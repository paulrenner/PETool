<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PE Fund Manager</title>
    <style>
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1800px;
            margin: 0 auto;
            background: white;
            border-radius: 12px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
            overflow: hidden;
        }

        header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px 30px;
        }

        header h1 {
            font-size: 2em;
            margin-bottom: 5px;
        }

        header p {
            font-size: 1em;
            opacity: 0.9;
        }

        .controls-bar {
            background: #f8f9fa;
            padding: 20px 30px;
            display: flex;
            gap: 20px;
            flex-wrap: wrap;
            align-items: flex-end;
            border-bottom: 2px solid #e0e0e0;
        }

        .control-group {
            display: flex;
            flex-direction: column;
            gap: 5px;
        }

        .control-group label {
            font-weight: 600;
            font-size: 0.85em;
            color: #555;
        }

        .control-group select,
        .control-group input[type="date"] {
            padding: 8px 12px;
            border: 2px solid #ddd;
            border-radius: 6px;
            font-size: 14px;
            min-width: 150px;
        }

        .control-group select:focus,
        .control-group input[type="date"]:focus {
            outline: none;
            border-color: #667eea;
        }

        .controls-bar button {
            padding: 10px 20px;
            border: none;
            border-radius: 6px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            margin-top: auto;
        }

        .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
        }

        .btn-secondary {
            background: #6c757d;
            color: white;
        }

        .btn-secondary:hover {
            background: #5a6268;
        }

        .btn-success {
            background: #28a745;
            color: white;
        }

        .btn-success:hover {
            background: #218838;
        }

        .btn-warning {
            background: #ffc107;
            color: #000;
        }

        .btn-warning:hover {
            background: #e0a800;
        }

        .btn-danger {
            background: #dc3545;
            color: white;
        }

        .btn-danger:hover {
            background: #c82333;
        }

        .btn-info {
            background: #17a2b8;
            color: white;
        }

        .btn-info:hover {
            background: #138496;
        }

        button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .content {
            padding: 30px;
        }

        .table-container {
            overflow-x: auto;
            margin-bottom: 30px;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            background: white;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
            border-radius: 8px;
            overflow: hidden;
            min-width: 1400px;
        }

        thead {
            background: linear-gradient(135deg, #009879 0%, #00745e 100%);
            color: white;
            position: sticky;
            top: 0;
            z-index: 10;
        }

        th {
            padding: 15px 12px;
            text-align: left;
            font-weight: 600;
            cursor: pointer;
            user-select: none;
            white-space: nowrap;
            font-size: 0.9em;
        }

        th:hover {
            background: rgba(255, 255, 255, 0.1);
        }

        th.sorted-asc::after {
            content: ' ‚Üë';
            opacity: 1;
        }

        th.sorted-desc::after {
            content: ' ‚Üì';
            opacity: 1;
        }

        td {
            padding: 12px;
            border-bottom: 1px solid #eee;
            font-size: 0.9em;
        }

        tbody tr:hover {
            background: #f8f9fa;
        }

        tbody tr:last-child {
            border-top: 2px solid #009879;
            border-bottom: 2px solid #009879;
            font-weight: bold;
            background: #f0f8ff;
        }

        tbody tr:last-child td {
            border-bottom: none;
        }

        td.number {
            text-align: right;
        }

        td.center {
            text-align: center;
        }

        .positive {
            color: #28a745;
        }

        .negative {
            color: #dc3545;
        }

        .empty-state {
            text-align: center;
            padding: 60px 20px;
            color: #999;
        }

        .action-buttons {
            display: flex;
            gap: 5px;
            flex-wrap: nowrap;
        }

        .btn-sm {
            padding: 5px 10px;
            font-size: 12px;
            min-width: auto;
            white-space: nowrap;
        }

        /* Modal Styles */
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            overflow-y: auto;
            background-color: rgba(0, 0, 0, 0.6);
        }

        .modal.show {
            display: flex;
            align-items: flex-start;
            justify-content: center;
            padding: 40px 20px;
        }

        .modal-content {
            background-color: #fff;
            padding: 30px;
            border-radius: 8px;
            width: 100%;
            max-width: 700px;
            box-shadow: 0 0 20px rgba(0, 0, 0, 0.3);
            position: relative;
            margin: auto;
        }

        .modal-content h2 {
            margin-bottom: 20px;
            color: #333;
        }

        .modal .close {
            position: absolute;
            top: 15px;
            right: 20px;
            font-size: 28px;
            font-weight: bold;
            color: #aaa;
            cursor: pointer;
            line-height: 1;
        }

        .modal .close:hover {
            color: #000;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #555;
        }

        .form-group input,
        .form-group select,
        .form-group textarea {
            width: 100%;
            padding: 10px;
            border: 2px solid #ddd;
            border-radius: 6px;
            font-size: 14px;
            transition: border-color 0.3s;
        }

        .form-group input:focus,
        .form-group select:focus,
        .form-group textarea:focus {
            outline: none;
            border-color: #667eea;
        }

        .form-group textarea {
            font-family: 'Courier New', monospace;
            resize: vertical;
            min-height: 100px;
        }

        .form-group .hint {
            font-size: 12px;
            color: #6c757d;
            margin-top: 5px;
        }

        .form-actions {
            display: flex;
            gap: 10px;
            margin-top: 25px;
        }

        .form-actions button {
            flex: 1;
        }

        .status-message {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 15px 45px 15px 25px;
            border-radius: 6px;
            background: white;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
            z-index: 2000;
            animation: slideIn 0.3s ease;
            max-width: 400px;
        }

        .status-message.success {
            border-left: 4px solid #28a745;
        }

        .status-message.error {
            border-left: 4px solid #dc3545;
        }

        .status-message.warning {
            border-left: 4px solid #ffc107;
        }

        .status-message .close-status {
            position: absolute;
            top: 10px;
            right: 15px;
            font-size: 20px;
            font-weight: bold;
            color: #999;
            cursor: pointer;
            line-height: 1;
            background: none;
            border: none;
            padding: 0;
        }

        .status-message .close-status:hover {
            color: #333;
        }

        @keyframes slideIn {
            from {
                transform: translateX(400px);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }

        input[type="file"] {
            display: none;
        }

        .file-input-label {
            display: inline-block;
            padding: 10px 20px;
            background: #ffc107;
            color: #000;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s;
            font-size: 14px;
        }

        .file-input-label:hover {
            background: #e0a800;
            transform: translateY(-2px);
        }

        input:disabled,
        textarea:disabled,
        select:disabled {
            opacity: 0.6;
            background: #f5f5f5;
            cursor: not-allowed;
        }

        /* Details Table */
        .details-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 15px;
            font-size: 0.9em;
        }

        .details-table th {
            background-color: #009879;
            color: #fff;
            padding: 10px;
            text-align: left;
            border: 1px solid #ccc;
        }

        .details-table td {
            padding: 8px 10px;
            border: 1px solid #ddd;
        }

        .details-table tbody tr:nth-child(even) {
            background-color: #f9f9f9;
        }

        .details-table input,
        .details-table select {
            width: 100%;
            padding: 6px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 0.9em;
        }

        .details-table input[type="number"],
        .details-table input[type="text"] {
            text-align: right;
        }

        .details-table input[type="date"],
        .details-table select {
            text-align: left;
        }

        .delete-row-btn {
            background: #e74c3c;
            color: white;
            border: none;
            padding: 5px 10px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 0.85em;
        }

        .delete-row-btn:hover {
            background: #c0392b;
        }

        #manageFundNamesModal .fund-name-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px;
            margin-bottom: 8px;
            background: #f8f9fa;
            border: 1px solid #ddd;
            border-radius: 6px;
        }

        #manageFundNamesModal .fund-name-item input {
            flex: 1;
            margin-right: 10px;
        }

        @media (max-width: 1400px) {
            .controls-bar {
                flex-direction: column;
                align-items: stretch;
            }

            .control-group {
                width: 100%;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>üè¶ PE Fund Manager</h1>
            <p>Private Equity Fund Analytics & Management Tool</p>
        </header>

        <div class="controls-bar">
            <div class="control-group">
                <button class="btn-primary" onclick="showAddFundModal()">‚ûï New Investment</button>
            </div>
            <div class="control-group">
                <button class="btn-info" onclick="showManageFundsModal()">üìã Manage Funds</button>
            </div>
            <div class="control-group">
                <label for="fundFilter">Filter by Fund</label>
                <select id="fundFilter" onchange="applyFilters()">
                    <option value="">All Funds</option>
                </select>
            </div>
            <div class="control-group">
                <label for="accountFilter">Filter by Account</label>
                <select id="accountFilter" onchange="applyFilters()">
                    <option value="">All Accounts</option>
                </select>
            </div>
            <div class="control-group">
                <label for="cutoffDate">Cutoff Date</label>
                <input type="date" id="cutoffDate" onchange="applyFilters()">
            </div>
            <div class="control-group">
                <button class="btn-secondary" onclick="resetFilters()">üîÑ Reset Filters</button>
            </div>
            <div style="margin-left: auto; display: flex; gap: 10px;">
                <button class="btn-success" onclick="exportDatabase()">üì§ Export</button>
                <label for="importFile" class="file-input-label">üì• Import</label>
                <input type="file" id="importFile" accept=".json" onchange="importDatabase(event)">
            </div>
        </div>

        <div class="content">
            <div class="table-container">
                <table id="fundsTable">
                    <thead>
                        <tr>
                            <th onclick="sortTable('fundName')">Fund Name</th>
                            <th onclick="sortTable('accountNumber')">Account</th>
                            <th onclick="sortTable('vintage')" class="center">Vintage</th>
                            <th onclick="sortTable('commitment')" class="number">Commitment</th>
                            <th onclick="sortTable('totalContributions')" class="number">Contributions</th>
                            <th onclick="sortTable('totalDistributions')" class="number">Distributions</th>
                            <th onclick="sortTable('nav')" class="number">Value (NAV)</th>
                            <th onclick="sortTable('investmentReturn')" class="number">Investment Return</th>
                            <th onclick="sortTable('moic')" class="number">MOIC</th>
                            <th onclick="sortTable('irr')" class="number">IRR</th>
                            <th onclick="sortTable('outstandingCommitment')" class="number">Outstanding Commitment</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody id="fundsTableBody">
                        <!-- Data will be populated here -->
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- Fund Add/Edit Modal -->
    <div id="fundModal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closeFundModal()">&times;</span>
            <h2 id="fundModalTitle">Add New Investment</h2>
            <form id="fundForm" onsubmit="saveFund(event)">
                <input type="hidden" id="fundId">
                <input type="hidden" id="isDuplicate">

                <div class="form-group">
                    <label for="fundName">Fund Name *</label>
                    <select id="fundName" required></select>
                </div>

                <div class="form-group">
                    <label for="accountNumber">Account Number *</label>
                    <input type="text" id="accountNumber" required>
                </div>

                <div class="form-group">
                    <label for="commitment">Commitment (USD) *</label>
                    <input type="text" id="commitment" required placeholder="e.g., 1,000,000">
                </div>

                <div id="duplicateMultiplierContainer" class="form-group" style="display: none;">
                    <label for="duplicateMultiplier">Duplicate Multiplier</label>
                    <input type="number" id="duplicateMultiplier" step="any" value="1">
                </div>

                <div class="form-group">
                    <label for="cashFlows">Cash Flows (JSON) *</label>
                    <textarea id="cashFlows" required placeholder='[{"date":"2024-01-15","amount":-1000000,"type":"Contribution","affectsCommitment":true}]'></textarea>
                    <div class="hint">Format: [{"date":"YYYY-MM-DD","amount":number,"type":"Contribution|Distribution","affectsCommitment":true}]</div>
                </div>

                <div class="form-group">
                    <label for="monthlyNav">Monthly NAV (JSON)</label>
                    <textarea id="monthlyNav" placeholder='[{"date":"2024-01-31","amount":950000}]'></textarea>
                    <div class="hint">Format: [{"date":"YYYY-MM-DD","amount":number}]</div>
                </div>

                <div class="form-actions">
                    <button type="submit" class="btn-primary">üíæ Save</button>
                    <button type="button" class="btn-secondary" onclick="closeFundModal()">Cancel</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Action Modal -->
    <div id="actionModal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closeActionModal()">&times;</span>
            <h2>Fund Actions</h2>
            <p id="actionFundInfo" style="margin-bottom: 20px; color: #666;"></p>
            <div class="form-actions">
                <button class="btn-info" onclick="editFundFromAction()">‚úèÔ∏è Edit</button>
                <button class="btn-success" onclick="duplicateFundFromAction()">üìã Duplicate</button>
                <button class="btn-warning" onclick="showDetailsFromAction()">üìä Details</button>
                <button class="btn-danger" onclick="deleteFundFromAction()">üóëÔ∏è Delete</button>
            </div>
        </div>
    </div>

    <!-- Manage Fund Names Modal -->
    <div id="manageFundNamesModal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closeManageFundsModal()">&times;</span>
            <h2>Manage Fund Names</h2>

            <div class="form-group">
                <label for="newFundNameInput">Add New Fund Name</label>
                <div style="display: flex; gap: 10px;">
                    <input type="text" id="newFundNameInput" style="flex: 1;" placeholder="Enter fund name">
                    <button class="btn-primary" onclick="addNewFundName()">Add</button>
                </div>
            </div>

            <hr style="margin: 20px 0;">

            <h3 style="margin-bottom: 15px;">Existing Fund Names</h3>
            <div id="fundNamesList"></div>

            <div class="form-actions">
                <button class="btn-secondary" onclick="closeManageFundsModal()">Close</button>
            </div>
        </div>
    </div>

    <!-- Details Modal -->
    <div id="detailsModal" class="modal">
        <div class="modal-content" style="max-width: 900px;">
            <span class="close" onclick="closeDetailsModal()">&times;</span>
            <h2 id="detailsModalTitle">Fund Details</h2>

            <h3 style="margin-top: 20px;">Cash Flows</h3>
            <table class="details-table" id="cashFlowsTable">
                <thead>
                    <tr>
                        <th>Date</th>
                        <th>Amount (USD)</th>
                        <th>Type</th>
                        <th>Affects Commitment?</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody></tbody>
            </table>
            <button type="button" class="btn-primary btn-sm" style="margin-top: 10px;" onclick="addCashFlowRow()">+ Add Cash Flow</button>

            <h3 style="margin-top: 30px;">Monthly NAV</h3>
            <table class="details-table" id="navTable">
                <thead>
                    <tr>
                        <th>Date</th>
                        <th>Amount (USD)</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody></tbody>
            </table>
            <button type="button" class="btn-primary btn-sm" style="margin-top: 10px;" onclick="addNavRow()">+ Add NAV</button>

            <div class="form-actions">
                <button class="btn-primary" onclick="saveDetailsChanges()">üíæ Save Changes</button>
                <button class="btn-secondary" onclick="closeDetailsModal()">Cancel</button>
            </div>
        </div>
    </div>

    <script>
        // ===========================
        // IndexedDB Operations
        // ===========================

        let db;
        let dbReady = false;
        const DB_NAME = 'FundsDB';
        const FUNDS_STORE = 'funds';
        const FUNDNAMES_STORE = 'fundNames';
        const DB_VERSION = 3;

        let currentFunds = [];
        let fundNames = new Set();
        let sortColumn = null;
        let sortDirection = 'asc';
        let currentActionFundId = null;
        let currentDetailsFundId = null;

        function initDB() {
            return new Promise((resolve, reject) => {
                const request = indexedDB.open(DB_NAME, DB_VERSION);

                request.onerror = () => reject(request.error);
                request.onsuccess = () => {
                    db = request.result;
                    dbReady = true;
                    resolve(db);
                };

                request.onupgradeneeded = (event) => {
                    const db = event.target.result;

                    // Funds store
                    if (!db.objectStoreNames.contains(FUNDS_STORE)) {
                        const fundsStore = db.createObjectStore(FUNDS_STORE, {
                            keyPath: 'id',
                            autoIncrement: true
                        });
                        fundsStore.createIndex('fundName', 'fundName', { unique: false });
                        fundsStore.createIndex('accountNumber', 'accountNumber', { unique: false });
                    }

                    // Fund names store
                    if (!db.objectStoreNames.contains(FUNDNAMES_STORE)) {
                        db.createObjectStore(FUNDNAMES_STORE, { keyPath: 'name' });
                    }
                };
            });
        }

        function saveFundToDB(fundData) {
            return new Promise((resolve, reject) => {
                if (!db) {
                    reject(new Error('Database not initialized'));
                    return;
                }

                const transaction = db.transaction([FUNDS_STORE], 'readwrite');
                const objectStore = transaction.objectStore(FUNDS_STORE);

                let request;
                if (fundData.id) {
                    request = objectStore.put(fundData);
                } else {
                    delete fundData.id;
                    request = objectStore.add(fundData);
                }

                request.onsuccess = () => resolve(request.result);
                request.onerror = () => reject(request.error);
            });
        }

        function getAllFunds() {
            return new Promise((resolve, reject) => {
                if (!db) {
                    reject(new Error('Database not initialized'));
                    return;
                }

                const transaction = db.transaction([FUNDS_STORE], 'readonly');
                const objectStore = transaction.objectStore(FUNDS_STORE);
                const request = objectStore.getAll();

                request.onsuccess = () => resolve(request.result);
                request.onerror = () => reject(request.error);
            });
        }

        function getFundById(id) {
            return new Promise((resolve, reject) => {
                if (!db) {
                    reject(new Error('Database not initialized'));
                    return;
                }

                const transaction = db.transaction([FUNDS_STORE], 'readonly');
                const objectStore = transaction.objectStore(FUNDS_STORE);
                const request = objectStore.get(id);

                request.onsuccess = () => resolve(request.result);
                request.onerror = () => reject(request.error);
            });
        }

        function deleteFundFromDB(id) {
            return new Promise((resolve, reject) => {
                if (!db) {
                    reject(new Error('Database not initialized'));
                    return;
                }

                const transaction = db.transaction([FUNDS_STORE], 'readwrite');
                const objectStore = transaction.objectStore(FUNDS_STORE);
                const request = objectStore.delete(id);

                request.onsuccess = () => resolve();
                request.onerror = () => reject(request.error);
            });
        }

        function getAllFundNames() {
            return new Promise((resolve, reject) => {
                if (!db) {
                    reject(new Error('Database not initialized'));
                    return;
                }

                const transaction = db.transaction([FUNDNAMES_STORE], 'readonly');
                const objectStore = transaction.objectStore(FUNDNAMES_STORE);
                const request = objectStore.getAll();

                request.onsuccess = () => {
                    const names = request.result.map(item => item.name);
                    resolve(names);
                };
                request.onerror = () => reject(request.error);
            });
        }

        function saveFundName(name) {
            return new Promise((resolve, reject) => {
                if (!db) {
                    reject(new Error('Database not initialized'));
                    return;
                }

                const transaction = db.transaction([FUNDNAMES_STORE], 'readwrite');
                const objectStore = transaction.objectStore(FUNDNAMES_STORE);
                const request = objectStore.put({ name });

                request.onsuccess = () => resolve();
                request.onerror = () => reject(request.error);
            });
        }

        function deleteFundName(name) {
            return new Promise((resolve, reject) => {
                if (!db) {
                    reject(new Error('Database not initialized'));
                    return;
                }

                const transaction = db.transaction([FUNDNAMES_STORE], 'readwrite');
                const objectStore = transaction.objectStore(FUNDNAMES_STORE);
                const request = objectStore.delete(name);

                request.onsuccess = () => resolve();
                request.onerror = () => reject(request.error);
            });
        }

        // ===========================
        // Calculation Functions
        // ===========================

        function parseCurrency(val) {
            if (val === null || typeof val === 'undefined') return NaN;
            if (typeof val === 'number') return isFinite(val) ? val : NaN;
            if (typeof val === 'string') {
                const cleaned = val.replace(/[$,]/g, '').replace(/^\((.*)\)$/, '-$1').trim();
                if (cleaned === '') return NaN;
                const num = parseFloat(cleaned);
                return isFinite(num) ? num : NaN;
            }
            return NaN;
        }

        function formatCurrency(value, showCents = false) {
            const val = parseFloat(value);
            if (!isFinite(val) || isNaN(val)) return '$0';
            return val.toLocaleString('en-US', {
                style: 'currency',
                currency: 'USD',
                minimumFractionDigits: showCents ? 2 : 0,
                maximumFractionDigits: showCents ? 2 : 0
            });
        }

        function isValidDate(dateStr) {
            if (typeof dateStr !== 'string' || !/^\d{4}-\d{2}-\d{2}$/.test(dateStr)) {
                return false;
            }
            const date = new Date(dateStr);
            return !isNaN(date.getTime());
        }

        function getVintageYear(fund) {
            const contributions = (fund.cashFlows || [])
                .filter(cf => cf.type === 'Contribution' && isValidDate(cf.date))
                .sort((a, b) => new Date(a.date) - new Date(b.date));

            return contributions.length > 0 ? new Date(contributions[0].date).getFullYear() : null;
        }

        function getTotalByType(fund, type, cutoffDate) {
            return (fund.cashFlows || [])
                .filter(cf =>
                    cf.type === type &&
                    isValidDate(cf.date) &&
                    (!cutoffDate || new Date(cf.date) <= cutoffDate)
                )
                .reduce((sum, cf) => sum + Math.abs(parseCurrency(cf.amount) || 0), 0);
        }

        function getLatestNav(fund, cutoffDate) {
            const navs = (fund.monthlyNav || [])
                .filter(n => isValidDate(n.date) && (!cutoffDate || new Date(n.date) <= cutoffDate))
                .sort((a, b) => new Date(b.date) - new Date(a.date));

            if (navs.length === 0) return 0;

            const latestNav = navs[0];
            let navAmount = parseCurrency(latestNav.amount) || 0;
            const navDate = new Date(latestNav.date);

            // Adjust for cash flows after NAV date
            const subsequentFlows = (fund.cashFlows || []).filter(cf => {
                if (!isValidDate(cf.date)) return false;
                const cfDate = new Date(cf.date);
                return cfDate > navDate && (!cutoffDate || cfDate <= cutoffDate);
            });

            subsequentFlows.forEach(cf => {
                const amount = parseCurrency(cf.amount) || 0;
                if (cf.type === 'Contribution') {
                    navAmount -= Math.abs(amount);
                } else if (cf.type === 'Distribution') {
                    navAmount += Math.abs(amount);
                }
            });

            return navAmount;
        }

        function getOutstandingCommitment(fund, cutoffDate) {
            let outstanding = parseCurrency(fund.commitment) || 0;

            (fund.cashFlows || [])
                .filter(cf =>
                    isValidDate(cf.date) &&
                    (!cutoffDate || new Date(cf.date) <= cutoffDate) &&
                    cf.affectsCommitment !== false
                )
                .forEach(cf => {
                    if (cf.type === 'Contribution') {
                        const amount = parseCurrency(cf.amount) || 0;
                        outstanding -= Math.abs(amount);
                    }
                });

            return Math.max(0, outstanding);
        }

        function parseCashFlowsForIRR(fund, cutoffDate) {
            const flows = (fund.cashFlows || [])
                .filter(cf => isValidDate(cf.date) && (!cutoffDate || new Date(cf.date) <= cutoffDate))
                .map(cf => {
                    const amount = parseCurrency(cf.amount) || 0;
                    return {
                        date: cf.date,
                        amount: cf.type === 'Contribution' ? -Math.abs(amount) : Math.abs(amount)
                    };
                });

            // Add NAV as final cash flow
            const nav = getLatestNav(fund, cutoffDate);
            if (nav > 0) {
                const navs = (fund.monthlyNav || [])
                    .filter(n => isValidDate(n.date) && (!cutoffDate || new Date(n.date) <= cutoffDate))
                    .sort((a, b) => new Date(b.date) - new Date(a.date));

                if (navs.length > 0) {
                    flows.push({ date: navs[0].date, amount: nav });
                }
            }

            return flows.sort((a, b) => new Date(a.date) - new Date(b.date));
        }

        function calculateIRR(cashFlows, guess = 0.1) {
            if (!Array.isArray(cashFlows) || cashFlows.length < 2) return null;

            const flows = [...cashFlows].sort((a, b) => new Date(a.date) - new Date(b.date));
            const firstDate = new Date(flows[0].date);

            const npv = rate => flows.reduce((acc, cf) => {
                const yearsDiff = (new Date(cf.date) - firstDate) / (365.25 * 24 * 60 * 60 * 1000);
                return acc + cf.amount / Math.pow(1 + rate, yearsDiff);
            }, 0);

            const dNpv = rate => flows.reduce((acc, cf) => {
                const yearsDiff = (new Date(cf.date) - firstDate) / (365.25 * 24 * 60 * 60 * 1000);
                if (yearsDiff === 0) return acc;
                return acc - (yearsDiff * cf.amount) / Math.pow(1 + rate, yearsDiff + 1);
            }, 0);

            let rate = guess;
            const maxIterations = 1000;
            const precision = 1e-6;

            for (let i = 0; i < maxIterations; i++) {
                const npvValue = npv(rate);
                const derivativeValue = dNpv(rate);

                if (Math.abs(npvValue) < precision) {
                    if (rate > 10 || rate < -1) return null;
                    return rate;
                }
                if (Math.abs(derivativeValue) < precision) return null;

                const newRate = rate - npvValue / derivativeValue;
                if (Math.abs(newRate - rate) < precision) {
                    if (newRate > 10 || newRate < -1) return null;
                    return newRate;
                }

                rate = newRate;
            }

            return null;
        }

        function calculateMOIC(cashFlows) {
            if (!Array.isArray(cashFlows) || cashFlows.length === 0) return null;

            const contributions = cashFlows
                .filter(f => f.amount < 0)
                .reduce((sum, f) => sum + Math.abs(f.amount), 0);

            const distributions = cashFlows
                .filter(f => f.amount > 0)
                .reduce((sum, f) => sum + f.amount, 0);

            if (contributions === 0) return distributions > 0 ? Infinity : null;
            return distributions / contributions;
        }

        function calculateMetrics(fund, cutoffDate) {
            const commitment = parseCurrency(fund.commitment) || 0;
            const totalContributions = getTotalByType(fund, 'Contribution', cutoffDate);
            const totalDistributions = getTotalByType(fund, 'Distribution', cutoffDate);
            const nav = getLatestNav(fund, cutoffDate);
            const outstandingCommitment = getOutstandingCommitment(fund, cutoffDate);
            const investmentReturn = totalDistributions + nav - totalContributions;
            const vintage = getVintageYear(fund);

            const cashFlowsForIRR = parseCashFlowsForIRR(fund, cutoffDate);
            const irr = calculateIRR(cashFlowsForIRR);
            const moic = calculateMOIC(cashFlowsForIRR);

            return {
                commitment,
                totalContributions,
                totalDistributions,
                nav,
                outstandingCommitment,
                investmentReturn,
                vintage,
                irr,
                moic
            };
        }

        function getLatestQuarterEnd() {
            const now = new Date();
            const currentMonth = now.getMonth();
            const currentQuarter = Math.floor(currentMonth / 3);
            const quarterStartMonth = currentQuarter * 3;
            return new Date(now.getFullYear(), quarterStartMonth, 0);
        }

        // ===========================
        // UI Functions
        // ===========================

        function showStatus(message, type = 'success') {
            const statusDiv = document.createElement('div');
            statusDiv.className = `status-message ${type}`;

            // Create close button
            const closeBtn = document.createElement('button');
            closeBtn.className = 'close-status';
            closeBtn.innerHTML = '&times;';
            closeBtn.onclick = () => statusDiv.remove();

            // Create message text
            const messageText = document.createElement('span');
            messageText.textContent = message;

            statusDiv.appendChild(messageText);
            statusDiv.appendChild(closeBtn);
            document.body.appendChild(statusDiv);

            // Only auto-dismiss success messages
            if (type === 'success') {
                setTimeout(() => {
                    statusDiv.remove();
                }, 3000);
            }
        }

        async function renderTable() {
            try {
                const funds = await getAllFunds();
                currentFunds = funds;

                // Apply filters
                let filtered = applyCurrentFilters(funds);

                // Apply sorting
                if (sortColumn) {
                    filtered = sortData(filtered, sortColumn, sortDirection);
                }

                // Update filter dropdowns
                updateFilterDropdowns(funds);

                // Get cutoff date
                const cutoffDateValue = document.getElementById('cutoffDate').value;
                const cutoffDate = cutoffDateValue ? new Date(cutoffDateValue) : null;

                // Calculate metrics for each fund
                const fundsWithMetrics = filtered.map(fund => ({
                    ...fund,
                    metrics: calculateMetrics(fund, cutoffDate)
                }));

                // Render table body
                const tbody = document.getElementById('fundsTableBody');
                tbody.innerHTML = '';

                if (fundsWithMetrics.length === 0) {
                    tbody.innerHTML = `
                        <tr>
                            <td colspan="12" class="empty-state">
                                <div style="padding: 40px;">
                                    <h3 style="margin-bottom: 10px;">No investments found</h3>
                                    <p>Click "New Investment" to add your first fund</p>
                                </div>
                            </td>
                        </tr>
                    `;
                    return;
                }

                fundsWithMetrics.forEach(fund => {
                    const m = fund.metrics;
                    const row = document.createElement('tr');

                    row.innerHTML = `
                        <td>${escapeHtml(fund.fundName)}</td>
                        <td>${escapeHtml(fund.accountNumber)}</td>
                        <td class="center">${m.vintage || 'N/A'}</td>
                        <td class="number">${formatCurrency(m.commitment)}</td>
                        <td class="number">${formatCurrency(m.totalContributions)}</td>
                        <td class="number">${formatCurrency(m.totalDistributions)}</td>
                        <td class="number">${formatCurrency(m.nav)}</td>
                        <td class="number ${m.investmentReturn >= 0 ? 'positive' : 'negative'}">${formatCurrency(m.investmentReturn)}</td>
                        <td class="number">${m.moic !== null && isFinite(m.moic) ? m.moic.toFixed(2) + 'x' : 'N/A'}</td>
                        <td class="number ${m.irr !== null && m.irr >= 0 ? 'positive' : 'negative'}">${m.irr !== null ? (m.irr * 100).toFixed(2) + '%' : 'N/A'}</td>
                        <td class="number">${formatCurrency(m.outstandingCommitment)}</td>
                        <td>
                            <button class="btn-sm btn-info" onclick="showActionModal(${fund.id})">‚ãÆ</button>
                        </td>
                    `;

                    tbody.appendChild(row);
                });

                // Add totals row
                addTotalsRow(fundsWithMetrics, cutoffDate);

            } catch (err) {
                console.error('Error rendering table:', err);
                showStatus('Error loading data: ' + err.message, 'error');
            }
        }

        function addTotalsRow(fundsWithMetrics, cutoffDate) {
            const tbody = document.getElementById('fundsTableBody');

            // Calculate totals
            const totals = {
                commitment: 0,
                totalContributions: 0,
                totalDistributions: 0,
                nav: 0,
                investmentReturn: 0,
                outstandingCommitment: 0,
                aggregateFlows: []
            };

            fundsWithMetrics.forEach(fund => {
                const m = fund.metrics;
                totals.commitment += m.commitment;
                totals.totalContributions += m.totalContributions;
                totals.totalDistributions += m.totalDistributions;
                totals.nav += m.nav;
                totals.investmentReturn += m.investmentReturn;
                totals.outstandingCommitment += m.outstandingCommitment;

                const flows = parseCashFlowsForIRR(fund, cutoffDate);
                totals.aggregateFlows.push(...flows);
            });

            // Calculate aggregate IRR and MOIC
            const aggregateIRR = calculateIRR(totals.aggregateFlows);
            const aggregateMOIC = calculateMOIC(totals.aggregateFlows);

            const totalRow = document.createElement('tr');
            totalRow.innerHTML = `
                <td><strong>Total</strong></td>
                <td></td>
                <td></td>
                <td class="number"><strong>${formatCurrency(totals.commitment)}</strong></td>
                <td class="number"><strong>${formatCurrency(totals.totalContributions)}</strong></td>
                <td class="number"><strong>${formatCurrency(totals.totalDistributions)}</strong></td>
                <td class="number"><strong>${formatCurrency(totals.nav)}</strong></td>
                <td class="number ${totals.investmentReturn >= 0 ? 'positive' : 'negative'}"><strong>${formatCurrency(totals.investmentReturn)}</strong></td>
                <td class="number"><strong>${aggregateMOIC !== null && isFinite(aggregateMOIC) ? aggregateMOIC.toFixed(2) + 'x' : 'N/A'}</strong></td>
                <td class="number ${aggregateIRR !== null && aggregateIRR >= 0 ? 'positive' : 'negative'}"><strong>${aggregateIRR !== null ? (aggregateIRR * 100).toFixed(2) + '%' : 'N/A'}</strong></td>
                <td class="number"><strong>${formatCurrency(totals.outstandingCommitment)}</strong></td>
                <td></td>
            `;

            tbody.appendChild(totalRow);
        }

        function applyCurrentFilters(funds) {
            const fundFilter = document.getElementById('fundFilter').value;
            const accountFilter = document.getElementById('accountFilter').value;

            return funds.filter(fund => {
                if (fundFilter && fund.fundName !== fundFilter) return false;
                if (accountFilter && fund.accountNumber !== accountFilter) return false;
                return true;
            });
        }

        function updateFilterDropdowns(funds) {
            // Update fund filter
            const fundFilter = document.getElementById('fundFilter');
            const currentFundValue = fundFilter.value;
            const uniqueFunds = [...new Set(funds.map(f => f.fundName))].sort();

            fundFilter.innerHTML = '<option value="">All Funds</option>';
            uniqueFunds.forEach(name => {
                const option = document.createElement('option');
                option.value = name;
                option.textContent = name;
                fundFilter.appendChild(option);
            });
            fundFilter.value = currentFundValue;

            // Update account filter
            const accountFilter = document.getElementById('accountFilter');
            const currentAccountValue = accountFilter.value;
            const uniqueAccounts = [...new Set(funds.map(f => f.accountNumber))].sort();

            accountFilter.innerHTML = '<option value="">All Accounts</option>';
            uniqueAccounts.forEach(account => {
                const option = document.createElement('option');
                option.value = account;
                option.textContent = account;
                accountFilter.appendChild(option);
            });
            accountFilter.value = currentAccountValue;
        }

        function applyFilters() {
            renderTable();
        }

        function resetFilters() {
            document.getElementById('fundFilter').value = '';
            document.getElementById('accountFilter').value = '';
            document.getElementById('cutoffDate').value = '';
            renderTable();
        }

        function sortData(data, column, direction) {
            return [...data].sort((a, b) => {
                const cutoffDateValue = document.getElementById('cutoffDate').value;
                const cutoffDate = cutoffDateValue ? new Date(cutoffDateValue) : null;

                const metricsA = calculateMetrics(a, cutoffDate);
                const metricsB = calculateMetrics(b, cutoffDate);

                let valA, valB;

                switch(column) {
                    case 'fundName':
                    case 'accountNumber':
                        valA = a[column];
                        valB = b[column];
                        break;
                    case 'vintage':
                    case 'commitment':
                    case 'totalContributions':
                    case 'totalDistributions':
                    case 'nav':
                    case 'investmentReturn':
                    case 'outstandingCommitment':
                    case 'irr':
                    case 'moic':
                        valA = metricsA[column] ?? -Infinity;
                        valB = metricsB[column] ?? -Infinity;
                        break;
                    default:
                        return 0;
                }

                if (valA < valB) return direction === 'asc' ? -1 : 1;
                if (valA > valB) return direction === 'asc' ? 1 : -1;
                return 0;
            });
        }

        function sortTable(column) {
            if (sortColumn === column) {
                sortDirection = sortDirection === 'asc' ? 'desc' : 'asc';
            } else {
                sortColumn = column;
                sortDirection = 'asc';
            }

            // Update header classes
            document.querySelectorAll('th').forEach(th => {
                th.classList.remove('sorted-asc', 'sorted-desc');
            });

            const headers = document.querySelectorAll('th');
            const columnIndex = ['fundName', 'accountNumber', 'vintage', 'commitment', 'totalContributions', 'totalDistributions', 'nav', 'investmentReturn', 'moic', 'irr', 'outstandingCommitment'].indexOf(column);
            if (columnIndex !== -1) {
                headers[columnIndex].classList.add(`sorted-${sortDirection}`);
            }

            renderTable();
        }

        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        // ===========================
        // Modal Functions
        // ===========================

        async function showAddFundModal() {
            document.getElementById('fundModalTitle').textContent = 'Add New Investment';
            document.getElementById('fundId').value = '';
            document.getElementById('isDuplicate').value = '';
            document.getElementById('duplicateMultiplierContainer').style.display = 'none';
            document.getElementById('fundForm').reset();

            await populateFundNamesDropdown();
            document.getElementById('fundModal').classList.add('show');
        }

        async function editFund(id) {
            try {
                const fund = await getFundById(id);
                if (!fund) {
                    showStatus('Fund not found', 'error');
                    return;
                }

                document.getElementById('fundModalTitle').textContent = 'Edit Investment';
                document.getElementById('fundId').value = fund.id;
                document.getElementById('isDuplicate').value = '';
                document.getElementById('duplicateMultiplierContainer').style.display = 'none';

                await populateFundNamesDropdown();
                document.getElementById('fundName').value = fund.fundName;
                document.getElementById('accountNumber').value = fund.accountNumber;
                document.getElementById('commitment').value = formatCurrency(parseCurrency(fund.commitment) || 0);
                document.getElementById('cashFlows').value = JSON.stringify(fund.cashFlows || [], null, 2);
                document.getElementById('monthlyNav').value = JSON.stringify(fund.monthlyNav || [], null, 2);

                document.getElementById('fundModal').classList.add('show');
            } catch (err) {
                showStatus('Error loading fund: ' + err.message, 'error');
            }
        }

        async function duplicateFund(id) {
            try {
                const fund = await getFundById(id);
                if (!fund) {
                    showStatus('Fund not found', 'error');
                    return;
                }

                document.getElementById('fundModalTitle').textContent = 'Duplicate Investment';
                document.getElementById('fundId').value = '';
                document.getElementById('isDuplicate').value = id;
                document.getElementById('duplicateMultiplierContainer').style.display = 'block';
                document.getElementById('duplicateMultiplier').value = '1';

                await populateFundNamesDropdown();
                document.getElementById('fundName').value = fund.fundName;
                document.getElementById('accountNumber').value = fund.accountNumber + ' (Copy)';
                document.getElementById('commitment').value = formatCurrency(parseCurrency(fund.commitment) || 0);
                document.getElementById('cashFlows').value = JSON.stringify(fund.cashFlows || [], null, 2);
                document.getElementById('monthlyNav').value = JSON.stringify(fund.monthlyNav || [], null, 2);

                document.getElementById('fundModal').classList.add('show');
            } catch (err) {
                showStatus('Error loading fund: ' + err.message, 'error');
            }
        }

        function closeFundModal() {
            document.getElementById('fundModal').classList.remove('show');
        }

        async function saveFund(event) {
            event.preventDefault();

            try {
                const fundId = document.getElementById('fundId').value;
                const isDuplicate = document.getElementById('isDuplicate').value;
                const fundName = document.getElementById('fundName').value.trim();
                const accountNumber = document.getElementById('accountNumber').value.trim();
                const commitmentText = document.getElementById('commitment').value.trim();
                const cashFlowsText = document.getElementById('cashFlows').value.trim();
                const monthlyNavText = document.getElementById('monthlyNav').value.trim();

                // Validate
                if (!fundName || !accountNumber || !commitmentText || !cashFlowsText) {
                    showStatus('Please fill in all required fields', 'error');
                    return;
                }

                // Parse commitment
                const commitment = parseCurrency(commitmentText);
                if (isNaN(commitment)) {
                    showStatus('Invalid commitment amount', 'error');
                    return;
                }

                // Parse JSON
                let cashFlows, monthlyNav;

                try {
                    cashFlows = JSON.parse(cashFlowsText);
                    if (!Array.isArray(cashFlows)) throw new Error('Cash flows must be an array');

                    // Validate cash flow structure
                    cashFlows.forEach((cf, i) => {
                        if (!cf.date || typeof cf.amount === 'undefined' || !cf.type) {
                            throw new Error(`Invalid cash flow at index ${i}`);
                        }
                        if (!['Contribution', 'Distribution'].includes(cf.type)) {
                            throw new Error(`Invalid cash flow type at index ${i}`);
                        }
                    });
                } catch (err) {
                    showStatus('Invalid cash flows JSON: ' + err.message, 'error');
                    return;
                }

                try {
                    monthlyNav = monthlyNavText ? JSON.parse(monthlyNavText) : [];
                    if (!Array.isArray(monthlyNav)) throw new Error('Monthly NAV must be an array');

                    monthlyNav.forEach((nav, i) => {
                        if (!nav.date || typeof nav.amount === 'undefined') {
                            throw new Error(`Invalid NAV entry at index ${i}`);
                        }
                    });
                } catch (err) {
                    showStatus('Invalid monthly NAV JSON: ' + err.message, 'error');
                    return;
                }

                // Handle duplicate multiplier
                if (isDuplicate) {
                    const multiplier = parseFloat(document.getElementById('duplicateMultiplier').value) || 1;

                    cashFlows = cashFlows.map(cf => ({
                        ...cf,
                        amount: parseCurrency(cf.amount) * multiplier
                    }));

                    monthlyNav = monthlyNav.map(nav => ({
                        ...nav,
                        amount: parseCurrency(nav.amount) * multiplier
                    }));
                }

                const fundData = {
                    fundName,
                    accountNumber,
                    commitment: commitment.toString(),
                    cashFlows,
                    monthlyNav,
                    timestamp: new Date().toISOString()
                };

                if (fundId) {
                    fundData.id = parseInt(fundId);
                }

                await saveFundToDB(fundData);

                // Save fund name if new
                if (!fundNames.has(fundName)) {
                    await saveFundName(fundName);
                    fundNames.add(fundName);
                }

                closeFundModal();
                await renderTable();
                showStatus(fundId ? 'Fund updated successfully' : 'Fund added successfully');

            } catch (err) {
                showStatus('Error saving fund: ' + err.message, 'error');
                console.error(err);
            }
        }

        async function showActionModal(id) {
            console.log('showActionModal called with ID:', id, 'Type:', typeof id);

            if (!id && id !== 0) {
                console.error('Invalid fund ID provided to showActionModal:', id);
                showStatus('Error: Invalid fund ID provided', 'error');
                return;
            }

            currentActionFundId = id;

            try {
                const fund = await getFundById(id);
                if (!fund) {
                    showStatus('Fund not found', 'error');
                    return;
                }

                console.log('Action modal showing for fund:', fund.fundName, 'ID:', fund.id);
                document.getElementById('actionFundInfo').textContent =
                    `${fund.fundName} - ${fund.accountNumber}`;
                document.getElementById('actionModal').classList.add('show');
            } catch (err) {
                console.error('Error in showActionModal:', err);
                showStatus('Error loading fund: ' + err.message, 'error');
            }
        }

        function closeActionModal() {
            document.getElementById('actionModal').classList.remove('show');
            currentActionFundId = null;
        }

        function editFundFromAction() {
            const fundId = currentActionFundId;
            if (!fundId) {
                showStatus('Error: No fund selected', 'error');
                return;
            }
            closeActionModal();
            editFund(fundId);
        }

        function duplicateFundFromAction() {
            const fundId = currentActionFundId;
            if (!fundId) {
                showStatus('Error: No fund selected', 'error');
                return;
            }
            closeActionModal();
            duplicateFund(fundId);
        }

        async function deleteFundFromAction() {
            if (!currentActionFundId) return;

            try {
                const fund = await getFundById(currentActionFundId);
                if (!fund) {
                    showStatus('Fund not found', 'error');
                    return;
                }

                if (confirm(`Are you sure you want to delete "${fund.fundName} - ${fund.accountNumber}"?`)) {
                    await deleteFundFromDB(currentActionFundId);
                    closeActionModal();
                    await renderTable();
                    showStatus('Fund deleted successfully');
                }
            } catch (err) {
                showStatus('Error deleting fund: ' + err.message, 'error');
            }
        }

        function showDetailsFromAction() {
            // Capture the ID before closing the modal
            const fundId = currentActionFundId;
            console.log('Opening details for fund ID:', fundId);
            if (!fundId) {
                console.error('No fund ID available');
                showStatus('Error: No fund selected', 'error');
                return;
            }
            closeActionModal();
            showDetailsModal(fundId);
        }

        async function showDetailsModal(id) {
            console.log('showDetailsModal called with ID:', id, 'Type:', typeof id);

            if (!id && id !== 0) {
                console.error('Invalid fund ID provided to showDetailsModal:', id);
                showStatus('Error: Invalid fund ID provided', 'error');
                return;
            }

            currentDetailsFundId = id;

            try {
                console.log('Loading fund details for ID:', id);
                const fund = await getFundById(id);

                if (!fund) {
                    console.error('Fund not found:', id);
                    showStatus('Fund not found', 'error');
                    return;
                }

                console.log('Fund loaded:', fund);

                document.getElementById('detailsModalTitle').textContent =
                    `Fund Details - ${fund.fundName}`;

                // Populate cash flows table
                const cashFlowsTable = document.getElementById('cashFlowsTable');
                if (!cashFlowsTable) {
                    console.error('Cash flows table not found');
                    showStatus('Error: Cash flows table element not found in page', 'error');
                    return;
                }
                const cashFlowsTableBody = cashFlowsTable.querySelector('tbody');
                if (!cashFlowsTableBody) {
                    console.error('Cash flows table body not found');
                    showStatus('Error: Cash flows table body element not found in page', 'error');
                    return;
                }
                cashFlowsTableBody.innerHTML = '';

                console.log('Cash flows:', fund.cashFlows);
                (fund.cashFlows || []).forEach((cf, index) => {
                    try {
                        const row = document.createElement('tr');
                        const amountValue = parseCurrency(cf.amount);
                        const displayAmount = isNaN(amountValue) ? '' : amountValue;

                        row.innerHTML = `
                            <td><input type="date" value="${escapeHtml(cf.date || '')}" data-field="date" data-index="${index}"></td>
                            <td><input type="text" value="${displayAmount}" data-field="amount" data-index="${index}"></td>
                            <td>
                                <select data-field="type" data-index="${index}">
                                    <option value="Contribution" ${cf.type === 'Contribution' ? 'selected' : ''}>Contribution</option>
                                    <option value="Distribution" ${cf.type === 'Distribution' ? 'selected' : ''}>Distribution</option>
                                </select>
                            </td>
                            <td style="text-align: center;">
                                <input type="checkbox" ${cf.affectsCommitment !== false ? 'checked' : ''} data-field="affectsCommitment" data-index="${index}">
                            </td>
                            <td>
                                <button class="delete-row-btn" onclick="deleteCashFlowRow(${index})">Delete</button>
                            </td>
                        `;
                        cashFlowsTableBody.appendChild(row);
                    } catch (cfErr) {
                        console.error('Error adding cash flow row:', cfErr, cf);
                        showStatus('Error loading cash flow at index ' + index + ': ' + cfErr.message, 'error');
                    }
                });

                // Populate NAV table
                const navTable = document.getElementById('navTable');
                if (!navTable) {
                    console.error('NAV table not found');
                    showStatus('Error: NAV table element not found in page', 'error');
                    return;
                }
                const navTableBody = navTable.querySelector('tbody');
                if (!navTableBody) {
                    console.error('NAV table body not found');
                    showStatus('Error: NAV table body element not found in page', 'error');
                    return;
                }
                navTableBody.innerHTML = '';

                console.log('Monthly NAV:', fund.monthlyNav);
                (fund.monthlyNav || []).forEach((nav, index) => {
                    try {
                        const row = document.createElement('tr');
                        const amountValue = parseCurrency(nav.amount);
                        const displayAmount = isNaN(amountValue) ? '' : amountValue;

                        row.innerHTML = `
                            <td><input type="date" value="${escapeHtml(nav.date || '')}" data-field="date" data-index="${index}"></td>
                            <td><input type="text" value="${displayAmount}" data-field="amount" data-index="${index}"></td>
                            <td>
                                <button class="delete-row-btn" onclick="deleteNavRow(${index})">Delete</button>
                            </td>
                        `;
                        navTableBody.appendChild(row);
                    } catch (navErr) {
                        console.error('Error adding NAV row:', navErr, nav);
                        showStatus('Error loading NAV at index ' + index + ': ' + navErr.message, 'error');
                    }
                });

                document.getElementById('detailsModal').classList.add('show');
                console.log('Details modal opened successfully');
            } catch (err) {
                console.error('Error in showDetailsModal:', err);
                showStatus('Error loading fund details: ' + err.message + ' (Check console for details)', 'error');
            }
        }

        function closeDetailsModal() {
            document.getElementById('detailsModal').classList.remove('show');
            currentDetailsFundId = null;
        }

        function addCashFlowRow() {
            const table = document.getElementById('cashFlowsTable').querySelector('tbody');
            const index = table.children.length;
            const row = document.createElement('tr');
            row.innerHTML = `
                <td><input type="date" data-field="date" data-index="${index}"></td>
                <td><input type="text" placeholder="0" data-field="amount" data-index="${index}"></td>
                <td>
                    <select data-field="type" data-index="${index}">
                        <option value="Contribution">Contribution</option>
                        <option value="Distribution">Distribution</option>
                    </select>
                </td>
                <td style="text-align: center;">
                    <input type="checkbox" checked data-field="affectsCommitment" data-index="${index}">
                </td>
                <td>
                    <button class="delete-row-btn" onclick="deleteCashFlowRow(${index})">Delete</button>
                </td>
            `;
            table.appendChild(row);
        }

        function deleteCashFlowRow(index) {
            const table = document.getElementById('cashFlowsTable').querySelector('tbody');
            table.children[index].remove();
        }

        function addNavRow() {
            const table = document.getElementById('navTable').querySelector('tbody');
            const index = table.children.length;
            const row = document.createElement('tr');
            row.innerHTML = `
                <td><input type="date" data-field="date" data-index="${index}"></td>
                <td><input type="text" placeholder="0" data-field="amount" data-index="${index}"></td>
                <td>
                    <button class="delete-row-btn" onclick="deleteNavRow(${index})">Delete</button>
                </td>
            `;
            table.appendChild(row);
        }

        function deleteNavRow(index) {
            const table = document.getElementById('navTable').querySelector('tbody');
            table.children[index].remove();
        }

        async function saveDetailsChanges() {
            if (!currentDetailsFundId) return;

            try {
                const fund = await getFundById(currentDetailsFundId);
                if (!fund) {
                    showStatus('Fund not found', 'error');
                    return;
                }

                // Read cash flows from table
                const cashFlowsTable = document.getElementById('cashFlowsTable').querySelector('tbody');
                const cashFlows = [];
                Array.from(cashFlowsTable.children).forEach(row => {
                    const date = row.querySelector('[data-field="date"]').value;
                    const amount = row.querySelector('[data-field="amount"]').value;
                    const type = row.querySelector('[data-field="type"]').value;
                    const affectsCommitment = row.querySelector('[data-field="affectsCommitment"]').checked;

                    if (date && amount) {
                        cashFlows.push({
                            date,
                            amount: parseCurrency(amount),
                            type,
                            affectsCommitment
                        });
                    }
                });

                // Read NAV from table
                const navTable = document.getElementById('navTable').querySelector('tbody');
                const monthlyNav = [];
                Array.from(navTable.children).forEach(row => {
                    const date = row.querySelector('[data-field="date"]').value;
                    const amount = row.querySelector('[data-field="amount"]').value;

                    if (date && amount) {
                        monthlyNav.push({
                            date,
                            amount: parseCurrency(amount)
                        });
                    }
                });

                // Update fund
                fund.cashFlows = cashFlows;
                fund.monthlyNav = monthlyNav;
                fund.timestamp = new Date().toISOString();

                await saveFundToDB(fund);
                closeDetailsModal();
                await renderTable();
                showStatus('Details updated successfully');

            } catch (err) {
                showStatus('Error saving details: ' + err.message, 'error');
                console.error(err);
            }
        }

        async function showManageFundsModal() {
            await loadFundNamesList();
            await populateFundNamesDropdown();
            document.getElementById('manageFundNamesModal').classList.add('show');
        }

        function closeManageFundsModal() {
            document.getElementById('manageFundNamesModal').classList.remove('show');
        }

        async function loadFundNamesList() {
            try {
                const names = await getAllFundNames();
                fundNames = new Set(names);

                const container = document.getElementById('fundNamesList');
                container.innerHTML = '';

                if (names.length === 0) {
                    container.innerHTML = '<p style="color: #999;">No fund names yet</p>';
                    return;
                }

                names.forEach(name => {
                    const div = document.createElement('div');
                    div.className = 'fund-name-item';
                    div.innerHTML = `
                        <input type="text" value="${escapeHtml(name)}" data-original-name="${escapeHtml(name)}" onchange="updateFundName(this)">
                        <button class="btn-danger btn-sm" onclick="removeFundName('${escapeHtml(name)}')">Delete</button>
                    `;
                    container.appendChild(div);
                });
            } catch (err) {
                showStatus('Error loading fund names: ' + err.message, 'error');
            }
        }

        async function addNewFundName() {
            const input = document.getElementById('newFundNameInput');
            const name = input.value.trim();

            if (!name) {
                showStatus('Please enter a fund name', 'error');
                return;
            }

            if (fundNames.has(name)) {
                showStatus('Fund name already exists', 'error');
                return;
            }

            try {
                await saveFundName(name);
                fundNames.add(name);
                input.value = '';
                await loadFundNamesList();
                showStatus('Fund name added successfully');
            } catch (err) {
                showStatus('Error adding fund name: ' + err.message, 'error');
            }
        }

        async function updateFundName(input) {
            const oldName = input.dataset.originalName;
            const newName = input.value.trim();

            if (!newName) {
                showStatus('Fund name cannot be empty', 'error');
                input.value = oldName;
                return;
            }

            if (newName === oldName) return;

            if (fundNames.has(newName) && newName !== oldName) {
                showStatus('Fund name already exists', 'error');
                input.value = oldName;
                return;
            }

            try {
                // Delete old name, save new name
                await deleteFundName(oldName);
                await saveFundName(newName);

                // Update all funds with this name
                const funds = await getAllFunds();
                for (const fund of funds) {
                    if (fund.fundName === oldName) {
                        fund.fundName = newName;
                        await saveFundToDB(fund);
                    }
                }

                fundNames.delete(oldName);
                fundNames.add(newName);
                input.dataset.originalName = newName;

                await renderTable();
                showStatus('Fund name updated successfully');
            } catch (err) {
                showStatus('Error updating fund name: ' + err.message, 'error');
                input.value = oldName;
            }
        }

        async function removeFundName(name) {
            if (!confirm(`Are you sure you want to delete "${name}"? This will not delete funds using this name.`)) {
                return;
            }

            try {
                await deleteFundName(name);
                fundNames.delete(name);
                await loadFundNamesList();
                showStatus('Fund name deleted successfully');
            } catch (err) {
                showStatus('Error deleting fund name: ' + err.message, 'error');
            }
        }

        async function populateFundNamesDropdown() {
            const select = document.getElementById('fundName');
            const currentValue = select.value;

            try {
                const names = await getAllFundNames();
                fundNames = new Set(names);

                select.innerHTML = '<option value="">Select a fund</option>';
                names.forEach(name => {
                    const option = document.createElement('option');
                    option.value = name;
                    option.textContent = name;
                    select.appendChild(option);
                });

                // Add option to create new fund
                const newOption = document.createElement('option');
                newOption.value = '__new__';
                newOption.textContent = '+ Add New Fund Name';
                select.appendChild(newOption);

                if (currentValue) {
                    select.value = currentValue;
                }

                // Handle new fund name creation
                select.onchange = async function() {
                    if (this.value === '__new__') {
                        const newName = prompt('Enter new fund name:');
                        if (newName && newName.trim()) {
                            const name = newName.trim();
                            if (!fundNames.has(name)) {
                                try {
                                    await saveFundName(name);
                                    fundNames.add(name);
                                    await populateFundNamesDropdown();
                                    select.value = name;
                                    showStatus('Fund name added successfully');
                                } catch (err) {
                                    showStatus('Error adding fund name: ' + err.message, 'error');
                                    this.value = '';
                                }
                            } else {
                                select.value = name;
                            }
                        } else {
                            this.value = '';
                        }
                    }
                };
            } catch (err) {
                console.error('Error populating fund names:', err);
            }
        }

        // ===========================
        // Import / Export
        // ===========================

        async function exportDatabase() {
            try {
                const funds = await getAllFunds();
                const names = await getAllFundNames();

                const exportData = {
                    funds,
                    fundNames: names,
                    exportDate: new Date().toISOString()
                };

                const dataStr = JSON.stringify(exportData, null, 2);
                const blob = new Blob([dataStr], { type: 'application/json' });
                const timestamp = new Date().toISOString().replace(/[:.]/g, '-');
                const filename = `pe-funds-export-${timestamp}.json`;

                if ('showSaveFilePicker' in window) {
                    try {
                        const handle = await window.showSaveFilePicker({
                            suggestedName: filename,
                            types: [{
                                description: 'JSON Files',
                                accept: { 'application/json': ['.json'] }
                            }]
                        });

                        const writable = await handle.createWritable();
                        await writable.write(blob);
                        await writable.close();

                        showStatus('Data exported successfully');
                        return;
                    } catch (err) {
                        if (err.name === 'AbortError') return;
                        throw err;
                    }
                }

                // Fallback
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = filename;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);

                showStatus('Data exported successfully');
            } catch (err) {
                showStatus('Error exporting data: ' + err.message, 'error');
                console.error(err);
            }
        }

        async function importDatabase(event) {
            const file = event.target.files[0];
            if (!file) return;

            try {
                const text = await file.text();
                const data = JSON.parse(text);

                let imported = 0;

                // Import fund names
                if (data.fundNames && Array.isArray(data.fundNames)) {
                    for (const name of data.fundNames) {
                        await saveFundName(name);
                        fundNames.add(name);
                    }
                }

                // Import funds
                const fundsToImport = data.funds || data;
                if (!Array.isArray(fundsToImport)) {
                    throw new Error('Invalid format: expected array of funds');
                }

                for (const fund of fundsToImport) {
                    // Normalize cash flows to ensure proper structure
                    const cashFlows = (fund.cashFlows || []).map(cf => ({
                        date: cf.date,
                        amount: parseCurrency(cf.amount),
                        type: cf.type || (cf.amount < 0 ? 'Contribution' : 'Distribution'),
                        affectsCommitment: cf.affectsCommitment !== undefined ? cf.affectsCommitment : true
                    }));

                    // Normalize monthly NAV
                    const monthlyNav = (fund.monthlyNav || []).map(nav => ({
                        date: nav.date,
                        amount: parseCurrency(nav.amount)
                    }));

                    const fundData = {
                        fundName: fund.fundName,
                        accountNumber: fund.accountNumber,
                        commitment: parseCurrency(fund.commitment),
                        cashFlows: cashFlows,
                        monthlyNav: monthlyNav,
                        timestamp: fund.timestamp || new Date().toISOString()
                    };

                    await saveFundToDB(fundData);
                    imported++;
                }

                await renderTable();
                showStatus(`Successfully imported ${imported} fund(s)`);

                event.target.value = '';
            } catch (err) {
                showStatus('Error importing data: ' + err.message, 'error');
                console.error(err);
            }
        }

        // ===========================
        // Initialization
        // ===========================

        function setControlsEnabled(enabled) {
            const buttons = document.querySelectorAll('button');
            const inputs = document.querySelectorAll('input, select, textarea');

            inputs.forEach(input => input.disabled = !enabled);
            buttons.forEach(button => button.disabled = !enabled);
        }

        async function init() {
            try {
                setControlsEnabled(false);

                await initDB();

                // Load fund names
                const names = await getAllFundNames();
                fundNames = new Set(names);

                // Set default cutoff date to latest quarter end
                const quarterEnd = getLatestQuarterEnd();
                document.getElementById('cutoffDate').value = quarterEnd.toISOString().split('T')[0];

                await renderTable();

                setControlsEnabled(true);

                console.log('PE Fund Manager initialized successfully');
            } catch (err) {
                showStatus('Error initializing application: ' + err.message, 'error');
                console.error(err);
            }
        }

        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', init);
        } else {
            init();
        }
    </script>
</body>
</html>
