<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="Content-Security-Policy"
          content="default-src 'self'; style-src 'self' 'unsafe-inline'; script-src 'self' 'unsafe-inline'; worker-src 'self' blob:; img-src 'self' data: blob:; connect-src 'self'">
    <title>PE Fund Manager</title>
    <meta name="description" content="Private Equity Fund Analytics & Management Tool">
  <script type="module" crossorigin>var lo=Object.defineProperty;var uo=(t,e,n)=>e in t?lo(t,e,{enumerable:!0,configurable:!0,writable:!0,value:n}):t[e]=n;var $=(t,e,n)=>uo(t,typeof e!="symbol"?e+"":e,n);(function(){const e=document.createElement("link").relList;if(e&&e.supports&&e.supports("modulepreload"))return;for(const a of document.querySelectorAll('link[rel="modulepreload"]'))o(a);new MutationObserver(a=>{for(const s of a)if(s.type==="childList")for(const r of s.addedNodes)r.tagName==="LINK"&&r.rel==="modulepreload"&&o(r)}).observe(document,{childList:!0,subtree:!0});function n(a){const s={};return a.integrity&&(s.integrity=a.integrity),a.referrerPolicy&&(s.referrerPolicy=a.referrerPolicy),a.crossOrigin==="use-credentials"?s.credentials="include":a.crossOrigin==="anonymous"?s.credentials="omit":s.credentials="same-origin",s}function o(a){if(a.ep)return;a.ep=!0;const s=n(a);fetch(a.href,s)}})();const I={DB_NAME:"FundsDB",FUNDS_STORE:"funds",FUNDNAMES_STORE:"fundNames",GROUPS_STORE:"groups",AUDIT_STORE:"auditLog",DISMISSED_ISSUES_STORE:"dismissedHealthIssues",DB_VERSION:12,CURRENCY_FORMAT:"en-US",CURRENCY_CODE:"USD",IRR_MAX_ITERATIONS:1e3,IRR_PRECISION:1e-6,IRR_GUESS:.1,IRR_MIN_RATE:-.99,IRR_MAX_RATE:10,IRR_MIN_DAYS:30,DATE_FORMAT:/^\d{4}-\d{2}-\d{2}$/,DEBOUNCE_FILTER:300,DEBOUNCE_SEARCH:300,DEBOUNCE_INPUT:300,MIN_COLUMN_WIDTH:50,MAX_FILE_SIZE:50*1024*1024,FUND_NAME_MIN_LENGTH:2,FUND_NAME_MAX_LENGTH:100,METRICS_CACHE_TTL:5e3,MAX_METRICS_CACHE_SIZE:1e3,LAZY_RENDER_TIMELINE:!0,TABLE_LOADING_DELAY:150,ALLOWED_FUND_NAME_PATTERN:/^[a-zA-Z0-9\s\-_.,&']+$/,MAX_IMPORT_FUNDS:1e4,MAX_IMPORT_GROUPS:1e3,MAX_IMPORT_FUNDNAMES:5e3,MAX_JSON_DEPTH:10,DANGEROUS_KEYS:["__proto__","constructor","prototype"],STORAGE_COLUMN_WIDTHS:"columnWidths",STORAGE_SHOW_TAGS:"showTags",STORAGE_GROUP_BY_FUND:"groupByFund",STORAGE_GROUP_BY_GROUP:"groupByGroup",STORAGE_EXPANDED_GROUPS:"expandedGroups",STORAGE_MASK_ACCOUNTS:"maskAccounts",STORAGE_BACKUP_WARNING:"backupWarningShown",STORAGE_LAST_BACKUP:"lastBackupDate",BACKUP_REMINDER_DAYS:30};function Ft(t){let e=2166136261;for(let n=0;n<t.length;n++){const o=t[n];o!==void 0&&(e^=o,e=e*16777619>>>0)}return e.toString(36)}function rn(t){const e=Object.keys(t).sort();let n=2166136261;for(const o of e){for(const s of o)n^=s.charCodeAt(0),n=n*16777619>>>0;const a=t[o];if(a)for(const s of a)for(const r of s)n^=r.charCodeAt(0),n=n*16777619>>>0}return n.toString(36)}class mo{constructor(){$(this,"currentFunds",[]);$(this,"fundNames",new Set);$(this,"fundNameData",new Map);$(this,"groups",[]);$(this,"groupsMap",new Map);$(this,"sortColumns",[]);$(this,"currentActionFundId",null);$(this,"currentDetailsFundId",null);$(this,"hasUnsavedChanges",!1);$(this,"fundModalHasUnsavedChanges",!1);$(this,"dataVersion",0);$(this,"lastHealthCheckVersion",-1);$(this,"dataChangedSinceLastExport",!1);$(this,"lastExportReminderTime",0);$(this,"displayLimit",50);$(this,"displayLimitIncrement",50);$(this,"metricsCache",new Map);$(this,"consolidatedMetricsCache",new Map);$(this,"groupDescendantsCache",new Map);$(this,"ancestorCache",new Map);$(this,"childrenByParentId",new Map);$(this,"filterCache",null);$(this,"groupTreeCache",null);$(this,"abortController",null)}getFunds(){return this.currentFunds}getGroups(){return this.groups}clearMetricsCache(){this.metricsCache.clear(),this.consolidatedMetricsCache.clear()}getMetricsFromCache(e,n){const o=`${e}-${n}`,a=this.metricsCache.get(o);return a?a.dataVersion!==this.dataVersion?(this.metricsCache.delete(o),null):Date.now()-a.timestamp>=I.METRICS_CACHE_TTL?(this.metricsCache.delete(o),null):a.metrics:null}setMetricsCache(e,n,o){const a=`${e}-${n}`;if(this.metricsCache.size>=I.MAX_METRICS_CACHE_SIZE){const s=this.metricsCache.keys().next().value;s&&this.metricsCache.delete(s)}this.metricsCache.set(a,{metrics:o,timestamp:Date.now(),dataVersion:this.dataVersion})}getConsolidatedMetricsFromCache(e,n,o){const a=[...o].sort((c,l)=>c-l),s=Ft(a),r=`${e}-${n}-${s}`,i=this.consolidatedMetricsCache.get(r);return!i||i.dataVersion!==this.dataVersion?null:i.metrics}setConsolidatedMetricsCache(e,n,o,a){const s=[...o].sort((c,l)=>c-l),r=Ft(s),i=`${e}-${n}-${r}`;this.consolidatedMetricsCache.set(i,{metrics:a,fundIdsHash:r,dataVersion:this.dataVersion})}getFilteredFundsFromCache(e,n){if(!this.filterCache||this.filterCache.dataVersion!==this.dataVersion)return null;const o=rn(e)+"-"+n;return this.filterCache.filterHash!==o?null:this.filterCache.fundIds}setFilteredFundsCache(e,n,o){const a=rn(e)+"-"+n;this.filterCache={fundIds:o,filterHash:a,dataVersion:this.dataVersion}}clearFilterCache(){this.filterCache=null}getGroupTreeFromCache(e,n){if(!this.groupTreeCache||this.groupTreeCache.dataVersion!==this.dataVersion)return null;const o=[...e].sort((i,c)=>i-c),a=Ft(o);if(this.groupTreeCache.fundIdsHash!==a)return null;const s=Array.from(n).map(i=>typeof i=="string"?parseInt(i):i).filter(i=>!isNaN(i)).sort((i,c)=>i-c),r=Ft(s);return this.groupTreeCache.expandedHash!==r?null:this.groupTreeCache.tree}setGroupTreeCache(e,n,o){const a=[...e].sort((c,l)=>c-l),s=Ft(a),r=Array.from(n).map(c=>typeof c=="string"?parseInt(c):c).filter(c=>!isNaN(c)).sort((c,l)=>c-l),i=Ft(r);this.groupTreeCache={tree:o,fundIdsHash:s,expandedHash:i,dataVersion:this.dataVersion}}clearGroupTreeCache(){this.groupTreeCache=null}clearConsolidatedMetricsCache(){this.consolidatedMetricsCache.clear()}setFunds(e){this.currentFunds=e}setGroups(e){this.groups=e,this.groupsMap.clear(),e.forEach(n=>this.groupsMap.set(n.id,n)),this.childrenByParentId.clear();for(const n of e){const o=n.parentGroupId,a=this.childrenByParentId.get(o)||[];a.push(n.id),this.childrenByParentId.set(o,a)}this.ancestorCache.clear(),this.groupDescendantsCache.clear(),this.groupTreeCache=null}getGroupByIdSync(e){return this.groupsMap.get(e)}getDirectChildIds(e){return this.childrenByParentId.get(e)||[]}getTopLevelGroupIds(){return this.childrenByParentId.get(null)||[]}getAncestorIds(e){const n=this.ancestorCache.get(e);if(n)return n;const o=[];let a=e;for(;a!=null;){const s=this.groupsMap.get(a);if(!s)break;o.push(s.id),a=s.parentGroupId}return this.ancestorCache.set(e,o),o}getDescendantIds(e){const n=this.groupDescendantsCache.get(e);if(n)return n;const o=[e],a=this.childrenByParentId.get(e)||[];for(const s of a){const r=this.getDescendantIds(s);o.push(...r)}return this.groupDescendantsCache.set(e,o),o}clearDescendantCache(){this.groupDescendantsCache.clear()}setUnsavedChanges(e){this.hasUnsavedChanges=e}setFundModalUnsavedChanges(e){this.fundModalHasUnsavedChanges=e}setFundNames(e){this.fundNames=e}setFundNameData(e){this.fundNameData=e}setSortColumns(e){this.sortColumns=e}setCurrentActionFundId(e){this.currentActionFundId=e}setCurrentDetailsFundId(e){this.currentDetailsFundId=e}setAbortController(e){this.abortController=e}markDataChanged(){this.dataVersion++,this.dataChangedSinceLastExport=!0}markDataExported(){this.dataChangedSinceLastExport=!1,this.lastExportReminderTime=Date.now()}needsHealthCheckRefresh(){return this.lastHealthCheckVersion!==this.dataVersion}markHealthCheckRun(){this.lastHealthCheckVersion=this.dataVersion}invalidateHealthCheck(){this.lastHealthCheckVersion=-1}shouldShowExportReminder(e){return this.dataChangedSinceLastExport?Date.now()-this.lastExportReminderTime>=e:!1}dismissExportReminder(){this.lastExportReminderTime=Date.now()}resetDisplayLimit(){this.displayLimit=50}loadMore(){this.displayLimit+=this.displayLimitIncrement}}const g=new mo;function fo(t,e){const n=[];if(!t&&e)return[{field:"record",oldValue:null,newValue:"created"}];if(t&&!e)return[{field:"record",oldValue:"existed",newValue:null}];if(!t||!e)return n;const o=new Set([...Object.keys(t),...Object.keys(e)]);for(const a of o){if(a==="id"||a==="timestamp")continue;const s=t[a],r=e[a],i=JSON.stringify(s),c=JSON.stringify(r);i!==c&&n.push({field:a,oldValue:s,newValue:r})}return n}function po(t){return t.length===0?"No changes":t.map(e=>{if(e.field==="record")return e.newValue==="created"?"Created new record":"Deleted record";const n=o=>{if(o==null)return"empty";const a=typeof o=="object"?JSON.stringify(o):String(o);return a.length>50?a.substring(0,47)+"...":a};return`${e.field}: ${n(e.oldValue)} → ${n(e.newValue)}`}).join("; ")}function W(t){if(typeof t!="string"||!/^\d{4}-\d{2}-\d{2}$/.test(t))return!1;const e=new Date(t+"T00:00:00");if(isNaN(e.getTime()))return!1;const[n,o,a]=t.split("-").map(Number);return e.getFullYear()===n&&e.getMonth()+1===o&&e.getDate()===a}function Cn(t){const e=[];if(!t||typeof t!="object")return{valid:!1,errors:["Fund data is required"]};const n=t;return(!n.fundName||typeof n.fundName!="string"||!n.fundName.trim())&&e.push("Fund name is required"),(!n.accountNumber||typeof n.accountNumber!="string"||!n.accountNumber.trim())&&e.push("Account number is required"),typeof n.commitment!="number"?e.push("Commitment must be a number"):isNaN(n.commitment)?e.push("Commitment is NaN (invalid number)"):isFinite(n.commitment)?n.commitment<0&&e.push("Commitment cannot be negative"):e.push("Commitment must be a finite number"),n.cashFlows!==void 0&&(Array.isArray(n.cashFlows)?n.cashFlows.forEach((o,a)=>{if(!o||typeof o!="object"){e.push(`Cash flow at index ${a} is invalid`);return}const s=o;typeof s.amount!="number"?e.push(`Cash flow ${a}: amount must be a number`):isNaN(s.amount)?e.push(`Cash flow ${a}: amount is NaN (invalid number)`):isFinite(s.amount)||e.push(`Cash flow ${a}: amount must be finite`),!s.date||typeof s.date!="string"?e.push(`Cash flow ${a}: date is required`):W(s.date)||e.push(`Cash flow ${a}: invalid date format (expected YYYY-MM-DD)`),s.type?["Contribution","Distribution","Adjustment"].includes(s.type)||e.push(`Cash flow ${a}: invalid type "${s.type}"`):e.push(`Cash flow ${a}: type is required`)}):e.push("Cash flows must be an array")),n.monthlyNav!==void 0&&(Array.isArray(n.monthlyNav)?n.monthlyNav.forEach((o,a)=>{if(!o||typeof o=="object"){const s=o;typeof s.amount!="number"?e.push(`NAV ${a}: amount must be a number`):isNaN(s.amount)?e.push(`NAV ${a}: amount is NaN (invalid number)`):isFinite(s.amount)||e.push(`NAV ${a}: amount must be finite`),!s.date||typeof s.date!="string"?e.push(`NAV ${a}: date is required`):W(s.date)||e.push(`NAV ${a}: invalid date format (expected YYYY-MM-DD)`)}else e.push(`NAV entry at index ${a} is invalid`)}):e.push("Monthly NAV must be an array")),{valid:e.length===0,errors:e}}let A=null;function go(){return new Promise((t,e)=>{const n=indexedDB.open(I.DB_NAME,I.DB_VERSION);n.onerror=()=>e(n.error),n.onsuccess=()=>{A=n.result,t(A)},n.onupgradeneeded=o=>{const a=o.target.result,s=o.oldVersion,r=o.target.transaction;if(!a.objectStoreNames.contains(I.FUNDS_STORE)){const i=a.createObjectStore(I.FUNDS_STORE,{keyPath:"id",autoIncrement:!0});i.createIndex("fundName","fundName",{unique:!1}),i.createIndex("accountNumber","accountNumber",{unique:!1})}if(a.objectStoreNames.contains(I.FUNDNAMES_STORE)||a.createObjectStore(I.FUNDNAMES_STORE,{keyPath:"name"}),!a.objectStoreNames.contains(I.GROUPS_STORE)){const i=a.createObjectStore(I.GROUPS_STORE,{keyPath:"id",autoIncrement:!0});i.createIndex("parentGroupId","parentGroupId",{unique:!1}),i.createIndex("name","name",{unique:!1})}if(!a.objectStoreNames.contains(I.AUDIT_STORE)){const i=a.createObjectStore(I.AUDIT_STORE,{keyPath:"id",autoIncrement:!0});i.createIndex("timestamp","timestamp",{unique:!1}),i.createIndex("operation","operation",{unique:!1}),i.createIndex("entityType","entityType",{unique:!1}),i.createIndex("entityId","entityId",{unique:!1})}if(!a.objectStoreNames.contains(I.DISMISSED_ISSUES_STORE)){const i=a.createObjectStore(I.DISMISSED_ISSUES_STORE,{keyPath:"id",autoIncrement:!0});i.createIndex("fund1Id","fund1Id",{unique:!1}),i.createIndex("fund2Id","fund2Id",{unique:!1})}if(s<6&&s>=5){a.objectStoreNames.contains("tags")&&a.deleteObjectStore("tags");const i=r.objectStore(I.FUNDS_STORE),c=r.objectStore(I.FUNDNAMES_STORE),l=new Map;i.openCursor().onsuccess=function(u){const m=u.target.result;if(m){const f=m.value;f.tags&&Array.isArray(f.tags)&&f.tags.length>0&&(l.has(f.fundName)||l.set(f.fundName,new Set),f.tags.forEach(d=>l.get(f.fundName).add(d))),delete f.tags,m.update(f),m.continue()}else c.getAll().onsuccess=function(f){f.target.result.forEach(p=>{const h=p.name,v=l.has(h)?Array.from(l.get(h)):[];c.put({name:h,tags:v})})}}}if(s===9){if(a.objectStoreNames.contains("investments")&&!a.objectStoreNames.contains("funds")){const i=a.createObjectStore("funds",{keyPath:"id",autoIncrement:!0});i.createIndex("fundName","fundName",{unique:!1}),i.createIndex("accountNumber","accountNumber",{unique:!1});const c=r.objectStore("investments");c.openCursor().onsuccess=function(l){const u=l.target.result;u&&(i.put(u.value),u.continue())}}if(a.objectStoreNames.contains("investmentNames")&&!a.objectStoreNames.contains("fundNames")){a.createObjectStore("fundNames",{keyPath:"name"});const i=r.objectStore("investmentNames"),c=r.objectStore("fundNames");i.openCursor().onsuccess=function(l){const u=l.target.result;u&&(c.put(u.value),u.continue())}}a.objectStoreNames.contains("investments")&&a.deleteObjectStore("investments"),a.objectStoreNames.contains("investmentNames")&&a.deleteObjectStore("investmentNames")}}})}async function De(t,e,n){if(!A)throw new Error("Database not initialized");return new Promise((o,a)=>{const r=A.transaction([t],e).objectStore(t),i=n(r);i.onsuccess=()=>o(i.result),i.onerror=()=>a(i.error)})}function st(t){return new Promise((e,n)=>{const o=Cn(t);if(!o.valid){const l=`Fund validation failed: ${o.errors.join("; ")}`;console.error(l,t),n(new Error(l));return}if(!A){n(new Error("Database not initialized"));return}const a=!!t.id,r=A.transaction([I.FUNDS_STORE],"readwrite").objectStore(I.FUNDS_STORE);let i;const c=()=>{let l;if(t.id)l=r.put(t);else{const{id:u,...m}=t;l=r.add(m)}l.onsuccess=()=>{const u=l.result;g.markDataChanged();const m={...t,id:u};Tn(a?"UPDATE":"CREATE",m,i).catch(console.error),e(u)},l.onerror=()=>n(l.error)};if(a){const l=r.get(t.id);l.onsuccess=()=>{i=l.result?ae(l.result):void 0,c()},l.onerror=()=>{c()}}else c()})}function cn(t){if(!t)return"";if(typeof t=="string"&&/^\d{4}-\d{2}-\d{2}$/.test(t))return t;let e=String(t).trim();const n=e.match(/^(\d{1,2})\/(\d{1,2})\/(\d{4})$/);if(n){const[,r,i,c]=n;return`${c}-${r.padStart(2,"0")}-${i.padStart(2,"0")}`}const o=e.match(/^(\d{4})\/(\d{1,2})\/(\d{1,2})$/);if(o){const[,r,i,c]=o;return`${r}-${i.padStart(2,"0")}-${c.padStart(2,"0")}`}const a=e.match(/^(\d{1,2})-(\d{1,2})-(\d{4})$/);if(a){const[,r,i,c]=a;return`${c}-${i.padStart(2,"0")}-${r.padStart(2,"0")}`}const s=e.match(/^(\d{4})-(\d{2})-(\d{2})T/);if(s){const[,r,i,c]=s;return`${r}-${i}-${c}`}return console.warn("Could not normalize date format:",t),e}function ho(t,e){if(typeof t=="string"){const n=t.toLowerCase().trim();if(n==="contribution"||n==="capital call")return"Contribution";if(n==="distribution")return"Distribution";if(n==="adjustment")return"Adjustment"}return e<0?"Contribution":"Distribution"}function ae(t){const e=Array.isArray(t.cashFlows)?t.cashFlows.map(o=>{const a=typeof o.amount=="number"?o.amount:parseFloat(o.amount)||0;return{date:cn(o.date),amount:a,type:ho(o.type,a),affectsCommitment:o.affectsCommitment!==void 0?o.affectsCommitment:!0}}):[],n=Array.isArray(t.monthlyNav)?t.monthlyNav.map(o=>({date:cn(o.date),amount:typeof o.amount=="number"?o.amount:parseFloat(o.amount)||0})):[];return{id:t.id,fundName:t.fundName||"",accountNumber:t.accountNumber||"",commitment:typeof t.commitment=="number"?t.commitment:parseFloat(t.commitment)||0,groupId:t.groupId??null,cashFlows:e,monthlyNav:n,timestamp:t.timestamp||new Date().toISOString()}}async function H(){return(await De(I.FUNDS_STORE,"readonly",e=>e.getAll())).map(ae)}async function ft(t){const e=await De(I.FUNDS_STORE,"readonly",n=>n.get(t));return e?ae(e):void 0}function Nn(t){return new Promise((e,n)=>{if(!A){n(new Error("Database not initialized"));return}const o=A.transaction([I.FUNDS_STORE],"readonly").objectStore(I.FUNDS_STORE).get(t);o.onsuccess=()=>{const a=o.result?ae(o.result):null,i=A.transaction([I.FUNDS_STORE],"readwrite").objectStore(I.FUNDS_STORE).delete(t);i.onsuccess=()=>{g.markDataChanged(),a&&Tn("DELETE",a).catch(console.error),e()},i.onerror=()=>n(i.error)},o.onerror=()=>{const r=A.transaction([I.FUNDS_STORE],"readwrite").objectStore(I.FUNDS_STORE).delete(t);r.onsuccess=()=>e(),r.onerror=()=>n(r.error)}})}function _t(){return new Promise((t,e)=>{if(!A){e(new Error("Database not initialized"));return}const a=A.transaction([I.FUNDNAMES_STORE],"readonly").objectStore(I.FUNDNAMES_STORE).getAll();a.onsuccess=()=>{const s=a.result.map(r=>({name:r.name,tags:r.tags||[],investmentTermStartDate:r.investmentTermStartDate||r.finalCloseDate||null,investmentTermYears:r.investmentTermYears||null}));t(s)},a.onerror=()=>e(a.error)})}function St(t){return new Promise((e,n)=>{if(!A){n(new Error("Database not initialized"));return}const o=typeof t=="string"?{name:t,tags:[],investmentTermStartDate:null,investmentTermYears:null}:{name:t.name,tags:t.tags||[],investmentTermStartDate:t.investmentTermStartDate||null,investmentTermYears:t.investmentTermYears||null},r=A.transaction([I.FUNDNAMES_STORE],"readwrite").objectStore(I.FUNDNAMES_STORE).put(o);r.onsuccess=()=>{g.markDataChanged(),e()},r.onerror=()=>n(r.error)})}function Fn(t){return new Promise((e,n)=>{if(!A){n(new Error("Database not initialized"));return}const s=A.transaction([I.FUNDNAMES_STORE],"readwrite").objectStore(I.FUNDNAMES_STORE).delete(t);s.onsuccess=()=>{g.markDataChanged(),e()},s.onerror=()=>n(s.error)})}function dt(){return De(I.GROUPS_STORE,"readonly",t=>t.getAll())}function xe(t){return new Promise((e,n)=>{if(!A){n(new Error("Database not initialized"));return}const s=A.transaction([I.GROUPS_STORE],"readwrite").objectStore(I.GROUPS_STORE).put(t);s.onsuccess=()=>{g.markDataChanged(),e(s.result)},s.onerror=()=>n(s.error)})}function yo(t){return new Promise((e,n)=>{if(!A){n(new Error("Database not initialized"));return}const s=A.transaction([I.GROUPS_STORE],"readwrite").objectStore(I.GROUPS_STORE).delete(t);s.onsuccess=()=>{g.markDataChanged(),e()},s.onerror=()=>n(s.error)})}function vo(){return new Promise((t,e)=>{if(!A){e(new Error("Database not initialized"));return}const n=A.transaction([I.FUNDS_STORE,I.FUNDNAMES_STORE,I.GROUPS_STORE],"readwrite");let o=0,a=!1;const s=[I.FUNDS_STORE,I.FUNDNAMES_STORE,I.GROUPS_STORE];s.forEach(r=>{const c=n.objectStore(r).clear();c.onsuccess=()=>{a||(o++,o===s.length&&(a=!0,g.markDataChanged(),Bn({operation:"CLEAR_ALL",entityType:"System",entityId:null,entityName:null,summary:"Cleared all data (funds, groups, fund names)"}).catch(console.error),t()))},c.onerror=()=>{a||(a=!0,e(c.error))}})})}function Bn(t){return new Promise((e,n)=>{if(!A){console.warn("[AUDIT] DB not ready, logging to console:",t),e(-1);return}if(!A.objectStoreNames.contains(I.AUDIT_STORE)){console.warn("[AUDIT] Audit store not available, logging to console:",t),e(-1);return}const o={...t,timestamp:new Date().toISOString()},r=A.transaction([I.AUDIT_STORE],"readwrite").objectStore(I.AUDIT_STORE).add(o);r.onsuccess=()=>e(r.result),r.onerror=()=>{console.error("[AUDIT] Failed to log entry:",r.error),n(r.error)}})}function bo(t){return new Promise((e,n)=>{if(!A){n(new Error("Database not initialized"));return}if(!A.objectStoreNames.contains(I.AUDIT_STORE)){e([]);return}const s=A.transaction([I.AUDIT_STORE],"readonly").objectStore(I.AUDIT_STORE).getAll();s.onsuccess=()=>{let r=s.result;r.sort((i,c)=>c.timestamp.localeCompare(i.timestamp)),e(r)},s.onerror=()=>n(s.error)})}async function Tn(t,e,n){const o=fo(n,t==="DELETE"?null:e);await Bn({operation:t,entityType:"Fund",entityId:e.id??null,entityName:e.fundName,summary:po(o),previousValue:n,newValue:t==="DELETE"?void 0:e})}function Io(){return new Promise((t,e)=>{if(!A){e(new Error("Database not initialized"));return}if(!A.objectStoreNames.contains(I.DISMISSED_ISSUES_STORE)){t([]);return}const a=A.transaction([I.DISMISSED_ISSUES_STORE],"readonly").objectStore(I.DISMISSED_ISSUES_STORE).getAll();a.onsuccess=()=>t(a.result),a.onerror=()=>e(a.error)})}function So(t,e,n){return new Promise((o,a)=>{if(!A){a(new Error("Database not initialized"));return}if(!A.objectStoreNames.contains(I.DISMISSED_ISSUES_STORE)){a(new Error("Dismissed issues store not available"));return}const s=Math.min(t,e),r=Math.max(t,e),i={fund1Id:s,fund2Id:r,reason:n,dismissedAt:new Date().toISOString()},u=A.transaction([I.DISMISSED_ISSUES_STORE],"readwrite").objectStore(I.DISMISSED_ISSUES_STORE).add(i);u.onsuccess=()=>o(),u.onerror=()=>a(u.error)})}function wo(t,e,n){return new Promise((o,a)=>{if(!A){a(new Error("Database not initialized"));return}if(!A.objectStoreNames.contains(I.DISMISSED_ISSUES_STORE)){a(new Error("Dismissed issues store not available"));return}const s={fund1Id:t,fund2Id:0,category:e,message:n,reason:`${e}: ${n}`,dismissedAt:new Date().toISOString()},c=A.transaction([I.DISMISSED_ISSUES_STORE],"readwrite").objectStore(I.DISMISSED_ISSUES_STORE).add(s);c.onsuccess=()=>o(),c.onerror=()=>a(c.error)})}function Eo(t){return new Date(t+"T00:00:00").getTime()}function Dn(t,e=I.IRR_GUESS){if(!Array.isArray(t)||t.length<2)return null;const n=t.map(d=>({amount:d.amount,timestamp:Eo(d.date)}));n.sort((d,p)=>d.timestamp-p.timestamp);const o=n[0],a=n[n.length-1];if(!o||!a)return null;const s=o.timestamp,i=(a.timestamp-s)/(24*60*60*1e3);if(i<I.IRR_MIN_DAYS)return null;const c=365.25*24*60*60*1e3,l=n.map(d=>({amount:d.amount,yearsDiff:(d.timestamp-s)/c})),u=d=>l.reduce((p,h)=>p+h.amount/Math.pow(1+d,h.yearsDiff),0),m=d=>l.reduce((p,h)=>h.yearsDiff===0?p:p-h.yearsDiff*h.amount/Math.pow(1+d,h.yearsDiff+1),0);let f=e;for(let d=0;d<I.IRR_MAX_ITERATIONS;d++){const p=u(f),h=m(f);if(Math.abs(p)<I.IRR_PRECISION)return f>I.IRR_MAX_RATE||f<I.IRR_MIN_RATE?null:f;if(Math.abs(h)<I.IRR_PRECISION)return null;const v=f-p/h;if(Math.abs(v-f)<I.IRR_PRECISION)return v>I.IRR_MAX_RATE||v<I.IRR_MIN_RATE?null:v;f=v}return console.debug("IRR: Max iterations reached without convergence",{finalRate:f,finalNpv:u(f),cashFlowCount:t.length,daySpan:i}),null}function xn(t){if(!Array.isArray(t)||t.length===0)return null;const e=t.filter(o=>o.amount<0).reduce((o,a)=>o+Math.abs(a.amount),0),n=t.filter(o=>o.amount>0).reduce((o,a)=>o+a.amount,0);return e===0?null:n/e}function nt(t){if(t===null||typeof t>"u")return NaN;if(typeof t=="number")return isFinite(t)?t:NaN;if(typeof t=="string"){const e=t.replace(/[$,]/g,"").replace(/^\((.*)\)$/,"-$1").trim();if(e==="")return NaN;const n=parseFloat(e);return isFinite(n)?n:NaN}return NaN}function ee(t){if(t==null||isNaN(t))return"";const e=t.toString().split(".");return e[0]=e[0].replace(/\B(?=(\d{3})+(?!\d))/g,","),e.join(".")}function x(t,e=!1){const n=typeof t=="string"?parseFloat(t):t;return!isFinite(n)||isNaN(n)?"$0":n.toLocaleString("en-US",{style:"currency",currency:"USD",minimumFractionDigits:e?2:0,maximumFractionDigits:e?2:0})}function de(t){return Math.round(t*100)/100}function wt(t,e){const n=nt(t);return n===null&&t!=null&&t!==""&&t!==0&&console.warn(`Currency parse failed (${e}):`,t),n||0}function Q(t){return new Date(t+"T00:00:00")}function Co(t,e){const n=e?e.getTime():null,o=(t.cashFlows||[]).filter(s=>W(s.date)).map(s=>({date:s.date,timestamp:Q(s.date).getTime(),type:s.type,amount:wt(s.amount,"cash flow amount"),affectsCommitment:s.affectsCommitment!==!1})).filter(s=>n===null||s.timestamp<=n),a=(t.monthlyNav||[]).filter(s=>W(s.date)).map(s=>({date:s.date,timestamp:Q(s.date).getTime(),amount:wt(s.amount,"NAV amount")})).filter(s=>n===null||s.timestamp<=n);return{cashFlows:o,navs:a,cutoffTimestamp:n}}function he(t){let e=null;for(const n of t.cashFlows||[])n.type==="Contribution"&&W(n.date)&&(e===null||n.date<e)&&(e=n.date);return e?Q(e).getFullYear():null}function No(t,e,n){return(t.cashFlows||[]).filter(a=>a.type===e&&W(a.date)&&!0).reduce((a,s)=>a+Math.abs(wt(s.amount,"cash flow amount")),0)}function Fo(t,e){const n=(t.monthlyNav||[]).filter(i=>W(i.date)&&(!e||Q(i.date)<=e)).sort((i,c)=>Q(c.date).getTime()-Q(i.date).getTime());if(n.length===0)return 0;const o=n[0];let a=wt(o.amount,"NAV amount");const s=Q(o.date);return(t.cashFlows||[]).filter(i=>{if(!W(i.date))return!1;const c=Q(i.date);return c>s&&(!e||c<=e)}).forEach(i=>{const c=wt(i.amount,"cash flow amount");i.type==="Contribution"?a+=Math.abs(c):i.type==="Distribution"&&(a-=Math.abs(c))}),a}function Bo(t,e){const n=(t.cashFlows||[]).filter(s=>W(s.date)&&(!e||Q(s.date)<=e)&&s.type!=="Adjustment").map(s=>{const r=wt(s.amount,"cash flow amount");return{date:s.date,amount:s.type==="Contribution"?-Math.abs(r):Math.abs(r)}}),o=Fo(t,e),a=(t.monthlyNav||[]).filter(s=>W(s.date)&&(!e||Q(s.date)<=e)).sort((s,r)=>Q(r.date).getTime()-Q(s.date).getTime());return a.length>0&&n.push({date:a[0].date,amount:o}),n.sort((s,r)=>Q(s.date).getTime()-Q(r.date).getTime())}function ot(t,e){const n=wt(t.commitment,"commitment"),{cashFlows:o,navs:a}=Co(t,e),s=[...o].sort((y,B)=>y.timestamp-B.timestamp),r=[...a].sort((y,B)=>B.timestamp-y.timestamp),i=de(s.filter(y=>y.type==="Contribution").reduce((y,B)=>y+Math.abs(B.amount),0)),c=de(s.filter(y=>y.type==="Distribution").reduce((y,B)=>y+Math.abs(B.amount),0));let l=0,u=null;if(r.length>0){const y=r[0];l=y.amount,u=y.date;const B=y.timestamp;for(const k of s)k.timestamp>B&&(k.type==="Contribution"?l+=Math.abs(k.amount):k.type==="Distribution"&&(l-=Math.abs(k.amount)))}let m=n;for(const y of s)y.type==="Adjustment"?m-=y.amount:y.affectsCommitment&&(y.type==="Contribution"?m-=Math.abs(y.amount):y.type==="Distribution"&&(m+=Math.abs(y.amount)));m=Math.max(0,m);const f=s.find(y=>y.type==="Contribution"),d=f?new Date(f.timestamp).getFullYear():null,p=de(c+l-i),h=s.filter(y=>y.type!=="Adjustment").map(y=>({date:y.date,amount:y.type==="Contribution"?-Math.abs(y.amount):Math.abs(y.amount)}));r.length>0&&h.push({date:r[0].date,amount:l}),h.sort((y,B)=>Q(y.date).getTime()-Q(B.date).getTime());const v=Dn(h),S=xn(h),E=i>0?c/i:null,C=i>0?l/i:null,N=i>0?(c+l)/i:null;return{calledCapital:i,distributions:c,nav:l,navDate:u,irr:v,moic:S,dpi:E,rvpi:C,tvpi:N,outstandingCommitment:m,vintageYear:d,commitment:n,totalContributions:i,totalDistributions:c,investmentReturn:p,vintage:d}}function ye(t,e){if(t.id==null)return ot(t,e);const n=e?.toISOString()??"current",o=g.getMetricsFromCache(t.id,n);if(o)return o;const a=ot(t,e);return g.setMetricsCache(t.id,n,a),a}const kn="KGZ1bmN0aW9uKCl7InVzZSBzdHJpY3QiO2NvbnN0IGQ9e0lSUl9NQVhfSVRFUkFUSU9OUzoxZTMsSVJSX1BSRUNJU0lPTjoxZS02LElSUl9HVUVTUzouMSxJUlJfTUlOX1JBVEU6LS45OSxJUlJfTUFYX1JBVEU6MTAsSVJSX01JTl9EQVlTOjMwfTtmdW5jdGlvbiBUKHQpe2lmKHR5cGVvZiB0IT0ic3RyaW5nInx8IS9eXGR7NH0tXGR7Mn0tXGR7Mn0kLy50ZXN0KHQpKXJldHVybiExO2NvbnN0IHM9bmV3IERhdGUodCsiVDAwOjAwOjAwIik7aWYoaXNOYU4ocy5nZXRUaW1lKCkpKXJldHVybiExO2NvbnN0W2EsaSx1XT10LnNwbGl0KCItIikubWFwKE51bWJlcik7cmV0dXJuIHMuZ2V0RnVsbFllYXIoKT09PWEmJnMuZ2V0TW9udGgoKSsxPT09aSYmcy5nZXREYXRlKCk9PT11fWZ1bmN0aW9uIF8odCl7aWYodD09PW51bGx8fHR5cGVvZiB0PiJ1IilyZXR1cm4gTmFOO2lmKHR5cGVvZiB0PT0ibnVtYmVyIilyZXR1cm4gaXNGaW5pdGUodCk/dDpOYU47aWYodHlwZW9mIHQ9PSJzdHJpbmciKXtjb25zdCBzPXQucmVwbGFjZSgvWyQsXS9nLCIiKS5yZXBsYWNlKC9eXCgoLiopXCkkLywiLSQxIikudHJpbSgpO2lmKHM9PT0iIilyZXR1cm4gTmFOO2NvbnN0IGE9cGFyc2VGbG9hdChzKTtyZXR1cm4gaXNGaW5pdGUoYSk/YTpOYU59cmV0dXJuIE5hTn1mdW5jdGlvbiBDKHQpe3JldHVybiBuZXcgRGF0ZSh0KyJUMDA6MDA6MDAiKS5nZXRUaW1lKCl9ZnVuY3Rpb24gQSh0LHM9ZC5JUlJfR1VFU1Mpe2lmKCFBcnJheS5pc0FycmF5KHQpfHx0Lmxlbmd0aDwyKXJldHVybiBudWxsO2NvbnN0IGE9dC5tYXAobz0+KHthbW91bnQ6by5hbW91bnQsdGltZXN0YW1wOkMoby5kYXRlKX0pKTthLnNvcnQoKG8sZik9Pm8udGltZXN0YW1wLWYudGltZXN0YW1wKTtjb25zdCBpPWFbMF0sdT1hW2EubGVuZ3RoLTFdO2lmKCFpfHwhdSlyZXR1cm4gbnVsbDtjb25zdCBuPWkudGltZXN0YW1wLG09KHUudGltZXN0YW1wLW4pLygyNCo2MCo2MCoxZTMpO2lmKG08ZC5JUlJfTUlOX0RBWVMpcmV0dXJuIG51bGw7Y29uc3QgUj0zNjUuMjUqMjQqNjAqNjAqMWUzLGM9YS5tYXAobz0+KHthbW91bnQ6by5hbW91bnQseWVhcnNEaWZmOihvLnRpbWVzdGFtcC1uKS9SfSkpLE49bz0+Yy5yZWR1Y2UoKGYscik9PmYrci5hbW91bnQvTWF0aC5wb3coMStvLHIueWVhcnNEaWZmKSwwKSxJPW89PmMucmVkdWNlKChmLHIpPT5yLnllYXJzRGlmZj09PTA/ZjpmLXIueWVhcnNEaWZmKnIuYW1vdW50L01hdGgucG93KDErbyxyLnllYXJzRGlmZisxKSwwKTtsZXQgbD1zO2ZvcihsZXQgbz0wO288ZC5JUlJfTUFYX0lURVJBVElPTlM7bysrKXtjb25zdCBmPU4obCkscj1JKGwpO2lmKE1hdGguYWJzKGYpPGQuSVJSX1BSRUNJU0lPTilyZXR1cm4gbD5kLklSUl9NQVhfUkFURXx8bDxkLklSUl9NSU5fUkFURT9udWxsOmw7aWYoTWF0aC5hYnMocik8ZC5JUlJfUFJFQ0lTSU9OKXJldHVybiBudWxsO2NvbnN0IHk9bC1mL3I7aWYoTWF0aC5hYnMoeS1sKTxkLklSUl9QUkVDSVNJT04pcmV0dXJuIHk+ZC5JUlJfTUFYX1JBVEV8fHk8ZC5JUlJfTUlOX1JBVEU/bnVsbDp5O2w9eX1yZXR1cm4gY29uc29sZS5kZWJ1ZygiSVJSOiBNYXggaXRlcmF0aW9ucyByZWFjaGVkIHdpdGhvdXQgY29udmVyZ2VuY2UiLHtmaW5hbFJhdGU6bCxmaW5hbE5wdjpOKGwpLGNhc2hGbG93Q291bnQ6dC5sZW5ndGgsZGF5U3BhbjptfSksbnVsbH1mdW5jdGlvbiB3KHQpe2lmKCFBcnJheS5pc0FycmF5KHQpfHx0Lmxlbmd0aD09PTApcmV0dXJuIG51bGw7Y29uc3Qgcz10LmZpbHRlcihpPT5pLmFtb3VudDwwKS5yZWR1Y2UoKGksdSk9PmkrTWF0aC5hYnModS5hbW91bnQpLDApLGE9dC5maWx0ZXIoaT0+aS5hbW91bnQ+MCkucmVkdWNlKChpLHUpPT5pK3UuYW1vdW50LDApO3JldHVybiBzPT09MD9udWxsOmEvc31mdW5jdGlvbiBnKHQpe3JldHVybiBNYXRoLnJvdW5kKHQqMTAwKS8xMDB9ZnVuY3Rpb24gRCh0LHMpe2NvbnN0IGE9Xyh0KTtyZXR1cm4gYT09PW51bGwmJnQhPW51bGwmJnQhPT0iIiYmdCE9PTAmJmNvbnNvbGUud2FybihgQ3VycmVuY3kgcGFyc2UgZmFpbGVkICgke3N9KTpgLHQpLGF8fDB9ZnVuY3Rpb24gYih0KXtyZXR1cm4gbmV3IERhdGUodCsiVDAwOjAwOjAwIil9ZnVuY3Rpb24gRSh0LHMpe2NvbnN0IGE9cz9zLmdldFRpbWUoKTpudWxsLGk9KHQuY2FzaEZsb3dzfHxbXSkuZmlsdGVyKG49PlQobi5kYXRlKSkubWFwKG49Pih7ZGF0ZTpuLmRhdGUsdGltZXN0YW1wOmIobi5kYXRlKS5nZXRUaW1lKCksdHlwZTpuLnR5cGUsYW1vdW50OkQobi5hbW91bnQsImNhc2ggZmxvdyBhbW91bnQiKSxhZmZlY3RzQ29tbWl0bWVudDpuLmFmZmVjdHNDb21taXRtZW50IT09ITF9KSkuZmlsdGVyKG49PmE9PT1udWxsfHxuLnRpbWVzdGFtcDw9YSksdT0odC5tb250aGx5TmF2fHxbXSkuZmlsdGVyKG49PlQobi5kYXRlKSkubWFwKG49Pih7ZGF0ZTpuLmRhdGUsdGltZXN0YW1wOmIobi5kYXRlKS5nZXRUaW1lKCksYW1vdW50OkQobi5hbW91bnQsIk5BViBhbW91bnQiKX0pKS5maWx0ZXIobj0+YT09PW51bGx8fG4udGltZXN0YW1wPD1hKTtyZXR1cm57Y2FzaEZsb3dzOmksbmF2czp1LGN1dG9mZlRpbWVzdGFtcDphfX1mdW5jdGlvbiB2KHQscyl7Y29uc3QgYT1EKHQuY29tbWl0bWVudCwiY29tbWl0bWVudCIpLHtjYXNoRmxvd3M6aSxuYXZzOnV9PUUodCxzKSxuPVsuLi5pXS5zb3J0KChlLHApPT5lLnRpbWVzdGFtcC1wLnRpbWVzdGFtcCksTT1bLi4udV0uc29ydCgoZSxwKT0+cC50aW1lc3RhbXAtZS50aW1lc3RhbXApLG09ZyhuLmZpbHRlcihlPT5lLnR5cGU9PT0iQ29udHJpYnV0aW9uIikucmVkdWNlKChlLHApPT5lK01hdGguYWJzKHAuYW1vdW50KSwwKSksUj1nKG4uZmlsdGVyKGU9PmUudHlwZT09PSJEaXN0cmlidXRpb24iKS5yZWR1Y2UoKGUscCk9PmUrTWF0aC5hYnMocC5hbW91bnQpLDApKTtsZXQgYz0wLE49bnVsbDtpZihNLmxlbmd0aD4wKXtjb25zdCBlPU1bMF07Yz1lLmFtb3VudCxOPWUuZGF0ZTtjb25zdCBwPWUudGltZXN0YW1wO2Zvcihjb25zdCBoIG9mIG4paC50aW1lc3RhbXA+cCYmKGgudHlwZT09PSJDb250cmlidXRpb24iP2MrPU1hdGguYWJzKGguYW1vdW50KTpoLnR5cGU9PT0iRGlzdHJpYnV0aW9uIiYmKGMtPU1hdGguYWJzKGguYW1vdW50KSkpfWxldCBJPWE7Zm9yKGNvbnN0IGUgb2YgbillLnR5cGU9PT0iQWRqdXN0bWVudCI/SS09ZS5hbW91bnQ6ZS5hZmZlY3RzQ29tbWl0bWVudCYmKGUudHlwZT09PSJDb250cmlidXRpb24iP0ktPU1hdGguYWJzKGUuYW1vdW50KTplLnR5cGU9PT0iRGlzdHJpYnV0aW9uIiYmKEkrPU1hdGguYWJzKGUuYW1vdW50KSkpO0k9TWF0aC5tYXgoMCxJKTtjb25zdCBsPW4uZmluZChlPT5lLnR5cGU9PT0iQ29udHJpYnV0aW9uIiksbz1sP25ldyBEYXRlKGwudGltZXN0YW1wKS5nZXRGdWxsWWVhcigpOm51bGwsZj1nKFIrYy1tKSxyPW4uZmlsdGVyKGU9PmUudHlwZSE9PSJBZGp1c3RtZW50IikubWFwKGU9Pih7ZGF0ZTplLmRhdGUsYW1vdW50OmUudHlwZT09PSJDb250cmlidXRpb24iPy1NYXRoLmFicyhlLmFtb3VudCk6TWF0aC5hYnMoZS5hbW91bnQpfSkpO00ubGVuZ3RoPjAmJnIucHVzaCh7ZGF0ZTpNWzBdLmRhdGUsYW1vdW50OmN9KSxyLnNvcnQoKGUscCk9PmIoZS5kYXRlKS5nZXRUaW1lKCktYihwLmRhdGUpLmdldFRpbWUoKSk7Y29uc3QgeT1BKHIpLFM9dyhyKSxGPW0+MD9SL206bnVsbCxPPW0+MD9jL206bnVsbCxZPW0+MD8oUitjKS9tOm51bGw7cmV0dXJue2NhbGxlZENhcGl0YWw6bSxkaXN0cmlidXRpb25zOlIsbmF2OmMsbmF2RGF0ZTpOLGlycjp5LG1vaWM6UyxkcGk6RixydnBpOk8sdHZwaTpZLG91dHN0YW5kaW5nQ29tbWl0bWVudDpJLHZpbnRhZ2VZZWFyOm8sY29tbWl0bWVudDphLHRvdGFsQ29udHJpYnV0aW9uczptLHRvdGFsRGlzdHJpYnV0aW9uczpSLGludmVzdG1lbnRSZXR1cm46Zix2aW50YWdlOm99fXNlbGYub25tZXNzYWdlPXQ9Pntjb25zdHt0eXBlOnMsZnVuZHM6YSxjdXRvZmZEYXRlOmkscmVxdWVzdElkOnV9PXQuZGF0YTtpZihzPT09ImNhbGN1bGF0ZU1ldHJpY3MiKXtjb25zdCBuPWk/bmV3IERhdGUoaSsiVDAwOjAwOjAwIik6dm9pZCAwLG09e3R5cGU6Im1ldHJpY3NSZXN1bHQiLHJlc3VsdHM6YS5tYXAoUj0+KHtmdW5kSWQ6Ui5pZCxtZXRyaWNzOnYoUixuKX0pKSxyZXF1ZXN0SWQ6dX07c2VsZi5wb3N0TWVzc2FnZShtKX19LHNlbGYucG9zdE1lc3NhZ2Uoe3R5cGU6InJlYWR5In0pfSkoKTsK",To=t=>Uint8Array.from(atob(t),e=>e.charCodeAt(0)),ln=typeof self<"u"&&self.Blob&&new Blob([To(kn)],{type:"text/javascript;charset=utf-8"});function Do(t){let e;try{if(e=ln&&(self.URL||self.webkitURL).createObjectURL(ln),!e)throw"";const n=new Worker(e,{name:t?.name});return n.addEventListener("error",()=>{(self.URL||self.webkitURL).revokeObjectURL(e)}),n}catch{return new Worker("data:text/javascript;base64,"+kn,{name:t?.name})}finally{e&&(self.URL||self.webkitURL).revokeObjectURL(e)}}let ct=null,xo=0;const mt=new Map;function An(){return typeof Worker<"u"}function ko(){return new Promise((t,e)=>{if(!An()){e(new Error("Web Workers not supported"));return}if(ct){t();return}try{ct=new Do,ct.onmessage=n=>{const o=n.data;if(o.type==="ready"){t();return}if(o.type==="metricsResult"){const a=mt.get(o.requestId);a&&(clearTimeout(a.timeoutId),a.resolve(o.results),mt.delete(o.requestId))}},ct.onerror=n=>{console.error("Metrics worker error:",n);for(const[o,a]of mt)clearTimeout(a.timeoutId),a.reject(new Error("Worker error")),mt.delete(o)},setTimeout(()=>{ct||e(new Error("Worker initialization timeout"))},5e3)}catch(n){e(n)}})}function Ao(t,e){return new Promise((n,o)=>{if(!ct){o(new Error("Worker not initialized"));return}const a=++xo,s=setTimeout(()=>{const i=mt.get(a);i&&(i.reject(new Error("Worker request timeout")),mt.delete(a))},3e4);mt.set(a,{resolve:n,reject:o,timeoutId:s});const r={type:"calculateMetrics",funds:t,cutoffDate:e?.toISOString().split("T")[0],requestId:a};ct.postMessage(r)})}function Mo(){if(ct){ct.terminate(),ct=null;for(const t of mt.values())clearTimeout(t.timeoutId);mt.clear()}}function Go(){return ct!==null}function T(t){if(typeof t!="string")return"";const e=document.createElement("div");return e.textContent=t,e.innerHTML}function At(t){if(t==null)return"";const e=String(t);return e.includes(",")||e.includes('"')||e.includes(`
`)?'"'+e.replace(/"/g,'""')+'"':e}function X(t){return typeof t!="string"?"":t.replace(/&/g,"&amp;").replace(/"/g,"&quot;").replace(/'/g,"&#39;").replace(/</g,"&lt;").replace(/>/g,"&gt;")}function Yt(t){return t==null||!isFinite(t)?"N/A":t.toFixed(2)+"x"}function Wt(t){return t==null||!isFinite(t)?"N/A":(t*100).toFixed(2)+"%"}function Mn(t){if(!t.groupId)return"";const e=g.getGroupByIdSync(t.groupId);return e?e.name:""}function ve(t){const e=Mn(t);return e?`${e} (${t.accountNumber})`:t.accountNumber}function Lo(t){const e=Mn(t);return e?`<div>${T(e)}</div><div style="font-size: 0.85em; color: var(--color-text-light);">${T(t.accountNumber)}</div>`:T(t.accountNumber)}function Gn(t,e,n){if(e.length===0)return t;const o=new Set(["vintage","commitment","totalContributions","totalDistributions","nav","investmentReturn","moic","irr","outstandingCommitment"]),a=e.some(({column:i})=>o.has(i)),s=new Map,r=i=>{if(i.id!=null){let c=s.get(i.id);return c||(c=ye(i,n),s.set(i.id,c)),c}return ye(i,n)};return[...t].sort((i,c)=>{for(const{column:l,direction:u}of e){const m=u==="asc"?1:-1;let f=0;const d=a?r(i):void 0,p=a?r(c):void 0;switch(l){case"fundName":f=i.fundName.localeCompare(c.fundName);break;case"accountNumber":f=ve(i).localeCompare(ve(c));break;case"vintage":f=(d.vintageYear||0)-(p.vintageYear||0);break;case"commitment":f=(d.commitment||0)-(p.commitment||0);break;case"totalContributions":f=(d.calledCapital||0)-(p.calledCapital||0);break;case"totalDistributions":f=(d.distributions||0)-(p.distributions||0);break;case"nav":f=(d.nav||0)-(p.nav||0);break;case"investmentReturn":f=(d.investmentReturn||0)-(p.investmentReturn||0);break;case"moic":f=(d.moic||0)-(p.moic||0);break;case"irr":f=(d.irr||0)-(p.irr||0);break;case"outstandingCommitment":f=(d.outstandingCommitment||0)-(p.outstandingCommitment||0);break;default:f=0}if(f!==0)return f*m}return 0})}function Ro(t,e,n=!1){const o=t.metrics,a=g.fundNameData.get(t.fundName),s=a&&a.tags?a.tags:[],r=n&&s.length>0?`<div class="table-tags">${s.map(c=>`<span class="table-tag">${T(c)}</span>`).join("")}</div>`:"",i=o.investmentReturn??o.distributions+o.nav-o.calledCapital;return`
    <td>
      <div>${T(t.fundName)}</div>
      ${r}
    </td>
    <td title="${T(ve(t))}">${Lo(t)}</td>
    <td class="center">${o.vintageYear||"N/A"}</td>
    <td class="number">${x(o.commitment||0)}</td>
    <td class="number">${x(o.calledCapital)}</td>
    <td class="number">${x(o.distributions)}</td>
    <td class="number">${x(o.nav)}</td>
    <td class="number ${i>=0?"positive":"negative"}">${x(i)}</td>
    <td class="number">${Yt(o.moic)}</td>
    <td class="number ${o.irr!==null&&o.irr>=0?"positive":"negative"}">${Wt(o.irr)}</td>
    <td class="number">${x(o.outstandingCommitment)}</td>
    <td class="center">
      <button class="btn-icon table-action-btn" data-action="menu" data-fund-id="${X(String(t.id))}" title="Actions" aria-label="Actions for ${T(t.fundName)}">⚙</button>
    </td>
  `}function Ln(t,e){const n={commitment:0,calledCapital:0,distributions:0,nav:0,investmentReturn:0,outstandingCommitment:0,aggregateFlows:[]};t.forEach(c=>{const l=c.metrics;n.commitment+=l.commitment||0,n.calledCapital+=l.calledCapital,n.distributions+=l.distributions,n.nav+=l.nav,n.investmentReturn+=l.investmentReturn??l.distributions+l.nav-l.calledCapital,n.outstandingCommitment+=l.outstandingCommitment;const u=Bo(c,e);n.aggregateFlows.push(...u)});const o=Dn(n.aggregateFlows),a=xn(n.aggregateFlows),s=n.calledCapital>0?n.distributions/n.calledCapital:null,r=n.calledCapital>0?n.nav/n.calledCapital:null,i=n.calledCapital>0?(n.distributions+n.nav)/n.calledCapital:null;return{commitment:n.commitment,calledCapital:n.calledCapital,distributions:n.distributions,nav:n.nav,investmentReturn:n.investmentReturn,outstandingCommitment:n.outstandingCommitment,aggregateIRR:o,aggregateMOIC:a,aggregateDPI:s,aggregateRVPI:r,aggregateTVPI:i}}function me(t){return`
    <td><strong>Total</strong></td>
    <td></td>
    <td></td>
    <td class="number"><strong>${x(t.commitment)}</strong></td>
    <td class="number"><strong>${x(t.calledCapital)}</strong></td>
    <td class="number"><strong>${x(t.distributions)}</strong></td>
    <td class="number"><strong>${x(t.nav)}</strong></td>
    <td class="number ${t.investmentReturn>=0?"positive":"negative"}"><strong>${x(t.investmentReturn)}</strong></td>
    <td class="number"><strong>${Yt(t.aggregateMOIC)}</strong></td>
    <td class="number ${t.aggregateIRR!==null&&t.aggregateIRR>=0?"positive":"negative"}"><strong>${Wt(t.aggregateIRR)}</strong></td>
    <td class="number"><strong>${x(t.outstandingCommitment)}</strong></td>
    <td></td>
  `}function $o(t,e){const n=Ln(t,e),o=new Set(t.map(s=>s.fundName)),a={investmentCount:document.getElementById("summaryInvestmentCount"),fundCount:document.getElementById("summaryFundCount"),commitment:document.getElementById("summaryCommitment"),nav:document.getElementById("summaryNav"),irr:document.getElementById("summaryIRR"),moic:document.getElementById("summaryMOIC"),dpi:document.getElementById("summaryDPI"),rvpi:document.getElementById("summaryRVPI"),tvpi:document.getElementById("summaryTVPI")};a.investmentCount&&(a.investmentCount.textContent=t.length.toString()),a.fundCount&&(a.fundCount.textContent=o.size.toString()),a.commitment&&(a.commitment.textContent=x(n.commitment)),a.nav&&(a.nav.textContent=x(n.nav)),a.irr&&(a.irr.textContent=Wt(n.aggregateIRR)),a.moic&&(a.moic.textContent=Yt(n.aggregateMOIC)),a.dpi&&(a.dpi.textContent=n.aggregateDPI!==null?n.aggregateDPI.toFixed(2)+"x":"N/A"),a.rvpi&&(a.rvpi.textContent=n.aggregateRVPI!==null?n.aggregateRVPI.toFixed(2)+"x":"N/A"),a.tvpi&&(a.tvpi.textContent=n.aggregateTVPI!==null?n.aggregateTVPI.toFixed(2)+"x":"N/A")}function Oo(t){document.querySelectorAll("#fundsTable th").forEach(e=>{e.classList.remove("sorted-asc","sorted-desc"),e.removeAttribute("data-sort-priority")}),t.forEach(({column:e,direction:n},o)=>{const a=document.querySelector(`#fundsTable th[data-sort="${e}"]`);a&&(a.classList.add(n==="asc"?"sorted-asc":"sorted-desc"),t.length>1&&a.setAttribute("data-sort-priority",(o+1).toString()))})}function Rn(t,e,n=[]){const o=new Map;for(const r of t){const i=o.get(r.fundName)||[];i.push(r),o.set(r.fundName,i)}const a=[],s=e?e.toISOString().split("T")[0]??"":"";for(const[r,i]of o){const c=i.map(p=>p.id).filter(p=>p!=null),l=g.getConsolidatedMetricsFromCache(r,s,c);let u;if(l)u=l;else{const p=[];let h=0,v=0,S=null;for(const y of i)p.push(...y.cashFlows),h+=y.commitment,v+=y.metrics.nav,y.metrics.navDate&&(!S||y.metrics.navDate>S)&&(S=y.metrics.navDate);const C=[{date:S??new Date().toISOString().split("T")[0]??"",amount:v}],N={accountNumber:`${i.length} investor${i.length!==1?"s":""}`,commitment:h,cashFlows:p,monthlyNav:C,timestamp:new Date().toISOString()};u=ot(N,e),g.setConsolidatedMetricsCache(r,s,c,u)}const m=i[0],f=i.reduce((p,h)=>p+h.commitment,0),d={fundName:r,accountNumber:`${i.length} investor${i.length!==1?"s":""}`,commitment:f,cashFlows:[],monthlyNav:[],groupId:null,timestamp:new Date().toISOString(),id:m?.id,investorCount:i.length,consolidatedMetrics:u};a.push(d)}return n.length>0?a.sort((r,i)=>{for(const{column:c,direction:l}of n){const u=l==="asc"?1:-1;let m=0;const f=r.consolidatedMetrics,d=i.consolidatedMetrics;switch(c){case"fundName":m=r.fundName.localeCompare(i.fundName);break;case"accountNumber":m=r.investorCount-i.investorCount;break;case"vintage":m=(f.vintageYear||0)-(d.vintageYear||0);break;case"commitment":m=(f.commitment||0)-(d.commitment||0);break;case"totalContributions":m=f.calledCapital-d.calledCapital;break;case"totalDistributions":m=f.distributions-d.distributions;break;case"nav":m=f.nav-d.nav;break;case"investmentReturn":m=(f.investmentReturn||0)-(d.investmentReturn||0);break;case"moic":m=(f.moic||0)-(d.moic||0);break;case"irr":m=(f.irr||0)-(d.irr||0);break;case"outstandingCommitment":m=f.outstandingCommitment-d.outstandingCommitment;break;default:m=0}if(m!==0)return m*u}return 0}):a.sort((r,i)=>r.fundName.localeCompare(i.fundName)),a}function Po(t,e,n=!1){const o=t.consolidatedMetrics,a=g.fundNameData.get(t.fundName),s=a&&a.tags?a.tags:[],r=n&&s.length>0?`<div class="table-tags">${s.map(c=>`<span class="table-tag">${T(c)}</span>`).join("")}</div>`:"",i=o.investmentReturn??o.distributions+o.nav-o.calledCapital;return`
    <td>
      <div>${T(t.fundName)}</div>
      ${r}
    </td>
    <td class="center"><span class="investor-count">${t.investorCount} investor${t.investorCount!==1?"s":""}</span></td>
    <td class="center">${o.vintageYear||"N/A"}</td>
    <td class="number">${x(o.commitment||0)}</td>
    <td class="number">${x(o.calledCapital)}</td>
    <td class="number">${x(o.distributions)}</td>
    <td class="number">${x(o.nav)}</td>
    <td class="number ${i>=0?"positive":"negative"}">${x(i)}</td>
    <td class="number">${Yt(o.moic)}</td>
    <td class="number ${o.irr!==null&&o.irr>=0?"positive":"negative"}">${Wt(o.irr)}</td>
    <td class="number">${x(o.outstandingCommitment)}</td>
    <td class="center">
      <button class="btn-icon table-action-btn" data-action="edit-fund" data-fund-name="${X(t.fundName)}" title="Edit Fund Name" aria-label="Edit ${T(t.fundName)}">⚙</button>
    </td>
  `}function Uo(t,e,n=new Set){const o=new Map;for(const u of t){const m=u.groupId??null,f=o.get(m)||[];f.push(u),o.set(m,f)}const a=new Set;for(const u of o.keys())if(u!==null){a.add(u);const m=g.getAncestorIds(u);for(const f of m)a.add(f)}function s(u){let m=[];if(u===null)m=o.get(null)||[];else{const y=g.getDescendantIds(u);for(const B of y){const k=o.get(B);k&&m.push(...k)}}if(m.length===0)return{metrics:{vintageYear:null,commitment:0,calledCapital:0,distributions:0,nav:0,navDate:null,outstandingCommitment:0,investmentReturn:0,irr:null,moic:null,dpi:null,rvpi:null,tvpi:null},fundCount:0,investorCount:0,allFunds:[]};const f=[];let d=0,p=0,h=null;const v=new Set;for(const y of m)f.push(...y.cashFlows),d+=y.commitment,p+=y.metrics.nav,v.add(y.fundName),y.metrics.navDate&&(!h||y.metrics.navDate>h)&&(h=y.metrics.navDate);const E=[{date:h??new Date().toISOString().split("T")[0]??"",amount:p}],C={commitment:d,cashFlows:f,monthlyNav:E,timestamp:new Date().toISOString()};return{metrics:ot(C,e),fundCount:v.size,investorCount:m.length,allFunds:m}}function r(u,m){const f=u!==null?g.getGroupByIdSync(u)??null:null,d=f?.name??"No Group";if(u!==null&&!a.has(u))return null;const{metrics:p,fundCount:h,investorCount:v}=s(u),S=[];if(u!==null){const C=g.getDirectChildIds(u);for(const N of C){const y=r(N,m+1);y&&S.push(y)}S.sort((N,y)=>N.groupName.localeCompare(y.groupName))}const E=u===null||n.has(u)||n.has(String(u));return{groupId:u,groupName:d,group:f,fundCount:h,investorCount:v,metrics:p,children:S,depth:m,isExpanded:E}}const i=[],c=g.getGroups().filter(u=>u.parentGroupId===null);for(const u of c){const m=r(u.id,0);m&&i.push(m)}i.sort((u,m)=>u.groupName.localeCompare(m.groupName));const l=o.get(null);if(l&&l.length>0){const u=r(null,0);u&&i.push(u)}return i}function _o(t){const e=[];function n(o){for(const a of o)e.push(a),a.isExpanded&&a.children.length>0&&n(a.children)}return n(t),e}function Yo(t,e){const n=t.metrics,o=n.investmentReturn??n.distributions+n.nav-n.calledCapital,a=t.children.length>0,s=a?t.isExpanded?"&#9660;":"&#9654;":'<span style="display:inline-block;width:12px;"></span>',r=t.depth*20,i=t.group?.type?` <span class="group-type-badge">${T(t.group.type)}</span>`:"";return`
    <td style="--group-indent: ${r+8}px">
      <div class="group-name-cell">
        ${a?`<button class="btn-expand" data-group-id="${t.groupId}" title="${t.isExpanded?"Collapse":"Expand"}">${s}</button>`:`<span class="expand-placeholder">${s}</span>`}
        <span class="group-name">${T(t.groupName)}</span>${i}
      </div>
    </td>
    <td class="center"><span class="investor-count">${t.fundCount} fund${t.fundCount!==1?"s":""}, ${t.investorCount} position${t.investorCount!==1?"s":""}</span></td>
    <td class="center">${n.vintageYear||"N/A"}</td>
    <td class="number">${x(n.commitment||0)}</td>
    <td class="number">${x(n.calledCapital)}</td>
    <td class="number">${x(n.distributions)}</td>
    <td class="number">${x(n.nav)}</td>
    <td class="number ${o>=0?"positive":"negative"}">${x(o)}</td>
    <td class="number">${Yt(n.moic)}</td>
    <td class="number ${n.irr!==null&&n.irr>=0?"positive":"negative"}">${Wt(n.irr)}</td>
    <td class="number">${x(n.outstandingCommitment)}</td>
    <td class="center">
      ${t.groupId!==null?`<button class="btn-icon table-action-btn" data-action="edit-group" data-group-id="${t.groupId}" title="Edit Group" aria-label="Edit ${T(t.groupName)}">⚙</button>`:""}
    </td>
  `}function Wo(){const t=new Date,e=t.getFullYear(),n=[new Date(e,2,31),new Date(e,5,30),new Date(e,8,30),new Date(e,11,31)];let o=new Date(e-1,11,31);for(let i=n.length-1;i>=0;i--)if(n[i]<=t){o=n[i];break}const a=o.getFullYear(),s=String(o.getMonth()+1).padStart(2,"0"),r=String(o.getDate()).padStart(2,"0");return`${a}-${s}-${r}`}function U(t){const e=document.getElementById(t);if(!e)return[];const n=e.querySelectorAll(".multi-select-option.selected");return Array.from(n).map(o=>o.dataset.value||"")}function Vo(){const t=["fundFilter","accountFilter","groupFilter","vintageFilter","tagFilter"],e=["fund","account","group","vintage","tag"],n={fund:[],account:[],group:[],vintage:[],tag:[]};return t.forEach((o,a)=>{const s=document.getElementById(o);if(s){const r=s.querySelectorAll(".multi-select-option.selected");n[e[a]]=Array.from(r).map(i=>i.dataset.value||"")}}),n}function Ho(){const t=Vo();return t.fund.length>0||t.account.length>0||t.group.length>0||t.vintage.length>0||t.tag.length>0}function Bt(t,e){const n=document.getElementById(t);if(!n)return;const o=new Set(e);n.querySelectorAll(".multi-select-option").forEach(s=>{const r=s;if(o.has(r.dataset.value||"")){s.classList.add("selected");const i=s.querySelector('input[type="checkbox"]');i&&(i.checked=!0)}else{s.classList.remove("selected");const i=s.querySelector('input[type="checkbox"]');i&&(i.checked=!1)}}),se(t)}function Mt(t){Bt(t,[])}function se(t){const e=document.getElementById(t);if(!e)return;const n=e.querySelector(".multi-select-display");if(!n)return;const o=e.dataset.placeholder||"Select...",a=U(t);if(a.length===0)n.innerHTML=`<span class="placeholder">${T(o)}</span>`;else if(a.length===1){const r=e.querySelector(`.multi-select-option[data-value="${CSS.escape(a[0]||"")}"]`)?.querySelector("label")?.textContent||a[0];n.innerHTML=T(r)}else n.innerHTML=`<span class="multi-select-count">${a.length} selected</span>`}function Gt(t,e,n=[]){const o=document.getElementById(t);if(!o)return;const a=o.querySelector(".multi-select-dropdown");if(!a)return;const r=a.querySelector(".multi-select-search input")?.value||"";a.innerHTML=`
    <div class="multi-select-search">
      <input type="text" placeholder="Search..." aria-label="Search options" value="${T(r)}">
    </div>
    <div class="multi-select-options"></div>
    <div class="multi-select-no-results">No matches found</div>
  `;const i=a.querySelector(".multi-select-options"),c=document.createDocumentFragment(),l=new Set(n),u=document.createElement("div");u.className="multi-select-option multi-select-all-option",u.setAttribute("data-value","__select_all__"),u.setAttribute("role","option"),u.setAttribute("aria-selected","false"),u.innerHTML='<input type="checkbox" tabindex="-1"><label>Select All</label>',c.appendChild(u);let m=!1;for(const f of e){const d=l.has(f.value),p=document.createElement("div"),h=["multi-select-option"];f.indent!==void 0&&(f.indent===0?(h.push("group-top-level"),m&&h.push("group-separator"),m=!0):h.push("group-option","group-child")),d&&h.push("selected"),p.className=h.join(" "),p.setAttribute("data-value",f.value),p.setAttribute("role","option"),p.setAttribute("aria-selected",String(d)),f.indent!==void 0&&p.style.setProperty("--indent-level",String(f.indent));const v=document.createElement("input");v.type="checkbox",v.checked=d,v.tabIndex=-1;const S=document.createElement("label");S.textContent=f.label,p.appendChild(v),p.appendChild(S),c.appendChild(p)}i.appendChild(c),r&&ke(o,r),se(t)}function ke(t,e){const n=t.querySelector(".multi-select-options"),o=t.querySelector(".multi-select-no-results");if(!n)return;const a=n.querySelectorAll(".multi-select-option"),s=e.toLowerCase().trim(),r=[],i=[];a.forEach(c=>{const l=c.querySelector("label"),u=l&&l.textContent?.toLowerCase()||"";s===""||u.includes(s)?r.push(c):i.push(c)});for(const c of r)c.classList.remove("search-hidden");for(const c of i)c.classList.add("search-hidden");o&&o.classList.toggle("visible",r.length===0&&s!=="")}function be(t){const e=t.querySelector(".multi-select-search input");e&&(e.value=""),ke(t,"")}function jo(t){const e=t.querySelector(".multi-select-options");if(!e)return;const n=e.querySelectorAll(".multi-select-option:not(.search-hidden):not(.multi-select-all-option)"),a=!Array.from(n).every(s=>s.classList.contains("selected"));n.forEach(s=>{a?s.classList.add("selected"):s.classList.remove("selected");const r=s.querySelector('input[type="checkbox"]');r&&(r.checked=a),s.setAttribute("aria-selected",a.toString())}),Ae(t),se(t.id)}function Ae(t){const e=t.querySelector(".multi-select-all-option");if(!e)return;const n=t.querySelector(".multi-select-options");if(!n)return;const o=n.querySelectorAll(".multi-select-option:not(.search-hidden):not(.multi-select-all-option)");if(o.length===0){e.classList.remove("selected");const r=e.querySelector('input[type="checkbox"]');r&&(r.checked=!1);return}const a=Array.from(o).every(r=>r.classList.contains("selected"));a?e.classList.add("selected"):e.classList.remove("selected");const s=e.querySelector('input[type="checkbox"]');s&&(s.checked=a)}let zt=null,un=null;function re(t,e){return zt&&un===t||(un=t,zt=$n(t,null)),zt}function $n(t,e){return t.filter(n=>n.parentGroupId===e).sort((n,o)=>n.name.localeCompare(o.name)).map(n=>({...n,children:$n(t,n.id)}))}const qo=[{id:"fundFilter",isMultiSelect:!0,apply:(t,e)=>e.length===0||e.includes(t.fundName)},{id:"accountFilter",isMultiSelect:!0,apply:(t,e)=>e.length===0||e.includes(t.accountNumber)},{id:"vintageFilter",isMultiSelect:!0,apply:(t,e)=>{if(e.length===0)return!0;const n=he(t);return n!==null&&e.includes(n.toString())}}];function On(){return{fundFilter:U("fundFilter"),accountFilter:U("accountFilter"),groupFilter:U("groupFilter"),tagFilter:U("tagFilter"),vintageFilter:U("vintageFilter")}}function Me(t){const e=On(),n=e.groupFilter||[];let o=null;if(n.length>0){o=new Set;for(const r of n){const i=parseInt(r),c=g.getDescendantIds(i);for(const l of c)o.add(l)}}const a=e.tagFilter||[],s=a.length>0?new Set(a):null;return t.filter(r=>{for(const i of qo){const c=e[i.id]||[];if(!i.apply(r,c))return!1}return!(o!==null&&(!r.groupId||!o.has(r.groupId))||s!==null&&!(g.fundNameData.get(r.fundName)?.tags||[]).some(u=>s.has(u)))})}function Ge(){Mt("fundFilter"),Mt("accountFilter"),Mt("groupFilter"),Mt("tagFilter"),Mt("vintageFilter");const t=document.getElementById("cutoffDate");t&&(t.value=Wo())}function Ko(){const t=document.getElementById("activeFiltersIndicator");if(!t)return;const e=[U("fundFilter"),U("accountFilter"),U("groupFilter"),U("tagFilter"),U("vintageFilter")].filter(n=>n.length>0).length;e>0?(t.innerHTML=`${e} filter${e>1?"s":""} active <button class="clear-filters" title="Clear all filters" aria-label="Clear all filters">&times;</button>`,t.classList.add("show")):(t.innerHTML="",t.classList.remove("show"))}function Zo(t,e,n){const o=t.querySelector(".multi-select-options");if(!o)return;const a=(r,i)=>{const c=o.querySelector(`[data-value="${r}"]`);if(c){i?c.classList.add("selected"):c.classList.remove("selected");const l=c.querySelector('input[type="checkbox"]');l&&(l.checked=i),c.setAttribute("aria-selected",i.toString())}},s=r=>{const i=o.querySelector(`[data-value="${r}"]`);return i?i.classList.contains("selected"):!1};if(n){g.getDescendantIds(e).forEach(c=>{c!==e&&a(c,!0)});let i=e;for(;i!=null;){const c=g.getGroupByIdSync(i);if(!c||c.parentGroupId==null)break;const l=c.parentGroupId;if(g.getDirectChildIds(l).every(f=>s(f)))a(l,!0),i=l;else break}}else{g.getDescendantIds(e).forEach(c=>{c!==e&&a(c,!1)});const i=g.getGroupByIdSync(e);if(i&&i.parentGroupId!=null){let c=i.parentGroupId;for(;c!=null;){a(c,!1);const l=g.getGroupByIdSync(c);c=l?l.parentGroupId:null}}}}function Xo(t,e,n){const o=t.querySelector(".multi-select-options");if(!o)return;const a=new Set;for(const s of e)g.getDescendantIds(s).forEach(i=>a.add(i));a.forEach(s=>{const r=o.querySelector(`[data-value="${s}"]`);if(r){r.classList.add("selected");const i=r.querySelector('input[type="checkbox"]');i&&(i.checked=n),r.setAttribute("aria-selected",n.toString())}})}function zo(t){const e=U("groupFilter"),n=U("fundFilter"),o=U("accountFilter"),a=U("vintageFilter"),s=U("tagFilter");let r=null;if(e.length>0){r=new Set;for(const F of e){const G=parseInt(F),R=g.getDescendantIds(G);for(const tt of R)r.add(tt)}}const i=n.length>0?new Set(n):null,c=o.length>0?new Set(o):null,l=a.length>0?new Set(a):null,u=(F,G)=>G?F.filter(R=>R.groupId!=null&&G.has(R.groupId)):F,m=(F,G)=>G?F.filter(R=>{const tt=he(R);return tt!==null&&G.has(tt.toString())}):F,f=(F,G)=>G?F.filter(R=>G.has(R.fundName)):F,d=(F,G)=>G?F.filter(R=>G.has(R.accountNumber)):F,p=u(t,r);let h=p;h=d(h,c),h=m(h,l);const v=new Set(h.map(F=>F.fundName)),E=[...v].sort().map(F=>({value:F,label:F})),C=n.filter(F=>v.has(F));Gt("fundFilter",E,C);let N=p;N=f(N,i),N=m(N,l);const y=new Set(N.map(F=>F.accountNumber)),k=[...y].sort().map(F=>({value:F,label:F})),P=o.filter(F=>y.has(F));Gt("accountFilter",k,P);const L=g.getGroups(),j=[];if(L.length>0){const F=re(L),G=(R,tt,rt=null)=>{const yt=[];return R.forEach(it=>{(rt===null||rt.has(it.id))&&yt.push({value:it.id.toString(),label:it.name,indent:tt}),it.children&&it.children.length>0&&yt.push(...G(it.children,tt+1,rt))}),yt};if(n.length>0||o.length>0||a.length>0){let R=t;R=f(R,i),R=d(R,c),R=m(R,l);const tt=new Set;R.forEach(rt=>{rt.groupId!=null&&g.getAncestorIds(rt.groupId).forEach(it=>tt.add(it))}),j.push(...G(F,0,tt))}else j.push(...G(F,0))}const q=new Set(j.map(F=>F.value)),lt=e.filter(F=>q.has(F));Gt("groupFilter",j,lt);let pt=p;pt=f(pt,i),pt=d(pt,c);const kt=new Set;pt.forEach(F=>{const G=he(F);G!==null&&kt.add(G)});const jt=Array.from(kt).sort((F,G)=>G-F).map(F=>({value:F.toString(),label:F.toString()})),qt=a.filter(F=>kt.has(parseInt(F)));Gt("vintageFilter",jt,qt);const ht=new Set;g.fundNameData.forEach(F=>{F.tags&&F.tags.forEach(G=>ht.add(G))});const Kt=Array.from(ht).sort((F,G)=>F.localeCompare(G)).map(F=>({value:F,label:F})),Zt=s.filter(F=>ht.has(F));Gt("tagFilter",Kt,Zt)}let Lt=null,bt=null;const Ie=new WeakMap,Jo=['button:not([disabled]):not([tabindex="-1"])','input:not([disabled]):not([type="hidden"]):not([tabindex="-1"])','select:not([disabled]):not([tabindex="-1"])','textarea:not([disabled]):not([tabindex="-1"])','a[href]:not([tabindex="-1"])','[tabindex]:not([tabindex="-1"]):not([disabled])'].join(", ");function Pn(t){const e=Ie.get(t);if(e)return e;const n=Array.from(t.querySelectorAll(Jo)).filter(o=>o.offsetParent!==null);return Ie.set(t,n),n}function Qo(t){Ie.delete(t)}function Un(t){bt&&document.removeEventListener("keydown",bt),Qo(t),bt=e=>{if(e.key!=="Tab")return;const n=Pn(t),o=n[0],a=n[n.length-1];!o||!a||(e.shiftKey?document.activeElement===o&&(e.preventDefault(),a.focus()):document.activeElement===a&&(e.preventDefault(),o.focus()))},document.addEventListener("keydown",bt)}function _n(){bt&&(document.removeEventListener("keydown",bt),bt=null)}function w(t,e="success"){let n=document.getElementById("toastContainer");n||(n=document.createElement("div"),n.id="toastContainer",n.className="toast-container",n.setAttribute("aria-live","polite"),document.body.appendChild(n));const o=document.createElement("div");o.className=`status-message ${e}`;const a=document.createElement("button");a.className="close-status",a.innerHTML="&times;";const s=document.createElement("span");s.textContent=t,o.appendChild(s),o.appendChild(a),n.appendChild(o);const r=()=>{a.removeEventListener("click",r),o.remove()};a.addEventListener("click",r),setTimeout(()=>{o.parentNode&&(a.removeEventListener("click",r),o.remove())},e==="success"?3e3:8e3)}function z(t="Loading..."){const e=document.getElementById("loadingOverlay"),n=document.getElementById("loadingText");n&&(n.textContent=t),e&&e.classList.add("show")}function V(){const t=document.getElementById("loadingOverlay");t&&t.classList.remove("show")}function It(t,e={}){return new Promise(n=>{const o=document.getElementById("confirmModal"),a=document.getElementById("confirmModalTitle"),s=document.getElementById("confirmModalMessage"),r=document.getElementById("confirmModalConfirmBtn"),i=document.getElementById("confirmModalCancelBtn"),c=document.getElementById("closeConfirmModalBtn");if(!o||!a||!s||!r||!i){n(!1);return}const l=document.activeElement;a.textContent=e.title||"Confirm",s.textContent=t,r.textContent=e.confirmText||"Confirm",i.textContent=e.cancelText||"Cancel",o.classList.add("show"),Un(o),requestAnimationFrame(()=>i.focus());const u=()=>{f(),n(!0)},m=()=>{f(),n(!1)},f=()=>{o.classList.remove("show"),_n(),r.removeEventListener("click",u),i.removeEventListener("click",m),c&&c.removeEventListener("click",m),l&&l.focus&&l.focus()};r.addEventListener("click",u),i.addEventListener("click",m),c&&c.addEventListener("click",m)})}function fe(t,e){const n=document.getElementById(t);if(!n)return;const o=n.closest(".form-group");if(o&&(o.classList.add("has-error"),e)){let a=o.querySelector(".error-message");a||(a=document.createElement("span"),a.className="error-message",o.appendChild(a)),a.textContent=e}}function dn(t){const e=document.getElementById(t);if(!e)return;const n=e.closest(".form-group");if(!n)return;n.classList.remove("has-error");const o=n.querySelector(".error-message");o&&(o.textContent="")}function ta(t){const e=document.getElementById(t);e&&e.querySelectorAll(".form-group.has-error").forEach(n=>{n.classList.remove("has-error");const o=n.querySelector(".error-message");o&&(o.textContent="")})}function et(t){const e=document.getElementById(t);e&&(Lt=document.activeElement,e.classList.add("show"),Un(e),requestAnimationFrame(()=>{const o=Pn(e)[0];o&&o.focus()}))}function O(t){const e=document.getElementById(t);e&&(e.classList.remove("show"),_n(),Lt&&Lt.focus&&(Lt.focus(),Lt=null))}function ea(){["fundName","accountNumber","fundGroup","commitment","newFundNameInline"].forEach(e=>{const n=document.getElementById(e);n&&(n.addEventListener("input",()=>{g.setFundModalUnsavedChanges(!0),dn(e)}),n.addEventListener("change",()=>{g.setFundModalUnsavedChanges(!0),dn(e)}))})}async function na(){g.fundModalHasUnsavedChanges&&!await It("You have unsaved changes. Discard them?",{title:"Unsaved Changes",confirmText:"Discard",cancelText:"Keep Editing"})||(g.setFundModalUnsavedChanges(!1),Yn(),O("fundModal"))}let Tt=null,Rt=!1,Se=0;function Yn(){Tt=null,Rt=!1,Se=0}async function Wn(t,e=null){if(!t||t.trim()==="")return{groupId:null,groupName:null,isAmbiguous:!1,conflictingGroups:[]};const n=t.trim().toLowerCase(),a=(await H()).filter(i=>e&&i.id===e?!1:i.accountNumber&&i.accountNumber.trim().toLowerCase()===n);if(a.length===0)return{groupId:null,groupName:null,isAmbiguous:!1,conflictingGroups:[]};const s=new Map;a.forEach(i=>{const c=i.groupId||null;if(s.has(c))s.get(c).count++;else{const l=c?g.getGroupByIdSync(c)?.name||"Unknown Group":"No Group";s.set(c,{groupId:c,groupName:l,count:1})}});const r=Array.from(s.values());return r.length===1?{groupId:r[0].groupId,groupName:r[0].groupName,isAmbiguous:!1,conflictingGroups:[]}:{groupId:null,groupName:null,isAmbiguous:!0,conflictingGroups:r}}function we(t,e=[],n=""){Nt();const o=document.getElementById("fundGroup")?.closest(".form-group");if(!o)return;const a=document.createElement("div");if(a.id="groupAutoFillIndicator",a.style.cssText="margin-top: 6px; font-size: 12px; display: flex; align-items: flex-start; gap: 6px;",t==="auto-filled")a.innerHTML=`
      <span style="color: var(--color-success); display: flex; align-items: center; gap: 4px;">
        <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <polyline points="20 6 9 17 4 12"></polyline>
        </svg>
        Auto-filled from existing investor data
      </span>
      <span style="color: var(--color-text-light);">(${T(n)})</span>
    `;else if(t==="ambiguous"){const s=e.map(r=>`${T(r.groupName)} (${r.count})`).join(", ");a.innerHTML=`
      <span style="color: var(--color-warning); display: flex; align-items: center; gap: 4px;">
        <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <circle cx="12" cy="12" r="10"></circle>
          <line x1="12" y1="8" x2="12" y2="12"></line>
          <line x1="12" y1="16" x2="12.01" y2="16"></line>
        </svg>
        Multiple groups found for this account
      </span>
      <span style="color: var(--color-text-light); font-size: 11px;">(${s})</span>
    `}o.appendChild(a)}function Nt(){const t=document.getElementById("groupAutoFillIndicator");t&&t.remove()}async function mn(){const t=document.getElementById("accountNumber"),e=document.getElementById("fundGroup"),n=document.getElementById("fundId");if(!t||!e)return;const o=t.value.trim(),a=n?.value?parseInt(n.value):null;if(Nt(),Tt=null,Rt=!1,!o)return;const s=++Se,r=await Wn(o,a);s===Se&&(r.isAmbiguous?(we("ambiguous",r.conflictingGroups),Rt=!0):(r.groupId!==null||r.groupName==="No Group")&&(Tt=r.groupId,Rt=!0,ie("fundGroup",r.groupId?.toString()||""),we("auto-filled",[],r.groupName||"No Group")))}function oa(t){Nt();const e=document.getElementById("fundGroup")?.closest(".form-group");if(!e)return;const n=document.createElement("div");n.id="groupAutoFillIndicator",n.style.cssText="margin-top: 6px; font-size: 12px; display: flex; align-items: flex-start; gap: 6px;";const o=t.map(a=>`${T(a.groupName)} (${a.count})`).join(", ");n.innerHTML=`
    <span style="color: var(--color-warning); display: flex; align-items: center; gap: 4px;">
      <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
        <circle cx="12" cy="12" r="10"></circle>
        <line x1="12" y1="8" x2="12" y2="12"></line>
        <line x1="12" y1="16" x2="12.01" y2="16"></line>
      </svg>
      Multiple groups will exist for this account
    </span>
    <span style="color: var(--color-text-light); font-size: 11px;">(${o})</span>
  `,e.appendChild(n)}async function aa(){const t=document.getElementById("fundGroup"),e=document.getElementById("accountNumber");if(!t||!e||!Rt)return;const n=e.value.trim();if(!n)return;const o=t.value?parseInt(t.value):null;if(o!==Tt){const a=document.getElementById("fundId"),s=a?.value?parseInt(a.value):null,r=await Wn(n,s);if(r.conflictingGroups.length>0||r.groupId!==null){const i=o?g.getGroupByIdSync(o)?.name||"Unknown Group":"No Group",c=[...r.conflictingGroups];!r.isAmbiguous&&r.groupId!==null&&c.push({groupId:r.groupId,groupName:r.groupName||"No Group",count:1}),c.some(l=>l.groupId===o)||c.push({groupId:o,groupName:i,count:0}),oa(c)}}else if(Tt!==null){const a=g.getGroupByIdSync(Tt)?.name||"No Group";we("auto-filled",[],a)}else Nt()}function sa(){const t=document.getElementById("accountNumber"),e=document.getElementById("fundGroup");if(!t)return;let n=null;t.addEventListener("input",()=>{n&&clearTimeout(n),n=setTimeout(mn,300)}),t.addEventListener("blur",mn),e&&e.addEventListener("change",aa)}async function Vt(){const t=document.getElementById("fundName");if(!t)return;const e=await _t(),n=e.map(r=>r.name).sort();g.setFundNames(new Set(n));const o=new Map;e.forEach(r=>o.set(r.name,r)),g.setFundNameData(o);const a=t.value;t.innerHTML='<option value="">Select a fund</option>',n.forEach(r=>{const i=document.createElement("option");i.value=r,i.textContent=r,t.appendChild(i)});const s=document.createElement("option");s.value="__new__",s.textContent="+ Add new fund name...",t.appendChild(s),a&&n.includes(a)&&(t.value=a)}function Et(t,e){if(document.getElementById(t+"Container")?.classList.contains("searchable-select")){ra(t,e);return}const o=document.getElementById(t);if(!o)return;const a=g.getGroups(),s=re(a);o.innerHTML='<option value="">No Group</option>';const r=(i,c)=>{i.forEach(l=>{if(e!==void 0&&l.id===e)return;const u=document.createElement("option");u.value=l.id.toString();const m=c>0?"–".repeat(c)+" ":"";u.textContent=m+l.name,o.appendChild(u),l.children&&l.children.length>0&&r(l.children,c+1)})};r(s,0)}function ra(t,e){const n=document.getElementById(t+"Container"),o=document.getElementById(t),a=n?.querySelector(".searchable-select-options");if(!n||!o||!a)return;const s=g.getGroups(),r=re(s),i=n.dataset.placeholder||"Select...";let c=`<div class="searchable-select-option" data-value="" data-indent="0">
    ${T(i)}
  </div>`;const l=(m,f)=>{m.forEach(d=>{if(e!==void 0&&d.id===e)return;const p=f>0?"–".repeat(f)+" ":"";c+=`<div class="searchable-select-option" data-value="${X(String(d.id))}" data-indent="${f}">
        ${T(p+d.name)}
      </div>`,d.children&&d.children.length>0&&l(d.children,f+1)})};l(r,0),a.innerHTML=c,o.value="";const u=n.querySelector(".searchable-select-display");u&&(u.textContent=i)}function ie(t,e){const n=document.getElementById(t+"Container"),o=document.getElementById(t);if(!n||!o)return;o.value=e;const a=n.querySelector(".searchable-select-display"),s=n.querySelectorAll(".searchable-select-option");let r=n.dataset.placeholder||"Select...";s.forEach(i=>{const c=i;c.classList.remove("selected"),c.dataset.value===e&&(c.classList.add("selected"),r=c.textContent?.trim()||r)}),a&&(a.textContent=r)}async function ne(){const t=document.getElementById("fundModalTitle"),e=document.getElementById("fundId"),n=document.getElementById("isDuplicate"),o=document.getElementById("saveFundBtn"),a=document.getElementById("duplicateMultiplierContainer");t&&(t.textContent="Add New Investment"),e&&(e.value=""),n&&(n.value=""),o&&(o.textContent="Save"),a&&a.classList.add("hidden");const s=document.getElementById("fundForm");s&&s.reset(),Nt(),await Vt(),Et("fundGroup"),g.setFundModalUnsavedChanges(!1),et("fundModal")}async function ia(t){const e=await ft(t);if(!e){w("Fund not found","error");return}const n=document.getElementById("fundModalTitle"),o=document.getElementById("fundId"),a=document.getElementById("isDuplicate"),s=document.getElementById("fundName"),r=document.getElementById("accountNumber"),i=document.getElementById("commitment"),c=document.getElementById("saveFundBtn"),l=document.getElementById("duplicateMultiplierContainer");n&&(n.textContent="Edit Investment"),o&&(o.value=t.toString()),a&&(a.value=""),c&&(c.textContent="Save"),l&&l.classList.add("hidden"),Nt(),await Vt(),Et("fundGroup"),s&&(s.value=e.fundName),r&&(r.value=e.accountNumber),ie("fundGroup",e.groupId?.toString()||""),i&&(i.value=ee(e.commitment)),g.setFundModalUnsavedChanges(!1),et("fundModal")}async function ca(t){const e=await ft(t);if(!e){w("Fund not found","error");return}const n=document.getElementById("fundModalTitle"),o=document.getElementById("fundId"),a=document.getElementById("isDuplicate"),s=document.getElementById("fundName"),r=document.getElementById("accountNumber"),i=document.getElementById("commitment"),c=document.getElementById("duplicateMultiplier"),l=document.getElementById("saveFundBtn"),u=document.getElementById("duplicateMultiplierContainer");n&&(n.textContent="Duplicate Investment"),o&&(o.value=t.toString()),a&&(a.value="true"),l&&(l.textContent="Duplicate"),u&&u.classList.remove("hidden"),c&&(c.value="1"),Nt(),await Vt(),Et("fundGroup"),s&&(s.value=e.fundName),r&&(r.value=""),ie("fundGroup",e.groupId?.toString()||""),i&&(i.value=ee(e.commitment)),g.setFundModalUnsavedChanges(!1),et("fundModal")}async function la(t){const e=document.getElementById("fundId"),n=document.getElementById("isDuplicate"),o=document.getElementById("fundName"),a=document.getElementById("accountNumber"),s=document.getElementById("fundGroup"),r=document.getElementById("commitment"),i=document.getElementById("duplicateMultiplier");let c=o?.value||"";const l=(a?.value||"").replace(/\s/g,""),u=s?.value?parseInt(s.value):null,m=nt(r?.value||"0"),f=n?.value==="true",d=parseFloat(i?.value||"1")||1;if(c==="__new__"){const h=document.getElementById("newFundNameInline"),v=h?.value?.trim();if(!v){w("Please enter a fund name","error");return}if(g.fundNames.has(v)){w("A fund with this name already exists. Please select it from the dropdown.","error");return}try{const S={name:v,tags:[],investmentTermStartDate:null,investmentTermYears:null};await St(S),g.fundNames.add(v),g.fundNameData.set(v,S),c=v,await Vt(),o&&(o.value=v);const E=document.getElementById("newFundNameContainer");E&&E.classList.add("hidden"),h&&(h.value="")}catch(S){w("Error creating fund name: "+S.message,"error");return}}ta("fundForm");let p=!1;if(c||(fe("fundName","Please select a fund name"),p=!0),l||(fe("accountNumber","Please enter an account number"),p=!0),(isNaN(m)||m<=0)&&(fe("commitment","Please enter a valid commitment amount"),p=!0),p){w("Please fix the errors above","error");return}try{if(z("Saving..."),f&&e?.value){const h=await ft(parseInt(e.value));if(!h){w("Original fund not found","error"),V();return}const v={fundName:c,accountNumber:l,groupId:u,commitment:m*d,cashFlows:h.cashFlows.map(S=>({...S,amount:S.amount*d})),monthlyNav:h.monthlyNav.map(S=>({...S,amount:S.amount*d})),timestamp:new Date().toISOString()};await st(v),w("Investment duplicated successfully")}else if(e?.value){const h=await ft(parseInt(e.value));if(!h){w("Fund not found","error"),V();return}const v={...h,fundName:c,accountNumber:l,groupId:u,commitment:m,timestamp:new Date().toISOString()};await st(v),w("Investment updated successfully")}else{const h={fundName:c,accountNumber:l,groupId:u,commitment:m,cashFlows:[],monthlyNav:[],timestamp:new Date().toISOString()};await st(h),w("Investment added successfully")}if(l){const v=(await H()).filter(S=>S.accountNumber===l&&S.groupId!==u);for(const S of v)await st({...S,groupId:u})}g.setFundModalUnsavedChanges(!1),Yn(),O("fundModal"),g.clearMetricsCache(),await t()}catch(h){console.error("Error saving fund:",h),w("Error saving investment: "+h.message,"error")}finally{V()}}async function ua(t,e){const n=await ft(t);if(!n){w("Fund not found","error");return}if(await It(`Are you sure you want to delete "${n.fundName}" (${n.accountNumber})? This action cannot be undone.`,{title:"Delete Investment",confirmText:"Delete",cancelText:"Cancel"}))try{z("Deleting..."),await Nn(t),g.clearMetricsCache(),w("Investment deleted successfully"),await e()}catch(a){console.error("Error deleting fund:",a),w("Error deleting investment: "+a.message,"error")}finally{V()}}async function Ee(t,e){const n=await ft(t);if(!n){w("Fund not found","error");return}g.setCurrentDetailsFundId(t);const o=document.getElementById("detailsModalTitle"),a=document.getElementById("detailsModalSubtitle"),s=document.querySelector("#cashFlowsTable tbody"),r=document.querySelector("#navTable tbody");o&&(o.textContent=n.fundName),a&&(a.textContent=n.accountNumber);const i=ye(n),c=(l,u)=>{const m=document.getElementById(l);m&&(m.textContent=u)};c("detailsSummaryCommitment",x(n.commitment)),c("detailsSummaryContributions",x(i.calledCapital)),c("detailsSummaryDistributions",x(i.distributions)),c("detailsSummaryValue",x(i.nav)),c("detailsSummaryReturn",x(i.investmentReturn||0)),c("detailsSummaryOutstanding",x(i.outstandingCommitment)),s&&(s.innerHTML="",[...n.cashFlows].sort((u,m)=>new Date(u.date).getTime()-new Date(m.date).getTime()).forEach((u,m)=>{const f=document.createElement("tr");f.innerHTML=`
        <td><input type="date" value="${u.date}" data-field="date" data-index="${m}"></td>
        <td class="number"><input type="text" value="${ee(nt(u.amount)||0)}" data-field="amount" data-index="${m}"></td>
        <td class="center">
          <select data-field="type" data-index="${m}">
            <option value="Contribution" ${u.type==="Contribution"?"selected":""}>Contribution</option>
            <option value="Distribution" ${u.type==="Distribution"?"selected":""}>Distribution</option>
            <option value="Adjustment" ${u.type==="Adjustment"?"selected":""}>Adjustment</option>
          </select>
        </td>
        <td class="center">
          <input type="checkbox" ${u.affectsCommitment!==!1?"checked":""} data-field="affectsCommitment" data-index="${m}">
        </td>
        <td>
          <button class="delete-row-btn" data-action="deleteCashFlow" data-index="${m}" title="Delete">×</button>
        </td>
      `,s.appendChild(f)})),r&&(r.innerHTML="",[...n.monthlyNav].sort((u,m)=>new Date(u.date).getTime()-new Date(m.date).getTime()).forEach((u,m)=>{const f=document.createElement("tr");f.innerHTML=`
        <td><input type="date" value="${u.date}" data-field="date" data-index="${m}"></td>
        <td><input type="text" value="${ee(nt(u.amount)||0)}" data-field="amount" data-index="${m}"></td>
        <td>
          <button class="delete-row-btn" data-action="deleteNav" data-index="${m}" title="Delete">×</button>
        </td>
      `,r.appendChild(f)})),g.setUnsavedChanges(!1),et("detailsModal")}function da(){const t=document.querySelector("#cashFlowsTable tbody");if(!t)return;const e=t.querySelectorAll("tr").length,n=new Date().toISOString().split("T")[0],o=document.createElement("tr");o.innerHTML=`
    <td><input type="date" value="${n}" data-field="date" data-index="${e}"></td>
    <td class="number"><input type="text" value="" placeholder="0" data-field="amount" data-index="${e}"></td>
    <td class="center">
      <select data-field="type" data-index="${e}">
        <option value="Contribution" selected>Contribution</option>
        <option value="Distribution">Distribution</option>
        <option value="Adjustment">Adjustment</option>
      </select>
    </td>
    <td class="center">
      <input type="checkbox" checked data-field="affectsCommitment" data-index="${e}">
    </td>
    <td>
      <button class="delete-row-btn" data-action="deleteCashFlow" data-index="${e}" title="Delete">×</button>
    </td>
  `,t.insertBefore(o,t.firstChild),g.setUnsavedChanges(!0)}function ma(){const t=document.querySelector("#navTable tbody");if(!t)return;const e=t.querySelectorAll("tr").length,n=new Date().toISOString().split("T")[0],o=document.createElement("tr");o.innerHTML=`
    <td><input type="date" value="${n}" data-field="date" data-index="${e}"></td>
    <td><input type="text" value="" placeholder="0" data-field="amount" data-index="${e}"></td>
    <td>
      <button class="delete-row-btn" data-action="deleteNav" data-index="${e}" title="Delete">×</button>
    </td>
  `,t.insertBefore(o,t.firstChild),g.setUnsavedChanges(!0)}async function Vn(){const t=g.currentDetailsFundId;if(!t)return;const e=await ft(t);if(!e)return;const n=document.querySelectorAll("#cashFlowsTable tbody tr"),o=[];n.forEach(l=>{const u=l.querySelector('input[data-field="date"]'),m=l.querySelector('input[data-field="amount"]'),f=l.querySelector('select[data-field="type"]'),d=l.querySelector('input[data-field="affectsCommitment"]'),p=u?.value||"",h=nt(m?.value||"0"),v=f?.value||"Contribution",S=d?.checked??!0;p&&!isNaN(h)&&o.push({date:p,amount:h,type:v,affectsCommitment:S})});const a=document.querySelectorAll("#navTable tbody tr"),s=[];a.forEach(l=>{const u=l.querySelector('input[data-field="date"]'),m=l.querySelector('input[data-field="amount"]'),f=u?.value||"",d=nt(m?.value||"0");f&&!isNaN(d)&&s.push({date:f,amount:d})});const r={...e,cashFlows:o,monthlyNav:s},i=ot(r),c=(l,u)=>{const m=document.getElementById(l);m&&(m.textContent=u)};c("detailsSummaryCommitment",x(e.commitment)),c("detailsSummaryContributions",x(i.calledCapital)),c("detailsSummaryDistributions",x(i.distributions)),c("detailsSummaryValue",x(i.nav)),c("detailsSummaryReturn",x(i.investmentReturn||0)),c("detailsSummaryOutstanding",x(i.outstandingCommitment))}async function fa(t){const e=g.currentDetailsFundId;if(!e)return;const n=await ft(e);if(!n){w("Fund not found","error");return}try{z("Saving...");const o=document.querySelectorAll("#cashFlowsTable tbody tr"),a=[];o.forEach(c=>{const l=c.querySelector('input[data-field="date"]'),u=c.querySelector('input[data-field="amount"]'),m=c.querySelector('select[data-field="type"]'),f=c.querySelector('input[data-field="affectsCommitment"]'),d=l?.value||"",p=nt(u?.value||"0"),h=m?.value||"Contribution",v=f?.checked??!0;d&&!isNaN(p)&&a.push({date:d,amount:p,type:h,affectsCommitment:v})});const s=document.querySelectorAll("#navTable tbody tr"),r=[];s.forEach(c=>{const l=c.querySelector('input[data-field="date"]'),u=c.querySelector('input[data-field="amount"]'),m=l?.value||"",f=nt(u?.value||"0");m&&!isNaN(f)&&r.push({date:m,amount:f})});const i={...n,cashFlows:a,monthlyNav:r,timestamp:new Date().toISOString()};await st(i),g.clearMetricsCache(),g.setUnsavedChanges(!1),w("Changes saved successfully"),O("detailsModal"),await t()}catch(o){console.error("Error saving details:",o),w("Error saving changes: "+o.message,"error")}finally{V()}}function pa(t){g.setCurrentActionFundId(t)}function Jt(){return g.currentActionFundId}async function ce(){const t=document.getElementById("groupsList");if(!t)return;const e=await dt();g.setGroups(e),Et("newGroupParent");const n=re(e),o=(a,s)=>{let i=`
      <div class="group-item" style="margin-left: ${s*20}px; padding: 10px; border-bottom: 1px solid var(--color-border);">
        <div style="display: flex; justify-content: space-between; align-items: center;">
          <div>
            <strong>${T(a.name)}</strong>
            ${a.type?`<span style="font-size: 0.85em; color: var(--color-text-light);"> (${T(a.type)})</span>`:""}
          </div>
          <div>
            <button class="btn-icon" data-action="editGroup" data-id="${X(String(a.id))}" title="Edit">✎</button>
            <button class="btn-icon danger" data-action="deleteGroup" data-id="${X(String(a.id))}" title="Delete">×</button>
          </div>
        </div>
      </div>
    `;return a.children&&a.children.length>0&&a.children.forEach(c=>{i+=o(c,s+1)}),i};t.innerHTML=n.map(a=>o(a,0)).join(""),et("manageGroupsModal")}async function ga(t){const e=document.getElementById("editGroupId"),n=document.getElementById("newGroupName"),o=document.getElementById("newGroupParent"),a=document.getElementById("newGroupType"),s=n?.value?.trim()||"",r=o?.value?parseInt(o.value):null,i=a?.value||"",c=e?.value?parseInt(e.value):null;if(!s){w("Please enter a group name","error");return}if(g.getGroups().find(m=>m.name.toLowerCase()===s.toLowerCase()&&m.id!==c)){w("A group with this name already exists","error");return}try{z("Saving...");const m={name:s,parentGroupId:r,type:i||void 0};c&&(m.id=c),await xe(m),g.clearMetricsCache(),w(c?"Group updated successfully":"Group added successfully"),n&&(n.value=""),a&&(a.value=""),o&&(o.value=""),e&&(e.value="");const f=await dt();g.setGroups(f),await ce(),await t()}catch(m){console.error("Error saving group:",m),w("Error saving group: "+m.message,"error")}finally{V()}}async function ha(t,e){const n=g.getGroupByIdSync(t);if(!n){w("Group not found","error");return}if(await It(`Are you sure you want to delete "${n.name}"? Funds in this group will become ungrouped.`,{title:"Delete Group",confirmText:"Delete",cancelText:"Cancel"}))try{z("Deleting..."),await yo(t);const a=await H();for(const r of a)r.groupId===t&&await st({...r,groupId:null});const s=await dt();g.setGroups(s),w("Group deleted successfully"),await ce(),await e()}catch(a){console.error("Error deleting group:",a),w("Error deleting group: "+a.message,"error")}finally{V()}}let gt=[];function Ce(){gt=[]}async function ya(){const t=await H(),e=await dt(),n=new Map;e.forEach(s=>n.set(s.id,s.name));const o=new Map;for(const s of t)s.accountNumber&&(o.has(s.accountNumber)||o.set(s.accountNumber,[]),o.get(s.accountNumber).push(s));const a=[];for(const[s,r]of o){if(new Set(r.map(m=>m.groupId)).size<=1)continue;const c=new Map;for(const m of r)c.set(m.groupId,(c.get(m.groupId)||0)+1);let l=null,u=0;for(const[m,f]of c)m!==null&&(l===null||f>u)&&(l=m,u=f);a.push({accountNumber:s,funds:r.map(m=>({id:m.id,fundName:m.fundName,groupId:m.groupId,groupName:m.groupId?n.get(m.groupId)||"Unknown":"None"})),suggestedGroupId:l,suggestedGroupName:l?n.get(l)||"Unknown":"None"})}return a}async function va(){const t=document.getElementById("syncAccountGroupsContent"),e=document.getElementById("applySyncAccountGroupsBtn");if(!t||!e)return;if(t.innerHTML='<p style="color: var(--color-text-light);">Analyzing account groups...</p>',e.disabled=!0,et("syncAccountGroupsModal"),gt=await ya(),gt.length===0){t.innerHTML=`
      <div style="padding: 20px; text-align: center; color: var(--color-success);">
        <p style="font-size: 16px; margin-bottom: 8px;">&#10003; All account numbers have consistent group assignments.</p>
        <p style="color: var(--color-text-light); font-size: 14px;">No sync needed.</p>
      </div>
    `,e.disabled=!0;return}let n=`
    <p style="margin-bottom: 16px; color: var(--color-warning);">
      Found <strong>${gt.length}</strong> account number${gt.length>1?"s":""} with inconsistent group assignments.
    </p>
    <table style="width: 100%; border-collapse: collapse; font-size: 13px;">
      <thead>
        <tr style="background: var(--color-alt-bg);">
          <th style="padding: 8px 12px; text-align: left; border-bottom: 1px solid var(--color-border);">Account #</th>
          <th style="padding: 8px 12px; text-align: left; border-bottom: 1px solid var(--color-border);">Current Groups</th>
          <th style="padding: 8px 12px; text-align: left; border-bottom: 1px solid var(--color-border);">Sync To</th>
        </tr>
      </thead>
      <tbody>
  `;for(const o of gt){const a=[...new Set(o.funds.map(s=>s.groupName))].join(", ");n+=`
      <tr>
        <td style="padding: 8px 12px; border-bottom: 1px solid var(--color-border);">${T(o.accountNumber)}</td>
        <td style="padding: 8px 12px; border-bottom: 1px solid var(--color-border);">${T(a)}</td>
        <td style="padding: 8px 12px; border-bottom: 1px solid var(--color-border); color: var(--color-action); font-weight: 500;">${T(o.suggestedGroupName)}</td>
      </tr>
    `}n+="</tbody></table>",t.innerHTML=n,e.disabled=!1}async function ba(t){if(gt.length===0){w("No sync needed"),Ce(),O("syncAccountGroupsModal");return}try{z("Syncing account groups...");let e=0;for(const n of gt)for(const o of n.funds)if(o.groupId!==n.suggestedGroupId){const a=await ft(o.id);a&&(await st({...a,groupId:n.suggestedGroupId}),e++)}Ce(),g.clearMetricsCache(),O("syncAccountGroupsModal"),w(`Synced groups for ${e} investment${e!==1?"s":""}`),await t()}catch(e){console.error("Error syncing account groups:",e),w("Error syncing account groups: "+e.message,"error")}finally{V()}}let Ct=[];function Hn(){Ct=[]}function Ia(){const t=new Set;return g.fundNameData.forEach(e=>{e.tags&&e.tags.forEach(n=>t.add(n))}),[...t].sort()}async function Ht(){const t=document.getElementById("fundNamesList");if(!t)return;const e=await _t();t.innerHTML="",e.sort((n,o)=>n.name.localeCompare(o.name)).forEach(n=>{const o=document.createElement("div");o.className="fund-name-item",o.innerHTML=`
        <div>
          <strong>${T(n.name)}</strong>
          ${n.tags&&n.tags.length>0?`<div class="fund-name-tags">${n.tags.map(a=>`<span class="table-tag">${T(a)}</span>`).join("")}</div>`:""}
        </div>
        <div>
          <button class="btn-icon" data-action="editFundName" data-name="${X(n.name)}" title="Edit">✎</button>
          <button class="btn-icon danger" data-action="deleteFundName" data-name="${X(n.name)}" title="Delete">×</button>
        </div>
      `,t.appendChild(o)}),et("manageFundNamesModal")}function Le(){const t=document.getElementById("editFundTagsContainer");t&&(t.innerHTML="",Ct.forEach((e,n)=>{const o=document.createElement("span");o.className="tag",o.innerHTML=`${T(e)} <button type="button" class="tag-remove" data-index="${n}">&times;</button>`,t.appendChild(o)}))}function jn(t){const e=g.fundNameData.get(t);if(!e){w("Fund not found","error");return}Ct=[...e.tags||[]];const n=document.getElementById("editFundNameOriginal"),o=document.getElementById("editFundNameInput"),a=document.getElementById("editFundTagsDatalist"),s=document.getElementById("editFundTermStartDate"),r=document.getElementById("editFundInvestmentTerm");n&&(n.value=t),o&&(o.value=t),s&&(s.value=e.investmentTermStartDate||""),r&&(r.value=e.investmentTermYears?.toString()||""),Le(),a&&(a.innerHTML="",Ia().forEach(i=>{const c=document.createElement("option");c.value=i,a.appendChild(c)})),et("editFundNameModal")}function Sa(t){const e=t.trim();e&&!Ct.includes(e)&&(Ct.push(e),Le())}function wa(t){Ct.splice(t,1),Le()}async function Ea(t){const e=document.getElementById("editFundNameOriginal"),n=document.getElementById("editFundNameInput"),o=document.getElementById("editFundTermStartDate"),a=document.getElementById("editFundInvestmentTerm"),s=e?.value,r=n?.value?.trim(),i=o?.value||null,c=a?.value?parseInt(a.value):null;if(!r){w("Please enter a fund name","error");return}if(r!==s&&g.fundNames.has(r)){w("A fund with this name already exists","error");return}try{if(z("Saving..."),r!==s&&s){const m=await H();for(const f of m)f.fundName===s&&await st({...f,fundName:r,timestamp:new Date().toISOString()});await Fn(s),g.fundNames.delete(s),g.fundNameData.delete(s)}const l={name:r,tags:Ct,investmentTermStartDate:i,investmentTermYears:c};await St(l),g.fundNames.add(r),g.fundNameData.set(r,l),Hn(),O("editFundNameModal"),w("Fund updated successfully"),document.getElementById("manageFundNamesModal")?.classList.contains("show")&&await Ht(),await t()}catch(l){console.error("Error saving fund name:",l),w("Error saving fund: "+l.message,"error")}finally{V()}}async function Ca(t,e){const o=(await H()).filter(s=>s.fundName===t);if(o.length>0){w(`Cannot delete: ${o.length} investment(s) use this fund name`,"error");return}if(await It(`Are you sure you want to delete "${t}"? This action cannot be undone.`,{title:"Delete Fund Name",confirmText:"Delete",cancelText:"Cancel"}))try{z("Deleting..."),await Fn(t),g.fundNames.delete(t),g.fundNameData.delete(t),w("Fund name deleted successfully"),await Ht(),await e()}catch(s){console.error("Error deleting fund name:",s),w("Error deleting fund name: "+s.message,"error")}finally{V()}}async function Na(t){const e=document.getElementById("newFundNameInput"),n=document.getElementById("newFundTermStartDate"),o=document.getElementById("newFundInvestmentTerm"),a=e?.value?.trim(),s=n?.value||null,r=o?.value?parseInt(o.value):null;if(!a){w("Please enter a fund name","error");return}if(g.fundNames.has(a)){w("A fund with this name already exists","error");return}try{z("Adding...");const i={name:a,tags:[],investmentTermStartDate:s,investmentTermYears:r};await St(i),g.fundNames.add(a),g.fundNameData.set(a,i),e&&(e.value=""),n&&(n.value=""),o&&(o.value="");const c=document.getElementById("newFundTermsDetails");c&&(c.open=!1),w("Fund name added successfully"),await Ht(),await t()}catch(i){console.error("Error adding fund name:",i),w("Error adding fund name: "+i.message,"error")}finally{V()}}async function Fa(){const t=document.getElementById("newFundNameInline"),e=t?.value?.trim();if(!e){w("Please enter a fund name","error");return}if(g.fundNames.has(e)){w("A fund with this name already exists","error");return}try{const n={name:e,tags:[],investmentTermStartDate:null,investmentTermYears:null};await St(n),g.fundNames.add(e),g.fundNameData.set(e,n),await Vt();const o=document.getElementById("fundName");o&&(o.value=e);const a=document.getElementById("newFundNameContainer");a&&a.classList.add("hidden"),t&&(t.value=""),w("Fund name added successfully")}catch(n){console.error("Error adding fund name:",n),w("Error adding fund name: "+n.message,"error")}}function Ba(){const t=document.getElementById("newFundNameContainer"),e=document.getElementById("newFundNameInline"),n=document.getElementById("fundName");t&&t.classList.add("hidden"),e&&(e.value=""),n&&(n.value="")}function at(t){if(t==null)return"";const e=typeof t=="number"?t:parseFloat(String(t));return!isFinite(e)||isNaN(e)?"":e.toFixed(2)}function K(t){if(t==null)return"";const e=String(t);if(!isNaN(Number(e))&&e.trim()!=="")return e;const n=e.charAt(0);return e.length>0&&["=","+","-","@","	","\r"].includes(n)?"'"+e:e}async function qn(){try{const t=await H(),e=await _t(),n=await dt(),o=await bo(),a={funds:t,fundNames:e,groups:n,auditLog:o,exportDate:new Date().toISOString()},s=JSON.stringify(a,null,2),r=new Blob([s],{type:"application/json"}),c=`pe-funds-export-${new Date().toISOString().replace(/[:.]/g,"-")}.json`;if("showSaveFilePicker"in window)try{const f=await(await window.showSaveFilePicker({suggestedName:c,types:[{description:"JSON Files",accept:{"application/json":[".json"]}}]})).createWritable();await f.write(r),await f.close(),g.markDataExported(),w("Data exported successfully");return}catch(m){if(m.name==="AbortError")return;throw m}const l=URL.createObjectURL(r),u=document.createElement("a");u.href=l,u.download=c,document.body.appendChild(u),u.click(),document.body.removeChild(u),URL.revokeObjectURL(l),g.markDataExported(),w("Data exported successfully")}catch(t){w("Error exporting data: "+t.message,"error"),console.error("Error exporting data:",t)}}async function Ta(){z("Exporting to CSV...");try{const t=await H();let e=Me(t);g.sortColumns.length>0&&(e=Gn(e,g.sortColumns));const o=document.getElementById("cutoffDate")?.value,a=o?new Date(o+"T00:00:00"):void 0,s=e.map(p=>({...p,metrics:ot(p,a)})),r=localStorage.getItem(I.STORAGE_GROUP_BY_FUND)==="true";let i,c;if(r){const p=Rn(s,a,g.sortColumns);i=["Fund Name","Vintage","Investor Count","Total Commitment","Total Contributions","Total Distributions","Total NAV","Investment Return","MOIC","IRR","Outstanding Commitment"],c=p.map(h=>{const v=h.consolidatedMetrics,S=v.investmentReturn??v.distributions+v.nav-v.calledCapital;return[At(h.fundName),At(v.vintageYear?.toString()||""),K(h.investorCount.toString()),K(at(v.commitment)),K(at(v.calledCapital)),K(at(v.distributions)),K(at(v.nav)),K(at(S)),K(v.moic!==null&&isFinite(v.moic)?v.moic.toFixed(2):""),K(v.irr!==null?(v.irr*100).toFixed(2):""),K(at(v.outstandingCommitment))].join(",")})}else i=["Fund Name","Account Number","Vintage","Commitment","Total Contributions","Total Distributions","NAV","Investment Return","MOIC","IRR","Outstanding Commitment"],c=s.map(p=>{const h=p.metrics,v=h.investmentReturn??h.distributions+h.nav-h.calledCapital;return[At(p.fundName),At(p.accountNumber),At(h.vintageYear?.toString()||""),K(at(h.commitment)),K(at(h.calledCapital)),K(at(h.distributions)),K(at(h.nav)),K(at(v)),K(h.moic!==null&&isFinite(h.moic)?h.moic.toFixed(2):""),K(h.irr!==null?(h.irr*100).toFixed(2):""),K(at(h.outstandingCommitment))].join(",")});const l=[i.join(","),...c].join(`
`),u=new Blob([l],{type:"text/csv;charset=utf-8;"}),f=`pe-funds-export-${new Date().toISOString().replace(/[:.]/g,"-").split("T")[0]}.csv`,d=document.createElement("a");if(d.download!==void 0){const p=URL.createObjectURL(u);d.setAttribute("href",p),d.setAttribute("download",f),d.style.visibility="hidden",document.body.appendChild(d),d.click(),document.body.removeChild(d),URL.revokeObjectURL(p)}w("CSV exported successfully")}catch(t){w("Error exporting CSV: "+t.message,"error"),console.error("Error exporting CSV:",t)}finally{V()}}function Da(){window.print()}function Ne(t,e=0){if(e>I.MAX_JSON_DEPTH)throw new Error("Object too deeply nested");if(t===null||typeof t!="object")return t;if(Array.isArray(t))return t.map(o=>Ne(o,e+1));const n=Object.create(null);for(const o of Object.keys(t)){if(I.DANGEROUS_KEYS.includes(o)){console.warn(`Blocked potentially dangerous key: ${o}`);continue}n[o]=Ne(t[o],e+1)}return n}function Re(t){const e=JSON.parse(t);return Ne(e)}function xa(t){const e=document.getElementById("srAnnounce");e&&(e.textContent=t,setTimeout(()=>{e.textContent=""},1e3))}let Dt=null;async function ka(t){const e=await H(),n=new Map;e.forEach(r=>{if(r.groupId){const i=r.accountNumber.replace(/\s/g,"").toLowerCase();n.has(i)||n.set(i,[]);const c=n.get(i);c.includes(r.groupId)||c.push(r.groupId)}});let o=0,a=0;const s=[];for(const r of t)if(r.groupId==null&&r.accountNumber){const i=r.accountNumber.replace(/\s/g,"").toLowerCase(),c=n.get(i);c&&c.length===1?(r.groupId=c[0],r._groupAutoFilled=!0,o++):c&&c.length>1&&(a++,s.includes(r.accountNumber)||s.push(r.accountNumber))}return{enrichedCount:o,ambiguousCount:a,ambiguousAccounts:s}}function Aa(){Dt=null;const t=document.getElementById("importPreviewContent"),e=document.getElementById("applyImportBtn"),n=document.getElementById("importPreviewFileInput");t&&(t.innerHTML='<p style="color: var(--color-text-light);">Select a JSON file to preview...</p>'),e&&(e.disabled=!0),n&&(n.value=""),et("importPreviewModal")}async function Ma(t){const e=t.target,n=e.files?.[0];if(!n)return;const o=document.getElementById("importPreviewContent"),a=document.getElementById("applyImportBtn");if(n.size>I.MAX_FILE_SIZE){o&&(o.innerHTML=`<p style="color: var(--color-danger);">File too large (${(n.size/1024/1024).toFixed(2)}MB). Maximum size is ${I.MAX_FILE_SIZE/1024/1024}MB.</p>`),e.value="";return}try{const s=await n.text(),r=Re(s);Dt=r;const i=r.funds||r,c=Array.isArray(i)?i.length:0,l=r.groups?.length||0,u=r.fundNames?.length||0,m=await H(),f=new Set;m.forEach(y=>{const B=`${y.fundName}|${y.accountNumber}`.toLowerCase();f.add(B)});const d=[],p=[],h=new Set;if(Array.isArray(i))for(const y of i){const B=(y.accountNumber||"").replace(/\s/g,""),k=`${y.fundName}|${B}`.toLowerCase();f.has(k)||h.has(k)?d.push({fundName:y.fundName,accountNumber:y.accountNumber}):(p.push({fundName:y.fundName,accountNumber:y.accountNumber}),h.add(k))}const v=await dt(),S=new Set(v.map(y=>y.name.toLowerCase()));let E=0,C=0;if(r.groups&&Array.isArray(r.groups))for(const y of r.groups)S.has(y.name.toLowerCase())?E++:C++;let N=`
      <div style="margin-bottom: 15px;">
        <strong>File:</strong> ${T(n.name)}<br>
        <strong>Size:</strong> ${(n.size/1024).toFixed(2)} KB
      </div>
      <div style="margin-bottom: 15px;">
        <strong>Contents:</strong>
        <ul style="margin: 10px 0 0 20px;">
          <li>${c} fund(s)</li>
          ${l>0?`<li>${l} group(s)</li>`:""}
          ${u>0?`<li>${u} fund name(s)</li>`:""}
        </ul>
      </div>
    `;c>0&&(N+=`
        <div style="margin-bottom: 15px; padding: 12px; background: var(--color-alt-bg); border-radius: var(--radius-sm);">
          <strong>Import Analysis:</strong>
          <ul style="margin: 10px 0 0 20px;">
            <li style="color: var(--color-success);">${p.length} new fund(s) will be imported</li>
            ${d.length>0?`<li style="color: var(--color-warning);">${d.length} duplicate(s) will be skipped</li>`:""}
            ${C>0?`<li style="color: var(--color-success);">${C} new group(s) will be created</li>`:""}
            ${E>0?`<li style="color: var(--color-warning);">${E} existing group(s) will be skipped</li>`:""}
          </ul>
        </div>
      `),d.length>0&&(N+=`
        <div style="margin-bottom: 15px;">
          <strong style="color: var(--color-warning);">Duplicates to skip:</strong>
          <ul style="margin: 10px 0 0 20px; font-size: 0.9em; color: var(--color-warning);">
            ${d.slice(0,5).map(y=>`<li>${T(y.fundName)} (${T(y.accountNumber)})</li>`).join("")}
            ${d.length>5?`<li>... and ${d.length-5} more</li>`:""}
          </ul>
        </div>
      `),p.length>0&&(N+=`
        <div>
          <strong>New funds to import:</strong>
          <ul style="margin: 10px 0 0 20px; font-size: 0.9em;">
            ${p.slice(0,5).map(y=>`<li>${T(y.fundName)} (${T(y.accountNumber)})</li>`).join("")}
            ${p.length>5?`<li>... and ${p.length-5} more</li>`:""}
          </ul>
        </div>
      `),o&&(o.innerHTML=N),a&&(a.disabled=p.length===0&&C===0&&u===0)}catch(s){o&&(o.innerHTML=`<p style="color: var(--color-danger);">Error reading file: ${T(s.message)}</p>`),Dt=null,e.value=""}}async function Ga(t){if(!Dt){w("No import data available","error");return}O("importPreviewModal"),z("Importing data...");try{const e=Dt;let n=0;const o={};if(e.groups&&Array.isArray(e.groups)){if(e.groups.length>I.MAX_IMPORT_GROUPS)throw new Error(`Too many groups (${e.groups.length}). Maximum allowed is ${I.MAX_IMPORT_GROUPS}.`);const d=new Set(e.groups.map(C=>C.id));for(const C of e.groups)C.parentGroupId!=null&&(d.has(C.parentGroupId)||(C.parentGroupId=null),C.id===C.parentGroupId&&(C.parentGroupId=null));const p=[],h=new Set;let v=[...e.groups];for(;v.length>0;){const C=v.length;for(let N=v.length-1;N>=0;N--){const y=v[N];(y.parentGroupId==null||h.has(y.parentGroupId))&&(p.push(y),h.add(y.id),v.splice(N,1))}if(v.length===C){console.warn(`Import: ${v.length} group(s) had circular parent references and were moved to root level:`,v.map(N=>N.name)),v.forEach(N=>{N.parentGroupId=null,p.push(N)});break}}const S=await dt(),E={};S.forEach(C=>{E[C.name.toLowerCase()]=C});for(const C of p){const N=C.id,{id:y,...B}=C;B.parentGroupId!=null&&o[B.parentGroupId]&&(B.parentGroupId=o[B.parentGroupId]);const k=E[B.name.toLowerCase()];if(k)N!=null&&(o[N]=k.id);else{const P=await xe(B);N!=null&&P&&(o[N]=P),E[B.name.toLowerCase()]={...B,id:P}}}g.setGroups(await dt())}if(e.fundNames&&Array.isArray(e.fundNames)){if(e.fundNames.length>I.MAX_IMPORT_FUNDNAMES)throw new Error(`Too many fund names (${e.fundNames.length}). Maximum allowed is ${I.MAX_IMPORT_FUNDNAMES}.`);const d=[];for(const p of e.fundNames){const h=typeof p=="string"?{name:p,tags:[],investmentTermStartDate:null,investmentTermYears:null}:{name:p.name,tags:p.tags||[],investmentTermStartDate:p.investmentTermStartDate||p.finalCloseDate||null,investmentTermYears:p.investmentTermYears||null};await St(h),d.push(h)}for(const p of d)g.fundNames.add(p.name),g.fundNameData.set(p.name,p)}const a=e.funds||e;if(!Array.isArray(a))throw new Error("Invalid format: expected array of funds");if(a.length>I.MAX_IMPORT_FUNDS)throw new Error(`Too many funds (${a.length}). Maximum allowed is ${I.MAX_IMPORT_FUNDS}.`);const s=new Set;a.forEach(d=>{d.fundName&&!g.fundNames.has(d.fundName)&&s.add(d.fundName)});for(const d of s){const p={name:d,tags:[],investmentTermStartDate:null,investmentTermYears:null};await St(p),g.fundNames.add(d),g.fundNameData.set(d,p)}const r=await ka(a),i=await H(),c=new Set;i.forEach(d=>{const p=`${d.fundName}|${d.accountNumber}`.toLowerCase();c.add(p)});const l=[],u=[],m=[];for(let d=0;d<a.length;d++){const p=a[d],h=(p.accountNumber||"").replace(/\s/g,""),v=`${p.fundName}|${h}`.toLowerCase();if(c.has(v))continue;const S=(p.cashFlows||[]).map(y=>({date:y.date,amount:nt(y.amount),type:y.type||(y.amount<0?"Contribution":"Distribution"),affectsCommitment:y.affectsCommitment!==void 0?y.affectsCommitment:!0})),E=(p.monthlyNav||[]).map(y=>({date:y.date,amount:nt(y.amount)})),C={fundName:p.fundName,accountNumber:(p.accountNumber||"").replace(/\s/g,""),commitment:nt(p.commitment),cashFlows:S,monthlyNav:E},N=Cn(C);N.valid||m.push({index:d,name:p.fundName||p.accountNumber||`Fund ${d+1}`,errors:N.errors})}if(m.length>0){const d=m.slice(0,5).map(h=>`• ${h.name}: ${h.errors.slice(0,2).join("; ")}`).join(`
`),p=m.length>5?`
...and ${m.length-5} more`:"";throw new Error(`Import aborted: ${m.length} fund(s) failed validation.

${d}${p}`)}for(let d=0;d<a.length;d++){const p=a[d],h=(p.accountNumber||"").replace(/\s/g,""),v=`${p.fundName}|${h}`.toLowerCase();if(c.has(v)){l.push({index:d,name:p.fundName,account:p.accountNumber});continue}try{c.add(v);const S=(p.cashFlows||[]).map(y=>({date:y.date,amount:nt(y.amount),type:y.type||(y.amount<0?"Contribution":"Distribution"),affectsCommitment:y.affectsCommitment!==void 0?y.affectsCommitment:!0})),E=(p.monthlyNav||[]).map(y=>({date:y.date,amount:nt(y.amount)}));let C=null;p.groupId!=null&&(p._groupAutoFilled?C=p.groupId:o[p.groupId]&&(C=o[p.groupId]));const N={fundName:p.fundName,accountNumber:(p.accountNumber||"").replace(/\s/g,""),groupId:C,commitment:nt(p.commitment),cashFlows:S,monthlyNav:E,timestamp:p.timestamp||new Date().toISOString()};await st(N),n++}catch(S){console.error(`Error importing fund at index ${d}:`,S),u.push({index:d,name:p.fundName||p.accountNumber||"Unknown",error:S.message})}}if(u.length>0||l.length>0){const d=[];n>0&&d.push(`${n} imported`),l.length>0&&d.push(`${l.length} duplicates skipped`),u.length>0&&d.push(`${u.length} failed`),r.enrichedCount>0&&d.push(`${r.enrichedCount} groups auto-filled`);const p=u.length>0?"error":"success";w(`Import complete: ${d.join(", ")}`,p)}else{let d=`Successfully imported ${n} fund(s)`;r.enrichedCount>0&&(d+=` (${r.enrichedCount} groups auto-filled)`),w(d)}Dt=null;const f={fundFilter:U("fundFilter"),accountFilter:U("accountFilter"),groupFilter:U("groupFilter"),tagFilter:U("tagFilter"),vintageFilter:U("vintageFilter")};await t(),Bt("fundFilter",f.fundFilter),Bt("accountFilter",f.accountFilter),Bt("groupFilter",f.groupFilter),Bt("tagFilter",f.tagFilter),Bt("vintageFilter",f.vintageFilter),await t()}catch(e){w("Error importing data: "+e.message,"error"),console.error("Error importing data:",e)}finally{V()}}async function La(t){z("Loading sample data...");try{const e=[{name:"Buyout Funds",parentGroupId:null,type:"Strategy"},{name:"Venture Capital",parentGroupId:null,type:"Strategy"},{name:"Real Estate",parentGroupId:null,type:"Strategy"}],n={};for(const s of e){const r=await xe(s);n[s.name]=r}g.setGroups(await dt());const o=[{name:"Apex Capital Partners",tags:["Buyout","North America"],investmentTermStartDate:"2020-06-15",investmentTermYears:10},{name:"Summit Growth Fund",tags:["Growth","Technology"],investmentTermStartDate:"2021-03-01",investmentTermYears:10},{name:"Horizon Ventures",tags:["Venture","Early Stage"],investmentTermStartDate:"2022-01-10",investmentTermYears:12},{name:"Metro Real Estate Partners",tags:["Real Estate","Commercial"],investmentTermStartDate:"2019-09-01",investmentTermYears:8},{name:"Blue Ocean Capital",tags:["Buyout","Europe"],investmentTermStartDate:"2021-07-20",investmentTermYears:10}];for(const s of o)await St(s),g.fundNames.add(s.name),g.fundNameData.set(s.name,s);const a=[{fundName:"Apex Capital Partners",accountNumber:"APEX-001",groupId:n["Buyout Funds"]??null,commitment:5e6,cashFlows:[{date:"2020-07-01",amount:-125e4,type:"Contribution",affectsCommitment:!0},{date:"2020-12-15",amount:-1e6,type:"Contribution",affectsCommitment:!0},{date:"2021-06-30",amount:-75e4,type:"Contribution",affectsCommitment:!0},{date:"2022-03-15",amount:-5e5,type:"Contribution",affectsCommitment:!0},{date:"2023-01-20",amount:8e5,type:"Distribution",affectsCommitment:!0},{date:"2023-09-10",amount:12e5,type:"Distribution",affectsCommitment:!0}],monthlyNav:[{date:"2021-12-31",amount:32e5},{date:"2022-12-31",amount:38e5},{date:"2023-12-31",amount:45e5}],timestamp:new Date().toISOString()},{fundName:"Summit Growth Fund",accountNumber:"SUMMIT-001",groupId:n["Venture Capital"]??null,commitment:25e5,cashFlows:[{date:"2021-04-01",amount:-625e3,type:"Contribution",affectsCommitment:!0},{date:"2021-10-15",amount:-5e5,type:"Contribution",affectsCommitment:!0},{date:"2022-06-30",amount:-375e3,type:"Contribution",affectsCommitment:!0},{date:"2023-06-15",amount:4e5,type:"Distribution",affectsCommitment:!0}],monthlyNav:[{date:"2022-12-31",amount:18e5},{date:"2023-12-31",amount:22e5}],timestamp:new Date().toISOString()},{fundName:"Horizon Ventures",accountNumber:"HV-001",groupId:n["Venture Capital"]??null,commitment:1e6,cashFlows:[{date:"2022-02-01",amount:-25e4,type:"Contribution",affectsCommitment:!0},{date:"2022-08-15",amount:-2e5,type:"Contribution",affectsCommitment:!0},{date:"2023-04-01",amount:-15e4,type:"Contribution",affectsCommitment:!0}],monthlyNav:[{date:"2022-12-31",amount:52e4},{date:"2023-12-31",amount:75e4}],timestamp:new Date().toISOString()},{fundName:"Metro Real Estate Partners",accountNumber:"METRO-001",groupId:n["Real Estate"]??null,commitment:3e6,cashFlows:[{date:"2019-10-01",amount:-75e4,type:"Contribution",affectsCommitment:!0},{date:"2020-04-15",amount:-6e5,type:"Contribution",affectsCommitment:!0},{date:"2020-12-01",amount:-45e4,type:"Contribution",affectsCommitment:!0},{date:"2021-06-30",amount:-3e5,type:"Contribution",affectsCommitment:!0},{date:"2022-03-15",amount:5e5,type:"Distribution",affectsCommitment:!0},{date:"2023-03-15",amount:6e5,type:"Distribution",affectsCommitment:!0}],monthlyNav:[{date:"2021-12-31",amount:24e5},{date:"2022-12-31",amount:28e5},{date:"2023-12-31",amount:31e5}],timestamp:new Date().toISOString()},{fundName:"Blue Ocean Capital",accountNumber:"BOC-001",groupId:n["Buyout Funds"]??null,commitment:4e6,cashFlows:[{date:"2021-08-01",amount:-1e6,type:"Contribution",affectsCommitment:!0},{date:"2022-02-15",amount:-8e5,type:"Contribution",affectsCommitment:!0},{date:"2022-09-01",amount:-6e5,type:"Contribution",affectsCommitment:!0},{date:"2023-05-15",amount:7e5,type:"Distribution",affectsCommitment:!0}],monthlyNav:[{date:"2022-12-31",amount:26e5},{date:"2023-12-31",amount:32e5}],timestamp:new Date().toISOString()}];for(const s of a)await st(s);g.clearMetricsCache(),w(`Successfully loaded ${a.length} sample investments`),await t()}catch(e){w("Error loading sample data: "+e.message,"error"),console.error("Error loading sample data:",e)}finally{V()}}async function Kn(t){const e=document.getElementById(t);if(!e)return;const o=(await _t()).map(a=>a.name).sort();e.innerHTML='<option value="">Select a fund</option>',o.forEach(a=>{const s=document.createElement("option");s.value=a,s.textContent=a,e.appendChild(s)})}async function Ra(t){const e=document.getElementById(t);if(!e)return;const n=await H(),o=[...new Set(n.map(a=>a.accountNumber))].sort();e.innerHTML='<option value="">Select an account</option>',o.forEach(a=>{const s=document.createElement("option");s.value=a,s.textContent=a,e.appendChild(s)})}async function $a(){await Kn("bulkCashFlowFundName");const t=document.getElementById("bulkCashFlowDate"),e=document.getElementById("bulkCashFlowType"),n=document.getElementById("bulkCashFlowPercentage"),o=document.getElementById("bulkCashFlowAffectsCommitment"),a=document.getElementById("bulkCashFlowPreview"),s=document.getElementById("applyBulkCashFlowBtn");t&&(t.value=new Date().toISOString().split("T")[0]||""),e&&(e.value="Contribution"),n&&(n.value=""),o&&(o.checked=!0),a&&a.classList.remove("show"),s&&(s.disabled=!0),et("bulkCashFlowModal")}async function Oa(){const t=document.getElementById("bulkCashFlowFundName"),e=document.getElementById("bulkCashFlowPercentage"),n=document.getElementById("bulkCashFlowType"),o=document.getElementById("bulkCashFlowPreview"),a=document.getElementById("bulkCashFlowPreviewContent"),s=document.getElementById("applyBulkCashFlowBtn"),r=t?.value,i=parseFloat(e?.value||"0"),c=n?.value||"Contribution";if(!r){w("Please select a fund","error");return}if(isNaN(i)||i<=0||i>100){w("Please enter a valid percentage (0.01 - 100)","error");return}const u=(await H()).filter(p=>p.fundName===r);if(u.length===0){w("No investments found for this fund","error");return}let m='<table style="width: 100%; font-size: 0.9em;"><thead><tr><th>Account</th><th style="text-align: right;">Commitment</th><th style="text-align: right;">Amount</th></tr></thead><tbody>',f=0;u.forEach(p=>{const h=p.commitment*(i/100);f+=h;const v=c==="Contribution"?-h:h;m+=`<tr><td>${T(p.accountNumber)}</td><td style="text-align: right;">${x(p.commitment)}</td><td style="text-align: right;">${x(v)}</td></tr>`});const d=c==="Contribution"?-f:f;m+=`</tbody><tfoot><tr style="font-weight: bold;"><td>Total (${u.length} investors)</td><td></td><td style="text-align: right;">${x(d)}</td></tr></tfoot></table>`,a&&(a.innerHTML=m),o&&o.classList.add("show"),s&&(s.disabled=!1)}async function Pa(t){const e=document.getElementById("bulkCashFlowFundName"),n=document.getElementById("bulkCashFlowDate"),o=document.getElementById("bulkCashFlowType"),a=document.getElementById("bulkCashFlowPercentage"),s=document.getElementById("bulkCashFlowAffectsCommitment"),r=e?.value,i=n?.value,c=o?.value||"Contribution",l=parseFloat(a?.value||"0"),u=s?.checked??!0;if(!r||!i||isNaN(l)){w("Missing required fields","error");return}O("bulkCashFlowModal"),z("Applying bulk cash flow...");try{const f=(await H()).filter(p=>p.fundName===r);let d=0;for(const p of f){const h=p.commitment*(l/100),v=c==="Contribution"?-h:h,S={...p,cashFlows:[...p.cashFlows,{date:i,amount:v,type:c,affectsCommitment:u}],timestamp:new Date().toISOString()};await st(S),d++}g.clearMetricsCache(),w(`Successfully added cash flow to ${d} investment(s)`),await t()}catch(m){w("Error applying bulk cash flow: "+m.message,"error")}finally{V()}}async function Ua(){await Kn("bulkRemoveFundName");const t=document.getElementById("bulkRemoveFundPreview"),e=document.getElementById("applyBulkRemoveFundBtn");t&&t.classList.remove("show"),e&&(e.disabled=!0),et("bulkRemoveFundModal")}async function _a(){const t=document.getElementById("bulkRemoveFundName"),e=document.getElementById("bulkRemoveFundPreview"),n=document.getElementById("bulkRemoveFundPreviewContent"),o=document.getElementById("applyBulkRemoveFundBtn"),a=t?.value;if(!a){w("Please select a fund","error");return}const r=(await H()).filter(c=>c.fundName===a);if(r.length===0){w("No investments found for this fund","error");return}let i='<ul style="margin: 0; padding-left: 20px;">';r.forEach(c=>{i+=`<li>${T(c.accountNumber)} - ${x(c.commitment)}</li>`}),i+="</ul>",i+=`<p style="margin-top: 10px; font-weight: bold; color: var(--color-danger);">Total: ${r.length} investment(s) will be permanently deleted.</p>`,n&&(n.innerHTML=i),e&&e.classList.add("show"),o&&(o.disabled=!1)}async function Ya(t){const n=document.getElementById("bulkRemoveFundName")?.value;if(!n){w("Please select a fund","error");return}O("bulkRemoveFundModal"),z("Removing investments...");try{const a=(await H()).filter(r=>r.fundName===n);let s=0;for(const r of a)r.id&&(await Nn(r.id),s++);g.clearMetricsCache(),w(`Successfully removed ${s} investment(s)`),await t()}catch(o){w("Error removing investments: "+o.message,"error")}finally{V()}}async function Wa(){await Ra("bulkAssignGroupAccount"),Et("bulkAssignGroupTarget");const t=document.getElementById("bulkAssignGroupPreview"),e=document.getElementById("applyBulkAssignGroupBtn");t&&t.classList.remove("show"),e&&(e.disabled=!0),et("bulkAssignGroupModal")}async function Va(){const t=document.getElementById("bulkAssignGroupAccount"),e=document.getElementById("bulkAssignGroupTarget"),n=document.getElementById("bulkAssignGroupPreview"),o=document.getElementById("bulkAssignGroupPreviewContent"),a=document.getElementById("applyBulkAssignGroupBtn"),s=t?.value,r=e?.value?parseInt(e.value):null;if(!s){w("Please select an account","error");return}const c=(await H()).filter(m=>m.accountNumber===s);if(c.length===0){w("No investments found for this account","error");return}const l=r?g.getGroupByIdSync(r)?.name||"Unknown":"No Group";let u='<ul style="margin: 0; padding-left: 20px;">';c.forEach(m=>{u+=`<li>${T(m.fundName)}</li>`}),u+="</ul>",u+=`<p style="margin-top: 10px;">These ${c.length} investment(s) will be assigned to: <strong>${T(l)}</strong></p>`,o&&(o.innerHTML=u),n&&n.classList.add("show"),a&&(a.disabled=!1)}async function Ha(t){const e=document.getElementById("bulkAssignGroupAccount"),n=document.getElementById("bulkAssignGroupTarget"),o=e?.value,a=n?.value?parseInt(n.value):null;if(!o){w("Please select an account","error");return}O("bulkAssignGroupModal"),z("Assigning group...");try{const r=(await H()).filter(c=>c.accountNumber===o);let i=0;for(const c of r){const l={...c,groupId:a,timestamp:new Date().toISOString()};await st(l),i++}g.clearMetricsCache(),w(`Successfully updated ${i} investment(s)`),await t()}catch(s){w("Error assigning group: "+s.message,"error")}finally{V()}}function ja(t){const e=document.getElementById("closeBulkCashFlowModalBtn"),n=document.getElementById("cancelBulkCashFlowBtn"),o=document.getElementById("previewBulkCashFlowBtn"),a=document.getElementById("applyBulkCashFlowBtn");[e,n].forEach(d=>{d&&d.addEventListener("click",()=>O("bulkCashFlowModal"))}),o&&o.addEventListener("click",Oa),a&&a.addEventListener("click",()=>Pa(t));const s=document.getElementById("closeBulkRemoveFundModalBtn"),r=document.getElementById("cancelBulkRemoveFundBtn"),i=document.getElementById("previewBulkRemoveFundBtn"),c=document.getElementById("applyBulkRemoveFundBtn");[s,r].forEach(d=>{d&&d.addEventListener("click",()=>O("bulkRemoveFundModal"))}),i&&i.addEventListener("click",_a),c&&c.addEventListener("click",()=>Ya(t));const l=document.getElementById("closeBulkAssignGroupModalBtn"),u=document.getElementById("cancelBulkAssignGroupBtn"),m=document.getElementById("previewBulkAssignGroupBtn"),f=document.getElementById("applyBulkAssignGroupBtn");[l,u].forEach(d=>{d&&d.addEventListener("click",()=>O("bulkAssignGroupModal"))}),m&&m.addEventListener("click",Va),f&&f.addEventListener("click",()=>Ha(t))}function qa(t,e){const n={calls:{},distributions:{},byFund:{}},o=e?e.getFullYear():new Date().getFullYear();return t.forEach(a=>{if(!a.cashFlows||a.cashFlows.length===0)return;const s=a.fundName;n.byFund[s]||(n.byFund[s]={calls:{},distributions:{}}),a.cashFlows.forEach(r=>{if(!r.date)return;const i=new Date(r.date+"T00:00:00"),c=i.getFullYear();if(r.type==="Adjustment"||e&&i>e||c>o)return;const l=Math.abs(r.amount);r.type==="Contribution"?(n.calls[c]=(n.calls[c]||0)+l,n.byFund[s].calls[c]=(n.byFund[s].calls[c]||0)+l):r.type==="Distribution"&&(n.distributions[c]=(n.distributions[c]||0)+l,n.byFund[s].distributions[c]=(n.byFund[s].distributions[c]||0)+l)})}),n}function Ka(t,e,n){const o={projectedCalls:{},byFund:{},estimatedCalls:{},estimatedByFund:{},estimatedYears:new Set},a=n||new Date,s=a.getFullYear(),r=4;return t.forEach(i=>{const c=e.get(i.fundName);if(!c)return;const{investmentTermStartDate:l,investmentTermYears:u}=c;if(!l||!u){const y=i.commitment||0,B=(i.cashFlows||[]).filter(P=>P.type==="Adjustment"||n&&new Date(P.date+"T00:00:00")>n?!1:P.type==="Contribution").reduce((P,L)=>P+Math.abs(L.amount),0),k=Math.max(0,y-B);if(k>0){const P=s+1,L=k/r,j=i.fundName;o.estimatedByFund[j]||(o.estimatedByFund[j]={});for(let q=0;q<r;q++){const lt=P+q;o.estimatedCalls[lt]=(o.estimatedCalls[lt]||0)+L,o.estimatedByFund[j][lt]=(o.estimatedByFund[j][lt]||0)+L,o.estimatedYears.add(lt)}}return}const m=new Date(l+"T00:00:00"),f=new Date(m);if(f.setFullYear(f.getFullYear()+u),f<a)return;const d=i.commitment||0,p=(i.cashFlows||[]).filter(y=>y.type==="Adjustment"||n&&new Date(y.date+"T00:00:00")>n?!1:y.type==="Contribution").reduce((y,B)=>y+Math.abs(B.amount),0),h=Math.max(0,d-p);if(h<=0)return;const v=Math.max(s+1,m.getFullYear()),S=f.getFullYear(),E=[];for(let y=v;y<=S;y++)E.push(y);if(E.length===0)return;const C=h/E.length,N=i.fundName;o.byFund[N]||(o.byFund[N]={}),E.forEach(y=>{o.projectedCalls[y]=(o.projectedCalls[y]||0)+C,o.byFund[N][y]=(o.byFund[N][y]||0)+C})}),o}function Za(t,e,n){const o=n||new Date().getFullYear(),a=new Set;Object.keys(t.calls).forEach(h=>a.add(parseInt(h))),Object.keys(t.distributions).forEach(h=>a.add(parseInt(h))),Object.keys(e.projectedCalls).forEach(h=>a.add(parseInt(h))),Object.keys(e.estimatedCalls||{}).forEach(h=>a.add(parseInt(h)));const s=Array.from(a);if(s.length===0){const h=[];for(let v=o;v<=o+4;v++)h.push(v);return{years:h,cutoffYear:o,firstProjectedYear:o+1,estimatedYears:new Set}}const r=Math.min(...s),i=Math.max(...s),c=Math.min(r,o-9),l=Math.max(i,o+6),u=[];for(let h=c;h<=l;h++)u.push(h);const m=u.filter(h=>h<=o),f=u.filter(h=>h>o),d=m.slice(-10),p=f.slice(0,6);return{years:[...d,...p],cutoffYear:o,firstProjectedYear:p.length>0?p[0]:null,estimatedYears:e.estimatedYears||new Set}}function fn(t,e,n,o,a,s,r,i,c,l,u={},m={}){let f="";const d=T(t),p=X(e);return f+=`<tr class="${e==="calls"?"row-calls":"row-distributions"} timeline-expand-row" ${`data-type="${p}"`}>`,f+=`<td class="row-label"><span class="timeline-expand-icon">▶</span>${d}</td>`,n.years.forEach(v=>{const S=n.firstProjectedYear!==null&&v>=n.firstProjectedYear,E=v===n.firstProjectedYear,C=n.estimatedYears&&n.estimatedYears.has(v);let N=0,y=!1;if(S){const P=a[v]||0,L=u[v]||0;N=P+L,y=L>0}else o[v]&&(N=o[v]);let B=E?"timeline-divider":"";C&&y?B+=" year-estimated":S&&(B+=" year-projected");const k=N>0?x(e==="calls"?-N:N):"-";f+=`<td class="${B}">${k}</td>`}),f+="</tr>",r&&r.forEach(v=>{f+=`<tr class="timeline-fund-row" data-type="${p}">`,f+=`<td>${T(v)}</td>`,n.years.forEach(S=>{const E=n.firstProjectedYear!==null&&S>=n.firstProjectedYear,C=S===n.firstProjectedYear,N=n.estimatedYears&&n.estimatedYears.has(S);let y=0,B=!1;if(E){const L=c[v]&&c[v][S]||0,j=m[v]&&m[v][S]||0;y=L+j,B=j>0}else i[v]&&i[v][l]&&i[v][l][S]&&(y=i[v][l][S]);let k=C?"timeline-divider":"";N&&B?k+=" year-estimated":E&&(k+=" year-projected");const P=y>0?x(e==="calls"?-y:y):"-";f+=`<td class="${k}">${P}</td>`}),f+="</tr>"}),f}function Xa(t,e,n){let o='<tr class="row-net">';return o+='<td class="row-label">Net Cash Flow</td>',t.years.forEach(a=>{const s=t.firstProjectedYear!==null&&a>=t.firstProjectedYear,r=a===t.firstProjectedYear,i=t.estimatedYears&&t.estimatedYears.has(a);let c=0,l=0,u=!1;if(s){const p=n.projectedCalls[a]||0,h=n.estimatedCalls&&n.estimatedCalls[a]||0;c=p+h,u=h>0}else c=e.calls[a]||0,l=e.distributions[a]||0;const m=l-c;let f=r?"timeline-divider":"";i&&u?f+=" year-estimated":s&&(f+=" year-projected"),f+=` ${m>=0?"positive":"negative"}`;let d="-";(c>0||l>0)&&(d=(m>=0?"+":"")+x(m)),o+=`<td class="${f}">${d}</td>`}),o+="</tr>",o}function za(t){const e=document.getElementById("timelineTableContainer"),n=document.getElementById("timelinePanel");if(!e)return;if(n&&!n.classList.contains("expanded")){e.innerHTML="";return}if(!t||t.length===0){e.innerHTML='<p class="timeline-no-data">No investments to display. <a href="#" data-action="showAddFundModal" style="color: var(--color-action);">Add your first investment</a> with cash flows to see the timeline.</p>',gn(e);return}const a=document.getElementById("cutoffDate")?.value,s=a?new Date(a+"T00:00:00"):null,r=s?s.getFullYear():null,i=qa(t,s),c=Ka(t,g.fundNameData,s),l=Za(i,c,r);if(l.years.length===0){e.innerHTML='<p class="timeline-no-data">No cash flow data available for the selected funds.</p>';return}let u='<table class="timeline-table">';const m=l.estimatedYears&&l.estimatedYears.size>0;u+="<thead><tr><th></th>",l.years.forEach(d=>{const p=l.firstProjectedYear!==null&&d>=l.firstProjectedYear,h=d===l.firstProjectedYear,v=l.estimatedYears&&l.estimatedYears.has(d),S=`${p&&!v?"year-projected":""} ${v?"year-estimated":""} ${h?"timeline-divider":""}`;let E="";v?E='<span class="timeline-estimated-indicator" title="Estimated: fund(s) missing term start date">&#8224;</span>':p&&(E="*"),u+=`<th class="${S}">${d}${E}</th>`}),u+="</tr></thead>",u+="<tbody>";const f=[...new Set(t.map(d=>d.fundName))].sort();if(u+=fn("Capital Calls","calls",l,i.calls,c.projectedCalls,!0,f,i.byFund,c.byFund,"calls",c.estimatedCalls,c.estimatedByFund),u+=fn("Distributions","distributions",l,i.distributions,{},!0,f,i.byFund,{},"distributions",{},{}),u+=Xa(l,i,c),u+="</tbody></table>",l.firstProjectedYear||m){let d='<div style="margin-top: 10px; font-size: 11px; color: var(--color-text-light); font-style: italic;">';if(l.firstProjectedYear&&!m){const p=s?`* Projected values (after ${T(a||"")}) based on remaining uncalled capital distributed linearly across investment period`:"* Projected values based on remaining uncalled capital distributed linearly across investment period";d+=`<p style="margin: 0;">${p}</p>`}else if(m&&!l.firstProjectedYear)d+='<p style="margin: 0; color: var(--color-warning);">&#8224; Estimated projections for funds missing term start date (spread over 4 years). <a href="#" data-action="showManageFundsModal" style="color: var(--color-action);">Add fund terms</a> for more accurate projections.</p>';else if(l.firstProjectedYear&&m){const p=s?`* Projected values (after ${T(a||"")}) based on remaining uncalled capital distributed linearly across investment period`:"* Projected values based on remaining uncalled capital distributed linearly across investment period";d+=`<p style="margin: 0 0 4px 0;">${p}</p>`,d+='<p style="margin: 0; color: var(--color-warning);">&#8224; Estimated projections for funds missing term start date (spread over 4 years). <a href="#" data-action="showManageFundsModal" style="color: var(--color-action);">Add fund terms</a> for more accurate projections.</p>'}d+="</div>",u+=d}e.innerHTML=u,gn(e)}let pn=!1;function gn(t){pn||(pn=!0,t.addEventListener("click",e=>{const o=e.target.closest("a[data-action]");if(!o)return;e.preventDefault();const a=o.dataset.action;a==="showAddFundModal"&&typeof window.showAddFundModal=="function"?window.showAddFundModal():a==="showManageFundsModal"&&typeof window.showManageFundsModal=="function"&&window.showManageFundsModal()}))}function Ja(){const t=g.getFunds(),e=Me(t);za(e)}function Qa(t,e=[],n=[]){let o=[];const a=new Set;for(const l of t){if(l.id==null)continue;const u=es(l);for(const m of u)o.push(m),a.add(l.id)}const s=os(t);for(const l of s)o.push(l),a.add(l.fundId);let r=as(t);n.length>0&&(r=r.filter(l=>{const u=Math.min(l.fund1Id,l.fund2Id),m=Math.max(l.fund1Id,l.fund2Id);return!n.some(f=>f.fund2Id>0&&f.fund1Id===u&&f.fund2Id===m)}),o=o.filter(l=>!n.some(u=>u.fund2Id===0&&u.fund1Id===l.fundId&&u.category===l.category&&u.message===l.message)));const i=ts(e,t),c={error:0,warning:1,info:2};o.sort((l,u)=>c[l.severity]-c[u.severity]),a.clear();for(const l of o)a.add(l.fundId);return{totalFunds:t.length,fundsWithIssues:a.size,issues:o,duplicates:r,groupIssues:i,errorCount:o.filter(l=>l.severity==="error").length+i.filter(l=>l.severity==="error").length,warningCount:o.filter(l=>l.severity==="warning").length+i.filter(l=>l.severity==="warning").length,infoCount:o.filter(l=>l.severity==="info").length+i.filter(l=>l.severity==="info").length,timestamp:new Date().toISOString()}}function ts(t,e){const n=[],o=new Set;for(const s of e)s.groupId!=null&&o.add(s.groupId);const a=new Set;for(const s of t)s.parentGroupId!=null&&a.add(s.parentGroupId);for(const s of t)if(s.id===0&&n.push({groupId:s.id,groupName:s.name,severity:"error",message:"Group has ID 0 (data corruption). Delete and recreate this group."}),s.id!=null&&s.id!==0){const r=o.has(s.id),i=a.has(s.id);!r&&!i&&n.push({groupId:s.id,groupName:s.name,severity:"warning",message:"Orphaned group: no investments or sub-groups assigned."})}return n}function es(t){const e=[],n=t.id,o=t.fundName;if(t.commitment<=0&&e.push({fundId:n,fundName:o,severity:"error",category:"Invalid Data",message:`Commitment is ${t.commitment<=0?t.commitment===0?"zero":"negative":"invalid"}`}),!t.cashFlows||t.cashFlows.length===0)e.push({fundId:n,fundName:o,severity:"info",category:"Incomplete Data",message:"No cash flows recorded"});else{const r=t.cashFlows.filter(d=>d.type==="Contribution"&&W(d.date)).sort((d,p)=>d.date.localeCompare(p.date)),i=t.cashFlows.filter(d=>d.type==="Distribution"&&W(d.date)).sort((d,p)=>d.date.localeCompare(p.date));if(r.length>0&&i.length>0){const d=r[0],p=i.filter(h=>h.date<d.date);p.length>0&&e.push({fundId:n,fundName:o,severity:"warning",category:"Timeline Issue",message:`${p.length} distribution(s) before first contribution (${d.date})`})}const c=new Map;for(const d of t.cashFlows){const p=d.affectsCommitment!==!1,h=`${d.date}|${d.type}|${d.amount}|${p}`;c.set(h,(c.get(h)||0)+1)}const l=Array.from(c.entries()).filter(([,d])=>d>1);if(l.length>0){const d=l.reduce((p,[,h])=>p+h-1,0);e.push({fundId:n,fundName:o,severity:"warning",category:"Duplicate Data",message:`${d} duplicate cash flow(s) detected`})}const u=new Date;u.setDate(u.getDate()+30);const m=u.toISOString().split("T")[0],f=t.cashFlows.filter(d=>W(d.date)&&d.date>m);if(f.length>0&&e.push({fundId:n,fundName:o,severity:"warning",category:"Timeline Issue",message:`${f.length} cash flow(s) dated more than 30 days in the future`}),t.commitment>0){const d=No(t,"Contribution"),p=d/t.commitment;p>1.2&&e.push({fundId:n,fundName:o,severity:"warning",category:"Data Anomaly",message:`Contributions (${Qt(d)}) exceed commitment (${Qt(t.commitment)}) by ${Math.round((p-1)*100)}%`})}}if(t.monthlyNav&&t.monthlyNav.length>0){const r=(t.cashFlows||[]).filter(f=>W(f.date)).sort((f,d)=>f.date.localeCompare(d.date));if(r.length>0){const f=r[0].date,d=t.monthlyNav.filter(p=>W(p.date)&&p.date<f);d.length>0&&e.push({fundId:n,fundName:o,severity:"info",category:"Timeline Issue",message:`${d.length} NAV entry(ies) before first cash flow`})}const i=t.monthlyNav.filter(f=>W(f.date)).map(f=>f.date),c=new Set(i);i.length!==c.size&&e.push({fundId:n,fundName:o,severity:"warning",category:"Duplicate Data",message:`${i.length-c.size} duplicate NAV date(s)`});const l=new Date;l.setDate(l.getDate()+30);const u=l.toISOString().split("T")[0],m=t.monthlyNav.filter(f=>W(f.date)&&f.date>u);m.length>0&&e.push({fundId:n,fundName:o,severity:"warning",category:"Timeline Issue",message:`${m.length} NAV entry(ies) dated more than 30 days in the future`})}const a=ot(t),s=(t.cashFlows||[]).filter(r=>W(r.date)).map(r=>r.date).concat((t.monthlyNav||[]).filter(r=>W(r.date)).map(r=>r.date)).sort();if(s.length>=2){const r=new Date(s[0]+"T00:00:00").getTime(),c=(new Date(s[s.length-1]+"T00:00:00").getTime()-r)/(24*60*60*1e3);c>0&&c<30&&e.push({fundId:n,fundName:o,severity:"info",category:"Calculation Note",message:`Short holding period (${Math.round(c)} days) - IRR not calculated for periods under 30 days`})}if(t.monthlyNav&&t.monthlyNav.length>0&&(!t.cashFlows||t.cashFlows.length===0)&&e.push({fundId:n,fundName:o,severity:"info",category:"Incomplete Data",message:"Has NAV but no cash flows - IRR and MOIC cannot be calculated"}),t.cashFlows&&t.cashFlows.length>0){const r=t.cashFlows.some(c=>c.type==="Contribution");t.cashFlows.some(c=>c.type==="Distribution")&&!r&&e.push({fundId:n,fundName:o,severity:"warning",category:"Data Anomaly",message:"Has distributions but no contributions - MOIC cannot be calculated"})}if(t.cashFlows&&t.cashFlows.length>0&&(!t.monthlyNav||t.monthlyNav.length===0)&&a.outstandingCommitment>0&&e.push({fundId:n,fundName:o,severity:"info",category:"Incomplete Data",message:"No NAV recorded - investment return may be understated if fund holds unrealized value"}),a.irr!==null&&a.irr>5&&e.push({fundId:n,fundName:o,severity:"warning",category:"Data Anomaly",message:`Extremely high IRR (${(a.irr*100).toFixed(1)}%) - verify data accuracy`}),a.calledCapital>0&&a.nav>=0){const r=a.calledCapital+a.nav;a.distributions>r*1.5&&e.push({fundId:n,fundName:o,severity:"warning",category:"Data Anomaly",message:`Distributions (${Qt(a.distributions)}) significantly exceed contributions + NAV`})}if(a.nav<0&&Math.abs(a.nav)>1e3&&e.push({fundId:n,fundName:o,severity:"info",category:"Review Needed",message:`Negative NAV (${Qt(a.nav)}) - verify if this is expected`}),a.vintageYear!==null){const r=(t.cashFlows||[]).filter(i=>i.type==="Contribution"&&W(i.date)).sort((i,c)=>i.date.localeCompare(c.date))[0];if(r){const i=new Date(r.date+"T00:00:00").getFullYear();i!==a.vintageYear&&e.push({fundId:n,fundName:o,severity:"info",category:"Data Anomaly",message:`Calculated vintage (${i}) differs from stored value`})}}return e}function Qt(t){return new Intl.NumberFormat("en-US",{style:"currency",currency:"USD",minimumFractionDigits:0,maximumFractionDigits:0}).format(t)}function Zn(t){switch(t){case"error":return"severity-error";case"warning":return"severity-warning";case"info":return"severity-info";default:return""}}function Xn(t){switch(t){case"error":return"Error";case"warning":return"Warning";case"info":return"Info";default:return t}}function ns(t){switch(t){case"high":return"confidence-high";case"medium":return"confidence-medium";case"low":return"confidence-low";default:return""}}function os(t){const e=[],n=new Map;for(const o of t){if(o.id==null||o.commitment<=0)continue;const a=Pt(o.fundName);n.has(a)||n.set(a,[]),n.get(a).push(o)}for(const[,o]of n){if(o.length<2)continue;const a=o.map(c=>({fund:c,metrics:ot(c)})),s=a.reduce((c,l)=>c+l.fund.commitment,0),r=a.reduce((c,l)=>c+l.metrics.calledCapital,0),i=a.reduce((c,l)=>c+l.metrics.distributions,0);if(!(r===0&&i===0))for(const{fund:c,metrics:l}of a){const u=c.commitment/s*r,m=c.commitment/s*i;if(l.calledCapital>0&&r>0){const f=Math.abs(l.calledCapital-u)/u;if(f>.1){const d=o.length-1;e.push({fundId:c.id,fundName:c.fundName,severity:"info",category:"Data Anomaly",message:`Contributions not proportional to commitment (${Math.round(f*100)}% deviation vs ${d} other investment${d>1?"s":""} in same fund)`});continue}}if(l.distributions>0&&i>0){const f=Math.abs(l.distributions-m)/m;if(f>.1){const d=o.length-1;e.push({fundId:c.id,fundName:c.fundName,severity:"info",category:"Data Anomaly",message:`Distributions not proportional to commitment (${Math.round(f*100)}% deviation vs ${d} other investment${d>1?"s":""} in same fund)`})}}}}return e}function as(t){const e=[],n=new Set;for(let a=0;a<t.length;a++)for(let s=a+1;s<t.length;s++){const r=t[a],i=t[s];if(r.id==null||i.id==null)continue;const c=`${Math.min(r.id,i.id)}-${Math.max(r.id,i.id)}`;if(n.has(c))continue;const l=ss(r,i);l&&(n.add(c),e.push({fund1Id:r.id,fund1Name:r.fundName,fund2Id:i.id,fund2Name:i.fundName,reason:l.reason,confidence:l.confidence}))}const o={high:0,medium:1,low:2};return e.sort((a,s)=>o[a.confidence]-o[s.confidence]),e}function ss(t,e){const n=t.accountNumber&&e.accountNumber&&hn(t.accountNumber)===hn(e.accountNumber);if(Pt(t.fundName)===Pt(e.fundName)&&n)return{reason:"Identical fund name and account number",confidence:"high"};const a=ls(t.fundName,e.fundName);if(a>=.85&&n){const s=ot(t),r=ot(e),i=s.vintageYear,c=r.vintageYear;if(!(i!=null&&c!=null&&i!==c))return{reason:`Same account with similar fund names (${Math.round(a*100)}% match)`,confidence:"medium"}}return null}const rs={xxv:"25",xxiv:"24",xxiii:"23",xxii:"22",xxi:"21",xx:"20",xix:"19",xviii:"18",xvii:"17",xvi:"16",xv:"15",xiv:"14",xiii:"13",xii:"12",xi:"11",x:"10",ix:"9",viii:"8",vii:"7",vi:"6",v:"5",iv:"4",iii:"3",ii:"2",i:"1"},is=/\b(xxv|xxiv|xxiii|xxii|xxi|xx|xix|xviii|xvii|xvi|xv|xiv|xiii|xii|xi|x|ix|viii|vii|vi|v|iv|iii|ii|i)\b/gi;function cs(t){return t.replace(is,e=>rs[e.toLowerCase()]||e)}function Pt(t){let e=t.toLowerCase();return e=cs(e),e.replace(/[^a-z0-9]/g,"").replace(/fund/g,"").replace(/lp/g,"").replace(/llc/g,"").replace(/inc/g,"").trim()}function hn(t){return t.toLowerCase().replace(/[^a-z0-9]/g,"").trim()}function ls(t,e){const n=Pt(t),o=Pt(e);if(n===o)return 1;if(n.length===0||o.length===0)return 0;const a=us(n,o),s=Math.max(n.length,o.length);return 1-a/s}function us(t,e){t.length>e.length&&([t,e]=[e,t]);const n=t.length,o=e.length;let a=new Array(n+1),s=new Array(n+1);for(let r=0;r<=n;r++)a[r]=r;for(let r=1;r<=o;r++){s[0]=r;for(let i=1;i<=n;i++){const c=t[i-1]===e[r-1]?0:1;s[i]=Math.min(a[i]+1,s[i-1]+1,a[i-1]+c)}[a,s]=[s,a]}return a[n]}const ut=new Map;function yn(){const t=document.getElementById("backupWarningModal");t&&t.classList.add("show")}function pe(){const t=document.getElementById("backupWarningModal");t&&t.classList.remove("show")}function zn(){localStorage.setItem(I.STORAGE_LAST_BACKUP,new Date().toISOString())}function ds(){const t=localStorage.getItem(I.STORAGE_LAST_BACKUP);if(localStorage.getItem(I.STORAGE_BACKUP_WARNING)==="true")return;if(!t){yn();return}(Date.now()-new Date(t).getTime())/(1e3*60*60*24)>I.BACKUP_REMINDER_DAYS&&yn()}function ms(){const t=document.getElementById("closeBackupWarningBtn"),e=document.getElementById("exportNowBtn"),n=document.getElementById("remindLaterBtn"),o=document.getElementById("dontShowBackupWarning");t&&t.addEventListener("click",pe),e&&e.addEventListener("click",async()=>{pe(),await qn(),zn()}),n&&n.addEventListener("click",()=>{o?.checked&&localStorage.setItem(I.STORAGE_BACKUP_WARNING,"true"),pe()})}const Jn=5*60*1e3;let xt=null;function fs(){g.shouldShowExportReminder(Jn)&&ps()}function ps(){g.dismissExportReminder(),w("You have unsaved changes. Consider exporting to JSON.","warning")}function gs(){xt!==null&&clearInterval(xt),xt=setInterval(fs,Jn)}function hs(){xt!==null&&(clearInterval(xt),xt=null)}function ys(){hs();for(const t of ut.values())clearTimeout(t);ut.clear(),Mo()}window.addEventListener("beforeunload",ys);const vs=60*1e3;let Ut=null,Qn=0;function bs(){return!Ut||g.needsHealthCheckRefresh()?!1:Date.now()-Qn<vs}function Fe(){const t=document.getElementById("healthCheckSummary"),e=document.getElementById("healthCheckResults");if(bs()){et("healthCheckModal"),vn(Ut);return}t&&(t.innerHTML=""),e&&(e.innerHTML=`
      <div class="health-check-loading">
        <div class="loading-spinner"></div>
        <p>Running health checks...</p>
      </div>
    `),et("healthCheckModal"),setTimeout(async()=>{const n=g.getFunds(),o=g.getGroups(),a=await Io(),s=Qa(n,o,a);Ut=s,Qn=Date.now(),g.markHealthCheckRun(),vn(s)},50)}function vn(t){const e=document.getElementById("healthCheckSummary"),n=document.getElementById("healthCheckResults");if(!e||!n)return;const o=t.duplicates.length;e.innerHTML=`
    <div class="health-check-stat">
      <div class="health-check-stat-value">${t.totalFunds}</div>
      <div class="health-check-stat-label">Total Funds</div>
    </div>
    <div class="health-check-stat">
      <div class="health-check-stat-value ${t.fundsWithIssues>0?"warning-count":"success-count"}">${t.fundsWithIssues}</div>
      <div class="health-check-stat-label">With Issues</div>
    </div>
    <div class="health-check-stat">
      <div class="health-check-stat-value ${o>0?"warning-count":"success-count"}">${o}</div>
      <div class="health-check-stat-label">Duplicates</div>
    </div>
    <div class="health-check-stat">
      <div class="health-check-stat-value error-count">${t.errorCount}</div>
      <div class="health-check-stat-label">Errors</div>
    </div>
    <div class="health-check-stat">
      <div class="health-check-stat-value warning-count">${t.warningCount}</div>
      <div class="health-check-stat-label">Warnings</div>
    </div>
    <div class="health-check-stat">
      <div class="health-check-stat-value info-count">${t.infoCount}</div>
      <div class="health-check-stat-label">Info</div>
    </div>
  `;let a="",s=!1;t.groupIssues.length>0&&(a+='<div class="health-check-section-header">Group Issues</div>',a+=t.groupIssues.map(r=>ws(r)).join(""),s=!0),t.duplicates.length>0&&(a+='<div class="health-check-section-header">Potential Duplicates</div>',a+=t.duplicates.map(r=>Ss(r)).join(""),s=!0),t.issues.length>0&&(s&&(a+='<div class="health-check-section-header">Data Issues</div>'),a+=t.issues.map(r=>Is(r)).join(""),s=!0),s||(a=`
      <div class="health-check-empty">
        All funds and groups passed health checks!
      </div>
    `),n.innerHTML=a}function Is(t){const n=t.severity==="warning"||t.severity==="info"?`<button class="btn-dismiss-issue btn-dismiss-fund-issue" data-fund-id="${X(String(t.fundId))}" data-category="${X(t.category)}" data-message="${X(t.message)}" title="Dismiss this issue">Dismiss</button>`:"";return`
    <div class="health-issue" data-fund-id="${X(String(t.fundId))}">
      <span class="health-issue-severity ${Zn(t.severity)}">${Xn(t.severity)}</span>
      <div class="health-issue-content">
        <div class="health-issue-fund">${T(t.fundName)}</div>
        <div class="health-issue-message">${T(t.message)}</div>
        <div class="health-issue-category">${T(t.category)}</div>
      </div>
      ${n}
    </div>
  `}function Ss(t){return`
    <div class="duplicate-pair">
      <span class="duplicate-confidence ${ns(t.confidence)}">${t.confidence}</span>
      <div class="duplicate-content">
        <div class="duplicate-funds">
          <span class="duplicate-fund-link" data-fund-id="${X(String(t.fund1Id))}">${T(t.fund1Name)}</span>
          <span class="duplicate-separator">&harr;</span>
          <span class="duplicate-fund-link" data-fund-id="${X(String(t.fund2Id))}">${T(t.fund2Name)}</span>
        </div>
        <div class="duplicate-reason">${T(t.reason)}</div>
      </div>
      <button class="btn-dismiss-issue" data-fund1-id="${X(String(t.fund1Id))}" data-fund2-id="${X(String(t.fund2Id))}" data-reason="${X(t.reason)}" title="Dismiss this issue">Dismiss</button>
    </div>
  `}function ws(t){return`
    <div class="health-issue group-issue">
      <span class="health-issue-severity ${Zn(t.severity)}">${Xn(t.severity)}</span>
      <div class="health-issue-content">
        <div class="health-issue-fund">Group: ${T(t.groupName)}</div>
        <div class="health-issue-message">${T(t.message)}</div>
      </div>
    </div>
  `}function Es(){const t=document.getElementById("closeHealthCheckModalBtn"),e=document.getElementById("closeHealthCheckModal2Btn");t&&t.addEventListener("click",()=>O("healthCheckModal")),e&&e.addEventListener("click",()=>O("healthCheckModal"));const n=document.getElementById("healthCheckResults");n&&n.addEventListener("click",async o=>{const a=o.target,s=a.closest(".btn-dismiss-issue:not(.btn-dismiss-fund-issue)");if(s){o.stopPropagation();const l=parseInt(s.getAttribute("data-fund1-id")||"0",10),u=parseInt(s.getAttribute("data-fund2-id")||"0",10),m=s.getAttribute("data-reason")||"";if(l>0&&u>0)try{await So(l,u,m),Ut=null,g.markHealthCheckRun(),g.invalidateHealthCheck(),Fe()}catch(f){console.error("Error dismissing health issue:",f)}return}const r=a.closest(".btn-dismiss-fund-issue");if(r){o.stopPropagation();const l=parseInt(r.getAttribute("data-fund-id")||"0",10),u=r.getAttribute("data-category")||"",m=r.getAttribute("data-message")||"";if(l>0&&u&&m)try{await wo(l,u,m),Ut=null,g.invalidateHealthCheck(),Fe()}catch(f){console.error("Error dismissing fund issue:",f)}return}const i=a.closest(".health-issue");if(i){const l=parseInt(i.getAttribute("data-fund-id")||"0",10);l>0&&(O("healthCheckModal"),Ee(l));return}const c=a.closest(".duplicate-fund-link");if(c){const l=parseInt(c.getAttribute("data-fund-id")||"0",10);l>0&&(O("healthCheckModal"),Ee(l))}})}let Be=!1,Te=!1;function Cs(t,e){const n=Re(localStorage.getItem(I.STORAGE_COLUMN_WIDTHS)||"{}");n[t]=e,localStorage.setItem(I.STORAGE_COLUMN_WIDTHS,JSON.stringify(n))}function Ns(){const t=document.getElementById("fundsTable");if(!t)return;const e=Re(localStorage.getItem(I.STORAGE_COLUMN_WIDTHS)||"{}");t.querySelectorAll("thead th").forEach((o,a)=>{const s=e[a];s&&(o.style.width=s+"px",o.style.minWidth=s+"px",o.style.maxWidth=s+"px")})}function Fs(){const t=document.getElementById("fundsTable");if(!t)return;const e=t.querySelectorAll("thead th");e.forEach(n=>{if(n.querySelector(".resizer")||!n.getAttribute("data-sort"))return;const o=document.createElement("span");o.className="resizer",n.appendChild(o),n.style.position="relative",o.addEventListener("mousedown",a=>{a.preventDefault(),a.stopPropagation();const s=a.pageX,r=n.offsetWidth,i=Array.from(e).indexOf(n),c=t.querySelectorAll(`tbody tr td:nth-child(${i+1})`);Be=!0,Te=!0,n.classList.add("resizing"),document.body.style.cursor="col-resize",document.body.style.userSelect="none";let l=r,u=null,m=s;const f=p=>{m=p.pageX,u===null&&(u=requestAnimationFrame(()=>{const h=m-s;l=Math.max(I.MIN_COLUMN_WIDTH,r+h),n.style.width=l+"px",n.style.minWidth=l+"px",n.style.maxWidth=l+"px",c.forEach(v=>{v.style.width=l+"px",v.style.minWidth=l+"px",v.style.maxWidth=l+"px"}),u=null}))},d=()=>{u!==null&&(cancelAnimationFrame(u),u=null),n.classList.remove("resizing"),document.body.style.cursor="",document.body.style.userSelect="",document.removeEventListener("mousemove",f),document.removeEventListener("mouseup",d),window.removeEventListener("blur",d),l!==r&&Cs(i,l),requestAnimationFrame(()=>{requestAnimationFrame(()=>{Be=!1,Te=!1})})};document.addEventListener("mousemove",f),document.addEventListener("mouseup",d),window.addEventListener("blur",d)})}),Ns()}function to(t,e){let n;return function(...a){const s=()=>{clearTimeout(n),t(...a)};clearTimeout(n),n=setTimeout(s,e)}}function eo(t){let e=null,n=null;return function(...a){n=a,e===null&&(e=requestAnimationFrame(()=>{n&&t(...n),e=null}))}}function bn(t){const e=document.getElementById("filterLoading");e&&e.classList.toggle("show",t)}function ge(t,e){let n=document.getElementById("tablePaginationContainer");if(!n){const o=document.querySelector(".table-container");o&&(n=document.createElement("div"),n.id="tablePaginationContainer",n.className="table-pagination",o.after(n))}if(n){if(t>=e){n.innerHTML="",n.style.display="none";return}n.style.display="flex",n.innerHTML=`
    <div class="pagination-info">
      Showing <strong>${t}</strong> of <strong>${e}</strong> investments
    </div>
    <button type="button" class="btn-secondary load-more-btn" data-action="load-more">
      Load More
    </button>
  `}}async function _(){const t=document.getElementById("fundsTableBody"),e=setTimeout(()=>{t&&(t.innerHTML=`
        <tr class="table-loading-row">
          <td colspan="12">
            <div class="table-loading-content">
              <div class="table-loading-spinner"></div>
              <div class="table-loading-text">Loading investments...</div>
            </div>
          </td>
        </tr>
      `)},I.TABLE_LOADING_DELAY);try{const n=await H();g.setFunds(n);const a=document.getElementById("cutoffDate")?.value||"",s=a?new Date(a+"T00:00:00"):void 0,r=On(),i=g.getFilteredFundsFromCache(r,a);let c;if(i){const S=new Map(n.map(E=>[E.id,E]));c=i.map(E=>S.get(E)).filter(E=>E!==void 0)}else{c=Me(n);const S=c.map(E=>E.id).filter(E=>E!==void 0);g.setFilteredFundsCache(r,a,S)}g.sortColumns.length>0&&(c=Gn(c,g.sortColumns,s)),zo(n),Ko();let l;if(c.length>=100&&Go())try{const S=await Ao(c,s),E=new Map(S.map(C=>[C.fundId,C.metrics]));l=c.map(C=>({...C,metrics:E.get(C.id)||ot(C,s)}))}catch(S){console.warn("Worker calculation failed, falling back to sync:",S),l=c.map(E=>({...E,metrics:ot(E,s)}))}else l=c.map(S=>({...S,metrics:ot(S,s)}));if($o(l,s),clearTimeout(e),!t)return;if(t.innerHTML="",l.length===0){const S=Ho(),E=n.length>0;let C;S&&E?C=`
          <tr>
            <td colspan="12" class="empty-state">
              <div style="padding: 40px;">
                <h3 style="margin-bottom: 10px;">No matching investments</h3>
                <p style="margin-bottom: 15px;">No investments match your current filters.</p>
                <button type="button" class="btn-secondary" id="clearFiltersBtn">Clear All Filters</button>
              </div>
            </td>
          </tr>
        `:C=`
          <tr>
            <td colspan="12" class="empty-state">
              <div style="padding: 40px;">
                <h3 style="margin-bottom: 10px;">No investments yet</h3>
                <p style="margin-bottom: 15px;">Add your first investment to start tracking your portfolio.</p>
                <button type="button" class="btn-primary" id="addFirstInvestmentBtn">Add Investment</button>
              </div>
            </td>
          </tr>
        `,t.innerHTML=C;const N=document.getElementById("clearFiltersBtn");N&&N.addEventListener("click",()=>{Ge(),$e()});const y=document.getElementById("addFirstInvestmentBtn");y&&y.addEventListener("click",ne);return}const m=document.getElementById("sidebarShowTagsCheckbox")?.checked??!0,f=localStorage.getItem(I.STORAGE_GROUP_BY_FUND)==="true",d=localStorage.getItem(I.STORAGE_GROUP_BY_GROUP)==="true",p=Ln(l,s),h=l.length,v=g.displayLimit;if(d){const S=localStorage.getItem(I.STORAGE_EXPANDED_GROUPS)||"[]";let E;try{const L=JSON.parse(S);E=new Set(L)}catch{E=new Set}const C=l.map(L=>L.id).filter(L=>L!==void 0),N=g.getGroupTreeFromCache(C,E);let y;N?y=N:(y=Uo(l,s,E),g.setGroupTreeCache(C,E,y));const B=_o(y),k=document.createDocumentFragment();B.forEach((L,j)=>{const q=document.createElement("tr");q.classList.add("grouped-group-row"),q.classList.add(`depth-${Math.min(L.depth,2)}`),L.groupId===null&&q.classList.add("no-group"),q.setAttribute("tabindex","0"),q.setAttribute("role","row"),q.setAttribute("aria-rowindex",(j+2).toString()),L.groupId!==null&&q.setAttribute("data-group-id",L.groupId.toString()),q.innerHTML=Yo(L,j),k.appendChild(q)});const P=document.createElement("tr");P.innerHTML=me(p),k.appendChild(P),t.appendChild(k),ge(B.length,B.length)}else if(f){const S=Rn(l,s,g.sortColumns),E=S.slice(0,v),C=document.createDocumentFragment();E.forEach((y,B)=>{const k=document.createElement("tr");k.classList.add("grouped-fund-row"),k.setAttribute("tabindex","0"),k.setAttribute("role","row"),k.setAttribute("aria-rowindex",(B+2).toString()),k.innerHTML=Po(y,B,m),C.appendChild(k)});const N=document.createElement("tr");N.innerHTML=me(p),C.appendChild(N),t.appendChild(C),ge(E.length,S.length)}else{const S=l.slice(0,v),E=document.createDocumentFragment();S.forEach((N,y)=>{const B=document.createElement("tr");B.setAttribute("tabindex","0"),B.setAttribute("data-fund-id",N.id?.toString()||""),B.setAttribute("role","row"),B.setAttribute("aria-rowindex",(y+2).toString()),B.innerHTML=Ro(N,y,m),E.appendChild(B)});const C=document.createElement("tr");C.innerHTML=me(p),E.appendChild(C),t.appendChild(E),ge(S.length,h)}}catch(n){clearTimeout(e),console.error("Error rendering table:",n),w("Error loading data: "+n.message,"error")}}async function $e(){g.abortController&&g.abortController.abort(),g.resetDisplayLimit(),g.setAbortController(new AbortController);const t=g.abortController.signal;bn(!0);try{if(t.aborted||(Bs(),t.aborted))return;await _();const e=document.getElementById("summaryInvestmentCount")?.textContent||"0";xa(`Filter applied. Showing ${e} investments.`)}catch(e){if(e.name==="AbortError")return;console.error("Error applying filters:",e),w("Error applying filters: "+e.message,"error")}finally{bn(!1),g.abortController&&!g.abortController.signal.aborted&&g.setAbortController(null)}}const te=to($e,I.DEBOUNCE_FILTER),In=to(Vn,I.DEBOUNCE_INPUT);function Bs(){const t=U("groupFilter"),e=document.getElementById("headerTitle"),n=document.getElementById("headerSubtitle");if(!(!e||!n))if(t.length===1&&t[0]){const o=parseInt(t[0]),a=g.getGroupByIdSync(o);if(a)if(e.textContent=a.name,a.parentGroupId){const s=g.getGroupByIdSync(a.parentGroupId);n.textContent=s?.name||a.type||"Account Group"}else n.textContent=""}else if(t.length>1){const o=t.map(s=>g.getGroupByIdSync(parseInt(s))),a=new Set(o.map(s=>s?.parentGroupId).filter(s=>s!=null));if(a.size===1){const s=Array.from(a)[0],r=g.getGroupByIdSync(s);r?(e.textContent=r.name,n.textContent="Multiple Groups Selected"):(e.textContent="PE Fund Manager",n.textContent="Multiple Groups Selected")}else e.textContent="PE Fund Manager",n.textContent="Multiple Groups Selected"}else e.textContent="PE Fund Manager",n.textContent="Private Equity Fund Analytics & Management Tool"}async function Ts(t){const e=t.target;if(Te||Be||e.closest(".resizer"))return;const n=e.closest("th[data-sort]");if(!n)return;const o=n.dataset.sort;if(!o)return;if(t.shiftKey){const s=g.sortColumns.findIndex(r=>r.column===o);if(s!==-1)if(g.sortColumns[s].direction==="asc"){const i=[...g.sortColumns];i[s]={column:o,direction:"desc"},g.setSortColumns(i)}else{const i=g.sortColumns.filter((c,l)=>l!==s);g.setSortColumns(i)}else g.setSortColumns([...g.sortColumns,{column:o,direction:"asc"}])}else{const s=g.sortColumns.find(r=>r.column===o);s?s.direction==="asc"?g.setSortColumns([{column:o,direction:"desc"}]):g.setSortColumns([]):g.setSortColumns([{column:o,direction:"asc"}])}Oo(g.sortColumns),await _()}function Ds(t){const n=t.target.closest(".btn-expand");if(!n)return;t.stopPropagation();const o=n.dataset.groupId;if(!o)return;const a=localStorage.getItem(I.STORAGE_EXPANDED_GROUPS)||"[]";let s;try{s=JSON.parse(a)}catch{s=[]}const r=parseInt(o),i=s.findIndex(c=>c===r||c===o);i>=0?s.splice(i,1):s.push(r),localStorage.setItem(I.STORAGE_EXPANDED_GROUPS,JSON.stringify(s)),_()}function xs(t){const e=t.target;if(e.closest(".btn-expand")){Ds(t);return}const o=e.closest(".table-action-btn");if(!o)return;t.stopPropagation();const a=o.dataset.action;if(a==="edit-fund"){const s=o.dataset.fundName;s&&jn(s);return}if(a==="edit-group"){const s=o.dataset.groupId;s&&(ce(),setTimeout(()=>{const r=g.getGroupByIdSync(parseInt(s));if(r){const i=document.getElementById("editGroupId"),c=document.getElementById("newGroupName"),l=document.getElementById("saveGroupBtn"),u=document.getElementById("cancelEditBtn"),m=document.getElementById("groupFormTitle");if(i&&c&&l&&u&&m){i.value=s,c.value=r.name,l.textContent="Save Changes",u.classList.remove("hidden"),m.textContent="Edit Group";const f=document.getElementById("newGroupParent");f&&r.parentGroupId&&(f.value=r.parentGroupId.toString());const d=document.getElementById("newGroupType");d&&r.type&&(d.value=r.type)}}},100));return}if(a==="menu"){const s=parseInt(o.dataset.fundId||"0");if(!s)return;pa(s);const r=document.getElementById("actionDropdown");if(!r)return;const i=o.getBoundingClientRect();r.style.visibility="hidden",r.classList.add("show");const c=r.offsetWidth||160,l=r.offsetHeight||200;r.classList.remove("show"),r.style.visibility="";let u=i.bottom+2,m=i.left-(c-i.width);u+l>window.innerHeight&&(u=i.top-l-2),m<8&&(m=8),m+c>window.innerWidth-8&&(m=window.innerWidth-c-8),r.style.position="fixed",r.style.top=`${u}px`,r.style.left=`${m}px`,r.classList.add("show")}}function ks(){const t=document.getElementById("sidebar"),e=document.getElementById("sidebarOverlay");t&&t.classList.add("show"),e&&e.classList.add("show")}function Z(){const t=document.getElementById("sidebar"),e=document.getElementById("sidebarOverlay");t&&t.classList.remove("show"),e&&e.classList.remove("show")}function As(){const t=document.getElementById("sidebarDarkModeCheckbox");if(!t)return;const e=localStorage.getItem("theme"),n=window.matchMedia("(prefers-color-scheme: dark)").matches,o=e?e==="dark":n;document.documentElement.setAttribute("data-theme",o?"dark":"light"),t.checked=o,t.addEventListener("change",()=>{const a=t.checked?"dark":"light";document.documentElement.setAttribute("data-theme",a),localStorage.setItem("theme",a)})}function Ms(){const t=new Date,e=t.getFullYear(),n=[new Date(e,2,31),new Date(e,5,30),new Date(e,8,30),new Date(e,11,31)];for(let o=n.length-1;o>=0;o--)if(n[o]<=t)return n[o];return new Date(e-1,11,31)}function Gs(){const t=document.getElementById("cutoffDate");if(!t)return;const e=Ms(),n=e.getFullYear(),o=String(e.getMonth()+1).padStart(2,"0"),a=String(e.getDate()).padStart(2,"0");t.value=`${n}-${o}-${a}`}function no(t=!1){document.querySelectorAll(".multi-select.open").forEach(e=>{e.classList.remove("open"),e.querySelector(".multi-select-trigger")?.setAttribute("aria-expanded","false"),be(e),t&&Ot(e);const n=e.id;if(n){const o=ut.get(n);o&&(clearTimeout(o),ut.delete(n))}})}function Ls(){document.querySelectorAll(".multi-select").forEach(e=>{if(e.dataset.initialized==="true")return;e.dataset.initialized="true";const n=e.querySelector(".multi-select-trigger"),o=e.querySelector(".multi-select-dropdown");if(!n||!o)return;n.addEventListener("click",s=>{s.stopPropagation();const r=e.classList.contains("open");no(),r||(e.classList.add("open"),n.setAttribute("aria-expanded","true"),setTimeout(()=>{const i=o.querySelector(".multi-select-search input");i&&i.focus()},0))}),n.addEventListener("keydown",s=>{const r=s;r.key==="Enter"||r.key===" "?(r.preventDefault(),n.click()):r.key==="Escape"&&(e.classList.remove("open"),n.setAttribute("aria-expanded","false"),be(e))}),o.addEventListener("input",s=>{const r=s.target;if(r.matches(".multi-select-search input")){const i=e.id||"unknown",c=ut.get(i);c&&clearTimeout(c);const l=r.value,u=setTimeout(()=>{ke(e,l),Ot(e),Ae(e),ut.delete(i)},150);ut.set(i,u)}}),o.addEventListener("keydown",s=>{const r=s;if(r.key==="Escape"){e.classList.remove("open"),n.setAttribute("aria-expanded","false"),be(e),Ot(e),n.focus();return}if(r.key==="ArrowDown"||r.key==="ArrowUp"){r.preventDefault(),Ps(e,r.key==="ArrowDown"?1:-1);return}if(r.key==="Enter"){r.preventDefault();const i=e.querySelector(".multi-select-option.highlighted");i&&!i.classList.contains("search-hidden")&&wn(e,i,te);return}}),o.addEventListener("click",s=>{const r=s.target;if(r.closest(".multi-select-search")){s.stopPropagation();return}const i=r.closest(".multi-select-option");if(i){if(s.stopPropagation(),i.classList.contains("multi-select-all-option")){if(jo(e),e.id==="groupFilter"){const c=e.querySelectorAll(".multi-select-option.selected:not(.multi-select-all-option)"),l=Array.from(c).map(u=>parseInt(u.getAttribute("data-value")||"0")).filter(u=>u>0);l.length>0&&Xo(e,l,!0)}te();return}wn(e,i,te)}});const a=eo(s=>{const r=s.closest(".multi-select-option");r&&!r.classList.contains("search-hidden")&&(Ot(e),r.classList.add("highlighted"))});o.addEventListener("mouseover",s=>{a(s.target)})})}function Rs(){document.querySelectorAll(".searchable-select").forEach(e=>{if(e.dataset.initialized==="true")return;e.dataset.initialized="true";const n=e.querySelector(".searchable-select-trigger"),o=e.querySelector(".searchable-select-dropdown"),a=e.querySelector('input[type="hidden"]');if(!n||!o||!a)return;n.addEventListener("click",r=>{r.stopPropagation();const i=e.classList.contains("open");document.querySelectorAll(".searchable-select.open").forEach(c=>{c.classList.remove("open"),c.querySelector(".searchable-select-trigger")?.setAttribute("aria-expanded","false");const l=c.querySelector(".searchable-select-search input");l&&(l.value=""),oe(c,"")}),i||(e.classList.add("open"),n.setAttribute("aria-expanded","true"),setTimeout(()=>{const c=o.querySelector(".searchable-select-search input");c&&c.focus()},0))}),n.addEventListener("keydown",r=>{const i=r;i.key==="Enter"||i.key===" "?(i.preventDefault(),n.click()):i.key==="Escape"&&(e.classList.remove("open"),n.setAttribute("aria-expanded","false"))}),o.addEventListener("input",r=>{const i=r.target;if(i.matches(".searchable-select-search input")){const c=e.id||"searchable-unknown",l=ut.get(c);l&&clearTimeout(l);const u=i.value,m=setTimeout(()=>{oe(e,u),$t(e),ut.delete(c)},150);ut.set(c,m)}}),o.addEventListener("keydown",r=>{const i=r;if(i.key==="Escape"){e.classList.remove("open"),n.setAttribute("aria-expanded","false"),$t(e),n.focus();return}if(i.key==="ArrowDown"||i.key==="ArrowUp"){i.preventDefault(),Os(e,i.key==="ArrowDown"?1:-1);return}if(i.key==="Enter"){i.preventDefault();const c=e.querySelector(".searchable-select-option.highlighted");c&&!c.classList.contains("search-hidden")&&Sn(e,c,a,n);return}}),o.addEventListener("click",r=>{const i=r.target;if(i.closest(".searchable-select-search")){r.stopPropagation();return}const c=i.closest(".searchable-select-option");c&&(r.stopPropagation(),Sn(e,c,a,n))});const s=eo(r=>{const i=r.closest(".searchable-select-option");i&&!i.classList.contains("search-hidden")&&($t(e),i.classList.add("highlighted"))});o.addEventListener("mouseover",r=>{s(r.target)})})}function $s(){document.addEventListener("click",t=>{const e=t.target;e.closest(".multi-select")||no(!0),e.closest(".searchable-select")||document.querySelectorAll(".searchable-select.open").forEach(o=>{o.classList.remove("open"),o.querySelector(".searchable-select-trigger")?.setAttribute("aria-expanded","false");const a=o.querySelector(".searchable-select-search input");a&&(a.value=""),oe(o,"")});const n=document.getElementById("actionDropdown");n&&!e.closest("#actionDropdown")&&!e.closest(".fund-actions-btn")&&n.classList.remove("show")})}function oe(t,e){const n=t.querySelector(".searchable-select-options"),o=t.querySelector(".searchable-select-no-results");if(!n)return;const a=n.querySelectorAll(".searchable-select-option"),s=e.toLowerCase().trim();let r=0;a.forEach(i=>{const c=i.textContent?.toLowerCase()||"";s===""||c.includes(s)?(i.classList.remove("search-hidden"),r++):i.classList.add("search-hidden")}),o&&o.classList.toggle("visible",r===0&&s!=="")}function $t(t){t.querySelectorAll(".searchable-select-option.highlighted").forEach(e=>{e.classList.remove("highlighted")})}function Os(t,e){const n=Array.from(t.querySelectorAll(".searchable-select-option:not(.search-hidden)"));if(n.length===0)return;const o=t.querySelector(".searchable-select-option.highlighted");let a=o?n.indexOf(o):-1;$t(t);let s=a+e;s<0&&(s=n.length-1),s>=n.length&&(s=0);const r=n[s];r&&(r.classList.add("highlighted"),r.scrollIntoView({block:"nearest"}))}function Sn(t,e,n,o){const a=e.dataset.value||"";n.value=a,n.dispatchEvent(new Event("change",{bubbles:!0}));const s=t.querySelector(".searchable-select-display");s&&(s.textContent=e.textContent?.trim()||t.getAttribute("data-placeholder")||"Select..."),t.querySelectorAll(".searchable-select-option").forEach(i=>{i.classList.remove("selected")}),e.classList.add("selected"),t.classList.remove("open"),o.setAttribute("aria-expanded","false");const r=t.querySelector(".searchable-select-search input");r&&(r.value=""),oe(t,""),$t(t)}function Ot(t){t.querySelectorAll(".multi-select-option.highlighted").forEach(e=>{e.classList.remove("highlighted")})}function Ps(t,e){const n=Array.from(t.querySelectorAll(".multi-select-option:not(.search-hidden)"));if(n.length===0)return;const o=t.querySelector(".multi-select-option.highlighted");let a=o?n.indexOf(o):-1;Ot(t);let s=a+e;s<0&&(s=n.length-1),s>=n.length&&(s=0);const r=n[s];r&&(r.classList.add("highlighted"),r.scrollIntoView({block:"nearest"}))}function wn(t,e,n){e.classList.toggle("selected");const o=e.querySelector('input[type="checkbox"]');if(o&&(o.checked=e.classList.contains("selected")),e.setAttribute("aria-selected",e.classList.contains("selected").toString()),t.id==="groupFilter"){const a=parseInt(e.getAttribute("data-value")||"0"),s=e.classList.contains("selected");Zo(t,a,s)}Ae(t),se(t.id),n()}function Us(){const t=document.querySelector("#fundsTable thead");t&&t.addEventListener("click",Ts);const e=document.getElementById("fundsTableBody");e&&e.addEventListener("click",xs),document.addEventListener("click",async b=>{b.target.dataset.action==="load-more"&&(g.loadMore(),await _())});const n=document.getElementById("actionEdit"),o=document.getElementById("actionDuplicate"),a=document.getElementById("actionViewDetails"),s=document.getElementById("actionDelete");n&&n.addEventListener("click",b=>{b.preventDefault();const D=Jt();D&&ia(D),document.getElementById("actionDropdown")?.classList.remove("show")}),o&&o.addEventListener("click",b=>{b.preventDefault();const D=Jt();D&&ca(D),document.getElementById("actionDropdown")?.classList.remove("show")}),a&&a.addEventListener("click",b=>{b.preventDefault();const D=Jt();D&&Ee(D),document.getElementById("actionDropdown")?.classList.remove("show")}),s&&s.addEventListener("click",async b=>{b.preventDefault();const D=Jt();D&&await ua(D,_),document.getElementById("actionDropdown")?.classList.remove("show")});const r=document.getElementById("fundForm");r&&r.addEventListener("submit",async b=>{b.preventDefault(),await la(_)});const i=document.getElementById("closeFundModalBtn"),c=document.getElementById("cancelFundModalBtn");[i,c].forEach(b=>{b&&b.addEventListener("click",()=>na())});const l=document.getElementById("fundName");l&&l.addEventListener("change",b=>{const D=b.target.value,M=document.getElementById("newFundNameContainer");D==="__new__"&&M?(M.classList.remove("hidden"),document.getElementById("newFundNameInline")?.focus()):M&&M.classList.add("hidden")});const u=document.getElementById("addCashFlowRowBtn"),m=document.getElementById("addNavRowBtn"),f=document.getElementById("saveDetailsChangesBtn"),d=document.getElementById("cancelDetailsModalBtn"),p=document.getElementById("closeDetailsModalBtn");u&&u.addEventListener("click",da),m&&m.addEventListener("click",ma),f&&f.addEventListener("click",()=>fa(_)),[d,p].forEach(b=>{b&&b.addEventListener("click",async()=>{g.hasUnsavedChanges&&!await It("You have unsaved changes. Discard them?",{title:"Unsaved Changes",confirmText:"Discard",cancelText:"Keep Editing"})||(g.setUnsavedChanges(!1),O("detailsModal"))})});const h=document.getElementById("cashFlowsTable"),v=document.getElementById("navTable");[h,v].forEach(b=>{b&&(b.addEventListener("click",D=>{const J=D.target.closest(".delete-row-btn");if(J){const Y=J.closest("tr");Y&&(Y.remove(),g.setUnsavedChanges(!0),Vn())}}),b.addEventListener("input",()=>{g.setUnsavedChanges(!0),In()}),b.addEventListener("change",()=>{g.setUnsavedChanges(!0),In()}))});const S=document.getElementById("sidebarManageFunds");S&&S.addEventListener("click",b=>{b.preventDefault(),Z(),Ht()});const E=document.getElementById("closeManageFundsModalBtn"),C=document.getElementById("closeManageFundsModal2Btn");[E,C].forEach(b=>{b&&b.addEventListener("click",()=>O("manageFundNamesModal"))});const N=document.getElementById("addNewFundNameModalBtn");N&&N.addEventListener("click",()=>Na(_));const y=document.getElementById("fundNamesList");y&&y.addEventListener("click",async b=>{const M=b.target.closest("button");if(!M)return;const J=M.dataset.action,Y=M.dataset.name;J==="editFundName"&&Y?jn(Y):J==="deleteFundName"&&Y&&await Ca(Y,_)});const B=document.getElementById("closeEditFundNameModalBtn"),k=document.getElementById("cancelEditFundNameBtn");[B,k].forEach(b=>{b&&b.addEventListener("click",()=>{Hn(),O("editFundNameModal")})});const P=document.getElementById("saveEditedFundNameBtn");P&&P.addEventListener("click",()=>Ea(_));const L=document.getElementById("editFundTagsInput");L&&L.addEventListener("keydown",b=>{if(b.key==="Enter"){b.preventDefault();const D=L.value.trim();D&&(Sa(D),L.value="")}});const j=document.getElementById("editFundTagsContainer");j&&j.addEventListener("click",b=>{const D=b.target;if(D.classList.contains("tag-remove")){const M=parseInt(D.dataset.index||"0");wa(M)}});const q=document.getElementById("addNewFundNameBtn");q&&q.addEventListener("click",Fa);const lt=document.getElementById("cancelNewFundNameBtn");lt&&lt.addEventListener("click",Ba);const pt=document.getElementById("sidebarManageGroups");pt&&pt.addEventListener("click",b=>{b.preventDefault(),Z(),ce()});const kt=document.getElementById("closeManageGroupsModalBtn"),Oe=document.getElementById("closeManageGroupsModal2Btn");[kt,Oe].forEach(b=>{b&&b.addEventListener("click",()=>O("manageGroupsModal"))});const jt=document.getElementById("saveGroupBtn");jt&&jt.addEventListener("click",()=>ga(_));const qt=document.getElementById("groupsList");qt&&qt.addEventListener("click",async b=>{const M=b.target.closest("button");if(!M)return;const J=M.dataset.action,Y=parseInt(M.dataset.id||"0");if(J==="editGroup"&&!isNaN(Y)){const vt=g.getGroupByIdSync(Y);if(vt){const Xt=document.getElementById("editGroupId"),en=document.getElementById("newGroupName"),nn=document.getElementById("newGroupType"),on=document.getElementById("saveGroupBtn"),an=document.getElementById("cancelEditBtn"),sn=document.getElementById("groupFormTitle");Xt&&(Xt.value=Y.toString()),en&&(en.value=vt.name),nn&&(nn.value=vt.type||""),on&&(on.textContent="Update Group"),an&&an.classList.remove("hidden"),sn&&(sn.textContent="Edit Group"),Et("newGroupParent",Y),ie("newGroupParent",vt.parentGroupId?.toString()||"")}}else J==="deleteGroup"&&!isNaN(Y)&&await ha(Y,_)});const ht=document.getElementById("cancelEditBtn");ht&&ht.addEventListener("click",()=>{const b=document.getElementById("editGroupId"),D=document.getElementById("newGroupName"),M=document.getElementById("newGroupType"),J=document.getElementById("saveGroupBtn"),Y=document.getElementById("groupFormTitle");b&&(b.value=""),D&&(D.value=""),M&&(M.value=""),J&&(J.textContent="Add Group"),Y&&(Y.textContent="Add New Group"),ht.classList.add("hidden"),Et("newGroupParent")});const le=document.getElementById("toggleSidebarBtn"),Kt=document.getElementById("closeSidebarBtn"),Zt=document.getElementById("sidebarOverlay");le&&le.addEventListener("click",ks),Kt&&Kt.addEventListener("click",Z),Zt&&Zt.addEventListener("click",Z);const F=document.getElementById("sidebarNewInvestment");F&&F.addEventListener("click",b=>{b.preventDefault(),Z(),ne()});const G=document.getElementById("sidebarShowTagsCheckbox");if(G){G.addEventListener("change",async()=>{const D=G.checked;localStorage.setItem("showTags",D.toString()),await _()});const b=localStorage.getItem("showTags");b!==null&&(G.checked=b==="true")}const R=document.getElementById("groupByFundToggle");R&&(localStorage.getItem(I.STORAGE_GROUP_BY_FUND)==="true"&&R.classList.add("active"),R.addEventListener("click",async()=>{const M=!(localStorage.getItem(I.STORAGE_GROUP_BY_FUND)==="true");if(R.classList.toggle("active",M),localStorage.setItem(I.STORAGE_GROUP_BY_FUND,M.toString()),M){localStorage.setItem(I.STORAGE_GROUP_BY_GROUP,"false");const J=document.getElementById("sidebarGroupByGroupCheckbox");J&&(J.checked=!1)}await _()}));const tt=document.getElementById("sidebarMaskAccountsCheckbox");if(tt){tt.addEventListener("change",()=>{const D=tt.checked;localStorage.setItem(I.STORAGE_MASK_ACCOUNTS,D.toString()),document.documentElement.setAttribute("data-mask-accounts",D.toString())});const b=localStorage.getItem(I.STORAGE_MASK_ACCOUNTS);if(b!==null){const D=b==="true";tt.checked=D,document.documentElement.setAttribute("data-mask-accounts",D.toString())}}const rt=document.getElementById("sidebarGroupByGroupCheckbox");if(rt){rt.addEventListener("change",async()=>{const D=rt.checked;if(localStorage.setItem(I.STORAGE_GROUP_BY_GROUP,D.toString()),D){localStorage.setItem(I.STORAGE_GROUP_BY_FUND,"false");const M=document.getElementById("groupByFundToggle");M&&M.classList.remove("active")}await _()});const b=localStorage.getItem(I.STORAGE_GROUP_BY_GROUP);b!==null&&(rt.checked=b==="true")}const yt=document.getElementById("sidebarClearDatabase");yt&&yt.addEventListener("click",async b=>{if(b.preventDefault(),Z(),await It("Are you sure you want to clear ALL data? This action cannot be undone!",{title:"Clear Database",confirmText:"Clear All Data",cancelText:"Cancel"}))try{z("Clearing database..."),await vo(),g.clearMetricsCache(),g.setFunds([]),g.setGroups([]),w("Database cleared successfully"),await _()}catch(M){console.error("Error clearing database:",M),w("Error clearing database: "+M.message,"error")}finally{V()}});const it=document.getElementById("sidebarExportCSV");it&&it.addEventListener("click",async b=>{b.preventDefault(),Z(),await Ta()});const Pe=document.getElementById("sidebarExportJSON");Pe&&Pe.addEventListener("click",async b=>{b.preventDefault(),Z(),await qn(),zn()});const Ue=document.getElementById("sidebarExportPDF");Ue&&Ue.addEventListener("click",b=>{b.preventDefault(),Z(),Da()});const _e=document.getElementById("sidebarImportJSON");_e&&_e.addEventListener("click",b=>{b.preventDefault(),Z(),Aa()});const Ye=document.getElementById("sidebarLoadSampleData");Ye&&Ye.addEventListener("click",async b=>{b.preventDefault(),Z(),await It("This will add sample data to your database. Existing data will not be deleted. Continue?",{title:"Load Sample Data",confirmText:"Load Data",cancelText:"Cancel"})&&await La(_)});const We=document.getElementById("sidebarHealthCheck");We&&We.addEventListener("click",b=>{b.preventDefault(),Z(),Fe()});const Ve=document.getElementById("sidebarSyncAccountGroups");Ve&&Ve.addEventListener("click",b=>{b.preventDefault(),Z(),va()});const He=document.getElementById("sidebarBulkCashFlow");He&&He.addEventListener("click",b=>{b.preventDefault(),Z(),$a()});const je=document.getElementById("sidebarBulkAssignGroup");je&&je.addEventListener("click",b=>{b.preventDefault(),Z(),Wa()});const qe=document.getElementById("sidebarBulkRemoveFund");qe&&qe.addEventListener("click",b=>{b.preventDefault(),Z(),Ua()}),ja(_);const Ke=document.getElementById("importPreviewFileInput");Ke&&Ke.addEventListener("change",Ma);const Ze=document.getElementById("applyImportBtn");Ze&&Ze.addEventListener("click",()=>Ga(_));const oo=document.getElementById("closeImportPreviewModalBtn"),ao=document.getElementById("cancelImportPreviewBtn");[oo,ao].forEach(b=>{b&&b.addEventListener("click",()=>O("importPreviewModal"))});const so=document.getElementById("closeSyncAccountGroupsModalBtn"),ro=document.getElementById("cancelSyncAccountGroupsBtn");[so,ro].forEach(b=>{b&&b.addEventListener("click",()=>{Ce(),O("syncAccountGroupsModal")})});const Xe=document.getElementById("applySyncAccountGroupsBtn");Xe&&Xe.addEventListener("click",()=>ba(_));const ze=document.getElementById("cutoffDate");ze&&ze.addEventListener("change",te);const Je=document.getElementById("activeFiltersIndicator");Je&&Je.addEventListener("click",b=>{b.target.classList.contains("clear-filters")&&(Ge(),$e())});const Qe=document.getElementById("timelineHeader"),tn=document.getElementById("timelinePanel");Qe&&tn&&Qe.addEventListener("click",()=>{tn.classList.toggle("expanded")&&Ja()});const ue=document.getElementById("timelineTableContainer");ue&&ue.addEventListener("click",b=>{const M=b.target.closest(".timeline-expand-row");if(!M)return;const J=M.dataset.type,Y=M.classList.toggle("expanded"),vt=M.querySelector(".timeline-expand-icon");vt&&(vt.textContent=Y?"▼":"▶"),ue.querySelectorAll(`.timeline-fund-row[data-type="${J}"]`).forEach(Xt=>{Xt.classList.toggle("visible",Y)})}),document.addEventListener("keydown",b=>{const D=b.target;D.tagName==="INPUT"||D.tagName==="TEXTAREA"||D.tagName==="SELECT"||(b.ctrlKey&&b.key==="n"?(b.preventDefault(),ne()):b.key==="?"&&!b.ctrlKey&&!b.metaKey?et("shortcutsModal"):b.key==="Escape"&&(Z(),document.querySelectorAll(".modal.show").forEach(M=>{O(M.id)})))});const io=document.getElementById("closeShortcutsModalBtn"),co=document.getElementById("closeShortcutsModal2Btn");[io,co].forEach(b=>{b&&b.addEventListener("click",()=>O("shortcutsModal"))})}async function En(){try{z("Initializing..."),await go(),An()&&ko().catch(a=>{console.warn("Failed to initialize metrics worker, will use sync calculations:",a)});const t=await H();g.setFunds(t);const e=await dt();g.setGroups(e);const n=await _t(),o=new Map;n.forEach(a=>o.set(a.name,a)),g.setFundNameData(o),g.setFundNames(new Set(n.map(a=>a.name))),As(),Gs(),Ls(),Rs(),$s(),Us(),ms(),Es(),Fs(),sa(),ea(),await _(),V(),setTimeout(()=>{ds()},1e3),gs()}catch(t){console.error("Error initializing application:",t),V(),w("Error initializing application: "+t.message,"error")}}window.showAddFundModal=ne;window.showManageFundsModal=Ht;window.resetFilters=Ge;document.readyState==="loading"?document.addEventListener("DOMContentLoaded",En):En();</script>
  <style rel="stylesheet" crossorigin>:root{--color-primary: #2C3E50;--color-primary-light: #34495E;--color-background: #ECF0F1;--color-white: #ffffff;--color-action: #3498DB;--color-action-hover: #2980B9;--color-success: #27AE60;--color-success-hover: #229954;--color-danger: #E74C3C;--color-danger-hover: #C0392B;--color-warning: #F39C12;--color-warning-bg: #FEF9E7;--color-secondary: #95A5A6;--color-secondary-hover: #7F8C8D;--color-text: #2C3E50;--color-text-light: #95A5A6;--color-muted: #95A5A6;--color-border: #E0E0E0;--color-border-input: #BDC3C7;--color-hover-bg: #F8F9FA;--color-alt-bg: #FAFAFA;--spacing-xs: 4px;--spacing-sm: 8px;--spacing-md: 12px;--spacing-lg: 20px;--spacing-xl: 30px;--radius-sm: 3px;--radius-md: 4px;--shadow-sm: 0 1px 3px rgba(0, 0, 0, .1);--shadow-md: 0 2px 8px rgba(0, 0, 0, .15);--shadow-lg: 0 4px 12px rgba(0, 0, 0, .15);--transition-fast: all .15s ease;--transition-medium: all .2s ease}[data-theme=dark]{--color-primary: #F0F0F0;--color-primary-light: #2D3748;--color-background: #1A202C;--color-white: #2D3748;--color-action: #63B3ED;--color-action-hover: #4299E1;--color-success: #68D391;--color-success-hover: #48BB78;--color-danger: #FC8181;--color-danger-hover: #F56565;--color-warning: #F6E05E;--color-warning-bg: #744210;--color-secondary: #A0AEC0;--color-secondary-hover: #CBD5E0;--color-text: #F7FAFC;--color-text-light: #CBD5E0;--color-muted: #A0AEC0;--color-border: #4A5568;--color-border-input: #4A5568;--color-hover-bg: #374151;--color-alt-bg: #1F2937;--shadow-sm: 0 1px 3px rgba(0, 0, 0, .3);--shadow-md: 0 2px 8px rgba(0, 0, 0, .4);--shadow-lg: 0 4px 12px rgba(0, 0, 0, .5)}[data-theme=dark] header{background:#1f2937;border-bottom-color:#374151;color:#e2e8f0}[data-theme=dark] header h1{color:#f7fafc}[data-theme=dark] thead{background:#374151}[data-theme=dark] thead th{color:#f7fafc}[data-theme=dark] th:hover{background:#4a5568}[data-theme=dark] td{border-bottom-color:#374151}[data-theme=dark] tbody tr:last-child{border-color:#4a5568;background:#1f2937}[data-theme=dark] .modal-content{background:#2d3748;color:var(--color-text)}[data-theme=dark] .sidebar{background:#2d3748}[data-theme=dark] .sidebar-header{background:#1f2937;border-bottom-color:#4a5568}[data-theme=dark] .status-message{background:#2d3748}[data-theme=dark] .table-tag{background:#374151;color:#e2e8f0}[data-theme=dark] .tag{background:#4299e1}[data-theme=dark] input:disabled,[data-theme=dark] textarea:disabled,[data-theme=dark] select:disabled{background:#1f2937}[data-theme=dark] input,[data-theme=dark] textarea,[data-theme=dark] select,[data-theme=dark] select option,[data-theme=dark] .form-group input,[data-theme=dark] .form-group textarea,[data-theme=dark] .form-group select{background:#2d3748!important;color:#f7fafc!important}[data-theme=dark] input::placeholder,[data-theme=dark] textarea::placeholder{color:#a0aec0}[data-theme=dark] .details-table th{background-color:#374151;border-bottom-color:#4a5568}[data-theme=dark] .details-table tbody tr:nth-child(2n){background-color:#1f2937}[data-theme=dark] .details-table input,[data-theme=dark] .details-table select{background:transparent!important}[data-theme=dark] .details-table input:hover,[data-theme=dark] .details-table select:hover{border-bottom-color:#4a5568}[data-theme=dark] .details-table input:focus,[data-theme=dark] .details-table select:focus{border-bottom-color:var(--color-action)}[data-theme=dark] .group-item,[data-theme=dark] .fund-name-item{background:#1f2937;border-color:#4a5568;color:#f7fafc}[data-theme=dark] .action-dropdown{background:#2d3748;border-color:#4a5568}[data-theme=dark] .action-dropdown a:hover{background:#374151}[data-theme=dark] .action-dropdown a.danger-action:hover{background:#742a2a}[data-theme=dark] .loading-content{background:#2d3748}[data-theme=dark] .multi-select-trigger{background:#2d3748;border-color:#4a5568;color:#f7fafc}[data-theme=dark] .multi-select-dropdown{background:#2d3748;border-color:#4a5568}[data-theme=dark] .multi-select-option:hover,[data-theme=dark] .multi-select-option.highlighted{background:#3b5068}[data-theme=dark] .multi-select-option.selected{background:#63b3ed33}[data-theme=dark] .multi-select-actions{background:#1f2937;border-top-color:#4a5568}[data-theme=dark] .multi-select-option.group-top-level{background:#374151}[data-theme=dark] .multi-select-option.group-separator{border-top-color:#4a5568}[data-theme=dark] .multi-select-option.group-child{border-left-color:#63b3ed}[data-theme=dark] .multi-select-search{background:var(--color-bg);border-bottom-color:#4a5568}[data-theme=dark] .multi-select-search input{background:#374151;border-color:#4a5568;color:var(--color-text)}[data-theme=dark] .multi-select-search input:focus{border-color:var(--color-action)}[data-theme=dark] .multi-select-all-option{border-bottom-color:#4a5568}.portfolio-summary{display:flex;flex-wrap:wrap;gap:16px;padding:16px 20px;background:var(--color-alt-bg);border:1px solid var(--color-border);border-radius:var(--radius-md);margin-bottom:20px}.summary-stat{display:flex;flex-direction:column;min-width:100px;padding:8px 16px;background:var(--color-white);border-radius:var(--radius-sm);border:1px solid var(--color-border)}.summary-label{font-size:11px;font-weight:600;text-transform:uppercase;color:var(--color-text-light);letter-spacing:.5px;margin-bottom:4px}.summary-value{font-size:18px;font-weight:600;color:var(--color-text);font-variant-numeric:tabular-nums}.summary-value.positive{color:var(--color-success)}.summary-value.negative{color:var(--color-danger)}#detailsSummary{gap:10px}#detailsSummary .summary-value{font-size:13px}#detailsSummary .summary-label{font-size:9px}#detailsSummary .summary-stat{min-width:70px;padding:8px 10px}.summary-label-container{display:flex;align-items:center;gap:4px}.info-icon{display:inline-flex;align-items:center;justify-content:center;width:14px;height:14px;border-radius:50%;background:var(--color-text-light);color:var(--color-white);font-size:9px;font-weight:700;cursor:help;position:relative;flex-shrink:0}.info-icon:hover{background:var(--color-action)}.info-icon .tooltip{display:none;position:absolute;bottom:calc(100% + 8px);left:50%;transform:translate(-50%);background:var(--color-primary);color:#fff;padding:8px 12px;border-radius:var(--radius-md);font-size:12px;font-weight:400;white-space:normal;width:220px;text-align:left;z-index:1000;box-shadow:var(--shadow-md);line-height:1.4}.info-icon .tooltip:after{content:"";position:absolute;top:100%;left:50%;transform:translate(-50%);border:6px solid transparent;border-top-color:var(--color-primary)}.info-icon:hover .tooltip{display:block}[data-theme=dark] .info-icon{background:var(--color-text-light);color:var(--color-background)}[data-theme=dark] .info-icon .tooltip{background:#4a5568}[data-theme=dark] .info-icon .tooltip:after{border-top-color:#4a5568}.timeline-panel{background:var(--color-white);border:1px solid var(--color-border);border-radius:var(--radius-md);margin-bottom:20px;overflow:hidden}.timeline-header{display:flex;justify-content:space-between;align-items:center;padding:12px 16px;background:var(--color-alt-bg);border-bottom:1px solid var(--color-border);cursor:pointer;user-select:none}.timeline-header:hover{background:var(--color-hover-bg)}.timeline-header h3{margin:0;font-size:14px;font-weight:600;color:var(--color-text);display:flex;align-items:center;gap:8px}.timeline-toggle{font-size:12px;color:var(--color-text-light);transition:transform .2s ease}.timeline-panel.expanded .timeline-toggle{transform:rotate(180deg)}.timeline-content{display:none;padding:16px;overflow-x:auto}.timeline-panel.expanded .timeline-content{display:block}.timeline-table{width:100%;border-collapse:collapse;font-size:13px;min-width:600px}.timeline-table th,.timeline-table td{padding:8px 12px;text-align:right;border:1px solid var(--color-border);white-space:nowrap}.timeline-table th:not(:first-child),.timeline-table td:not(:first-child){min-width:90px;width:90px}.timeline-table th{background:var(--color-alt-bg);font-weight:600;color:var(--color-text)}.timeline-table th:first-child,.timeline-table td:first-child{text-align:left;position:sticky;left:0;background:var(--color-white);z-index:1}.timeline-table th:first-child{background:var(--color-alt-bg)}.timeline-table .year-projected{background:var(--color-alt-bg);font-style:italic}.timeline-table .year-projected th{background:#e8f4fd}[data-theme=dark] .timeline-table .year-projected th{background:#2c4a5e}.timeline-table .year-estimated{background:var(--color-warning-bg);font-style:italic}.timeline-table .year-estimated th{background:var(--color-warning-bg)}.timeline-estimated-indicator{display:inline-block;font-size:10px;color:var(--color-warning);margin-left:4px;vertical-align:super;cursor:help}.timeline-table .row-calls td{color:var(--color-danger)}.timeline-table .row-distributions td,.timeline-table .row-net td.positive{color:var(--color-success)}.timeline-table .row-net td.negative{color:var(--color-danger)}.timeline-table .row-net{font-weight:600;border-top:2px solid var(--color-border)}.timeline-table .row-label{font-weight:500;color:var(--color-text)}.timeline-table td:first-child{font-weight:500}.timeline-divider{border-left:3px solid var(--color-action)!important}.timeline-expand-row{cursor:pointer}.timeline-expand-row:hover{background:var(--color-hover-bg)}.timeline-expand-icon{display:inline-block;width:16px;font-size:10px;color:var(--color-text-light)}.timeline-fund-row{display:none}.timeline-fund-row.visible{display:table-row}.timeline-fund-row td{background:var(--color-alt-bg);font-size:12px}.timeline-fund-row td:first-child{padding-left:28px;background:var(--color-alt-bg)}.timeline-no-data{text-align:center;padding:30px;color:var(--color-text-light);font-style:italic}@media (max-width: 768px){.timeline-table{font-size:11px}.timeline-table th,.timeline-table td{padding:6px 8px}}.shortcuts-modal .modal-content{max-width:500px}.shortcuts-list{display:grid;grid-template-columns:auto 1fr;gap:12px 20px;margin-top:16px}.shortcut-key{display:inline-flex;align-items:center;gap:4px}.shortcut-key kbd{display:inline-block;padding:4px 8px;font-family:monospace;font-size:12px;background:var(--color-alt-bg);border:1px solid var(--color-border);border-radius:var(--radius-sm);box-shadow:0 1px 2px #0000001a}.shortcut-desc{color:var(--color-text);font-size:14px}.health-check-modal .modal-content{max-width:700px;max-height:80vh;display:flex;flex-direction:column}.health-check-summary{display:flex;gap:16px;flex-wrap:wrap;padding:16px;background:var(--color-alt-bg);border-radius:var(--radius-sm);margin-bottom:16px}.health-check-stat{text-align:center;padding:8px 16px;min-width:80px}.health-check-stat-value{font-size:24px;font-weight:600}.health-check-stat-label{font-size:12px;color:var(--color-secondary-hover);text-transform:uppercase}.health-check-stat-value.error-count{color:var(--color-danger)}.health-check-stat-value.warning-count{color:var(--color-warning)}.health-check-stat-value.info-count{color:var(--color-action)}.health-check-stat-value.success-count{color:var(--color-success)}.health-check-results{flex:1;overflow-y:auto;max-height:400px}.health-check-empty{text-align:center;padding:40px;color:var(--color-success);font-size:16px}.health-check-loading{display:flex;flex-direction:column;align-items:center;justify-content:center;padding:40px;gap:16px;color:var(--color-text-light)}.health-check-loading .loading-spinner{width:32px;height:32px}.health-issue{display:flex;align-items:flex-start;gap:12px;padding:12px;border-bottom:1px solid var(--color-border)}.health-issue:last-child{border-bottom:none}.health-issue:hover{background:var(--color-hover-bg)}.health-issue-severity{padding:4px 8px;border-radius:var(--radius-sm);font-size:11px;font-weight:600;text-transform:uppercase;flex-shrink:0}.severity-error{background:#e74c3c26;color:var(--color-danger)}.severity-warning{background:#f1c40f26;color:var(--color-warning)}.severity-info{background:#3498db26;color:var(--color-action)}.health-issue-content{flex:1}.health-issue-fund{font-weight:600;color:var(--color-primary);margin-bottom:4px}.health-issue-message{font-size:14px;color:var(--color-text)}.health-issue-category{font-size:12px;color:var(--color-secondary-hover);margin-top:4px}.health-check-section-header{font-size:13px;font-weight:600;text-transform:uppercase;color:var(--color-secondary-hover);padding:12px 12px 8px;border-bottom:1px solid var(--color-border);background:var(--color-alt-bg)}.duplicate-pair{display:flex;align-items:flex-start;gap:12px;padding:12px;border-bottom:1px solid var(--color-border)}.duplicate-pair:last-child{border-bottom:none}.duplicate-pair:hover{background:var(--color-hover-bg)}.duplicate-confidence{padding:4px 8px;border-radius:var(--radius-sm);font-size:11px;font-weight:600;text-transform:uppercase;flex-shrink:0}.confidence-high{background:#e74c3c26;color:var(--color-danger)}.confidence-medium{background:#f1c40f26;color:var(--color-warning)}.confidence-low{background:#3498db26;color:var(--color-action)}.duplicate-content{flex:1}.duplicate-funds{display:flex;align-items:center;gap:8px;flex-wrap:wrap;margin-bottom:4px}.duplicate-fund-link{font-weight:600;color:var(--color-action);cursor:pointer}.duplicate-fund-link:hover{text-decoration:underline}.duplicate-separator{color:var(--color-secondary-hover)}.duplicate-reason{font-size:14px;color:var(--color-text)}.btn-dismiss-issue{padding:4px 10px;font-size:12px;background:transparent;border:1px solid var(--color-border);border-radius:var(--radius-sm);color:var(--color-text-light);cursor:pointer;flex-shrink:0;align-self:center;transition:all .15s ease}.btn-dismiss-issue:hover{background:var(--color-hover-bg);border-color:var(--color-secondary-hover);color:var(--color-text)}@media (max-width: 768px){.portfolio-summary{gap:8px;padding:12px}.summary-stat{min-width:80px;padding:6px 10px}.summary-label{font-size:10px}.summary-value{font-size:14px}}*{box-sizing:border-box;margin:0;padding:0}body{font-family:-apple-system,BlinkMacSystemFont,Segoe UI,Roboto,Oxygen,Ubuntu,Cantarell,sans-serif;background:var(--color-background);min-height:100vh;padding:var(--spacing-lg)}.container{max-width:1800px;margin:0 auto;background:var(--color-white);border-radius:var(--radius-md);box-shadow:var(--shadow-sm);overflow:hidden}header{background:var(--color-primary);color:var(--color-white);padding:24px var(--spacing-xl);border-bottom:1px solid var(--color-primary-light)}header h1{font-size:1.75em;font-weight:600;margin-bottom:4px;letter-spacing:-.5px}header p{font-size:.95em;opacity:.85;font-weight:400}.controls-bar{background:var(--color-alt-bg);padding:var(--spacing-lg) var(--spacing-xl);display:flex;gap:16px;flex-wrap:wrap;align-items:flex-end;border-bottom:1px solid var(--color-border)}.control-group{display:flex;flex-direction:column;gap:6px}.control-group label{font-weight:500;font-size:.85em;color:var(--color-text)}.control-group select,.control-group input[type=date],.control-group input[type=text]{padding:var(--spacing-sm) var(--spacing-md);border:1px solid var(--color-border-input);border-radius:var(--radius-sm);font-size:14px;min-width:150px;background:var(--color-white);color:var(--color-text)}.control-group select:focus,.control-group input[type=date]:focus,.control-group input[type=text]:focus{outline:none;border-color:var(--color-action);box-shadow:0 0 0 2px #3498db1a}.filter-badge{display:none;align-items:center;gap:6px;background:var(--color-action);color:#fff;font-size:11px;font-weight:600;padding:3px 8px;border-radius:12px;margin-left:8px}.filter-badge.show{display:inline-flex;white-space:nowrap}.filter-badge .clear-filters{display:inline-flex;align-items:center;justify-content:center;width:14px;height:14px;border-radius:50%;background:#ffffff4d;color:#fff;font-size:10px;cursor:pointer;border:none;padding:0;line-height:1}.filter-badge .clear-filters:hover{background:#ffffff80}.multi-select{position:relative;min-width:150px}.multi-select-trigger{display:flex;align-items:center;justify-content:space-between;padding:var(--spacing-sm) var(--spacing-md);border:1px solid var(--color-border-input);border-radius:var(--radius-sm);font-size:14px;background:var(--color-white);color:var(--color-text);cursor:pointer;min-height:36px;gap:8px}.multi-select-trigger:hover{border-color:var(--color-action)}.multi-select.open .multi-select-trigger{border-color:var(--color-action);box-shadow:0 0 0 2px #3498db1a}.multi-select-display{flex:1;overflow:hidden;text-overflow:ellipsis;white-space:nowrap}.multi-select-display .placeholder{color:var(--color-muted)}.multi-select-count{background:var(--color-action);color:#fff;font-size:11px;font-weight:600;padding:2px 6px;border-radius:10px;flex-shrink:0}.multi-select-arrow{flex-shrink:0;transition:transform .2s ease}.multi-select.open .multi-select-arrow{transform:rotate(180deg)}.multi-select-dropdown{position:absolute;top:100%;left:0;min-width:220px;margin-top:4px;background:var(--color-white);border:1px solid var(--color-border);border-radius:var(--radius-sm);box-shadow:var(--shadow-lg);z-index:1000;display:none}.multi-select.open .multi-select-dropdown{display:block}.multi-select-option{display:flex;align-items:center;gap:8px;padding:8px 12px;cursor:pointer;transition:background .15s ease}.multi-select-option:hover,.multi-select-option.highlighted{background:#e8f4fc;outline:none}.multi-select-option.selected{background:#3498db1a}.multi-select-option input[type=checkbox]{margin:0;cursor:pointer}.multi-select-option label{flex:1;cursor:pointer;font-size:14px;white-space:nowrap}.multi-select-option.group-option{padding-left:calc(12px + var(--indent-level, 0) * 16px)}.multi-select-option.group-top-level{background:var(--color-alt-bg);font-weight:600}.multi-select-option.group-top-level label{font-weight:600}.multi-select-option.group-separator{margin-top:6px;border-top:1px solid var(--color-border);padding-top:10px}.multi-select-option.group-child{border-left:3px solid var(--color-primary-light, #85c1e9);margin-left:8px;padding-left:calc(12px + var(--indent-level, 0) * 16px - 11px)}.multi-select-actions{display:flex;gap:8px;padding:8px 12px;border-top:1px solid var(--color-border);background:var(--color-alt-bg)}.multi-select-actions button{flex:1;padding:4px 8px;font-size:12px}.multi-select-search{padding:8px;border-bottom:1px solid var(--color-border);position:sticky;top:0;background:var(--color-white);z-index:1}.multi-select-search input{width:100%;padding:6px 10px;border:1px solid var(--color-border-input);border-radius:var(--radius-sm);font-size:13px;background:var(--color-white);color:var(--color-text)}.multi-select-all-option{border-bottom:1px solid var(--color-border);font-weight:500}.multi-select-all-option label{font-weight:500}.multi-select-search input:focus{outline:none;border-color:var(--color-action);box-shadow:0 0 0 2px #3498db1a}.multi-select-search input::placeholder{color:var(--color-muted)}.multi-select-options{max-height:350px;overflow-y:auto}.multi-select-option.search-hidden{display:none}.multi-select-no-results{padding:12px;text-align:center;color:var(--color-muted);font-size:13px;display:none}.multi-select-no-results.visible{display:block}.searchable-select{position:relative}.searchable-select-trigger{display:flex;align-items:center;justify-content:space-between;padding:var(--spacing-sm) var(--spacing-md);border:1px solid var(--color-border-input);border-radius:var(--radius-sm);font-size:14px;background:var(--color-white);color:var(--color-text);cursor:pointer;min-height:36px;gap:8px}.searchable-select-trigger:hover{border-color:var(--color-action)}.searchable-select.open .searchable-select-trigger{border-color:var(--color-action);box-shadow:0 0 0 2px #3498db1a}.searchable-select-display{flex:1;overflow:hidden;text-overflow:ellipsis;white-space:nowrap}.searchable-select-arrow{flex-shrink:0;width:0;height:0;border-left:5px solid transparent;border-right:5px solid transparent;border-top:5px solid var(--color-text-light);transition:transform .2s ease}.searchable-select.open .searchable-select-arrow{transform:rotate(180deg)}.searchable-select-dropdown{position:absolute;top:100%;left:0;right:0;min-width:200px;margin-top:4px;background:var(--color-white);border:1px solid var(--color-border);border-radius:var(--radius-sm);box-shadow:var(--shadow-lg);z-index:1000;display:none}.searchable-select.open .searchable-select-dropdown{display:block}.searchable-select-search{padding:8px;background:var(--color-bg);border-bottom:1px solid var(--color-border)}.searchable-select-search input{width:100%;padding:6px 10px;border:1px solid var(--color-border-input);border-radius:var(--radius-sm);font-size:13px;background:var(--color-white);color:var(--color-text)}.searchable-select-search input:focus{outline:none;border-color:var(--color-action);box-shadow:0 0 0 2px #3498db1a}.searchable-select-options{max-height:250px;overflow-y:auto}.searchable-select-option{display:flex;align-items:center;padding:8px 12px;cursor:pointer;font-size:14px;color:var(--color-text)}.searchable-select-option:hover{background:var(--color-hover-bg)}.searchable-select-option.selected{background:#3498db1a;font-weight:500}.searchable-select-option.highlighted{background:#e8f4fc;outline:none}.searchable-select-option.search-hidden{display:none}.searchable-select-option[data-indent="1"]{padding-left:28px}.searchable-select-option[data-indent="2"]{padding-left:44px}.searchable-select-option[data-indent="3"]{padding-left:60px}.searchable-select-no-results{padding:12px;text-align:center;color:var(--color-muted);font-size:13px;display:none}.searchable-select-no-results.visible{display:block}[data-theme=dark] .searchable-select-trigger{background:#2d3748;border-color:#4a5568;color:#f7fafc}[data-theme=dark] .searchable-select-dropdown{background:#2d3748;border-color:#4a5568}[data-theme=dark] .searchable-select-option:hover{background:#374151}[data-theme=dark] .searchable-select-option.selected{background:#63b3ed33}[data-theme=dark] .searchable-select-option.highlighted{background:#3b5068}[data-theme=dark] .searchable-select-search{background:var(--color-bg);border-bottom-color:#4a5568}[data-theme=dark] .searchable-select-search input{background:#374151;border-color:#4a5568;color:var(--color-text)}button{padding:9px 18px;border:none;border-radius:var(--radius-sm);font-size:14px;font-weight:500;cursor:pointer;transition:var(--transition-fast)}.controls-bar button{margin-top:auto}.btn-primary{background:var(--color-action);color:var(--color-white)}.btn-primary:hover{background:var(--color-action-hover)}.btn-secondary{background:var(--color-secondary);color:var(--color-white)}.btn-secondary:hover{background:var(--color-secondary-hover)}.btn-success{background:var(--color-success);color:var(--color-white)}.btn-success:hover{background:var(--color-success-hover)}.btn-danger{background:var(--color-danger);color:var(--color-white)}.btn-danger:hover{background:var(--color-danger-hover)}.btn-link{background:none;border:none;color:var(--color-action);cursor:pointer;padding:2px 4px;font-size:inherit;text-decoration:underline}.btn-link:hover{color:var(--color-action-hover)}.btn-info{background:var(--color-primary-light);color:var(--color-white)}.btn-info:hover{background:var(--color-primary)}button:disabled{opacity:.5;cursor:not-allowed}button:focus-visible,a:focus-visible,input:focus-visible,select:focus-visible,textarea:focus-visible{outline:2px solid var(--color-action);outline-offset:2px}button:focus:not(:focus-visible),a:focus:not(:focus-visible),input:focus:not(:focus-visible),select:focus:not(:focus-visible){outline:none}.skip-link{position:absolute;top:-40px;left:0;background:var(--color-action);color:#fff;padding:8px;z-index:100000;transition:top .3s}.skip-link:focus{top:0}.sr-announce{position:absolute;left:-10000px;width:1px;height:1px;overflow:hidden}.filter-loading{display:none;align-items:center;gap:8px;padding:8px 12px;color:var(--color-text-light);font-size:13px}.filter-loading.show{display:flex}.filter-loading-spinner{width:16px;height:16px;border:2px solid var(--color-border);border-top-color:var(--color-action);border-radius:50%;animation:spin .8s linear infinite}@keyframes spin{to{transform:rotate(360deg)}}tbody tr:focus{outline:2px solid var(--color-action);outline-offset:-2px}tbody tr[tabindex]:hover{background:var(--color-hover-bg)}.btn-icon{background:none;border:none;color:var(--color-text-light);font-size:16px;padding:var(--spacing-xs) var(--spacing-sm);cursor:pointer;transition:var(--transition-fast)}.btn-icon:hover{color:var(--color-primary-light)}.action-dropdown{display:none;position:fixed;background:var(--color-white);border:1px solid var(--color-border);border-radius:var(--radius-md);box-shadow:var(--shadow-lg);min-width:160px;z-index:10000;padding:var(--spacing-xs) 0}.action-dropdown.show{display:block}.action-dropdown a{display:block;padding:10px 16px;color:var(--color-text);text-decoration:none;font-size:14px;transition:var(--transition-fast)}.action-dropdown a:hover{background:var(--color-hover-bg)}.action-dropdown a.danger-action{color:var(--color-danger)}.action-dropdown a.danger-action:hover{background:#ffebee}.dropdown{position:relative;display:inline-block}.dropdown-menu{display:none;position:absolute;top:100%;right:0;background:var(--color-white);border:1px solid var(--color-border);border-radius:var(--radius-sm);box-shadow:var(--shadow-md);min-width:160px;z-index:1000;margin-top:var(--spacing-xs)}.dropdown-menu.show{display:block}.dropdown-menu a{display:block;padding:10px 16px;color:var(--color-text);text-decoration:none;font-size:14px;transition:var(--transition-fast)}.dropdown-menu a:hover{background:var(--color-hover-bg)}.dropdown-menu a:first-child{border-radius:var(--radius-sm) var(--radius-sm) 0 0}.dropdown-menu a:last-child{border-radius:0 0 var(--radius-sm) var(--radius-sm)}.content{padding:var(--spacing-xl)}.table-container{overflow-x:auto;margin-bottom:var(--spacing-sm)}.table-pagination{display:flex;align-items:center;justify-content:center;gap:16px;padding:16px;background:var(--color-alt-bg);border:1px solid var(--color-border);border-top:none;border-radius:0 0 var(--radius-sm) var(--radius-sm);margin-bottom:var(--spacing-xl)}.pagination-info{color:var(--color-text-light);font-size:14px}.pagination-info strong{color:var(--color-text)}.load-more-btn{padding:8px 24px;font-size:14px}.table-container table,table{width:100%;border-collapse:collapse;background:var(--color-white);border:1px solid var(--color-border);border-radius:var(--radius-sm);overflow:hidden}.table-container table{width:100%;table-layout:auto}thead{background:var(--color-primary-light);color:var(--color-white);position:sticky;top:0;z-index:10}th{padding:14px var(--spacing-md);text-align:left;font-weight:500;cursor:pointer;user-select:none;white-space:nowrap;font-size:.9em}th:hover{background:var(--color-primary)}th.sorted-asc:after{content:" ↑";opacity:1}th.sorted-desc:after{content:" ↓";opacity:1}th.sorted-asc[data-sort-priority="1"]:after{content:" ↑¹"}th.sorted-asc[data-sort-priority="2"]:after{content:" ↑²"}th.sorted-asc[data-sort-priority="3"]:after{content:" ↑³"}th.sorted-asc[data-sort-priority="4"]:after{content:" ↑⁴"}th.sorted-asc[data-sort-priority="5"]:after{content:" ↑⁵"}th.sorted-desc[data-sort-priority="1"]:after{content:" ↓¹"}th.sorted-desc[data-sort-priority="2"]:after{content:" ↓²"}th.sorted-desc[data-sort-priority="3"]:after{content:" ↓³"}th.sorted-desc[data-sort-priority="4"]:after{content:" ↓⁴"}th.sorted-desc[data-sort-priority="5"]:after{content:" ↓⁵"}th.wrap-header{white-space:normal;line-height:1.3;padding:10px 8px}th{position:relative}th.resizable{overflow:hidden;text-overflow:ellipsis}th .resizer{position:absolute;top:0;right:-8px;width:16px;height:100%;cursor:col-resize;user-select:none;z-index:10}th .resizer:hover{background-color:var(--color-action);width:4px;right:0}th.resizing{user-select:none}#fundsTable th:nth-child(2),#fundsTable td:nth-child(2){max-width:200px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap}td{padding:12px;border-bottom:1px solid #F0F0F0;font-size:.9em;color:var(--color-primary)}tbody tr:hover{background:var(--color-hover-bg)}tbody tr:last-child{border-top:2px solid var(--color-primary-light);border-bottom:2px solid var(--color-primary-light);font-weight:600;background:var(--color-alt-bg)}tbody tr:last-child td{border-bottom:none}table.no-summary-row tbody tr:last-child{border-top:none;border-bottom:1px solid var(--color-border);font-weight:400;background:transparent}[data-theme=dark] table.no-summary-row tbody tr:last-child{border-color:var(--color-border);background:transparent}td.number{text-align:right;font-variant-numeric:tabular-nums}th.center,td.center{text-align:center}.positive{color:var(--color-success)}.negative{color:var(--color-danger)}.empty-state{text-align:center;padding:60px 20px;color:var(--color-text-light)}.action-buttons{display:flex;gap:5px;flex-wrap:nowrap}.btn-sm{padding:6px 12px;font-size:12px;min-width:auto;white-space:nowrap}.modal{display:none;position:fixed;z-index:1000;left:0;top:0;width:100%;height:100%;overflow-y:auto;background-color:#00000080}.modal.show{display:flex;align-items:flex-start;justify-content:center;padding:40px 20px}.modal-content{background-color:var(--color-white);padding:30px;border-radius:var(--radius-md);width:100%;max-width:700px;box-shadow:0 4px 12px #00000026;position:relative;margin:auto}.modal-content h2{margin-bottom:24px;color:var(--color-primary);font-size:1.5em;font-weight:600}.modal .btn-close{position:absolute;top:15px;right:20px;font-size:28px;font-weight:300;color:var(--color-text-light);cursor:pointer;line-height:1;width:30px;height:30px;display:flex;align-items:center;justify-content:center;border-radius:var(--radius-sm);transition:var(--transition-medium);background:none;border:none;padding:0}.modal .btn-close:hover{background:var(--color-border);color:var(--color-primary)}.modal .btn-close:focus{outline:2px solid var(--color-action);outline-offset:2px}.confirm-modal{z-index:2000}.confirm-modal-content{max-width:450px;text-align:center}.confirm-modal-content h2{margin-bottom:16px}.confirm-modal-message{color:var(--color-text);line-height:1.6;margin-bottom:8px;white-space:pre-wrap}.confirm-modal-content .form-actions{justify-content:center}.confirm-modal-content .form-actions button{flex:0 1 auto;min-width:100px}.form-group{margin-bottom:20px}.form-group label{display:block;margin-bottom:8px;font-weight:500;color:var(--color-primary);font-size:.9em}.form-group label.checkbox-label{display:inline-flex;align-items:center;gap:8px;cursor:pointer}.form-group label.checkbox-label input[type=checkbox]{width:auto;margin:0}.form-group input,.form-group select,.form-group textarea{width:100%;padding:10px 12px;border:1px solid var(--color-border-input);border-radius:var(--radius-sm);font-size:14px;transition:var(--transition-fast);background:var(--color-white)}.form-group input:focus,.form-group select:focus,.form-group textarea:focus{outline:none;border-color:var(--color-action);box-shadow:0 0 0 2px #3498db1a}.form-group.has-error input,.form-group.has-error select,.form-group.has-error textarea{border-color:var(--color-danger);background-color:#e74c3c0d}.form-group.has-error input:focus,.form-group.has-error select:focus,.form-group.has-error textarea:focus{border-color:var(--color-danger);box-shadow:0 0 0 2px #e74c3c1a}.form-group.has-error label{color:var(--color-danger)}.form-group .error-message{display:none;color:var(--color-danger);font-size:12px;margin-top:4px}.form-group.has-error .error-message{display:block}.form-group textarea{font-family:Courier New,monospace;resize:vertical;min-height:100px}.form-group .hint{font-size:12px;color:var(--color-secondary-hover);margin-top:5px}.tags-container{display:flex;flex-wrap:wrap;gap:6px;margin-bottom:8px;min-height:24px}.tag{display:inline-flex;align-items:center;background:var(--color-action);color:var(--color-white);padding:4px 10px;border-radius:12px;font-size:13px;font-weight:500;gap:6px}.tag-remove{cursor:pointer;font-weight:700;font-size:16px;line-height:1;opacity:.8}.tag-remove:hover{opacity:1}.table-tags{display:flex;flex-wrap:wrap;gap:4px}.table-tag{display:inline-block;background:#e8f4f8;color:var(--color-primary);padding:2px 8px;border-radius:10px;font-size:11px;font-weight:500;white-space:nowrap}.form-actions{display:flex;gap:10px;margin-top:25px}.form-actions button{flex:1}.modal-sm .modal-content{max-width:500px}.modal-md .modal-content{max-width:600px}.modal-lg .modal-content{max-width:700px}.modal-xl .modal-content{max-width:900px}.hidden{display:none!important}.btn-full{width:100%}.btn-compact{padding:8px 12px;white-space:nowrap}.btn-min-width{min-width:100px}.btn-file-input{cursor:pointer;display:inline-block;padding:9px 18px;min-width:100px;text-align:center}.btn-sm.mt-md{margin-top:10px}.ml-auto{margin-left:auto}.btn-icon-lg{font-size:20px}.text-muted{color:var(--color-text-light)}.text-sm{font-size:14px}.text-xs{font-size:12px}.text-danger{color:var(--color-danger)}.mb-sm{margin-bottom:10px}.mb-md{margin-bottom:15px}.mb-lg{margin-bottom:20px}.mt-md{margin-top:15px}.mt-lg{margin-top:20px}.p-md{padding:15px}.gap-sm{gap:8px}.gap-md{gap:10px}.d-flex{display:flex}.flex-1{flex:1}.section-title{margin-bottom:15px;color:var(--color-text);font-weight:600;font-size:1.1em}.section-title-sm{margin-bottom:15px;color:var(--color-text);font-weight:600;font-size:1em}.section-divider{margin:20px 0;border:none;border-top:1px solid var(--color-border)}.preview-container{display:none;margin:20px 0;padding:15px;background:var(--color-alt-bg);border-radius:var(--radius-sm);max-height:300px;overflow-y:auto}.preview-container.show{display:block}.preview-title{margin:0 0 10px;font-size:14px}.preview-title-danger{margin:0 0 10px;font-size:14px;color:var(--color-danger)}.import-preview-container{margin:20px 0;padding:15px;background:var(--color-alt-bg);border-radius:var(--radius-sm);max-height:400px;overflow-y:auto}.sync-content{margin:20px 0;max-height:400px;overflow-y:auto}.groups-list{max-height:400px;overflow-y:auto}.fund-terms-panel{padding:10px;background:var(--color-alt-bg);border-radius:var(--radius-sm);margin-top:10px}.fund-terms-toggle{cursor:pointer;color:var(--color-action);font-size:13px}.small-hint{color:var(--color-text-light);font-size:.85em;margin-top:4px;display:block}.modal-subtitle{margin:5px 0 0;color:var(--color-text-light);font-size:.9em}.modal-description{color:var(--color-text-light);margin-bottom:20px;font-size:14px}.section-title-bordered{margin:20px 0 15px;color:var(--color-text);font-weight:600;font-size:1em;border-top:1px solid var(--color-border);padding-top:20px}.timeline-label{font-weight:400;font-size:12px;color:var(--color-text-light)}.text-warning{color:var(--color-warning)}.backup-warning-text{line-height:1.6;margin-bottom:15px}.backup-warning-list{margin:15px 0 15px 25px;line-height:1.8}.backup-warning-cta{line-height:1.6;margin-bottom:20px;font-weight:600;color:var(--color-danger)}.toast-container{position:fixed;top:20px;right:20px;z-index:2000;display:flex;flex-direction:column;gap:10px;pointer-events:none}.status-message{position:relative;padding:14px 45px 14px 20px;border-radius:var(--radius-sm);background:var(--color-white);box-shadow:0 2px 8px #00000026;animation:slideIn .2s ease;max-width:400px;border-left:3px solid;pointer-events:auto}.status-message.success{border-left-color:var(--color-success)}.status-message.error{border-left-color:var(--color-danger)}.status-message.warning{border-left-color:#f39c12}.status-message .close-status{position:absolute;top:10px;right:12px;font-size:20px;font-weight:300;color:var(--color-text-light);cursor:pointer;line-height:1;background:none;border:none;padding:0}.status-message .close-status:hover{color:var(--color-primary)}@keyframes slideIn{0%{transform:translate(400px);opacity:0}to{transform:translate(0);opacity:1}}.loading-overlay{position:fixed;top:0;left:0;width:100%;height:100%;background:#00000080;display:none;justify-content:center;align-items:center;z-index:3000}.loading-overlay.show{display:flex}.loading-content{background:var(--color-white);padding:30px 40px;border-radius:5px;text-align:center;box-shadow:0 4px 12px #0000004d}.loading-spinner{border:4px solid #f3f3f3;border-top:4px solid var(--color-action);border-radius:50%;width:40px;height:40px;animation:spin 1s linear infinite;margin:0 auto 15px}@keyframes spin{0%{transform:rotate(0)}to{transform:rotate(360deg)}}.loading-text{color:var(--color-primary);font-size:16px;font-weight:500}input[type=file]{display:none}.file-input-label{display:inline-block;padding:9px 18px;background:var(--color-primary-light);color:var(--color-white);border-radius:var(--radius-sm);cursor:pointer;font-weight:500;transition:var(--transition-fast);font-size:14px}.file-input-label:hover{background:var(--color-primary)}input:disabled,textarea:disabled,select:disabled{opacity:.6;background:#f5f5f5;cursor:not-allowed}.details-table-wrapper{overflow-x:auto;margin-top:15px;border:1px solid var(--color-border);border-radius:var(--radius-sm);max-width:100%}.details-table{border-collapse:collapse;font-size:.85em}.details-table th{background-color:var(--color-primary-light);color:var(--color-white);padding:6px 8px;text-align:left;border:none;border-bottom:2px solid var(--color-primary);font-weight:500;font-size:.85em}.details-table td{padding:6px 8px;border:none}.details-table tbody tr:nth-child(2n){background-color:var(--color-alt-bg)}.details-table input,.details-table select{padding:6px 8px;background:transparent!important;border:none;border-bottom:1px solid transparent;border-radius:0;font-family:inherit;font-size:1em;box-sizing:border-box;transition:border-color .15s ease}.details-table input:hover,.details-table select:hover{border-bottom-color:var(--color-border-input)}.details-table input:focus,.details-table select:focus{border-bottom-color:var(--color-action);outline:none}.details-table input[type=number],.details-table input[type=text]{text-align:right;width:90px}.details-table input[type=date]{text-align:left;width:130px}.details-table select{text-align:left;width:115px}.details-table input[type=checkbox]{width:auto}#cashFlowsTable{width:100%}#cashFlowsTable th:nth-child(1),#cashFlowsTable td:nth-child(1){width:150px}#cashFlowsTable th:nth-child(2),#cashFlowsTable td:nth-child(2){width:140px}#cashFlowsTable th:nth-child(3),#cashFlowsTable td:nth-child(3){width:130px}#cashFlowsTable th:nth-child(4),#cashFlowsTable td:nth-child(4){width:160px;text-align:center}#cashFlowsTable th:nth-child(5),#cashFlowsTable td:nth-child(5){width:auto;text-align:right}#navTable{width:100%}#navTable th:nth-child(1),#navTable td:nth-child(1){width:150px}#navTable th:nth-child(2),#navTable td:nth-child(2){width:140px;text-align:right}#navTable th:nth-child(3),#navTable td:nth-child(3){width:auto;text-align:right}.delete-row-btn{background:none;border:none;color:var(--color-danger);font-size:18px;padding:4px 8px;cursor:pointer;transition:var(--transition-fast)}.delete-row-btn:hover{color:var(--color-danger-hover)}.validation-error-row{background-color:#ffebee!important;border-left:3px solid var(--color-danger)}.validation-error-row input{border-color:var(--color-danger)!important}#manageFundNamesModal .fund-name-item{display:flex;justify-content:space-between;align-items:center;padding:10px;margin-bottom:8px;background:var(--color-alt-bg);border:1px solid var(--color-border);border-radius:var(--radius-sm);gap:10px}#manageFundNamesModal .fund-name-item .btn-sm{margin-left:5px}.group-item{display:flex;justify-content:space-between;align-items:center;padding:8px 10px;margin-bottom:4px;background:var(--color-alt-bg);border:1px solid var(--color-border);border-radius:var(--radius-sm)}.group-item.level-0{margin-left:0;font-weight:600}.group-item.level-1{margin-left:20px;font-weight:500}.group-item.level-2{margin-left:40px}.group-item.level-3{margin-left:60px}.group-item-info{flex:1;display:flex;align-items:center;gap:10px}.group-item-type{font-size:.85em;color:var(--color-secondary-hover);font-style:italic}.group-item-actions{display:flex;gap:5px}@media (max-width: 1400px){.controls-bar{flex-direction:column;align-items:stretch}.control-group{width:100%}}@media (max-width: 768px){body{padding:var(--spacing-sm)}header{padding:16px var(--spacing-md)}header h1{font-size:1.4em}.controls-bar{padding:var(--spacing-md);gap:12px}.content{padding:var(--spacing-md)}.table-container{overflow-x:auto;-webkit-overflow-scrolling:touch}.modal-content{padding:20px;margin:20px;max-width:calc(100% - 40px)}.form-actions{flex-direction:column}.form-actions button{width:100%}.sidebar{width:280px;right:-280px}.btn-icon{font-size:18px!important;padding:6px}th,td{font-size:.85em;padding:8px 6px}}@media (max-width: 480px){header h1{font-size:1.2em}header p{font-size:.85em}.controls-bar{gap:8px}.modal-content{padding:15px}.modal-content h2{font-size:1.2em}th,td{font-size:.8em;padding:6px 4px}.table-container table{min-width:800px}}@media print{:root,[data-theme=dark]{--color-primary: #2C3E50;--color-primary-light: #34495E;--color-background: #ECF0F1;--color-white: #ffffff;--color-action: #3498DB;--color-success: #27AE60;--color-danger: #E74C3C;--color-text: #2C3E50;--color-text-light: #95A5A6;--color-muted: #95A5A6;--color-border: #E0E0E0;--color-hover-bg: #F8F9FA;--color-alt-bg: #FAFAFA}body{background:#fff!important;color:#2c3e50!important;padding:0}.container{box-shadow:none;border-radius:0}.controls-bar,.btn-sm,button{display:none!important}header{background:#fff!important;color:#2c3e50!important;border-bottom:2px solid #2C3E50!important;padding:15px}header h1{color:#2c3e50!important}header p{color:#95a5a6!important}.content{padding:10px}table{width:100%;max-width:100%;page-break-inside:auto;border:1px solid var(--color-primary);table-layout:fixed}.table-container table{min-width:100%!important;max-width:100%!important}thead{background:#2c3e50!important;-webkit-print-color-adjust:exact;print-color-adjust:exact}thead th{color:#fff!important;background:#2c3e50!important}tr{page-break-inside:avoid;page-break-after:auto}th,td{padding:8px 6px;font-size:10px;color:#2c3e50!important;background:#fff!important}tbody tr:nth-child(2n) td{background:#f8f9fa!important}.container,.content,.table-container{background:#fff!important}.positive{color:#27ae60!important}.negative{color:#e74c3c!important}#fundsTable th,#fundsTable td{min-width:auto!important;max-width:none!important}#fundsTable th:nth-child(1),#fundsTable td:nth-child(1){width:130px!important}#fundsTable th:nth-child(2),#fundsTable td:nth-child(2){width:90px!important;max-width:90px!important;overflow:hidden;text-overflow:ellipsis}#fundsTable th:nth-child(3),#fundsTable td:nth-child(3){width:45px!important}#fundsTable th:nth-child(4),#fundsTable td:nth-child(4),#fundsTable th:nth-child(5),#fundsTable td:nth-child(5),#fundsTable th:nth-child(6),#fundsTable td:nth-child(6),#fundsTable th:nth-child(7),#fundsTable td:nth-child(7),#fundsTable th:nth-child(8),#fundsTable td:nth-child(8),#fundsTable th:nth-child(11),#fundsTable td:nth-child(11){width:70px!important}#fundsTable th:nth-child(9),#fundsTable td:nth-child(9),#fundsTable th:nth-child(10),#fundsTable td:nth-child(10){width:50px!important}thead tr th:last-child,tbody tr td:last-child{display:none}.table-tags{display:none!important}tbody tr:last-child{border-top:2px solid var(--color-primary);border-bottom:2px solid var(--color-primary);background:#f0f0f0!important;-webkit-print-color-adjust:exact;print-color-adjust:exact}.positive{color:var(--color-success)!important;-webkit-print-color-adjust:exact;print-color-adjust:exact}.negative{color:var(--color-danger)!important;-webkit-print-color-adjust:exact;print-color-adjust:exact}@page{size:landscape;margin:.5in}#timelinePanel:not(.expanded){display:none!important}}.sidebar-overlay{position:fixed;top:0;left:0;width:100%;height:100%;background:#00000080;z-index:9998;opacity:0;visibility:hidden;transition:opacity .3s ease,visibility .3s ease}.sidebar-overlay.show{opacity:1;visibility:visible}.sidebar{position:fixed;top:0;right:-320px;width:320px;height:100%;background:var(--color-white);box-shadow:-2px 0 8px #00000026;z-index:9999;transition:right .3s ease;display:flex;flex-direction:column}.sidebar.show{right:0}.sidebar-header{display:flex;justify-content:space-between;align-items:center;padding:20px;border-bottom:1px solid var(--color-border);background:var(--color-hover-bg)}.sidebar-header h3{margin:0;color:var(--color-primary);font-size:18px;font-weight:600}.sidebar-close{background:none;border:none;font-size:28px;color:var(--color-secondary-hover);cursor:pointer;padding:0;width:30px;height:30px;display:flex;align-items:center;justify-content:center;border-radius:var(--radius-sm);transition:var(--transition-medium)}.sidebar-close:hover{background:var(--color-border);color:var(--color-primary)}.sidebar-content{flex:1;overflow-y:auto;padding:10px 0}.sidebar-section{margin-bottom:10px}.sidebar-section-title{padding:12px 20px 8px;margin:0;font-size:12px;font-weight:600;color:var(--color-secondary-hover);text-transform:uppercase;letter-spacing:.5px}.sidebar-item{padding:0}.sidebar-item a{display:flex;align-items:center;gap:12px;padding:12px 20px;color:var(--color-primary);text-decoration:none;transition:var(--transition-medium);cursor:pointer;font-size:14px}.sidebar-item a:hover{background:var(--color-hover-bg)}.sidebar-checkbox-label{display:flex;align-items:center;gap:12px;padding:12px 20px;cursor:pointer;transition:var(--transition-medium);font-size:14px}.sidebar-checkbox-label:hover{background:var(--color-hover-bg)}.sidebar-checkbox-label input[type=checkbox]{width:18px;height:18px;cursor:pointer;margin:0}.sidebar-checkbox-label span{color:var(--color-primary);flex:1}body.sidebar-open{overflow:hidden}[data-mask-accounts=true] #fundsTable th:nth-child(2),[data-mask-accounts=true] #fundsTable td:nth-child(2){display:none}.grouped-fund-row td:first-child{font-weight:600}.grouped-fund-row .investor-count{font-size:.85em;color:var(--color-text-light);font-weight:400}.table-loading-row td{text-align:center;padding:40px;color:var(--color-text-light)}.table-loading-content{display:flex;flex-direction:column;align-items:center;gap:12px}.table-loading-spinner{width:24px;height:24px;border:3px solid var(--color-border);border-top-color:var(--color-action);border-radius:50%;animation:spin .8s linear infinite}.table-loading-text{font-size:14px}.header-toggle{font-size:14px;padding:2px 6px;border-radius:var(--radius-sm);transition:var(--transition-fast);background:transparent;color:var(--color-white);opacity:.7}.header-toggle:hover{opacity:1;background:#ffffff1a}.header-toggle.active{background-color:var(--color-action);color:#fff;opacity:1}[data-theme=dark] .header-toggle{color:var(--color-text)}[data-theme=dark] .header-toggle.active{background-color:var(--color-action);color:#fff}.grouped-group-row td:first-child{font-weight:600;padding-left:var(--group-indent, 8px)}.group-name-cell{display:flex;align-items:center;gap:6px}.group-name-cell .group-name{font-weight:600}.group-name-cell .btn-expand{background:none;border:none;cursor:pointer;padding:2px 4px;font-size:10px;color:var(--color-text-light);border-radius:var(--radius-sm);transition:var(--transition-fast);line-height:1;min-width:18px;text-align:center}.group-name-cell .btn-expand:hover{background:var(--color-hover-bg);color:var(--color-text)}.group-name-cell .expand-placeholder{display:inline-block;width:18px;font-size:10px;color:transparent}.group-type-badge{font-size:.75em;font-weight:400;color:var(--color-text-light);background:var(--color-alt-bg);padding:2px 6px;border-radius:var(--radius-sm);margin-left:6px}[data-theme=dark] .group-type-badge{background:var(--color-hover-bg)}.grouped-group-row.depth-0{background-color:var(--color-alt-bg)}.grouped-group-row.depth-1{background-color:var(--color-white)}.grouped-group-row.depth-2{background-color:var(--color-hover-bg)}[data-theme=dark] .grouped-group-row.depth-0{background-color:#ffffff08}[data-theme=dark] .grouped-group-row.depth-1{background-color:var(--color-white)}[data-theme=dark] .grouped-group-row.depth-2{background-color:#ffffff05}.grouped-group-row.no-group td:first-child .group-name{font-style:italic;color:var(--color-text-light)}</style>
</head>
<body>
    <!-- Skip to main content for keyboard/screen reader users -->
    <a href="#mainContent" class="skip-link">Skip to main content</a>

    <!-- Screen reader announcements for dynamic content updates -->
    <div id="srAnnounce" class="sr-announce" aria-live="polite" aria-atomic="true"></div>

    <!-- Toast container for stacking notifications -->
    <div id="toastContainer" class="toast-container" aria-live="polite"></div>

    <!-- Loading Overlay -->
    <div id="loadingOverlay" class="loading-overlay" role="dialog" aria-labelledby="loadingText" aria-modal="true">
        <div class="loading-content">
            <div class="loading-spinner" aria-hidden="true"></div>
            <div class="loading-text" id="loadingText">Loading...</div>
        </div>
    </div>

    <div class="container" role="main">
        <header role="banner">
            <h1 id="headerTitle">PE Fund Manager</h1>
            <p id="headerSubtitle">Private Equity Fund Analytics & Management Tool</p>
        </header>

        <div class="controls-bar" role="search" aria-label="Filter and search controls">
            <div class="control-group">
                <label>Filter by Group</label>
                <div class="multi-select" id="groupFilter" data-placeholder="All Groups">
                    <div class="multi-select-trigger" tabindex="0" role="combobox" aria-expanded="false" aria-haspopup="listbox">
                        <span class="multi-select-display"><span class="placeholder">All Groups</span></span>
                        <span class="multi-select-arrow">&#9662;</span>
                    </div>
                    <div class="multi-select-dropdown" role="listbox"></div>
                </div>
            </div>
            <div class="control-group">
                <label>Filter by Fund</label>
                <div class="multi-select" id="fundFilter" data-placeholder="All Funds">
                    <div class="multi-select-trigger" tabindex="0" role="combobox" aria-expanded="false" aria-haspopup="listbox">
                        <span class="multi-select-display"><span class="placeholder">All Funds</span></span>
                        <span class="multi-select-arrow">&#9662;</span>
                    </div>
                    <div class="multi-select-dropdown" role="listbox"></div>
                </div>
            </div>
            <div class="control-group">
                <label>Filter by Account</label>
                <div class="multi-select" id="accountFilter" data-placeholder="All Accounts">
                    <div class="multi-select-trigger" tabindex="0" role="combobox" aria-expanded="false" aria-haspopup="listbox">
                        <span class="multi-select-display"><span class="placeholder">All Accounts</span></span>
                        <span class="multi-select-arrow">&#9662;</span>
                    </div>
                    <div class="multi-select-dropdown" role="listbox"></div>
                </div>
            </div>
            <div class="control-group">
                <label>Filter by Vintage</label>
                <div class="multi-select" id="vintageFilter" data-placeholder="All Vintages">
                    <div class="multi-select-trigger" tabindex="0" role="combobox" aria-expanded="false" aria-haspopup="listbox">
                        <span class="multi-select-display"><span class="placeholder">All Vintages</span></span>
                        <span class="multi-select-arrow">&#9662;</span>
                    </div>
                    <div class="multi-select-dropdown" role="listbox"></div>
                </div>
            </div>
            <div class="control-group">
                <label>Filter by Tag</label>
                <div class="multi-select" id="tagFilter" data-placeholder="All Tags">
                    <div class="multi-select-trigger" tabindex="0" role="combobox" aria-expanded="false" aria-haspopup="listbox">
                        <span class="multi-select-display"><span class="placeholder">All Tags</span></span>
                        <span class="multi-select-arrow">&#9662;</span>
                    </div>
                    <div class="multi-select-dropdown" role="listbox"></div>
                </div>
            </div>
            <div class="control-group">
                <label for="cutoffDate" title="Calculate all metrics (IRR, MOIC, NAV, etc.) as of this date">Cutoff Date</label>
                <input type="date" id="cutoffDate" title="Calculate all metrics (IRR, MOIC, NAV, etc.) as of this date" aria-label="Cutoff date for calculating metrics">
            </div>
            <span id="activeFiltersIndicator" class="filter-badge" aria-live="polite"></span>
            <div id="filterLoading" class="filter-loading" aria-live="polite">
                <div class="filter-loading-spinner" aria-hidden="true"></div>
                <span>Filtering...</span>
            </div>
            <div class="ml-auto">
                <button class="btn-icon btn-icon-lg" id="toggleSidebarBtn" title="Settings and Actions" aria-label="Open settings sidebar">&#9776;</button>
            </div>
        </div>

        <div class="content" id="mainContent">
            <div id="portfolioSummary" class="portfolio-summary">
                <div class="summary-stat">
                    <span class="summary-label">Investments</span>
                    <span class="summary-value" id="summaryInvestmentCount">0</span>
                </div>
                <div class="summary-stat">
                    <span class="summary-label">Funds</span>
                    <span class="summary-value" id="summaryFundCount">0</span>
                </div>
                <div class="summary-stat">
                    <span class="summary-label">Total Commitment</span>
                    <span class="summary-value" id="summaryCommitment">$0</span>
                </div>
                <div class="summary-stat">
                    <span class="summary-label">Total NAV</span>
                    <span class="summary-value" id="summaryNav">$0</span>
                </div>
                <div class="summary-stat">
                    <div class="summary-label-container">
                        <span class="summary-label">Avg IRR</span>
                        <span class="info-icon" aria-label="IRR explanation">?<span class="tooltip">Internal Rate of Return: The annualized return rate that makes the net present value of all cash flows equal to zero. Higher is better.</span></span>
                    </div>
                    <span class="summary-value" id="summaryIRR">N/A</span>
                </div>
                <div class="summary-stat">
                    <div class="summary-label-container">
                        <span class="summary-label">Avg MOIC</span>
                        <span class="info-icon" aria-label="MOIC explanation">?<span class="tooltip">Multiple on Invested Capital: Total value (distributions + NAV) divided by total contributions. A MOIC of 2.0x means you doubled your money.</span></span>
                    </div>
                    <span class="summary-value" id="summaryMOIC">N/A</span>
                </div>
                <div class="summary-stat">
                    <div class="summary-label-container">
                        <span class="summary-label">DPI</span>
                        <span class="info-icon" aria-label="DPI explanation">?<span class="tooltip">Distributions to Paid-In: Total distributions divided by total contributions. Measures actual cash returned to investors.</span></span>
                    </div>
                    <span class="summary-value" id="summaryDPI">N/A</span>
                </div>
                <div class="summary-stat">
                    <div class="summary-label-container">
                        <span class="summary-label">RVPI</span>
                        <span class="info-icon" aria-label="RVPI explanation">?<span class="tooltip">Residual Value to Paid-In: Current NAV divided by total contributions. Represents unrealized value still held in the fund.</span></span>
                    </div>
                    <span class="summary-value" id="summaryRVPI">N/A</span>
                </div>
                <div class="summary-stat">
                    <div class="summary-label-container">
                        <span class="summary-label">TVPI</span>
                        <span class="info-icon" aria-label="TVPI explanation">?<span class="tooltip">Total Value to Paid-In: DPI + RVPI. The most comprehensive measure of fund performance.</span></span>
                    </div>
                    <span class="summary-value" id="summaryTVPI">N/A</span>
                </div>
            </div>

            <div id="timelinePanel" class="timeline-panel">
                <div class="timeline-header" id="timelineHeader">
                    <h3>
                        <span>Cash Flow Timeline</span>
                        <span class="timeline-label">(Historical + Projected)</span>
                    </h3>
                    <span class="timeline-toggle">&#9660;</span>
                </div>
                <div class="timeline-content">
                    <div id="timelineTableContainer">
                        <p class="timeline-no-data">No investments to display yet.</p>
                    </div>
                </div>
            </div>

            <div class="table-container">
                <table id="fundsTable">
                    <thead>
                        <tr>
                            <th data-sort="fundName">Fund Name</th>
                            <th data-sort="accountNumber" class="center">Investor</th>
                            <th data-sort="vintage" class="center">Vintage</th>
                            <th data-sort="commitment" class="center number">Commitment</th>
                            <th data-sort="totalContributions" class="center number">Contributions</th>
                            <th data-sort="totalDistributions" class="center number">Distributions</th>
                            <th data-sort="nav" class="center number">Value (NAV)</th>
                            <th data-sort="investmentReturn" class="center number wrap-header">Investment<br>Return</th>
                            <th data-sort="moic" class="center number">MOIC</th>
                            <th data-sort="irr" class="center number">IRR</th>
                            <th data-sort="outstandingCommitment" class="center number wrap-header">Outstanding<br>Commitment</th>
                            <th class="center">
                                <button id="groupByFundToggle" class="btn-icon header-toggle" title="Group by Fund (Σ)" aria-label="Toggle group by fund">Σ</button>
                            </th>
                        </tr>
                    </thead>
                    <tbody id="fundsTableBody"></tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- Fund Add/Edit Modal -->
    <div id="fundModal" class="modal">
        <div class="modal-content">
            <button type="button" class="btn-close" id="closeFundModalBtn" aria-label="Close">&times;</button>
            <h2 id="fundModalTitle">Add New Investment</h2>
            <form id="fundForm">
                <input type="hidden" id="fundId">
                <input type="hidden" id="isDuplicate">
                <div class="form-group">
                    <label for="fundName">Fund Name *</label>
                    <select id="fundName" required></select>
                    <div id="newFundNameContainer" class="hidden mt-md">
                        <div class="d-flex gap-sm">
                            <input type="text" id="newFundNameInline" placeholder="Enter new fund name" class="flex-1">
                            <button type="button" class="btn-primary btn-compact" id="addNewFundNameBtn">Add</button>
                            <button type="button" class="btn-secondary btn-compact" id="cancelNewFundNameBtn">Cancel</button>
                        </div>
                    </div>
                </div>
                <div class="form-group">
                    <label for="accountNumber">Account Number *</label>
                    <input type="text" id="accountNumber" required>
                </div>
                <div class="form-group">
                    <label for="fundGroup">Group (optional)</label>
                    <div class="searchable-select" id="fundGroupContainer" data-placeholder="No Group">
                        <input type="hidden" id="fundGroup" value="">
                        <div class="searchable-select-trigger" tabindex="0" aria-haspopup="listbox" aria-expanded="false">
                            <span class="searchable-select-display">No Group</span>
                            <span class="searchable-select-arrow"></span>
                        </div>
                        <div class="searchable-select-dropdown">
                            <div class="searchable-select-search">
                                <input type="text" placeholder="Search groups..." aria-label="Search groups">
                            </div>
                            <div class="searchable-select-options"></div>
                            <div class="searchable-select-no-results">No matches found</div>
                        </div>
                    </div>
                </div>
                <div class="form-group">
                    <label for="commitment">Commitment (USD) *</label>
                    <input type="text" id="commitment" required placeholder="e.g., 1,000,000">
                </div>
                <div id="duplicateMultiplierContainer" class="form-group hidden">
                    <label for="duplicateMultiplier">Duplicate Multiplier</label>
                    <input type="number" id="duplicateMultiplier" step="any" value="1">
                </div>
                <div class="form-actions">
                    <button type="button" class="btn-secondary" id="cancelFundModalBtn">Cancel</button>
                    <button type="submit" class="btn-primary" id="saveFundBtn">Save</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Action Dropdown -->
    <div id="actionDropdown" class="action-dropdown">
        <a href="#" id="actionEdit">Edit</a>
        <a href="#" id="actionDuplicate">Duplicate</a>
        <a href="#" id="actionViewDetails">View Details</a>
        <a href="#" id="actionDelete" class="danger-action">Delete</a>
    </div>

    <!-- Manage Fund Names Modal -->
    <div id="manageFundNamesModal" class="modal">
        <div class="modal-content">
            <button type="button" class="btn-close" id="closeManageFundsModalBtn" aria-label="Close">&times;</button>
            <h2>Manage Fund Names</h2>
            <div class="form-group">
                <label for="newFundNameInput">Add New Fund Name</label>
                <input type="text" id="newFundNameInput" placeholder="Enter fund name">
            </div>
            <details id="newFundTermsDetails" class="mb-md">
                <summary class="fund-terms-toggle">+ Add Fund Terms (optional)</summary>
                <div class="fund-terms-panel">
                    <div class="form-group mb-sm">
                        <label for="newFundTermStartDate" class="text-xs">Investment Term Start Date</label>
                        <input type="date" id="newFundTermStartDate">
                    </div>
                    <div class="form-group">
                        <label for="newFundInvestmentTerm" class="text-xs">Investment Term (years)</label>
                        <input type="number" id="newFundInvestmentTerm" min="1" max="15" step="1" placeholder="e.g., 5">
                    </div>
                </div>
            </details>
            <button class="btn-primary btn-full" id="addNewFundNameModalBtn">Add Fund Name</button>
            <hr class="section-divider">
            <h3 class="section-title">Existing Fund Names</h3>
            <div id="fundNamesList"></div>
            <div class="form-actions">
                <button class="btn-secondary" id="closeManageFundsModal2Btn">Close</button>
            </div>
        </div>
    </div>

    <!-- Edit Fund Name Modal -->
    <div id="editFundNameModal" class="modal">
        <div class="modal-content">
            <button type="button" class="btn-close" id="closeEditFundNameModalBtn" aria-label="Close">&times;</button>
            <h2>Edit Fund</h2>
            <input type="hidden" id="editFundNameOriginal" value="">
            <div class="form-group">
                <label for="editFundNameInput">Fund Name</label>
                <input type="text" id="editFundNameInput" placeholder="Enter fund name">
            </div>
            <div class="form-group">
                <label for="editFundTags">Tags (optional)</label>
                <div id="editFundTagsContainer" class="tags-container"></div>
                <input type="text" id="editFundTagsInput" placeholder="Add tag (e.g., Venture Capital, Growth Equity)" list="editFundTagsDatalist">
                <datalist id="editFundTagsDatalist"></datalist>
                <div class="hint">Press Enter to add tags. Click x on a tag to remove it.</div>
            </div>
            <h3 class="section-title-bordered">Fund Terms</h3>
            <div class="form-group">
                <label for="editFundTermStartDate">Investment Term Start Date</label>
                <input type="date" id="editFundTermStartDate">
            </div>
            <div class="form-group">
                <label for="editFundInvestmentTerm">Investment Term (years)</label>
                <input type="number" id="editFundInvestmentTerm" min="1" max="15" step="1" placeholder="e.g., 5">
                <div class="hint">Number of years from term start during which capital can be called</div>
            </div>
            <div class="form-actions">
                <button class="btn-secondary" id="cancelEditFundNameBtn">Cancel</button>
                <button class="btn-primary" id="saveEditedFundNameBtn">Save Changes</button>
            </div>
        </div>
    </div>

    <!-- Manage Groups Modal -->
    <div id="manageGroupsModal" class="modal modal-md">
        <div class="modal-content">
            <button type="button" class="btn-close" id="closeManageGroupsModal2Btn" aria-label="Close">&times;</button>
            <h2>Manage Account Groups</h2>
            <input type="hidden" id="editGroupId" value="">
            <h3 id="groupFormTitle" class="section-title">Add New Group</h3>
            <div class="form-group">
                <label for="newGroupName">Group Name</label>
                <input type="text" id="newGroupName" placeholder="e.g., John Smith, Smith Family Trust">
                <small class="small-hint">Use groups to organize by account holder or entity</small>
            </div>
            <div class="form-group">
                <label>Parent Group (optional)</label>
                <div class="searchable-select" id="newGroupParentContainer" data-placeholder="None (Top Level)">
                    <input type="hidden" id="newGroupParent" value="">
                    <div class="searchable-select-trigger" tabindex="0" aria-haspopup="listbox" aria-expanded="false">
                        <span class="searchable-select-display">None (Top Level)</span>
                        <span class="searchable-select-arrow"></span>
                    </div>
                    <div class="searchable-select-dropdown">
                        <div class="searchable-select-search">
                            <input type="text" placeholder="Search groups..." aria-label="Search groups">
                        </div>
                        <div class="searchable-select-options"></div>
                        <div class="searchable-select-no-results">No matches found</div>
                    </div>
                </div>
            </div>
            <div class="form-group">
                <label for="newGroupType">Type (optional)</label>
                <select id="newGroupType">
                    <option value="">Select type...</option>
                    <option value="Household">Household</option>
                    <option value="Client">Client</option>
                    <option value="Revocable Trust">Revocable Trust</option>
                    <option value="Irrevocable Trust">Irrevocable Trust</option>
                    <option value="Retirement Account">Retirement Account</option>
                    <option value="Other">Other</option>
                </select>
            </div>
            <div class="d-flex gap-md">
                <button id="saveGroupBtn" class="btn-primary">Add Group</button>
                <button id="cancelEditBtn" class="btn-secondary hidden">Cancel</button>
            </div>
            <hr class="section-divider">
            <h3 class="section-title">Existing Groups</h3>
            <div id="groupsList" class="groups-list"></div>
            <div class="form-actions">
                <button class="btn-secondary" id="closeManageGroupsModalBtn">Close</button>
            </div>
        </div>
    </div>

    <!-- Details Modal -->
    <div id="detailsModal" class="modal modal-xl">
        <div class="modal-content">
            <button type="button" class="btn-close" id="closeDetailsModalBtn" aria-label="Close">&times;</button>
            <h2 id="detailsModalTitle">Fund Details</h2>
            <p id="detailsModalSubtitle" class="modal-subtitle"></p>
            <div id="detailsSummary" class="portfolio-summary mt-lg">
                <div class="summary-stat"><span class="summary-label">Total Commitment</span><span class="summary-value" id="detailsSummaryCommitment">$0</span></div>
                <div class="summary-stat"><span class="summary-label">Contributions</span><span class="summary-value" id="detailsSummaryContributions">$0</span></div>
                <div class="summary-stat"><span class="summary-label">Distributions</span><span class="summary-value" id="detailsSummaryDistributions">$0</span></div>
                <div class="summary-stat"><span class="summary-label">Current Value</span><span class="summary-value" id="detailsSummaryValue">$0</span></div>
                <div class="summary-stat"><span class="summary-label">Investment Return</span><span class="summary-value" id="detailsSummaryReturn">$0</span></div>
                <div class="summary-stat"><span class="summary-label">Outstanding Commitment</span><span class="summary-value" id="detailsSummaryOutstanding">$0</span></div>
            </div>
            <h3 class="section-title mt-lg">Cash Flows</h3>
            <div class="details-table-wrapper">
                <table class="details-table" id="cashFlowsTable">
                    <thead><tr><th>Date</th><th class="number">Amount (USD)</th><th class="center">Type</th><th class="center">Affects Commitment?</th><th></th></tr></thead>
                    <tbody></tbody>
                </table>
            </div>
            <button type="button" class="btn-primary btn-sm mt-md" id="addCashFlowRowBtn">Add Cash Flow</button>
            <h3 class="section-title" style="margin-top: 30px;">Values</h3>
            <div class="details-table-wrapper">
                <table class="details-table" id="navTable">
                    <thead><tr><th>Date</th><th>Amount (USD)</th><th></th></tr></thead>
                    <tbody></tbody>
                </table>
            </div>
            <button type="button" class="btn-primary btn-sm mt-md" id="addNavRowBtn">Add Value</button>
            <div class="form-actions">
                <button class="btn-secondary" id="cancelDetailsModalBtn">Cancel</button>
                <button class="btn-primary" id="saveDetailsChangesBtn">Save Changes</button>
            </div>
        </div>
    </div>

    <!-- Backup Warning Modal -->
    <div id="backupWarningModal" class="modal modal-sm">
        <div class="modal-content">
            <button type="button" class="btn-close" id="closeBackupWarningBtn" aria-label="Close">&times;</button>
            <h2 class="text-warning mb-md">Important: Backup Your Data</h2>
            <p class="backup-warning-text">Your PE Fund Manager data is stored <strong>locally in your browser</strong>. This means your data could be lost if:</p>
            <ul class="backup-warning-list">
                <li>You clear your browser cache or cookies</li>
                <li>You uninstall your browser</li>
                <li>Your computer crashes or is reset</li>
                <li>You switch to a different device</li>
            </ul>
            <p class="backup-warning-cta">Please export your data regularly to avoid data loss!</p>
            <div class="form-group">
                <label class="checkbox-label"><input type="checkbox" id="dontShowBackupWarning">Don't show this warning again</label>
            </div>
            <div class="form-actions">
                <button class="btn-secondary" id="remindLaterBtn">Remind Me Later</button>
                <button class="btn-success" id="exportNowBtn">Export Now</button>
            </div>
        </div>
    </div>

    <!-- Health Check Modal -->
    <div id="healthCheckModal" class="modal health-check-modal">
        <div class="modal-content health-check-content">
            <button type="button" class="btn-close" id="closeHealthCheckModalBtn" aria-label="Close">&times;</button>
            <h2>Data Health Check</h2>
            <div id="healthCheckSummary" class="health-check-summary"></div>
            <div id="healthCheckResults" class="health-check-results"></div>
            <div class="form-actions">
                <button class="btn-secondary" id="closeHealthCheckModal2Btn">Close</button>
            </div>
        </div>
    </div>

    <!-- Keyboard Shortcuts Modal -->
    <div id="shortcutsModal" class="modal shortcuts-modal">
        <div class="modal-content">
            <button type="button" class="btn-close" id="closeShortcutsModalBtn" aria-label="Close">&times;</button>
            <h2>Keyboard Shortcuts</h2>
            <div class="shortcuts-list">
                <div class="shortcut-key"><kbd>?</kbd></div><div class="shortcut-desc">Show this help</div>
                <div class="shortcut-key"><kbd>Ctrl</kbd> + <kbd>N</kbd></div><div class="shortcut-desc">Add new investment</div>
                <div class="shortcut-key"><kbd>Ctrl</kbd> + <kbd>E</kbd></div><div class="shortcut-desc">Export to JSON</div>
                <div class="shortcut-key"><kbd>Ctrl</kbd> + <kbd>S</kbd></div><div class="shortcut-desc">Save (in details modal)</div>
                <div class="shortcut-key"><kbd>Esc</kbd></div><div class="shortcut-desc">Close modal/sidebar</div>
            </div>
            <div class="form-actions"><button class="btn-secondary" id="closeShortcutsModal2Btn">Close</button></div>
        </div>
    </div>

    <!-- Confirm Modal -->
    <div id="confirmModal" class="modal confirm-modal">
        <div class="modal-content confirm-modal-content">
            <button type="button" class="btn-close" id="closeConfirmModalBtn" aria-label="Close">&times;</button>
            <h2 id="confirmModalTitle">Confirm</h2>
            <p id="confirmModalMessage" class="confirm-modal-message"></p>
            <div class="form-actions">
                <button class="btn-secondary" id="confirmModalCancelBtn">Cancel</button>
                <button class="btn-danger" id="confirmModalConfirmBtn">Confirm</button>
            </div>
        </div>
    </div>

    <!-- Bulk Cash Flow Modal -->
    <div id="bulkCashFlowModal" class="modal modal-md">
        <div class="modal-content">
            <button type="button" class="btn-close" id="closeBulkCashFlowModalBtn" aria-label="Close">&times;</button>
            <h2>Bulk Cash Flow</h2>
            <p class="modal-description">Add a cash flow to all investors in a fund based on a percentage of their commitment.</p>
            <div class="form-group"><label for="bulkCashFlowFundName">Fund Name *</label><select id="bulkCashFlowFundName" required><option value="">Select a fund</option></select></div>
            <div class="form-group"><label for="bulkCashFlowDate">Date *</label><input type="date" id="bulkCashFlowDate" required></div>
            <div class="form-group"><label for="bulkCashFlowType">Type *</label><select id="bulkCashFlowType" required><option value="Contribution">Contribution (Capital Call)</option><option value="Distribution">Distribution</option><option value="Adjustment">Adjustment</option></select></div>
            <div class="form-group"><label for="bulkCashFlowPercentage">Percentage of Commitment *</label><input type="number" id="bulkCashFlowPercentage" step="0.01" min="0.01" max="100" placeholder="e.g., 4.5" required><div class="hint">Enter percentage (e.g., 4.5 for 4.5%)</div></div>
            <div class="form-group"><label><input type="checkbox" id="bulkCashFlowAffectsCommitment" checked>Affects unfunded commitment</label></div>
            <div id="bulkCashFlowPreview" class="preview-container"><h4 class="preview-title">Preview</h4><div id="bulkCashFlowPreviewContent"></div></div>
            <div class="form-actions">
                <button type="button" class="btn-secondary" id="cancelBulkCashFlowBtn">Cancel</button>
                <button type="button" class="btn-secondary" id="previewBulkCashFlowBtn">Preview</button>
                <button type="button" class="btn-primary" id="applyBulkCashFlowBtn" disabled>Apply</button>
            </div>
        </div>
    </div>

    <!-- Bulk Remove Fund Modal -->
    <div id="bulkRemoveFundModal" class="modal modal-md">
        <div class="modal-content">
            <button type="button" class="btn-close" id="closeBulkRemoveFundModalBtn" aria-label="Close">&times;</button>
            <h2>Bulk Remove Fund</h2>
            <p class="modal-description">Remove all investor positions for a selected fund. This action cannot be undone.</p>
            <div class="form-group"><label for="bulkRemoveFundName">Fund Name *</label><select id="bulkRemoveFundName" required><option value="">Select a fund</option></select></div>
            <div id="bulkRemoveFundPreview" class="preview-container"><h4 class="preview-title-danger">The following investors will be removed:</h4><div id="bulkRemoveFundPreviewContent"></div></div>
            <div class="form-actions">
                <button type="button" class="btn-secondary" id="cancelBulkRemoveFundBtn">Cancel</button>
                <button type="button" class="btn-secondary" id="previewBulkRemoveFundBtn">Preview</button>
                <button type="button" class="btn-danger" id="applyBulkRemoveFundBtn" disabled>Remove All</button>
            </div>
        </div>
    </div>

    <!-- Bulk Assign Group Modal -->
    <div id="bulkAssignGroupModal" class="modal modal-md">
        <div class="modal-content">
            <button type="button" class="btn-close" id="closeBulkAssignGroupModalBtn" aria-label="Close">&times;</button>
            <h2>Bulk Assign Group</h2>
            <p class="modal-description">Assign all investments with a specific account number to a group.</p>
            <div class="form-group"><label for="bulkAssignGroupAccount">Account Number *</label><select id="bulkAssignGroupAccount" required><option value="">Select an account</option></select></div>
            <div class="form-group"><label for="bulkAssignGroupTarget">Target Group *</label><select id="bulkAssignGroupTarget" required><option value="">No Group</option></select></div>
            <div id="bulkAssignGroupPreview" class="preview-container"><h4 class="preview-title">The following investments will be updated:</h4><div id="bulkAssignGroupPreviewContent"></div></div>
            <div class="form-actions">
                <button type="button" class="btn-secondary" id="cancelBulkAssignGroupBtn">Cancel</button>
                <button type="button" class="btn-secondary" id="previewBulkAssignGroupBtn">Preview</button>
                <button type="button" class="btn-primary" id="applyBulkAssignGroupBtn" disabled>Apply</button>
            </div>
        </div>
    </div>

    <!-- Import Preview Modal -->
    <div id="importPreviewModal" class="modal modal-lg">
        <div class="modal-content">
            <button type="button" class="btn-close" id="closeImportPreviewModalBtn" aria-label="Close">&times;</button>
            <h2>Import Preview</h2>
            <p class="modal-description">Review the data to be imported before confirming.</p>
            <div id="importPreviewContent" class="import-preview-container"><p class="text-muted">Select a JSON file to preview...</p></div>
            <div class="form-actions">
                <button type="button" class="btn-secondary btn-min-width" id="cancelImportPreviewBtn">Cancel</button>
                <label for="importPreviewFileInput" class="btn-secondary btn-file-input">Choose File</label>
                <input type="file" id="importPreviewFileInput" accept=".json" class="hidden">
                <button type="button" class="btn-primary btn-min-width" id="applyImportBtn" disabled>Import</button>
            </div>
        </div>
    </div>

    <!-- Sync Account Groups Modal -->
    <div id="syncAccountGroupsModal" class="modal modal-lg">
        <div class="modal-content">
            <button type="button" class="btn-close" id="closeSyncAccountGroupsModalBtn" aria-label="Close">&times;</button>
            <h2>Sync Account Groups</h2>
            <p class="modal-description">Review account numbers with inconsistent group assignments. Apply sync to ensure all investments with the same account number share the same group.</p>
            <div id="syncAccountGroupsContent" class="sync-content"></div>
            <div class="form-actions">
                <button type="button" class="btn-secondary btn-min-width" id="cancelSyncAccountGroupsBtn">Cancel</button>
                <button type="button" class="btn-primary btn-min-width" id="applySyncAccountGroupsBtn" disabled>Apply Sync</button>
            </div>
        </div>
    </div>

    <!-- Sidebar Panel -->
    <div id="sidebarOverlay" class="sidebar-overlay"></div>
    <div id="sidebar" class="sidebar">
        <div class="sidebar-header">
            <h3>Settings & Actions</h3>
            <button class="sidebar-close" id="closeSidebarBtn" title="Close">&times;</button>
        </div>
        <div class="sidebar-content">
            <div class="sidebar-section">
                <h4 class="sidebar-section-title">View Options</h4>
                <div class="sidebar-item"><label class="sidebar-checkbox-label"><input type="checkbox" id="sidebarShowTagsCheckbox" checked><span>Show Tags</span></label></div>
                <div class="sidebar-item"><label class="sidebar-checkbox-label"><input type="checkbox" id="sidebarMaskAccountsCheckbox"><span>Mask Accounts</span></label></div>
                <div class="sidebar-item"><label class="sidebar-checkbox-label"><input type="checkbox" id="sidebarGroupByGroupCheckbox"><span>Group by Group</span></label></div>
                <div class="sidebar-item"><label class="sidebar-checkbox-label"><input type="checkbox" id="sidebarDarkModeCheckbox"><span>Dark Mode</span></label></div>
            </div>
            <div class="sidebar-section">
                <h4 class="sidebar-section-title">Manage</h4>
                <div class="sidebar-item"><a href="#" id="sidebarNewInvestment">New Investment</a></div>
                <div class="sidebar-item"><a href="#" id="sidebarManageFunds">Manage Funds</a></div>
                <div class="sidebar-item"><a href="#" id="sidebarManageGroups">Manage Groups</a></div>
                <div class="sidebar-item"><a href="#" id="sidebarBulkCashFlow">Bulk Cash Flow</a></div>
                <div class="sidebar-item"><a href="#" id="sidebarBulkAssignGroup">Bulk Assign Group</a></div>
            </div>
            <div class="sidebar-section">
                <h4 class="sidebar-section-title">Data</h4>
                <div class="sidebar-item"><a href="#" id="sidebarExportCSV">Export to CSV</a></div>
                <div class="sidebar-item"><a href="#" id="sidebarExportJSON">Export to JSON</a></div>
                <div class="sidebar-item"><a href="#" id="sidebarExportPDF">Export to PDF</a></div>
                <div class="sidebar-item"><a href="#" id="sidebarImportJSON">Import JSON</a></div>
            </div>
            <div class="sidebar-section">
                <h4 class="sidebar-section-title">Admin</h4>
                <div class="sidebar-item"><a href="#" id="sidebarHealthCheck">Data Health Check</a></div>
                <div class="sidebar-item"><a href="#" id="sidebarSyncAccountGroups">Sync Account Groups</a></div>
                <div class="sidebar-item"><a href="#" id="sidebarLoadSampleData">Load Sample Data</a></div>
                <div class="sidebar-item"><a href="#" id="sidebarBulkRemoveFund" style="color: var(--color-danger);">Bulk Remove Fund</a></div>
                <div class="sidebar-item"><a href="#" id="sidebarClearDatabase" style="color: var(--color-danger);">Clear Database</a></div>
            </div>
        </div>
    </div>

</body>
</html>
