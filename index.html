<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PE Fund Manager</title>
    <style>
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background: #ECF0F1;
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1800px;
            margin: 0 auto;
            background: white;
            border-radius: 4px;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
            overflow: hidden;
        }

        header {
            background: #2C3E50;
            color: white;
            padding: 24px 30px;
            border-bottom: 3px solid #34495E;
        }

        header h1 {
            font-size: 1.75em;
            font-weight: 600;
            margin-bottom: 4px;
            letter-spacing: -0.5px;
        }

        header p {
            font-size: 0.95em;
            opacity: 0.85;
            font-weight: 400;
        }

        .controls-bar {
            background: #FAFAFA;
            padding: 20px 30px;
            display: flex;
            gap: 16px;
            flex-wrap: wrap;
            align-items: flex-end;
            border-bottom: 1px solid #E0E0E0;
        }

        .control-group {
            display: flex;
            flex-direction: column;
            gap: 6px;
        }

        .control-group label {
            font-weight: 500;
            font-size: 0.85em;
            color: #2C3E50;
        }

        .control-group select,
        .control-group input[type="date"] {
            padding: 8px 12px;
            border: 1px solid #BDC3C7;
            border-radius: 3px;
            font-size: 14px;
            min-width: 150px;
            background: white;
            color: #2C3E50;
        }

        .control-group select:focus,
        .control-group input[type="date"]:focus {
            outline: none;
            border-color: #3498DB;
            box-shadow: 0 0 0 2px rgba(52, 152, 219, 0.1);
        }

        button {
            padding: 9px 18px;
            border: none;
            border-radius: 3px;
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.15s ease;
        }

        .controls-bar button {
            margin-top: auto;
        }

        .btn-primary {
            background: #3498DB;
            color: white;
        }

        .btn-primary:hover {
            background: #2980B9;
        }

        .btn-secondary {
            background: #95A5A6;
            color: white;
        }

        .btn-secondary:hover {
            background: #7F8C8D;
        }

        .btn-success {
            background: #27AE60;
            color: white;
        }

        .btn-success:hover {
            background: #229954;
        }

        .btn-danger {
            background: #E74C3C;
            color: white;
        }

        .btn-danger:hover {
            background: #C0392B;
        }

        .btn-info {
            background: #34495E;
            color: white;
        }

        .btn-info:hover {
            background: #2C3E50;
        }

        button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        /* Dropdown Menu */
        .dropdown {
            position: relative;
            display: inline-block;
        }

        .dropdown-menu {
            display: none;
            position: absolute;
            top: 100%;
            right: 0;
            background: white;
            border: 1px solid #E0E0E0;
            border-radius: 3px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.15);
            min-width: 160px;
            z-index: 1000;
            margin-top: 4px;
        }

        .dropdown-menu.show {
            display: block;
        }

        .dropdown-menu a {
            display: block;
            padding: 10px 16px;
            color: #2C3E50;
            text-decoration: none;
            font-size: 14px;
            transition: background 0.15s ease;
        }

        .dropdown-menu a:hover {
            background: #F8F9FA;
        }

        .dropdown-menu a:first-child {
            border-radius: 3px 3px 0 0;
        }

        .dropdown-menu a:last-child {
            border-radius: 0 0 3px 3px;
        }

        .content {
            padding: 30px;
        }

        .table-container {
            overflow-x: auto;
            margin-bottom: 30px;
        }

        .table-container table {
            width: 100%;
            border-collapse: collapse;
            background: white;
            border: 1px solid #E0E0E0;
            border-radius: 3px;
            overflow: hidden;
            min-width: 1400px;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            background: white;
            border: 1px solid #E0E0E0;
            border-radius: 3px;
            overflow: hidden;
        }

        thead {
            background: #34495E;
            color: white;
            position: sticky;
            top: 0;
            z-index: 10;
        }

        th {
            padding: 14px 12px;
            text-align: left;
            font-weight: 500;
            cursor: pointer;
            user-select: none;
            white-space: nowrap;
            font-size: 0.9em;
        }

        th:hover {
            background: #2C3E50;
        }

        th.sorted-asc::after {
            content: ' ‚Üë';
            opacity: 1;
        }

        th.sorted-desc::after {
            content: ' ‚Üì';
            opacity: 1;
        }

        th.wrap-header {
            white-space: normal;
            line-height: 1.3;
            padding: 10px 8px;
        }

        td {
            padding: 12px;
            border-bottom: 1px solid #F0F0F0;
            font-size: 0.9em;
            color: #2C3E50;
        }

        tbody tr:hover {
            background: #F8F9FA;
        }

        tbody tr:last-child {
            border-top: 2px solid #34495E;
            border-bottom: 2px solid #34495E;
            font-weight: 600;
            background: #FAFAFA;
        }

        tbody tr:last-child td {
            border-bottom: none;
        }

        td.number {
            text-align: right;
            font-variant-numeric: tabular-nums;
        }

        th.center,
        td.center {
            text-align: center;
        }

        .positive {
            color: #27AE60;
        }

        .negative {
            color: #E74C3C;
        }

        .empty-state {
            text-align: center;
            padding: 60px 20px;
            color: #95A5A6;
        }

        .action-buttons {
            display: flex;
            gap: 5px;
            flex-wrap: nowrap;
        }

        .btn-sm {
            padding: 6px 12px;
            font-size: 12px;
            min-width: auto;
            white-space: nowrap;
        }

        /* Modal Styles */
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            overflow-y: auto;
            background-color: rgba(44, 62, 80, 0.5);
        }

        .modal.show {
            display: flex;
            align-items: flex-start;
            justify-content: center;
            padding: 40px 20px;
        }

        .modal-content {
            background-color: #fff;
            padding: 30px;
            border-radius: 4px;
            width: 100%;
            max-width: 700px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
            position: relative;
            margin: auto;
        }

        .modal-content h2 {
            margin-bottom: 24px;
            color: #2C3E50;
            font-size: 1.5em;
            font-weight: 600;
        }

        .modal .close {
            position: absolute;
            top: 15px;
            right: 20px;
            font-size: 28px;
            font-weight: 300;
            color: #95A5A6;
            cursor: pointer;
            line-height: 1;
        }

        .modal .close:hover {
            color: #2C3E50;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 500;
            color: #2C3E50;
            font-size: 0.9em;
        }

        .form-group input,
        .form-group select,
        .form-group textarea {
            width: 100%;
            padding: 10px 12px;
            border: 1px solid #BDC3C7;
            border-radius: 3px;
            font-size: 14px;
            transition: border-color 0.15s ease;
            background: white;
        }

        .form-group input:focus,
        .form-group select:focus,
        .form-group textarea:focus {
            outline: none;
            border-color: #3498DB;
            box-shadow: 0 0 0 2px rgba(52, 152, 219, 0.1);
        }

        .form-group textarea {
            font-family: 'Courier New', monospace;
            resize: vertical;
            min-height: 100px;
        }

        .form-group .hint {
            font-size: 12px;
            color: #7F8C8D;
            margin-top: 5px;
        }

        .tags-container {
            display: flex;
            flex-wrap: wrap;
            gap: 6px;
            margin-bottom: 8px;
            min-height: 24px;
        }

        .tag {
            display: inline-flex;
            align-items: center;
            background: #3498DB;
            color: white;
            padding: 4px 10px;
            border-radius: 12px;
            font-size: 13px;
            font-weight: 500;
            gap: 6px;
        }

        .tag-remove {
            cursor: pointer;
            font-weight: bold;
            font-size: 16px;
            line-height: 1;
            opacity: 0.8;
        }

        .tag-remove:hover {
            opacity: 1;
        }

        .table-tags {
            display: flex;
            flex-wrap: wrap;
            gap: 4px;
        }

        .table-tag {
            display: inline-block;
            background: #E8F4F8;
            color: #2C3E50;
            padding: 2px 8px;
            border-radius: 10px;
            font-size: 11px;
            font-weight: 500;
            white-space: nowrap;
        }

        .form-actions {
            display: flex;
            gap: 10px;
            margin-top: 25px;
        }

        .form-actions button {
            flex: 1;
        }

        .status-message {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 14px 45px 14px 20px;
            border-radius: 3px;
            background: white;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.15);
            z-index: 2000;
            animation: slideIn 0.2s ease;
            max-width: 400px;
            border-left: 3px solid;
        }

        .status-message.success {
            border-left-color: #27AE60;
        }

        .status-message.error {
            border-left-color: #E74C3C;
        }

        .status-message.warning {
            border-left-color: #F39C12;
        }

        .status-message .close-status {
            position: absolute;
            top: 10px;
            right: 12px;
            font-size: 20px;
            font-weight: 300;
            color: #95A5A6;
            cursor: pointer;
            line-height: 1;
            background: none;
            border: none;
            padding: 0;
        }

        .status-message .close-status:hover {
            color: #2C3E50;
        }

        @keyframes slideIn {
            from {
                transform: translateX(400px);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }

        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 3000;
        }

        .loading-overlay.show {
            display: flex;
        }

        .loading-content {
            background: white;
            padding: 30px 40px;
            border-radius: 5px;
            text-align: center;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
        }

        .loading-spinner {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #3498DB;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 0 auto 15px auto;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .loading-text {
            color: #2C3E50;
            font-size: 16px;
            font-weight: 500;
        }

        input[type="file"] {
            display: none;
        }

        .file-input-label {
            display: inline-block;
            padding: 9px 18px;
            background: #34495E;
            color: white;
            border-radius: 3px;
            cursor: pointer;
            font-weight: 500;
            transition: all 0.15s ease;
            font-size: 14px;
        }

        .file-input-label:hover {
            background: #2C3E50;
        }

        input:disabled,
        textarea:disabled,
        select:disabled {
            opacity: 0.6;
            background: #F5F5F5;
            cursor: not-allowed;
        }

        /* Details Table */
        .details-table-wrapper {
            overflow-x: auto;
            margin-top: 15px;
            border: 1px solid #E0E0E0;
            border-radius: 3px;
            max-width: 100%;
        }

        .details-table {
            border-collapse: collapse;
            font-size: 0.85em;
        }

        .details-table th {
            background-color: #34495E;
            color: #fff;
            padding: 6px 8px;
            text-align: left;
            border: 1px solid #2C3E50;
            font-weight: 500;
            font-size: 0.85em;
        }

        .details-table td {
            padding: 4px;
            border: 1px solid #E0E0E0;
        }

        .details-table tbody tr:nth-child(even) {
            background-color: #FAFAFA;
        }

        .details-table input,
        .details-table select {
            padding: 6px 8px;
            border: 1px solid #BDC3C7;
            border-radius: 3px;
            font-size: 1em;
            box-sizing: border-box;
        }

        .details-table input[type="number"],
        .details-table input[type="text"] {
            text-align: right;
            width: 90px;
        }

        .details-table input[type="date"] {
            text-align: left;
            width: 130px;
        }

        .details-table select {
            text-align: left;
            width: 115px;
        }

        .details-table input[type="checkbox"] {
            width: auto;
        }

        /* Cash Flows Table Column Widths */
        #cashFlowsTable {
            width: 100%;
        }

        #cashFlowsTable th:nth-child(1),
        #cashFlowsTable td:nth-child(1) {
            width: 20%;
        }

        #cashFlowsTable th:nth-child(2),
        #cashFlowsTable td:nth-child(2) {
            width: 20%;
        }

        #cashFlowsTable th:nth-child(3),
        #cashFlowsTable td:nth-child(3) {
            width: 25%;
        }

        #cashFlowsTable th:nth-child(4),
        #cashFlowsTable td:nth-child(4) {
            width: 25%;
            text-align: center;
        }

        #cashFlowsTable th:nth-child(5),
        #cashFlowsTable td:nth-child(5) {
            width: 10%;
            text-align: center;
        }

        /* NAV Table Column Widths */
        #navTable {
            width: 100%;
        }

        #navTable th:nth-child(1),
        #navTable td:nth-child(1) {
            width: 40%;
        }

        #navTable th:nth-child(2),
        #navTable td:nth-child(2) {
            width: 45%;
        }

        #navTable th:nth-child(3),
        #navTable td:nth-child(3) {
            width: 15%;
            text-align: center;
        }

        .delete-row-btn {
            background: #E74C3C;
            color: white;
            border: none;
            padding: 5px 10px;
            border-radius: 3px;
            cursor: pointer;
            font-size: 0.85em;
            font-weight: 500;
        }

        .delete-row-btn:hover {
            background: #C0392B;
        }

        .validation-error-row {
            background-color: #ffebee !important;
            border-left: 3px solid #E74C3C;
        }

        .validation-error-row input {
            border-color: #E74C3C !important;
        }

        #manageFundNamesModal .fund-name-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px;
            margin-bottom: 8px;
            background: #FAFAFA;
            border: 1px solid #E0E0E0;
            border-radius: 3px;
            gap: 10px;
        }

        #manageFundNamesModal .fund-name-item .btn-sm {
            margin-left: 5px;
        }

        /* Manage Groups Modal */
        .group-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 8px 10px;
            margin-bottom: 4px;
            background: #FAFAFA;
            border: 1px solid #E0E0E0;
            border-radius: 3px;
        }

        .group-item.level-0 {
            margin-left: 0;
            font-weight: 600;
        }

        .group-item.level-1 {
            margin-left: 20px;
            font-weight: 500;
        }

        .group-item.level-2 {
            margin-left: 40px;
        }

        .group-item.level-3 {
            margin-left: 60px;
        }

        .group-item-info {
            flex: 1;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .group-item-type {
            font-size: 0.85em;
            color: #7F8C8D;
            font-style: italic;
        }

        .group-item-actions {
            display: flex;
            gap: 5px;
        }

        @media (max-width: 1400px) {
            .controls-bar {
                flex-direction: column;
                align-items: stretch;
            }

            .control-group {
                width: 100%;
            }
        }

        /* Print Styles for PDF Export */
        @media print {
            body {
                background: white;
                padding: 0;
            }

            .container {
                box-shadow: none;
                border-radius: 0;
            }

            .controls-bar,
            .btn-sm,
            button {
                display: none !important;
            }

            header {
                background: white;
                color: #2C3E50;
                border-bottom: 2px solid #2C3E50;
                padding: 15px;
            }

            .content {
                padding: 15px;
            }

            table {
                min-width: 100%;
                page-break-inside: auto;
                border: 1px solid #2C3E50;
            }

            /* Override min-width for main table in print view */
            .table-container table {
                min-width: 100% !important;
            }

            thead {
                background: #2C3E50 !important;
                -webkit-print-color-adjust: exact;
                print-color-adjust: exact;
            }

            tr {
                page-break-inside: avoid;
                page-break-after: auto;
            }

            th, td {
                padding: 8px 6px;
                font-size: 10px;
            }

            /* Hide Actions column in print view */
            thead tr th:last-child,
            tbody tr td:last-child {
                display: none;
            }

            tbody tr:last-child {
                border-top: 2px solid #2C3E50;
                border-bottom: 2px solid #2C3E50;
                background: #F0F0F0 !important;
                -webkit-print-color-adjust: exact;
                print-color-adjust: exact;
            }

            .positive {
                color: #27AE60 !important;
                -webkit-print-color-adjust: exact;
                print-color-adjust: exact;
            }

            .negative {
                color: #E74C3C !important;
                -webkit-print-color-adjust: exact;
                print-color-adjust: exact;
            }

            @page {
                size: landscape;
                margin: 0.5in;
            }
        }

        /* Sidebar Styles */
        .sidebar-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            z-index: 9998;
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.3s ease, visibility 0.3s ease;
        }

        .sidebar-overlay.show {
            opacity: 1;
            visibility: visible;
        }

        .sidebar {
            position: fixed;
            top: 0;
            right: -320px;
            width: 320px;
            height: 100%;
            background: white;
            box-shadow: -2px 0 8px rgba(0, 0, 0, 0.15);
            z-index: 9999;
            transition: right 0.3s ease;
            display: flex;
            flex-direction: column;
        }

        .sidebar.show {
            right: 0;
        }

        .sidebar-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 20px;
            border-bottom: 1px solid #E0E0E0;
            background: #F8F9FA;
        }

        .sidebar-header h3 {
            margin: 0;
            color: #2C3E50;
            font-size: 18px;
            font-weight: 600;
        }

        .sidebar-close {
            background: none;
            border: none;
            font-size: 28px;
            color: #7F8C8D;
            cursor: pointer;
            padding: 0;
            width: 30px;
            height: 30px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 3px;
            transition: background 0.2s ease, color 0.2s ease;
        }

        .sidebar-close:hover {
            background: #E0E0E0;
            color: #2C3E50;
        }

        .sidebar-content {
            flex: 1;
            overflow-y: auto;
            padding: 10px 0;
        }

        .sidebar-section {
            margin-bottom: 10px;
        }

        .sidebar-section-title {
            padding: 12px 20px 8px;
            margin: 0;
            font-size: 12px;
            font-weight: 600;
            color: #7F8C8D;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .sidebar-item {
            padding: 0;
        }

        .sidebar-item a,
        .sidebar-import-label {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 12px 20px;
            color: #2C3E50;
            text-decoration: none;
            transition: background 0.2s ease;
            cursor: pointer;
            font-size: 14px;
        }

        .sidebar-item a:hover,
        .sidebar-import-label:hover {
            background: #F8F9FA;
        }

        .sidebar-item a span,
        .sidebar-import-label span {
            font-size: 18px;
            width: 24px;
            text-align: center;
        }

        .sidebar-checkbox-label {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 12px 20px;
            cursor: pointer;
            transition: background 0.2s ease;
            font-size: 14px;
        }

        .sidebar-checkbox-label:hover {
            background: #F8F9FA;
        }

        .sidebar-checkbox-label input[type="checkbox"] {
            width: 18px;
            height: 18px;
            cursor: pointer;
            margin: 0;
        }

        .sidebar-checkbox-label span {
            color: #2C3E50;
            flex: 1;
        }

        /* Adjust body when sidebar is open to prevent scroll issues */
        body.sidebar-open {
            overflow: hidden;
        }
    </style>
</head>
<body>
    <!-- Loading Overlay -->
    <div id="loadingOverlay" class="loading-overlay">
        <div class="loading-content">
            <div class="loading-spinner"></div>
            <div class="loading-text" id="loadingText">Loading...</div>
        </div>
    </div>

    <div class="container">
        <header>
            <h1 id="headerTitle">PE Fund Manager</h1>
            <p id="headerSubtitle">Private Equity Fund Analytics & Management Tool</p>
        </header>

        <div class="controls-bar">
            <div class="control-group">
                <label for="groupFilter">Filter by Group</label>
                <select id="groupFilter" onchange="applyFilters()">
                    <option value="">All Groups</option>
                </select>
            </div>
            <div class="control-group">
                <label for="fundFilter">Filter by Fund</label>
                <select id="fundFilter" onchange="applyFilters()">
                    <option value="">All Funds</option>
                </select>
            </div>
            <div class="control-group">
                <label for="accountFilter">Filter by Account</label>
                <select id="accountFilter" onchange="applyFilters()">
                    <option value="">All Accounts</option>
                </select>
            </div>
            <div class="control-group">
                <label for="searchInput">Search</label>
                <input type="text" id="searchInput" placeholder="Search funds..." oninput="applyFilters()" title="Search by fund name or account number" aria-label="Search funds by name or account number">
            </div>
            <div class="control-group">
                <label for="cutoffDate" title="Calculate all metrics (IRR, MOIC, NAV, etc.) as of this date">Cutoff Date</label>
                <input type="date" id="cutoffDate" onchange="applyFilters()" title="Calculate all metrics (IRR, MOIC, NAV, etc.) as of this date" aria-label="Cutoff date for calculating metrics">
            </div>
            <div class="control-group">
                <button class="btn-secondary" onclick="resetFilters()">Reset Filters</button>
            </div>
            <div style="margin-left: auto; display: flex; gap: 10px; align-items: center;">
                <button class="btn-primary" onclick="toggleSidebar()" title="Settings and Actions">
                    <span style="font-size: 18px;">‚öô</span> Menu
                </button>
            </div>
        </div>

        <div class="content">
            <div class="table-container">
                <table id="fundsTable">
                    <thead>
                        <tr>
                            <th onclick="sortTable('fundName')">Fund Name</th>
                            <th onclick="sortTable('accountNumber')" class="center">Account</th>
                            <th onclick="sortTable('vintage')" class="center">Vintage</th>
                            <th onclick="sortTable('commitment')" class="center number">Commitment</th>
                            <th onclick="sortTable('totalContributions')" class="center number">Contributions</th>
                            <th onclick="sortTable('totalDistributions')" class="center number">Distributions</th>
                            <th onclick="sortTable('nav')" class="center number">Value (NAV)</th>
                            <th onclick="sortTable('investmentReturn')" class="center number wrap-header">Investment<br>Return</th>
                            <th onclick="sortTable('moic')" class="center number">MOIC</th>
                            <th onclick="sortTable('irr')" class="center number">IRR</th>
                            <th onclick="sortTable('outstandingCommitment')" class="center number wrap-header">Outstanding<br>Commitment</th>
                            <th class="center">Actions</th>
                        </tr>
                    </thead>
                    <tbody id="fundsTableBody">
                        <!-- Data will be populated here -->
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- Fund Add/Edit Modal -->
    <div id="fundModal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closeFundModal()">&times;</span>
            <h2 id="fundModalTitle">Add New Investment</h2>
            <form id="fundForm" onsubmit="saveFund(event)">
                <input type="hidden" id="fundId">
                <input type="hidden" id="isDuplicate">

                <div class="form-group">
                    <label for="fundName">Fund Name *</label>
                    <select id="fundName" required></select>
                </div>

                <div class="form-group">
                    <label for="accountNumber">Account Number *</label>
                    <input type="text" id="accountNumber" required>
                </div>

                <div class="form-group">
                    <label for="fundGroup">Group (optional)</label>
                    <select id="fundGroup">
                        <option value="">No Group</option>
                    </select>
                </div>

                <div class="form-group">
                    <label for="commitment">Commitment (USD) *</label>
                    <input type="text" id="commitment" required placeholder="e.g., 1,000,000">
                </div>

                <div id="duplicateMultiplierContainer" class="form-group" style="display: none;">
                    <label for="duplicateMultiplier">Duplicate Multiplier</label>
                    <input type="number" id="duplicateMultiplier" step="any" value="1">
                </div>

                <div class="form-group">
                    <label for="cashFlows">Cash Flows (JSON)</label>
                    <textarea id="cashFlows" placeholder='[{"date":"2024-01-15","amount":-1000000,"type":"Contribution","affectsCommitment":true}]'></textarea>
                    <div class="hint">Format: [{"date":"YYYY-MM-DD","amount":number,"type":"Contribution|Distribution","affectsCommitment":true}]</div>
                </div>

                <div class="form-group">
                    <label for="monthlyNav">Monthly NAV (JSON)</label>
                    <textarea id="monthlyNav" placeholder='[{"date":"2024-01-31","amount":950000}]'></textarea>
                    <div class="hint">Format: [{"date":"YYYY-MM-DD","amount":number}]</div>
                </div>

                <div class="form-actions">
                    <button type="submit" class="btn-primary">Save</button>
                    <button type="button" class="btn-secondary" onclick="closeFundModal()">Cancel</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Action Modal -->
    <div id="actionModal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closeActionModal()">&times;</span>
            <h2>Fund Actions</h2>
            <p id="actionFundInfo" style="margin-bottom: 20px; color: #7F8C8D;"></p>
            <div class="form-actions">
                <button class="btn-info" onclick="editFundFromAction()">Edit</button>
                <button class="btn-secondary" onclick="duplicateFundFromAction()">Duplicate</button>
                <button class="btn-secondary" onclick="showDetailsFromAction()">Details</button>
                <button class="btn-danger" onclick="deleteFundFromAction()">Delete</button>
            </div>
        </div>
    </div>

    <!-- Manage Fund Names Modal -->
    <div id="manageFundNamesModal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closeManageFundsModal()">&times;</span>
            <h2>Manage Fund Names</h2>

            <div class="form-group">
                <label for="newFundNameInput">Add New Fund Name</label>
                <div style="display: flex; gap: 10px;">
                    <input type="text" id="newFundNameInput" style="flex: 1;" placeholder="Enter fund name">
                    <button class="btn-primary" onclick="addNewFundName()">Add</button>
                </div>
            </div>

            <hr style="margin: 20px 0; border: none; border-top: 1px solid #E0E0E0;">

            <h3 style="margin-bottom: 15px; color: #2C3E50; font-weight: 600; font-size: 1.1em;">Existing Fund Names</h3>
            <div id="fundNamesList"></div>

            <div class="form-actions">
                <button class="btn-secondary" onclick="closeManageFundsModal()">Close</button>
            </div>
        </div>
    </div>

    <!-- Edit Fund Name Modal -->
    <div id="editFundNameModal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closeEditFundNameModal()">&times;</span>
            <h2>Edit Fund</h2>

            <input type="hidden" id="editFundNameOriginal" value="">

            <div class="form-group">
                <label for="editFundNameInput">Fund Name</label>
                <input type="text" id="editFundNameInput" placeholder="Enter fund name">
            </div>

            <div class="form-group">
                <label for="editFundTags">Tags (optional)</label>
                <div id="editFundTagsContainer" class="tags-container"></div>
                <input type="text" id="editFundTagsInput" placeholder="Add tag (e.g., Venture Capital, Growth Equity)" list="editFundTagsDatalist">
                <datalist id="editFundTagsDatalist"></datalist>
                <div class="hint">Press Enter to add tags. Click √ó on a tag to remove it.</div>
            </div>

            <div class="form-actions">
                <button class="btn-primary" onclick="saveEditedFundName()">Save Changes</button>
                <button class="btn-secondary" onclick="closeEditFundNameModal()">Cancel</button>
            </div>
        </div>
    </div>

    <!-- Manage Groups Modal -->
    <div id="manageGroupsModal" class="modal">
        <div class="modal-content" style="max-width: 600px;">
            <span class="close" onclick="closeManageGroupsModal()">&times;</span>
            <h2>Manage Account Groups</h2>

            <input type="hidden" id="editGroupId" value="">
            <h3 id="groupFormTitle" style="margin-bottom: 15px; color: #2C3E50; font-weight: 600; font-size: 1.1em;">Add New Group</h3>

            <div class="form-group">
                <label for="newGroupName">Group Name</label>
                <input type="text" id="newGroupName" placeholder="Enter group name">
            </div>

            <div class="form-group">
                <label for="newGroupParent">Parent Group (optional)</label>
                <select id="newGroupParent">
                    <option value="">None (Top Level)</option>
                </select>
            </div>

            <div class="form-group">
                <label for="newGroupType">Type (optional)</label>
                <input type="text" id="newGroupType" placeholder="e.g., Client, Trust, Account">
            </div>

            <div style="display: flex; gap: 10px;">
                <button id="saveGroupBtn" class="btn-primary" onclick="saveGroupChanges()">Add Group</button>
                <button id="cancelEditBtn" class="btn-secondary" onclick="cancelGroupEdit()" style="display: none;">Cancel</button>
            </div>

            <hr style="margin: 20px 0; border: none; border-top: 1px solid #E0E0E0;">

            <h3 style="margin-bottom: 15px; color: #2C3E50; font-weight: 600; font-size: 1.1em;">Existing Groups</h3>
            <div id="groupsList" style="max-height: 400px; overflow-y: auto;"></div>

            <div class="form-actions">
                <button class="btn-secondary" onclick="closeManageGroupsModal()">Close</button>
            </div>
        </div>
    </div>

    <!-- Details Modal -->
    <div id="detailsModal" class="modal">
        <div class="modal-content" style="max-width: 900px;">
            <span class="close" onclick="closeDetailsModal()">&times;</span>
            <h2 id="detailsModalTitle">Fund Details</h2>
            <p id="detailsModalSubtitle" style="margin: 5px 0 0 0; color: #95A5A6; font-size: 0.9em;"></p>

            <h3 style="margin-top: 20px; color: #2C3E50; font-weight: 600; font-size: 1.1em;">Cash Flows</h3>
            <div class="details-table-wrapper">
                <table class="details-table" id="cashFlowsTable">
                    <thead>
                        <tr>
                            <th>Date</th>
                            <th>Amount (USD)</th>
                            <th>Type</th>
                            <th>Affects Commitment?</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody></tbody>
                </table>
            </div>
            <button type="button" class="btn-primary btn-sm" style="margin-top: 10px;" onclick="addCashFlowRow()">Add Cash Flow</button>

            <h3 style="margin-top: 30px; color: #2C3E50; font-weight: 600; font-size: 1.1em;">Monthly NAV</h3>
            <div class="details-table-wrapper">
                <table class="details-table" id="navTable">
                    <thead>
                        <tr>
                            <th>Date</th>
                            <th>Amount (USD)</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody></tbody>
                </table>
            </div>
            <button type="button" class="btn-primary btn-sm" style="margin-top: 10px;" onclick="addNavRow()">Add NAV</button>

            <div class="form-actions">
                <button class="btn-primary" onclick="saveDetailsChanges()">Save Changes</button>
                <button class="btn-secondary" onclick="closeDetailsModal()">Cancel</button>
            </div>
        </div>
    </div>

    <!-- Sidebar Panel -->
    <div id="sidebarOverlay" class="sidebar-overlay" onclick="closeSidebar()"></div>
    <div id="sidebar" class="sidebar">
        <div class="sidebar-header">
            <h3>Settings & Actions</h3>
            <button class="sidebar-close" onclick="closeSidebar()" title="Close">&times;</button>
        </div>
        <div class="sidebar-content">
            <!-- View Options Section -->
            <div class="sidebar-section">
                <h4 class="sidebar-section-title">View Options</h4>
                <div class="sidebar-item">
                    <label class="sidebar-checkbox-label">
                        <input type="checkbox" id="sidebarShowTagsCheckbox" onchange="toggleTagsDisplay()" checked>
                        <span>Show Tags</span>
                    </label>
                </div>
            </div>

            <!-- Manage Section -->
            <div class="sidebar-section">
                <h4 class="sidebar-section-title">Manage</h4>
                <div class="sidebar-item">
                    <a href="#" onclick="closeSidebar(); showAddFundModal(); return false;">
                        <span>üìù</span> New Investment
                    </a>
                </div>
                <div class="sidebar-item">
                    <a href="#" onclick="closeSidebar(); showManageFundsModal(); return false;">
                        <span>üìã</span> Manage Funds
                    </a>
                </div>
                <div class="sidebar-item">
                    <a href="#" onclick="closeSidebar(); showManageGroupsModal(); return false;">
                        <span>üìÅ</span> Manage Groups
                    </a>
                </div>
            </div>

            <!-- Data Section -->
            <div class="sidebar-section">
                <h4 class="sidebar-section-title">Data</h4>
                <div class="sidebar-item">
                    <a href="#" onclick="closeSidebar(); exportToCSV(); return false;">
                        <span>üìä</span> Export to CSV
                    </a>
                </div>
                <div class="sidebar-item">
                    <a href="#" onclick="closeSidebar(); exportDatabase(); return false;">
                        <span>üíæ</span> Export to JSON
                    </a>
                </div>
                <div class="sidebar-item">
                    <a href="#" onclick="closeSidebar(); exportToPDF(); return false;">
                        <span>üìÑ</span> Export to PDF
                    </a>
                </div>
                <div class="sidebar-item">
                    <label for="sidebarImportFile" class="sidebar-import-label">
                        <span>üì•</span> Import JSON
                    </label>
                    <input type="file" id="sidebarImportFile" accept=".json" onchange="importDatabase(event); closeSidebar();" style="display: none;">
                </div>
            </div>
        </div>
    </div>

    <script>
        // ===========================
        // IndexedDB Operations
        // ===========================

        let db;
        let dbReady = false;
        const DB_NAME = 'FundsDB';
        const FUNDS_STORE = 'funds';
        const FUNDNAMES_STORE = 'fundNames';
        const GROUPS_STORE = 'groups';
        const DB_VERSION = 6;

        let currentFunds = [];
        let fundNames = new Set(); // Just the names for quick lookup
        let fundNameData = new Map(); // Full data: name -> { name, tags }
        let groups = [];
        let currentGroupDescendants = null; // Cache for selected group and its descendants
        let sortColumn = null;
        let sortDirection = 'asc';
        let currentActionFundId = null;
        let currentDetailsFundId = null;
        let hasUnsavedChanges = false;

        function initDB() {
            return new Promise((resolve, reject) => {
                const request = indexedDB.open(DB_NAME, DB_VERSION);

                request.onerror = () => reject(request.error);
                request.onsuccess = () => {
                    db = request.result;
                    dbReady = true;
                    resolve(db);
                };

                request.onupgradeneeded = (event) => {
                    const db = event.target.result;
                    const oldVersion = event.oldVersion;
                    const transaction = event.target.transaction;

                    // Funds store
                    if (!db.objectStoreNames.contains(FUNDS_STORE)) {
                        const fundsStore = db.createObjectStore(FUNDS_STORE, {
                            keyPath: 'id',
                            autoIncrement: true
                        });
                        fundsStore.createIndex('fundName', 'fundName', { unique: false });
                        fundsStore.createIndex('accountNumber', 'accountNumber', { unique: false });
                    }

                    // Fund names store
                    if (!db.objectStoreNames.contains(FUNDNAMES_STORE)) {
                        db.createObjectStore(FUNDNAMES_STORE, { keyPath: 'name' });
                    }

                    // Groups store
                    if (!db.objectStoreNames.contains(GROUPS_STORE)) {
                        const groupsStore = db.createObjectStore(GROUPS_STORE, {
                            keyPath: 'id',
                            autoIncrement: true
                        });
                        groupsStore.createIndex('parentGroupId', 'parentGroupId', { unique: false });
                        groupsStore.createIndex('name', 'name', { unique: false });
                    }

                    // Migrate from v5 to v6: Move tags from investments to fund names
                    if (oldVersion < 6 && oldVersion >= 5) {
                        // Delete old tags store
                        if (db.objectStoreNames.contains('tags')) {
                            db.deleteObjectStore('tags');
                        }

                        // Get all funds and extract unique fund names with their tags
                        const fundsStore = transaction.objectStore(FUNDS_STORE);
                        const fundNamesStore = transaction.objectStore(FUNDNAMES_STORE);

                        const fundNameTagsMap = new Map(); // fundName -> Set of tags

                        fundsStore.openCursor().onsuccess = function(event) {
                            const cursor = event.target.result;
                            if (cursor) {
                                const fund = cursor.value;
                                if (fund.tags && Array.isArray(fund.tags) && fund.tags.length > 0) {
                                    if (!fundNameTagsMap.has(fund.fundName)) {
                                        fundNameTagsMap.set(fund.fundName, new Set());
                                    }
                                    fund.tags.forEach(tag => fundNameTagsMap.get(fund.fundName).add(tag));
                                }

                                // Remove tags from fund
                                delete fund.tags;
                                cursor.update(fund);

                                cursor.continue();
                            } else {
                                // Cursor finished - now update all fund names with their tags
                                fundNamesStore.getAll().onsuccess = function(event) {
                                    const fundNames = event.target.result;
                                    fundNames.forEach(fundNameObj => {
                                        const name = fundNameObj.name;
                                        const tags = fundNameTagsMap.has(name)
                                            ? Array.from(fundNameTagsMap.get(name))
                                            : [];
                                        fundNamesStore.put({ name, tags });
                                    });
                                };
                            }
                        };
                    }
                };
            });
        }

        function saveFundToDB(fundData) {
            return new Promise((resolve, reject) => {
                if (!db) {
                    reject(new Error('Database not initialized'));
                    return;
                }

                const transaction = db.transaction([FUNDS_STORE], 'readwrite');
                const objectStore = transaction.objectStore(FUNDS_STORE);

                let request;
                if (fundData.id) {
                    request = objectStore.put(fundData);
                } else {
                    delete fundData.id;
                    request = objectStore.add(fundData);
                }

                request.onsuccess = () => resolve(request.result);
                request.onerror = () => reject(request.error);
            });
        }

        function getAllFunds() {
            return new Promise((resolve, reject) => {
                if (!db) {
                    reject(new Error('Database not initialized'));
                    return;
                }

                const transaction = db.transaction([FUNDS_STORE], 'readonly');
                const objectStore = transaction.objectStore(FUNDS_STORE);
                const request = objectStore.getAll();

                request.onsuccess = () => resolve(request.result);
                request.onerror = () => reject(request.error);
            });
        }

        function getFundById(id) {
            return new Promise((resolve, reject) => {
                if (!db) {
                    reject(new Error('Database not initialized'));
                    return;
                }

                const transaction = db.transaction([FUNDS_STORE], 'readonly');
                const objectStore = transaction.objectStore(FUNDS_STORE);
                const request = objectStore.get(id);

                request.onsuccess = () => resolve(request.result);
                request.onerror = () => reject(request.error);
            });
        }

        function deleteFundFromDB(id) {
            return new Promise((resolve, reject) => {
                if (!db) {
                    reject(new Error('Database not initialized'));
                    return;
                }

                const transaction = db.transaction([FUNDS_STORE], 'readwrite');
                const objectStore = transaction.objectStore(FUNDS_STORE);
                const request = objectStore.delete(id);

                request.onsuccess = () => resolve();
                request.onerror = () => reject(request.error);
            });
        }

        // Get all fund name objects (with name and tags)
        function getAllFundNameObjects() {
            return new Promise((resolve, reject) => {
                if (!db) {
                    reject(new Error('Database not initialized'));
                    return;
                }

                const transaction = db.transaction([FUNDNAMES_STORE], 'readonly');
                const objectStore = transaction.objectStore(FUNDNAMES_STORE);
                const request = objectStore.getAll();

                request.onsuccess = () => {
                    // Ensure all objects have tags array
                    const objects = request.result.map(item => ({
                        name: item.name,
                        tags: item.tags || []
                    }));
                    resolve(objects);
                };
                request.onerror = () => reject(request.error);
            });
        }

        // Get just the fund names (for backward compatibility)
        function getAllFundNames() {
            return new Promise((resolve, reject) => {
                getAllFundNameObjects()
                    .then(objects => resolve(objects.map(obj => obj.name)))
                    .catch(reject);
            });
        }

        // Save or update a fund name (pass string for just name, or object with {name, tags})
        function saveFundName(nameOrObject) {
            return new Promise((resolve, reject) => {
                if (!db) {
                    reject(new Error('Database not initialized'));
                    return;
                }

                const fundNameObj = typeof nameOrObject === 'string'
                    ? { name: nameOrObject, tags: [] }
                    : { name: nameOrObject.name, tags: nameOrObject.tags || [] };

                const transaction = db.transaction([FUNDNAMES_STORE], 'readwrite');
                const objectStore = transaction.objectStore(FUNDNAMES_STORE);
                const request = objectStore.put(fundNameObj);

                request.onsuccess = () => resolve();
                request.onerror = () => reject(request.error);
            });
        }

        function deleteFundName(name) {
            return new Promise((resolve, reject) => {
                if (!db) {
                    reject(new Error('Database not initialized'));
                    return;
                }

                const transaction = db.transaction([FUNDNAMES_STORE], 'readwrite');
                const objectStore = transaction.objectStore(FUNDNAMES_STORE);
                const request = objectStore.delete(name);

                request.onsuccess = () => resolve();
                request.onerror = () => reject(request.error);
            });
        }

        // ===========================
        // Groups Database Operations
        // ===========================

        function getAllGroups() {
            return new Promise((resolve, reject) => {
                if (!db) {
                    reject(new Error('Database not initialized'));
                    return;
                }

                const transaction = db.transaction([GROUPS_STORE], 'readonly');
                const objectStore = transaction.objectStore(GROUPS_STORE);
                const request = objectStore.getAll();

                request.onsuccess = () => resolve(request.result);
                request.onerror = () => reject(request.error);
            });
        }

        function saveGroup(groupData) {
            return new Promise((resolve, reject) => {
                if (!db) {
                    reject(new Error('Database not initialized'));
                    return;
                }

                const transaction = db.transaction([GROUPS_STORE], 'readwrite');
                const objectStore = transaction.objectStore(GROUPS_STORE);
                const request = objectStore.put(groupData);

                request.onsuccess = () => resolve(request.result);
                request.onerror = () => reject(request.error);
            });
        }

        function deleteGroup(id) {
            return new Promise((resolve, reject) => {
                if (!db) {
                    reject(new Error('Database not initialized'));
                    return;
                }

                const transaction = db.transaction([GROUPS_STORE], 'readwrite');
                const objectStore = transaction.objectStore(GROUPS_STORE);
                const request = objectStore.delete(id);

                request.onsuccess = () => resolve();
                request.onerror = () => reject(request.error);
            });
        }

        function getGroupsByParent(parentGroupId) {
            return new Promise((resolve, reject) => {
                if (!db) {
                    reject(new Error('Database not initialized'));
                    return;
                }

                const transaction = db.transaction([GROUPS_STORE], 'readonly');
                const objectStore = transaction.objectStore(GROUPS_STORE);
                const index = objectStore.index('parentGroupId');
                const request = index.getAll(parentGroupId);

                request.onsuccess = () => resolve(request.result);
                request.onerror = () => reject(request.error);
            });
        }

        function getGroupById(id) {
            return new Promise((resolve, reject) => {
                if (!db) {
                    reject(new Error('Database not initialized'));
                    return;
                }

                const transaction = db.transaction([GROUPS_STORE], 'readonly');
                const objectStore = transaction.objectStore(GROUPS_STORE);
                const request = objectStore.get(id);

                request.onsuccess = () => resolve(request.result);
                request.onerror = () => reject(request.error);
            });
        }

        // Helper function to get all descendant group IDs recursively
        async function getAllDescendantGroupIds(groupId) {
            const descendants = [groupId];
            const children = await getGroupsByParent(groupId);

            for (const child of children) {
                const childDescendants = await getAllDescendantGroupIds(child.id);
                descendants.push(...childDescendants);
            }

            return descendants;
        }

        // ===========================
        // Calculation Functions
        // ===========================

        function parseCurrency(val) {
            if (val === null || typeof val === 'undefined') return NaN;
            if (typeof val === 'number') return isFinite(val) ? val : NaN;
            if (typeof val === 'string') {
                const cleaned = val.replace(/[$,]/g, '').replace(/^\((.*)\)$/, '-$1').trim();
                if (cleaned === '') return NaN;
                const num = parseFloat(cleaned);
                return isFinite(num) ? num : NaN;
            }
            return NaN;
        }

        function formatNumberWithCommas(num) {
            if (num === null || num === undefined || isNaN(num)) return '';
            // Format with commas and up to 2 decimal places if needed
            const parts = num.toString().split('.');
            parts[0] = parts[0].replace(/\B(?=(\d{3})+(?!\d))/g, ',');
            return parts.join('.');
        }

        function formatCurrency(value, showCents = false) {
            const val = parseFloat(value);
            if (!isFinite(val) || isNaN(val)) return '$0';
            return val.toLocaleString('en-US', {
                style: 'currency',
                currency: 'USD',
                minimumFractionDigits: showCents ? 2 : 0,
                maximumFractionDigits: showCents ? 2 : 0
            });
        }

        function isValidDate(dateStr) {
            if (typeof dateStr !== 'string' || !/^\d{4}-\d{2}-\d{2}$/.test(dateStr)) {
                return false;
            }
            const date = new Date(dateStr);
            return !isNaN(date.getTime());
        }

        function getVintageYear(fund) {
            const contributions = (fund.cashFlows || [])
                .filter(cf => cf.type === 'Contribution' && isValidDate(cf.date))
                .sort((a, b) => new Date(a.date) - new Date(b.date));

            return contributions.length > 0 ? new Date(contributions[0].date).getFullYear() : null;
        }

        function getTotalByType(fund, type, cutoffDate) {
            return (fund.cashFlows || [])
                .filter(cf =>
                    cf.type === type &&
                    isValidDate(cf.date) &&
                    (!cutoffDate || new Date(cf.date) <= cutoffDate)
                )
                .reduce((sum, cf) => sum + Math.abs(parseCurrency(cf.amount) || 0), 0);
        }

        function getLatestNav(fund, cutoffDate) {
            const navs = (fund.monthlyNav || [])
                .filter(n => isValidDate(n.date) && (!cutoffDate || new Date(n.date) <= cutoffDate))
                .sort((a, b) => new Date(b.date) - new Date(a.date));

            if (navs.length === 0) return 0;

            const latestNav = navs[0];
            let navAmount = parseCurrency(latestNav.amount) || 0;
            const navDate = new Date(latestNav.date);

            // Adjust for cash flows after NAV date
            const subsequentFlows = (fund.cashFlows || []).filter(cf => {
                if (!isValidDate(cf.date)) return false;
                const cfDate = new Date(cf.date);
                return cfDate > navDate && (!cutoffDate || cfDate <= cutoffDate);
            });

            subsequentFlows.forEach(cf => {
                const amount = parseCurrency(cf.amount) || 0;
                if (cf.type === 'Contribution') {
                    navAmount -= Math.abs(amount);
                } else if (cf.type === 'Distribution') {
                    navAmount += Math.abs(amount);
                }
            });

            return navAmount;
        }

        function getOutstandingCommitment(fund, cutoffDate) {
            let outstanding = parseCurrency(fund.commitment) || 0;

            (fund.cashFlows || [])
                .filter(cf =>
                    isValidDate(cf.date) &&
                    (!cutoffDate || new Date(cf.date) <= cutoffDate) &&
                    cf.affectsCommitment !== false
                )
                .forEach(cf => {
                    if (cf.type === 'Contribution') {
                        const amount = parseCurrency(cf.amount) || 0;
                        outstanding -= Math.abs(amount);
                    }
                });

            return Math.max(0, outstanding);
        }

        function parseCashFlowsForIRR(fund, cutoffDate) {
            const flows = (fund.cashFlows || [])
                .filter(cf => isValidDate(cf.date) && (!cutoffDate || new Date(cf.date) <= cutoffDate))
                .map(cf => {
                    const amount = parseCurrency(cf.amount) || 0;
                    return {
                        date: cf.date,
                        amount: cf.type === 'Contribution' ? -Math.abs(amount) : Math.abs(amount)
                    };
                });

            // Add NAV as final cash flow (include zero NAV for accurate IRR calculation)
            const nav = getLatestNav(fund, cutoffDate);
            if (nav >= 0) {
                const navs = (fund.monthlyNav || [])
                    .filter(n => isValidDate(n.date) && (!cutoffDate || new Date(n.date) <= cutoffDate))
                    .sort((a, b) => new Date(b.date) - new Date(a.date));

                if (navs.length > 0) {
                    flows.push({ date: navs[0].date, amount: nav });
                }
            }

            return flows.sort((a, b) => new Date(a.date) - new Date(b.date));
        }

        function calculateIRR(cashFlows, guess = 0.1) {
            if (!Array.isArray(cashFlows) || cashFlows.length < 2) return null;

            const flows = [...cashFlows].sort((a, b) => new Date(a.date) - new Date(b.date));
            const firstDate = new Date(flows[0].date);

            const npv = rate => flows.reduce((acc, cf) => {
                const yearsDiff = (new Date(cf.date) - firstDate) / (365.25 * 24 * 60 * 60 * 1000);
                return acc + cf.amount / Math.pow(1 + rate, yearsDiff);
            }, 0);

            const dNpv = rate => flows.reduce((acc, cf) => {
                const yearsDiff = (new Date(cf.date) - firstDate) / (365.25 * 24 * 60 * 60 * 1000);
                if (yearsDiff === 0) return acc;
                return acc - (yearsDiff * cf.amount) / Math.pow(1 + rate, yearsDiff + 1);
            }, 0);

            let rate = guess;
            const maxIterations = 1000;
            const precision = 1e-6;

            for (let i = 0; i < maxIterations; i++) {
                const npvValue = npv(rate);
                const derivativeValue = dNpv(rate);

                if (Math.abs(npvValue) < precision) {
                    if (rate > 10 || rate < -1) return null;
                    return rate;
                }
                if (Math.abs(derivativeValue) < precision) return null;

                const newRate = rate - npvValue / derivativeValue;
                if (Math.abs(newRate - rate) < precision) {
                    if (newRate > 10 || newRate < -1) return null;
                    return newRate;
                }

                rate = newRate;
            }

            return null;
        }

        function calculateMOIC(cashFlows) {
            if (!Array.isArray(cashFlows) || cashFlows.length === 0) return null;

            const contributions = cashFlows
                .filter(f => f.amount < 0)
                .reduce((sum, f) => sum + Math.abs(f.amount), 0);

            const distributions = cashFlows
                .filter(f => f.amount > 0)
                .reduce((sum, f) => sum + f.amount, 0);

            // Cannot calculate meaningful MOIC without contributions
            if (contributions === 0) return null;
            return distributions / contributions;
        }

        function calculateMetrics(fund, cutoffDate) {
            const commitment = parseCurrency(fund.commitment) || 0;
            const totalContributions = getTotalByType(fund, 'Contribution', cutoffDate);
            const totalDistributions = getTotalByType(fund, 'Distribution', cutoffDate);
            const nav = getLatestNav(fund, cutoffDate);
            const outstandingCommitment = getOutstandingCommitment(fund, cutoffDate);
            const investmentReturn = totalDistributions + nav - totalContributions;
            const vintage = getVintageYear(fund);

            const cashFlowsForIRR = parseCashFlowsForIRR(fund, cutoffDate);
            const irr = calculateIRR(cashFlowsForIRR);
            const moic = calculateMOIC(cashFlowsForIRR);

            return {
                commitment,
                totalContributions,
                totalDistributions,
                nav,
                outstandingCommitment,
                investmentReturn,
                vintage,
                irr,
                moic
            };
        }

        function getLatestQuarterEnd() {
            const now = new Date();
            const currentMonth = now.getMonth();
            const currentQuarter = Math.floor(currentMonth / 3);
            const quarterStartMonth = currentQuarter * 3;
            return new Date(now.getFullYear(), quarterStartMonth, 0);
        }

        // ===========================
        // UI Functions
        // ===========================

        function showStatus(message, type = 'success') {
            const statusDiv = document.createElement('div');
            statusDiv.className = `status-message ${type}`;

            // Create close button
            const closeBtn = document.createElement('button');
            closeBtn.className = 'close-status';
            closeBtn.innerHTML = '&times;';
            closeBtn.onclick = () => statusDiv.remove();

            // Create message text
            const messageText = document.createElement('span');
            messageText.textContent = message;

            statusDiv.appendChild(messageText);
            statusDiv.appendChild(closeBtn);
            document.body.appendChild(statusDiv);

            // Auto-dismiss messages: success after 3s, errors/warnings after 8s
            const dismissTime = type === 'success' ? 3000 : 8000;
            setTimeout(() => {
                if (statusDiv.parentNode) {
                    statusDiv.remove();
                }
            }, dismissTime);
        }

        function showLoading(message = 'Loading...') {
            const overlay = document.getElementById('loadingOverlay');
            const text = document.getElementById('loadingText');
            text.textContent = message;
            overlay.classList.add('show');
        }

        function hideLoading() {
            const overlay = document.getElementById('loadingOverlay');
            overlay.classList.remove('show');
        }

        async function renderTable() {
            try {
                const funds = await getAllFunds();
                currentFunds = funds;

                // Apply filters
                let filtered = applyCurrentFilters(funds);

                // Apply sorting
                if (sortColumn) {
                    filtered = sortData(filtered, sortColumn, sortDirection);
                }

                // Update filter dropdowns
                updateFilterDropdowns(funds);

                // Get cutoff date
                const cutoffDateValue = document.getElementById('cutoffDate').value;
                const cutoffDate = cutoffDateValue ? new Date(cutoffDateValue) : null;

                // Calculate metrics for each fund
                const fundsWithMetrics = filtered.map(fund => ({
                    ...fund,
                    metrics: calculateMetrics(fund, cutoffDate)
                }));

                // Render table body
                const tbody = document.getElementById('fundsTableBody');
                tbody.innerHTML = '';

                if (fundsWithMetrics.length === 0) {
                    tbody.innerHTML = `
                        <tr>
                            <td colspan="12" class="empty-state">
                                <div style="padding: 40px;">
                                    <h3 style="margin-bottom: 10px;">No investments found</h3>
                                    <p>Click "New Investment" to add your first fund</p>
                                </div>
                            </td>
                        </tr>
                    `;
                    return;
                }

                fundsWithMetrics.forEach(fund => {
                    const m = fund.metrics;
                    const row = document.createElement('tr');

                    // Build tags HTML - look up tags from fund name
                    const showTags = document.getElementById('sidebarShowTagsCheckbox').checked;
                    const fundNameObj = fundNameData.get(fund.fundName);
                    const tags = fundNameObj && fundNameObj.tags ? fundNameObj.tags : [];
                    const tagsHtml = (showTags && tags.length > 0)
                        ? `<div class="table-tags">${tags.map(tag => `<span class="table-tag">${escapeHtml(tag)}</span>`).join('')}</div>`
                        : '';

                    row.innerHTML = `
                        <td>
                            <div>${escapeHtml(fund.fundName)}</div>
                            ${tagsHtml}
                        </td>
                        <td>${escapeHtml(fund.accountNumber)}</td>
                        <td class="center">${m.vintage || 'N/A'}</td>
                        <td class="number">${formatCurrency(m.commitment)}</td>
                        <td class="number">${formatCurrency(m.totalContributions)}</td>
                        <td class="number">${formatCurrency(m.totalDistributions)}</td>
                        <td class="number">${formatCurrency(m.nav)}</td>
                        <td class="number ${m.investmentReturn >= 0 ? 'positive' : 'negative'}">${formatCurrency(m.investmentReturn)}</td>
                        <td class="number">${m.moic !== null && isFinite(m.moic) ? m.moic.toFixed(2) + 'x' : 'N/A'}</td>
                        <td class="number ${m.irr !== null && m.irr >= 0 ? 'positive' : 'negative'}">${m.irr !== null ? (m.irr * 100).toFixed(2) + '%' : 'N/A'}</td>
                        <td class="number">${formatCurrency(m.outstandingCommitment)}</td>
                        <td>
                            <button class="btn-sm btn-info fund-actions-btn" data-fund-id="${fund.id}">Actions</button>
                        </td>
                    `;

                    tbody.appendChild(row);
                });

                // Add totals row
                addTotalsRow(fundsWithMetrics, cutoffDate);

            } catch (err) {
                console.error('Error rendering table:', err);
                showStatus('Error loading data: ' + err.message, 'error');
            }
        }

        function addTotalsRow(fundsWithMetrics, cutoffDate) {
            const tbody = document.getElementById('fundsTableBody');

            // Calculate totals
            const totals = {
                commitment: 0,
                totalContributions: 0,
                totalDistributions: 0,
                nav: 0,
                investmentReturn: 0,
                outstandingCommitment: 0,
                aggregateFlows: []
            };

            fundsWithMetrics.forEach(fund => {
                const m = fund.metrics;
                totals.commitment += m.commitment;
                totals.totalContributions += m.totalContributions;
                totals.totalDistributions += m.totalDistributions;
                totals.nav += m.nav;
                totals.investmentReturn += m.investmentReturn;
                totals.outstandingCommitment += m.outstandingCommitment;

                const flows = parseCashFlowsForIRR(fund, cutoffDate);
                totals.aggregateFlows.push(...flows);
            });

            // Calculate aggregate IRR and MOIC
            const aggregateIRR = calculateIRR(totals.aggregateFlows);
            const aggregateMOIC = calculateMOIC(totals.aggregateFlows);

            const totalRow = document.createElement('tr');
            totalRow.innerHTML = `
                <td><strong>Total</strong></td>
                <td></td>
                <td></td>
                <td class="number"><strong>${formatCurrency(totals.commitment)}</strong></td>
                <td class="number"><strong>${formatCurrency(totals.totalContributions)}</strong></td>
                <td class="number"><strong>${formatCurrency(totals.totalDistributions)}</strong></td>
                <td class="number"><strong>${formatCurrency(totals.nav)}</strong></td>
                <td class="number ${totals.investmentReturn >= 0 ? 'positive' : 'negative'}"><strong>${formatCurrency(totals.investmentReturn)}</strong></td>
                <td class="number"><strong>${aggregateMOIC !== null && isFinite(aggregateMOIC) ? aggregateMOIC.toFixed(2) + 'x' : 'N/A'}</strong></td>
                <td class="number ${aggregateIRR !== null && aggregateIRR >= 0 ? 'positive' : 'negative'}"><strong>${aggregateIRR !== null ? (aggregateIRR * 100).toFixed(2) + '%' : 'N/A'}</strong></td>
                <td class="number"><strong>${formatCurrency(totals.outstandingCommitment)}</strong></td>
                <td></td>
            `;

            tbody.appendChild(totalRow);
        }

        function applyCurrentFilters(funds) {
            const fundFilter = document.getElementById('fundFilter').value;
            const accountFilter = document.getElementById('accountFilter').value;
            const groupFilter = document.getElementById('groupFilter').value;
            const searchInput = document.getElementById('searchInput').value.toLowerCase().trim();

            return funds.filter(fund => {
                if (fundFilter && fund.fundName !== fundFilter) return false;
                if (accountFilter && fund.accountNumber !== accountFilter) return false;
                if (groupFilter) {
                    // Check if fund's groupId matches or is descendant of selected group
                    const groupId = parseInt(groupFilter);
                    if (!fund.groupId) return false;
                    if (!currentGroupDescendants || currentGroupDescendants.groupId !== groupId) {
                        return false; // Will be set by async filter
                    }
                    if (!currentGroupDescendants.ids.includes(fund.groupId)) return false;
                }
                // Search filter: check fund name, account number, and tags
                if (searchInput) {
                    const fundName = (fund.fundName || '').toLowerCase();
                    const accountNumber = (fund.accountNumber || '').toLowerCase();
                    // Look up tags from fund name data
                    const fundNameObj = fundNameData.get(fund.fundName);
                    const tags = fundNameObj && fundNameObj.tags ? fundNameObj.tags : [];
                    const fundTags = tags.map(tag => tag.toLowerCase()).join(' ');
                    if (!fundName.includes(searchInput) &&
                        !accountNumber.includes(searchInput) &&
                        !fundTags.includes(searchInput)) {
                        return false;
                    }
                }
                return true;
            });
        }

        function updateFilterDropdowns(funds) {
            // Update fund filter
            const fundFilter = document.getElementById('fundFilter');
            const currentFundValue = fundFilter.value;
            const uniqueFunds = [...new Set(funds.map(f => f.fundName))].sort();

            fundFilter.innerHTML = '<option value="">All Funds</option>';
            uniqueFunds.forEach(name => {
                const option = document.createElement('option');
                option.value = name;
                option.textContent = name;
                fundFilter.appendChild(option);
            });
            fundFilter.value = currentFundValue;

            // Update account filter
            const accountFilter = document.getElementById('accountFilter');
            const currentAccountValue = accountFilter.value;
            const uniqueAccounts = [...new Set(funds.map(f => f.accountNumber))].sort();

            accountFilter.innerHTML = '<option value="">All Accounts</option>';
            uniqueAccounts.forEach(account => {
                const option = document.createElement('option');
                option.value = account;
                option.textContent = account;
                accountFilter.appendChild(option);
            });
            accountFilter.value = currentAccountValue;

            // Update group filter
            const groupFilter = document.getElementById('groupFilter');
            const currentGroupValue = groupFilter.value;

            groupFilter.innerHTML = '<option value="">All Groups</option>';
            if (groups.length > 0) {
                const tree = buildGroupsTree(groups, null);
                addGroupOptionsToSelect(groupFilter, tree, 0);
            }
            groupFilter.value = currentGroupValue;
        }

        async function applyFilters() {
            const groupFilterValue = document.getElementById('groupFilter').value;

            // Precompute descendants if group filter is active
            if (groupFilterValue) {
                const groupId = parseInt(groupFilterValue);
                const descendants = await getAllDescendantGroupIds(groupId);
                currentGroupDescendants = { groupId, ids: descendants };
            } else {
                currentGroupDescendants = null;
            }

            // Update header based on selected group
            updateHeader();

            renderTable();
        }

        function updateHeader() {
            const groupFilterValue = document.getElementById('groupFilter').value;
            const headerTitle = document.getElementById('headerTitle');
            const headerSubtitle = document.getElementById('headerSubtitle');

            if (groupFilterValue) {
                const groupId = parseInt(groupFilterValue);
                const group = groups.find(g => g.id === groupId);

                if (group) {
                    // Set main title to group name
                    headerTitle.textContent = group.name;

                    // Set subtitle to parent group name if exists, otherwise show type or default
                    if (group.parentGroupId) {
                        const parentGroup = groups.find(g => g.id === group.parentGroupId);
                        if (parentGroup) {
                            headerSubtitle.textContent = parentGroup.name;
                        } else {
                            headerSubtitle.textContent = group.type || 'Account Group';
                        }
                    } else {
                        // Top level group - show type or generic text
                        headerSubtitle.textContent = group.type || 'Account Group';
                    }
                }
            } else {
                // Reset to default
                headerTitle.textContent = 'PE Fund Manager';
                headerSubtitle.textContent = 'Private Equity Fund Analytics & Management Tool';
            }
        }

        function resetFilters() {
            document.getElementById('fundFilter').value = '';
            document.getElementById('accountFilter').value = '';
            document.getElementById('groupFilter').value = '';
            document.getElementById('searchInput').value = '';
            document.getElementById('cutoffDate').value = '';
            currentGroupDescendants = null;
            updateHeader();
            renderTable();
        }

        function toggleSidebar() {
            const sidebar = document.getElementById('sidebar');
            const overlay = document.getElementById('sidebarOverlay');
            sidebar.classList.add('show');
            overlay.classList.add('show');
            document.body.classList.add('sidebar-open');
        }

        function closeSidebar() {
            const sidebar = document.getElementById('sidebar');
            const overlay = document.getElementById('sidebarOverlay');
            sidebar.classList.remove('show');
            overlay.classList.remove('show');
            document.body.classList.remove('sidebar-open');
        }

        function toggleTagsDisplay() {
            const checkbox = document.getElementById('sidebarShowTagsCheckbox');
            // Save preference to localStorage
            localStorage.setItem('showTags', checkbox.checked);
            // Re-render table to show/hide tags
            renderTable();
            // Also refresh Manage Funds list if it's open
            const manageFundsModal = document.getElementById('manageFundNamesModal');
            if (manageFundsModal && manageFundsModal.classList.contains('show')) {
                loadFundNamesList();
            }
        }

        function sortData(data, column, direction) {
            return [...data].sort((a, b) => {
                const cutoffDateValue = document.getElementById('cutoffDate').value;
                const cutoffDate = cutoffDateValue ? new Date(cutoffDateValue) : null;

                const metricsA = calculateMetrics(a, cutoffDate);
                const metricsB = calculateMetrics(b, cutoffDate);

                let valA, valB;

                switch(column) {
                    case 'fundName':
                    case 'accountNumber':
                        valA = a[column];
                        valB = b[column];
                        break;
                    case 'vintage':
                    case 'commitment':
                    case 'totalContributions':
                    case 'totalDistributions':
                    case 'nav':
                    case 'investmentReturn':
                    case 'outstandingCommitment':
                    case 'irr':
                    case 'moic':
                        valA = metricsA[column] ?? -Infinity;
                        valB = metricsB[column] ?? -Infinity;
                        break;
                    default:
                        return 0;
                }

                if (valA < valB) return direction === 'asc' ? -1 : 1;
                if (valA > valB) return direction === 'asc' ? 1 : -1;
                return 0;
            });
        }

        function sortTable(column) {
            if (sortColumn === column) {
                sortDirection = sortDirection === 'asc' ? 'desc' : 'asc';
            } else {
                sortColumn = column;
                sortDirection = 'asc';
            }

            // Update header classes
            document.querySelectorAll('th').forEach(th => {
                th.classList.remove('sorted-asc', 'sorted-desc');
            });

            const headers = document.querySelectorAll('th');
            const columnIndex = ['fundName', 'accountNumber', 'vintage', 'commitment', 'totalContributions', 'totalDistributions', 'nav', 'investmentReturn', 'moic', 'irr', 'outstandingCommitment'].indexOf(column);
            if (columnIndex !== -1) {
                headers[columnIndex].classList.add(`sorted-${sortDirection}`);
            }

            renderTable();
        }

        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        // ===========================
        // Modal Functions
        // ===========================

        async function showAddFundModal() {
            document.getElementById('fundModalTitle').textContent = 'Add New Investment';
            document.getElementById('fundId').value = '';
            document.getElementById('isDuplicate').value = '';
            document.getElementById('duplicateMultiplierContainer').style.display = 'none';

            await populateFundNamesDropdown();
            await populateFundGroupDropdown();

            // Reset other form fields (not the fund name dropdown which we just populated)
            document.getElementById('accountNumber').value = '';
            document.getElementById('commitment').value = '';
            document.getElementById('cashFlows').value = '';
            document.getElementById('monthlyNav').value = '';

            document.getElementById('fundModal').classList.add('show');
        }

        async function editFund(id) {
            try {
                const fund = await getFundById(id);
                if (!fund) {
                    showStatus('Fund not found', 'error');
                    return;
                }

                console.log('Editing fund:', fund);
                console.log('Fund monthlyNav:', fund.monthlyNav);

                document.getElementById('fundModalTitle').textContent = 'Edit Investment';
                document.getElementById('fundId').value = fund.id;
                document.getElementById('isDuplicate').value = '';
                document.getElementById('duplicateMultiplierContainer').style.display = 'none';

                await populateFundNamesDropdown(fund.fundName);
                await populateFundGroupDropdown(fund.groupId);
                document.getElementById('accountNumber').value = fund.accountNumber;
                document.getElementById('commitment').value = formatCurrency(parseCurrency(fund.commitment) || 0);
                document.getElementById('cashFlows').value = JSON.stringify(fund.cashFlows || [], null, 2);
                document.getElementById('monthlyNav').value = JSON.stringify(fund.monthlyNav || [], null, 2);

                document.getElementById('fundModal').classList.add('show');
            } catch (err) {
                showStatus('Error loading fund: ' + err.message, 'error');
                console.error('Error in editFund:', err);
            }
        }

        async function duplicateFund(id) {
            try {
                const fund = await getFundById(id);
                if (!fund) {
                    showStatus('Fund not found', 'error');
                    return;
                }

                document.getElementById('fundModalTitle').textContent = 'Duplicate Investment';
                document.getElementById('fundId').value = '';
                document.getElementById('isDuplicate').value = id;
                document.getElementById('duplicateMultiplierContainer').style.display = 'block';
                document.getElementById('duplicateMultiplier').value = '1';

                await populateFundNamesDropdown(fund.fundName);
                await populateFundGroupDropdown(fund.groupId);
                document.getElementById('accountNumber').value = fund.accountNumber + ' (Copy)';
                document.getElementById('commitment').value = formatCurrency(parseCurrency(fund.commitment) || 0);
                document.getElementById('cashFlows').value = JSON.stringify(fund.cashFlows || [], null, 2);
                document.getElementById('monthlyNav').value = JSON.stringify(fund.monthlyNav || [], null, 2);

                document.getElementById('fundModal').classList.add('show');
            } catch (err) {
                showStatus('Error loading fund: ' + err.message, 'error');
            }
        }

        function closeFundModal() {
            document.getElementById('fundModal').classList.remove('show');
        }

        // Tag management functions
        // Handle tag input for Edit Fund Name modal
        document.addEventListener('keydown', function(event) {
            if (event.target.id === 'editFundTagsInput' && event.key === 'Enter') {
                event.preventDefault();
                const input = event.target;
                const tagName = input.value.trim();
                if (tagName) {
                    const currentTags = getEditFundTags();
                    if (!currentTags.includes(tagName)) {
                        addEditFundTag(tagName);
                        input.value = '';
                    } else {
                        showStatus('Tag already added', 'warning');
                    }
                }
            }
        });

        async function saveFund(event) {
            event.preventDefault();

            try {
                const fundId = document.getElementById('fundId').value;
                const isDuplicate = document.getElementById('isDuplicate').value;
                const fundName = document.getElementById('fundName').value.trim();
                const accountNumber = document.getElementById('accountNumber').value.trim();
                const groupId = document.getElementById('fundGroup').value;
                const commitmentText = document.getElementById('commitment').value.trim();
                const cashFlowsText = document.getElementById('cashFlows').value.trim();
                const monthlyNavText = document.getElementById('monthlyNav').value.trim();

                // Validate
                if (!fundName || !accountNumber || !commitmentText) {
                    showStatus('Please fill in all required fields', 'error');
                    return;
                }

                // Parse commitment
                let commitment = parseCurrency(commitmentText);
                if (isNaN(commitment)) {
                    showStatus('Invalid commitment amount', 'error');
                    return;
                }
                if (commitment < 0) {
                    showStatus('Commitment amount cannot be negative', 'error');
                    return;
                }

                // Parse JSON
                let cashFlows, monthlyNav;

                // Parse cash flows (optional)
                if (cashFlowsText) {
                    try {
                        cashFlows = JSON.parse(cashFlowsText);
                        if (!Array.isArray(cashFlows)) throw new Error('Cash flows must be an array');

                        // Validate cash flow structure
                        cashFlows.forEach((cf, i) => {
                            if (!cf.date || typeof cf.amount === 'undefined' || !cf.type) {
                                throw new Error(`Invalid cash flow at index ${i}`);
                            }
                            if (!['Contribution', 'Distribution'].includes(cf.type)) {
                                throw new Error(`Invalid cash flow type at index ${i}`);
                            }
                        });
                    } catch (err) {
                        showStatus('Invalid cash flows JSON: ' + err.message, 'error');
                        return;
                    }
                } else {
                    cashFlows = [];
                }

                try {
                    monthlyNav = monthlyNavText ? JSON.parse(monthlyNavText) : [];
                    if (!Array.isArray(monthlyNav)) throw new Error('Monthly NAV must be an array');

                    monthlyNav.forEach((nav, i) => {
                        if (!nav.date || typeof nav.amount === 'undefined') {
                            throw new Error(`Invalid NAV entry at index ${i}`);
                        }
                    });
                } catch (err) {
                    showStatus('Invalid monthly NAV JSON: ' + err.message, 'error');
                    return;
                }

                // Handle duplicate multiplier
                if (isDuplicate) {
                    const multiplier = parseFloat(document.getElementById('duplicateMultiplier').value) || 1;

                    if (multiplier <= 0) {
                        showStatus('Duplicate multiplier must be positive', 'error');
                        return;
                    }

                    if (multiplier > 1000) {
                        if (!confirm(`Warning: Multiplier of ${multiplier} is very large. This will create extremely large amounts. Continue?`)) {
                            return;
                        }
                    }

                    if (multiplier < 0.001) {
                        if (!confirm(`Warning: Multiplier of ${multiplier} is very small. This may result in rounding to zero. Continue?`)) {
                            return;
                        }
                    }

                    commitment = commitment * multiplier;

                    cashFlows = cashFlows.map(cf => ({
                        ...cf,
                        amount: parseCurrency(cf.amount) * multiplier
                    }));

                    monthlyNav = monthlyNav.map(nav => ({
                        ...nav,
                        amount: parseCurrency(nav.amount) * multiplier
                    }));
                }

                const fundData = {
                    fundName,
                    accountNumber,
                    groupId: groupId ? parseInt(groupId) : null,
                    commitment: commitment,
                    cashFlows,
                    monthlyNav,
                    timestamp: new Date().toISOString()
                };

                if (fundId) {
                    fundData.id = parseInt(fundId);
                }

                await saveFundToDB(fundData);

                // Save fund name if new
                if (!fundNames.has(fundName)) {
                    await saveFundName(fundName);
                    fundNames.add(fundName);
                }

                closeFundModal();
                await renderTable();
                showStatus(fundId ? 'Fund updated successfully' : 'Fund added successfully');

            } catch (err) {
                showStatus('Error saving fund: ' + err.message, 'error');
                console.error(err);
            }
        }

        async function showActionModal(id) {
            console.log('showActionModal called with ID:', id, 'Type:', typeof id);

            if (!id && id !== 0) {
                console.error('Invalid fund ID provided to showActionModal:', id);
                showStatus('Error: Invalid fund ID provided', 'error');
                return;
            }

            currentActionFundId = id;

            try {
                const fund = await getFundById(id);
                if (!fund) {
                    showStatus('Fund not found', 'error');
                    return;
                }

                console.log('Action modal showing for fund:', fund.fundName, 'ID:', fund.id);
                document.getElementById('actionFundInfo').textContent =
                    `${fund.fundName} - ${fund.accountNumber}`;
                document.getElementById('actionModal').classList.add('show');
            } catch (err) {
                console.error('Error in showActionModal:', err);
                showStatus('Error loading fund: ' + err.message, 'error');
            }
        }

        function closeActionModal() {
            document.getElementById('actionModal').classList.remove('show');
            currentActionFundId = null;
        }

        function editFundFromAction() {
            const fundId = currentActionFundId;
            if (fundId == null) {
                showStatus('Error: No fund selected', 'error');
                return;
            }
            closeActionModal();
            editFund(fundId);
        }

        function duplicateFundFromAction() {
            const fundId = currentActionFundId;
            if (fundId == null) {
                showStatus('Error: No fund selected', 'error');
                return;
            }
            closeActionModal();
            duplicateFund(fundId);
        }

        async function deleteFundFromAction() {
            if (currentActionFundId == null) return;

            try {
                const fund = await getFundById(currentActionFundId);
                if (!fund) {
                    showStatus('Fund not found', 'error');
                    return;
                }

                if (confirm(`Are you sure you want to delete "${fund.fundName} - ${fund.accountNumber}"?`)) {
                    await deleteFundFromDB(currentActionFundId);
                    closeActionModal();
                    await renderTable();
                    showStatus('Fund deleted successfully');
                }
            } catch (err) {
                showStatus('Error deleting fund: ' + err.message, 'error');
            }
        }

        function showDetailsFromAction() {
            // Capture the ID before closing the modal
            const fundId = currentActionFundId;
            console.log('Opening details for fund ID:', fundId);
            if (fundId == null) {
                console.error('No fund ID available');
                showStatus('Error: No fund selected', 'error');
                return;
            }
            closeActionModal();
            showDetailsModal(fundId);
        }

        async function showDetailsModal(id) {
            console.log('showDetailsModal called with ID:', id, 'Type:', typeof id);

            if (!id && id !== 0) {
                console.error('Invalid fund ID provided to showDetailsModal:', id);
                showStatus('Error: Invalid fund ID provided', 'error');
                return;
            }

            currentDetailsFundId = id;

            try {
                console.log('Loading fund details for ID:', id);
                const fund = await getFundById(id);

                if (!fund) {
                    console.error('Fund not found:', id);
                    showStatus('Fund not found', 'error');
                    return;
                }

                console.log('Fund loaded:', fund);

                document.getElementById('detailsModalTitle').textContent =
                    `Fund Details - ${fund.fundName}`;

                // Display last modified timestamp
                const subtitle = document.getElementById('detailsModalSubtitle');
                if (fund.timestamp) {
                    try {
                        const date = new Date(fund.timestamp);
                        const formatted = date.toLocaleString('en-US', {
                            year: 'numeric',
                            month: 'short',
                            day: 'numeric',
                            hour: '2-digit',
                            minute: '2-digit'
                        });
                        subtitle.textContent = `Last modified: ${formatted}`;
                    } catch (err) {
                        subtitle.textContent = '';
                    }
                } else {
                    subtitle.textContent = '';
                }

                // Populate cash flows table
                const cashFlowsTable = document.getElementById('cashFlowsTable');
                if (!cashFlowsTable) {
                    console.error('Cash flows table not found');
                    showStatus('Error: Cash flows table element not found in page', 'error');
                    return;
                }
                const cashFlowsTableBody = cashFlowsTable.querySelector('tbody');
                if (!cashFlowsTableBody) {
                    console.error('Cash flows table body not found');
                    showStatus('Error: Cash flows table body element not found in page', 'error');
                    return;
                }
                cashFlowsTableBody.innerHTML = '';

                console.log('Cash flows:', fund.cashFlows);
                (fund.cashFlows || []).forEach((cf, index) => {
                    try {
                        const row = document.createElement('tr');
                        const amountValue = parseCurrency(cf.amount);
                        const displayAmount = isNaN(amountValue) ? '' : formatNumberWithCommas(amountValue);

                        row.innerHTML = `
                            <td><input type="date" value="${escapeHtml(cf.date || '')}" data-field="date" data-index="${index}"></td>
                            <td><input type="text" value="${displayAmount}" data-field="amount" data-index="${index}"></td>
                            <td>
                                <select data-field="type" data-index="${index}">
                                    <option value="Contribution" ${cf.type === 'Contribution' ? 'selected' : ''}>Contribution</option>
                                    <option value="Distribution" ${cf.type === 'Distribution' ? 'selected' : ''}>Distribution</option>
                                </select>
                            </td>
                            <td style="text-align: center;">
                                <input type="checkbox" ${cf.affectsCommitment !== false ? 'checked' : ''} data-field="affectsCommitment" data-index="${index}">
                            </td>
                            <td>
                                <button class="delete-row-btn" onclick="deleteCashFlowRow(this)">Delete</button>
                            </td>
                        `;
                        cashFlowsTableBody.appendChild(row);
                    } catch (cfErr) {
                        console.error('Error adding cash flow row:', cfErr, cf);
                        showStatus('Error loading cash flow at index ' + index + ': ' + cfErr.message, 'error');
                    }
                });

                // Populate NAV table
                const navTable = document.getElementById('navTable');
                if (!navTable) {
                    console.error('NAV table not found');
                    showStatus('Error: NAV table element not found in page', 'error');
                    return;
                }
                const navTableBody = navTable.querySelector('tbody');
                if (!navTableBody) {
                    console.error('NAV table body not found');
                    showStatus('Error: NAV table body element not found in page', 'error');
                    return;
                }
                navTableBody.innerHTML = '';

                console.log('Monthly NAV:', fund.monthlyNav);
                (fund.monthlyNav || []).forEach((nav, index) => {
                    try {
                        const row = document.createElement('tr');
                        const amountValue = parseCurrency(nav.amount);
                        const displayAmount = isNaN(amountValue) ? '' : formatNumberWithCommas(amountValue);

                        row.innerHTML = `
                            <td><input type="date" value="${escapeHtml(nav.date || '')}" data-field="date" data-index="${index}"></td>
                            <td><input type="text" value="${displayAmount}" data-field="amount" data-index="${index}"></td>
                            <td>
                                <button class="delete-row-btn" onclick="deleteNavRow(this)">Delete</button>
                            </td>
                        `;
                        navTableBody.appendChild(row);
                    } catch (navErr) {
                        console.error('Error adding NAV row:', navErr, nav);
                        showStatus('Error loading NAV at index ' + index + ': ' + navErr.message, 'error');
                    }
                });

                document.getElementById('detailsModal').classList.add('show');
                hasUnsavedChanges = false; // Reset unsaved changes flag when opening modal
                console.log('Details modal opened successfully');
            } catch (err) {
                console.error('Error in showDetailsModal:', err);
                showStatus('Error loading fund details: ' + err.message + ' (Check console for details)', 'error');
            }
        }

        function closeDetailsModal() {
            if (hasUnsavedChanges) {
                if (!confirm('You have unsaved changes. Are you sure you want to close without saving?')) {
                    return;
                }
            }
            document.getElementById('detailsModal').classList.remove('show');
            currentDetailsFundId = null;
            hasUnsavedChanges = false;
        }

        function addCashFlowRow() {
            const table = document.getElementById('cashFlowsTable').querySelector('tbody');
            const index = table.children.length;
            const row = document.createElement('tr');
            row.innerHTML = `
                <td><input type="date" data-field="date" data-index="${index}"></td>
                <td><input type="text" placeholder="0" data-field="amount" data-index="${index}"></td>
                <td>
                    <select data-field="type" data-index="${index}">
                        <option value="Contribution">Contribution</option>
                        <option value="Distribution">Distribution</option>
                    </select>
                </td>
                <td style="text-align: center;">
                    <input type="checkbox" checked data-field="affectsCommitment" data-index="${index}">
                </td>
                <td>
                    <button class="delete-row-btn" onclick="deleteCashFlowRow(this)">Delete</button>
                </td>
            `;
            table.appendChild(row);
            hasUnsavedChanges = true;
        }

        function deleteCashFlowRow(button) {
            const row = button.closest('tr');
            if (row) {
                const date = row.querySelector('[data-field="date"]').value;
                const amount = row.querySelector('[data-field="amount"]').value;
                const type = row.querySelector('[data-field="type"]').value;

                const dateText = date || 'no date';
                const amountText = amount || '$0';
                const typeText = type || 'contribution';

                if (confirm(`Delete this cash flow?\n${typeText} on ${dateText}: ${amountText}`)) {
                    row.remove();
                    hasUnsavedChanges = true;
                }
            }
        }

        function addNavRow() {
            const table = document.getElementById('navTable').querySelector('tbody');
            const index = table.children.length;
            const row = document.createElement('tr');
            row.innerHTML = `
                <td><input type="date" data-field="date" data-index="${index}"></td>
                <td><input type="text" placeholder="0" data-field="amount" data-index="${index}"></td>
                <td>
                    <button class="delete-row-btn" onclick="deleteNavRow(this)">Delete</button>
                </td>
            `;
            table.appendChild(row);
            hasUnsavedChanges = true;
        }

        function deleteNavRow(button) {
            const row = button.closest('tr');
            if (row) {
                const date = row.querySelector('[data-field="date"]').value;
                const amount = row.querySelector('[data-field="amount"]').value;

                const dateText = date || 'no date';
                const amountText = amount || '$0';

                if (confirm(`Delete this NAV entry?\n${dateText}: ${amountText}`)) {
                    row.remove();
                    hasUnsavedChanges = true;
                }
            }
        }

        async function saveDetailsChanges() {
            if (!currentDetailsFundId) return;

            try {
                const fund = await getFundById(currentDetailsFundId);
                if (!fund) {
                    showStatus('Fund not found', 'error');
                    return;
                }

                // Store original counts for comparison
                const originalCashFlowCount = (fund.cashFlows || []).length;
                const originalNavCount = (fund.monthlyNav || []).length;

                // Read cash flows from table
                const cashFlowsTable = document.getElementById('cashFlowsTable').querySelector('tbody');
                const cashFlows = [];
                const invalidCashFlows = [];

                // Clear previous error highlights
                Array.from(cashFlowsTable.children).forEach(row => {
                    row.classList.remove('validation-error-row');
                });

                Array.from(cashFlowsTable.children).forEach((row, index) => {
                    const date = row.querySelector('[data-field="date"]').value;
                    const amount = row.querySelector('[data-field="amount"]').value;
                    const type = row.querySelector('[data-field="type"]').value;
                    const affectsCommitment = row.querySelector('[data-field="affectsCommitment"]').checked;

                    if (date && amount) {
                        // Validate date format (YYYY-MM-DD)
                        if (!isValidDate(date)) {
                            invalidCashFlows.push(index + 1);
                            row.classList.add('validation-error-row');
                        } else {
                            cashFlows.push({
                                date,
                                amount: parseCurrency(amount),
                                type,
                                affectsCommitment
                            });
                        }
                    }
                });

                if (invalidCashFlows.length > 0) {
                    showStatus(`Invalid date format in cash flow row(s): ${invalidCashFlows.join(', ')}. Use YYYY-MM-DD format.`, 'error');
                    return;
                }

                // Read NAV from table
                const navTable = document.getElementById('navTable').querySelector('tbody');
                const monthlyNav = [];
                const invalidNav = [];

                // Clear previous error highlights
                Array.from(navTable.children).forEach(row => {
                    row.classList.remove('validation-error-row');
                });

                Array.from(navTable.children).forEach((row, index) => {
                    const date = row.querySelector('[data-field="date"]').value;
                    const amount = row.querySelector('[data-field="amount"]').value;

                    if (date && amount) {
                        // Validate date format (YYYY-MM-DD)
                        if (!isValidDate(date)) {
                            invalidNav.push(index + 1);
                            row.classList.add('validation-error-row');
                        } else {
                            monthlyNav.push({
                                date,
                                amount: parseCurrency(amount)
                            });
                        }
                    }
                });

                if (invalidNav.length > 0) {
                    showStatus(`Invalid date format in NAV row(s): ${invalidNav.join(', ')}. Use YYYY-MM-DD format.`, 'error');
                    return;
                }

                // Warn if significant data is being deleted
                if (originalCashFlowCount > 0 && cashFlows.length < originalCashFlowCount / 2) {
                    if (!confirm(`Warning: You are deleting ${originalCashFlowCount - cashFlows.length} cash flow(s). Continue?`)) {
                        return;
                    }
                }

                if (originalNavCount > 0 && monthlyNav.length < originalNavCount / 2) {
                    if (!confirm(`Warning: You are deleting ${originalNavCount - monthlyNav.length} NAV entr(ies). Continue?`)) {
                        return;
                    }
                }

                // Update fund
                fund.cashFlows = cashFlows;
                fund.monthlyNav = monthlyNav;
                fund.timestamp = new Date().toISOString();

                await saveFundToDB(fund);
                hasUnsavedChanges = false; // Mark as saved before closing
                closeDetailsModal();
                await renderTable();
                showStatus('Details updated successfully');

            } catch (err) {
                showStatus('Error saving details: ' + err.message, 'error');
                console.error(err);
            }
        }

        async function showManageFundsModal() {
            await loadFundNamesList();
            await populateFundNamesDropdown();
            document.getElementById('manageFundNamesModal').classList.add('show');
        }

        function closeManageFundsModal() {
            document.getElementById('manageFundNamesModal').classList.remove('show');
        }

        async function loadFundNamesList() {
            try {
                const fundNameObjects = await getAllFundNameObjects();
                fundNames = new Set(fundNameObjects.map(obj => obj.name));
                fundNameData = new Map(fundNameObjects.map(obj => [obj.name, obj]));

                const container = document.getElementById('fundNamesList');
                container.innerHTML = '';

                if (fundNameObjects.length === 0) {
                    container.innerHTML = '<p style="color: #95A5A6;">No fund names yet</p>';
                    return;
                }

                fundNameObjects.forEach(fundNameObj => {
                    const div = document.createElement('div');
                    div.className = 'fund-name-item';

                    const nameDiv = document.createElement('div');
                    nameDiv.style.flex = '1';
                    nameDiv.style.minWidth = '0';

                    const nameSpan = document.createElement('div');
                    nameSpan.textContent = fundNameObj.name;
                    nameSpan.style.fontWeight = '500';
                    nameSpan.style.marginBottom = '4px';
                    nameDiv.appendChild(nameSpan);

                    // Show tags if any and if tags are enabled
                    const showTags = document.getElementById('sidebarShowTagsCheckbox').checked;
                    if (showTags && fundNameObj.tags && fundNameObj.tags.length > 0) {
                        const tagsDiv = document.createElement('div');
                        tagsDiv.className = 'table-tags';
                        tagsDiv.style.marginTop = '4px';
                        fundNameObj.tags.forEach(tag => {
                            const tagSpan = document.createElement('span');
                            tagSpan.className = 'table-tag';
                            tagSpan.textContent = tag;
                            tagsDiv.appendChild(tagSpan);
                        });
                        nameDiv.appendChild(tagsDiv);
                    }

                    const editBtn = document.createElement('button');
                    editBtn.className = 'btn-secondary btn-sm';
                    editBtn.textContent = 'Edit';
                    editBtn.setAttribute('data-fund-name', fundNameObj.name);
                    editBtn.onclick = function() { openEditFundNameModal(this.getAttribute('data-fund-name')); };

                    const deleteBtn = document.createElement('button');
                    deleteBtn.className = 'btn-danger btn-sm';
                    deleteBtn.textContent = 'Delete';
                    deleteBtn.setAttribute('data-fund-name', fundNameObj.name);
                    deleteBtn.onclick = function() { removeFundName(this.getAttribute('data-fund-name')); };

                    div.appendChild(nameDiv);
                    div.appendChild(editBtn);
                    div.appendChild(deleteBtn);
                    container.appendChild(div);
                });
            } catch (err) {
                showStatus('Error loading fund names: ' + err.message, 'error');
            }
        }

        async function addNewFundName() {
            const input = document.getElementById('newFundNameInput');
            const name = input.value.trim();

            if (!name) {
                showStatus('Please enter a fund name', 'error');
                return;
            }

            if (fundNames.has(name)) {
                showStatus('Fund name already exists', 'error');
                return;
            }

            try {
                await saveFundName(name);
                fundNames.add(name);
                input.value = '';
                await loadFundNamesList();
                showStatus('Fund name added successfully');
            } catch (err) {
                showStatus('Error adding fund name: ' + err.message, 'error');
            }
        }

        // Open Edit Fund Name Modal
        function openEditFundNameModal(fundName) {
            const fundNameObj = fundNameData.get(fundName);
            if (!fundNameObj) {
                showStatus('Fund name not found', 'error');
                return;
            }

            document.getElementById('editFundNameOriginal').value = fundName;
            document.getElementById('editFundNameInput').value = fundName;

            // Populate tags
            populateEditFundTagsDatalist();
            setEditFundTags(fundNameObj.tags || []);

            document.getElementById('editFundNameModal').classList.add('show');
        }

        function closeEditFundNameModal() {
            document.getElementById('editFundNameModal').classList.remove('show');
        }

        // Tag management for Edit Fund Name modal
        function addEditFundTag(tagName) {
            const container = document.getElementById('editFundTagsContainer');
            const tag = document.createElement('span');
            tag.className = 'tag';
            tag.innerHTML = `${escapeHtml(tagName)}<span class="tag-remove" onclick="removeEditFundTag(this)">√ó</span>`;
            tag.setAttribute('data-tag', tagName);
            container.appendChild(tag);

            populateEditFundTagsDatalist();
        }

        function removeEditFundTag(button) {
            const tag = button.closest('.tag');
            if (tag) {
                tag.remove();
            }
        }

        function getEditFundTags() {
            const container = document.getElementById('editFundTagsContainer');
            const tagElements = container.querySelectorAll('.tag');
            return Array.from(tagElements).map(tag => tag.getAttribute('data-tag'));
        }

        function setEditFundTags(tagArray) {
            const container = document.getElementById('editFundTagsContainer');
            container.innerHTML = '';
            if (Array.isArray(tagArray)) {
                tagArray.forEach(tagName => addEditFundTag(tagName));
            }
        }

        function populateEditFundTagsDatalist() {
            const datalist = document.getElementById('editFundTagsDatalist');
            datalist.innerHTML = '';

            // Collect all unique tags from all fund names
            const allTags = new Set();
            fundNameData.forEach(fundNameObj => {
                if (fundNameObj.tags) {
                    fundNameObj.tags.forEach(tag => allTags.add(tag));
                }
            });

            allTags.forEach(tag => {
                const option = document.createElement('option');
                option.value = tag;
                datalist.appendChild(option);
            });
        }

        // Save edited fund name
        async function saveEditedFundName() {
            const oldName = document.getElementById('editFundNameOriginal').value;
            const newName = document.getElementById('editFundNameInput').value.trim();
            const tags = getEditFundTags();

            if (!newName) {
                showStatus('Fund name cannot be empty', 'error');
                return;
            }

            if (fundNames.has(newName) && newName !== oldName) {
                showStatus('Fund name already exists', 'error');
                return;
            }

            try {
                showLoading('Updating fund name...');

                // If name changed, update all funds that use this name
                if (newName !== oldName) {
                    const funds = await getAllFunds();
                    const fundsToUpdate = funds.filter(f => f.fundName === oldName);

                    const updateErrors = [];
                    for (const fund of fundsToUpdate) {
                        try {
                            fund.fundName = newName;
                            await saveFundToDB(fund);
                        } catch (err) {
                            updateErrors.push(fund.accountNumber);
                            console.error(`Failed to update fund ${fund.accountNumber}:`, err);
                        }
                    }

                    if (updateErrors.length > 0) {
                        throw new Error(`Failed to update ${updateErrors.length} fund(s): ${updateErrors.join(', ')}`);
                    }

                    // Delete old name and save new name with tags
                    await deleteFundName(oldName);
                    await saveFundName({ name: newName, tags });

                    fundNames.delete(oldName);
                    fundNames.add(newName);
                    fundNameData.delete(oldName);
                    fundNameData.set(newName, { name: newName, tags });

                    await renderTable();
                    showStatus(`Fund name updated successfully (${fundsToUpdate.length} fund(s) updated)`);
                } else {
                    // Just update tags
                    await saveFundName({ name: newName, tags });
                    fundNameData.set(newName, { name: newName, tags });
                    await renderTable();
                    showStatus('Tags updated successfully');
                }

                closeEditFundNameModal();
                await loadFundNamesList();
            } catch (err) {
                showStatus('Error updating fund name: ' + err.message, 'error');
                console.error(err);
            } finally {
                hideLoading();
            }
        }

        async function removeFundName(name) {
            if (!confirm(`Are you sure you want to delete "${name}"? This will not delete funds using this name.`)) {
                return;
            }

            try {
                await deleteFundName(name);
                fundNames.delete(name);
                fundNameData.delete(name);
                await loadFundNamesList();
                showStatus('Fund name deleted successfully');
            } catch (err) {
                showStatus('Error deleting fund name: ' + err.message, 'error');
            }
        }

        // ===========================
        // Manage Groups Modal Functions
        // ===========================

        async function showManageGroupsModal() {
            await loadGroupsList();
            await populateGroupParentDropdown();
            document.getElementById('manageGroupsModal').classList.add('show');
        }

        function closeManageGroupsModal() {
            document.getElementById('manageGroupsModal').classList.remove('show');
        }

        async function loadGroupsList() {
            try {
                groups = await getAllGroups();
                const container = document.getElementById('groupsList');
                container.innerHTML = '';

                if (groups.length === 0) {
                    container.innerHTML = '<p style="color: #95A5A6;">No groups yet</p>';
                    return;
                }

                // Build hierarchical tree
                const tree = buildGroupsTree(groups, null);
                renderGroupsTree(container, tree, 0);
            } catch (err) {
                showStatus('Error loading groups: ' + err.message, 'error');
            }
        }

        function buildGroupsTree(allGroups, parentId) {
            return allGroups
                .filter(g => g.parentGroupId === parentId)
                .sort((a, b) => a.name.localeCompare(b.name))
                .map(group => ({
                    ...group,
                    children: buildGroupsTree(allGroups, group.id)
                }));
        }

        function renderGroupsTree(container, tree, level) {
            tree.forEach(group => {
                const div = document.createElement('div');
                div.className = `group-item level-${Math.min(level, 3)}`;

                const typeText = group.type ? `<span class="group-item-type">(${escapeHtml(group.type)})</span>` : '';

                div.innerHTML = `
                    <div class="group-item-info">
                        <span>${escapeHtml(group.name)}</span>
                        ${typeText}
                    </div>
                    <div class="group-item-actions">
                        <button class="btn-info btn-sm group-edit-btn" data-group-id="${group.id}">Edit</button>
                        <button class="btn-danger btn-sm group-delete-btn" data-group-id="${group.id}">Delete</button>
                    </div>
                `;
                container.appendChild(div);

                // Recursively render children
                if (group.children && group.children.length > 0) {
                    renderGroupsTree(container, group.children, level + 1);
                }
            });
        }

        async function populateGroupParentDropdown() {
            const select = document.getElementById('newGroupParent');
            const editId = document.getElementById('editGroupId').value;

            try {
                groups = await getAllGroups();

                select.innerHTML = '<option value="">None (Top Level)</option>';

                // If editing, exclude the group being edited and its descendants
                let excludeIds = [];
                if (editId) {
                    excludeIds = await getAllDescendantGroupIds(parseInt(editId));
                }

                // Build hierarchical options
                const tree = buildGroupsTree(groups, null);
                addGroupOptionsToSelect(select, tree, 0, excludeIds);
            } catch (err) {
                console.error('Error populating group parent dropdown:', err);
            }
        }

        function addGroupOptionsToSelect(select, tree, level, excludeIds = []) {
            tree.forEach(group => {
                // Skip excluded groups (the group being edited and its descendants)
                if (excludeIds.includes(group.id)) {
                    return;
                }
                const option = document.createElement('option');
                option.value = group.id;
                const indent = '  '.repeat(level);
                option.textContent = indent + (level > 0 ? '‚îî‚îÄ ' : '') + group.name;
                select.appendChild(option);

                // Recursively add children
                if (group.children && group.children.length > 0) {
                    addGroupOptionsToSelect(select, group.children, level + 1, excludeIds);
                }
            });
        }

        async function saveGroupChanges() {
            const name = document.getElementById('newGroupName').value.trim();
            const parentId = document.getElementById('newGroupParent').value;
            const type = document.getElementById('newGroupType').value.trim();
            const editId = document.getElementById('editGroupId').value;

            if (!name) {
                showStatus('Please enter a group name', 'error');
                return;
            }

            // Validate circular reference prevention
            if (editId && parentId) {
                const groupId = parseInt(editId);
                const parentGroupId = parseInt(parentId);

                // Check if trying to set itself as parent
                if (groupId === parentGroupId) {
                    showStatus('Error: A group cannot be its own parent', 'error');
                    return;
                }

                // Check if parent is a descendant (would create circular reference)
                try {
                    const descendants = await getAllDescendantGroupIds(groupId);
                    if (descendants.includes(parentGroupId)) {
                        showStatus('Error: Cannot set a descendant group as parent (circular reference)', 'error');
                        return;
                    }
                } catch (err) {
                    console.error('Error checking descendants:', err);
                    showStatus('Error validating group hierarchy', 'error');
                    return;
                }
            }

            try {
                const groupData = {
                    name,
                    parentGroupId: parentId ? parseInt(parentId) : null,
                    type: type || null
                };

                // If editing, include the ID
                if (editId) {
                    groupData.id = parseInt(editId);
                }

                await saveGroup(groupData);

                // Reset form
                cancelGroupEdit();

                await loadGroupsList();
                await populateGroupParentDropdown();

                showStatus(editId ? 'Group updated successfully' : 'Group added successfully');
            } catch (err) {
                showStatus('Error saving group: ' + err.message, 'error');
            }
        }

        async function editGroup(id) {
            const group = groups.find(g => g.id === id);
            if (!group) return;

            // Set edit ID first
            document.getElementById('editGroupId').value = id;

            // Refresh parent dropdown (will now exclude this group and descendants)
            await populateGroupParentDropdown();

            // Populate form fields
            document.getElementById('newGroupName').value = group.name;
            document.getElementById('newGroupParent').value = group.parentGroupId || '';
            document.getElementById('newGroupType').value = group.type || '';

            // Update UI
            document.getElementById('groupFormTitle').textContent = 'Edit Group';
            document.getElementById('saveGroupBtn').textContent = 'Update Group';
            document.getElementById('cancelEditBtn').style.display = 'inline-block';

            // Scroll to top of modal
            document.querySelector('#manageGroupsModal .modal-content').scrollTop = 0;
        }

        function cancelGroupEdit() {
            // Clear form
            document.getElementById('newGroupName').value = '';
            document.getElementById('newGroupParent').value = '';
            document.getElementById('newGroupType').value = '';
            document.getElementById('editGroupId').value = '';

            // Reset UI
            document.getElementById('groupFormTitle').textContent = 'Add New Group';
            document.getElementById('saveGroupBtn').textContent = 'Add Group';
            document.getElementById('cancelEditBtn').style.display = 'none';
        }

        async function removeGroup(id) {
            const group = groups.find(g => g.id === id);
            if (!group) return;

            // Check if group has children
            const children = await getGroupsByParent(id);
            if (children.length > 0) {
                showStatus('Cannot delete group with subgroups. Delete subgroups first.', 'error');
                return;
            }

            // Check if any funds use this group
            const funds = await getAllFunds();
            const fundsInGroup = funds.filter(f => f.groupId === id);
            if (fundsInGroup.length > 0) {
                if (!confirm(`This group contains ${fundsInGroup.length} fund(s). Deleting the group will remove the group assignment from these funds. Continue?`)) {
                    return;
                }

                // Remove groupId from affected funds
                for (const fund of fundsInGroup) {
                    fund.groupId = null;
                    await saveFundToDB(fund);
                }
            }

            try {
                await deleteGroup(id);
                await loadGroupsList();
                await populateGroupParentDropdown();
                await renderTable();
                showStatus('Group deleted successfully');
            } catch (err) {
                showStatus('Error deleting group: ' + err.message, 'error');
            }
        }

        async function populateFundGroupDropdown(valueToSet = null) {
            const select = document.getElementById('fundGroup');

            try {
                groups = await getAllGroups();

                select.innerHTML = '<option value="">No Group</option>';

                // Build hierarchical options
                const tree = buildGroupsTree(groups, null);
                addGroupOptionsToSelect(select, tree, 0);

                // Set the value if provided
                if (valueToSet) {
                    select.value = valueToSet;
                }
            } catch (err) {
                console.error('Error populating fund group dropdown:', err);
            }
        }

        async function populateFundNamesDropdown(valueToSet = null) {
            const select = document.getElementById('fundName');
            const currentValue = valueToSet !== null ? valueToSet : select.value;

            try {
                const names = await getAllFundNames();
                console.log('Fund names from database:', names);
                fundNames = new Set(names);

                select.innerHTML = '<option value="">Select a fund</option>';
                names.forEach(name => {
                    const option = document.createElement('option');
                    option.value = name;
                    option.textContent = name;
                    select.appendChild(option);
                });

                // Add option to create new fund
                const newOption = document.createElement('option');
                newOption.value = '__new__';
                newOption.textContent = '+ Add New Fund Name';
                select.appendChild(newOption);

                if (currentValue && currentValue !== '__new__') {
                    select.value = currentValue;
                }

                console.log('Dropdown populated with', names.length, 'fund names');

                // Handle new fund name creation
                select.onchange = async function() {
                    if (this.value === '__new__') {
                        const newName = prompt('Enter new fund name:');
                        if (newName && newName.trim()) {
                            const name = newName.trim();

                            // Validate fund name
                            if (name.length > 100) {
                                showStatus('Fund name too long (max 100 characters)', 'error');
                                this.value = '';
                                return;
                            }

                            if (name.length < 2) {
                                showStatus('Fund name too short (min 2 characters)', 'error');
                                this.value = '';
                                return;
                            }

                            if (!fundNames.has(name)) {
                                try {
                                    await saveFundName(name);
                                    fundNames.add(name);
                                    await populateFundNamesDropdown(name);
                                    showStatus('Fund name added successfully');
                                } catch (err) {
                                    showStatus('Error adding fund name: ' + err.message, 'error');
                                    this.value = '';
                                }
                            } else {
                                select.value = name;
                            }
                        } else {
                            this.value = '';
                        }
                    }
                };
            } catch (err) {
                console.error('Error populating fund names:', err);
            }
        }

        // ===========================
        // Import / Export
        // ===========================

        async function exportDatabase() {
            try {
                const funds = await getAllFunds();
                const fundNamesData = await getAllFundNameObjects(); // Get full objects with tags
                const groupsData = await getAllGroups();

                const exportData = {
                    funds,
                    fundNames: fundNamesData, // Export full objects instead of just names
                    groups: groupsData,
                    exportDate: new Date().toISOString()
                };

                const dataStr = JSON.stringify(exportData, null, 2);
                const blob = new Blob([dataStr], { type: 'application/json' });
                const timestamp = new Date().toISOString().replace(/[:.]/g, '-');
                const filename = `pe-funds-export-${timestamp}.json`;

                if ('showSaveFilePicker' in window) {
                    try {
                        const handle = await window.showSaveFilePicker({
                            suggestedName: filename,
                            types: [{
                                description: 'JSON Files',
                                accept: { 'application/json': ['.json'] }
                            }]
                        });

                        const writable = await handle.createWritable();
                        await writable.write(blob);
                        await writable.close();

                        showStatus('Data exported successfully');
                        return;
                    } catch (err) {
                        if (err.name === 'AbortError') return;
                        throw err;
                    }
                }

                // Fallback
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = filename;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);

                showStatus('Data exported successfully');
            } catch (err) {
                showStatus('Error exporting data: ' + err.message, 'error');
                console.error(err);
            }
        }

        async function exportToCSV() {
            showLoading('Exporting to CSV...');
            try {
                // Get filtered and sorted data (same as what's displayed in the table)
                const funds = await getAllFunds();
                let filtered = applyCurrentFilters(funds);

                if (sortColumn) {
                    filtered = sortData(filtered, sortColumn, sortDirection);
                }

                // Get cutoff date
                const cutoffDateValue = document.getElementById('cutoffDate').value;
                const cutoffDate = cutoffDateValue ? new Date(cutoffDateValue) : null;

                // Calculate metrics for each fund
                const fundsWithMetrics = filtered.map(fund => ({
                    ...fund,
                    metrics: calculateMetrics(fund, cutoffDate)
                }));

                // Create CSV header
                const headers = [
                    'Fund Name',
                    'Account Number',
                    'Vintage',
                    'Commitment',
                    'Total Contributions',
                    'Total Distributions',
                    'NAV',
                    'Investment Return',
                    'MOIC',
                    'IRR',
                    'Outstanding Commitment'
                ];

                // Helper function to escape CSV values
                const escapeCSV = (value) => {
                    if (value === null || value === undefined) return '';
                    const str = String(value);
                    // If contains comma, quote, or newline, wrap in quotes and escape quotes
                    if (str.includes(',') || str.includes('"') || str.includes('\n')) {
                        return '"' + str.replace(/"/g, '""') + '"';
                    }
                    return str;
                };

                // Helper to format number without $ symbol for CSV
                const formatNumber = (value) => {
                    const val = parseFloat(value);
                    if (!isFinite(val) || isNaN(val)) return '';
                    return val.toFixed(2);
                };

                // Create CSV rows
                const rows = fundsWithMetrics.map(fund => {
                    const m = fund.metrics;
                    return [
                        escapeCSV(fund.fundName),
                        escapeCSV(fund.accountNumber),
                        escapeCSV(m.vintage || ''),
                        formatNumber(m.commitment),
                        formatNumber(m.totalContributions),
                        formatNumber(m.totalDistributions),
                        formatNumber(m.nav),
                        formatNumber(m.investmentReturn),
                        m.moic !== null && isFinite(m.moic) ? m.moic.toFixed(2) : '',
                        m.irr !== null ? (m.irr * 100).toFixed(2) : '',
                        formatNumber(m.outstandingCommitment)
                    ].join(',');
                });

                // Combine header and rows
                const csv = [headers.join(','), ...rows].join('\n');

                // Create blob and download
                const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
                const timestamp = new Date().toISOString().replace(/[:.]/g, '-').split('T')[0];
                const filename = `pe-funds-export-${timestamp}.csv`;

                // Create download link
                const link = document.createElement('a');
                if (link.download !== undefined) {
                    const url = URL.createObjectURL(blob);
                    link.setAttribute('href', url);
                    link.setAttribute('download', filename);
                    link.style.visibility = 'hidden';
                    document.body.appendChild(link);
                    link.click();
                    document.body.removeChild(link);
                    URL.revokeObjectURL(url);
                }

                showStatus('CSV exported successfully');
            } catch (err) {
                showStatus('Error exporting CSV: ' + err.message, 'error');
                console.error(err);
            } finally {
                hideLoading();
            }
        }

        function exportToPDF() {
            // Close the dropdown
            document.getElementById('exportDropdown').classList.remove('show');

            // Use the browser's print dialog to save as PDF
            window.print();
        }

        // Event delegation for dynamically created buttons and dropdown handling
        document.addEventListener('click', function(event) {
            // Handle fund actions button
            if (event.target.classList.contains('fund-actions-btn')) {
                const fundId = parseInt(event.target.getAttribute('data-fund-id'));
                showActionModal(fundId);
                return;
            }

            // Handle group edit button
            if (event.target.classList.contains('group-edit-btn')) {
                const groupId = parseInt(event.target.getAttribute('data-group-id'));
                editGroup(groupId);
                return;
            }

            // Handle group delete button
            if (event.target.classList.contains('group-delete-btn')) {
                const groupId = parseInt(event.target.getAttribute('data-group-id'));
                removeGroup(groupId);
                return;
            }

            // Close dropdown when clicking outside
            const dropdowns = document.querySelectorAll('.dropdown');
            dropdowns.forEach(dropdown => {
                if (!dropdown.contains(event.target)) {
                    const menu = dropdown.querySelector('.dropdown-menu');
                    if (menu) {
                        menu.classList.remove('show');
                    }
                }
            });
        });

        // Track changes in details modal
        document.addEventListener('input', function(event) {
            const detailsModal = document.getElementById('detailsModal');
            if (detailsModal && detailsModal.classList.contains('show')) {
                if (detailsModal.contains(event.target)) {
                    hasUnsavedChanges = true;
                }
            }
        });

        // Keyboard shortcuts
        document.addEventListener('keydown', function(event) {
            // Escape key: Close sidebar or open modals
            if (event.key === 'Escape') {
                const sidebar = document.getElementById('sidebar');
                const detailsModal = document.getElementById('detailsModal');
                const actionModal = document.getElementById('actionModal');
                const investmentModal = document.getElementById('investmentModal');
                const manageFundsModal = document.getElementById('manageFundNamesModal');
                const editFundNameModal = document.getElementById('editFundNameModal');
                const manageGroupsModal = document.getElementById('manageGroupsModal');

                if (sidebar && sidebar.classList.contains('show')) {
                    closeSidebar();
                } else if (detailsModal && detailsModal.classList.contains('show')) {
                    closeDetailsModal();
                } else if (actionModal && actionModal.classList.contains('show')) {
                    closeActionModal();
                } else if (investmentModal && investmentModal.classList.contains('show')) {
                    closeInvestmentModal();
                } else if (editFundNameModal && editFundNameModal.classList.contains('show')) {
                    closeEditFundNameModal();
                } else if (manageFundsModal && manageFundsModal.classList.contains('show')) {
                    closeManageFundsModal();
                } else if (manageGroupsModal && manageGroupsModal.classList.contains('show')) {
                    closeManageGroupsModal();
                }
                return;
            }

            // Ctrl/Cmd+S: Save details if details modal is open
            if ((event.ctrlKey || event.metaKey) && event.key === 's') {
                event.preventDefault();
                const detailsModal = document.getElementById('detailsModal');
                if (detailsModal && detailsModal.classList.contains('show')) {
                    saveDetailsChanges();
                }
                return;
            }
        });

        async function importDatabase(event) {
            const file = event.target.files[0];
            if (!file) return;

            // Validate file size (max 50MB)
            const maxSize = 50 * 1024 * 1024; // 50MB in bytes
            if (file.size > maxSize) {
                showStatus(`File too large (${(file.size / 1024 / 1024).toFixed(2)}MB). Maximum size is 50MB.`, 'error');
                event.target.value = '';
                return;
            }

            showLoading('Importing data...');
            try {
                const text = await file.text();
                const data = JSON.parse(text);

                let imported = 0;
                const oldGroupIdToNew = {}; // Map old group IDs to new ones

                // Import groups first (since funds may reference them)
                if (data.groups && Array.isArray(data.groups)) {
                    // Validate group hierarchy before importing
                    const groupIds = new Set(data.groups.map(g => g.id));

                    // Check for invalid parent references and circular dependencies
                    for (const group of data.groups) {
                        if (group.parentGroupId != null) {
                            // Check if parent exists in import data
                            if (!groupIds.has(group.parentGroupId)) {
                                console.warn(`Warning: Group "${group.name}" (ID ${group.id}) references non-existent parent ${group.parentGroupId}. Setting to top-level.`);
                                group.parentGroupId = null;
                            }

                            // Check for circular reference (direct self-reference)
                            if (group.id === group.parentGroupId) {
                                console.warn(`Warning: Group "${group.name}" (ID ${group.id}) has circular reference. Setting to top-level.`);
                                group.parentGroupId = null;
                            }
                        }
                    }

                    // Import groups sorted by hierarchy (parents before children)
                    const sortedGroups = [];
                    const addedIds = new Set();
                    let remainingGroups = [...data.groups];

                    // Keep adding groups whose parents have been added (or are null)
                    while (remainingGroups.length > 0) {
                        const initialLength = remainingGroups.length;

                        for (let i = remainingGroups.length - 1; i >= 0; i--) {
                            const group = remainingGroups[i];
                            if (group.parentGroupId == null || addedIds.has(group.parentGroupId)) {
                                sortedGroups.push(group);
                                addedIds.add(group.id);
                                remainingGroups.splice(i, 1);
                            }
                        }

                        // If no groups were added this iteration, we have circular dependencies
                        if (remainingGroups.length === initialLength) {
                            console.warn('Warning: Circular dependencies detected in remaining groups. Setting to top-level.');
                            remainingGroups.forEach(g => {
                                g.parentGroupId = null;
                                sortedGroups.push(g);
                            });
                            break;
                        }
                    }

                    // Import sorted groups
                    for (const group of sortedGroups) {
                        const oldId = group.id;
                        const { id, ...groupData } = group;

                        // Map parent ID to new ID if it was already imported
                        if (groupData.parentGroupId != null && oldGroupIdToNew[groupData.parentGroupId]) {
                            groupData.parentGroupId = oldGroupIdToNew[groupData.parentGroupId];
                        }

                        // Save group and get new ID
                        const newId = await saveGroup(groupData);
                        if (oldId != null && newId) {
                            oldGroupIdToNew[oldId] = newId;
                        }
                    }
                    // Reload groups cache
                    groups = await getAllGroups();
                }

                // Import fund names (now with tags)
                if (data.fundNames && Array.isArray(data.fundNames)) {
                    for (const fundNameItem of data.fundNames) {
                        // Support both old format (string) and new format (object with tags)
                        const fundNameObj = typeof fundNameItem === 'string'
                            ? { name: fundNameItem, tags: [] }
                            : { name: fundNameItem.name, tags: fundNameItem.tags || [] };

                        await saveFundName(fundNameObj);
                        fundNames.add(fundNameObj.name);
                        fundNameData.set(fundNameObj.name, fundNameObj);
                    }
                }

                // Import funds
                const fundsToImport = data.funds || data;
                if (!Array.isArray(fundsToImport)) {
                    throw new Error('Invalid format: expected array of funds');
                }

                // Collect unique fund names from imported funds (in case fundNames array is missing)
                const uniqueFundNames = new Set();
                fundsToImport.forEach(fund => {
                    if (fund.fundName && !fundNames.has(fund.fundName)) {
                        uniqueFundNames.add(fund.fundName);
                    }
                });

                // Save any missing fund names to database
                for (const name of uniqueFundNames) {
                    const fundNameObj = { name, tags: [] };
                    await saveFundName(fundNameObj);
                    fundNames.add(name);
                    fundNameData.set(name, fundNameObj);
                }

                const totalFunds = fundsToImport.length;
                const failedImports = [];

                for (let i = 0; i < fundsToImport.length; i++) {
                    const fund = fundsToImport[i];
                    try {
                        // Normalize cash flows to ensure proper structure
                        const cashFlows = (fund.cashFlows || []).map(cf => ({
                            date: cf.date,
                            amount: parseCurrency(cf.amount),
                            type: cf.type || (cf.amount < 0 ? 'Contribution' : 'Distribution'),
                            affectsCommitment: cf.affectsCommitment !== undefined ? cf.affectsCommitment : true
                        }));

                        // Normalize monthly NAV
                        const monthlyNav = (fund.monthlyNav || []).map(nav => ({
                            date: nav.date,
                            amount: parseCurrency(nav.amount)
                        }));

                        // Map old groupId to new groupId if applicable
                        let groupId = null;
                        if (fund.groupId && oldGroupIdToNew[fund.groupId]) {
                            groupId = oldGroupIdToNew[fund.groupId];
                        }

                        const fundData = {
                            fundName: fund.fundName,
                            accountNumber: fund.accountNumber,
                            groupId: groupId,
                            commitment: parseCurrency(fund.commitment),
                            cashFlows: cashFlows,
                            monthlyNav: monthlyNav,
                            timestamp: fund.timestamp || new Date().toISOString()
                        };

                        await saveFundToDB(fundData);
                        imported++;
                    } catch (fundErr) {
                        console.error(`Error importing fund at index ${i}:`, fundErr, fund);
                        failedImports.push({ index: i, name: fund.fundName || fund.accountNumber || 'Unknown', error: fundErr.message });
                    }
                }

                await renderTable();

                if (failedImports.length > 0) {
                    const failedCount = failedImports.length;
                    showStatus(`Partial import: ${imported}/${totalFunds} funds imported. ${failedCount} failed (see console for details)`, 'error');
                    console.error('Failed imports:', failedImports);
                    // Don't clear input on partial failure
                } else {
                    showStatus(`Successfully imported ${imported} fund(s)`);
                    event.target.value = '';
                }
            } catch (err) {
                showStatus('Error importing data: ' + err.message, 'error');
                console.error(err);
                // Don't clear input on error so user can retry
            } finally {
                hideLoading();
            }
        }

        // ===========================
        // Initialization
        // ===========================

        function setControlsEnabled(enabled) {
            const buttons = document.querySelectorAll('button');
            const inputs = document.querySelectorAll('input, select, textarea');

            inputs.forEach(input => input.disabled = !enabled);
            buttons.forEach(button => button.disabled = !enabled);
        }

        async function init() {
            showLoading('Initializing application...');
            try {
                setControlsEnabled(false);

                await initDB();

                // Load fund name objects (with tags)
                const fundNameObjects = await getAllFundNameObjects();
                fundNames = new Set(fundNameObjects.map(obj => obj.name));
                fundNameData = new Map(fundNameObjects.map(obj => [obj.name, obj]));

                // Load groups
                groups = await getAllGroups();

                // Set default cutoff date to latest quarter end
                const quarterEnd = getLatestQuarterEnd();
                document.getElementById('cutoffDate').value = quarterEnd.toISOString().split('T')[0];

                // Restore tag display preference from localStorage (default: true)
                const showTags = localStorage.getItem('showTags');
                document.getElementById('sidebarShowTagsCheckbox').checked = showTags === null ? true : showTags === 'true';

                await renderTable();

                setControlsEnabled(true);

                console.log('PE Fund Manager initialized successfully');
            } catch (err) {
                showStatus('Error initializing application: ' + err.message, 'error');
                console.error(err);
            } finally {
                hideLoading();
            }
        }

        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', init);
        } else {
            init();
        }
    </script>
</body>
</html>
