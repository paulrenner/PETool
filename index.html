<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="Content-Security-Policy"
          content="default-src 'self'; style-src 'self' 'unsafe-inline'; script-src 'self' 'unsafe-inline'; worker-src 'self' blob:; img-src 'self' data: blob:; connect-src 'self'">
    <title>PE Fund Manager</title>
    <meta name="description" content="Private Equity Fund Analytics & Management Tool">
    <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><rect fill='%232C3E50' width='100' height='100' rx='12'/><path d='M20 70 L35 45 L50 55 L65 30 L80 40' stroke='%2327AE60' stroke-width='6' fill='none' stroke-linecap='round' stroke-linejoin='round'/><circle cx='80' cy='40' r='6' fill='%2327AE60'/></svg>">
  <script type="module" crossorigin>var Ro=Object.defineProperty;var Go=(e,t,n)=>t in e?Ro(e,t,{enumerable:!0,configurable:!0,writable:!0,value:n}):e[t]=n;var P=(e,t,n)=>Go(e,typeof t!="symbol"?t+"":t,n);(function(){const t=document.createElement("link").relList;if(t&&t.supports&&t.supports("modulepreload"))return;for(const s of document.querySelectorAll('link[rel="modulepreload"]'))o(s);new MutationObserver(s=>{for(const a of s)if(a.type==="childList")for(const r of a.addedNodes)r.tagName==="LINK"&&r.rel==="modulepreload"&&o(r)}).observe(document,{childList:!0,subtree:!0});function n(s){const a={};return s.integrity&&(a.integrity=s.integrity),s.referrerPolicy&&(a.referrerPolicy=s.referrerPolicy),s.crossOrigin==="use-credentials"?a.credentials="include":s.crossOrigin==="anonymous"?a.credentials="omit":a.credentials="same-origin",a}function o(s){if(s.ep)return;s.ep=!0;const a=n(s);fetch(s.href,a)}})();const E={DB_NAME:"FundsDB",FUNDS_STORE:"funds",FUNDNAMES_STORE:"fundNames",GROUPS_STORE:"groups",AUDIT_STORE:"auditLog",DISMISSED_ISSUES_STORE:"dismissedHealthIssues",DB_VERSION:12,CURRENCY_FORMAT:"en-US",CURRENCY_CODE:"USD",IRR_MAX_ITERATIONS:1e3,IRR_PRECISION:1e-6,IRR_GUESS:.1,IRR_MIN_RATE:-.99,IRR_MAX_RATE:10,IRR_MIN_DAYS:30,DATE_FORMAT:/^\d{4}-\d{2}-\d{2}$/,DEBOUNCE_FILTER:300,DEBOUNCE_SEARCH:300,DEBOUNCE_INPUT:300,MIN_COLUMN_WIDTH:50,MAX_FILE_SIZE:50*1024*1024,FUND_NAME_MIN_LENGTH:2,FUND_NAME_MAX_LENGTH:100,METRICS_CACHE_TTL:5e3,MAX_METRICS_CACHE_SIZE:1e3,LAZY_RENDER_TIMELINE:!0,TABLE_LOADING_DELAY:150,WORKER_THRESHOLD:100,ALLOWED_FUND_NAME_PATTERN:/^[a-zA-Z0-9\s\-_.,&']+$/,MAX_IMPORT_FUNDS:1e4,MAX_IMPORT_GROUPS:1e3,MAX_IMPORT_FUNDNAMES:5e3,MAX_JSON_DEPTH:10,DANGEROUS_KEYS:["__proto__","constructor","prototype"],STORAGE_THEME:"pe-tool-theme",STORAGE_COLUMN_WIDTHS:"columnWidths",STORAGE_SHOW_TAGS:"showTags",STORAGE_GROUP_BY_FUND:"groupByFund",STORAGE_GROUP_BY_GROUP:"groupByGroup",STORAGE_EXPANDED_GROUPS:"expandedGroups",STORAGE_MASK_ACCOUNTS:"maskAccounts",STORAGE_BACKUP_WARNING:"backupWarningShown",STORAGE_LAST_BACKUP:"lastBackupDate",BACKUP_REMINDER_DAYS:30,MS_PER_DAY:24*60*60*1e3,MS_PER_YEAR:365.25*24*60*60*1e3,TOAST_SUCCESS_DURATION:3e3,TOAST_ERROR_DURATION:8e3,SR_ANNOUNCEMENT_DURATION:1e3,WORKER_INIT_TIMEOUT:2e3,WORKER_CALCULATION_TIMEOUT:3e4,HEALTH_CONTRIBUTION_EXCEED_THRESHOLD:1.2,HEALTH_FUTURE_DAYS_THRESHOLD:30},Yn=2166136261,xt=16777619;function De(e){let t=Yn;for(let n=0;n<e.length;n++){const o=e[n];o!==void 0&&(t^=o,t=t*xt>>>0)}return t.toString(36)}function wn(e){const t=Object.keys(e).sort();let n=Yn;for(const o of t){for(const a of o)n^=a.charCodeAt(0),n=n*xt>>>0;const s=e[o];if(s)for(const a of s)for(const r of a)n^=r.charCodeAt(0),n=n*xt>>>0}return n.toString(36)}class $o{constructor(){P(this,"currentFunds",[]);P(this,"fundNames",new Set);P(this,"fundNameData",new Map);P(this,"groups",[]);P(this,"groupsMap",new Map);P(this,"sortColumns",[]);P(this,"currentActionFundId",null);P(this,"currentDetailsFundId",null);P(this,"hasUnsavedChanges",!1);P(this,"fundModalHasUnsavedChanges",!1);P(this,"dataVersion",0);P(this,"lastHealthCheckVersion",-1);P(this,"dataChangedSinceLastExport",!1);P(this,"lastExportReminderTime",0);P(this,"displayLimit",50);P(this,"displayLimitIncrement",50);P(this,"metricsCache",new Map);P(this,"consolidatedMetricsCache",new Map);P(this,"groupDescendantsCache",new Map);P(this,"ancestorCache",new Map);P(this,"childrenByParentId",new Map);P(this,"filterCache",null);P(this,"groupTreeCache",null);P(this,"abortController",null)}getFunds(){return this.currentFunds}getGroups(){return this.groups}clearMetricsCache(){this.metricsCache.clear(),this.consolidatedMetricsCache.clear()}getMetricsFromCache(t,n){const o=`${t}-${n}`,s=this.metricsCache.get(o);return s?s.dataVersion!==this.dataVersion?(this.metricsCache.delete(o),null):Date.now()-s.timestamp>=E.METRICS_CACHE_TTL?(this.metricsCache.delete(o),null):s.metrics:null}setMetricsCache(t,n,o){const s=`${t}-${n}`;if(this.metricsCache.size>=E.MAX_METRICS_CACHE_SIZE){const a=this.metricsCache.keys().next().value;a&&this.metricsCache.delete(a)}this.metricsCache.set(s,{metrics:o,timestamp:Date.now(),dataVersion:this.dataVersion})}getConsolidatedMetricsFromCache(t,n,o){const s=[...o].sort((c,u)=>c-u),a=De(s),r=`${t}-${n}-${a}`,i=this.consolidatedMetricsCache.get(r);return!i||i.dataVersion!==this.dataVersion?null:i.metrics}setConsolidatedMetricsCache(t,n,o,s){const a=[...o].sort((c,u)=>c-u),r=De(a),i=`${t}-${n}-${r}`;if(this.consolidatedMetricsCache.size>=E.MAX_METRICS_CACHE_SIZE){const c=this.consolidatedMetricsCache.keys().next().value;c&&this.consolidatedMetricsCache.delete(c)}this.consolidatedMetricsCache.set(i,{metrics:s,fundIdsHash:r,dataVersion:this.dataVersion})}getFilteredFundsFromCache(t,n){if(!this.filterCache||this.filterCache.dataVersion!==this.dataVersion)return null;const o=wn(t)+"-"+n;return this.filterCache.filterHash!==o?null:this.filterCache.fundIds}setFilteredFundsCache(t,n,o){const s=wn(t)+"-"+n;this.filterCache={fundIds:o,filterHash:s,dataVersion:this.dataVersion}}clearFilterCache(){this.filterCache=null}getGroupTreeFromCache(t,n){if(!this.groupTreeCache||this.groupTreeCache.dataVersion!==this.dataVersion)return null;const o=[...t].sort((i,c)=>i-c),s=De(o);if(this.groupTreeCache.fundIdsHash!==s)return null;const a=Array.from(n).map(i=>typeof i=="string"?parseInt(i,10):i).filter(i=>!isNaN(i)).sort((i,c)=>i-c),r=De(a);return this.groupTreeCache.expandedHash!==r?null:this.groupTreeCache.tree}setGroupTreeCache(t,n,o){const s=[...t].sort((c,u)=>c-u),a=De(s),r=Array.from(n).map(c=>typeof c=="string"?parseInt(c,10):c).filter(c=>!isNaN(c)).sort((c,u)=>c-u),i=De(r);this.groupTreeCache={tree:o,fundIdsHash:a,expandedHash:i,dataVersion:this.dataVersion}}clearGroupTreeCache(){this.groupTreeCache=null}clearConsolidatedMetricsCache(){this.consolidatedMetricsCache.clear()}setFunds(t){this.currentFunds=t}setGroups(t){this.groups=t,this.groupsMap.clear(),t.forEach(n=>this.groupsMap.set(n.id,n)),this.childrenByParentId.clear();for(const n of t){const o=n.parentGroupId,s=this.childrenByParentId.get(o)||[];s.push(n.id),this.childrenByParentId.set(o,s)}this.ancestorCache.clear(),this.groupDescendantsCache.clear(),this.groupTreeCache=null}getGroupByIdSync(t){return this.groupsMap.get(t)}getDirectChildIds(t){return this.childrenByParentId.get(t)||[]}getTopLevelGroupIds(){return this.childrenByParentId.get(null)||[]}getAncestorIds(t){const n=this.ancestorCache.get(t);if(n)return n;const o=[];let s=t;for(;s!=null;){const a=this.groupsMap.get(s);if(!a)break;o.push(a.id),s=a.parentGroupId}return this.ancestorCache.set(t,o),o}getDescendantIds(t){const n=this.groupDescendantsCache.get(t);if(n)return n;const o=[t],s=this.childrenByParentId.get(t)||[];for(const a of s){const r=this.getDescendantIds(a);o.push(...r)}return this.groupDescendantsCache.set(t,o),o}clearDescendantCache(){this.groupDescendantsCache.clear()}setUnsavedChanges(t){this.hasUnsavedChanges=t}setFundModalUnsavedChanges(t){this.fundModalHasUnsavedChanges=t}setFundNames(t){this.fundNames=t}setFundNameData(t){this.fundNameData=t}setSortColumns(t){this.sortColumns=t}setCurrentActionFundId(t){this.currentActionFundId=t}setCurrentDetailsFundId(t){this.currentDetailsFundId=t}setAbortController(t){this.abortController=t}markDataChanged(){this.dataVersion++,this.dataChangedSinceLastExport=!0}markDataExported(){this.dataChangedSinceLastExport=!1,this.lastExportReminderTime=Date.now()}needsHealthCheckRefresh(){return this.lastHealthCheckVersion!==this.dataVersion}markHealthCheckRun(){this.lastHealthCheckVersion=this.dataVersion}invalidateHealthCheck(){this.lastHealthCheckVersion=-1}shouldShowExportReminder(t){return this.dataChangedSinceLastExport?Date.now()-this.lastExportReminderTime>=t:!1}dismissExportReminder(){this.lastExportReminderTime=Date.now()}resetDisplayLimit(){this.displayLimit=50}loadMore(){this.displayLimit+=this.displayLimitIncrement}}const h=new $o,Oo="modulepreload",_o=function(e,t){return new URL(e,t).href},In={},Po=function(t,n,o){let s=Promise.resolve();if(n&&n.length>0){const r=document.getElementsByTagName("link"),i=document.querySelector("meta[property=csp-nonce]"),c=i?.nonce||i?.getAttribute("nonce");s=Promise.allSettled(n.map(u=>{if(u=_o(u,o),u in In)return;In[u]=!0;const l=u.endsWith(".css"),d=l?'[rel="stylesheet"]':"";if(!!o)for(let y=r.length-1;y>=0;y--){const f=r[y];if(f.href===u&&(!l||f.rel==="stylesheet"))return}else if(document.querySelector(`link[href="${u}"]${d}`))return;const g=document.createElement("link");if(g.rel=l?"stylesheet":Oo,l||(g.as="script"),g.crossOrigin="",g.href=u,c&&g.setAttribute("nonce",c),document.head.appendChild(g),l)return new Promise((y,f)=>{g.addEventListener("load",y),g.addEventListener("error",()=>f(new Error(`Unable to preload CSS for ${u}`)))})}))}function a(r){const i=new Event("vite:preloadError",{cancelable:!0});if(i.payload=r,window.dispatchEvent(i),!i.defaultPrevented)throw r}return s.then(r=>{for(const i of r||[])i.status==="rejected"&&a(i.reason);return t().catch(a)})};function Uo(e,t){const n=[];if(!e&&t)return[{field:"record",oldValue:null,newValue:"created"}];if(e&&!t)return[{field:"record",oldValue:"existed",newValue:null}];if(!e||!t)return n;const o=new Set([...Object.keys(e),...Object.keys(t)]);for(const s of o){if(s==="id"||s==="timestamp")continue;const a=e[s],r=t[s],i=JSON.stringify(a),c=JSON.stringify(r);i!==c&&n.push({field:s,oldValue:a,newValue:r})}return n}function Yo(e){return e.length===0?"No changes":e.map(t=>{if(t.field==="record")return t.newValue==="created"?"Created new record":"Deleted record";const n=o=>{if(o==null)return"empty";const s=typeof o=="object"?JSON.stringify(o):String(o);return s.length>50?s.substring(0,47)+"...":s};return`${t.field}: ${n(t.oldValue)} → ${n(t.newValue)}`}).join("; ")}function re(e){if(typeof e!="string"||!/^\d{4}-\d{2}-\d{2}$/.test(e))return!1;const t=new Date(e+"T00:00:00");if(isNaN(t.getTime()))return!1;const[n,o,s]=e.split("-").map(Number);return t.getFullYear()===n&&t.getMonth()+1===o&&t.getDate()===s}function Vn(e){const t=[];if(!e||typeof e!="object")return{valid:!1,errors:["Fund data is required"]};const n=e;(!n.fundName||typeof n.fundName!="string"||!n.fundName.trim())&&t.push("Fund name is required"),(!n.accountNumber||typeof n.accountNumber!="string"||!n.accountNumber.trim())&&t.push("Account number is required");const o=1e15;return typeof n.commitment!="number"?t.push("Commitment must be a number"):isNaN(n.commitment)?t.push("Commitment is NaN (invalid number)"):isFinite(n.commitment)?n.commitment<0?t.push("Commitment cannot be negative"):n.commitment>o&&t.push(`Commitment exceeds maximum allowed value (${o})`):t.push("Commitment must be a finite number"),n.cashFlows!==void 0&&(Array.isArray(n.cashFlows)?n.cashFlows.forEach((s,a)=>{if(!s||typeof s!="object"){t.push(`Cash flow at index ${a} is invalid`);return}const r=s;typeof r.amount!="number"?t.push(`Cash flow ${a}: amount must be a number`):isNaN(r.amount)?t.push(`Cash flow ${a}: amount is NaN (invalid number)`):isFinite(r.amount)?Math.abs(r.amount)>o&&t.push(`Cash flow ${a}: amount exceeds maximum allowed value`):t.push(`Cash flow ${a}: amount must be finite`),!r.date||typeof r.date!="string"?t.push(`Cash flow ${a}: date is required`):re(r.date)||t.push(`Cash flow ${a}: invalid date format (expected YYYY-MM-DD)`),r.type?["Contribution","Distribution","Adjustment"].includes(r.type)||t.push(`Cash flow ${a}: invalid type "${r.type}"`):t.push(`Cash flow ${a}: type is required`)}):t.push("Cash flows must be an array")),n.monthlyNav!==void 0&&(Array.isArray(n.monthlyNav)?n.monthlyNav.forEach((s,a)=>{if(s&&typeof s=="object"){const r=s;typeof r.amount!="number"?t.push(`NAV ${a}: amount must be a number`):isNaN(r.amount)?t.push(`NAV ${a}: amount is NaN (invalid number)`):isFinite(r.amount)?Math.abs(r.amount)>o&&t.push(`NAV ${a}: amount exceeds maximum allowed value`):t.push(`NAV ${a}: amount must be finite`),!r.date||typeof r.date!="string"?t.push(`NAV ${a}: date is required`):re(r.date)||t.push(`NAV ${a}: invalid date format (expected YYYY-MM-DD)`)}else t.push(`NAV entry at index ${a} is invalid`)}):t.push("Monthly NAV must be an array")),{valid:t.length===0,errors:t}}let St=null;async function Vo(){return St||(St=(await Po(()=>Promise.resolve().then(()=>Bs),void 0,import.meta.url)).showStatus),St}function Ho(e,t="success"){Vo().then(n=>n?.(e,t)).catch(console.error)}let G=null;function Wo(){return new Promise((e,t)=>{const n=indexedDB.open(E.DB_NAME,E.DB_VERSION);n.onerror=()=>t(n.error),n.onsuccess=()=>{G=n.result,e(G)},n.onupgradeneeded=o=>{const s=o.target.result,a=o.oldVersion,r=o.target.transaction;if(r.onerror=()=>{console.error("Migration transaction error:",r.error)},r.onabort=()=>{console.error("Migration transaction aborted:",r.error)},!s.objectStoreNames.contains(E.FUNDS_STORE)){const i=s.createObjectStore(E.FUNDS_STORE,{keyPath:"id",autoIncrement:!0});i.createIndex("fundName","fundName",{unique:!1}),i.createIndex("accountNumber","accountNumber",{unique:!1})}if(s.objectStoreNames.contains(E.FUNDNAMES_STORE)||s.createObjectStore(E.FUNDNAMES_STORE,{keyPath:"name"}),!s.objectStoreNames.contains(E.GROUPS_STORE)){const i=s.createObjectStore(E.GROUPS_STORE,{keyPath:"id",autoIncrement:!0});i.createIndex("parentGroupId","parentGroupId",{unique:!1}),i.createIndex("name","name",{unique:!1})}if(!s.objectStoreNames.contains(E.AUDIT_STORE)){const i=s.createObjectStore(E.AUDIT_STORE,{keyPath:"id",autoIncrement:!0});i.createIndex("timestamp","timestamp",{unique:!1}),i.createIndex("operation","operation",{unique:!1}),i.createIndex("entityType","entityType",{unique:!1}),i.createIndex("entityId","entityId",{unique:!1})}if(!s.objectStoreNames.contains(E.DISMISSED_ISSUES_STORE)){const i=s.createObjectStore(E.DISMISSED_ISSUES_STORE,{keyPath:"id",autoIncrement:!0});i.createIndex("fund1Id","fund1Id",{unique:!1}),i.createIndex("fund2Id","fund2Id",{unique:!1})}if(a<6&&a>=5){s.objectStoreNames.contains("tags")&&s.deleteObjectStore("tags");const i=r.objectStore(E.FUNDS_STORE),c=r.objectStore(E.FUNDNAMES_STORE),u=new Map,l=i.openCursor();l.onerror=function(){console.error("Cursor error during v5-v6 migration:",l.error)},l.onsuccess=function(d){const m=d.target.result;if(m){const g=m.value;g.tags&&Array.isArray(g.tags)&&g.tags.length>0&&(u.has(g.fundName)||u.set(g.fundName,new Set),g.tags.forEach(y=>u.get(g.fundName).add(y))),delete g.tags,m.update(g),m.continue()}else{const g=c.getAll();g.onerror=function(){console.error("Error getting fund names during v5-v6 migration:",g.error)},g.onsuccess=function(y){y.target.result.forEach(p=>{const v=p.name,F=u.has(v)?Array.from(u.get(v)):[];c.put({name:v,tags:F})})}}}}if(a===9){if(s.objectStoreNames.contains("investments")&&!s.objectStoreNames.contains("funds")){const i=s.createObjectStore("funds",{keyPath:"id",autoIncrement:!0});i.createIndex("fundName","fundName",{unique:!1}),i.createIndex("accountNumber","accountNumber",{unique:!1});const c=r.objectStore("investments");c.openCursor().onsuccess=function(u){const l=u.target.result;l&&(i.put(l.value),l.continue())}}if(s.objectStoreNames.contains("investmentNames")&&!s.objectStoreNames.contains("fundNames")){s.createObjectStore("fundNames",{keyPath:"name"});const i=r.objectStore("investmentNames"),c=r.objectStore("fundNames");i.openCursor().onsuccess=function(u){const l=u.target.result;l&&(c.put(l.value),l.continue())}}s.objectStoreNames.contains("investments")&&s.deleteObjectStore("investments"),s.objectStoreNames.contains("investmentNames")&&s.deleteObjectStore("investmentNames")}}})}async function Wt(e,t,n){if(!G)throw new Error("Database not initialized");return new Promise((o,s)=>{let a=!1;const r=G.transaction([e],t),i=r.objectStore(e),c=n(i);c.onsuccess=()=>{a||(a=!0,o(c.result))},c.onerror=()=>{a||(a=!0,s(c.error))},r.onabort=()=>{a||(a=!0,s(new Error("Transaction aborted")))},r.onerror=()=>{a||(a=!0,s(r.error||new Error("Transaction error")))}})}let Sn=Promise.resolve();function ie(e){const t=new Promise((n,o)=>{const s=Vn(e);if(!s.valid){const d=`Fund validation failed: ${s.errors.join("; ")}`;console.error(d,{fundId:e.id,fundName:e.fundName}),o(new Error(d));return}if(!G){o(new Error("Database not initialized"));return}let a=!1;const r=!!e.id,i=G.transaction([E.FUNDS_STORE],"readwrite"),c=i.objectStore(E.FUNDS_STORE);i.onabort=()=>{a||(a=!0,o(new Error("Transaction aborted")))},i.onerror=()=>{a||(a=!0,o(i.error||new Error("Transaction error")))};let u;const l=()=>{let d;if(e.id)d=c.put(e);else{const{id:m,...g}=e;d=c.add(g)}d.onsuccess=()=>{if(a)return;a=!0;const m=d.result;h.markDataChanged();const g={...e,id:m};qn(r?"UPDATE":"CREATE",g,u).catch(y=>{console.error("Audit log failed for fund:",{fundId:m,action:r?"UPDATE":"CREATE"},y)}),n(m)},d.onerror=()=>{a||(a=!0,o(d.error))}};if(r){const d=c.get(e.id);d.onsuccess=()=>{u=d.result?gt(d.result):void 0,l()},d.onerror=()=>{l()}}else l()});return Sn=Sn.then(()=>t).catch(()=>t),t}function Cn(e){if(!e)return"";if(typeof e=="string"&&/^\d{4}-\d{2}-\d{2}$/.test(e))return e;let t=String(e).trim();const n=t.match(/^(\d{1,2})\/(\d{1,2})\/(\d{4})$/);if(n){const[,r,i,c]=n;return`${c}-${r.padStart(2,"0")}-${i.padStart(2,"0")}`}const o=t.match(/^(\d{4})\/(\d{1,2})\/(\d{1,2})$/);if(o){const[,r,i,c]=o;return`${r}-${i.padStart(2,"0")}-${c.padStart(2,"0")}`}const s=t.match(/^(\d{1,2})-(\d{1,2})-(\d{4})$/);if(s){const[,r,i,c]=s;return`${c}-${i.padStart(2,"0")}-${r.padStart(2,"0")}`}const a=t.match(/^(\d{4})-(\d{2})-(\d{2})T/);if(a){const[,r,i,c]=a;return`${r}-${i}-${c}`}return console.warn("Could not normalize date format:",e),t}function jo(e,t){if(typeof e=="string"){const n=e.toLowerCase().trim();if(n==="contribution"||n==="capital call")return"Contribution";if(n==="distribution")return"Distribution";if(n==="adjustment")return"Adjustment"}return t<0?"Contribution":"Distribution"}function gt(e){const t=Array.isArray(e.cashFlows)?e.cashFlows.map(o=>{const s=typeof o.amount=="number"?o.amount:parseFloat(o.amount)||0;return{date:Cn(o.date),amount:s,type:jo(o.type,s),affectsCommitment:o.affectsCommitment!==void 0?o.affectsCommitment:!0}}):[],n=Array.isArray(e.monthlyNav)?e.monthlyNav.map(o=>({date:Cn(o.date),amount:typeof o.amount=="number"?o.amount:parseFloat(o.amount)||0})):[];return{id:e.id,fundName:e.fundName||"",accountNumber:e.accountNumber||"",commitment:typeof e.commitment=="number"?e.commitment:parseFloat(e.commitment)||0,groupId:e.groupId??null,cashFlows:t,monthlyNav:n,timestamp:e.timestamp||new Date().toISOString()}}async function q(){return(await Wt(E.FUNDS_STORE,"readonly",t=>t.getAll())).map(gt)}async function ye(e){const t=await Wt(E.FUNDS_STORE,"readonly",n=>n.get(e));return t?gt(t):void 0}function Hn(e){return new Promise((t,n)=>{if(!G){n(new Error("Database not initialized"));return}const s=G.transaction([E.FUNDS_STORE],"readwrite").objectStore(E.FUNDS_STORE),a=s.get(e);a.onsuccess=()=>{const r=a.result?gt(a.result):null,i=s.delete(e);i.onsuccess=()=>{h.markDataChanged(),r&&qn("DELETE",r).catch(c=>{console.error("[AUDIT] Failed to log deletion:",c),Ho("Warning: Deletion succeeded but audit log failed","warning")}),t()},i.onerror=()=>n(i.error)},a.onerror=()=>{const r=s.delete(e);r.onsuccess=()=>t(),r.onerror=()=>n(r.error)}})}function We(){return new Promise((e,t)=>{if(!G){t(new Error("Database not initialized"));return}const s=G.transaction([E.FUNDNAMES_STORE],"readonly").objectStore(E.FUNDNAMES_STORE).getAll();s.onsuccess=()=>{const a=s.result.map(r=>({name:r.name,tags:r.tags||[],investmentTermStartDate:r.investmentTermStartDate||r.finalCloseDate||null,investmentTermYears:r.investmentTermYears||null}));e(a)},s.onerror=()=>t(s.error)})}function Se(e){return new Promise((t,n)=>{if(!G){n(new Error("Database not initialized"));return}const o=typeof e=="string"?{name:e,tags:[],investmentTermStartDate:null,investmentTermYears:null}:{name:e.name,tags:e.tags||[],investmentTermStartDate:e.investmentTermStartDate||null,investmentTermYears:e.investmentTermYears||null},r=G.transaction([E.FUNDNAMES_STORE],"readwrite").objectStore(E.FUNDNAMES_STORE).put(o);r.onsuccess=()=>{h.markDataChanged(),t()},r.onerror=()=>n(r.error)})}function Wn(e){return new Promise((t,n)=>{if(!G){n(new Error("Database not initialized"));return}const a=G.transaction([E.FUNDNAMES_STORE],"readwrite").objectStore(E.FUNDNAMES_STORE).delete(e);a.onsuccess=()=>{h.markDataChanged(),t()},a.onerror=()=>n(a.error)})}function he(){return Wt(E.GROUPS_STORE,"readonly",e=>e.getAll())}function jt(e){return new Promise((t,n)=>{if(!G){n(new Error("Database not initialized"));return}const a=G.transaction([E.GROUPS_STORE],"readwrite").objectStore(E.GROUPS_STORE).put(e);a.onsuccess=()=>{h.markDataChanged(),t(a.result)},a.onerror=()=>n(a.error)})}function qo(e){return new Promise((t,n)=>{if(!G){n(new Error("Database not initialized"));return}const a=G.transaction([E.GROUPS_STORE],"readwrite").objectStore(E.GROUPS_STORE).delete(e);a.onsuccess=()=>{h.markDataChanged(),t()},a.onerror=()=>n(a.error)})}function Zo(){return new Promise((e,t)=>{if(!G){t(new Error("Database not initialized"));return}const n=G.transaction([E.FUNDS_STORE,E.FUNDNAMES_STORE,E.GROUPS_STORE],"readwrite");let o=0,s=!1;const a=[E.FUNDS_STORE,E.FUNDNAMES_STORE,E.GROUPS_STORE];n.onerror=()=>{if(s)return;s=!0;const i=(n.error?.name||"")==="QuotaExceededError"?"Storage quota exceeded. Please free up browser storage and try again.":`Database error: ${n.error?.message||"Transaction failed"}`;console.error("Transaction error in clearAllData:",n.error),t(new Error(i))},n.onabort=()=>{if(s)return;s=!0;const i=(n.error?.name||"")==="QuotaExceededError"?"Storage quota exceeded. Please free up browser storage and try again.":`Database error: ${n.error?.message||"Transaction aborted"}`;console.error("Transaction aborted in clearAllData:",n.error),t(new Error(i))},a.forEach(r=>{const c=n.objectStore(r).clear();c.onsuccess=()=>{s||(o++,o===a.length&&(s=!0,h.markDataChanged(),jn({operation:"CLEAR_ALL",entityType:"System",entityId:null,entityName:null,summary:"Cleared all data (funds, groups, fund names)"}).catch(console.error),e()))},c.onerror=()=>{s||(s=!0,t(c.error))}})})}function jn(e){return new Promise((t,n)=>{if(!G){console.warn("[AUDIT] DB not ready, logging to console:",e),t(-1);return}if(!G.objectStoreNames.contains(E.AUDIT_STORE)){console.warn("[AUDIT] Audit store not available, logging to console:",e),t(-1);return}const o={...e,timestamp:new Date().toISOString()},r=G.transaction([E.AUDIT_STORE],"readwrite").objectStore(E.AUDIT_STORE).add(o);r.onsuccess=()=>t(r.result),r.onerror=()=>{console.error("[AUDIT] Failed to log entry:",r.error),n(r.error)}})}function zo(e){return new Promise((t,n)=>{if(!G){n(new Error("Database not initialized"));return}if(!G.objectStoreNames.contains(E.AUDIT_STORE)){t([]);return}const a=G.transaction([E.AUDIT_STORE],"readonly").objectStore(E.AUDIT_STORE).getAll();a.onsuccess=()=>{let r=a.result;r.sort((i,c)=>c.timestamp.localeCompare(i.timestamp)),t(r)},a.onerror=()=>n(a.error)})}async function qn(e,t,n){const o=Uo(n,e==="DELETE"?null:t);await jn({operation:e,entityType:"Fund",entityId:t.id??null,entityName:t.fundName,summary:Yo(o),previousValue:n,newValue:e==="DELETE"?void 0:t})}function Ko(){return new Promise((e,t)=>{if(!G){t(new Error("Database not initialized"));return}if(!G.objectStoreNames.contains(E.DISMISSED_ISSUES_STORE)){e([]);return}const s=G.transaction([E.DISMISSED_ISSUES_STORE],"readonly").objectStore(E.DISMISSED_ISSUES_STORE).getAll();s.onsuccess=()=>e(s.result),s.onerror=()=>t(s.error)})}function Xo(e,t,n){return new Promise((o,s)=>{if(!G){s(new Error("Database not initialized"));return}if(!G.objectStoreNames.contains(E.DISMISSED_ISSUES_STORE)){s(new Error("Dismissed issues store not available"));return}const a=Math.min(e,t),r=Math.max(e,t),i={fund1Id:a,fund2Id:r,reason:n,dismissedAt:new Date().toISOString()},l=G.transaction([E.DISMISSED_ISSUES_STORE],"readwrite").objectStore(E.DISMISSED_ISSUES_STORE).add(i);l.onsuccess=()=>o(),l.onerror=()=>s(l.error)})}function Jo(e,t,n){return new Promise((o,s)=>{if(!G){s(new Error("Database not initialized"));return}if(!G.objectStoreNames.contains(E.DISMISSED_ISSUES_STORE)){s(new Error("Dismissed issues store not available"));return}const a={fund1Id:e,fund2Id:0,category:t,message:n,reason:`${t}: ${n}`,dismissedAt:new Date().toISOString()},c=G.transaction([E.DISMISSED_ISSUES_STORE],"readwrite").objectStore(E.DISMISSED_ISSUES_STORE).add(a);c.onsuccess=()=>o(),c.onerror=()=>s(c.error)})}function Qo(e){return new Date(e+"T00:00:00").getTime()}function Nn(e){return e>=E.IRR_MIN_RATE&&e<=E.IRR_MAX_RATE}function Zn(e,t=E.IRR_GUESS){if(!Array.isArray(e)||e.length<2)return null;const n=e.map(m=>({amount:m.amount,timestamp:Qo(m.date)}));n.sort((m,g)=>m.timestamp-g.timestamp);const o=n[0],s=n[n.length-1];if(!o||!s)return null;const a=o.timestamp;if((s.timestamp-a)/E.MS_PER_DAY<E.IRR_MIN_DAYS)return null;const c=n.map(m=>({amount:m.amount,yearsDiff:(m.timestamp-a)/E.MS_PER_YEAR})),u=m=>c.reduce((g,y)=>g+y.amount/Math.pow(1+m,y.yearsDiff),0),l=m=>c.reduce((g,y)=>y.yearsDiff===0?g:g-y.yearsDiff*y.amount/Math.pow(1+m,y.yearsDiff+1),0);let d=t;for(let m=0;m<E.IRR_MAX_ITERATIONS;m++){const g=u(d),y=l(d);if(Math.abs(g)<E.IRR_PRECISION)return Nn(d)?d:null;if(Math.abs(y)<E.IRR_PRECISION)return null;const f=d-g/y;if(Math.abs(f-d)<E.IRR_PRECISION)return Nn(f)?f:null;d=f}return null}function zn(e){if(!Array.isArray(e)||e.length===0)return null;const t=e.filter(o=>o.amount<0).reduce((o,s)=>o+Math.abs(s.amount),0),n=e.filter(o=>o.amount>0).reduce((o,s)=>o+s.amount,0);return t===0?null:n/t}function ee(e){if(e===null||typeof e>"u")return NaN;if(typeof e=="number")return isFinite(e)?e:NaN;if(typeof e=="string"){const t=e.replace(/[$,]/g,"").replace(/^\((.*)\)$/,"-$1").trim();if(t==="")return NaN;const n=parseFloat(t);return isFinite(n)?n:NaN}return NaN}function Ve(e,t){if(e==null||isNaN(e))return"";const o=(t!==void 0?e.toFixed(t):e.toString()).split(".");return o[0]=o[0].replace(/\B(?=(\d{3})+(?!\d))/g,","),o.join(".")}function k(e,t=!1){const n=typeof e=="string"?parseFloat(e):e;return!isFinite(n)||isNaN(n)?"$0":n.toLocaleString("en-US",{style:"currency",currency:"USD",minimumFractionDigits:t?2:0,maximumFractionDigits:t?2:0})}function Ct(e){return Math.round(e*100)/100}function Ce(e,t){const n=ee(e);return Number.isNaN(n)&&e!=null&&e!==""&&e!==0&&console.warn(`Currency parse failed (${t}):`,e),Number.isNaN(n)?0:n}function te(e){return new Date(e+"T00:00:00")}function es(e,t){const n=t?t.getTime():null,o=(e.cashFlows||[]).filter(a=>re(a.date)).map(a=>({date:a.date,timestamp:te(a.date).getTime(),type:a.type,amount:Ce(a.amount,"cash flow amount"),affectsCommitment:a.affectsCommitment!==!1})).filter(a=>n===null||a.timestamp<=n),s=(e.monthlyNav||[]).filter(a=>re(a.date)).map(a=>({date:a.date,timestamp:te(a.date).getTime(),amount:Ce(a.amount,"NAV amount")})).filter(a=>n===null||a.timestamp<=n);return{cashFlows:o,navs:s,cutoffTimestamp:n}}function At(e){let t=null;for(const n of e.cashFlows||[])n.type==="Contribution"&&re(n.date)&&(t===null||n.date<t)&&(t=n.date);return t?te(t).getFullYear():null}function ts(e,t,n){return(e.cashFlows||[]).filter(s=>s.type===t&&re(s.date)&&!0).reduce((s,a)=>s+Math.abs(Ce(a.amount,"cash flow amount")),0)}function ns(e,t){const n=(e.monthlyNav||[]).filter(i=>re(i.date)&&(!t||te(i.date)<=t)).sort((i,c)=>te(c.date).getTime()-te(i.date).getTime());if(n.length===0)return 0;const o=n[0];let s=Ce(o.amount,"NAV amount");const a=te(o.date);return(e.cashFlows||[]).filter(i=>{if(!re(i.date))return!1;const c=te(i.date);return c>a&&(!t||c<=t)}).forEach(i=>{const c=Ce(i.amount,"cash flow amount");i.type==="Contribution"?s+=Math.abs(c):i.type==="Distribution"&&(s-=Math.abs(c))}),s}function os(e,t){const n=(e.cashFlows||[]).filter(a=>re(a.date)&&(!t||te(a.date)<=t)&&a.type!=="Adjustment").map(a=>{const r=Ce(a.amount,"cash flow amount");return{date:a.date,amount:a.type==="Contribution"?-Math.abs(r):Math.abs(r)}}),o=ns(e,t),s=(e.monthlyNav||[]).filter(a=>re(a.date)&&(!t||te(a.date)<=t)).sort((a,r)=>te(r.date).getTime()-te(a.date).getTime());return s.length>0&&n.push({date:s[0].date,amount:o}),n.sort((a,r)=>te(a.date).getTime()-te(r.date).getTime())}function ce(e,t){const n=Ce(e.commitment,"commitment"),{cashFlows:o,navs:s}=es(e,t),a=[...o].sort((b,w)=>b.timestamp-w.timestamp),r=[...s].sort((b,w)=>w.timestamp-b.timestamp),i=Ct(a.filter(b=>b.type==="Contribution").reduce((b,w)=>b+Math.abs(w.amount),0)),c=Ct(a.filter(b=>b.type==="Distribution").reduce((b,w)=>b+Math.abs(w.amount),0));let u=0,l=null;if(r.length>0){const b=r[0];u=b.amount,l=b.date;const w=b.timestamp;for(const C of a)C.timestamp>w&&(C.type==="Contribution"?u+=Math.abs(C.amount):C.type==="Distribution"&&(u-=Math.abs(C.amount)))}let d=n;for(const b of a)b.type==="Adjustment"?d-=b.amount:b.affectsCommitment&&(b.type==="Contribution"?d-=Math.abs(b.amount):b.type==="Distribution"&&(d+=Math.abs(b.amount)));d=Math.max(0,d);const m=a.find(b=>b.type==="Contribution"),g=m?new Date(m.timestamp).getFullYear():null,y=Ct(c+u-i),f=a.filter(b=>b.type!=="Adjustment").map(b=>({date:b.date,amount:b.type==="Contribution"?-Math.abs(b.amount):Math.abs(b.amount)}));r.length>0&&f.push({date:r[0].date,amount:u}),f.sort((b,w)=>te(b.date).getTime()-te(w.date).getTime());const p=Zn(f),v=zn(f),F=i>0?c/i:null,N=i>0?u/i:null,D=i>0?(c+u)/i:null;return{calledCapital:i,distributions:c,nav:u,navDate:l,irr:p,moic:v,dpi:F,rvpi:N,tvpi:D,outstandingCommitment:d,vintageYear:g,commitment:n,totalContributions:i,totalDistributions:c,investmentReturn:y,vintage:g}}function kt(e,t){if(e.id==null)return ce(e,t);const n=t?.toISOString()??"current",o=h.getMetricsFromCache(e.id,n);if(o)return o;const s=ce(e,t);return h.setMetricsCache(e.id,n,s),s}const Kn="KGZ1bmN0aW9uKCl7InVzZSBzdHJpY3QiO2NvbnN0IGQ9e0lSUl9NQVhfSVRFUkFUSU9OUzoxZTMsSVJSX1BSRUNJU0lPTjoxZS02LElSUl9HVUVTUzouMSxJUlJfTUlOX1JBVEU6LS45OSxJUlJfTUFYX1JBVEU6MTAsSVJSX01JTl9EQVlTOjMwLE1TX1BFUl9EQVk6ODY0ZTUsTVNfUEVSX1lFQVI6MzE1NTc2ZTV9O2Z1bmN0aW9uIGgodCl7aWYodHlwZW9mIHQhPSJzdHJpbmcifHwhL15cZHs0fS1cZHsyfS1cZHsyfSQvLnRlc3QodCkpcmV0dXJuITE7Y29uc3Qgcz1uZXcgRGF0ZSh0KyJUMDA6MDA6MDAiKTtpZihpc05hTihzLmdldFRpbWUoKSkpcmV0dXJuITE7Y29uc3RbYSxpLHJdPXQuc3BsaXQoIi0iKS5tYXAoTnVtYmVyKTtyZXR1cm4gcy5nZXRGdWxsWWVhcigpPT09YSYmcy5nZXRNb250aCgpKzE9PT1pJiZzLmdldERhdGUoKT09PXJ9ZnVuY3Rpb24gVCh0KXtpZih0PT09bnVsbHx8dHlwZW9mIHQ+InUiKXJldHVybiBOYU47aWYodHlwZW9mIHQ9PSJudW1iZXIiKXJldHVybiBpc0Zpbml0ZSh0KT90Ok5hTjtpZih0eXBlb2YgdD09InN0cmluZyIpe2NvbnN0IHM9dC5yZXBsYWNlKC9bJCxdL2csIiIpLnJlcGxhY2UoL15cKCguKilcKSQvLCItJDEiKS50cmltKCk7aWYocz09PSIiKXJldHVybiBOYU47Y29uc3QgYT1wYXJzZUZsb2F0KHMpO3JldHVybiBpc0Zpbml0ZShhKT9hOk5hTn1yZXR1cm4gTmFOfWZ1bmN0aW9uIEEodCl7cmV0dXJuIG5ldyBEYXRlKHQrIlQwMDowMDowMCIpLmdldFRpbWUoKX1mdW5jdGlvbiBnKHQpe3JldHVybiB0Pj1kLklSUl9NSU5fUkFURSYmdDw9ZC5JUlJfTUFYX1JBVEV9ZnVuY3Rpb24gQyh0LHM9ZC5JUlJfR1VFU1Mpe2lmKCFBcnJheS5pc0FycmF5KHQpfHx0Lmxlbmd0aDwyKXJldHVybiBudWxsO2NvbnN0IGE9dC5tYXAobz0+KHthbW91bnQ6by5hbW91bnQsdGltZXN0YW1wOkEoby5kYXRlKX0pKTthLnNvcnQoKG8sbCk9Pm8udGltZXN0YW1wLWwudGltZXN0YW1wKTtjb25zdCBpPWFbMF0scj1hW2EubGVuZ3RoLTFdO2lmKCFpfHwhcilyZXR1cm4gbnVsbDtjb25zdCBuPWkudGltZXN0YW1wO2lmKChyLnRpbWVzdGFtcC1uKS9kLk1TX1BFUl9EQVk8ZC5JUlJfTUlOX0RBWVMpcmV0dXJuIG51bGw7Y29uc3QgZj1hLm1hcChvPT4oe2Ftb3VudDpvLmFtb3VudCx5ZWFyc0RpZmY6KG8udGltZXN0YW1wLW4pL2QuTVNfUEVSX1lFQVJ9KSksUj1vPT5mLnJlZHVjZSgobCxjKT0+bCtjLmFtb3VudC9NYXRoLnBvdygxK28sYy55ZWFyc0RpZmYpLDApLGI9bz0+Zi5yZWR1Y2UoKGwsYyk9PmMueWVhcnNEaWZmPT09MD9sOmwtYy55ZWFyc0RpZmYqYy5hbW91bnQvTWF0aC5wb3coMStvLGMueWVhcnNEaWZmKzEpLDApO2xldCB1PXM7Zm9yKGxldCBvPTA7bzxkLklSUl9NQVhfSVRFUkFUSU9OUztvKyspe2NvbnN0IGw9Uih1KSxjPWIodSk7aWYoTWF0aC5hYnMobCk8ZC5JUlJfUFJFQ0lTSU9OKXJldHVybiBnKHUpP3U6bnVsbDtpZihNYXRoLmFicyhjKTxkLklSUl9QUkVDSVNJT04pcmV0dXJuIG51bGw7Y29uc3QgeT11LWwvYztpZihNYXRoLmFicyh5LXUpPGQuSVJSX1BSRUNJU0lPTilyZXR1cm4gZyh5KT95Om51bGw7dT15fXJldHVybiBudWxsfWZ1bmN0aW9uIEUodCl7aWYoIUFycmF5LmlzQXJyYXkodCl8fHQubGVuZ3RoPT09MClyZXR1cm4gbnVsbDtjb25zdCBzPXQuZmlsdGVyKGk9PmkuYW1vdW50PDApLnJlZHVjZSgoaSxyKT0+aStNYXRoLmFicyhyLmFtb3VudCksMCksYT10LmZpbHRlcihpPT5pLmFtb3VudD4wKS5yZWR1Y2UoKGkscik9Pmkrci5hbW91bnQsMCk7cmV0dXJuIHM9PT0wP251bGw6YS9zfWZ1bmN0aW9uIEQodCl7cmV0dXJuIE1hdGgucm91bmQodCoxMDApLzEwMH1mdW5jdGlvbiBfKHQscyl7Y29uc3QgYT1UKHQpO3JldHVybiBOdW1iZXIuaXNOYU4oYSkmJnQhPW51bGwmJnQhPT0iIiYmdCE9PTAmJmNvbnNvbGUud2FybihgQ3VycmVuY3kgcGFyc2UgZmFpbGVkICgke3N9KTpgLHQpLE51bWJlci5pc05hTihhKT8wOmF9ZnVuY3Rpb24gTSh0KXtyZXR1cm4gbmV3IERhdGUodCsiVDAwOjAwOjAwIil9ZnVuY3Rpb24gdyh0LHMpe2NvbnN0IGE9cz9zLmdldFRpbWUoKTpudWxsLGk9KHQuY2FzaEZsb3dzfHxbXSkuZmlsdGVyKG49Pmgobi5kYXRlKSkubWFwKG49Pih7ZGF0ZTpuLmRhdGUsdGltZXN0YW1wOk0obi5kYXRlKS5nZXRUaW1lKCksdHlwZTpuLnR5cGUsYW1vdW50Ol8obi5hbW91bnQsImNhc2ggZmxvdyBhbW91bnQiKSxhZmZlY3RzQ29tbWl0bWVudDpuLmFmZmVjdHNDb21taXRtZW50IT09ITF9KSkuZmlsdGVyKG49PmE9PT1udWxsfHxuLnRpbWVzdGFtcDw9YSkscj0odC5tb250aGx5TmF2fHxbXSkuZmlsdGVyKG49Pmgobi5kYXRlKSkubWFwKG49Pih7ZGF0ZTpuLmRhdGUsdGltZXN0YW1wOk0obi5kYXRlKS5nZXRUaW1lKCksYW1vdW50Ol8obi5hbW91bnQsIk5BViBhbW91bnQiKX0pKS5maWx0ZXIobj0+YT09PW51bGx8fG4udGltZXN0YW1wPD1hKTtyZXR1cm57Y2FzaEZsb3dzOmksbmF2czpyLGN1dG9mZlRpbWVzdGFtcDphfX1mdW5jdGlvbiBTKHQscyl7Y29uc3QgYT1fKHQuY29tbWl0bWVudCwiY29tbWl0bWVudCIpLHtjYXNoRmxvd3M6aSxuYXZzOnJ9PXcodCxzKSxuPVsuLi5pXS5zb3J0KChlLHApPT5lLnRpbWVzdGFtcC1wLnRpbWVzdGFtcCksST1bLi4ucl0uc29ydCgoZSxwKT0+cC50aW1lc3RhbXAtZS50aW1lc3RhbXApLG09RChuLmZpbHRlcihlPT5lLnR5cGU9PT0iQ29udHJpYnV0aW9uIikucmVkdWNlKChlLHApPT5lK01hdGguYWJzKHAuYW1vdW50KSwwKSksZj1EKG4uZmlsdGVyKGU9PmUudHlwZT09PSJEaXN0cmlidXRpb24iKS5yZWR1Y2UoKGUscCk9PmUrTWF0aC5hYnMocC5hbW91bnQpLDApKTtsZXQgUj0wLGI9bnVsbDtpZihJLmxlbmd0aD4wKXtjb25zdCBlPUlbMF07Uj1lLmFtb3VudCxiPWUuZGF0ZTtjb25zdCBwPWUudGltZXN0YW1wO2Zvcihjb25zdCBOIG9mIG4pTi50aW1lc3RhbXA+cCYmKE4udHlwZT09PSJDb250cmlidXRpb24iP1IrPU1hdGguYWJzKE4uYW1vdW50KTpOLnR5cGU9PT0iRGlzdHJpYnV0aW9uIiYmKFItPU1hdGguYWJzKE4uYW1vdW50KSkpfWxldCB1PWE7Zm9yKGNvbnN0IGUgb2YgbillLnR5cGU9PT0iQWRqdXN0bWVudCI/dS09ZS5hbW91bnQ6ZS5hZmZlY3RzQ29tbWl0bWVudCYmKGUudHlwZT09PSJDb250cmlidXRpb24iP3UtPU1hdGguYWJzKGUuYW1vdW50KTplLnR5cGU9PT0iRGlzdHJpYnV0aW9uIiYmKHUrPU1hdGguYWJzKGUuYW1vdW50KSkpO3U9TWF0aC5tYXgoMCx1KTtjb25zdCBvPW4uZmluZChlPT5lLnR5cGU9PT0iQ29udHJpYnV0aW9uIiksbD1vP25ldyBEYXRlKG8udGltZXN0YW1wKS5nZXRGdWxsWWVhcigpOm51bGwsYz1EKGYrUi1tKSx5PW4uZmlsdGVyKGU9PmUudHlwZSE9PSJBZGp1c3RtZW50IikubWFwKGU9Pih7ZGF0ZTplLmRhdGUsYW1vdW50OmUudHlwZT09PSJDb250cmlidXRpb24iPy1NYXRoLmFicyhlLmFtb3VudCk6TWF0aC5hYnMoZS5hbW91bnQpfSkpO0kubGVuZ3RoPjAmJnkucHVzaCh7ZGF0ZTpJWzBdLmRhdGUsYW1vdW50OlJ9KSx5LnNvcnQoKGUscCk9Pk0oZS5kYXRlKS5nZXRUaW1lKCktTShwLmRhdGUpLmdldFRpbWUoKSk7Y29uc3QgWT1DKHkpLHY9RSh5KSxGPW0+MD9mL206bnVsbCxQPW0+MD9SL206bnVsbCxPPW0+MD8oZitSKS9tOm51bGw7cmV0dXJue2NhbGxlZENhcGl0YWw6bSxkaXN0cmlidXRpb25zOmYsbmF2OlIsbmF2RGF0ZTpiLGlycjpZLG1vaWM6dixkcGk6RixydnBpOlAsdHZwaTpPLG91dHN0YW5kaW5nQ29tbWl0bWVudDp1LHZpbnRhZ2VZZWFyOmwsY29tbWl0bWVudDphLHRvdGFsQ29udHJpYnV0aW9uczptLHRvdGFsRGlzdHJpYnV0aW9uczpmLGludmVzdG1lbnRSZXR1cm46Yyx2aW50YWdlOmx9fXNlbGYub25tZXNzYWdlPXQ9Pntjb25zdHt0eXBlOnMsZnVuZHM6YSxjdXRvZmZEYXRlOmkscmVxdWVzdElkOnJ9PXQuZGF0YTtpZihzPT09ImNhbGN1bGF0ZU1ldHJpY3MiKXtjb25zdCBuPWk/bmV3IERhdGUoaSsiVDAwOjAwOjAwIik6dm9pZCAwLG09e3R5cGU6Im1ldHJpY3NSZXN1bHQiLHJlc3VsdHM6YS5tYXAoZj0+KHtmdW5kSWQ6Zi5pZCxtZXRyaWNzOlMoZixuKX0pKSxyZXF1ZXN0SWQ6cn07c2VsZi5wb3N0TWVzc2FnZShtKX19LHNlbGYucG9zdE1lc3NhZ2Uoe3R5cGU6InJlYWR5In0pfSkoKTsK",ss=e=>Uint8Array.from(atob(e),t=>t.charCodeAt(0)),Fn=typeof self<"u"&&self.Blob&&new Blob([ss(Kn)],{type:"text/javascript;charset=utf-8"});function as(e){let t;try{if(t=Fn&&(self.URL||self.webkitURL).createObjectURL(Fn),!t)throw"";const n=new Worker(t,{name:e?.name});return n.addEventListener("error",()=>{(self.URL||self.webkitURL).revokeObjectURL(t)}),n}catch{return new Worker("data:text/javascript;base64,"+Kn,{name:e?.name})}finally{t&&(self.URL||self.webkitURL).revokeObjectURL(t)}}let ge=null,Nt=0;const fe=new Map;let Oe=null;const Xn=E.WORKER_CALCULATION_TIMEOUT*2;function rs(){const e=Date.now();for(const[t,n]of fe)e-n.createdAt>Xn&&(clearTimeout(n.timeoutId),n.reject(new Error("Request expired during cleanup")),fe.delete(t))}function Jn(){return typeof Worker<"u"}function is(){return new Promise((e,t)=>{if(!Jn()){t(new Error("Web Workers not supported"));return}if(ge){e();return}try{ge=new as;let n=!1,o=null;const s=()=>{n||(n=!0,o&&(clearTimeout(o),o=null),e())},a=r=>{n||(n=!0,o&&(clearTimeout(o),o=null),t(r))};ge.onmessage=r=>{const i=r.data;if(i.type==="ready"){Oe||(Oe=setInterval(rs,Xn)),s();return}if(i.type==="metricsResult"){const c=fe.get(i.requestId);c&&(clearTimeout(c.timeoutId),Array.isArray(i.results)?c.resolve(i.results):c.reject(new Error("Invalid worker response: results is not an array")),fe.delete(i.requestId))}},ge.onerror=r=>{console.error("Metrics worker error:",r),a(new Error("Worker initialization failed"));for(const[i,c]of fe)clearTimeout(c.timeoutId),c.reject(new Error("Worker error")),fe.delete(i)},o=setTimeout(()=>{a(new Error("Worker initialization timeout"))},E.WORKER_INIT_TIMEOUT)}catch(n){t(n)}})}function cs(e,t){return new Promise((n,o)=>{if(!ge){o(new Error("Worker not initialized"));return}const s=Date.now()*1e3+ ++Nt%1e3;Nt>1e6&&(Nt=0);const a=setTimeout(()=>{const i=fe.get(s);i&&(i.reject(new Error("Worker request timeout")),fe.delete(s))},E.WORKER_CALCULATION_TIMEOUT);fe.set(s,{resolve:n,reject:o,timeoutId:a,createdAt:Date.now()});const r={type:"calculateMetrics",funds:e,cutoffDate:t?.toISOString().split("T")[0],requestId:s};ge.postMessage(r)})}function ls(){if(ge){ge.terminate(),ge=null;for(const e of fe.values())clearTimeout(e.timeoutId);fe.clear(),Oe&&(clearInterval(Oe),Oe=null)}}function us(){return ge!==null}function A(e){if(typeof e!="string")return"";const t=document.createElement("div");return t.textContent=e,t.innerHTML}function pe(e){if(e==null)return"";let t=String(e);if(t.length===0)return"";const n=t.charAt(0);if(["=","+","@","	","\r"].includes(n))t="'"+t;else if(n==="-"){const o=Number(t);(isNaN(o)||!isFinite(o))&&(t="'"+t)}return t.includes(",")||t.includes('"')||t.includes(`
`)||t.includes("'")?'"'+t.replace(/"/g,'""')+'"':t}function W(e){return typeof e!="string"?"":e.replace(/&/g,"&amp;").replace(/"/g,"&quot;").replace(/'/g,"&#39;").replace(/</g,"&lt;").replace(/>/g,"&gt;")}function je(e){return e==null||!isFinite(e)?"N/A":e.toFixed(2)+"x"}function qe(e){return e==null||!isFinite(e)?"N/A":(e*100).toFixed(2)+"%"}function Qn(e,t){if(!t)return"";const o=h.fundNameData.get(e)?.tags||[];return o.length===0?"":`<div class="table-tags">${o.map(s=>`<span class="table-tag">${A(s)}</span>`).join("")}</div>`}function qt(e){return e.investmentReturn??e.distributions+e.nav-e.calledCapital}function eo(e){if(!e.groupId)return"";const t=h.getGroupByIdSync(e.groupId);return t?t.name:""}function it(e){const t=eo(e);return t?`${t} (${e.accountNumber})`:e.accountNumber}function ds(e){const t=eo(e);return t?`<div>${A(t)}</div><div style="font-size: 0.85em; color: var(--color-text-light);">${A(e.accountNumber)}</div>`:A(e.accountNumber)}function to(e,t,n){if(t.length===0)return e;const o=new Set(["vintage","commitment","totalContributions","totalDistributions","nav","investmentReturn","moic","irr","outstandingCommitment"]),s=t.some(({column:l})=>o.has(l)),a=new Map,r=l=>{if(l.id!=null){let d=a.get(l.id);return d||(d=kt(l,n),a.set(l.id,d)),d}return kt(l,n)},i=t.some(({column:l})=>l==="accountNumber"),c=new Map;if(i)for(const l of e)l.id!=null&&c.set(l.id,it(l));const u=l=>l.id!=null?c.get(l.id)??it(l):it(l);return[...e].sort((l,d)=>{for(const{column:m,direction:g}of t){const y=g==="asc"?1:-1;let f=0;const p=s?r(l):void 0,v=s?r(d):void 0;switch(m){case"fundName":f=l.fundName.localeCompare(d.fundName);break;case"accountNumber":f=u(l).localeCompare(u(d));break;case"vintage":f=(p.vintageYear??1/0)-(v.vintageYear??1/0);break;case"commitment":f=(p.commitment||0)-(v.commitment||0);break;case"totalContributions":f=(p.calledCapital||0)-(v.calledCapital||0);break;case"totalDistributions":f=(p.distributions||0)-(v.distributions||0);break;case"nav":f=(p.nav||0)-(v.nav||0);break;case"investmentReturn":f=(p.investmentReturn||0)-(v.investmentReturn||0);break;case"moic":f=(p.moic||0)-(v.moic||0);break;case"irr":f=(p.irr||0)-(v.irr||0);break;case"outstandingCommitment":f=(p.outstandingCommitment||0)-(v.outstandingCommitment||0);break;default:f=0}if(f!==0)return f*y}return 0})}function ms(e,t,n=!1){const o=e.metrics,s=Qn(e.fundName,n),a=qt(o);return`
    <td>
      <div>${A(e.fundName)}</div>
      ${s}
    </td>
    <td title="${A(it(e))}">${ds(e)}</td>
    <td class="center">${o.vintageYear||"N/A"}</td>
    <td class="number">${k(o.commitment||0)}</td>
    <td class="number">${k(o.calledCapital)}</td>
    <td class="number">${k(o.distributions)}</td>
    <td class="number">${k(o.nav)}</td>
    <td class="number ${a>=0?"positive":"negative"}">${k(a)}</td>
    <td class="number">${je(o.moic)}</td>
    <td class="number ${o.irr!==null&&o.irr>=0?"positive":"negative"}">${qe(o.irr)}</td>
    <td class="number">${k(o.outstandingCommitment)}</td>
    <td class="center">
      <button class="btn-icon table-action-btn" data-action="menu" data-fund-id="${W(String(e.id))}" title="Actions" aria-label="Actions for ${A(e.fundName)}">⚙</button>
    </td>
  `}function no(e,t){const n={commitment:0,calledCapital:0,distributions:0,nav:0,investmentReturn:0,outstandingCommitment:0,aggregateFlows:[]};e.forEach(c=>{const u=c.metrics;n.commitment+=u.commitment||0,n.calledCapital+=u.calledCapital,n.distributions+=u.distributions,n.nav+=u.nav,n.investmentReturn+=u.investmentReturn??u.distributions+u.nav-u.calledCapital,n.outstandingCommitment+=u.outstandingCommitment;const l=os(c,t);n.aggregateFlows.push(...l)});const o=Zn(n.aggregateFlows),s=zn(n.aggregateFlows),a=n.calledCapital>0?n.distributions/n.calledCapital:null,r=n.calledCapital>0?n.nav/n.calledCapital:null,i=n.calledCapital>0?(n.distributions+n.nav)/n.calledCapital:null;return{commitment:n.commitment,calledCapital:n.calledCapital,distributions:n.distributions,nav:n.nav,investmentReturn:n.investmentReturn,outstandingCommitment:n.outstandingCommitment,aggregateIRR:o,aggregateMOIC:s,aggregateDPI:a,aggregateRVPI:r,aggregateTVPI:i}}function Ft(e){return`
    <td><strong>Total</strong></td>
    <td></td>
    <td></td>
    <td class="number"><strong>${k(e.commitment)}</strong></td>
    <td class="number"><strong>${k(e.calledCapital)}</strong></td>
    <td class="number"><strong>${k(e.distributions)}</strong></td>
    <td class="number"><strong>${k(e.nav)}</strong></td>
    <td class="number ${e.investmentReturn>=0?"positive":"negative"}"><strong>${k(e.investmentReturn)}</strong></td>
    <td class="number"><strong>${je(e.aggregateMOIC)}</strong></td>
    <td class="number ${e.aggregateIRR!==null&&e.aggregateIRR>=0?"positive":"negative"}"><strong>${qe(e.aggregateIRR)}</strong></td>
    <td class="number"><strong>${k(e.outstandingCommitment)}</strong></td>
    <td></td>
  `}function fs(e,t){const n=no(e,t),o=new Set(e.map(a=>a.fundName)),s={investmentCount:document.getElementById("summaryInvestmentCount"),fundCount:document.getElementById("summaryFundCount"),commitment:document.getElementById("summaryCommitment"),nav:document.getElementById("summaryNav"),irr:document.getElementById("summaryIRR"),moic:document.getElementById("summaryMOIC"),dpi:document.getElementById("summaryDPI"),rvpi:document.getElementById("summaryRVPI"),tvpi:document.getElementById("summaryTVPI")};s.investmentCount&&(s.investmentCount.textContent=e.length.toString()),s.fundCount&&(s.fundCount.textContent=o.size.toString()),s.commitment&&(s.commitment.textContent=k(n.commitment)),s.nav&&(s.nav.textContent=k(n.nav)),s.irr&&(s.irr.textContent=qe(n.aggregateIRR)),s.moic&&(s.moic.textContent=je(n.aggregateMOIC)),s.dpi&&(s.dpi.textContent=n.aggregateDPI!==null?n.aggregateDPI.toFixed(2)+"x":"N/A"),s.rvpi&&(s.rvpi.textContent=n.aggregateRVPI!==null?n.aggregateRVPI.toFixed(2)+"x":"N/A"),s.tvpi&&(s.tvpi.textContent=n.aggregateTVPI!==null?n.aggregateTVPI.toFixed(2)+"x":"N/A")}function ps(e){const t=document.querySelectorAll("#fundsTable th"),n=new Map;e.forEach(({column:o,direction:s},a)=>{n.set(o,{direction:s,priority:a+1})}),t.forEach(o=>{o.classList.remove("sorted-asc","sorted-desc"),o.removeAttribute("data-sort-priority");const s=o.getAttribute("data-sort");if(s){const a=n.get(s);a&&(o.classList.add(a.direction==="asc"?"sorted-asc":"sorted-desc"),e.length>1&&o.setAttribute("data-sort-priority",a.priority.toString()))}})}function oo(e,t,n=[]){const o=new Map;for(const r of e){const i=o.get(r.fundName)||[];i.push(r),o.set(r.fundName,i)}const s=[],a=t?t.toISOString().split("T")[0]??"":"";for(const[r,i]of o){const c=i.map(y=>y.id).filter(y=>y!=null),u=h.getConsolidatedMetricsFromCache(r,a,c);let l;if(u)l=u;else{const y=[];let f=0,p=0,v=null;for(const b of i){for(const w of b.cashFlows)y.push(w);f+=b.commitment,p+=b.metrics.nav,b.metrics.navDate&&(!v||b.metrics.navDate>v)&&(v=b.metrics.navDate)}const N=[{date:v??new Date().toISOString().split("T")[0]??"",amount:p}],D={accountNumber:`${i.length} investor${i.length!==1?"s":""}`,commitment:f,cashFlows:y,monthlyNav:N,timestamp:new Date().toISOString()};l=ce(D,t),h.setConsolidatedMetricsCache(r,a,c,l)}const d=i[0],m=i.reduce((y,f)=>y+f.commitment,0),g={fundName:r,accountNumber:`${i.length} investor${i.length!==1?"s":""}`,commitment:m,cashFlows:[],monthlyNav:[],groupId:null,timestamp:new Date().toISOString(),id:d?.id,investorCount:i.length,consolidatedMetrics:l};s.push(g)}return n.length>0?s.sort((r,i)=>{for(const{column:c,direction:u}of n){const l=u==="asc"?1:-1;let d=0;const m=r.consolidatedMetrics,g=i.consolidatedMetrics;switch(c){case"fundName":d=r.fundName.localeCompare(i.fundName);break;case"accountNumber":d=r.investorCount-i.investorCount;break;case"vintage":d=(m.vintageYear??1/0)-(g.vintageYear??1/0);break;case"commitment":d=(m.commitment||0)-(g.commitment||0);break;case"totalContributions":d=m.calledCapital-g.calledCapital;break;case"totalDistributions":d=m.distributions-g.distributions;break;case"nav":d=m.nav-g.nav;break;case"investmentReturn":d=(m.investmentReturn||0)-(g.investmentReturn||0);break;case"moic":d=(m.moic||0)-(g.moic||0);break;case"irr":d=(m.irr||0)-(g.irr||0);break;case"outstandingCommitment":d=m.outstandingCommitment-g.outstandingCommitment;break;default:d=0}if(d!==0)return d*l}return 0}):s.sort((r,i)=>r.fundName.localeCompare(i.fundName)),s}function gs(e,t,n=!1){const o=e.consolidatedMetrics,s=Qn(e.fundName,n),a=qt(o);return`
    <td>
      <div>${A(e.fundName)}</div>
      ${s}
    </td>
    <td class="center"><span class="investor-count" aria-label="${e.investorCount} investor${e.investorCount!==1?"s":""}">${e.investorCount} investor${e.investorCount!==1?"s":""}</span></td>
    <td class="center">${o.vintageYear||"N/A"}</td>
    <td class="number">${k(o.commitment||0)}</td>
    <td class="number">${k(o.calledCapital)}</td>
    <td class="number">${k(o.distributions)}</td>
    <td class="number">${k(o.nav)}</td>
    <td class="number ${a>=0?"positive":"negative"}">${k(a)}</td>
    <td class="number">${je(o.moic)}</td>
    <td class="number ${o.irr!==null&&o.irr>=0?"positive":"negative"}">${qe(o.irr)}</td>
    <td class="number">${k(o.outstandingCommitment)}</td>
    <td class="center">
      <button class="btn-icon table-action-btn" data-action="edit-fund" data-fund-name="${W(e.fundName)}" title="Edit Fund Name" aria-label="Edit ${A(e.fundName)}">⚙</button>
    </td>
  `}function hs(e,t,n=new Set){const o=new Map;for(const l of e){const d=l.groupId??null,m=o.get(d)||[];m.push(l),o.set(d,m)}const s=new Set;for(const l of o.keys())if(l!==null){s.add(l);const d=h.getAncestorIds(l);for(const m of d)s.add(m)}function a(l){let d=[];if(l===null)d=o.get(null)||[];else{const b=h.getDescendantIds(l);for(const w of b){const C=o.get(w);C&&d.push(...C)}}if(d.length===0)return{metrics:{vintageYear:null,commitment:0,calledCapital:0,distributions:0,nav:0,navDate:null,outstandingCommitment:0,investmentReturn:0,irr:null,moic:null,dpi:null,rvpi:null,tvpi:null},fundCount:0,investorCount:0,allFunds:[]};const m=[];let g=0,y=0,f=null;const p=new Set;for(const b of d){for(const w of b.cashFlows)m.push(w);g+=b.commitment,y+=b.metrics.nav,p.add(b.fundName),b.metrics.navDate&&(!f||b.metrics.navDate>f)&&(f=b.metrics.navDate)}const F=[{date:f??new Date().toISOString().split("T")[0]??"",amount:y}],N={commitment:g,cashFlows:m,monthlyNav:F,timestamp:new Date().toISOString()};return{metrics:ce(N,t),fundCount:p.size,investorCount:d.length,allFunds:d}}function r(l,d){const m=l!==null?h.getGroupByIdSync(l)??null:null,g=m?.name??"No Group";if(l!==null&&!s.has(l))return null;const{metrics:y,fundCount:f,investorCount:p}=a(l),v=[];if(l!==null){const N=h.getDirectChildIds(l);for(const D of N){const b=r(D,d+1);b&&v.push(b)}v.sort((D,b)=>D.groupName.localeCompare(b.groupName))}const F=l===null||n.has(l)||n.has(String(l));return{groupId:l,groupName:g,group:m,fundCount:f,investorCount:p,metrics:y,children:v,depth:d,isExpanded:F}}const i=[],c=h.getGroups().filter(l=>l.parentGroupId===null);for(const l of c){const d=r(l.id,0);d&&i.push(d)}i.sort((l,d)=>l.groupName.localeCompare(d.groupName));const u=o.get(null);if(u&&u.length>0){const l=r(null,0);l&&i.push(l)}return i}function ys(e){const t=[];function n(o){for(const s of o)t.push(s),s.isExpanded&&s.children.length>0&&n(s.children)}return n(e),t}function vs(e,t){const n=e.metrics,o=qt(n),s=e.children.length>0,a=s?e.isExpanded?"&#9660;":"&#9654;":'<span style="display:inline-block;width:12px;"></span>',r=e.depth*20,i=e.group?.type?` <span class="group-type-badge">${A(e.group.type)}</span>`:"",c=e.isExpanded?`Collapse ${e.groupName}`:`Expand ${e.groupName}`;return`
    <td style="--group-indent: ${r+8}px">
      <div class="group-name-cell">
        ${s?`<button class="btn-expand" data-group-id="${e.groupId}" title="${e.isExpanded?"Collapse":"Expand"}" aria-label="${W(c)}" aria-expanded="${e.isExpanded}">${a}</button>`:`<span class="expand-placeholder">${a}</span>`}
        <span class="group-name">${A(e.groupName)}</span>${i}
      </div>
    </td>
    <td class="center"><span class="investor-count" aria-label="${e.fundCount} fund${e.fundCount!==1?"s":""}, ${e.investorCount} position${e.investorCount!==1?"s":""}">${e.fundCount} fund${e.fundCount!==1?"s":""}, ${e.investorCount} position${e.investorCount!==1?"s":""}</span></td>
    <td class="center">${n.vintageYear||"N/A"}</td>
    <td class="number">${k(n.commitment||0)}</td>
    <td class="number">${k(n.calledCapital)}</td>
    <td class="number">${k(n.distributions)}</td>
    <td class="number">${k(n.nav)}</td>
    <td class="number ${o>=0?"positive":"negative"}">${k(o)}</td>
    <td class="number">${je(n.moic)}</td>
    <td class="number ${n.irr!==null&&n.irr>=0?"positive":"negative"}">${qe(n.irr)}</td>
    <td class="number">${k(n.outstandingCommitment)}</td>
    <td class="center">
      ${e.groupId!==null?`<button class="btn-icon table-action-btn" data-action="edit-group" data-group-id="${e.groupId}" title="Edit Group" aria-label="Edit ${A(e.groupName)}">⚙</button>`:""}
    </td>
  `}function bs(){const e=new Date,t=e.getFullYear(),n=[new Date(t,2,31),new Date(t,5,30),new Date(t,8,30),new Date(t,11,31)];let o=new Date(t-1,11,31);for(let i=n.length-1;i>=0;i--)if(n[i]<=e){o=n[i];break}const s=o.getFullYear(),a=String(o.getMonth()+1).padStart(2,"0"),r=String(o.getDate()).padStart(2,"0");return`${s}-${a}-${r}`}function V(e){const t=document.getElementById(e);if(!t)return[];const n=t.querySelectorAll(".multi-select-option.selected");return Array.from(n).map(o=>o.dataset.value||"")}function Es(){const e=["fundFilter","accountFilter","groupFilter","vintageFilter","tagFilter"],t=["fund","account","group","vintage","tag"],n={fund:[],account:[],group:[],vintage:[],tag:[]};return e.forEach((o,s)=>{const a=document.getElementById(o);if(a){const r=a.querySelectorAll(".multi-select-option.selected");n[t[s]]=Array.from(r).map(i=>i.dataset.value||"")}}),n}function ws(){const e=Es();return e.fund.length>0||e.account.length>0||e.group.length>0||e.vintage.length>0||e.tag.length>0}function Be(e,t){const n=document.getElementById(e);if(!n)return;const o=new Set(t);n.querySelectorAll(".multi-select-option").forEach(a=>{const r=a;if(o.has(r.dataset.value||"")){a.classList.add("selected");const i=a.querySelector('input[type="checkbox"]');i&&(i.checked=!0)}else{a.classList.remove("selected");const i=a.querySelector('input[type="checkbox"]');i&&(i.checked=!1)}}),ht(e)}function Re(e){Be(e,[])}function ht(e){const t=document.getElementById(e);if(!t)return;const n=t.querySelector(".multi-select-display");if(!n)return;const o=t.dataset.placeholder||"Select...",s=V(e);if(s.length===0)n.innerHTML=`<span class="placeholder">${A(o)}</span>`;else if(s.length===1){const r=t.querySelector(`.multi-select-option[data-value="${CSS.escape(s[0]||"")}"]`)?.querySelector("label")?.textContent||s[0];n.innerHTML=A(r)}else{const a=document.createElement("span");a.className="multi-select-count",a.textContent=`${s.length} selected`,n.innerHTML="",n.appendChild(a)}}function Ge(e,t,n=[]){const o=document.getElementById(e);if(!o)return;const s=o.querySelector(".multi-select-dropdown");if(!s)return;const r=s.querySelector(".multi-select-search input")?.value||"";s.innerHTML=`
    <div class="multi-select-search">
      <input type="text" placeholder="Search..." aria-label="Search options" value="${A(r)}">
    </div>
    <div class="multi-select-options"></div>
    <div class="multi-select-no-results">No matches found</div>
  `;const i=s.querySelector(".multi-select-options"),c=document.createDocumentFragment(),u=new Set(n),l=document.createElement("div");l.className="multi-select-option multi-select-all-option",l.setAttribute("data-value","__select_all__"),l.setAttribute("role","option"),l.setAttribute("aria-selected","false"),l.innerHTML='<input type="checkbox" tabindex="-1"><label>Select All</label>',c.appendChild(l);let d=!1;for(const m of t){const g=u.has(m.value),y=document.createElement("div"),f=["multi-select-option"];m.indent!==void 0&&(m.indent===0?(f.push("group-top-level"),d&&f.push("group-separator"),d=!0):f.push("group-option","group-child")),g&&f.push("selected"),y.className=f.join(" "),y.setAttribute("data-value",m.value),y.setAttribute("role","option"),y.setAttribute("aria-selected",String(g)),m.indent!==void 0&&y.style.setProperty("--indent-level",String(m.indent));const p=document.createElement("input");p.type="checkbox",p.checked=g,p.tabIndex=-1;const v=document.createElement("label");v.textContent=m.label,y.appendChild(p),y.appendChild(v),c.appendChild(y)}i.appendChild(c),r&&Zt(o,r),ht(e)}function Zt(e,t){const n=e.querySelector(".multi-select-options"),o=e.querySelector(".multi-select-no-results");if(!n)return;const s=n.querySelectorAll(".multi-select-option"),a=t.toLowerCase().trim(),r=[],i=[];s.forEach(c=>{const u=c.querySelector("label"),l=u&&u.textContent?.toLowerCase()||"";a===""||l.includes(a)?r.push(c):i.push(c)});for(const c of r)c.classList.remove("search-hidden");for(const c of i)c.classList.add("search-hidden");o&&o.classList.toggle("visible",r.length===0&&a!=="")}function Mt(e){const t=e.querySelector(".multi-select-search input");t&&(t.value=""),Zt(e,"")}function Is(e){const t=e.querySelector(".multi-select-options");if(!t)return;const n=t.querySelectorAll(".multi-select-option:not(.search-hidden):not(.multi-select-all-option)"),s=!Array.from(n).every(a=>a.classList.contains("selected"));n.forEach(a=>{s?a.classList.add("selected"):a.classList.remove("selected");const r=a.querySelector('input[type="checkbox"]');r&&(r.checked=s),a.setAttribute("aria-selected",s.toString())}),zt(e),ht(e.id)}function zt(e){const t=e.querySelector(".multi-select-all-option");if(!t)return;const n=e.querySelector(".multi-select-options");if(!n)return;const o=n.querySelectorAll(".multi-select-option:not(.search-hidden):not(.multi-select-all-option)");if(o.length===0){t.classList.remove("selected");const r=t.querySelector('input[type="checkbox"]');r&&(r.checked=!1);return}const s=Array.from(o).every(r=>r.classList.contains("selected"));s?t.classList.add("selected"):t.classList.remove("selected");const a=t.querySelector('input[type="checkbox"]');a&&(a.checked=s)}let ot=null,Tn=-1;function yt(e,t){return ot&&Tn===h.dataVersion||(Tn=h.dataVersion,ot=so(e,null)),ot}function so(e,t){return e.filter(n=>n.parentGroupId===t).sort((n,o)=>n.name.localeCompare(o.name)).map(n=>({...n,children:so(e,n.id)}))}const Ss=[{id:"fundFilter",isMultiSelect:!0,apply:(e,t)=>t.length===0||t.includes(e.fundName)},{id:"accountFilter",isMultiSelect:!0,apply:(e,t)=>t.length===0||t.includes(e.accountNumber)},{id:"vintageFilter",isMultiSelect:!0,apply:(e,t)=>{if(t.length===0)return!0;const n=At(e);return n!==null&&t.includes(n.toString())}}];function ao(){return{fundFilter:V("fundFilter"),accountFilter:V("accountFilter"),groupFilter:V("groupFilter"),tagFilter:V("tagFilter"),vintageFilter:V("vintageFilter")}}function vt(e){const t=ao(),n=t.groupFilter||[];let o=null;if(n.length>0){o=new Set;for(const r of n){const i=parseInt(r,10),c=h.getDescendantIds(i);for(const u of c)o.add(u)}}const s=t.tagFilter||[],a=s.length>0?new Set(s):null;return e.filter(r=>{for(const i of Ss){const c=t[i.id]||[];if(!i.apply(r,c))return!1}return!(o!==null&&(!r.groupId||!o.has(r.groupId))||a!==null&&!(h.fundNameData.get(r.fundName)?.tags||[]).some(l=>a.has(l)))})}function Lt(){Re("fundFilter"),Re("accountFilter"),Re("groupFilter"),Re("tagFilter"),Re("vintageFilter");const e=document.getElementById("cutoffDate");e&&(e.value=bs())}function Cs(){const e=document.getElementById("activeFiltersIndicator");if(!e)return;const t=[V("fundFilter"),V("accountFilter"),V("groupFilter"),V("tagFilter"),V("vintageFilter")].filter(n=>n.length>0).length;t>0?(e.innerHTML=`${t} filter${t>1?"s":""} active <button class="clear-filters" title="Clear all filters" aria-label="Clear all filters">&times;</button>`,e.classList.add("show")):(e.innerHTML="",e.classList.remove("show"))}function Ns(e,t,n){const o=e.querySelector(".multi-select-options");if(!o)return;const s=(r,i)=>{const c=o.querySelector(`[data-value="${CSS.escape(String(r))}"]`);if(c){i?c.classList.add("selected"):c.classList.remove("selected");const u=c.querySelector('input[type="checkbox"]');u&&(u.checked=i),c.setAttribute("aria-selected",i.toString())}},a=r=>{const i=o.querySelector(`[data-value="${CSS.escape(String(r))}"]`);return i?i.classList.contains("selected"):!1};if(n){h.getDescendantIds(t).forEach(c=>{c!==t&&s(c,!0)});let i=t;for(;i!=null;){const c=h.getGroupByIdSync(i);if(!c||c.parentGroupId==null)break;const u=c.parentGroupId;if(h.getDirectChildIds(u).every(m=>a(m)))s(u,!0),i=u;else break}}else{h.getDescendantIds(t).forEach(c=>{c!==t&&s(c,!1)});const i=h.getGroupByIdSync(t);if(i&&i.parentGroupId!=null){let c=i.parentGroupId;for(;c!=null;){s(c,!1);const u=h.getGroupByIdSync(c);c=u?u.parentGroupId:null}}}}function Fs(e,t,n){const o=e.querySelector(".multi-select-options");if(!o)return;const s=new Set;for(const a of t)h.getDescendantIds(a).forEach(i=>s.add(i));s.forEach(a=>{const r=o.querySelector(`[data-value="${CSS.escape(String(a))}"]`);if(r){r.classList.add("selected");const i=r.querySelector('input[type="checkbox"]');i&&(i.checked=n),r.setAttribute("aria-selected",n.toString())}})}function Ts(e){const t=V("groupFilter"),n=V("fundFilter"),o=V("accountFilter"),s=V("vintageFilter"),a=V("tagFilter");let r=null;if(t.length>0){r=new Set;for(const B of t){const $=parseInt(B,10),_=h.getDescendantIds($);for(const oe of _)r.add(oe)}}const i=n.length>0?new Set(n):null,c=o.length>0?new Set(o):null,u=s.length>0?new Set(s):null,l=(B,$)=>$?B.filter(_=>_.groupId!=null&&$.has(_.groupId)):B,d=(B,$)=>$?B.filter(_=>{const oe=At(_);return oe!==null&&$.has(oe.toString())}):B,m=(B,$)=>$?B.filter(_=>$.has(_.fundName)):B,g=(B,$)=>$?B.filter(_=>$.has(_.accountNumber)):B,y=l(e,r);let f=y;f=g(f,c),f=d(f,u);const p=new Set(f.map(B=>B.fundName)),F=[...p].sort().map(B=>({value:B,label:B})),N=n.filter(B=>p.has(B));Ge("fundFilter",F,N);let D=y;D=m(D,i),D=d(D,u);const b=new Set(D.map(B=>B.accountNumber)),C=[...b].sort().map(B=>({value:B,label:B})),L=o.filter(B=>b.has(B));Ge("accountFilter",C,L);const x=h.getGroups(),R=[];if(x.length>0){const B=yt(x),$=(_,oe,ue=null)=>{const Ie=[];return _.forEach(de=>{(ue===null||ue.has(de.id))&&Ie.push({value:de.id.toString(),label:de.name,indent:oe}),de.children&&de.children.length>0&&Ie.push(...$(de.children,oe+1,ue))}),Ie};if(n.length>0||o.length>0||s.length>0){let _=e;_=m(_,i),_=g(_,c),_=d(_,u);const oe=new Set;_.forEach(ue=>{ue.groupId!=null&&h.getAncestorIds(ue.groupId).forEach(de=>oe.add(de))}),R.push(...$(B,0,oe))}else R.push(...$(B,0))}const J=new Set(R.map(B=>B.value)),Q=t.filter(B=>J.has(B));Ge("groupFilter",R,Q);let ve=y;ve=m(ve,i),ve=g(ve,c);const Le=new Set;ve.forEach(B=>{const $=At(B);$!==null&&Le.add($)});const Xe=Array.from(Le).sort((B,$)=>$-B).map(B=>({value:B.toString(),label:B.toString()})),Je=s.filter(B=>Le.has(parseInt(B,10)));Ge("vintageFilter",Xe,Je);const we=new Set;h.fundNameData.forEach(B=>{B.tags&&B.tags.forEach($=>we.add($))});const Qe=Array.from(we).sort((B,$)=>B.localeCompare($)).map(B=>({value:B,label:B})),et=a.filter(B=>we.has(B));Ge("tagFilter",Qe,et)}let $e=null,_e=null;const Rt=new WeakMap,Ds=['button:not([disabled]):not([tabindex="-1"])','input:not([disabled]):not([type="hidden"]):not([tabindex="-1"])','select:not([disabled]):not([tabindex="-1"])','textarea:not([disabled]):not([tabindex="-1"])','a[href]:not([tabindex="-1"])','[tabindex]:not([tabindex="-1"]):not([disabled])'].join(", ");function ro(e,t=!1){if(t){const o=Rt.get(e);if(o)return o}const n=Array.from(e.querySelectorAll(Ds)).filter(o=>o.offsetParent!==null);return Rt.set(e,n),n}function io(e){Rt.delete(e)}function co(e){Kt(),io(e),_e=t=>{if(t.key!=="Tab")return;const n=ro(e),o=n[0],s=n[n.length-1];!o||!s||(t.shiftKey?document.activeElement===o&&(t.preventDefault(),s.focus()):document.activeElement===s&&(t.preventDefault(),o.focus()))},document.addEventListener("keydown",_e)}function Kt(){_e&&(document.removeEventListener("keydown",_e),_e=null)}function S(e,t="success"){let n=document.getElementById("toastContainer");n||(n=document.createElement("div"),n.id="toastContainer",n.className="toast-container",n.setAttribute("aria-live","polite"),document.body.appendChild(n));const o=document.createElement("div");o.className=`status-message ${t}`,o.setAttribute("role",t==="error"?"alert":"status");const s=document.createElement("button");s.className="close-status",s.innerHTML="&times;",s.setAttribute("aria-label","Dismiss message");const a=document.createElement("span");a.textContent=e,o.appendChild(a),o.appendChild(s),n.appendChild(o);let r=!1;const i=()=>{r||(r=!0,s.removeEventListener("click",i),o.remove())};s.addEventListener("click",i);const c=t==="success"?E.TOAST_SUCCESS_DURATION:E.TOAST_ERROR_DURATION;setTimeout(()=>{!r&&o.parentNode&&i()},c)}function K(e="Loading..."){const t=document.getElementById("loadingOverlay"),n=document.getElementById("loadingText");n&&(n.textContent=e),t&&t.classList.add("show")}function j(){const e=document.getElementById("loadingOverlay");e&&e.classList.remove("show")}function Ee(e,t={}){return new Promise(n=>{const o=document.getElementById("confirmModal"),s=document.getElementById("confirmModalTitle"),a=document.getElementById("confirmModalMessage"),r=document.getElementById("confirmModalConfirmBtn"),i=document.getElementById("confirmModalCancelBtn"),c=document.getElementById("closeConfirmModalBtn");if(!o||!s||!a||!r||!i){n(!1);return}const u=document.activeElement;s.textContent=t.title||"Confirm",a.textContent=e,r.textContent=t.confirmText||"Confirm",i.textContent=t.cancelText||"Cancel",o.classList.add("show"),co(o),requestAnimationFrame(()=>i.focus());const l=()=>{m(),n(!0)},d=()=>{m(),n(!1)},m=()=>{o.classList.remove("show"),Kt(),r.removeEventListener("click",l),i.removeEventListener("click",d),c&&c.removeEventListener("click",d),u&&u.focus&&u.focus()};r.addEventListener("click",l),i.addEventListener("click",d),c&&c.addEventListener("click",d)})}function ct(e,t){const n=document.getElementById(e);if(!n)return;const o=n.closest(".form-group");if(o&&(o.classList.add("has-error"),t)){let s=o.querySelector(".error-message");s||(s=document.createElement("span"),s.className="error-message",o.appendChild(s)),s.textContent=t}}function Gt(e){const t=document.getElementById(e);if(!t)return;const n=t.closest(".form-group");if(!n)return;n.classList.remove("has-error");const o=n.querySelector(".error-message");o&&(o.textContent="")}function lo(e){const t=document.getElementById(e);t&&t.querySelectorAll(".form-group.has-error").forEach(n=>{n.classList.remove("has-error");const o=n.querySelector(".error-message");o&&(o.textContent="")})}function ne(e){const t=document.getElementById(e);t&&($e=document.activeElement,t.classList.add("show"),co(t),requestAnimationFrame(()=>{const o=ro(t)[0];o&&o.focus()}))}function O(e){const t=document.getElementById(e);t&&(t.classList.remove("show"),Kt(),io(t),$e&&$e.focus&&($e.focus(),$e=null))}const Bs=Object.freeze(Object.defineProperty({__proto__:null,clearFieldError:Gt,clearFormErrors:lo,closeModal:O,hideLoading:j,openModal:ne,setFieldError:ct,showConfirm:Ee,showLoading:K,showStatus:S},Symbol.toStringTag,{value:"Module"}));function xs(){["fundName","accountNumber","fundGroup","commitment","newFundNameInline"].forEach(t=>{const n=document.getElementById(t);n&&(n.addEventListener("input",()=>{h.setFundModalUnsavedChanges(!0),Gt(t)}),n.addEventListener("change",()=>{h.setFundModalUnsavedChanges(!0),Gt(t)}))})}async function As(){h.fundModalHasUnsavedChanges&&!await Ee("You have unsaved changes. Discard them?",{title:"Unsaved Changes",confirmText:"Discard",cancelText:"Keep Editing"})||(h.setFundModalUnsavedChanges(!1),uo(),O("fundModal"))}let xe=null,Pe=!1,$t=0,Ae=null;function uo(){xe=null,Pe=!1,$t=0,Ae&&(clearTimeout(Ae),Ae=null)}async function mo(e,t=null){if(!e||e.trim()==="")return{groupId:null,groupName:null,isAmbiguous:!1,conflictingGroups:[]};const n=e.trim().toLowerCase(),s=(await q()).filter(i=>t&&i.id===t?!1:i.accountNumber&&i.accountNumber.trim().toLowerCase()===n);if(s.length===0)return{groupId:null,groupName:null,isAmbiguous:!1,conflictingGroups:[]};const a=new Map;s.forEach(i=>{const c=i.groupId||null;if(a.has(c))a.get(c).count++;else{const u=c?h.getGroupByIdSync(c)?.name||"Unknown Group":"No Group";a.set(c,{groupId:c,groupName:u,count:1})}});const r=Array.from(a.values());return r.length===1?{groupId:r[0].groupId,groupName:r[0].groupName,isAmbiguous:!1,conflictingGroups:[]}:{groupId:null,groupName:null,isAmbiguous:!0,conflictingGroups:r}}function Ot(e,t=[],n=""){Te();const o=document.getElementById("fundGroup")?.closest(".form-group");if(!o)return;const s=document.createElement("div");if(s.id="groupAutoFillIndicator",s.style.cssText="margin-top: 6px; font-size: 12px; display: flex; align-items: flex-start; gap: 6px;",e==="auto-filled")s.innerHTML=`
      <span style="color: var(--color-success); display: flex; align-items: center; gap: 4px;">
        <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <polyline points="20 6 9 17 4 12"></polyline>
        </svg>
        Auto-filled from existing investor data
      </span>
      <span style="color: var(--color-text-light);">(${A(n)})</span>
    `;else if(e==="ambiguous"){const a=t.map(r=>`${A(r.groupName)} (${r.count})`).join(", ");s.innerHTML=`
      <span style="color: var(--color-warning); display: flex; align-items: center; gap: 4px;">
        <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <circle cx="12" cy="12" r="10"></circle>
          <line x1="12" y1="8" x2="12" y2="12"></line>
          <line x1="12" y1="16" x2="12.01" y2="16"></line>
        </svg>
        Multiple groups found for this account
      </span>
      <span style="color: var(--color-text-light); font-size: 11px;">(${a})</span>
    `}o.appendChild(s)}function Te(){const e=document.getElementById("groupAutoFillIndicator");e&&e.remove()}async function Dn(){const e=document.getElementById("accountNumber"),t=document.getElementById("fundGroup"),n=document.getElementById("fundId");if(!e||!t)return;const o=e.value.trim(),s=n?.value?parseInt(n.value,10):null;if(Te(),xe=null,Pe=!1,!o)return;const a=++$t,r=await mo(o,s);a===$t&&(r.isAmbiguous?(Ot("ambiguous",r.conflictingGroups),Pe=!0):(r.groupId!==null||r.groupName==="No Group")&&(xe=r.groupId,Pe=!0,bt("fundGroup",r.groupId?.toString()||""),Ot("auto-filled",[],r.groupName||"No Group")))}function ks(e){Te();const t=document.getElementById("fundGroup")?.closest(".form-group");if(!t)return;const n=document.createElement("div");n.id="groupAutoFillIndicator",n.style.cssText="margin-top: 6px; font-size: 12px; display: flex; align-items: flex-start; gap: 6px;";const o=e.map(s=>`${A(s.groupName)} (${s.count})`).join(", ");n.innerHTML=`
    <span style="color: var(--color-warning); display: flex; align-items: center; gap: 4px;">
      <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
        <circle cx="12" cy="12" r="10"></circle>
        <line x1="12" y1="8" x2="12" y2="12"></line>
        <line x1="12" y1="16" x2="12.01" y2="16"></line>
      </svg>
      Multiple groups will exist for this account
    </span>
    <span style="color: var(--color-text-light); font-size: 11px;">(${o})</span>
  `,t.appendChild(n)}async function Ms(){const e=document.getElementById("fundGroup"),t=document.getElementById("accountNumber");if(!e||!t||!Pe)return;const n=t.value.trim();if(!n)return;const o=e.value?parseInt(e.value,10):null;if(o!==xe){const s=document.getElementById("fundId"),a=s?.value?parseInt(s.value,10):null,r=await mo(n,a);if(r.conflictingGroups.length>0||r.groupId!==null){const i=o?h.getGroupByIdSync(o)?.name||"Unknown Group":"No Group",c=[...r.conflictingGroups];!r.isAmbiguous&&r.groupId!==null&&c.push({groupId:r.groupId,groupName:r.groupName||"No Group",count:1}),c.some(u=>u.groupId===o)||c.push({groupId:o,groupName:i,count:0}),ks(c)}}else if(xe!==null){const s=h.getGroupByIdSync(xe)?.name||"No Group";Ot("auto-filled",[],s)}else Te()}function Ls(){const e=document.getElementById("accountNumber"),t=document.getElementById("fundGroup");e&&(e.addEventListener("input",()=>{Ae&&clearTimeout(Ae),Ae=setTimeout(Dn,300)}),e.addEventListener("blur",Dn),t&&t.addEventListener("change",Ms))}async function Ze(){const e=document.getElementById("fundName");if(!e)return;const t=await We(),n=t.map(r=>r.name).sort();h.setFundNames(new Set(n));const o=new Map;t.forEach(r=>o.set(r.name,r)),h.setFundNameData(o);const s=e.value;e.innerHTML='<option value="">Select a fund</option>',n.forEach(r=>{const i=document.createElement("option");i.value=r,i.textContent=r,e.appendChild(i)});const a=document.createElement("option");a.value="__new__",a.textContent="+ Add new fund name...",e.appendChild(a),s&&n.includes(s)&&(e.value=s)}function Ne(e,t){if(document.getElementById(e+"Container")?.classList.contains("searchable-select")){Rs(e,t);return}const o=document.getElementById(e);if(!o)return;const s=h.getGroups(),a=yt(s);o.innerHTML='<option value="">No Group</option>';const r=(i,c)=>{i.forEach(u=>{if(t!==void 0&&u.id===t)return;const l=document.createElement("option");l.value=u.id.toString();const d=c>0?"–".repeat(c)+" ":"";l.textContent=d+u.name,o.appendChild(l),u.children&&u.children.length>0&&r(u.children,c+1)})};r(a,0)}function Rs(e,t){const n=document.getElementById(e+"Container"),o=document.getElementById(e),s=n?.querySelector(".searchable-select-options");if(!n||!o||!s)return;const a=h.getGroups(),r=yt(a),i=n.dataset.placeholder||"Select...";let c=`<div class="searchable-select-option" data-value="" data-indent="0">
    ${A(i)}
  </div>`;const u=(d,m)=>{d.forEach(g=>{if(t!==void 0&&g.id===t)return;const y=m>0?"–".repeat(m)+" ":"";c+=`<div class="searchable-select-option" data-value="${W(String(g.id))}" data-indent="${m}">
        ${A(y+g.name)}
      </div>`,g.children&&g.children.length>0&&u(g.children,m+1)})};u(r,0),s.innerHTML=c,o.value="";const l=n.querySelector(".searchable-select-display");l&&(l.textContent=i)}function bt(e,t){const n=document.getElementById(e+"Container"),o=document.getElementById(e);if(!n||!o)return;o.value=t;const s=n.querySelector(".searchable-select-display"),a=n.querySelectorAll(".searchable-select-option");let r=n.dataset.placeholder||"Select...";a.forEach(i=>{const c=i;c.classList.remove("selected"),c.dataset.value===t&&(c.classList.add("selected"),r=c.textContent?.trim()||r)}),s&&(s.textContent=r)}async function lt(){const e=document.getElementById("fundModalTitle"),t=document.getElementById("fundId"),n=document.getElementById("isDuplicate"),o=document.getElementById("saveFundBtn"),s=document.getElementById("duplicateMultiplierContainer");e&&(e.textContent="Add New Investment"),t&&(t.value=""),n&&(n.value=""),o&&(o.textContent="Save"),s&&s.classList.add("hidden");const a=document.getElementById("fundForm");a&&a.reset(),Te(),await Ze(),Ne("fundGroup"),h.setFundModalUnsavedChanges(!1),ne("fundModal")}async function Gs(e){const t=await ye(e);if(!t){S("Fund not found","error");return}const n=document.getElementById("fundModalTitle"),o=document.getElementById("fundId"),s=document.getElementById("isDuplicate"),a=document.getElementById("fundName"),r=document.getElementById("accountNumber"),i=document.getElementById("commitment"),c=document.getElementById("saveFundBtn"),u=document.getElementById("duplicateMultiplierContainer");n&&(n.textContent="Edit Investment"),o&&(o.value=e.toString()),s&&(s.value=""),c&&(c.textContent="Save"),u&&u.classList.add("hidden"),Te(),await Ze(),Ne("fundGroup"),a&&(a.value=t.fundName),r&&(r.value=t.accountNumber),bt("fundGroup",t.groupId?.toString()||""),i&&(i.value=Ve(t.commitment)),h.setFundModalUnsavedChanges(!1),ne("fundModal")}async function $s(e){const t=await ye(e);if(!t){S("Fund not found","error");return}const n=document.getElementById("fundModalTitle"),o=document.getElementById("fundId"),s=document.getElementById("isDuplicate"),a=document.getElementById("fundName"),r=document.getElementById("accountNumber"),i=document.getElementById("commitment"),c=document.getElementById("duplicateMultiplier"),u=document.getElementById("saveFundBtn"),l=document.getElementById("duplicateMultiplierContainer");n&&(n.textContent="Duplicate Investment"),o&&(o.value=e.toString()),s&&(s.value="true"),u&&(u.textContent="Duplicate"),l&&l.classList.remove("hidden"),c&&(c.value="1"),Te(),await Ze(),Ne("fundGroup"),a&&(a.value=t.fundName),r&&(r.value=""),bt("fundGroup",t.groupId?.toString()||""),i&&(i.value=Ve(t.commitment)),h.setFundModalUnsavedChanges(!1),ne("fundModal")}async function Os(e){const t=document.getElementById("fundId"),n=document.getElementById("isDuplicate"),o=document.getElementById("fundName"),s=document.getElementById("accountNumber"),a=document.getElementById("fundGroup"),r=document.getElementById("commitment"),i=document.getElementById("duplicateMultiplier");let c=o?.value||"";const u=(s?.value||"").replace(/\s/g,""),l=a?.value?parseInt(a.value,10):null,d=ee(r?.value||"0"),m=n?.value==="true";let g=parseFloat(i?.value||"1")||1;if(m&&(!isFinite(g)||g<=0||g>1e3)){S("Multiplier must be between 0 and 1000","error");return}if(c==="__new__"){const f=document.getElementById("newFundNameInline"),p=f?.value?.trim();if(!p){S("Please enter a fund name","error");return}if(h.fundNames.has(p)){S("A fund with this name already exists. Please select it from the dropdown.","error");return}try{const v={name:p,tags:[],investmentTermStartDate:null,investmentTermYears:null};await Se(v),h.fundNames.add(p),h.fundNameData.set(p,v),c=p,await Ze(),o&&(o.value=p);const F=document.getElementById("newFundNameContainer");F&&F.classList.add("hidden"),f&&(f.value="")}catch(v){S("Error creating fund name: "+v.message,"error");return}}lo("fundForm");let y=!1;if(c||(ct("fundName","Please select a fund name"),y=!0),u||(ct("accountNumber","Please enter an account number"),y=!0),(isNaN(d)||d<=0)&&(ct("commitment","Please enter a valid commitment amount"),y=!0),y){S("Please fix the errors above","error");return}try{if(K("Saving..."),m&&t?.value){const f=await ye(parseInt(t.value,10));if(!f){S("Original fund not found","error"),j();return}const p={fundName:c,accountNumber:u,groupId:l,commitment:d*g,cashFlows:f.cashFlows.map(v=>({...v,amount:v.amount*g})),monthlyNav:f.monthlyNav.map(v=>({...v,amount:v.amount*g})),timestamp:new Date().toISOString()};await ie(p),S("Investment duplicated successfully")}else if(t?.value){const f=await ye(parseInt(t.value,10));if(!f){S("Fund not found","error"),j();return}const p={...f,fundName:c,accountNumber:u,groupId:l,commitment:d,timestamp:new Date().toISOString()};await ie(p),S("Investment updated successfully")}else{const f={fundName:c,accountNumber:u,groupId:l,commitment:d,cashFlows:[],monthlyNav:[],timestamp:new Date().toISOString()};await ie(f),S("Investment added successfully")}if(u){const p=(await q()).filter(v=>v.accountNumber===u&&v.groupId!==l);for(const v of p)await ie({...v,groupId:l})}h.setFundModalUnsavedChanges(!1),uo(),O("fundModal"),h.clearMetricsCache(),await e()}catch(f){console.error("Error saving fund:",f),S("Error saving investment: "+f.message,"error")}finally{j()}}async function _s(e,t){const n=await ye(e);if(!n){S("Fund not found","error");return}if(await Ee(`Are you sure you want to delete "${n.fundName}" (${n.accountNumber})? This action cannot be undone.`,{title:"Delete Investment",confirmText:"Delete",cancelText:"Cancel"}))try{K("Deleting..."),await Hn(e),h.clearMetricsCache(),S("Investment deleted successfully"),await t()}catch(s){console.error("Error deleting fund:",s),S("Error deleting investment: "+s.message,"error")}finally{j()}}async function mt(e,t){const n=await ye(e);if(!n){S("Fund not found","error");return}h.setCurrentDetailsFundId(e);const o=document.getElementById("detailsModalTitle"),s=document.getElementById("detailsModalSubtitle"),a=document.querySelector("#cashFlowsTable tbody"),r=document.querySelector("#navTable tbody");o&&(o.textContent=n.fundName),s&&(s.textContent=n.accountNumber);const i=kt(n),c=(u,l)=>{const d=document.getElementById(u);d&&(d.textContent=l)};c("detailsSummaryCommitment",k(n.commitment,!0)),c("detailsSummaryContributions",k(i.calledCapital,!0)),c("detailsSummaryDistributions",k(i.distributions,!0)),c("detailsSummaryValue",k(i.nav,!0)),c("detailsSummaryReturn",k(i.investmentReturn||0,!0)),c("detailsSummaryOutstanding",k(i.outstandingCommitment,!0)),a&&(a.innerHTML="",[...n.cashFlows].sort((l,d)=>new Date(l.date+"T00:00:00").getTime()-new Date(d.date+"T00:00:00").getTime()).forEach((l,d)=>{const m=document.createElement("tr");m.innerHTML=`
        <td><input type="date" value="${l.date}" data-field="date" data-index="${d}"></td>
        <td class="number"><input type="text" value="${Ve(ee(l.amount)||0,2)}" data-field="amount" data-index="${d}"></td>
        <td class="center">
          <select data-field="type" data-index="${d}">
            <option value="Contribution" ${l.type==="Contribution"?"selected":""}>Contribution</option>
            <option value="Distribution" ${l.type==="Distribution"?"selected":""}>Distribution</option>
            <option value="Adjustment" ${l.type==="Adjustment"?"selected":""}>Adjustment</option>
          </select>
        </td>
        <td class="center">
          <input type="checkbox" ${l.affectsCommitment!==!1?"checked":""} data-field="affectsCommitment" data-index="${d}">
        </td>
        <td>
          <button class="delete-row-btn" data-action="deleteCashFlow" data-index="${d}" title="Delete">×</button>
        </td>
      `,a.appendChild(m)})),r&&(r.innerHTML="",[...n.monthlyNav].sort((l,d)=>new Date(l.date+"T00:00:00").getTime()-new Date(d.date+"T00:00:00").getTime()).forEach((l,d)=>{const m=document.createElement("tr");m.innerHTML=`
        <td><input type="date" value="${l.date}" data-field="date" data-index="${d}"></td>
        <td><input type="text" value="${Ve(ee(l.amount)||0,2)}" data-field="amount" data-index="${d}"></td>
        <td>
          <button class="delete-row-btn" data-action="deleteNav" data-index="${d}" title="Delete">×</button>
        </td>
      `,r.appendChild(m)})),h.setUnsavedChanges(!1),ne("detailsModal")}function Ps(){const e=document.querySelector("#cashFlowsTable tbody");if(!e)return;const t=e.querySelectorAll("tr").length,n=new Date().toISOString().split("T")[0],o=document.createElement("tr");o.innerHTML=`
    <td><input type="date" value="${n}" data-field="date" data-index="${t}"></td>
    <td class="number"><input type="text" value="" placeholder="0.00" data-field="amount" data-index="${t}"></td>
    <td class="center">
      <select data-field="type" data-index="${t}">
        <option value="Contribution" selected>Contribution</option>
        <option value="Distribution">Distribution</option>
        <option value="Adjustment">Adjustment</option>
      </select>
    </td>
    <td class="center">
      <input type="checkbox" checked data-field="affectsCommitment" data-index="${t}">
    </td>
    <td>
      <button class="delete-row-btn" data-action="deleteCashFlow" data-index="${t}" title="Delete">×</button>
    </td>
  `,e.appendChild(o),h.setUnsavedChanges(!0)}function Us(){const e=document.querySelector("#navTable tbody");if(!e)return;const t=e.querySelectorAll("tr").length,n=new Date().toISOString().split("T")[0],o=document.createElement("tr");o.innerHTML=`
    <td><input type="date" value="${n}" data-field="date" data-index="${t}"></td>
    <td><input type="text" value="" placeholder="0.00" data-field="amount" data-index="${t}"></td>
    <td>
      <button class="delete-row-btn" data-action="deleteNav" data-index="${t}" title="Delete">×</button>
    </td>
  `,e.appendChild(o),h.setUnsavedChanges(!0)}async function fo(){const e=h.currentDetailsFundId;if(!e)return;const t=await ye(e);if(!t)return;const n=document.querySelectorAll("#cashFlowsTable tbody tr"),o=[];n.forEach(u=>{const l=u.querySelector('input[data-field="date"]'),d=u.querySelector('input[data-field="amount"]'),m=u.querySelector('select[data-field="type"]'),g=u.querySelector('input[data-field="affectsCommitment"]'),y=l?.value||"",f=ee(d?.value||"0"),p=m?.value||"Contribution",v=g?.checked??!0;y&&!isNaN(f)&&o.push({date:y,amount:f,type:p,affectsCommitment:v})});const s=document.querySelectorAll("#navTable tbody tr"),a=[];s.forEach(u=>{const l=u.querySelector('input[data-field="date"]'),d=u.querySelector('input[data-field="amount"]'),m=l?.value||"",g=ee(d?.value||"0");m&&!isNaN(g)&&a.push({date:m,amount:g})});const r={...t,cashFlows:o,monthlyNav:a},i=ce(r),c=(u,l)=>{const d=document.getElementById(u);d&&(d.textContent=l)};c("detailsSummaryCommitment",k(t.commitment,!0)),c("detailsSummaryContributions",k(i.calledCapital,!0)),c("detailsSummaryDistributions",k(i.distributions,!0)),c("detailsSummaryValue",k(i.nav,!0)),c("detailsSummaryReturn",k(i.investmentReturn||0,!0)),c("detailsSummaryOutstanding",k(i.outstandingCommitment,!0))}async function Ys(e){const t=h.currentDetailsFundId;if(!t)return;const n=await ye(t);if(!n){S("Fund not found","error");return}try{K("Saving...");const o=document.querySelectorAll("#cashFlowsTable tbody tr"),s=[];o.forEach(c=>{const u=c.querySelector('input[data-field="date"]'),l=c.querySelector('input[data-field="amount"]'),d=c.querySelector('select[data-field="type"]'),m=c.querySelector('input[data-field="affectsCommitment"]'),g=u?.value||"",y=ee(l?.value||"0"),f=d?.value||"Contribution",p=m?.checked??!0;g&&!isNaN(y)&&s.push({date:g,amount:y,type:f,affectsCommitment:p})});const a=document.querySelectorAll("#navTable tbody tr"),r=[];a.forEach(c=>{const u=c.querySelector('input[data-field="date"]'),l=c.querySelector('input[data-field="amount"]'),d=u?.value||"",m=ee(l?.value||"0");d&&!isNaN(m)&&r.push({date:d,amount:m})});const i={...n,cashFlows:s,monthlyNav:r,timestamp:new Date().toISOString()};await ie(i),h.clearMetricsCache(),h.setUnsavedChanges(!1),S("Changes saved successfully"),O("detailsModal"),await e()}catch(o){console.error("Error saving details:",o),S("Error saving changes: "+o.message,"error")}finally{j()}}function Vs(e){h.setCurrentActionFundId(e)}function st(){return h.currentActionFundId}async function Et(){const e=document.getElementById("groupsList");if(!e)return;const t=await he();h.setGroups(t),Ne("newGroupParent");const n=yt(t),o=(s,a)=>{let i=`
      <div class="group-item" style="margin-left: ${a*20}px; padding: 10px; border-bottom: 1px solid var(--color-border);">
        <div style="display: flex; justify-content: space-between; align-items: center;">
          <div>
            <strong>${A(s.name)}</strong>
            ${s.type?`<span style="font-size: 0.85em; color: var(--color-text-light);"> (${A(s.type)})</span>`:""}
          </div>
          <div>
            <button class="btn-icon" data-action="editGroup" data-id="${W(String(s.id))}" title="Edit">✎</button>
            <button class="btn-icon danger" data-action="deleteGroup" data-id="${W(String(s.id))}" title="Delete">×</button>
          </div>
        </div>
      </div>
    `;return s.children&&s.children.length>0&&s.children.forEach(c=>{i+=o(c,a+1)}),i};e.innerHTML=n.map(s=>o(s,0)).join(""),ne("manageGroupsModal")}async function Hs(e){const t=document.getElementById("editGroupId"),n=document.getElementById("newGroupName"),o=document.getElementById("newGroupParent"),s=document.getElementById("newGroupType"),a=n?.value?.trim()||"",r=o?.value?parseInt(o.value,10):null,i=s?.value||"",c=t?.value?parseInt(t.value,10):null;if(!a){S("Please enter a group name","error");return}if(h.getGroups().find(d=>d.name.toLowerCase()===a.toLowerCase()&&d.id!==c)){S("A group with this name already exists","error");return}try{K("Saving...");const d={name:a,parentGroupId:r,type:i||void 0};c&&(d.id=c),await jt(d),h.clearMetricsCache(),S(c?"Group updated successfully":"Group added successfully"),n&&(n.value=""),s&&(s.value=""),o&&(o.value=""),t&&(t.value="");const m=await he();h.setGroups(m),await Et(),await e()}catch(d){console.error("Error saving group:",d),S("Error saving group: "+d.message,"error")}finally{j()}}async function Ws(e,t){const n=h.getGroupByIdSync(e);if(!n){S("Group not found","error");return}if(await Ee(`Are you sure you want to delete "${n.name}"? Funds in this group will become ungrouped.`,{title:"Delete Group",confirmText:"Delete",cancelText:"Cancel"}))try{K("Deleting...");const a=(await q()).filter(i=>i.groupId===e);if(a.length>0){const i=a.map(l=>ie({...l,groupId:null})),u=(await Promise.allSettled(i)).filter(l=>l.status==="rejected");u.length>0&&(u.forEach((l,d)=>{console.error(`Failed to update fund ${a[d]?.id}:`,l.reason)}),S(`Warning: ${u.length} fund(s) could not be updated`,"warning"))}await qo(e);const r=await he();h.setGroups(r),S("Group deleted successfully"),await Et(),await t()}catch(s){console.error("Error deleting group:",s),S("Error deleting group: "+s.message,"error")}finally{j()}}let be=[];function _t(){be=[]}async function js(){const e=await q(),t=await he(),n=new Map;t.forEach(a=>n.set(a.id,a.name));const o=new Map;for(const a of e)a.accountNumber&&(o.has(a.accountNumber)||o.set(a.accountNumber,[]),o.get(a.accountNumber).push(a));const s=[];for(const[a,r]of o){if(new Set(r.map(d=>d.groupId)).size<=1)continue;const c=new Map;for(const d of r)c.set(d.groupId,(c.get(d.groupId)||0)+1);let u=null,l=0;for(const[d,m]of c)d!==null&&(u===null||m>l)&&(u=d,l=m);s.push({accountNumber:a,funds:r.map(d=>({id:d.id,fundName:d.fundName,groupId:d.groupId,groupName:d.groupId?n.get(d.groupId)||"Unknown":"None"})),suggestedGroupId:u,suggestedGroupName:u?n.get(u)||"Unknown":"None"})}return s}async function qs(){const e=document.getElementById("syncAccountGroupsContent"),t=document.getElementById("applySyncAccountGroupsBtn");if(!e||!t)return;if(e.innerHTML='<p style="color: var(--color-text-light);">Analyzing account groups...</p>',t.disabled=!0,ne("syncAccountGroupsModal"),be=await js(),be.length===0){e.innerHTML=`
      <div style="padding: 20px; text-align: center; color: var(--color-success);">
        <p style="font-size: 16px; margin-bottom: 8px;">&#10003; All account numbers have consistent group assignments.</p>
        <p style="color: var(--color-text-light); font-size: 14px;">No sync needed.</p>
      </div>
    `,t.disabled=!0;return}let n=`
    <p style="margin-bottom: 16px; color: var(--color-warning);">
      Found <strong>${be.length}</strong> account number${be.length>1?"s":""} with inconsistent group assignments.
    </p>
    <table style="width: 100%; border-collapse: collapse; font-size: 13px;">
      <thead>
        <tr style="background: var(--color-alt-bg);">
          <th style="padding: 8px 12px; text-align: left; border-bottom: 1px solid var(--color-border);">Account #</th>
          <th style="padding: 8px 12px; text-align: left; border-bottom: 1px solid var(--color-border);">Current Groups</th>
          <th style="padding: 8px 12px; text-align: left; border-bottom: 1px solid var(--color-border);">Sync To</th>
        </tr>
      </thead>
      <tbody>
  `;for(const o of be){const s=[...new Set(o.funds.map(a=>a.groupName))].join(", ");n+=`
      <tr>
        <td style="padding: 8px 12px; border-bottom: 1px solid var(--color-border);">${A(o.accountNumber)}</td>
        <td style="padding: 8px 12px; border-bottom: 1px solid var(--color-border);">${A(s)}</td>
        <td style="padding: 8px 12px; border-bottom: 1px solid var(--color-border); color: var(--color-action); font-weight: 500;">${A(o.suggestedGroupName)}</td>
      </tr>
    `}n+="</tbody></table>",e.innerHTML=n,t.disabled=!1}async function Zs(e){if(be.length===0){S("No sync needed"),_t(),O("syncAccountGroupsModal");return}try{K("Syncing account groups...");const t=[];for(const r of be)for(const i of r.funds)i.groupId!==r.suggestedGroupId&&t.push({fundId:i.id,suggestedGroupId:r.suggestedGroupId});const n=t.map(async({fundId:r,suggestedGroupId:i})=>{const c=await ye(r);c&&await ie({...c,groupId:i})}),o=await Promise.allSettled(n),s=o.filter(r=>r.status==="fulfilled").length,a=o.filter(r=>r.status==="rejected");a.length>0&&a.forEach((r,i)=>{console.error(`Account group sync failed for operation ${i+1}:`,r.reason)}),_t(),h.clearMetricsCache(),O("syncAccountGroupsModal"),a.length>0?S(`Synced ${s} investment(s), ${a.length} failed`,"warning"):S(`Synced groups for ${s} investment${s!==1?"s":""}`),await e()}catch(t){console.error("Error syncing account groups:",t),S("Error syncing account groups: "+t.message,"error")}finally{j()}}let Fe=[];function po(){Fe=[]}function zs(){const e=new Set;return h.fundNameData.forEach(t=>{t.tags&&t.tags.forEach(n=>e.add(n))}),[...e].sort()}async function ze(){const e=document.getElementById("fundNamesList");if(!e)return;const t=await We();e.innerHTML="",t.sort((n,o)=>n.name.localeCompare(o.name)).forEach(n=>{const o=document.createElement("div");o.className="fund-name-item",o.innerHTML=`
        <div>
          <strong>${A(n.name)}</strong>
          ${n.tags&&n.tags.length>0?`<div class="fund-name-tags">${n.tags.map(s=>`<span class="table-tag">${A(s)}</span>`).join("")}</div>`:""}
        </div>
        <div>
          <button class="btn-icon" data-action="editFundName" data-name="${W(n.name)}" title="Edit">✎</button>
          <button class="btn-icon danger" data-action="deleteFundName" data-name="${W(n.name)}" title="Delete">×</button>
        </div>
      `,e.appendChild(o)}),ne("manageFundNamesModal")}function Xt(){const e=document.getElementById("editFundTagsContainer");e&&(e.innerHTML="",Fe.forEach((t,n)=>{const o=document.createElement("span");o.className="tag",o.innerHTML=`${A(t)} <button type="button" class="tag-remove" data-index="${n}">&times;</button>`,e.appendChild(o)}))}function go(e){const t=h.fundNameData.get(e);if(!t){S("Fund not found","error");return}Fe=[...t.tags||[]];const n=document.getElementById("editFundNameOriginal"),o=document.getElementById("editFundNameInput"),s=document.getElementById("editFundTagsDatalist"),a=document.getElementById("editFundTermStartDate"),r=document.getElementById("editFundInvestmentTerm");n&&(n.value=e),o&&(o.value=e),a&&(a.value=t.investmentTermStartDate||""),r&&(r.value=t.investmentTermYears?.toString()||""),Xt(),s&&(s.innerHTML="",zs().forEach(i=>{const c=document.createElement("option");c.value=i,s.appendChild(c)})),ne("editFundNameModal")}function Ks(e){const t=e.trim();t&&!Fe.includes(t)&&(Fe.push(t),Xt())}function Xs(e){Fe.splice(e,1),Xt()}async function Js(e){const t=document.getElementById("editFundNameOriginal"),n=document.getElementById("editFundNameInput"),o=document.getElementById("editFundTermStartDate"),s=document.getElementById("editFundInvestmentTerm"),a=t?.value,r=n?.value?.trim(),i=o?.value||null,c=s?.value?parseInt(s.value,10):null;if(!r){S("Please enter a fund name","error");return}if(r!==a&&h.fundNames.has(r)){S("A fund with this name already exists","error");return}try{if(K("Saving..."),r!==a&&a){const d=await q();for(const m of d)m.fundName===a&&await ie({...m,fundName:r,timestamp:new Date().toISOString()});await Wn(a),h.fundNames.delete(a),h.fundNameData.delete(a)}const u={name:r,tags:Fe,investmentTermStartDate:i,investmentTermYears:c};await Se(u),h.fundNames.add(r),h.fundNameData.set(r,u),po(),O("editFundNameModal"),S("Fund updated successfully"),document.getElementById("manageFundNamesModal")?.classList.contains("show")&&await ze(),await e()}catch(u){console.error("Error saving fund name:",u),S("Error saving fund: "+u.message,"error")}finally{j()}}async function Qs(e,t){const o=(await q()).filter(a=>a.fundName===e);if(o.length>0){S(`Cannot delete: ${o.length} investment(s) use this fund name`,"error");return}if(await Ee(`Are you sure you want to delete "${e}"? This action cannot be undone.`,{title:"Delete Fund Name",confirmText:"Delete",cancelText:"Cancel"}))try{K("Deleting..."),await Wn(e),h.fundNames.delete(e),h.fundNameData.delete(e),S("Fund name deleted successfully"),await ze(),await t()}catch(a){console.error("Error deleting fund name:",a),S("Error deleting fund name: "+a.message,"error")}finally{j()}}async function ea(e){const t=document.getElementById("newFundNameInput"),n=document.getElementById("newFundTermStartDate"),o=document.getElementById("newFundInvestmentTerm"),s=t?.value?.trim(),a=n?.value||null,r=o?.value?parseInt(o.value,10):null;if(!s){S("Please enter a fund name","error");return}if(h.fundNames.has(s)){S("A fund with this name already exists","error");return}try{K("Adding...");const i={name:s,tags:[],investmentTermStartDate:a,investmentTermYears:r};await Se(i),h.fundNames.add(s),h.fundNameData.set(s,i),t&&(t.value=""),n&&(n.value=""),o&&(o.value="");const c=document.getElementById("newFundTermsDetails");c&&(c.open=!1),S("Fund name added successfully"),await ze(),await e()}catch(i){console.error("Error adding fund name:",i),S("Error adding fund name: "+i.message,"error")}finally{j()}}async function ta(){const e=document.getElementById("newFundNameInline"),t=e?.value?.trim();if(!t){S("Please enter a fund name","error");return}if(h.fundNames.has(t)){S("A fund with this name already exists","error");return}try{const n={name:t,tags:[],investmentTermStartDate:null,investmentTermYears:null};await Se(n),h.fundNames.add(t),h.fundNameData.set(t,n),await Ze();const o=document.getElementById("fundName");o&&(o.value=t);const s=document.getElementById("newFundNameContainer");s&&s.classList.add("hidden"),e&&(e.value=""),S("Fund name added successfully")}catch(n){console.error("Error adding fund name:",n),S("Error adding fund name: "+n.message,"error")}}function na(){const e=document.getElementById("newFundNameContainer"),t=document.getElementById("newFundNameInline"),n=document.getElementById("fundName");e&&e.classList.add("hidden"),t&&(t.value=""),n&&(n.value="")}function oa(e){return E.DANGEROUS_KEYS.includes(e)||e==="__defineGetter__"||e==="__defineSetter__"||e==="__lookupGetter__"||e==="__lookupSetter__"}function Pt(e,t=0){if(t>E.MAX_JSON_DEPTH)throw new Error("Object too deeply nested");if(e===null||typeof e!="object")return e;if(Array.isArray(e))return e.map(o=>Pt(o,t+1));const n=Object.create(null);for(const o of Object.getOwnPropertyNames(e)){if(oa(o)){console.warn(`Blocked potentially dangerous key: ${o}`);continue}const s=Object.getOwnPropertyDescriptor(e,o);if(s&&(s.get||s.set)){console.warn(`Blocked accessor property: ${o}`);continue}n[o]=Pt(e[o],t+1)}return n}function Ke(e){const t=JSON.parse(e);return Pt(t)}function se(e){try{return localStorage.getItem(e)}catch{return console.warn(`Failed to read localStorage key: ${e}`),null}}function me(e,t){try{return localStorage.setItem(e,t),!0}catch(n){return console.warn(`Failed to write localStorage key: ${e}`,n),!1}}function sa(e,t=0){if(e==null)return t;const n=parseInt(e,10);return isNaN(n)?t:n}function Ut(e){const t=document.getElementById("srAnnounce");t&&(t.textContent=e,setTimeout(()=>{t.textContent=""},E.SR_ANNOUNCEMENT_DURATION))}function Z(e){return e==null||!Number.isFinite(e)?"":e.toFixed(2)}function z(e){if(e==null)return"";if(typeof e=="number")return isFinite(e)?String(e):"";const t=String(e);if(t.length===0)return"";const n=t.charAt(0);if(["=","+","@","	","\r"].includes(n))return"'"+t;if(n==="-"){const o=Number(t);if(isNaN(o)||!isFinite(o))return"'"+t}return t}async function ho(){try{const e=await q(),t=await We(),n=await he(),o=await zo(),s={funds:e,fundNames:t,groups:n,auditLog:o,exportDate:new Date().toISOString()},a=JSON.stringify(s,null,2),r=new Blob([a],{type:"application/json"}),c=`pe-funds-export-${new Date().toISOString().replace(/[:.]/g,"-")}.json`;if("showSaveFilePicker"in window)try{const d=await(await window.showSaveFilePicker({suggestedName:c,types:[{description:"JSON Files",accept:{"application/json":[".json"]}}]})).createWritable();await d.write(r),await d.close(),h.markDataExported(),S("Data exported successfully");return}catch(l){if(l.name==="AbortError")return;throw l}const u=URL.createObjectURL(r);try{const l=document.createElement("a");l.href=u,l.download=c,document.body.appendChild(l),l.click(),document.body.removeChild(l)}finally{URL.revokeObjectURL(u)}h.markDataExported(),S("Data exported successfully")}catch(e){S("Error exporting data: "+e.message,"error"),console.error("Error exporting data:",e)}}async function aa(){K("Exporting to CSV...");try{const e=await q();let t=vt(e);h.sortColumns.length>0&&(t=to(t,h.sortColumns));const o=document.getElementById("cutoffDate")?.value,s=o?new Date(o+"T00:00:00"):void 0,a=t.map(y=>({...y,metrics:ce(y,s)})),r=se(E.STORAGE_GROUP_BY_FUND)==="true";let i,c;if(r){const y=oo(a,s,h.sortColumns);i=["Fund Name","Vintage","Investor Count","Total Commitment","Total Contributions","Total Distributions","Total NAV","Investment Return","MOIC","IRR","Outstanding Commitment"],c=y.map(f=>{const p=f.consolidatedMetrics,v=p.investmentReturn??p.distributions+p.nav-p.calledCapital;return[pe(f.fundName),pe(p.vintageYear?.toString()||""),z(f.investorCount.toString()),z(Z(p.commitment)),z(Z(p.calledCapital)),z(Z(p.distributions)),z(Z(p.nav)),z(Z(v)),z(p.moic!==null&&isFinite(p.moic)?p.moic.toFixed(2):""),z(p.irr!==null?(p.irr*100).toFixed(2):""),z(Z(p.outstandingCommitment))].join(",")})}else i=["Fund Name","Account Number","Vintage","Commitment","Total Contributions","Total Distributions","NAV","Investment Return","MOIC","IRR","Outstanding Commitment"],c=a.map(y=>{const f=y.metrics,p=f.investmentReturn??f.distributions+f.nav-f.calledCapital;return[pe(y.fundName),pe(y.accountNumber),pe(f.vintageYear?.toString()||""),z(Z(f.commitment)),z(Z(f.calledCapital)),z(Z(f.distributions)),z(Z(f.nav)),z(Z(p)),z(f.moic!==null&&isFinite(f.moic)?f.moic.toFixed(2):""),z(f.irr!==null?(f.irr*100).toFixed(2):""),z(Z(f.outstandingCommitment))].join(",")});const u=[i.join(","),...c].join(`
`),l=new Blob([u],{type:"text/csv;charset=utf-8;"}),m=`pe-funds-export-${new Date().toISOString().replace(/[:.]/g,"-").split("T")[0]}.csv`,g=document.createElement("a");if(g.download!==void 0){const y=URL.createObjectURL(l);try{g.setAttribute("href",y),g.setAttribute("download",m),g.style.visibility="hidden",document.body.appendChild(g),g.click(),document.body.removeChild(g)}finally{URL.revokeObjectURL(y)}}S("CSV exported successfully")}catch(e){S("Error exporting CSV: "+e.message,"error"),console.error("Error exporting CSV:",e)}finally{j()}}function ra(){window.print()}let ke=null;async function ia(e){const t=await q(),n=new Map;t.forEach(r=>{if(r.groupId){const i=r.accountNumber.replace(/\s/g,"").toLowerCase();n.has(i)||n.set(i,[]);const c=n.get(i);c.includes(r.groupId)||c.push(r.groupId)}});let o=0,s=0;const a=[];for(const r of e)if(r.groupId==null&&r.accountNumber){const i=r.accountNumber.replace(/\s/g,"").toLowerCase(),c=n.get(i);c&&c.length===1?(r.groupId=c[0],r._groupAutoFilled=!0,o++):c&&c.length>1&&(s++,a.includes(r.accountNumber)||a.push(r.accountNumber))}return{enrichedCount:o,ambiguousCount:s,ambiguousAccounts:a}}function ca(){ke=null;const e=document.getElementById("importPreviewContent"),t=document.getElementById("applyImportBtn"),n=document.getElementById("importPreviewFileInput");e&&(e.innerHTML='<p style="color: var(--color-text-light);">Select a JSON file to preview...</p>'),t&&(t.disabled=!0),n&&(n.value=""),ne("importPreviewModal")}async function la(e){const t=e.target,n=t.files?.[0];if(!n)return;const o=document.getElementById("importPreviewContent"),s=document.getElementById("applyImportBtn");if(n.size>E.MAX_FILE_SIZE){if(o){const a=document.createElement("p");a.style.color="var(--color-danger)",a.textContent=`File too large (${(n.size/1024/1024).toFixed(2)}MB). Maximum size is ${E.MAX_FILE_SIZE/1024/1024}MB.`,o.replaceChildren(a)}t.value="";return}try{const a=await n.text(),r=Ke(a);if(r===null||typeof r!="object"){if(o){const b=document.createElement("p");b.style.color="var(--color-danger)",b.textContent="Invalid file format: expected JSON object or array.",o.replaceChildren(b)}s&&(s.disabled=!0),t.value="";return}ke=r;const i=r.funds||r,c=Array.isArray(i)?i.length:0,u=r.groups?.length||0,l=r.fundNames?.length||0,d=await q(),m=new Set;d.forEach(b=>{const w=`${b.fundName}|${b.accountNumber}`.toLowerCase();m.add(w)});const g=[],y=[],f=new Set;if(Array.isArray(i))for(const b of i){const w=(b.accountNumber||"").replace(/\s/g,""),C=`${b.fundName}|${w}`.toLowerCase();m.has(C)||f.has(C)?g.push({fundName:b.fundName,accountNumber:b.accountNumber}):(y.push({fundName:b.fundName,accountNumber:b.accountNumber}),f.add(C))}const p=await he(),v=new Set(p.map(b=>b.name.toLowerCase()));let F=0,N=0;if(r.groups&&Array.isArray(r.groups))for(const b of r.groups)v.has(b.name.toLowerCase())?F++:N++;let D=`
      <div style="margin-bottom: 15px;">
        <strong>File:</strong> ${A(n.name)}<br>
        <strong>Size:</strong> ${(n.size/1024).toFixed(2)} KB
      </div>
      <div style="margin-bottom: 15px;">
        <strong>Contents:</strong>
        <ul style="margin: 10px 0 0 20px;">
          <li>${c} fund(s)</li>
          ${u>0?`<li>${u} group(s)</li>`:""}
          ${l>0?`<li>${l} fund name(s)</li>`:""}
        </ul>
      </div>
    `;c>0&&(D+=`
        <div style="margin-bottom: 15px; padding: 12px; background: var(--color-alt-bg); border-radius: var(--radius-sm);">
          <strong>Import Analysis:</strong>
          <ul style="margin: 10px 0 0 20px;">
            <li style="color: var(--color-success);">${y.length} new fund(s) will be imported</li>
            ${g.length>0?`<li style="color: var(--color-warning);">${g.length} duplicate(s) will be skipped</li>`:""}
            ${N>0?`<li style="color: var(--color-success);">${N} new group(s) will be created</li>`:""}
            ${F>0?`<li style="color: var(--color-warning);">${F} existing group(s) will be skipped</li>`:""}
          </ul>
        </div>
      `),g.length>0&&(D+=`
        <div style="margin-bottom: 15px;">
          <strong style="color: var(--color-warning);">Duplicates to skip:</strong>
          <ul style="margin: 10px 0 0 20px; font-size: 0.9em; color: var(--color-warning);">
            ${g.slice(0,5).map(b=>`<li>${A(b.fundName)} (${A(b.accountNumber)})</li>`).join("")}
            ${g.length>5?`<li>... and ${g.length-5} more</li>`:""}
          </ul>
        </div>
      `),y.length>0&&(D+=`
        <div>
          <strong>New funds to import:</strong>
          <ul style="margin: 10px 0 0 20px; font-size: 0.9em;">
            ${y.slice(0,5).map(b=>`<li>${A(b.fundName)} (${A(b.accountNumber)})</li>`).join("")}
            ${y.length>5?`<li>... and ${y.length-5} more</li>`:""}
          </ul>
        </div>
      `),o&&(o.innerHTML=D),s&&(s.disabled=y.length===0&&N===0&&l===0)}catch(a){o&&(o.innerHTML=`<p style="color: var(--color-danger);">Error reading file: ${A(a.message)}</p>`),ke=null,t.value=""}}async function ua(e){if(!ke){S("No import data available","error");return}O("importPreviewModal"),K("Importing data...");try{const t=ke;let n=0;const o={};if(t.groups&&Array.isArray(t.groups)){if(t.groups.length>E.MAX_IMPORT_GROUPS)throw new Error(`Too many groups (${t.groups.length}). Maximum allowed is ${E.MAX_IMPORT_GROUPS}.`);const f=new Set(t.groups.map(w=>w.id)),p=[];for(const w of t.groups)w.parentGroupId!=null&&(f.has(w.parentGroupId)?w.id===w.parentGroupId&&(p.push({name:w.name,reason:"Self-referencing parent removed"}),w.parentGroupId=null):(p.push({name:w.name,reason:`Parent group ID ${w.parentGroupId} not found in import`}),w.parentGroupId=null));p.length>0&&console.warn(`Import: ${p.length} group(s) had invalid parent references and were moved to root level:`,p);const v=[],F=new Set;let N=[...t.groups];for(;N.length>0;){const w=N.length;for(let C=N.length-1;C>=0;C--){const L=N[C];(L.parentGroupId==null||F.has(L.parentGroupId))&&(v.push(L),F.add(L.id),N.splice(C,1))}if(N.length===w){console.warn(`Import: ${N.length} group(s) had circular parent references and were moved to root level:`,N.map(C=>C.name)),N.forEach(C=>{C.parentGroupId=null,v.push(C)});break}}const D=await he(),b={};D.forEach(w=>{b[w.name.toLowerCase()]=w});for(const w of v){const C=w.id,{id:L,...x}=w;x.parentGroupId!=null&&o[x.parentGroupId]&&(x.parentGroupId=o[x.parentGroupId]);const R=b[x.name.toLowerCase()];if(R)C!=null&&(o[C]=R.id);else{const J=await jt(x);C!=null&&J&&(o[C]=J),b[x.name.toLowerCase()]={...x,id:J}}}h.setGroups(await he())}if(t.fundNames&&Array.isArray(t.fundNames)){if(t.fundNames.length>E.MAX_IMPORT_FUNDNAMES)throw new Error(`Too many fund names (${t.fundNames.length}). Maximum allowed is ${E.MAX_IMPORT_FUNDNAMES}.`);const f=[];for(const p of t.fundNames){const v=typeof p=="string"?{name:p,tags:[],investmentTermStartDate:null,investmentTermYears:null}:{name:p.name,tags:p.tags||[],investmentTermStartDate:p.investmentTermStartDate||p.finalCloseDate||null,investmentTermYears:p.investmentTermYears||null};await Se(v),f.push(v)}for(const p of f)h.fundNames.add(p.name),h.fundNameData.set(p.name,p)}const s=t.funds||t;if(!Array.isArray(s))throw new Error("Invalid format: expected array of funds");if(s.length>E.MAX_IMPORT_FUNDS)throw new Error(`Too many funds (${s.length}). Maximum allowed is ${E.MAX_IMPORT_FUNDS}.`);const a=new Set;s.forEach(f=>{f.fundName&&!h.fundNames.has(f.fundName)&&a.add(f.fundName)});for(const f of a){const p={name:f,tags:[],investmentTermStartDate:null,investmentTermYears:null};await Se(p),h.fundNames.add(f),h.fundNameData.set(f,p)}const r=await ia(s),i=await q(),c=new Set;i.forEach(f=>{const p=`${f.fundName}|${f.accountNumber}`.toLowerCase();c.add(p)});const u=[],l=[],d=[];for(let f=0;f<s.length;f++){const p=s[f],v=(p.accountNumber||"").replace(/\s/g,""),F=`${p.fundName}|${v}`.toLowerCase();if(c.has(F))continue;const N=(p.cashFlows||[]).map(C=>({date:C.date,amount:ee(C.amount),type:C.type||(C.amount<0?"Contribution":"Distribution"),affectsCommitment:C.affectsCommitment!==void 0?C.affectsCommitment:!0})),D=(p.monthlyNav||[]).map(C=>({date:C.date,amount:ee(C.amount)})),b={fundName:p.fundName,accountNumber:(p.accountNumber||"").replace(/\s/g,""),commitment:ee(p.commitment),cashFlows:N,monthlyNav:D},w=Vn(b);w.valid||d.push({index:f,name:p.fundName||p.accountNumber||`Fund ${f+1}`,errors:w.errors})}if(d.length>0){const f=d.slice(0,5).map(v=>`• ${v.name}: ${v.errors.slice(0,2).join("; ")}`).join(`
`),p=d.length>5?`
...and ${d.length-5} more`:"";throw new Error(`Import aborted: ${d.length} fund(s) failed validation.

${f}${p}`)}const m=[];for(let f=0;f<s.length;f++){const p=s[f],v=(p.accountNumber||"").replace(/\s/g,""),F=`${p.fundName}|${v}`.toLowerCase();if(c.has(F)){u.push({index:f,name:p.fundName,account:p.accountNumber});continue}c.add(F);const N=(p.cashFlows||[]).map(C=>({date:C.date,amount:ee(C.amount),type:C.type||(C.amount<0?"Contribution":"Distribution"),affectsCommitment:C.affectsCommitment!==void 0?C.affectsCommitment:!0})),D=(p.monthlyNav||[]).map(C=>({date:C.date,amount:ee(C.amount)}));let b=null;p.groupId!=null&&(p._groupAutoFilled?b=p.groupId:o[p.groupId]&&(b=o[p.groupId]));const w={fundName:p.fundName,accountNumber:(p.accountNumber||"").replace(/\s/g,""),groupId:b,commitment:ee(p.commitment),cashFlows:N,monthlyNav:D,timestamp:p.timestamp||new Date().toISOString()};m.push({index:f,fund:p,fundData:w})}if((await Promise.allSettled(m.map(({fundData:f})=>ie(f)))).forEach((f,p)=>{const v=m[p];if(!v)return;const{index:F,fund:N}=v;f.status==="fulfilled"?n++:(console.error(`Error importing fund at index ${F}:`,f.reason),l.push({index:F,name:N.fundName||N.accountNumber||"Unknown",error:f.reason?.message||"Unknown error"}))}),l.length>0||u.length>0){const f=[];n>0&&f.push(`${n} imported`),u.length>0&&f.push(`${u.length} duplicates skipped`),l.length>0&&f.push(`${l.length} failed`),r.enrichedCount>0&&f.push(`${r.enrichedCount} groups auto-filled`);const p=l.length>0?"error":"success";S(`Import complete: ${f.join(", ")}`,p)}else{let f=`Successfully imported ${n} fund(s)`;r.enrichedCount>0&&(f+=` (${r.enrichedCount} groups auto-filled)`),S(f)}ke=null;const y={fundFilter:V("fundFilter"),accountFilter:V("accountFilter"),groupFilter:V("groupFilter"),tagFilter:V("tagFilter"),vintageFilter:V("vintageFilter")};await e(),Be("fundFilter",y.fundFilter),Be("accountFilter",y.accountFilter),Be("groupFilter",y.groupFilter),Be("tagFilter",y.tagFilter),Be("vintageFilter",y.vintageFilter),await e()}catch(t){S("Error importing data: "+t.message,"error"),console.error("Error importing data:",t)}finally{j()}}async function da(e){K("Loading sample data...");try{const t=[{name:"Buyout Funds",parentGroupId:null,type:"Strategy"},{name:"Venture Capital",parentGroupId:null,type:"Strategy"},{name:"Real Estate",parentGroupId:null,type:"Strategy"}],n={};for(const a of t){const r=await jt(a);n[a.name]=r}h.setGroups(await he());const o=[{name:"Apex Capital Partners",tags:["Buyout","North America"],investmentTermStartDate:"2020-06-15",investmentTermYears:10},{name:"Summit Growth Fund",tags:["Growth","Technology"],investmentTermStartDate:"2021-03-01",investmentTermYears:10},{name:"Horizon Ventures",tags:["Venture","Early Stage"],investmentTermStartDate:"2022-01-10",investmentTermYears:12},{name:"Metro Real Estate Partners",tags:["Real Estate","Commercial"],investmentTermStartDate:"2019-09-01",investmentTermYears:8},{name:"Blue Ocean Capital",tags:["Buyout","Europe"],investmentTermStartDate:"2021-07-20",investmentTermYears:10}];for(const a of o)await Se(a),h.fundNames.add(a.name),h.fundNameData.set(a.name,a);const s=[{fundName:"Apex Capital Partners",accountNumber:"APEX-001",groupId:n["Buyout Funds"]??null,commitment:5e6,cashFlows:[{date:"2020-07-01",amount:-125e4,type:"Contribution",affectsCommitment:!0},{date:"2020-12-15",amount:-1e6,type:"Contribution",affectsCommitment:!0},{date:"2021-06-30",amount:-75e4,type:"Contribution",affectsCommitment:!0},{date:"2022-03-15",amount:-5e5,type:"Contribution",affectsCommitment:!0},{date:"2023-01-20",amount:8e5,type:"Distribution",affectsCommitment:!0},{date:"2023-09-10",amount:12e5,type:"Distribution",affectsCommitment:!0}],monthlyNav:[{date:"2021-12-31",amount:32e5},{date:"2022-12-31",amount:38e5},{date:"2023-12-31",amount:45e5}],timestamp:new Date().toISOString()},{fundName:"Summit Growth Fund",accountNumber:"SUMMIT-001",groupId:n["Venture Capital"]??null,commitment:25e5,cashFlows:[{date:"2021-04-01",amount:-625e3,type:"Contribution",affectsCommitment:!0},{date:"2021-10-15",amount:-5e5,type:"Contribution",affectsCommitment:!0},{date:"2022-06-30",amount:-375e3,type:"Contribution",affectsCommitment:!0},{date:"2023-06-15",amount:4e5,type:"Distribution",affectsCommitment:!0}],monthlyNav:[{date:"2022-12-31",amount:18e5},{date:"2023-12-31",amount:22e5}],timestamp:new Date().toISOString()},{fundName:"Horizon Ventures",accountNumber:"HV-001",groupId:n["Venture Capital"]??null,commitment:1e6,cashFlows:[{date:"2022-02-01",amount:-25e4,type:"Contribution",affectsCommitment:!0},{date:"2022-08-15",amount:-2e5,type:"Contribution",affectsCommitment:!0},{date:"2023-04-01",amount:-15e4,type:"Contribution",affectsCommitment:!0}],monthlyNav:[{date:"2022-12-31",amount:52e4},{date:"2023-12-31",amount:75e4}],timestamp:new Date().toISOString()},{fundName:"Metro Real Estate Partners",accountNumber:"METRO-001",groupId:n["Real Estate"]??null,commitment:3e6,cashFlows:[{date:"2019-10-01",amount:-75e4,type:"Contribution",affectsCommitment:!0},{date:"2020-04-15",amount:-6e5,type:"Contribution",affectsCommitment:!0},{date:"2020-12-01",amount:-45e4,type:"Contribution",affectsCommitment:!0},{date:"2021-06-30",amount:-3e5,type:"Contribution",affectsCommitment:!0},{date:"2022-03-15",amount:5e5,type:"Distribution",affectsCommitment:!0},{date:"2023-03-15",amount:6e5,type:"Distribution",affectsCommitment:!0}],monthlyNav:[{date:"2021-12-31",amount:24e5},{date:"2022-12-31",amount:28e5},{date:"2023-12-31",amount:31e5}],timestamp:new Date().toISOString()},{fundName:"Blue Ocean Capital",accountNumber:"BOC-001",groupId:n["Buyout Funds"]??null,commitment:4e6,cashFlows:[{date:"2021-08-01",amount:-1e6,type:"Contribution",affectsCommitment:!0},{date:"2022-02-15",amount:-8e5,type:"Contribution",affectsCommitment:!0},{date:"2022-09-01",amount:-6e5,type:"Contribution",affectsCommitment:!0},{date:"2023-05-15",amount:7e5,type:"Distribution",affectsCommitment:!0}],monthlyNav:[{date:"2022-12-31",amount:26e5},{date:"2023-12-31",amount:32e5}],timestamp:new Date().toISOString()}];for(const a of s)await ie(a);h.clearMetricsCache(),S(`Successfully loaded ${s.length} sample investments`),await e()}catch(t){S("Error loading sample data: "+t.message,"error"),console.error("Error loading sample data:",t)}finally{j()}}async function yo(e){const t=document.getElementById(e);if(!t)return;const o=(await We()).map(s=>s.name).sort();t.innerHTML='<option value="">Select a fund</option>',o.forEach(s=>{const a=document.createElement("option");a.value=s,a.textContent=s,t.appendChild(a)})}async function ma(e){const t=document.getElementById(e);if(!t)return;const n=await q(),o=[...new Set(n.map(s=>s.accountNumber))].sort();t.innerHTML='<option value="">Select an account</option>',o.forEach(s=>{const a=document.createElement("option");a.value=s,a.textContent=s,t.appendChild(a)})}function fa(){const e=document.querySelectorAll(".bulk-amount-input");let t=0;e.forEach(o=>{const s=ee(o.value)||0;t+=s});const n=document.getElementById("bulkCashFlowTotalAmount");n&&(n.textContent=k(t,!0))}async function pa(){await yo("bulkCashFlowFundName");const e=document.getElementById("bulkCashFlowDate"),t=document.getElementById("bulkCashFlowType"),n=document.getElementById("bulkCashFlowPercentage"),o=document.getElementById("bulkCashFlowAffectsCommitment"),s=document.getElementById("bulkCashFlowPreview"),a=document.getElementById("applyBulkCashFlowBtn");e&&(e.value=new Date().toISOString().split("T")[0]||""),t&&(t.value="Contribution"),n&&(n.value=""),o&&(o.checked=!0),s&&s.classList.remove("show"),a&&(a.disabled=!0),ne("bulkCashFlowModal")}async function ga(){const e=document.getElementById("bulkCashFlowFundName"),t=document.getElementById("bulkCashFlowPercentage"),n=document.getElementById("bulkCashFlowType"),o=document.getElementById("bulkCashFlowPreview"),s=document.getElementById("bulkCashFlowPreviewContent"),a=document.getElementById("applyBulkCashFlowBtn"),r=e?.value,i=parseFloat(t?.value||"0"),c=n?.value||"Contribution";if(!r){S("Please select a fund","error");return}if(isNaN(i)||i<=0||i>100){S("Please enter a valid percentage (0.01 - 100)","error");return}const l=(await q()).filter(y=>y.fundName===r);if(l.length===0){S("No investments found for this fund","error");return}let d='<table style="width: 100%; font-size: 0.9em;"><thead><tr><th>Account</th><th style="text-align: right;">Commitment</th><th style="text-align: right;">Amount</th></tr></thead><tbody>',m=0;l.forEach(y=>{const f=y.commitment*(i/100);m+=f;const p=c==="Contribution"?-f:f;d+=`<tr data-fund-id="${W(String(y.id))}">
      <td>${A(y.accountNumber)}</td>
      <td style="text-align: right;">${k(y.commitment,!0)}</td>
      <td style="text-align: right;">
        <input type="text" class="bulk-amount-input"
               value="${W(Ve(p,2))}"
               data-fund-id="${W(String(y.id))}"
               style="width: 120px; text-align: right; border: 1px solid var(--color-border); padding: 2px 4px; font-size: inherit; background: var(--color-bg); color: var(--color-text);">
      </td>
    </tr>`});const g=c==="Contribution"?-m:m;d+=`</tbody><tfoot><tr style="font-weight: bold;"><td>Total (${l.length} investors)</td><td></td><td id="bulkCashFlowTotalAmount" style="text-align: right;">${k(g,!0)}</td></tr></tfoot></table>`,s&&(s.innerHTML=d,s._bulkInputDelegationSetup||(s._bulkInputDelegationSetup=!0,s.addEventListener("input",y=>{y.target.classList.contains("bulk-amount-input")&&fa()}))),o&&o.classList.add("show"),a&&(a.disabled=!1)}async function ha(e){const t=document.getElementById("bulkCashFlowFundName"),n=document.getElementById("bulkCashFlowDate"),o=document.getElementById("bulkCashFlowType"),s=document.getElementById("bulkCashFlowPercentage"),a=document.getElementById("bulkCashFlowAffectsCommitment"),r=t?.value,i=n?.value,c=o?.value||"Contribution",u=parseFloat(s?.value||"0"),l=a?.checked??!0;if(!r||!i||isNaN(u)){S("Missing required fields","error");return}O("bulkCashFlowModal"),K("Applying bulk cash flow...");try{const d=document.querySelectorAll(".bulk-amount-input"),m=new Map;d.forEach(N=>{const D=parseInt(N.dataset.fundId||"0",10),b=ee(N.value)||0;D&&m.set(D,b)});const f=(await q()).filter(N=>N.fundName===r).map(N=>{let D;if(N.id&&m.has(N.id))D=m.get(N.id);else{const w=N.commitment*(u/100);D=c==="Contribution"?-w:w}const b={...N,cashFlows:[...N.cashFlows,{date:i,amount:D,type:c,affectsCommitment:l}],timestamp:new Date().toISOString()};return ie(b)}),p=await Promise.allSettled(f),v=p.filter(N=>N.status==="fulfilled").length,F=p.filter(N=>N.status==="rejected").length;h.clearMetricsCache(),F>0?S(`Added cash flow to ${v} investment(s), ${F} failed`,"warning"):S(`Successfully added cash flow to ${v} investment(s)`),await e()}catch(d){S("Error applying bulk cash flow: "+d.message,"error")}finally{j()}}async function ya(){await yo("bulkRemoveFundName");const e=document.getElementById("bulkRemoveFundPreview"),t=document.getElementById("applyBulkRemoveFundBtn");e&&e.classList.remove("show"),t&&(t.disabled=!0),ne("bulkRemoveFundModal")}async function va(){const e=document.getElementById("bulkRemoveFundName"),t=document.getElementById("bulkRemoveFundPreview"),n=document.getElementById("bulkRemoveFundPreviewContent"),o=document.getElementById("applyBulkRemoveFundBtn"),s=e?.value;if(!s){S("Please select a fund","error");return}const r=(await q()).filter(c=>c.fundName===s);if(r.length===0){S("No investments found for this fund","error");return}let i='<ul style="margin: 0; padding-left: 20px;">';r.forEach(c=>{i+=`<li>${A(c.accountNumber)} - ${k(c.commitment)}</li>`}),i+="</ul>",i+=`<p style="margin-top: 10px; font-weight: bold; color: var(--color-danger);">Total: ${r.length} investment(s) will be permanently deleted.</p>`,n&&(n.innerHTML=i),t&&t.classList.add("show"),o&&(o.disabled=!1)}async function ba(e){const n=document.getElementById("bulkRemoveFundName")?.value;if(!n){S("Please select a fund","error");return}O("bulkRemoveFundModal"),K("Removing investments...");try{const a=(await q()).filter(u=>u.fundName===n).filter(u=>u.id).map(u=>Hn(u.id)),r=await Promise.allSettled(a),i=r.filter(u=>u.status==="fulfilled").length,c=r.filter(u=>u.status==="rejected").length;h.clearMetricsCache(),c>0?S(`Removed ${i} investment(s), ${c} failed`,"warning"):S(`Successfully removed ${i} investment(s)`),await e()}catch(o){S("Error removing investments: "+o.message,"error")}finally{j()}}async function Ea(){await ma("bulkAssignGroupAccount"),Ne("bulkAssignGroupTarget");const e=document.getElementById("bulkAssignGroupPreview"),t=document.getElementById("applyBulkAssignGroupBtn");e&&e.classList.remove("show"),t&&(t.disabled=!0),ne("bulkAssignGroupModal")}async function wa(){const e=document.getElementById("bulkAssignGroupAccount"),t=document.getElementById("bulkAssignGroupTarget"),n=document.getElementById("bulkAssignGroupPreview"),o=document.getElementById("bulkAssignGroupPreviewContent"),s=document.getElementById("applyBulkAssignGroupBtn"),a=e?.value,r=t?.value?parseInt(t.value,10):null;if(!a){S("Please select an account","error");return}const c=(await q()).filter(d=>d.accountNumber===a);if(c.length===0){S("No investments found for this account","error");return}const u=r?h.getGroupByIdSync(r)?.name||"Unknown":"No Group";let l='<ul style="margin: 0; padding-left: 20px;">';c.forEach(d=>{l+=`<li>${A(d.fundName)}</li>`}),l+="</ul>",l+=`<p style="margin-top: 10px;">These ${c.length} investment(s) will be assigned to: <strong>${A(u)}</strong></p>`,o&&(o.innerHTML=l),n&&n.classList.add("show"),s&&(s.disabled=!1)}async function Ia(e){const t=document.getElementById("bulkAssignGroupAccount"),n=document.getElementById("bulkAssignGroupTarget"),o=t?.value,s=n?.value?parseInt(n.value,10):null;if(!o){S("Please select an account","error");return}O("bulkAssignGroupModal"),K("Assigning group...");try{const i=(await q()).filter(d=>d.accountNumber===o).map(d=>{const m={...d,groupId:s,timestamp:new Date().toISOString()};return ie(m)}),c=await Promise.allSettled(i),u=c.filter(d=>d.status==="fulfilled").length,l=c.filter(d=>d.status==="rejected").length;h.clearMetricsCache(),l>0?S(`Updated ${u} investment(s), ${l} failed`,"warning"):S(`Successfully updated ${u} investment(s)`),await e()}catch(a){S("Error assigning group: "+a.message,"error")}finally{j()}}function Sa(e){const t=document.getElementById("closeBulkCashFlowModalBtn"),n=document.getElementById("cancelBulkCashFlowBtn"),o=document.getElementById("previewBulkCashFlowBtn"),s=document.getElementById("applyBulkCashFlowBtn");[t,n].forEach(g=>{g&&g.addEventListener("click",()=>O("bulkCashFlowModal"))}),o&&o.addEventListener("click",ga),s&&s.addEventListener("click",()=>ha(e));const a=document.getElementById("closeBulkRemoveFundModalBtn"),r=document.getElementById("cancelBulkRemoveFundBtn"),i=document.getElementById("previewBulkRemoveFundBtn"),c=document.getElementById("applyBulkRemoveFundBtn");[a,r].forEach(g=>{g&&g.addEventListener("click",()=>O("bulkRemoveFundModal"))}),i&&i.addEventListener("click",va),c&&c.addEventListener("click",()=>ba(e));const u=document.getElementById("closeBulkAssignGroupModalBtn"),l=document.getElementById("cancelBulkAssignGroupBtn"),d=document.getElementById("previewBulkAssignGroupBtn"),m=document.getElementById("applyBulkAssignGroupBtn");[u,l].forEach(g=>{g&&g.addEventListener("click",()=>O("bulkAssignGroupModal"))}),d&&d.addEventListener("click",wa),m&&m.addEventListener("click",()=>Ia(e))}function Bn(e,t){let n=e.commitment||0;for(const o of e.cashFlows||[])t&&new Date(o.date+"T00:00:00")>t||(o.type==="Adjustment"?n-=o.amount:o.affectsCommitment!==!1&&(o.type==="Contribution"?n-=Math.abs(o.amount):o.type==="Distribution"&&(n+=Math.abs(o.amount))));return Math.max(0,n)}function vo(e,t){const n={calls:{},distributions:{},byFund:{}},o=t?t.getFullYear():new Date().getFullYear();return e.forEach(s=>{if(!s.cashFlows||s.cashFlows.length===0)return;const a=s.fundName;n.byFund[a]||(n.byFund[a]={calls:{},distributions:{}}),s.cashFlows.forEach(r=>{if(!r.date)return;const i=new Date(r.date+"T00:00:00"),c=i.getFullYear();if(r.type==="Adjustment"||t&&i>t||c>o)return;const u=Math.abs(r.amount);r.type==="Contribution"?(n.calls[c]=(n.calls[c]||0)+u,n.byFund[a].calls[c]=(n.byFund[a].calls[c]||0)+u):r.type==="Distribution"&&(n.distributions[c]=(n.distributions[c]||0)+u,n.byFund[a].distributions[c]=(n.byFund[a].distributions[c]||0)+u)})}),n}function bo(e,t,n){const o={projectedCalls:{},byFund:{},estimatedCalls:{},estimatedByFund:{},estimatedYears:new Set},s=n||new Date,a=s.getFullYear(),r=4;return e.forEach(i=>{const c=t.get(i.fundName);if(!c)return;const{investmentTermStartDate:u,investmentTermYears:l}=c;if(!u||!l){const D=Bn(i,n);if(D>0){const b=a+1,w=D/r,C=i.fundName;o.estimatedByFund[C]||(o.estimatedByFund[C]={});for(let L=0;L<r;L++){const x=b+L;o.estimatedCalls[x]=(o.estimatedCalls[x]||0)+w,o.estimatedByFund[C][x]=(o.estimatedByFund[C][x]||0)+w,o.estimatedYears.add(x)}}return}const d=new Date(u+"T00:00:00"),m=new Date(d);if(m.setFullYear(m.getFullYear()+l),m<s)return;const g=Bn(i,n);if(g<=0)return;const y=n!==null&&!(s.getMonth()===11&&s.getDate()===31),f=Math.max(y?a:a+1,d.getFullYear()),p=m.getFullYear(),v=[];for(let D=f;D<=p;D++)v.push(D);if(v.length===0)return;const F=g/v.length,N=i.fundName;o.byFund[N]||(o.byFund[N]={}),v.forEach(D=>{o.projectedCalls[D]=(o.projectedCalls[D]||0)+F,o.byFund[N][D]=(o.byFund[N][D]||0)+F})}),o}function Eo(e,t,n){const o=n||new Date().getFullYear(),s=new Set;Object.keys(e.calls).forEach(f=>s.add(parseInt(f,10))),Object.keys(e.distributions).forEach(f=>s.add(parseInt(f,10))),Object.keys(t.projectedCalls).forEach(f=>s.add(parseInt(f,10))),Object.keys(t.estimatedCalls||{}).forEach(f=>s.add(parseInt(f,10)));const a=Array.from(s);if(a.length===0){const f=[];for(let p=o;p<=o+4;p++)f.push(p);return{years:f,cutoffYear:o,firstProjectedYear:o+1,estimatedYears:new Set}}const r=Math.min(...a),i=Math.max(...a),c=Math.min(r,o-9),u=Math.max(i,o+6),l=[];for(let f=c;f<=u;f++)l.push(f);const d=l.filter(f=>f<=o),m=l.filter(f=>f>o),g=d.slice(-10),y=m.slice(0,6);return{years:[...g,...y],cutoffYear:o,firstProjectedYear:y.length>0?y[0]:null,estimatedYears:t.estimatedYears||new Set}}function xn(e,t,n,o,s,a,r,i,c,u,l={},d={}){let m="";const g=A(e),y=W(t);return m+=`<tr class="${t==="calls"?"row-calls":"row-distributions"} timeline-expand-row" ${`data-type="${y}"`}>`,m+=`<td class="row-label"><span class="timeline-expand-icon">▶</span>${g}</td>`,n.years.forEach(p=>{const v=n.firstProjectedYear!==null&&p>=n.firstProjectedYear,F=p===n.firstProjectedYear,N=n.estimatedYears&&n.estimatedYears.has(p);let D=0,b=!1;if(v){const L=s[p]||0,x=l[p]||0;D=L+x,b=x>0}else if(D=o[p]||0,p===n.cutoffYear){const L=s[p]||0,x=l[p]||0;D+=L+x,b=x>0}let w=F?"timeline-divider":"";N&&b?w+=" year-estimated":(v||p===n.cutoffYear&&(s[p]||l[p]))&&(w+=" year-projected");const C=D>0?k(t==="calls"?-D:D):"-";m+=`<td class="${w}">${C}</td>`}),m+="</tr>",r&&r.forEach(p=>{m+=`<tr class="timeline-fund-row" data-type="${y}">`,m+=`<td>${A(p)}</td>`,n.years.forEach(v=>{const F=n.firstProjectedYear!==null&&v>=n.firstProjectedYear,N=v===n.firstProjectedYear,D=n.estimatedYears&&n.estimatedYears.has(v);let b=0,w=!1;if(F){const x=c[p]&&c[p][v]||0,R=d[p]&&d[p][v]||0;b=x+R,w=R>0}else if(i[p]?.[u]?.[v]&&(b=i[p][u][v]),v===n.cutoffYear){const x=c[p]?.[v]||0,R=d[p]?.[v]||0;b+=x+R,w=R>0}let C=N?"timeline-divider":"";D&&w?C+=" year-estimated":(F||v===n.cutoffYear&&(c[p]?.[v]||d[p]?.[v]))&&(C+=" year-projected");const L=b>0?k(t==="calls"?-b:b):"-";m+=`<td class="${C}">${L}</td>`}),m+="</tr>"}),m}function Ca(e,t,n){let o='<tr class="row-net">';return o+='<td class="row-label">Net Cash Flow</td>',e.years.forEach(s=>{const a=e.firstProjectedYear!==null&&s>=e.firstProjectedYear,r=s===e.firstProjectedYear,i=e.estimatedYears&&e.estimatedYears.has(s);let c=0,u=0,l=!1;if(a){const y=n.projectedCalls[s]||0,f=n.estimatedCalls&&n.estimatedCalls[s]||0;c=y+f,l=f>0}else c=t.calls[s]||0,u=t.distributions[s]||0,s===e.cutoffYear&&(c+=(n.projectedCalls[s]||0)+(n.estimatedCalls?.[s]||0),l=(n.estimatedCalls?.[s]||0)>0);const d=u-c;let m=r?"timeline-divider":"";i&&l?m+=" year-estimated":(a||s===e.cutoffYear&&(n.projectedCalls[s]||0)+(n.estimatedCalls?.[s]||0)>0)&&(m+=" year-projected"),m+=` ${d>=0?"positive":"negative"}`;let g="-";(c>0||u>0)&&(g=(d>=0?"+":"")+k(d)),o+=`<td class="${m}">${g}</td>`}),o+="</tr>",o}function Na(e){const t=document.getElementById("timelineTableContainer"),n=document.getElementById("timelinePanel");if(!t)return;if(n&&!n.classList.contains("expanded")){t.innerHTML="";return}if(!e||e.length===0){t.innerHTML='<p class="timeline-no-data">No investments to display. <a href="#" data-action="showAddFundModal" style="color: var(--color-action);">Add your first investment</a> with cash flows to see the timeline.</p>',kn(t);return}const s=document.getElementById("cutoffDate")?.value,a=s?new Date(s+"T00:00:00"):null,r=a?a.getFullYear():null,i=vo(e,a),c=bo(e,h.fundNameData,a),u=Eo(i,c,r);if(u.years.length===0){t.innerHTML='<p class="timeline-no-data">No cash flow data available for the selected funds.</p>';return}let l='<table class="timeline-table">';const d=u.estimatedYears&&u.estimatedYears.size>0;l+="<thead><tr><th></th>",u.years.forEach(g=>{const y=u.firstProjectedYear!==null&&g>=u.firstProjectedYear,f=g===u.firstProjectedYear,p=u.estimatedYears&&u.estimatedYears.has(g),v=`${y&&!p?"year-projected":""} ${p?"year-estimated":""} ${f?"timeline-divider":""}`;let F="";p?F='<span class="timeline-estimated-indicator" title="Estimated: fund(s) missing term start date">&#8224;</span>':y&&(F="*"),l+=`<th class="${v}">${g}${F}</th>`}),l+="</tr></thead>",l+="<tbody>";const m=[...new Set(e.map(g=>g.fundName))].sort();if(l+=xn("Capital Calls","calls",u,i.calls,c.projectedCalls,!0,m,i.byFund,c.byFund,"calls",c.estimatedCalls,c.estimatedByFund),l+=xn("Distributions","distributions",u,i.distributions,{},!0,m,i.byFund,{},"distributions",{},{}),l+=Ca(u,i,c),l+="</tbody></table>",u.firstProjectedYear||d){let g='<div style="margin-top: 10px; font-size: 11px; color: var(--color-text-light); font-style: italic;">';if(u.firstProjectedYear&&!d){const y=a?`* Projected values (after ${A(s||"")}) based on remaining uncalled capital distributed linearly across investment period`:"* Projected values based on remaining uncalled capital distributed linearly across investment period";g+=`<p style="margin: 0;">${y}</p>`}else if(d&&!u.firstProjectedYear)g+='<p style="margin: 0; color: var(--color-warning);">&#8224; Estimated projections for funds missing term start date (spread over 4 years). <a href="#" data-action="showManageFundsModal" style="color: var(--color-action);">Add fund terms</a> for more accurate projections.</p>';else if(u.firstProjectedYear&&d){const y=a?`* Projected values (after ${A(s||"")}) based on remaining uncalled capital distributed linearly across investment period`:"* Projected values based on remaining uncalled capital distributed linearly across investment period";g+=`<p style="margin: 0 0 4px 0;">${y}</p>`,g+='<p style="margin: 0; color: var(--color-warning);">&#8224; Estimated projections for funds missing term start date (spread over 4 years). <a href="#" data-action="showManageFundsModal" style="color: var(--color-action);">Add fund terms</a> for more accurate projections.</p>'}g+="</div>",l+=g}t.innerHTML=l,kn(t)}let An=!1;function kn(e){An||(An=!0,e.addEventListener("click",t=>{const o=t.target.closest("a[data-action]");if(!o)return;t.preventDefault();const s=o.dataset.action;s==="showAddFundModal"&&typeof window.showAddFundModal=="function"?window.showAddFundModal():s==="showManageFundsModal"&&typeof window.showManageFundsModal=="function"&&window.showManageFundsModal()}))}function Fa(){const e=h.getFunds(),t=vt(e);Na(t)}function Ta(){const e=h.getFunds(),t=vt(e);if(!t||t.length===0){S("No data to export","error");return}const o=document.getElementById("cutoffDate")?.value,s=o?new Date(o+"T00:00:00"):null,a=s?s.getFullYear():null,r=vo(t,s),i=bo(t,h.fundNameData,s),c=Eo(r,i,a);if(c.years.length===0){S("No timeline data to export","error");return}const u=[...new Set(t.map(w=>w.fundName))].sort();function l(w,C,L,x={}){if(c.firstProjectedYear!==null&&w>=c.firstProjectedYear)return(L[w]||0)+(x[w]||0);let J=C[w]||0;return w===c.cutoffYear&&(J+=(L[w]||0)+(x[w]||0)),J}function d(w,C,L){if(c.firstProjectedYear!==null&&C>=c.firstProjectedYear){const J=i.byFund[w]?.[C]||0,Q=i.estimatedByFund[w]?.[C]||0;return J+Q}let R=r.byFund[w]?.[L]?.[C]||0;return C===c.cutoffYear&&(R+=(i.byFund[w]?.[C]||0)+(i.estimatedByFund[w]?.[C]||0)),R}const m=c.years.map(w=>{const C=c.firstProjectedYear!==null&&w>=c.firstProjectedYear,L=c.estimatedYears&&c.estimatedYears.has(w);let x="";return L?x="†":C&&(x="*"),z(w+x)}),g=[];g.push(["",...m].join(","));const y=c.years.map(w=>{const C=l(w,r.calls,i.projectedCalls,i.estimatedCalls);return C>0?Z(-C):Z(0)});g.push([pe("Capital Calls"),...y].join(",")),u.forEach(w=>{if(!c.years.some(x=>d(w,x,"calls")>0))return;const L=c.years.map(x=>{const R=d(w,x,"calls");return R>0?Z(-R):Z(0)});g.push([pe("  "+w),...L].join(","))});const f=c.years.map(w=>{const C=l(w,r.distributions,{},{});return Z(C)});g.push([pe("Distributions"),...f].join(",")),u.forEach(w=>{if(!c.years.some(x=>d(w,x,"distributions")>0))return;const L=c.years.map(x=>{const R=d(w,x,"distributions");return Z(R)});g.push([pe("  "+w),...L].join(","))});const p=c.years.map(w=>{const C=l(w,r.calls,i.projectedCalls,i.estimatedCalls),x=l(w,r.distributions,{},{})-C;return Z(x)});g.push([pe("Net Cash Flow"),...p].join(","));const v=g.join(`
`),F=new Blob([v],{type:"text/csv;charset=utf-8;"}),D=`pe-timeline-export-${new Date().toISOString().replace(/[:.]/g,"-").split("T")[0]}.csv`,b=document.createElement("a");if(b.download!==void 0){const w=URL.createObjectURL(F);try{b.setAttribute("href",w),b.setAttribute("download",D),b.style.visibility="hidden",document.body.appendChild(b),b.click(),document.body.removeChild(b)}finally{URL.revokeObjectURL(w)}}S("Timeline CSV exported successfully")}function Da(e,t=[],n=[]){let o=[];const s=new Set;for(const l of e){if(l.id==null)continue;const d=xa(l);for(const m of d)o.push(m),s.add(l.id)}const a=ka(e);for(const l of a)o.push(l),s.add(l.fundId);let r=Ma(e);if(n.length>0){const l=new Set(n.filter(m=>m.fund2Id>0).map(m=>`${Math.min(m.fund1Id,m.fund2Id)}-${Math.max(m.fund1Id,m.fund2Id)}`)),d=new Set(n.filter(m=>m.fund2Id===0).map(m=>`${m.fund1Id}|${m.category}|${m.message}`));r=r.filter(m=>{const g=`${Math.min(m.fund1Id,m.fund2Id)}-${Math.max(m.fund1Id,m.fund2Id)}`;return!l.has(g)}),o=o.filter(m=>{const g=`${m.fundId}|${m.category}|${m.message}`;return!d.has(g)})}const i=Ba(t,e),c={error:0,warning:1,info:2};o.sort((l,d)=>c[l.severity]-c[d.severity]),s.clear();for(const l of o)s.add(l.fundId);const u={error:0,warning:0,info:0};for(const l of o)u[l.severity]++;for(const l of i)u[l.severity]++;return{totalFunds:e.length,fundsWithIssues:s.size,issues:o,duplicates:r,groupIssues:i,errorCount:u.error,warningCount:u.warning,infoCount:u.info,timestamp:new Date().toISOString()}}function Ba(e,t){const n=[],o=new Set;for(const a of t)a.groupId!=null&&o.add(a.groupId);const s=new Set;for(const a of e)a.parentGroupId!=null&&s.add(a.parentGroupId);for(const a of e)if(a.id===0&&n.push({groupId:a.id,groupName:a.name,severity:"error",message:"Group has ID 0 (data corruption). Delete and recreate this group."}),a.id!=null&&a.id!==0){const r=o.has(a.id),i=s.has(a.id);!r&&!i&&n.push({groupId:a.id,groupName:a.name,severity:"warning",message:"Orphaned group: no investments or sub-groups assigned."})}return n}function xa(e){const t=[],n=e.id,o=e.fundName,s=(e.cashFlows||[]).filter(l=>re(l.date)),a=(e.monthlyNav||[]).filter(l=>re(l.date)),r=new Date;r.setDate(r.getDate()+E.HEALTH_FUTURE_DAYS_THRESHOLD);const i=r.toISOString().split("T")[0];if(e.commitment<=0&&t.push({fundId:n,fundName:o,severity:"error",category:"Invalid Data",message:`Commitment is ${e.commitment<=0?e.commitment===0?"zero":"negative":"invalid"}`}),!e.cashFlows||e.cashFlows.length===0)t.push({fundId:n,fundName:o,severity:"info",category:"Incomplete Data",message:"No cash flows recorded"});else{const l=s.filter(f=>f.type==="Contribution").sort((f,p)=>f.date.localeCompare(p.date)),d=s.filter(f=>f.type==="Distribution").sort((f,p)=>f.date.localeCompare(p.date));if(l.length>0&&d.length>0){const f=l[0],p=d.filter(v=>v.date<f.date);p.length>0&&t.push({fundId:n,fundName:o,severity:"warning",category:"Timeline Issue",message:`${p.length} distribution(s) before first contribution (${f.date})`})}const m=new Map;for(const f of e.cashFlows){const p=f.affectsCommitment!==!1,v=`${f.date}|${f.type}|${f.amount}|${p}`;m.set(v,(m.get(v)||0)+1)}const g=Array.from(m.entries()).filter(([,f])=>f>1);if(g.length>0){const f=g.reduce((p,[,v])=>p+v-1,0);t.push({fundId:n,fundName:o,severity:"warning",category:"Duplicate Data",message:`${f} duplicate cash flow(s) detected`})}const y=s.filter(f=>f.date>i);if(y.length>0&&t.push({fundId:n,fundName:o,severity:"warning",category:"Timeline Issue",message:`${y.length} cash flow(s) dated more than ${E.HEALTH_FUTURE_DAYS_THRESHOLD} days in the future`}),e.commitment>0){const f=ts(e,"Contribution"),p=f/e.commitment;p>E.HEALTH_CONTRIBUTION_EXCEED_THRESHOLD&&t.push({fundId:n,fundName:o,severity:"warning",category:"Data Anomaly",message:`Contributions (${at(f)}) exceed commitment (${at(e.commitment)}) by ${Math.round((p-1)*100)}%`})}}if(a.length>0){const l=[...s].sort((y,f)=>y.date.localeCompare(f.date));if(l.length>0){const y=l[0].date,f=a.filter(p=>p.date<y);f.length>0&&t.push({fundId:n,fundName:o,severity:"info",category:"Timeline Issue",message:`${f.length} NAV entry(ies) before first cash flow`})}const d=a.map(y=>y.date),m=new Set(d);d.length!==m.size&&t.push({fundId:n,fundName:o,severity:"warning",category:"Duplicate Data",message:`${d.length-m.size} duplicate NAV date(s)`});const g=a.filter(y=>y.date>i);g.length>0&&t.push({fundId:n,fundName:o,severity:"warning",category:"Timeline Issue",message:`${g.length} NAV entry(ies) dated more than ${E.HEALTH_FUTURE_DAYS_THRESHOLD} days in the future`})}const c=ce(e),u=s.map(l=>l.date).concat(a.map(l=>l.date)).sort();if(u.length>=2){const l=new Date(u[0]+"T00:00:00").getTime(),m=(new Date(u[u.length-1]+"T00:00:00").getTime()-l)/E.MS_PER_DAY;m>0&&m<E.IRR_MIN_DAYS&&t.push({fundId:n,fundName:o,severity:"info",category:"Calculation Note",message:`Short holding period (${Math.round(m)} days) - IRR not calculated for periods under ${E.IRR_MIN_DAYS} days`})}if(e.monthlyNav&&e.monthlyNav.length>0&&(!e.cashFlows||e.cashFlows.length===0)&&t.push({fundId:n,fundName:o,severity:"info",category:"Incomplete Data",message:"Has NAV but no cash flows - IRR and MOIC cannot be calculated"}),e.cashFlows&&e.cashFlows.length>0){const l=e.cashFlows.some(m=>m.type==="Contribution");e.cashFlows.some(m=>m.type==="Distribution")&&!l&&t.push({fundId:n,fundName:o,severity:"warning",category:"Data Anomaly",message:"Has distributions but no contributions - MOIC cannot be calculated"})}if(e.cashFlows&&e.cashFlows.length>0&&(!e.monthlyNav||e.monthlyNav.length===0)&&c.outstandingCommitment>0&&t.push({fundId:n,fundName:o,severity:"info",category:"Incomplete Data",message:"No NAV recorded - investment return may be understated if fund holds unrealized value"}),c.irr!==null&&c.irr>5&&t.push({fundId:n,fundName:o,severity:"warning",category:"Data Anomaly",message:`Extremely high IRR (${(c.irr*100).toFixed(1)}%) - verify data accuracy`}),c.calledCapital>0&&c.nav>=0){const l=c.calledCapital+c.nav;c.distributions>l*1.5&&t.push({fundId:n,fundName:o,severity:"warning",category:"Data Anomaly",message:`Distributions (${at(c.distributions)}) significantly exceed contributions + NAV`})}if(c.nav<0&&Math.abs(c.nav)>1e3&&t.push({fundId:n,fundName:o,severity:"info",category:"Review Needed",message:`Negative NAV (${at(c.nav)}) - verify if this is expected`}),c.vintageYear!==null){const l=(e.cashFlows||[]).filter(d=>d.type==="Contribution"&&re(d.date)).sort((d,m)=>d.date.localeCompare(m.date))[0];if(l){const d=new Date(l.date+"T00:00:00").getFullYear();d!==c.vintageYear&&t.push({fundId:n,fundName:o,severity:"info",category:"Data Anomaly",message:`Calculated vintage (${d}) differs from stored value`})}}return t}function at(e){return new Intl.NumberFormat("en-US",{style:"currency",currency:"USD",minimumFractionDigits:0,maximumFractionDigits:0}).format(e)}function wo(e){switch(e){case"error":return"severity-error";case"warning":return"severity-warning";case"info":return"severity-info";default:return""}}function Io(e){switch(e){case"error":return"Error";case"warning":return"Warning";case"info":return"Info";default:return e}}function Aa(e){switch(e){case"high":return"confidence-high";case"medium":return"confidence-medium";case"low":return"confidence-low";default:return""}}function ka(e){const t=[],n=new Map;for(const o of e){if(o.id==null||o.commitment<=0)continue;const s=ft(o.fundName);n.has(s)||n.set(s,[]),n.get(s).push(o)}for(const[,o]of n){if(o.length<2)continue;const s=o.map(c=>({fund:c,metrics:ce(c)})),a=s.reduce((c,u)=>c+u.fund.commitment,0),r=s.reduce((c,u)=>c+u.metrics.calledCapital,0),i=s.reduce((c,u)=>c+u.metrics.distributions,0);if(!(r===0&&i===0))for(const{fund:c,metrics:u}of s){const l=c.commitment/a*r,d=c.commitment/a*i;if(u.calledCapital>0&&r>0){const m=Math.abs(u.calledCapital-l)/l;if(m>.1){const g=o.length-1;t.push({fundId:c.id,fundName:c.fundName,severity:"info",category:"Data Anomaly",message:`Contributions not proportional to commitment (${Math.round(m*100)}% deviation vs ${g} other investment${g>1?"s":""} in same fund)`});continue}}if(u.distributions>0&&i>0){const m=Math.abs(u.distributions-d)/d;if(m>.1){const g=o.length-1;t.push({fundId:c.id,fundName:c.fundName,severity:"info",category:"Data Anomaly",message:`Distributions not proportional to commitment (${Math.round(m*100)}% deviation vs ${g} other investment${g>1?"s":""} in same fund)`})}}}}return t}function Ma(e){const t=[],n=new Set,o=[];for(const r of e)r.id!=null&&o.push({fund:r,normalizedName:ft(r.fundName),normalizedAccount:r.accountNumber?Oa(r.accountNumber):"",vintageYear:ce(r).vintageYear});const s=new Map;for(const r of o)r.normalizedAccount&&(s.has(r.normalizedAccount)||s.set(r.normalizedAccount,[]),s.get(r.normalizedAccount).push(r));for(const[,r]of s)if(!(r.length<2))for(let i=0;i<r.length;i++)for(let c=i+1;c<r.length;c++){const u=r[i],l=r[c],d=u.fund,m=l.fund,g=`${Math.min(d.id,m.id)}-${Math.max(d.id,m.id)}`;if(n.has(g))continue;const y=La(u,l);y&&(n.add(g),t.push({fund1Id:d.id,fund1Name:d.fundName,fund2Id:m.id,fund2Name:m.fundName,reason:y.reason,confidence:y.confidence}))}const a={high:0,medium:1,low:2};return t.sort((r,i)=>a[r.confidence]-a[i.confidence]),t}function La(e,t){if(e.normalizedName===t.normalizedName)return{reason:"Identical fund name and account number",confidence:"high"};const o=_a(e.fund.fundName,t.fund.fundName);return o>=.85&&!(e.vintageYear!=null&&t.vintageYear!=null&&e.vintageYear!==t.vintageYear)?{reason:`Same account with similar fund names (${Math.round(o*100)}% match)`,confidence:"medium"}:null}const Ra={xxv:"25",xxiv:"24",xxiii:"23",xxii:"22",xxi:"21",xx:"20",xix:"19",xviii:"18",xvii:"17",xvi:"16",xv:"15",xiv:"14",xiii:"13",xii:"12",xi:"11",x:"10",ix:"9",viii:"8",vii:"7",vi:"6",v:"5",iv:"4",iii:"3",ii:"2",i:"1"},Ga=/\b(xxv|xxiv|xxiii|xxii|xxi|xx|xix|xviii|xvii|xvi|xv|xiv|xiii|xii|xi|x|ix|viii|vii|vi|v|iv|iii|ii|i)\b/gi;function $a(e){return e.replace(Ga,t=>Ra[t.toLowerCase()]||t)}function ft(e){let t=e.toLowerCase();return t=$a(t),t.replace(/[^a-z0-9]/g,"").replace(/fund/g,"").replace(/lp/g,"").replace(/llc/g,"").replace(/inc/g,"").trim()}function Oa(e){return e.toLowerCase().replace(/[^a-z0-9]/g,"").trim()}function _a(e,t){const n=ft(e),o=ft(t);if(n===o)return 1;if(n.length===0||o.length===0)return 0;const s=Pa(n,o),a=Math.max(n.length,o.length);return 1-s/a}function Pa(e,t){e.length>t.length&&([e,t]=[t,e]);const n=e.length,o=t.length;let s=new Array(n+1),a=new Array(n+1);for(let r=0;r<=n;r++)s[r]=r;for(let r=1;r<=o;r++){a[0]=r;for(let i=1;i<=n;i++){const c=e[i-1]===t[r-1]?0:1;a[i]=Math.min(s[i]+1,a[i-1]+1,s[i-1]+c)}[s,a]=[a,s]}return s[n]}const le=new Map;function Ua(){le.forEach(e=>clearTimeout(e)),le.clear()}window.addEventListener("unload",Ua);function Mn(){const e=document.getElementById("backupWarningModal");e&&e.classList.add("show")}function Tt(){const e=document.getElementById("backupWarningModal");e&&e.classList.remove("show")}function So(){me(E.STORAGE_LAST_BACKUP,new Date().toISOString())}function Ya(){const e=se(E.STORAGE_LAST_BACKUP);if(se(E.STORAGE_BACKUP_WARNING)==="true")return;if(!e){Mn();return}(Date.now()-new Date(e).getTime())/(1e3*60*60*24)>E.BACKUP_REMINDER_DAYS&&Mn()}function Va(){const e=document.getElementById("closeBackupWarningBtn"),t=document.getElementById("exportNowBtn"),n=document.getElementById("remindLaterBtn"),o=document.getElementById("dontShowBackupWarning");e&&e.addEventListener("click",Tt),t&&t.addEventListener("click",async()=>{Tt(),await ho(),So()}),n&&n.addEventListener("click",()=>{o?.checked&&me(E.STORAGE_BACKUP_WARNING,"true"),Tt()})}const Co=5*60*1e3;let Me=null;function Ha(){h.shouldShowExportReminder(Co)&&Wa()}function Wa(){h.dismissExportReminder(),S("You have unsaved changes. Consider exporting to JSON.","warning")}function ja(){Me!==null&&clearInterval(Me),Me=setInterval(()=>{try{Ha()}catch(e){console.error("Export reminder error:",e)}},Co)}function qa(){Me!==null&&(clearInterval(Me),Me=null)}function Za(){qa();for(const e of le.values())clearTimeout(e);le.clear(),ls()}window.addEventListener("beforeunload",Za);const za=60*1e3;let He=null,No=0;function Ka(){return!He||h.needsHealthCheckRefresh()?!1:Date.now()-No<za}function Yt(){const e=document.getElementById("healthCheckSummary"),t=document.getElementById("healthCheckResults");if(Ka()){ne("healthCheckModal"),Ln(He);return}e&&(e.innerHTML=""),t&&(t.innerHTML=`
      <div class="health-check-loading">
        <div class="loading-spinner"></div>
        <p>Running health checks...</p>
      </div>
    `),ne("healthCheckModal"),setTimeout(async()=>{try{const n=h.getFunds(),o=h.getGroups(),s=await Ko(),a=Da(n,o,s);He=a,No=Date.now(),h.markHealthCheckRun(),Ln(a)}catch(n){console.error("Health check error:",n);const o=document.getElementById("healthCheckResults");o&&(o.innerHTML='<p style="color: var(--color-error);">Error running health check. Please try again.</p>')}},50)}function Ln(e){const t=document.getElementById("healthCheckSummary"),n=document.getElementById("healthCheckResults");if(!t||!n)return;const o=e.duplicates.length;t.innerHTML=`
    <div class="health-check-stat">
      <div class="health-check-stat-value">${e.totalFunds}</div>
      <div class="health-check-stat-label">Total Funds</div>
    </div>
    <div class="health-check-stat">
      <div class="health-check-stat-value ${e.fundsWithIssues>0?"warning-count":"success-count"}">${e.fundsWithIssues}</div>
      <div class="health-check-stat-label">With Issues</div>
    </div>
    <div class="health-check-stat">
      <div class="health-check-stat-value ${o>0?"warning-count":"success-count"}">${o}</div>
      <div class="health-check-stat-label">Duplicates</div>
    </div>
    <div class="health-check-stat">
      <div class="health-check-stat-value error-count">${e.errorCount}</div>
      <div class="health-check-stat-label">Errors</div>
    </div>
    <div class="health-check-stat">
      <div class="health-check-stat-value warning-count">${e.warningCount}</div>
      <div class="health-check-stat-label">Warnings</div>
    </div>
    <div class="health-check-stat">
      <div class="health-check-stat-value info-count">${e.infoCount}</div>
      <div class="health-check-stat-label">Info</div>
    </div>
  `;const s=[];if(e.groupIssues.length>0){s.push('<div class="health-check-section-header">Group Issues</div>');for(const a of e.groupIssues)s.push(Qa(a))}if(e.duplicates.length>0){s.push('<div class="health-check-section-header">Potential Duplicates</div>');for(const a of e.duplicates)s.push(Ja(a))}if(e.issues.length>0){s.length>0&&s.push('<div class="health-check-section-header">Data Issues</div>');for(const a of e.issues)s.push(Xa(a))}s.length===0&&s.push(`
      <div class="health-check-empty">
        All funds and groups passed health checks!
      </div>
    `),n.innerHTML=s.join("")}function Xa(e){const n=e.severity==="warning"||e.severity==="info"?`<button class="btn-dismiss-issue btn-dismiss-fund-issue" data-fund-id="${W(String(e.fundId))}" data-category="${W(e.category)}" data-message="${W(e.message)}" title="Dismiss this issue">Dismiss</button>`:"";return`
    <div class="health-issue" data-fund-id="${W(String(e.fundId))}">
      <span class="health-issue-severity ${wo(e.severity)}">${Io(e.severity)}</span>
      <div class="health-issue-content">
        <div class="health-issue-fund">${A(e.fundName)}</div>
        <div class="health-issue-message">${A(e.message)}</div>
        <div class="health-issue-category">${A(e.category)}</div>
      </div>
      ${n}
    </div>
  `}function Ja(e){return`
    <div class="duplicate-pair">
      <span class="duplicate-confidence ${Aa(e.confidence)}">${e.confidence}</span>
      <div class="duplicate-content">
        <div class="duplicate-funds">
          <span class="duplicate-fund-link" data-fund-id="${W(String(e.fund1Id))}">${A(e.fund1Name)}</span>
          <span class="duplicate-separator">&harr;</span>
          <span class="duplicate-fund-link" data-fund-id="${W(String(e.fund2Id))}">${A(e.fund2Name)}</span>
        </div>
        <div class="duplicate-reason">${A(e.reason)}</div>
      </div>
      <button class="btn-dismiss-issue" data-fund1-id="${W(String(e.fund1Id))}" data-fund2-id="${W(String(e.fund2Id))}" data-reason="${W(e.reason)}" title="Dismiss this issue">Dismiss</button>
    </div>
  `}function Qa(e){return`
    <div class="health-issue group-issue">
      <span class="health-issue-severity ${wo(e.severity)}">${Io(e.severity)}</span>
      <div class="health-issue-content">
        <div class="health-issue-fund">Group: ${A(e.groupName)}</div>
        <div class="health-issue-message">${A(e.message)}</div>
      </div>
    </div>
  `}function er(){const e=document.getElementById("closeHealthCheckModalBtn"),t=document.getElementById("closeHealthCheckModal2Btn");e&&e.addEventListener("click",()=>O("healthCheckModal")),t&&t.addEventListener("click",()=>O("healthCheckModal"));const n=document.getElementById("healthCheckResults");n&&n.addEventListener("click",async o=>{const s=o.target,a=s.closest(".btn-dismiss-issue:not(.btn-dismiss-fund-issue)");if(a){o.stopPropagation();const u=parseInt(a.getAttribute("data-fund1-id")||"0",10),l=parseInt(a.getAttribute("data-fund2-id")||"0",10),d=a.getAttribute("data-reason")||"";if(u>0&&l>0)try{await Xo(u,l,d),He=null,h.markHealthCheckRun(),h.invalidateHealthCheck(),Yt()}catch(m){console.error("Error dismissing health issue:",m)}return}const r=s.closest(".btn-dismiss-fund-issue");if(r){o.stopPropagation();const u=parseInt(r.getAttribute("data-fund-id")||"0",10),l=r.getAttribute("data-category")||"",d=r.getAttribute("data-message")||"";if(u>0&&l&&d)try{await Jo(u,l,d),He=null,h.invalidateHealthCheck(),Yt()}catch(m){console.error("Error dismissing fund issue:",m)}return}const i=s.closest(".health-issue");if(i){const u=parseInt(i.getAttribute("data-fund-id")||"0",10);u>0&&(O("healthCheckModal"),mt(u));return}const c=s.closest(".duplicate-fund-link");if(c){const u=parseInt(c.getAttribute("data-fund-id")||"0",10);u>0&&(O("healthCheckModal"),mt(u))}})}let Vt=!1,Ht=!1;function tr(e,t){const n=Ke(se(E.STORAGE_COLUMN_WIDTHS)||"{}");n[e]=t,me(E.STORAGE_COLUMN_WIDTHS,JSON.stringify(n))}function nr(){const e=document.getElementById("fundsTable");if(!e)return;const t=Ke(se(E.STORAGE_COLUMN_WIDTHS)||"{}");e.querySelectorAll("thead th").forEach((o,s)=>{const a=t[s];a&&(o.style.width=a+"px",o.style.minWidth=a+"px",o.style.maxWidth=a+"px")})}function or(){const e=document.getElementById("fundsTable");if(!e)return;const t=e.querySelectorAll("thead th");t.forEach(n=>{if(n.querySelector(".resizer")||!n.getAttribute("data-sort"))return;const o=document.createElement("span");o.className="resizer",n.appendChild(o),n.style.position="relative",o.addEventListener("mousedown",s=>{s.preventDefault(),s.stopPropagation();const a=s.pageX,r=n.offsetWidth,i=Array.from(t).indexOf(n),c=e.querySelectorAll(`tbody tr td:nth-child(${i+1})`);Vt=!0,Ht=!0,n.classList.add("resizing"),document.body.style.cursor="col-resize",document.body.style.userSelect="none";let u=r,l=null,d=a;const m=y=>{d=y.pageX,l===null&&(l=requestAnimationFrame(()=>{const f=d-a;u=Math.max(E.MIN_COLUMN_WIDTH,r+f);const p=u+"px",v=n.style;v.width=p,v.minWidth=p,v.maxWidth=p,c.forEach(F=>{const N=F.style;N.width=p,N.minWidth=p,N.maxWidth=p}),l=null}))},g=()=>{l!==null&&(cancelAnimationFrame(l),l=null),n.classList.remove("resizing"),document.body.style.cursor="",document.body.style.userSelect="",document.removeEventListener("mousemove",m),document.removeEventListener("mouseup",g),window.removeEventListener("blur",g),u!==r&&tr(i,u),requestAnimationFrame(()=>{requestAnimationFrame(()=>{Vt=!1,Ht=!1})})};document.addEventListener("mousemove",m),document.addEventListener("mouseup",g),window.addEventListener("blur",g)})}),nr()}function Fo(e,t){let n;return function(...s){const a=async()=>{n=void 0;try{await e(...s)}catch(r){console.error("Debounced function error:",r)}};n!==void 0&&clearTimeout(n),n=setTimeout(a,t)}}function To(e){let t=null,n=null;return function(...s){n=s,t===null&&(t=requestAnimationFrame(()=>{n&&e(...n),t=null}))}}function Rn(e){const t=document.getElementById("filterLoading");t&&t.classList.toggle("show",e)}function Dt(e,t){let n=document.getElementById("tablePaginationContainer");if(!n){const o=document.querySelector(".table-container");o&&(n=document.createElement("div"),n.id="tablePaginationContainer",n.className="table-pagination",o.after(n))}if(n){if(e>=t){n.innerHTML="",n.style.display="none";return}n.style.display="flex",n.innerHTML=`
    <div class="pagination-info">
      Showing <strong>${e}</strong> of <strong>${t}</strong> investments
    </div>
    <button type="button" class="btn-secondary load-more-btn" data-action="load-more">
      Load More
    </button>
  `}}let Bt=!1,rt=null;async function Y(){if(Bt)return new Promise(e=>{rt=e});Bt=!0;try{await sr()}finally{if(Bt=!1,rt){const e=rt;rt=null,e(),Y()}}}async function sr(){const e=h.abortController?.signal,t=document.getElementById("fundsTableBody"),n=setTimeout(()=>{t&&(t.innerHTML=`
        <tr class="table-loading-row">
          <td colspan="12">
            <div class="table-loading-content">
              <div class="table-loading-spinner"></div>
              <div class="table-loading-text">Loading investments...</div>
            </div>
          </td>
        </tr>
      `)},E.TABLE_LOADING_DELAY);try{const o=await q();h.setFunds(o);const a=document.getElementById("cutoffDate")?.value||"",r=a?new Date(a+"T00:00:00"):void 0,i=ao(),c=h.getFilteredFundsFromCache(i,a);let u;if(c){const v=new Map(o.map(F=>[F.id,F]));u=c.map(F=>v.get(F)).filter(F=>F!==void 0)}else{u=vt(o);const v=u.map(F=>F.id).filter(F=>F!==void 0);h.setFilteredFundsCache(i,a,v)}if(h.sortColumns.length>0&&(u=to(u,h.sortColumns,r)),Ts(o),Cs(),e?.aborted){clearTimeout(n);return}let l;if(u.length>=E.WORKER_THRESHOLD&&us())try{const v=await cs(u,r);if(e?.aborted){clearTimeout(n);return}const F=new Map(v.map(N=>[N.fundId,N.metrics]));l=u.map(N=>({...N,metrics:F.get(N.id)||ce(N,r)}))}catch(v){console.warn("Worker calculation failed, falling back to sync:",v),l=u.map(F=>({...F,metrics:ce(F,r)}))}else l=u.map(v=>({...v,metrics:ce(v,r)}));if(fs(l,r),clearTimeout(n),!t)return;if(t.innerHTML="",l.length===0){const v=ws(),F=o.length>0;let N;v&&F?N=`
          <tr>
            <td colspan="12" class="empty-state">
              <div style="padding: 40px;">
                <h3 style="margin-bottom: 10px;">No matching investments</h3>
                <p style="margin-bottom: 15px;">No investments match your current filters.</p>
                <button type="button" class="btn-secondary" data-action="clear-filters">Clear All Filters</button>
              </div>
            </td>
          </tr>
        `:N=`
          <tr>
            <td colspan="12" class="empty-state">
              <div style="padding: 40px;">
                <h3 style="margin-bottom: 10px;">No investments yet</h3>
                <p style="margin-bottom: 15px;">Add your first investment to start tracking your portfolio.</p>
                <button type="button" class="btn-primary" data-action="add-first-investment">Add Investment</button>
              </div>
            </td>
          </tr>
        `,t.innerHTML=N;return}const d=document.getElementById("sidebarShowTagsCheckbox")?.checked??!0,m=se(E.STORAGE_GROUP_BY_FUND)==="true",g=se(E.STORAGE_GROUP_BY_GROUP)==="true",y=no(l,r),f=l.length,p=h.displayLimit;if(g){const v=se(E.STORAGE_EXPANDED_GROUPS)||"[]",F=Ke(v),N=new Set(Array.isArray(F)?F:[]),D=l.map(R=>R.id).filter(R=>R!==void 0),b=h.getGroupTreeFromCache(D,N);let w;b?w=b:(w=hs(l,r,N),h.setGroupTreeCache(D,N,w));const C=ys(w),L=document.createDocumentFragment();C.forEach((R,J)=>{const Q=document.createElement("tr");Q.classList.add("grouped-group-row"),Q.classList.add(`depth-${Math.min(R.depth,2)}`),R.groupId===null&&Q.classList.add("no-group"),Q.setAttribute("tabindex","0"),Q.setAttribute("role","row"),Q.setAttribute("aria-rowindex",(J+2).toString()),R.groupId!==null&&Q.setAttribute("data-group-id",R.groupId.toString()),Q.innerHTML=vs(R,J),L.appendChild(Q)});const x=document.createElement("tr");x.innerHTML=Ft(y),L.appendChild(x),t.appendChild(L),Dt(C.length,C.length)}else if(m){const v=oo(l,r,h.sortColumns),F=v.slice(0,p),N=document.createDocumentFragment();F.forEach((b,w)=>{const C=document.createElement("tr");C.classList.add("grouped-fund-row"),C.setAttribute("tabindex","0"),C.setAttribute("role","row"),C.setAttribute("aria-rowindex",(w+2).toString()),C.innerHTML=gs(b,w,d),N.appendChild(C)});const D=document.createElement("tr");D.innerHTML=Ft(y),N.appendChild(D),t.appendChild(N),Dt(F.length,v.length)}else{const v=l.slice(0,p),F=document.createDocumentFragment();v.forEach((D,b)=>{const w=document.createElement("tr");w.setAttribute("tabindex","0"),w.setAttribute("data-fund-id",D.id?.toString()||""),w.setAttribute("role","row"),w.setAttribute("aria-rowindex",(b+2).toString()),w.innerHTML=ms(D,b,d),F.appendChild(w)});const N=document.createElement("tr");N.innerHTML=Ft(y),F.appendChild(N),t.appendChild(F),Dt(v.length,f)}}catch(o){clearTimeout(n),console.error("Error rendering table:",o),S("Error loading data: "+o.message,"error")}}async function ut(){h.abortController&&h.abortController.abort(),h.resetDisplayLimit(),h.setAbortController(new AbortController);const e=h.abortController.signal;Rn(!0);try{if(e.aborted||(ar(),e.aborted))return;await Y();const t=document.getElementById("summaryInvestmentCount")?.textContent||"0";Ut(`Filter applied. Showing ${t} investments.`)}catch(t){if(t.name==="AbortError")return;console.error("Error applying filters:",t),S("Error applying filters: "+t.message,"error")}finally{Rn(!1),h.abortController&&!h.abortController.signal.aborted&&h.setAbortController(null)}}const dt=Fo(ut,E.DEBOUNCE_FILTER),Gn=Fo(fo,E.DEBOUNCE_INPUT);function ar(){const e=V("groupFilter"),t=document.getElementById("headerTitle"),n=document.getElementById("headerSubtitle");if(!(!t||!n))if(e.length===1&&e[0]){const o=parseInt(e[0],10),s=h.getGroupByIdSync(o);if(s)if(t.textContent=s.name,s.parentGroupId){const a=h.getGroupByIdSync(s.parentGroupId);n.textContent=a?.name||s.type||"Account Group"}else n.textContent=""}else if(e.length>1){const o=e.map(a=>h.getGroupByIdSync(parseInt(a,10))),s=new Set(o.map(a=>a?.parentGroupId).filter(a=>a!=null));if(s.size===1){const a=Array.from(s)[0],r=h.getGroupByIdSync(a);r?(t.textContent=r.name,n.textContent="Multiple Groups Selected"):(t.textContent="PE Fund Manager",n.textContent="Multiple Groups Selected")}else t.textContent="PE Fund Manager",n.textContent="Multiple Groups Selected"}else t.textContent="PE Fund Manager",n.textContent="Private Equity Fund Analytics & Management Tool"}async function rr(e){const t=e.target;if(Ht||Vt||t.closest(".resizer"))return;const n=t.closest("th[data-sort]");if(!n)return;const o=n.dataset.sort;if(!o)return;if(e.shiftKey){const a=h.sortColumns.findIndex(r=>r.column===o);if(a!==-1)if(h.sortColumns[a].direction==="asc"){const i=[...h.sortColumns];i[a]={column:o,direction:"desc"},h.setSortColumns(i)}else{const i=h.sortColumns.filter((c,u)=>u!==a);h.setSortColumns(i)}else h.setSortColumns([...h.sortColumns,{column:o,direction:"asc"}])}else{const a=h.sortColumns.find(r=>r.column===o);a?a.direction==="asc"?h.setSortColumns([{column:o,direction:"desc"}]):h.setSortColumns([]):h.setSortColumns([{column:o,direction:"asc"}])}if(ps(h.sortColumns),h.sortColumns.length>0){const a=h.sortColumns.map(r=>`${r.column} ${r.direction==="asc"?"ascending":"descending"}`).join(", then ");Ut(`Table sorted by ${a}`)}else Ut("Table sort cleared");await Y()}async function ir(e){const n=e.target.closest(".btn-expand");if(!n)return;e.stopPropagation(),e.preventDefault();const o=n.dataset.groupId;if(!o)return;const s=window.scrollY||document.documentElement.scrollTop,a=se(E.STORAGE_EXPANDED_GROUPS)||"[]",r=Ke(a);let i=Array.isArray(r)?r:[];const c=sa(o,0),u=i.findIndex(l=>l===c||l===o);u>=0?i.splice(u,1):i.push(c),me(E.STORAGE_EXPANDED_GROUPS,JSON.stringify(i)),await Y(),window.scrollTo(0,s)}function cr(e){const t=e.target;if(t.closest(".btn-expand")){ir(e);return}const o=t.closest(".table-action-btn");if(!o)return;e.stopPropagation();const s=o.dataset.action;if(s==="edit-fund"){const a=o.dataset.fundName;a&&go(a);return}if(s==="edit-group"){const a=o.dataset.groupId;a&&(Et(),setTimeout(()=>{try{const r=h.getGroupByIdSync(parseInt(a,10));if(r){const i=document.getElementById("editGroupId"),c=document.getElementById("newGroupName"),u=document.getElementById("saveGroupBtn"),l=document.getElementById("cancelEditBtn"),d=document.getElementById("groupFormTitle");if(i&&c&&u&&l&&d){i.value=a,c.value=r.name,u.textContent="Save Changes",l.classList.remove("hidden"),d.textContent="Edit Group";const m=document.getElementById("newGroupParent");m&&r.parentGroupId&&(m.value=r.parentGroupId.toString());const g=document.getElementById("newGroupType");g&&r.type&&(g.value=r.type)}}}catch(r){console.error("Error pre-selecting group for edit:",r)}},100));return}if(s==="menu"){const a=parseInt(o.dataset.fundId||"0",10);if(!a)return;Vs(a);const r=document.getElementById("actionDropdown");if(!r)return;const i=o.getBoundingClientRect();r.style.visibility="hidden",r.classList.add("show");const c=r.offsetWidth||160,u=r.offsetHeight||200;r.classList.remove("show"),r.style.visibility="";let l=i.bottom+2,d=i.left-(c-i.width);l+u>window.innerHeight&&(l=i.top-u-2),d<8&&(d=8),d+c>window.innerWidth-8&&(d=window.innerWidth-c-8),r.style.position="fixed",r.style.top=`${l}px`,r.style.left=`${d}px`,r.classList.add("show")}}function lr(){const e=document.getElementById("sidebar"),t=document.getElementById("sidebarOverlay");e&&e.classList.add("show"),t&&t.classList.add("show")}function X(){const e=document.getElementById("sidebar"),t=document.getElementById("sidebarOverlay");e&&e.classList.remove("show"),t&&t.classList.remove("show")}function ur(){const e=document.getElementById("sidebarDarkModeCheckbox");if(!e)return;const t=se(E.STORAGE_THEME),n=window.matchMedia("(prefers-color-scheme: dark)").matches,o=t?t==="dark":n;document.documentElement.setAttribute("data-theme",o?"dark":"light"),e.checked=o,e.addEventListener("change",()=>{const s=e.checked?"dark":"light";document.documentElement.setAttribute("data-theme",s),me(E.STORAGE_THEME,s)})}function dr(){const e=new Date,t=e.getFullYear(),n=[new Date(t,2,31),new Date(t,5,30),new Date(t,8,30),new Date(t,11,31)];for(let o=n.length-1;o>=0;o--)if(n[o]<=e)return n[o];return new Date(t-1,11,31)}function mr(){const e=document.getElementById("cutoffDate");if(!e)return;const t=dr(),n=t.getFullYear(),o=String(t.getMonth()+1).padStart(2,"0"),s=String(t.getDate()).padStart(2,"0");e.value=`${n}-${o}-${s}`}function Do(e=!1){document.querySelectorAll(".multi-select.open").forEach(t=>{t.classList.remove("open"),t.querySelector(".multi-select-trigger")?.setAttribute("aria-expanded","false"),Mt(t),e&&Ye(t);const n=t.id;if(n){const o=le.get(n);o&&(clearTimeout(o),le.delete(n))}})}function fr(){document.querySelectorAll(".multi-select").forEach(t=>{if(t.dataset.initialized==="true")return;t.dataset.initialized="true";const n=t.querySelector(".multi-select-trigger"),o=t.querySelector(".multi-select-dropdown");if(!n||!o)return;n.setAttribute("aria-expanded","false"),n.addEventListener("click",a=>{a.stopPropagation();const r=t.classList.contains("open");Do(),r||(t.classList.add("open"),n.setAttribute("aria-expanded","true"),setTimeout(()=>{const i=o.querySelector(".multi-select-search input");i&&i.focus()},0))}),n.addEventListener("keydown",a=>{const r=a;r.key==="Enter"||r.key===" "?(r.preventDefault(),n.click()):r.key==="Escape"&&(t.classList.remove("open"),n.setAttribute("aria-expanded","false"),Mt(t))}),o.addEventListener("input",a=>{const r=a.target;if(r.matches(".multi-select-search input")){const i=t.id||"unknown",c=le.get(i);c&&clearTimeout(c);const u=r.value,l=setTimeout(()=>{Zt(t,u),Ye(t),zt(t),le.delete(i)},150);le.set(i,l)}}),o.addEventListener("keydown",a=>{const r=a;if(r.key==="Escape"){t.classList.remove("open"),n.setAttribute("aria-expanded","false"),Mt(t),Ye(t),n.focus();return}if(r.key==="ArrowDown"||r.key==="ArrowUp"){r.preventDefault(),yr(t,r.key==="ArrowDown"?1:-1);return}if(r.key==="Enter"){r.preventDefault();const i=t.querySelector(".multi-select-option.highlighted");i&&!i.classList.contains("search-hidden")&&_n(t,i,dt);return}}),o.addEventListener("click",a=>{const r=a.target;if(r.closest(".multi-select-search")){a.stopPropagation();return}const i=r.closest(".multi-select-option");if(i){if(a.stopPropagation(),i.classList.contains("multi-select-all-option")){if(Is(t),t.id==="groupFilter"){const c=t.querySelectorAll(".multi-select-option.selected:not(.multi-select-all-option)"),u=Array.from(c).map(l=>parseInt(l.getAttribute("data-value")||"0",10)).filter(l=>l>0);u.length>0&&Fs(t,u,!0)}dt();return}_n(t,i,dt)}});const s=To(a=>{const r=a.closest(".multi-select-option");r&&!r.classList.contains("search-hidden")&&(Ye(t),r.classList.add("highlighted"))});o.addEventListener("mouseover",a=>{s(a.target)})})}function pr(){document.querySelectorAll(".searchable-select").forEach(t=>{if(t.dataset.initialized==="true")return;t.dataset.initialized="true";const n=t.querySelector(".searchable-select-trigger"),o=t.querySelector(".searchable-select-dropdown"),s=t.querySelector('input[type="hidden"]');if(!n||!o||!s)return;n.addEventListener("click",r=>{r.stopPropagation();const i=t.classList.contains("open");document.querySelectorAll(".searchable-select.open").forEach(c=>{c.classList.remove("open"),c.querySelector(".searchable-select-trigger")?.setAttribute("aria-expanded","false");const u=c.querySelector(".searchable-select-search input");u&&(u.value=""),pt(c,"")}),i||(t.classList.add("open"),n.setAttribute("aria-expanded","true"),setTimeout(()=>{const c=o.querySelector(".searchable-select-search input");c&&c.focus()},0))}),n.addEventListener("keydown",r=>{const i=r;i.key==="Enter"||i.key===" "?(i.preventDefault(),n.click()):i.key==="Escape"&&(t.classList.remove("open"),n.setAttribute("aria-expanded","false"))}),o.addEventListener("input",r=>{const i=r.target;if(i.matches(".searchable-select-search input")){const c=t.id||"searchable-unknown",u=le.get(c);u&&clearTimeout(u);const l=i.value,d=setTimeout(()=>{pt(t,l),Ue(t),le.delete(c)},150);le.set(c,d)}}),o.addEventListener("keydown",r=>{const i=r;if(i.key==="Escape"){t.classList.remove("open"),n.setAttribute("aria-expanded","false"),Ue(t),n.focus();return}if(i.key==="ArrowDown"||i.key==="ArrowUp"){i.preventDefault(),hr(t,i.key==="ArrowDown"?1:-1);return}if(i.key==="Enter"){i.preventDefault();const c=t.querySelector(".searchable-select-option.highlighted");c&&!c.classList.contains("search-hidden")&&On(t,c,s,n);return}}),o.addEventListener("click",r=>{const i=r.target;if(i.closest(".searchable-select-search")){r.stopPropagation();return}const c=i.closest(".searchable-select-option");c&&(r.stopPropagation(),On(t,c,s,n))});const a=To(r=>{const i=r.closest(".searchable-select-option");i&&!i.classList.contains("search-hidden")&&(Ue(t),i.classList.add("highlighted"))});o.addEventListener("mouseover",r=>{a(r.target)})})}let $n=!1;function gr(){$n||($n=!0,document.addEventListener("click",e=>{const t=e.target;t.closest(".multi-select")||Do(!0),t.closest(".searchable-select")||document.querySelectorAll(".searchable-select.open").forEach(o=>{o.classList.remove("open"),o.querySelector(".searchable-select-trigger")?.setAttribute("aria-expanded","false");const s=o.querySelector(".searchable-select-search input");s&&(s.value=""),pt(o,"")});const n=document.getElementById("actionDropdown");n&&!t.closest("#actionDropdown")&&!t.closest(".fund-actions-btn")&&n.classList.remove("show")}))}function pt(e,t){const n=e.querySelector(".searchable-select-options"),o=e.querySelector(".searchable-select-no-results");if(!n)return;const s=n.querySelectorAll(".searchable-select-option"),a=t.toLowerCase().trim();let r=0;s.forEach(i=>{const c=i.textContent?.toLowerCase()||"";a===""||c.includes(a)?(i.classList.remove("search-hidden"),r++):i.classList.add("search-hidden")}),o&&o.classList.toggle("visible",r===0&&a!=="")}function Ue(e){e.querySelectorAll(".searchable-select-option.highlighted").forEach(t=>{t.classList.remove("highlighted")})}function hr(e,t){const n=Array.from(e.querySelectorAll(".searchable-select-option:not(.search-hidden)"));if(n.length===0)return;const o=e.querySelector(".searchable-select-option.highlighted");let s=o?n.indexOf(o):-1;Ue(e);let a=s+t;a<0&&(a=n.length-1),a>=n.length&&(a=0);const r=n[a];r&&(r.classList.add("highlighted"),r.scrollIntoView({block:"nearest"}))}function On(e,t,n,o){const s=t.dataset.value||"";n.value=s,n.dispatchEvent(new Event("change",{bubbles:!0}));const a=e.querySelector(".searchable-select-display");a&&(a.textContent=t.textContent?.trim()||e.getAttribute("data-placeholder")||"Select..."),e.querySelectorAll(".searchable-select-option").forEach(i=>{i.classList.remove("selected")}),t.classList.add("selected"),e.classList.remove("open"),o.setAttribute("aria-expanded","false");const r=e.querySelector(".searchable-select-search input");r&&(r.value=""),pt(e,""),Ue(e)}function Ye(e){e.querySelectorAll(".multi-select-option.highlighted").forEach(t=>{t.classList.remove("highlighted")})}function yr(e,t){const n=Array.from(e.querySelectorAll(".multi-select-option:not(.search-hidden)"));if(n.length===0)return;const o=e.querySelector(".multi-select-option.highlighted");let s=o?n.indexOf(o):-1;Ye(e);let a=s+t;a<0&&(a=n.length-1),a>=n.length&&(a=0);const r=n[a];r&&(r.classList.add("highlighted"),r.scrollIntoView({block:"nearest"}))}function _n(e,t,n){t.classList.toggle("selected");const o=t.querySelector('input[type="checkbox"]');if(o&&(o.checked=t.classList.contains("selected")),t.setAttribute("aria-selected",t.classList.contains("selected").toString()),e.id==="groupFilter"){const s=parseInt(t.getAttribute("data-value")||"0",10),a=t.classList.contains("selected");Ns(e,s,a)}zt(e),ht(e.id),n()}let Pn=!1;function vr(){if(Pn)return;Pn=!0;const e=document.querySelector("#fundsTable thead");e&&e.addEventListener("click",rr);const t=document.getElementById("fundsTableBody");t&&(t.addEventListener("click",cr),t.addEventListener("keydown",async I=>{const T=I;if(T.key!=="Enter"&&T.key!==" ")return;const M=T.target,H=M.closest("tr");if(!H||M.tagName==="BUTTON")return;T.preventDefault();const U=H.dataset.fundId;if(U)try{await mt(parseInt(U,10),ut)}catch(ae){console.error("Error opening fund details:",ae)}})),document.addEventListener("click",async I=>{const M=I.target.dataset.action;if(M)try{M==="load-more"?(h.loadMore(),await Y()):M==="clear-filters"?(Lt(),await ut()):M==="add-first-investment"&&lt()}catch(H){console.error("Error handling action:",M,H),S("An error occurred","error")}});const n=document.getElementById("actionEdit"),o=document.getElementById("actionDuplicate"),s=document.getElementById("actionViewDetails"),a=document.getElementById("actionDelete");n&&n.addEventListener("click",I=>{I.preventDefault();const T=st();T&&Gs(T),document.getElementById("actionDropdown")?.classList.remove("show")}),o&&o.addEventListener("click",I=>{I.preventDefault();const T=st();T&&$s(T),document.getElementById("actionDropdown")?.classList.remove("show")}),s&&s.addEventListener("click",I=>{I.preventDefault();const T=st();T&&mt(T),document.getElementById("actionDropdown")?.classList.remove("show")}),a&&a.addEventListener("click",async I=>{I.preventDefault();try{const T=st();T&&await _s(T,Y)}catch(T){console.error("Error deleting fund:",T),S("Error deleting fund","error")}document.getElementById("actionDropdown")?.classList.remove("show")});const r=document.getElementById("fundForm");r&&r.addEventListener("submit",async I=>{I.preventDefault();try{await Os(Y)}catch(T){console.error("Error saving fund:",T),S("Error saving fund","error")}});const i=document.getElementById("closeFundModalBtn"),c=document.getElementById("cancelFundModalBtn");[i,c].forEach(I=>{I&&I.addEventListener("click",()=>As())});const u=document.getElementById("fundName");u&&u.addEventListener("change",I=>{const T=I.target.value,M=document.getElementById("newFundNameContainer");T==="__new__"&&M?(M.classList.remove("hidden"),document.getElementById("newFundNameInline")?.focus()):M&&M.classList.add("hidden")});const l=document.getElementById("addCashFlowRowBtn"),d=document.getElementById("addNavRowBtn"),m=document.getElementById("saveDetailsChangesBtn"),g=document.getElementById("cancelDetailsModalBtn"),y=document.getElementById("closeDetailsModalBtn");l&&l.addEventListener("click",Ps),d&&d.addEventListener("click",Us),m&&m.addEventListener("click",()=>Ys(Y)),[g,y].forEach(I=>{I&&I.addEventListener("click",async()=>{try{if(h.hasUnsavedChanges&&!await Ee("You have unsaved changes. Discard them?",{title:"Unsaved Changes",confirmText:"Discard",cancelText:"Keep Editing"}))return;h.setUnsavedChanges(!1),O("detailsModal")}catch(T){console.error("Error closing details modal:",T)}})});const f=document.getElementById("cashFlowsTable"),p=document.getElementById("navTable");[f,p].forEach(I=>{if(I){if(I._detailsListenersInitialized)return;I._detailsListenersInitialized=!0,I.addEventListener("click",T=>{const H=T.target.closest(".delete-row-btn");if(H){const U=H.closest("tr");U&&(U.remove(),h.setUnsavedChanges(!0),fo())}}),I.addEventListener("input",()=>{h.setUnsavedChanges(!0),Gn()}),I.addEventListener("change",()=>{h.setUnsavedChanges(!0),Gn()})}});const v=document.getElementById("sidebarManageFunds");v&&v.addEventListener("click",I=>{I.preventDefault(),X(),ze()});const F=document.getElementById("closeManageFundsModalBtn"),N=document.getElementById("closeManageFundsModal2Btn");[F,N].forEach(I=>{I&&I.addEventListener("click",()=>O("manageFundNamesModal"))});const D=document.getElementById("addNewFundNameModalBtn");D&&D.addEventListener("click",()=>ea(Y));const b=document.getElementById("fundNamesList");b&&b.addEventListener("click",async I=>{const M=I.target.closest("button");if(!M)return;const H=M.dataset.action,U=M.dataset.name;try{H==="editFundName"&&U?go(U):H==="deleteFundName"&&U&&await Qs(U,Y)}catch(ae){console.error("Error handling fund name action:",ae),S("Error processing request","error")}});const w=document.getElementById("closeEditFundNameModalBtn"),C=document.getElementById("cancelEditFundNameBtn");[w,C].forEach(I=>{I&&I.addEventListener("click",()=>{po(),O("editFundNameModal")})});const L=document.getElementById("saveEditedFundNameBtn");L&&L.addEventListener("click",()=>Js(Y));const x=document.getElementById("editFundTagsInput");x&&x.addEventListener("keydown",I=>{if(I.key==="Enter"){I.preventDefault();const T=x.value.trim();T&&(Ks(T),x.value="")}});const R=document.getElementById("editFundTagsContainer");R&&R.addEventListener("click",I=>{const T=I.target;if(T.classList.contains("tag-remove")){const M=parseInt(T.dataset.index||"0",10);Xs(M)}});const J=document.getElementById("addNewFundNameBtn");J&&J.addEventListener("click",ta);const Q=document.getElementById("cancelNewFundNameBtn");Q&&Q.addEventListener("click",na);const ve=document.getElementById("sidebarManageGroups");ve&&ve.addEventListener("click",I=>{I.preventDefault(),X(),Et()});const Le=document.getElementById("closeManageGroupsModalBtn"),Jt=document.getElementById("closeManageGroupsModal2Btn");[Le,Jt].forEach(I=>{I&&I.addEventListener("click",()=>O("manageGroupsModal"))});const Xe=document.getElementById("saveGroupBtn");Xe&&Xe.addEventListener("click",()=>Hs(Y));const Je=document.getElementById("groupsList");Je&&Je.addEventListener("click",async I=>{const M=I.target.closest("button");if(!M)return;const H=M.dataset.action,U=parseInt(M.dataset.id||"0",10);try{if(H==="editGroup"&&!isNaN(U)){const ae=h.getGroupByIdSync(U);if(ae){const tt=document.getElementById("editGroupId"),nt=document.getElementById("newGroupName"),yn=document.getElementById("newGroupType"),vn=document.getElementById("saveGroupBtn"),bn=document.getElementById("cancelEditBtn"),En=document.getElementById("groupFormTitle");tt&&(tt.value=U.toString()),nt&&(nt.value=ae.name),yn&&(yn.value=ae.type||""),vn&&(vn.textContent="Update Group"),bn&&bn.classList.remove("hidden"),En&&(En.textContent="Edit Group"),Ne("newGroupParent",U),bt("newGroupParent",ae.parentGroupId?.toString()||"")}}else H==="deleteGroup"&&!isNaN(U)&&await Ws(U,Y)}catch(ae){console.error("Error handling group action:",ae),S("Error processing request","error")}});const we=document.getElementById("cancelEditBtn");we&&we.addEventListener("click",()=>{const I=document.getElementById("editGroupId"),T=document.getElementById("newGroupName"),M=document.getElementById("newGroupType"),H=document.getElementById("saveGroupBtn"),U=document.getElementById("groupFormTitle");I&&(I.value=""),T&&(T.value=""),M&&(M.value=""),H&&(H.textContent="Add Group"),U&&(U.textContent="Add New Group"),we.classList.add("hidden"),Ne("newGroupParent")});const wt=document.getElementById("toggleSidebarBtn"),Qe=document.getElementById("closeSidebarBtn"),et=document.getElementById("sidebarOverlay");wt&&wt.addEventListener("click",lr),Qe&&Qe.addEventListener("click",X),et&&et.addEventListener("click",X);const B=document.getElementById("sidebarNewInvestment");B&&B.addEventListener("click",I=>{I.preventDefault(),X(),lt()});const $=document.getElementById("sidebarShowTagsCheckbox");if($){$.addEventListener("change",async()=>{try{const T=$.checked;me(E.STORAGE_SHOW_TAGS,T.toString()),await Y()}catch(T){console.error("Error toggling tags display:",T),S("Error updating display","error")}});const I=se(E.STORAGE_SHOW_TAGS);I!==null&&($.checked=I==="true")}const _=document.getElementById("groupByFundToggle");_&&(se(E.STORAGE_GROUP_BY_FUND)==="true"&&_.classList.add("active"),_.addEventListener("click",async()=>{try{const M=!(se(E.STORAGE_GROUP_BY_FUND)==="true");if(_.classList.toggle("active",M),me(E.STORAGE_GROUP_BY_FUND,M.toString()),M){me(E.STORAGE_GROUP_BY_GROUP,"false");const H=document.getElementById("sidebarGroupByGroupCheckbox");H&&(H.checked=!1)}await Y()}catch(T){console.error("Error toggling group by fund:",T),S("Error updating display","error")}}));const oe=document.getElementById("sidebarMaskAccountsCheckbox");if(oe){oe.addEventListener("change",()=>{const T=oe.checked;me(E.STORAGE_MASK_ACCOUNTS,T.toString()),document.documentElement.setAttribute("data-mask-accounts",T.toString())});const I=se(E.STORAGE_MASK_ACCOUNTS);if(I!==null){const T=I==="true";oe.checked=T,document.documentElement.setAttribute("data-mask-accounts",T.toString())}}const ue=document.getElementById("sidebarGroupByGroupCheckbox");if(ue){ue.addEventListener("change",async()=>{try{const T=ue.checked;if(me(E.STORAGE_GROUP_BY_GROUP,T.toString()),T){me(E.STORAGE_GROUP_BY_FUND,"false");const M=document.getElementById("groupByFundToggle");M&&M.classList.remove("active")}await Y()}catch(T){console.error("Error toggling group by group:",T),S("Error updating display","error")}});const I=se(E.STORAGE_GROUP_BY_GROUP);I!==null&&(ue.checked=I==="true")}const Ie=document.getElementById("sidebarClearDatabase");Ie&&Ie.addEventListener("click",async I=>{if(I.preventDefault(),X(),await Ee("Are you sure you want to clear ALL data? This action cannot be undone!",{title:"Clear Database",confirmText:"Clear All Data",cancelText:"Cancel"}))try{K("Clearing database..."),await Zo(),h.clearMetricsCache(),h.setFunds([]),h.setGroups([]),S("Database cleared successfully"),await Y()}catch(M){console.error("Error clearing database:",M),S("Error clearing database: "+M.message,"error")}finally{j()}});const de=document.getElementById("sidebarExportCSV");de&&de.addEventListener("click",async I=>{I.preventDefault(),X();try{await aa()}catch(T){console.error("Error exporting CSV:",T),S("Error exporting CSV","error")}});const Qt=document.getElementById("sidebarExportJSON");Qt&&Qt.addEventListener("click",async I=>{I.preventDefault(),X();try{await ho(),So()}catch(T){console.error("Error exporting JSON:",T),S("Error exporting data","error")}});const en=document.getElementById("sidebarExportPDF");en&&en.addEventListener("click",I=>{I.preventDefault(),X(),ra()});const tn=document.getElementById("sidebarImportJSON");tn&&tn.addEventListener("click",I=>{I.preventDefault(),X(),ca()});const nn=document.getElementById("sidebarLoadSampleData");nn&&nn.addEventListener("click",async I=>{I.preventDefault(),X(),await Ee("This will add sample data to your database. Existing data will not be deleted. Continue?",{title:"Load Sample Data",confirmText:"Load Data",cancelText:"Cancel"})&&await da(Y)});const on=document.getElementById("sidebarHealthCheck");on&&on.addEventListener("click",I=>{I.preventDefault(),X(),Yt()});const sn=document.getElementById("sidebarSyncAccountGroups");sn&&sn.addEventListener("click",I=>{I.preventDefault(),X(),qs()});const an=document.getElementById("sidebarBulkCashFlow");an&&an.addEventListener("click",I=>{I.preventDefault(),X(),pa()});const rn=document.getElementById("sidebarBulkAssignGroup");rn&&rn.addEventListener("click",I=>{I.preventDefault(),X(),Ea()});const cn=document.getElementById("sidebarBulkRemoveFund");cn&&cn.addEventListener("click",I=>{I.preventDefault(),X(),ya()}),Sa(Y);const ln=document.getElementById("importPreviewFileInput");ln&&ln.addEventListener("change",la);const un=document.getElementById("applyImportBtn");un&&un.addEventListener("click",()=>ua(Y));const Bo=document.getElementById("closeImportPreviewModalBtn"),xo=document.getElementById("cancelImportPreviewBtn");[Bo,xo].forEach(I=>{I&&I.addEventListener("click",()=>O("importPreviewModal"))});const Ao=document.getElementById("closeSyncAccountGroupsModalBtn"),ko=document.getElementById("cancelSyncAccountGroupsBtn");[Ao,ko].forEach(I=>{I&&I.addEventListener("click",()=>{_t(),O("syncAccountGroupsModal")})});const dn=document.getElementById("applySyncAccountGroupsBtn");dn&&dn.addEventListener("click",()=>Zs(Y));const mn=document.getElementById("cutoffDate");mn&&mn.addEventListener("change",dt);const fn=document.getElementById("activeFiltersIndicator");fn&&fn.addEventListener("click",I=>{I.target.classList.contains("clear-filters")&&(Lt(),ut())});const pn=document.getElementById("timelineHeader"),gn=document.getElementById("timelinePanel");pn&&gn&&pn.addEventListener("click",()=>{gn.classList.toggle("expanded")&&Fa()});const hn=document.getElementById("timelineExportCSV");hn&&hn.addEventListener("click",I=>{I.stopPropagation(),I.preventDefault(),Ta()});const It=document.getElementById("timelineTableContainer");It&&It.addEventListener("click",I=>{const M=I.target.closest(".timeline-expand-row");if(!M)return;const H=M.dataset.type,U=M.classList.toggle("expanded"),ae=M.querySelector(".timeline-expand-icon");ae&&(ae.textContent=U?"▼":"▶");const tt=CSS.escape(H||"");It.querySelectorAll(`.timeline-fund-row[data-type="${tt}"]`).forEach(nt=>{nt.classList.toggle("visible",U)})}),document.addEventListener("keydown",I=>{const T=I.target;T.tagName==="INPUT"||T.tagName==="TEXTAREA"||T.tagName==="SELECT"||(I.ctrlKey&&I.key==="n"?(I.preventDefault(),lt()):I.key==="?"&&!I.ctrlKey&&!I.metaKey?ne("shortcutsModal"):I.key==="Escape"&&(X(),document.querySelectorAll(".modal.show").forEach(M=>{O(M.id)})))});const Mo=document.getElementById("closeShortcutsModalBtn"),Lo=document.getElementById("closeShortcutsModal2Btn");[Mo,Lo].forEach(I=>{I&&I.addEventListener("click",()=>O("shortcutsModal"))})}async function Un(){try{K("Initializing..."),await Wo(),Jn()&&is().catch(s=>{console.warn("Failed to initialize metrics worker, will use sync calculations:",s)});const e=await q();h.setFunds(e);const t=await he();h.setGroups(t);const n=await We(),o=new Map;n.forEach(s=>o.set(s.name,s)),h.setFundNameData(o),h.setFundNames(new Set(n.map(s=>s.name))),ur(),mr(),fr(),pr(),gr(),vr(),Va(),er(),or(),Ls(),xs(),await Y(),j(),setTimeout(()=>{Ya()},1e3),ja()}catch(e){console.error("Error initializing application:",e),j(),S("Error initializing application: "+e.message,"error")}}window.showAddFundModal=lt;window.showManageFundsModal=ze;window.resetFilters=Lt;document.readyState==="loading"?document.addEventListener("DOMContentLoaded",Un):Un();</script>
  <style rel="stylesheet" crossorigin>:root{--color-primary: #2C3E50;--color-primary-light: #34495E;--color-background: #ECF0F1;--color-white: #ffffff;--color-action: #3498DB;--color-action-hover: #2980B9;--color-success: #27AE60;--color-success-hover: #229954;--color-danger: #E74C3C;--color-danger-hover: #C0392B;--color-warning: #F39C12;--color-warning-bg: #FEF9E7;--color-secondary: #95A5A6;--color-secondary-hover: #7F8C8D;--color-text: #2C3E50;--color-text-light: #95A5A6;--color-muted: #95A5A6;--color-border: #E0E0E0;--color-border-input: #BDC3C7;--color-hover-bg: #F8F9FA;--color-alt-bg: #FAFAFA;--spacing-xs: 4px;--spacing-sm: 8px;--spacing-md: 12px;--spacing-lg: 20px;--spacing-xl: 30px;--radius-sm: 3px;--radius-md: 4px;--shadow-sm: 0 1px 3px rgba(0, 0, 0, .1);--shadow-md: 0 2px 8px rgba(0, 0, 0, .15);--shadow-lg: 0 4px 12px rgba(0, 0, 0, .15);--transition-fast: all .15s ease;--transition-medium: all .2s ease}[data-theme=dark]{--color-primary: #F0F0F0;--color-primary-light: #2D3748;--color-background: #1A202C;--color-white: #2D3748;--color-action: #63B3ED;--color-action-hover: #4299E1;--color-success: #68D391;--color-success-hover: #48BB78;--color-danger: #FC8181;--color-danger-hover: #F56565;--color-warning: #F6E05E;--color-warning-bg: #744210;--color-secondary: #A0AEC0;--color-secondary-hover: #CBD5E0;--color-text: #F7FAFC;--color-text-light: #CBD5E0;--color-muted: #A0AEC0;--color-border: #4A5568;--color-border-input: #4A5568;--color-hover-bg: #374151;--color-alt-bg: #1F2937;--shadow-sm: 0 1px 3px rgba(0, 0, 0, .3);--shadow-md: 0 2px 8px rgba(0, 0, 0, .4);--shadow-lg: 0 4px 12px rgba(0, 0, 0, .5)}[data-theme=dark] header{background:#1f2937;border-bottom-color:#374151;color:#e2e8f0}[data-theme=dark] header h1{color:#f7fafc}[data-theme=dark] thead{background:#374151}[data-theme=dark] thead th{color:#f7fafc}[data-theme=dark] th:hover{background:#4a5568}[data-theme=dark] td{border-bottom-color:#374151}[data-theme=dark] tbody tr:last-child{border-color:#4a5568;background:#1f2937}[data-theme=dark] .modal-content{background:#2d3748;color:var(--color-text)}[data-theme=dark] .sidebar{background:#2d3748}[data-theme=dark] .sidebar-header{background:#1f2937;border-bottom-color:#4a5568}[data-theme=dark] .status-message{background:#2d3748}[data-theme=dark] .table-tag{background:#374151;color:#e2e8f0}[data-theme=dark] .tag{background:#4299e1}[data-theme=dark] input:disabled,[data-theme=dark] textarea:disabled,[data-theme=dark] select:disabled{background:#1f2937}[data-theme=dark] input,[data-theme=dark] textarea,[data-theme=dark] select,[data-theme=dark] select option,[data-theme=dark] .form-group input,[data-theme=dark] .form-group textarea,[data-theme=dark] .form-group select{background:#2d3748!important;color:#f7fafc!important}[data-theme=dark] input::placeholder,[data-theme=dark] textarea::placeholder{color:#a0aec0}[data-theme=dark] .details-table th{background-color:#374151;border-bottom-color:#4a5568}[data-theme=dark] .details-table tbody tr:nth-child(2n){background-color:#1f2937}[data-theme=dark] .details-table input,[data-theme=dark] .details-table select{background:transparent!important}[data-theme=dark] .details-table input:hover,[data-theme=dark] .details-table select:hover{border-bottom-color:#4a5568}[data-theme=dark] .details-table input:focus,[data-theme=dark] .details-table select:focus{border-bottom-color:var(--color-action)}[data-theme=dark] .group-item,[data-theme=dark] .fund-name-item{background:#1f2937;border-color:#4a5568;color:#f7fafc}[data-theme=dark] .action-dropdown{background:#2d3748;border-color:#4a5568}[data-theme=dark] .action-dropdown a:hover{background:#374151}[data-theme=dark] .action-dropdown a.danger-action:hover{background:#742a2a}[data-theme=dark] .loading-content{background:#2d3748}[data-theme=dark] .multi-select-trigger{background:#2d3748;border-color:#4a5568;color:#f7fafc}[data-theme=dark] .multi-select-dropdown{background:#2d3748;border-color:#4a5568}[data-theme=dark] .multi-select-option:hover,[data-theme=dark] .multi-select-option.highlighted{background:#3b5068}[data-theme=dark] .multi-select-option.selected{background:#63b3ed33}[data-theme=dark] .multi-select-actions{background:#1f2937;border-top-color:#4a5568}[data-theme=dark] .multi-select-option.group-top-level{background:#374151}[data-theme=dark] .multi-select-option.group-separator{border-top-color:#4a5568}[data-theme=dark] .multi-select-option.group-child{border-left-color:#63b3ed}[data-theme=dark] .multi-select-search{background:var(--color-bg);border-bottom-color:#4a5568}[data-theme=dark] .multi-select-search input{background:#374151;border-color:#4a5568;color:var(--color-text)}[data-theme=dark] .multi-select-search input:focus{border-color:var(--color-action)}[data-theme=dark] .multi-select-all-option{border-bottom-color:#4a5568}.portfolio-summary{display:flex;flex-wrap:wrap;gap:16px;padding:16px 20px;background:var(--color-alt-bg);border:1px solid var(--color-border);border-radius:var(--radius-md);margin-bottom:20px}.summary-stat{display:flex;flex-direction:column;min-width:100px;padding:8px 16px;background:var(--color-white);border-radius:var(--radius-sm);border:1px solid var(--color-border)}.summary-label{font-size:11px;font-weight:600;text-transform:uppercase;color:var(--color-text-light);letter-spacing:.5px;margin-bottom:4px}.summary-value{font-size:18px;font-weight:600;color:var(--color-text);font-variant-numeric:tabular-nums}.summary-value.positive{color:var(--color-success)}.summary-value.negative{color:var(--color-danger)}#detailsSummary{gap:10px}#detailsSummary .summary-value{font-size:13px}#detailsSummary .summary-label{font-size:9px}#detailsSummary .summary-stat{min-width:70px;padding:8px 10px}.summary-label-container{display:flex;align-items:center;gap:4px}.info-icon{display:inline-flex;align-items:center;justify-content:center;width:14px;height:14px;border-radius:50%;background:var(--color-text-light);color:var(--color-white);font-size:9px;font-weight:700;cursor:help;position:relative;flex-shrink:0}.info-icon:hover{background:var(--color-action)}.info-icon .tooltip{display:none;position:absolute;bottom:calc(100% + 8px);left:50%;transform:translate(-50%);background:var(--color-primary);color:#fff;padding:8px 12px;border-radius:var(--radius-md);font-size:12px;font-weight:400;white-space:normal;width:220px;text-align:left;z-index:1000;box-shadow:var(--shadow-md);line-height:1.4}.info-icon .tooltip:after{content:"";position:absolute;top:100%;left:50%;transform:translate(-50%);border:6px solid transparent;border-top-color:var(--color-primary)}.info-icon:hover .tooltip{display:block}[data-theme=dark] .info-icon{background:var(--color-text-light);color:var(--color-background)}[data-theme=dark] .info-icon .tooltip{background:#4a5568}[data-theme=dark] .info-icon .tooltip:after{border-top-color:#4a5568}.timeline-panel{background:var(--color-white);border:1px solid var(--color-border);border-radius:var(--radius-md);margin-bottom:20px;overflow:hidden}.timeline-header{display:flex;justify-content:space-between;align-items:center;padding:12px 16px;background:var(--color-alt-bg);border-bottom:1px solid var(--color-border);cursor:pointer;user-select:none}.timeline-header:hover{background:var(--color-hover-bg)}.timeline-header h3{margin:0;font-size:14px;font-weight:600;color:var(--color-text);display:flex;align-items:center;gap:8px}.timeline-header-actions{display:flex;align-items:center;gap:10px}.btn-timeline-export{padding:2px 8px;font-size:11px;background:transparent;border:1px solid var(--color-border);border-radius:3px;color:var(--color-text-light);cursor:pointer;white-space:nowrap}.btn-timeline-export:hover{background:var(--color-hover-bg);color:var(--color-text);border-color:var(--color-text-light)}.timeline-toggle{font-size:12px;color:var(--color-text-light);transition:transform .2s ease}.timeline-panel.expanded .timeline-toggle{transform:rotate(180deg)}.timeline-content{display:none;padding:16px;overflow-x:auto}.timeline-panel.expanded .timeline-content{display:block}.timeline-table{width:100%;border-collapse:collapse;font-size:13px;min-width:600px}.timeline-table th,.timeline-table td{padding:8px 12px;text-align:right;border:1px solid var(--color-border);white-space:nowrap}.timeline-table th:not(:first-child),.timeline-table td:not(:first-child){min-width:90px;width:90px}.timeline-table th{background:var(--color-alt-bg);font-weight:600;color:var(--color-text)}.timeline-table th:first-child,.timeline-table td:first-child{text-align:left;position:sticky;left:0;background:var(--color-white);z-index:1}.timeline-table th:first-child{background:var(--color-alt-bg)}.timeline-table .year-projected{background:var(--color-alt-bg);font-style:italic}.timeline-table .year-projected th{background:#e8f4fd}[data-theme=dark] .timeline-table .year-projected th{background:#2c4a5e}.timeline-table .year-estimated{background:var(--color-warning-bg);font-style:italic}.timeline-table .year-estimated th{background:var(--color-warning-bg)}.timeline-estimated-indicator{display:inline-block;font-size:10px;color:var(--color-warning);margin-left:4px;vertical-align:super;cursor:help}.timeline-table .row-calls td{color:var(--color-danger)}.timeline-table .row-distributions td,.timeline-table .row-net td.positive{color:var(--color-success)}.timeline-table .row-net td.negative{color:var(--color-danger)}.timeline-table .row-net{font-weight:600;border-top:2px solid var(--color-border)}.timeline-table .row-label{font-weight:500;color:var(--color-text)}.timeline-table td:first-child{font-weight:500}.timeline-divider{border-left:3px solid var(--color-action)!important}.timeline-expand-row{cursor:pointer}.timeline-expand-row:hover{background:var(--color-hover-bg)}.timeline-expand-icon{display:inline-block;width:16px;font-size:10px;color:var(--color-text-light)}.timeline-fund-row{display:none}.timeline-fund-row.visible{display:table-row}.timeline-fund-row td{background:var(--color-alt-bg);font-size:12px}.timeline-fund-row td:first-child{padding-left:28px;background:var(--color-alt-bg)}.timeline-no-data{text-align:center;padding:30px;color:var(--color-text-light);font-style:italic}@media (max-width: 768px){.timeline-table{font-size:11px}.timeline-table th,.timeline-table td{padding:6px 8px}}.shortcuts-modal .modal-content{max-width:500px}.shortcuts-list{display:grid;grid-template-columns:auto 1fr;gap:12px 20px;margin-top:16px}.shortcut-key{display:inline-flex;align-items:center;gap:4px}.shortcut-key kbd{display:inline-block;padding:4px 8px;font-family:monospace;font-size:12px;background:var(--color-alt-bg);border:1px solid var(--color-border);border-radius:var(--radius-sm);box-shadow:0 1px 2px #0000001a}.shortcut-desc{color:var(--color-text);font-size:14px}.health-check-modal .modal-content{max-width:700px;max-height:80vh;display:flex;flex-direction:column}.health-check-summary{display:flex;gap:16px;flex-wrap:wrap;padding:16px;background:var(--color-alt-bg);border-radius:var(--radius-sm);margin-bottom:16px}.health-check-stat{text-align:center;padding:8px 16px;min-width:80px}.health-check-stat-value{font-size:24px;font-weight:600}.health-check-stat-label{font-size:12px;color:var(--color-secondary-hover);text-transform:uppercase}.health-check-stat-value.error-count{color:var(--color-danger)}.health-check-stat-value.warning-count{color:var(--color-warning)}.health-check-stat-value.info-count{color:var(--color-action)}.health-check-stat-value.success-count{color:var(--color-success)}.health-check-results{flex:1;overflow-y:auto;max-height:400px}.health-check-empty{text-align:center;padding:40px;color:var(--color-success);font-size:16px}.health-check-loading{display:flex;flex-direction:column;align-items:center;justify-content:center;padding:40px;gap:16px;color:var(--color-text-light)}.health-check-loading .loading-spinner{width:32px;height:32px}.health-issue{display:flex;align-items:flex-start;gap:12px;padding:12px;border-bottom:1px solid var(--color-border)}.health-issue:last-child{border-bottom:none}.health-issue:hover{background:var(--color-hover-bg)}.health-issue-severity{padding:4px 8px;border-radius:var(--radius-sm);font-size:11px;font-weight:600;text-transform:uppercase;flex-shrink:0}.severity-error{background:#e74c3c26;color:var(--color-danger)}.severity-warning{background:#f1c40f26;color:var(--color-warning)}.severity-info{background:#3498db26;color:var(--color-action)}.health-issue-content{flex:1}.health-issue-fund{font-weight:600;color:var(--color-primary);margin-bottom:4px}.health-issue-message{font-size:14px;color:var(--color-text)}.health-issue-category{font-size:12px;color:var(--color-secondary-hover);margin-top:4px}.health-check-section-header{font-size:13px;font-weight:600;text-transform:uppercase;color:var(--color-secondary-hover);padding:12px 12px 8px;border-bottom:1px solid var(--color-border);background:var(--color-alt-bg)}.duplicate-pair{display:flex;align-items:flex-start;gap:12px;padding:12px;border-bottom:1px solid var(--color-border)}.duplicate-pair:last-child{border-bottom:none}.duplicate-pair:hover{background:var(--color-hover-bg)}.duplicate-confidence{padding:4px 8px;border-radius:var(--radius-sm);font-size:11px;font-weight:600;text-transform:uppercase;flex-shrink:0}.confidence-high{background:#e74c3c26;color:var(--color-danger)}.confidence-medium{background:#f1c40f26;color:var(--color-warning)}.confidence-low{background:#3498db26;color:var(--color-action)}.duplicate-content{flex:1}.duplicate-funds{display:flex;align-items:center;gap:8px;flex-wrap:wrap;margin-bottom:4px}.duplicate-fund-link{font-weight:600;color:var(--color-action);cursor:pointer}.duplicate-fund-link:hover{text-decoration:underline}.duplicate-separator{color:var(--color-secondary-hover)}.duplicate-reason{font-size:14px;color:var(--color-text)}.btn-dismiss-issue{padding:4px 10px;font-size:12px;background:transparent;border:1px solid var(--color-border);border-radius:var(--radius-sm);color:var(--color-text-light);cursor:pointer;flex-shrink:0;align-self:center;transition:all .15s ease}.btn-dismiss-issue:hover{background:var(--color-hover-bg);border-color:var(--color-secondary-hover);color:var(--color-text)}@media (max-width: 768px){.portfolio-summary{gap:8px;padding:12px}.summary-stat{min-width:80px;padding:6px 10px}.summary-label{font-size:10px}.summary-value{font-size:14px}}*{box-sizing:border-box;margin:0;padding:0}body{font-family:-apple-system,BlinkMacSystemFont,Segoe UI,Roboto,Oxygen,Ubuntu,Cantarell,sans-serif;background:var(--color-background);min-height:100vh;padding:var(--spacing-lg)}.container{max-width:1800px;margin:0 auto;background:var(--color-white);border-radius:var(--radius-md);box-shadow:var(--shadow-sm);overflow:hidden}header{background:var(--color-primary);color:var(--color-white);padding:24px var(--spacing-xl);border-bottom:1px solid var(--color-primary-light)}header h1{font-size:1.75em;font-weight:600;margin-bottom:4px;letter-spacing:-.5px}header p{font-size:.95em;opacity:.85;font-weight:400}.controls-bar{background:var(--color-alt-bg);padding:var(--spacing-lg) var(--spacing-xl);display:flex;gap:16px;flex-wrap:wrap;align-items:flex-end;border-bottom:1px solid var(--color-border)}.control-group{display:flex;flex-direction:column;gap:6px}.control-group label{font-weight:500;font-size:.85em;color:var(--color-text)}.control-group select,.control-group input[type=date],.control-group input[type=text]{padding:var(--spacing-sm) var(--spacing-md);border:1px solid var(--color-border-input);border-radius:var(--radius-sm);font-size:14px;min-width:150px;background:var(--color-white);color:var(--color-text)}.control-group select:focus,.control-group input[type=date]:focus,.control-group input[type=text]:focus{outline:none;border-color:var(--color-action);box-shadow:0 0 0 2px #3498db1a}.filter-badge{display:none;align-items:center;gap:6px;background:var(--color-action);color:#fff;font-size:11px;font-weight:600;padding:3px 8px;border-radius:12px;margin-left:8px}.filter-badge.show{display:inline-flex;white-space:nowrap}.filter-badge .clear-filters{display:inline-flex;align-items:center;justify-content:center;width:14px;height:14px;border-radius:50%;background:#ffffff4d;color:#fff;font-size:10px;cursor:pointer;border:none;padding:0;line-height:1}.filter-badge .clear-filters:hover{background:#ffffff80}.multi-select{position:relative;min-width:150px}.multi-select-trigger{display:flex;align-items:center;justify-content:space-between;padding:var(--spacing-sm) var(--spacing-md);border:1px solid var(--color-border-input);border-radius:var(--radius-sm);font-size:14px;background:var(--color-white);color:var(--color-text);cursor:pointer;min-height:36px;gap:8px}.multi-select-trigger:hover{border-color:var(--color-action)}.multi-select.open .multi-select-trigger{border-color:var(--color-action);box-shadow:0 0 0 2px #3498db1a}.multi-select-display{flex:1;overflow:hidden;text-overflow:ellipsis;white-space:nowrap}.multi-select-display .placeholder{color:var(--color-muted)}.multi-select-count{background:var(--color-action);color:#fff;font-size:11px;font-weight:600;padding:2px 6px;border-radius:10px;flex-shrink:0}.multi-select-arrow{flex-shrink:0;transition:transform .2s ease}.multi-select.open .multi-select-arrow{transform:rotate(180deg)}.multi-select-dropdown{position:absolute;top:100%;left:0;min-width:220px;margin-top:4px;background:var(--color-white);border:1px solid var(--color-border);border-radius:var(--radius-sm);box-shadow:var(--shadow-lg);z-index:1000;display:none}.multi-select.open .multi-select-dropdown{display:block}.multi-select-option{display:flex;align-items:center;gap:8px;padding:8px 12px;cursor:pointer;transition:background .15s ease}.multi-select-option:hover,.multi-select-option.highlighted{background:#e8f4fc;outline:none}.multi-select-option.selected{background:#3498db1a}.multi-select-option input[type=checkbox]{margin:0;cursor:pointer}.multi-select-option label{flex:1;cursor:pointer;font-size:14px;white-space:nowrap}.multi-select-option.group-option{padding-left:calc(12px + var(--indent-level, 0) * 16px)}.multi-select-option.group-top-level{background:var(--color-alt-bg);font-weight:600}.multi-select-option.group-top-level label{font-weight:600}.multi-select-option.group-separator{margin-top:6px;border-top:1px solid var(--color-border);padding-top:10px}.multi-select-option.group-child{border-left:3px solid var(--color-primary-light, #85c1e9);margin-left:8px;padding-left:calc(12px + var(--indent-level, 0) * 16px - 11px)}.multi-select-actions{display:flex;gap:8px;padding:8px 12px;border-top:1px solid var(--color-border);background:var(--color-alt-bg)}.multi-select-actions button{flex:1;padding:4px 8px;font-size:12px}.multi-select-search{padding:8px;border-bottom:1px solid var(--color-border);position:sticky;top:0;background:var(--color-white);z-index:1}.multi-select-search input{width:100%;padding:6px 10px;border:1px solid var(--color-border-input);border-radius:var(--radius-sm);font-size:13px;background:var(--color-white);color:var(--color-text)}.multi-select-all-option{border-bottom:1px solid var(--color-border);font-weight:500}.multi-select-all-option label{font-weight:500}.multi-select-search input:focus{outline:none;border-color:var(--color-action);box-shadow:0 0 0 2px #3498db1a}.multi-select-search input::placeholder{color:var(--color-muted)}.multi-select-options{max-height:350px;overflow-y:auto}.multi-select-option.search-hidden{display:none}.multi-select-no-results{padding:12px;text-align:center;color:var(--color-muted);font-size:13px;display:none}.multi-select-no-results.visible{display:block}.searchable-select{position:relative}.searchable-select-trigger{display:flex;align-items:center;justify-content:space-between;padding:var(--spacing-sm) var(--spacing-md);border:1px solid var(--color-border-input);border-radius:var(--radius-sm);font-size:14px;background:var(--color-white);color:var(--color-text);cursor:pointer;min-height:36px;gap:8px}.searchable-select-trigger:hover{border-color:var(--color-action)}.searchable-select.open .searchable-select-trigger{border-color:var(--color-action);box-shadow:0 0 0 2px #3498db1a}.searchable-select-display{flex:1;overflow:hidden;text-overflow:ellipsis;white-space:nowrap}.searchable-select-arrow{flex-shrink:0;width:0;height:0;border-left:5px solid transparent;border-right:5px solid transparent;border-top:5px solid var(--color-text-light);transition:transform .2s ease}.searchable-select.open .searchable-select-arrow{transform:rotate(180deg)}.searchable-select-dropdown{position:absolute;top:100%;left:0;right:0;min-width:200px;margin-top:4px;background:var(--color-white);border:1px solid var(--color-border);border-radius:var(--radius-sm);box-shadow:var(--shadow-lg);z-index:1000;display:none}.searchable-select.open .searchable-select-dropdown{display:block}.searchable-select-search{padding:8px;background:var(--color-bg);border-bottom:1px solid var(--color-border)}.searchable-select-search input{width:100%;padding:6px 10px;border:1px solid var(--color-border-input);border-radius:var(--radius-sm);font-size:13px;background:var(--color-white);color:var(--color-text)}.searchable-select-search input:focus{outline:none;border-color:var(--color-action);box-shadow:0 0 0 2px #3498db1a}.searchable-select-options{max-height:250px;overflow-y:auto}.searchable-select-option{display:flex;align-items:center;padding:8px 12px;cursor:pointer;font-size:14px;color:var(--color-text)}.searchable-select-option:hover{background:var(--color-hover-bg)}.searchable-select-option.selected{background:#3498db1a;font-weight:500}.searchable-select-option.highlighted{background:#e8f4fc;outline:none}.searchable-select-option.search-hidden{display:none}.searchable-select-option[data-indent="1"]{padding-left:28px}.searchable-select-option[data-indent="2"]{padding-left:44px}.searchable-select-option[data-indent="3"]{padding-left:60px}.searchable-select-no-results{padding:12px;text-align:center;color:var(--color-muted);font-size:13px;display:none}.searchable-select-no-results.visible{display:block}[data-theme=dark] .searchable-select-trigger{background:#2d3748;border-color:#4a5568;color:#f7fafc}[data-theme=dark] .searchable-select-dropdown{background:#2d3748;border-color:#4a5568}[data-theme=dark] .searchable-select-option:hover{background:#374151}[data-theme=dark] .searchable-select-option.selected{background:#63b3ed33}[data-theme=dark] .searchable-select-option.highlighted{background:#3b5068}[data-theme=dark] .searchable-select-search{background:var(--color-bg);border-bottom-color:#4a5568}[data-theme=dark] .searchable-select-search input{background:#374151;border-color:#4a5568;color:var(--color-text)}button{padding:9px 18px;border:none;border-radius:var(--radius-sm);font-size:14px;font-weight:500;cursor:pointer;transition:var(--transition-fast)}.controls-bar button{margin-top:auto}.btn-primary{background:var(--color-action);color:var(--color-white)}.btn-primary:hover{background:var(--color-action-hover)}.btn-secondary{background:var(--color-secondary);color:var(--color-white)}.btn-secondary:hover{background:var(--color-secondary-hover)}.btn-success{background:var(--color-success);color:var(--color-white)}.btn-success:hover{background:var(--color-success-hover)}.btn-danger{background:var(--color-danger);color:var(--color-white)}.btn-danger:hover{background:var(--color-danger-hover)}.btn-link{background:none;border:none;color:var(--color-action);cursor:pointer;padding:2px 4px;font-size:inherit;text-decoration:underline}.btn-link:hover{color:var(--color-action-hover)}.btn-info{background:var(--color-primary-light);color:var(--color-white)}.btn-info:hover{background:var(--color-primary)}button:disabled{opacity:.5;cursor:not-allowed}button:focus-visible,a:focus-visible,input:focus-visible,select:focus-visible,textarea:focus-visible{outline:2px solid var(--color-action);outline-offset:2px}button:focus:not(:focus-visible),a:focus:not(:focus-visible),input:focus:not(:focus-visible),select:focus:not(:focus-visible){outline:none}.skip-link{position:absolute;top:-40px;left:0;background:var(--color-action);color:#fff;padding:8px;z-index:100000;transition:top .3s}.skip-link:focus{top:0}.sr-announce{position:absolute;left:-10000px;width:1px;height:1px;overflow:hidden}.filter-loading{display:none;align-items:center;gap:8px;padding:8px 12px;color:var(--color-text-light);font-size:13px}.filter-loading.show{display:flex}.filter-loading-spinner{width:16px;height:16px;border:2px solid var(--color-border);border-top-color:var(--color-action);border-radius:50%;animation:spin .8s linear infinite}@keyframes spin{to{transform:rotate(360deg)}}tbody tr:focus{outline:2px solid var(--color-action);outline-offset:-2px}tbody tr[tabindex]:hover{background:var(--color-hover-bg)}.btn-icon{background:none;border:none;color:var(--color-text-light);font-size:16px;padding:var(--spacing-xs) var(--spacing-sm);cursor:pointer;transition:var(--transition-fast)}.btn-icon:hover{color:var(--color-primary-light)}.action-dropdown{display:none;position:fixed;background:var(--color-white);border:1px solid var(--color-border);border-radius:var(--radius-md);box-shadow:var(--shadow-lg);min-width:160px;z-index:10000;padding:var(--spacing-xs) 0}.action-dropdown.show{display:block}.action-dropdown a{display:block;padding:10px 16px;color:var(--color-text);text-decoration:none;font-size:14px;transition:var(--transition-fast)}.action-dropdown a:hover{background:var(--color-hover-bg)}.action-dropdown a.danger-action{color:var(--color-danger)}.action-dropdown a.danger-action:hover{background:#ffebee}.dropdown{position:relative;display:inline-block}.dropdown-menu{display:none;position:absolute;top:100%;right:0;background:var(--color-white);border:1px solid var(--color-border);border-radius:var(--radius-sm);box-shadow:var(--shadow-md);min-width:160px;z-index:1000;margin-top:var(--spacing-xs)}.dropdown-menu.show{display:block}.dropdown-menu a{display:block;padding:10px 16px;color:var(--color-text);text-decoration:none;font-size:14px;transition:var(--transition-fast)}.dropdown-menu a:hover{background:var(--color-hover-bg)}.dropdown-menu a:first-child{border-radius:var(--radius-sm) var(--radius-sm) 0 0}.dropdown-menu a:last-child{border-radius:0 0 var(--radius-sm) var(--radius-sm)}.content{padding:var(--spacing-xl)}.table-container{overflow-x:auto;margin-bottom:var(--spacing-sm)}.table-pagination{display:flex;align-items:center;justify-content:center;gap:16px;padding:16px;background:var(--color-alt-bg);border:1px solid var(--color-border);border-top:none;border-radius:0 0 var(--radius-sm) var(--radius-sm);margin-bottom:var(--spacing-xl)}.pagination-info{color:var(--color-text-light);font-size:14px}.pagination-info strong{color:var(--color-text)}.load-more-btn{padding:8px 24px;font-size:14px}.table-container table,table{width:100%;border-collapse:collapse;background:var(--color-white);border:1px solid var(--color-border);border-radius:var(--radius-sm);overflow:hidden}.table-container table{width:100%;table-layout:auto}thead{background:var(--color-primary-light);color:var(--color-white);position:sticky;top:0;z-index:10}th{padding:14px var(--spacing-md);text-align:left;font-weight:500;cursor:pointer;user-select:none;white-space:nowrap;font-size:.9em}th:hover{background:var(--color-primary)}th.sorted-asc:after{content:" ↑";opacity:1}th.sorted-desc:after{content:" ↓";opacity:1}th.sorted-asc[data-sort-priority="1"]:after{content:" ↑¹"}th.sorted-asc[data-sort-priority="2"]:after{content:" ↑²"}th.sorted-asc[data-sort-priority="3"]:after{content:" ↑³"}th.sorted-asc[data-sort-priority="4"]:after{content:" ↑⁴"}th.sorted-asc[data-sort-priority="5"]:after{content:" ↑⁵"}th.sorted-desc[data-sort-priority="1"]:after{content:" ↓¹"}th.sorted-desc[data-sort-priority="2"]:after{content:" ↓²"}th.sorted-desc[data-sort-priority="3"]:after{content:" ↓³"}th.sorted-desc[data-sort-priority="4"]:after{content:" ↓⁴"}th.sorted-desc[data-sort-priority="5"]:after{content:" ↓⁵"}th.wrap-header{white-space:normal;line-height:1.3;padding:10px 8px}th{position:relative}th.resizable{overflow:hidden;text-overflow:ellipsis}th .resizer{position:absolute;top:0;right:-8px;width:16px;height:100%;cursor:col-resize;user-select:none;z-index:10}th .resizer:hover{background-color:var(--color-action);width:4px;right:0}th.resizing{user-select:none}#fundsTable th:nth-child(2),#fundsTable td:nth-child(2){max-width:200px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap}td{padding:12px;border-bottom:1px solid #F0F0F0;font-size:.9em;color:var(--color-primary)}tbody tr:hover{background:var(--color-hover-bg)}tbody tr:last-child{border-top:2px solid var(--color-primary-light);border-bottom:2px solid var(--color-primary-light);font-weight:600;background:var(--color-alt-bg)}tbody tr:last-child td{border-bottom:none}table.no-summary-row tbody tr:last-child{border-top:none;border-bottom:1px solid var(--color-border);font-weight:400;background:transparent}[data-theme=dark] table.no-summary-row tbody tr:last-child{border-color:var(--color-border);background:transparent}td.number{text-align:right;font-variant-numeric:tabular-nums}th.center,td.center{text-align:center}.positive{color:var(--color-success)}.negative{color:var(--color-danger)}.empty-state{text-align:center;padding:60px 20px;color:var(--color-text-light)}.action-buttons{display:flex;gap:5px;flex-wrap:nowrap}.btn-sm{padding:6px 12px;font-size:12px;min-width:auto;white-space:nowrap}.modal{display:none;position:fixed;z-index:1000;left:0;top:0;width:100%;height:100%;overflow-y:auto;background-color:#00000080}.modal.show{display:flex;align-items:flex-start;justify-content:center;padding:40px 20px}.modal-content{background-color:var(--color-white);padding:30px;border-radius:var(--radius-md);width:100%;max-width:700px;box-shadow:0 4px 12px #00000026;position:relative;margin:auto}.modal-content h2{margin-bottom:24px;color:var(--color-primary);font-size:1.5em;font-weight:600}.modal .btn-close{position:absolute;top:15px;right:20px;font-size:28px;font-weight:300;color:var(--color-text-light);cursor:pointer;line-height:1;width:30px;height:30px;display:flex;align-items:center;justify-content:center;border-radius:var(--radius-sm);transition:var(--transition-medium);background:none;border:none;padding:0}.modal .btn-close:hover{background:var(--color-border);color:var(--color-primary)}.modal .btn-close:focus{outline:2px solid var(--color-action);outline-offset:2px}.confirm-modal{z-index:2000}.confirm-modal-content{max-width:450px;text-align:center}.confirm-modal-content h2{margin-bottom:16px}.confirm-modal-message{color:var(--color-text);line-height:1.6;margin-bottom:8px;white-space:pre-wrap}.confirm-modal-content .form-actions{justify-content:center}.confirm-modal-content .form-actions button{flex:0 1 auto;min-width:100px}.form-group{margin-bottom:20px}.form-group label{display:block;margin-bottom:8px;font-weight:500;color:var(--color-primary);font-size:.9em}.form-group label.checkbox-label{display:inline-flex;align-items:center;gap:8px;cursor:pointer}.form-group label.checkbox-label input[type=checkbox]{width:auto;margin:0}.form-group input,.form-group select,.form-group textarea{width:100%;padding:10px 12px;border:1px solid var(--color-border-input);border-radius:var(--radius-sm);font-size:14px;transition:var(--transition-fast);background:var(--color-white)}.form-group input:focus,.form-group select:focus,.form-group textarea:focus{outline:none;border-color:var(--color-action);box-shadow:0 0 0 2px #3498db1a}.form-group.has-error input,.form-group.has-error select,.form-group.has-error textarea{border-color:var(--color-danger);background-color:#e74c3c0d}.form-group.has-error input:focus,.form-group.has-error select:focus,.form-group.has-error textarea:focus{border-color:var(--color-danger);box-shadow:0 0 0 2px #e74c3c1a}.form-group.has-error label{color:var(--color-danger)}.form-group .error-message{display:none;color:var(--color-danger);font-size:12px;margin-top:4px}.form-group.has-error .error-message{display:block}.form-group textarea{font-family:Courier New,monospace;resize:vertical;min-height:100px}.form-group .hint{font-size:12px;color:var(--color-secondary-hover);margin-top:5px}.tags-container{display:flex;flex-wrap:wrap;gap:6px;margin-bottom:8px;min-height:24px}.tag{display:inline-flex;align-items:center;background:var(--color-action);color:var(--color-white);padding:4px 10px;border-radius:12px;font-size:13px;font-weight:500;gap:6px}.tag-remove{cursor:pointer;font-weight:700;font-size:16px;line-height:1;opacity:.8}.tag-remove:hover{opacity:1}.table-tags{display:flex;flex-wrap:wrap;gap:4px}.table-tag{display:inline-block;background:#e8f4f8;color:var(--color-primary);padding:2px 8px;border-radius:10px;font-size:11px;font-weight:500;white-space:nowrap}.form-actions{display:flex;gap:10px;margin-top:25px}.form-actions button{flex:1}.modal-sm .modal-content{max-width:500px}.modal-md .modal-content{max-width:600px}.modal-lg .modal-content{max-width:700px}.modal-xl .modal-content{max-width:900px}.hidden{display:none!important}.btn-full{width:100%}.btn-compact{padding:8px 12px;white-space:nowrap}.btn-min-width{min-width:100px}.btn-file-input{cursor:pointer;display:inline-block;padding:9px 18px;min-width:100px;text-align:center}.btn-sm.mt-md{margin-top:10px}.ml-auto{margin-left:auto}.btn-icon-lg{font-size:20px}.text-muted{color:var(--color-text-light)}.text-sm{font-size:14px}.text-xs{font-size:12px}.text-danger{color:var(--color-danger)}.mb-sm{margin-bottom:10px}.mb-md{margin-bottom:15px}.mb-lg{margin-bottom:20px}.mt-md{margin-top:15px}.mt-lg{margin-top:20px}.p-md{padding:15px}.gap-sm{gap:8px}.gap-md{gap:10px}.d-flex{display:flex}.flex-1{flex:1}.section-title{margin-bottom:15px;color:var(--color-text);font-weight:600;font-size:1.1em}.section-title-sm{margin-bottom:15px;color:var(--color-text);font-weight:600;font-size:1em}.section-divider{margin:20px 0;border:none;border-top:1px solid var(--color-border)}.preview-container{display:none;margin:20px 0;padding:15px;background:var(--color-alt-bg);border-radius:var(--radius-sm);max-height:300px;overflow-y:auto}.preview-container.show{display:block}.preview-title{margin:0 0 10px;font-size:14px}.preview-title-danger{margin:0 0 10px;font-size:14px;color:var(--color-danger)}.import-preview-container{margin:20px 0;padding:15px;background:var(--color-alt-bg);border-radius:var(--radius-sm);max-height:400px;overflow-y:auto}.sync-content{margin:20px 0;max-height:400px;overflow-y:auto}.groups-list{max-height:400px;overflow-y:auto}.fund-terms-panel{padding:10px;background:var(--color-alt-bg);border-radius:var(--radius-sm);margin-top:10px}.fund-terms-toggle{cursor:pointer;color:var(--color-action);font-size:13px}.small-hint{color:var(--color-text-light);font-size:.85em;margin-top:4px;display:block}.modal-subtitle{margin:5px 0 0;color:var(--color-text-light);font-size:.9em}.modal-description{color:var(--color-text-light);margin-bottom:20px;font-size:14px}.section-title-bordered{margin:20px 0 15px;color:var(--color-text);font-weight:600;font-size:1em;border-top:1px solid var(--color-border);padding-top:20px}.timeline-label{font-weight:400;font-size:12px;color:var(--color-text-light)}.text-warning{color:var(--color-warning)}.backup-warning-text{line-height:1.6;margin-bottom:15px}.backup-warning-list{margin:15px 0 15px 25px;line-height:1.8}.backup-warning-cta{line-height:1.6;margin-bottom:20px;font-weight:600;color:var(--color-danger)}.toast-container{position:fixed;top:20px;right:20px;z-index:2000;display:flex;flex-direction:column;gap:10px;pointer-events:none}.status-message{position:relative;padding:14px 45px 14px 20px;border-radius:var(--radius-sm);background:var(--color-white);box-shadow:0 2px 8px #00000026;animation:slideIn .2s ease;max-width:400px;border-left:3px solid;pointer-events:auto}.status-message.success{border-left-color:var(--color-success)}.status-message.error{border-left-color:var(--color-danger)}.status-message.warning{border-left-color:#f39c12}.status-message .close-status{position:absolute;top:10px;right:12px;font-size:20px;font-weight:300;color:var(--color-text-light);cursor:pointer;line-height:1;background:none;border:none;padding:0}.status-message .close-status:hover{color:var(--color-primary)}@keyframes slideIn{0%{transform:translate(400px);opacity:0}to{transform:translate(0);opacity:1}}.loading-overlay{position:fixed;top:0;left:0;width:100%;height:100%;background:#00000080;display:none;justify-content:center;align-items:center;z-index:3000}.loading-overlay.show{display:flex}.loading-content{background:var(--color-white);padding:30px 40px;border-radius:5px;text-align:center;box-shadow:0 4px 12px #0000004d}.loading-spinner{border:4px solid #f3f3f3;border-top:4px solid var(--color-action);border-radius:50%;width:40px;height:40px;animation:spin 1s linear infinite;margin:0 auto 15px}@keyframes spin{0%{transform:rotate(0)}to{transform:rotate(360deg)}}.loading-text{color:var(--color-primary);font-size:16px;font-weight:500}input[type=file]{display:none}.file-input-label{display:inline-block;padding:9px 18px;background:var(--color-primary-light);color:var(--color-white);border-radius:var(--radius-sm);cursor:pointer;font-weight:500;transition:var(--transition-fast);font-size:14px}.file-input-label:hover{background:var(--color-primary)}input:disabled,textarea:disabled,select:disabled{opacity:.6;background:#f5f5f5;cursor:not-allowed}.details-table-wrapper{overflow-x:auto;margin-top:15px;border:1px solid var(--color-border);border-radius:var(--radius-sm);max-width:100%}.details-table{border-collapse:collapse;font-size:.85em}.details-table th{background-color:var(--color-primary-light);color:var(--color-white);padding:6px 8px;text-align:left;border:none;border-bottom:2px solid var(--color-primary);font-weight:500;font-size:.85em}.details-table td{padding:6px 8px;border:none}.details-table tbody tr:nth-child(2n){background-color:var(--color-alt-bg)}.details-table input,.details-table select{padding:6px 8px;background:transparent!important;border:none;border-bottom:1px solid transparent;border-radius:0;font-family:inherit;font-size:1em;box-sizing:border-box;transition:border-color .15s ease}.details-table input:hover,.details-table select:hover{border-bottom-color:var(--color-border-input)}.details-table input:focus,.details-table select:focus{border-bottom-color:var(--color-action);outline:none}.details-table input[type=number],.details-table input[type=text]{text-align:right;width:90px}.details-table input[type=date]{text-align:left;width:130px}.details-table select{text-align:left;width:115px}.details-table input[type=checkbox]{width:auto}#cashFlowsTable{width:100%}#cashFlowsTable th:nth-child(1),#cashFlowsTable td:nth-child(1){width:150px}#cashFlowsTable th:nth-child(2),#cashFlowsTable td:nth-child(2){width:140px}#cashFlowsTable th:nth-child(3),#cashFlowsTable td:nth-child(3){width:130px}#cashFlowsTable th:nth-child(4),#cashFlowsTable td:nth-child(4){width:160px;text-align:center}#cashFlowsTable th:nth-child(5),#cashFlowsTable td:nth-child(5){width:auto;text-align:right}#navTable{width:100%}#navTable th:nth-child(1),#navTable td:nth-child(1){width:150px}#navTable th:nth-child(2),#navTable td:nth-child(2){width:140px;text-align:right}#navTable th:nth-child(3),#navTable td:nth-child(3){width:auto;text-align:right}.delete-row-btn{background:none;border:none;color:var(--color-danger);font-size:18px;padding:4px 8px;cursor:pointer;transition:var(--transition-fast)}.delete-row-btn:hover{color:var(--color-danger-hover)}.validation-error-row{background-color:#ffebee!important;border-left:3px solid var(--color-danger)}.validation-error-row input{border-color:var(--color-danger)!important}#manageFundNamesModal .fund-name-item{display:flex;justify-content:space-between;align-items:center;padding:10px;margin-bottom:8px;background:var(--color-alt-bg);border:1px solid var(--color-border);border-radius:var(--radius-sm);gap:10px}#manageFundNamesModal .fund-name-item .btn-sm{margin-left:5px}.group-item{display:flex;justify-content:space-between;align-items:center;padding:8px 10px;margin-bottom:4px;background:var(--color-alt-bg);border:1px solid var(--color-border);border-radius:var(--radius-sm)}.group-item.level-0{margin-left:0;font-weight:600}.group-item.level-1{margin-left:20px;font-weight:500}.group-item.level-2{margin-left:40px}.group-item.level-3{margin-left:60px}.group-item-info{flex:1;display:flex;align-items:center;gap:10px}.group-item-type{font-size:.85em;color:var(--color-secondary-hover);font-style:italic}.group-item-actions{display:flex;gap:5px}@media (max-width: 1400px){.controls-bar{flex-direction:column;align-items:stretch}.control-group{width:100%}}@media (max-width: 768px){body{padding:var(--spacing-sm)}header{padding:16px var(--spacing-md)}header h1{font-size:1.4em}.controls-bar{padding:var(--spacing-md);gap:12px}.content{padding:var(--spacing-md)}.table-container{overflow-x:auto;-webkit-overflow-scrolling:touch}.modal-content{padding:20px;margin:20px;max-width:calc(100% - 40px)}.form-actions{flex-direction:column}.form-actions button{width:100%}.sidebar{width:280px;right:-280px}.btn-icon{font-size:18px!important;padding:6px}th,td{font-size:.85em;padding:8px 6px}}@media (max-width: 480px){header h1{font-size:1.2em}header p{font-size:.85em}.controls-bar{gap:8px}.modal-content{padding:15px}.modal-content h2{font-size:1.2em}th,td{font-size:.8em;padding:6px 4px}.table-container table{min-width:800px}}@media print{:root,[data-theme=dark]{--color-primary: #2C3E50;--color-primary-light: #34495E;--color-background: #ECF0F1;--color-white: #ffffff;--color-action: #3498DB;--color-success: #27AE60;--color-danger: #E74C3C;--color-text: #2C3E50;--color-text-light: #95A5A6;--color-muted: #95A5A6;--color-border: #E0E0E0;--color-hover-bg: #F8F9FA;--color-alt-bg: #FAFAFA}body{background:#fff!important;color:#2c3e50!important;padding:0}.container{box-shadow:none;border-radius:0}.controls-bar,.btn-sm,button{display:none!important}header{background:#fff!important;color:#2c3e50!important;border-bottom:2px solid #2C3E50!important;padding:15px}header h1{color:#2c3e50!important}header p{color:#95a5a6!important}.content{padding:10px}table{width:100%;max-width:100%;page-break-inside:auto;border:1px solid var(--color-primary);table-layout:fixed}.table-container table{min-width:100%!important;max-width:100%!important}thead{background:#2c3e50!important;-webkit-print-color-adjust:exact;print-color-adjust:exact}thead th{color:#fff!important;background:#2c3e50!important}tr{page-break-inside:avoid;page-break-after:auto}th,td{padding:8px 6px;font-size:10px;color:#2c3e50!important;background:#fff!important}tbody tr:nth-child(2n) td{background:#f8f9fa!important}.container,.content,.table-container{background:#fff!important}.positive{color:#27ae60!important}.negative{color:#e74c3c!important}#fundsTable th,#fundsTable td{min-width:auto!important;max-width:none!important}#fundsTable th:nth-child(1),#fundsTable td:nth-child(1){width:130px!important}#fundsTable th:nth-child(2),#fundsTable td:nth-child(2){width:90px!important;max-width:90px!important;overflow:hidden;text-overflow:ellipsis}#fundsTable th:nth-child(3),#fundsTable td:nth-child(3){width:45px!important}#fundsTable th:nth-child(4),#fundsTable td:nth-child(4),#fundsTable th:nth-child(5),#fundsTable td:nth-child(5),#fundsTable th:nth-child(6),#fundsTable td:nth-child(6),#fundsTable th:nth-child(7),#fundsTable td:nth-child(7),#fundsTable th:nth-child(8),#fundsTable td:nth-child(8),#fundsTable th:nth-child(11),#fundsTable td:nth-child(11){width:70px!important}#fundsTable th:nth-child(9),#fundsTable td:nth-child(9),#fundsTable th:nth-child(10),#fundsTable td:nth-child(10){width:50px!important}thead tr th:last-child,tbody tr td:last-child{display:none}.table-tags{display:none!important}tbody tr:last-child{border-top:2px solid var(--color-primary);border-bottom:2px solid var(--color-primary);background:#f0f0f0!important;-webkit-print-color-adjust:exact;print-color-adjust:exact}.positive{color:var(--color-success)!important;-webkit-print-color-adjust:exact;print-color-adjust:exact}.negative{color:var(--color-danger)!important;-webkit-print-color-adjust:exact;print-color-adjust:exact}@page{size:landscape;margin:.5in}#timelinePanel:not(.expanded){display:none!important}}.sidebar-overlay{position:fixed;top:0;left:0;width:100%;height:100%;background:#00000080;z-index:9998;opacity:0;visibility:hidden;transition:opacity .3s ease,visibility .3s ease}.sidebar-overlay.show{opacity:1;visibility:visible}.sidebar{position:fixed;top:0;right:-320px;width:320px;height:100%;background:var(--color-white);box-shadow:-2px 0 8px #00000026;z-index:9999;transition:right .3s ease;display:flex;flex-direction:column}.sidebar.show{right:0}.sidebar-header{display:flex;justify-content:space-between;align-items:center;padding:20px;border-bottom:1px solid var(--color-border);background:var(--color-hover-bg)}.sidebar-header h3{margin:0;color:var(--color-primary);font-size:18px;font-weight:600}.sidebar-close{background:none;border:none;font-size:28px;color:var(--color-secondary-hover);cursor:pointer;padding:0;width:30px;height:30px;display:flex;align-items:center;justify-content:center;border-radius:var(--radius-sm);transition:var(--transition-medium)}.sidebar-close:hover{background:var(--color-border);color:var(--color-primary)}.sidebar-content{flex:1;overflow-y:auto;padding:10px 0}.sidebar-section{margin-bottom:10px}.sidebar-section-title{padding:12px 20px 8px;margin:0;font-size:12px;font-weight:600;color:var(--color-secondary-hover);text-transform:uppercase;letter-spacing:.5px}.sidebar-item{padding:0}.sidebar-item a{display:flex;align-items:center;gap:12px;padding:12px 20px;color:var(--color-primary);text-decoration:none;transition:var(--transition-medium);cursor:pointer;font-size:14px}.sidebar-item a:hover{background:var(--color-hover-bg)}.sidebar-checkbox-label{display:flex;align-items:center;gap:12px;padding:12px 20px;cursor:pointer;transition:var(--transition-medium);font-size:14px}.sidebar-checkbox-label:hover{background:var(--color-hover-bg)}.sidebar-checkbox-label input[type=checkbox]{width:18px;height:18px;cursor:pointer;margin:0}.sidebar-checkbox-label span{color:var(--color-primary);flex:1}body.sidebar-open{overflow:hidden}[data-mask-accounts=true] #fundsTable th:nth-child(2),[data-mask-accounts=true] #fundsTable td:nth-child(2){display:none}.grouped-fund-row td:first-child{font-weight:600}.grouped-fund-row .investor-count{font-size:.85em;color:var(--color-text-light);font-weight:400}.table-loading-row td{text-align:center;padding:40px;color:var(--color-text-light)}.table-loading-content{display:flex;flex-direction:column;align-items:center;gap:12px}.table-loading-spinner{width:24px;height:24px;border:3px solid var(--color-border);border-top-color:var(--color-action);border-radius:50%;animation:spin .8s linear infinite}.table-loading-text{font-size:14px}.header-toggle{font-size:14px;padding:2px 6px;border-radius:var(--radius-sm);transition:var(--transition-fast);background:transparent;color:var(--color-white);opacity:.7}.header-toggle:hover{opacity:1;background:#ffffff1a}.header-toggle.active{background-color:var(--color-action);color:#fff;opacity:1}[data-theme=dark] .header-toggle{color:var(--color-text)}[data-theme=dark] .header-toggle.active{background-color:var(--color-action);color:#fff}.grouped-group-row td:first-child{font-weight:600;padding-left:var(--group-indent, 8px)}.group-name-cell{display:flex;align-items:center;gap:6px}.group-name-cell .group-name{font-weight:600}.group-name-cell .btn-expand{background:none;border:none;cursor:pointer;padding:2px 4px;font-size:10px;color:var(--color-text-light);border-radius:var(--radius-sm);transition:var(--transition-fast);line-height:1;min-width:18px;text-align:center}.group-name-cell .btn-expand:hover{background:var(--color-hover-bg);color:var(--color-text)}.group-name-cell .expand-placeholder{display:inline-block;width:18px;font-size:10px;color:transparent}.group-type-badge{font-size:.75em;font-weight:400;color:var(--color-text-light);background:var(--color-alt-bg);padding:2px 6px;border-radius:var(--radius-sm);margin-left:6px}[data-theme=dark] .group-type-badge{background:var(--color-hover-bg)}.grouped-group-row.depth-0{background-color:var(--color-alt-bg)}.grouped-group-row.depth-1{background-color:var(--color-white)}.grouped-group-row.depth-2{background-color:var(--color-hover-bg)}[data-theme=dark] .grouped-group-row.depth-0{background-color:#ffffff08}[data-theme=dark] .grouped-group-row.depth-1{background-color:var(--color-white)}[data-theme=dark] .grouped-group-row.depth-2{background-color:#ffffff05}.grouped-group-row.no-group td:first-child .group-name{font-style:italic;color:var(--color-text-light)}</style>
</head>
<body>
    <!-- Skip to main content for keyboard/screen reader users -->
    <a href="#mainContent" class="skip-link">Skip to main content</a>

    <!-- Screen reader announcements for dynamic content updates -->
    <div id="srAnnounce" class="sr-announce" aria-live="polite" aria-atomic="true"></div>

    <!-- Toast container for stacking notifications -->
    <div id="toastContainer" class="toast-container" aria-live="polite"></div>

    <!-- Loading Overlay -->
    <div id="loadingOverlay" class="loading-overlay" role="dialog" aria-labelledby="loadingText" aria-modal="true">
        <div class="loading-content">
            <div class="loading-spinner" aria-hidden="true"></div>
            <div class="loading-text" id="loadingText">Loading...</div>
        </div>
    </div>

    <div class="container" role="main">
        <header role="banner">
            <h1 id="headerTitle">PE Fund Manager</h1>
            <p id="headerSubtitle">Private Equity Fund Analytics & Management Tool</p>
        </header>

        <div class="controls-bar" role="search" aria-label="Filter and search controls">
            <div class="control-group">
                <label id="groupFilterLabel">Filter by Group</label>
                <div class="multi-select" id="groupFilter" data-placeholder="All Groups">
                    <div class="multi-select-trigger" tabindex="0" role="combobox" aria-expanded="false" aria-haspopup="listbox" aria-labelledby="groupFilterLabel">
                        <span class="multi-select-display"><span class="placeholder">All Groups</span></span>
                        <span class="multi-select-arrow">&#9662;</span>
                    </div>
                    <div class="multi-select-dropdown" role="listbox"></div>
                </div>
            </div>
            <div class="control-group">
                <label id="fundFilterLabel">Filter by Fund</label>
                <div class="multi-select" id="fundFilter" data-placeholder="All Funds">
                    <div class="multi-select-trigger" tabindex="0" role="combobox" aria-expanded="false" aria-haspopup="listbox" aria-labelledby="fundFilterLabel">
                        <span class="multi-select-display"><span class="placeholder">All Funds</span></span>
                        <span class="multi-select-arrow">&#9662;</span>
                    </div>
                    <div class="multi-select-dropdown" role="listbox"></div>
                </div>
            </div>
            <div class="control-group">
                <label id="accountFilterLabel">Filter by Account</label>
                <div class="multi-select" id="accountFilter" data-placeholder="All Accounts">
                    <div class="multi-select-trigger" tabindex="0" role="combobox" aria-expanded="false" aria-haspopup="listbox" aria-labelledby="accountFilterLabel">
                        <span class="multi-select-display"><span class="placeholder">All Accounts</span></span>
                        <span class="multi-select-arrow">&#9662;</span>
                    </div>
                    <div class="multi-select-dropdown" role="listbox"></div>
                </div>
            </div>
            <div class="control-group">
                <label id="vintageFilterLabel">Filter by Vintage</label>
                <div class="multi-select" id="vintageFilter" data-placeholder="All Vintages">
                    <div class="multi-select-trigger" tabindex="0" role="combobox" aria-expanded="false" aria-haspopup="listbox" aria-labelledby="vintageFilterLabel">
                        <span class="multi-select-display"><span class="placeholder">All Vintages</span></span>
                        <span class="multi-select-arrow">&#9662;</span>
                    </div>
                    <div class="multi-select-dropdown" role="listbox"></div>
                </div>
            </div>
            <div class="control-group">
                <label id="tagFilterLabel">Filter by Tag</label>
                <div class="multi-select" id="tagFilter" data-placeholder="All Tags">
                    <div class="multi-select-trigger" tabindex="0" role="combobox" aria-expanded="false" aria-haspopup="listbox" aria-labelledby="tagFilterLabel">
                        <span class="multi-select-display"><span class="placeholder">All Tags</span></span>
                        <span class="multi-select-arrow">&#9662;</span>
                    </div>
                    <div class="multi-select-dropdown" role="listbox"></div>
                </div>
            </div>
            <div class="control-group">
                <label for="cutoffDate" title="Calculate all metrics (IRR, MOIC, NAV, etc.) as of this date">Cutoff Date</label>
                <input type="date" id="cutoffDate" title="Calculate all metrics (IRR, MOIC, NAV, etc.) as of this date" aria-label="Cutoff date for calculating metrics">
            </div>
            <span id="activeFiltersIndicator" class="filter-badge" aria-live="polite"></span>
            <div id="filterLoading" class="filter-loading" aria-live="polite">
                <div class="filter-loading-spinner" aria-hidden="true"></div>
                <span>Filtering...</span>
            </div>
            <div class="ml-auto">
                <button class="btn-icon btn-icon-lg" id="toggleSidebarBtn" title="Settings and Actions" aria-label="Open settings sidebar">&#9776;</button>
            </div>
        </div>

        <div class="content" id="mainContent">
            <div id="portfolioSummary" class="portfolio-summary">
                <div class="summary-stat">
                    <span class="summary-label">Investments</span>
                    <span class="summary-value" id="summaryInvestmentCount">0</span>
                </div>
                <div class="summary-stat">
                    <span class="summary-label">Funds</span>
                    <span class="summary-value" id="summaryFundCount">0</span>
                </div>
                <div class="summary-stat">
                    <span class="summary-label">Total Commitment</span>
                    <span class="summary-value" id="summaryCommitment">$0</span>
                </div>
                <div class="summary-stat">
                    <span class="summary-label">Total NAV</span>
                    <span class="summary-value" id="summaryNav">$0</span>
                </div>
                <div class="summary-stat">
                    <div class="summary-label-container">
                        <span class="summary-label">Avg IRR</span>
                        <span class="info-icon" aria-label="IRR explanation">?<span class="tooltip">Internal Rate of Return: The annualized return rate that makes the net present value of all cash flows equal to zero. Higher is better.</span></span>
                    </div>
                    <span class="summary-value" id="summaryIRR">N/A</span>
                </div>
                <div class="summary-stat">
                    <div class="summary-label-container">
                        <span class="summary-label">Avg MOIC</span>
                        <span class="info-icon" aria-label="MOIC explanation">?<span class="tooltip">Multiple on Invested Capital: Total value (distributions + NAV) divided by total contributions. A MOIC of 2.0x means you doubled your money.</span></span>
                    </div>
                    <span class="summary-value" id="summaryMOIC">N/A</span>
                </div>
                <div class="summary-stat">
                    <div class="summary-label-container">
                        <span class="summary-label">DPI</span>
                        <span class="info-icon" aria-label="DPI explanation">?<span class="tooltip">Distributions to Paid-In: Total distributions divided by total contributions. Measures actual cash returned to investors.</span></span>
                    </div>
                    <span class="summary-value" id="summaryDPI">N/A</span>
                </div>
                <div class="summary-stat">
                    <div class="summary-label-container">
                        <span class="summary-label">RVPI</span>
                        <span class="info-icon" aria-label="RVPI explanation">?<span class="tooltip">Residual Value to Paid-In: Current NAV divided by total contributions. Represents unrealized value still held in the fund.</span></span>
                    </div>
                    <span class="summary-value" id="summaryRVPI">N/A</span>
                </div>
                <div class="summary-stat">
                    <div class="summary-label-container">
                        <span class="summary-label">TVPI</span>
                        <span class="info-icon" aria-label="TVPI explanation">?<span class="tooltip">Total Value to Paid-In: DPI + RVPI. The most comprehensive measure of fund performance.</span></span>
                    </div>
                    <span class="summary-value" id="summaryTVPI">N/A</span>
                </div>
            </div>

            <div id="timelinePanel" class="timeline-panel">
                <div class="timeline-header" id="timelineHeader">
                    <h3>
                        <span>Cash Flow Timeline</span>
                        <span class="timeline-label">(Historical + Projected)</span>
                    </h3>
                    <div class="timeline-header-actions">
                        <button id="timelineExportCSV" class="btn-timeline-export" title="Export timeline to CSV">Export CSV</button>
                        <span class="timeline-toggle">&#9660;</span>
                    </div>
                </div>
                <div class="timeline-content">
                    <div id="timelineTableContainer">
                        <p class="timeline-no-data">No investments to display yet.</p>
                    </div>
                </div>
            </div>

            <div class="table-container">
                <table id="fundsTable">
                    <thead>
                        <tr>
                            <th data-sort="fundName">Fund Name</th>
                            <th data-sort="accountNumber" class="center">Investor</th>
                            <th data-sort="vintage" class="center">Vintage</th>
                            <th data-sort="commitment" class="center number">Commitment</th>
                            <th data-sort="totalContributions" class="center number">Contributions</th>
                            <th data-sort="totalDistributions" class="center number">Distributions</th>
                            <th data-sort="nav" class="center number">Value (NAV)</th>
                            <th data-sort="investmentReturn" class="center number wrap-header">Investment<br>Return</th>
                            <th data-sort="moic" class="center number">MOIC</th>
                            <th data-sort="irr" class="center number">IRR</th>
                            <th data-sort="outstandingCommitment" class="center number wrap-header">Outstanding<br>Commitment</th>
                            <th class="center">
                                <button id="groupByFundToggle" class="btn-icon header-toggle" title="Group by Fund (Σ)" aria-label="Toggle group by fund">Σ</button>
                            </th>
                        </tr>
                    </thead>
                    <tbody id="fundsTableBody"></tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- Fund Add/Edit Modal -->
    <div id="fundModal" class="modal">
        <div class="modal-content">
            <button type="button" class="btn-close" id="closeFundModalBtn" aria-label="Close">&times;</button>
            <h2 id="fundModalTitle">Add New Investment</h2>
            <form id="fundForm">
                <input type="hidden" id="fundId">
                <input type="hidden" id="isDuplicate">
                <div class="form-group">
                    <label for="fundName">Fund Name *</label>
                    <select id="fundName" required></select>
                    <div id="newFundNameContainer" class="hidden mt-md">
                        <div class="d-flex gap-sm">
                            <input type="text" id="newFundNameInline" placeholder="Enter new fund name" class="flex-1">
                            <button type="button" class="btn-primary btn-compact" id="addNewFundNameBtn">Add</button>
                            <button type="button" class="btn-secondary btn-compact" id="cancelNewFundNameBtn">Cancel</button>
                        </div>
                    </div>
                </div>
                <div class="form-group">
                    <label for="accountNumber">Account Number *</label>
                    <input type="text" id="accountNumber" required>
                </div>
                <div class="form-group">
                    <label for="fundGroup">Group (optional)</label>
                    <div class="searchable-select" id="fundGroupContainer" data-placeholder="No Group">
                        <input type="hidden" id="fundGroup" value="">
                        <div class="searchable-select-trigger" tabindex="0" aria-haspopup="listbox" aria-expanded="false">
                            <span class="searchable-select-display">No Group</span>
                            <span class="searchable-select-arrow"></span>
                        </div>
                        <div class="searchable-select-dropdown">
                            <div class="searchable-select-search">
                                <input type="text" placeholder="Search groups..." aria-label="Search groups">
                            </div>
                            <div class="searchable-select-options"></div>
                            <div class="searchable-select-no-results">No matches found</div>
                        </div>
                    </div>
                </div>
                <div class="form-group">
                    <label for="commitment">Commitment (USD) *</label>
                    <input type="text" id="commitment" required placeholder="e.g., 1,000,000">
                </div>
                <div id="duplicateMultiplierContainer" class="form-group hidden">
                    <label for="duplicateMultiplier">Duplicate Multiplier</label>
                    <input type="number" id="duplicateMultiplier" step="any" value="1">
                </div>
                <div class="form-actions">
                    <button type="button" class="btn-secondary" id="cancelFundModalBtn">Cancel</button>
                    <button type="submit" class="btn-primary" id="saveFundBtn">Save</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Action Dropdown -->
    <div id="actionDropdown" class="action-dropdown">
        <a href="#" id="actionEdit">Edit</a>
        <a href="#" id="actionDuplicate">Duplicate</a>
        <a href="#" id="actionViewDetails">View Details</a>
        <a href="#" id="actionDelete" class="danger-action">Delete</a>
    </div>

    <!-- Manage Fund Names Modal -->
    <div id="manageFundNamesModal" class="modal">
        <div class="modal-content">
            <button type="button" class="btn-close" id="closeManageFundsModalBtn" aria-label="Close">&times;</button>
            <h2>Manage Fund Names</h2>
            <div class="form-group">
                <label for="newFundNameInput">Add New Fund Name</label>
                <input type="text" id="newFundNameInput" placeholder="Enter fund name">
            </div>
            <details id="newFundTermsDetails" class="mb-md">
                <summary class="fund-terms-toggle">+ Add Fund Terms (optional)</summary>
                <div class="fund-terms-panel">
                    <div class="form-group mb-sm">
                        <label for="newFundTermStartDate" class="text-xs">Investment Term Start Date</label>
                        <input type="date" id="newFundTermStartDate">
                    </div>
                    <div class="form-group">
                        <label for="newFundInvestmentTerm" class="text-xs">Investment Term (years)</label>
                        <input type="number" id="newFundInvestmentTerm" min="1" max="15" step="1" placeholder="e.g., 5">
                    </div>
                </div>
            </details>
            <button class="btn-primary btn-full" id="addNewFundNameModalBtn">Add Fund Name</button>
            <hr class="section-divider">
            <h3 class="section-title">Existing Fund Names</h3>
            <div id="fundNamesList"></div>
            <div class="form-actions">
                <button class="btn-secondary" id="closeManageFundsModal2Btn">Close</button>
            </div>
        </div>
    </div>

    <!-- Edit Fund Name Modal -->
    <div id="editFundNameModal" class="modal">
        <div class="modal-content">
            <button type="button" class="btn-close" id="closeEditFundNameModalBtn" aria-label="Close">&times;</button>
            <h2>Edit Fund</h2>
            <input type="hidden" id="editFundNameOriginal" value="">
            <div class="form-group">
                <label for="editFundNameInput">Fund Name</label>
                <input type="text" id="editFundNameInput" placeholder="Enter fund name">
            </div>
            <div class="form-group">
                <label for="editFundTags">Tags (optional)</label>
                <div id="editFundTagsContainer" class="tags-container"></div>
                <input type="text" id="editFundTagsInput" placeholder="Add tag (e.g., Venture Capital, Growth Equity)" list="editFundTagsDatalist">
                <datalist id="editFundTagsDatalist"></datalist>
                <div class="hint">Press Enter to add tags. Click x on a tag to remove it.</div>
            </div>
            <h3 class="section-title-bordered">Fund Terms</h3>
            <div class="form-group">
                <label for="editFundTermStartDate">Investment Term Start Date</label>
                <input type="date" id="editFundTermStartDate">
            </div>
            <div class="form-group">
                <label for="editFundInvestmentTerm">Investment Term (years)</label>
                <input type="number" id="editFundInvestmentTerm" min="1" max="15" step="1" placeholder="e.g., 5">
                <div class="hint">Number of years from term start during which capital can be called</div>
            </div>
            <div class="form-actions">
                <button class="btn-secondary" id="cancelEditFundNameBtn">Cancel</button>
                <button class="btn-primary" id="saveEditedFundNameBtn">Save Changes</button>
            </div>
        </div>
    </div>

    <!-- Manage Groups Modal -->
    <div id="manageGroupsModal" class="modal modal-md">
        <div class="modal-content">
            <button type="button" class="btn-close" id="closeManageGroupsModal2Btn" aria-label="Close">&times;</button>
            <h2>Manage Account Groups</h2>
            <input type="hidden" id="editGroupId" value="">
            <h3 id="groupFormTitle" class="section-title">Add New Group</h3>
            <div class="form-group">
                <label for="newGroupName">Group Name</label>
                <input type="text" id="newGroupName" placeholder="e.g., John Smith, Smith Family Trust">
                <small class="small-hint">Use groups to organize by account holder or entity</small>
            </div>
            <div class="form-group">
                <label>Parent Group (optional)</label>
                <div class="searchable-select" id="newGroupParentContainer" data-placeholder="None (Top Level)">
                    <input type="hidden" id="newGroupParent" value="">
                    <div class="searchable-select-trigger" tabindex="0" aria-haspopup="listbox" aria-expanded="false">
                        <span class="searchable-select-display">None (Top Level)</span>
                        <span class="searchable-select-arrow"></span>
                    </div>
                    <div class="searchable-select-dropdown">
                        <div class="searchable-select-search">
                            <input type="text" placeholder="Search groups..." aria-label="Search groups">
                        </div>
                        <div class="searchable-select-options"></div>
                        <div class="searchable-select-no-results">No matches found</div>
                    </div>
                </div>
            </div>
            <div class="form-group">
                <label for="newGroupType">Type (optional)</label>
                <select id="newGroupType">
                    <option value="">Select type...</option>
                    <option value="Household">Household</option>
                    <option value="Client">Client</option>
                    <option value="Revocable Trust">Revocable Trust</option>
                    <option value="Irrevocable Trust">Irrevocable Trust</option>
                    <option value="Retirement Account">Retirement Account</option>
                    <option value="Other">Other</option>
                </select>
            </div>
            <div class="d-flex gap-md">
                <button id="saveGroupBtn" class="btn-primary">Add Group</button>
                <button id="cancelEditBtn" class="btn-secondary hidden">Cancel</button>
            </div>
            <hr class="section-divider">
            <h3 class="section-title">Existing Groups</h3>
            <div id="groupsList" class="groups-list"></div>
            <div class="form-actions">
                <button class="btn-secondary" id="closeManageGroupsModalBtn">Close</button>
            </div>
        </div>
    </div>

    <!-- Details Modal -->
    <div id="detailsModal" class="modal modal-xl">
        <div class="modal-content">
            <button type="button" class="btn-close" id="closeDetailsModalBtn" aria-label="Close">&times;</button>
            <h2 id="detailsModalTitle">Fund Details</h2>
            <p id="detailsModalSubtitle" class="modal-subtitle"></p>
            <div id="detailsSummary" class="portfolio-summary mt-lg">
                <div class="summary-stat"><span class="summary-label">Total Commitment</span><span class="summary-value" id="detailsSummaryCommitment">$0</span></div>
                <div class="summary-stat"><span class="summary-label">Contributions</span><span class="summary-value" id="detailsSummaryContributions">$0</span></div>
                <div class="summary-stat"><span class="summary-label">Distributions</span><span class="summary-value" id="detailsSummaryDistributions">$0</span></div>
                <div class="summary-stat"><span class="summary-label">Current Value</span><span class="summary-value" id="detailsSummaryValue">$0</span></div>
                <div class="summary-stat"><span class="summary-label">Investment Return</span><span class="summary-value" id="detailsSummaryReturn">$0</span></div>
                <div class="summary-stat"><span class="summary-label">Outstanding Commitment</span><span class="summary-value" id="detailsSummaryOutstanding">$0</span></div>
            </div>
            <h3 class="section-title mt-lg">Cash Flows</h3>
            <div class="details-table-wrapper">
                <table class="details-table" id="cashFlowsTable">
                    <thead><tr><th>Date</th><th class="number">Amount (USD)</th><th class="center">Type</th><th class="center">Affects Commitment?</th><th></th></tr></thead>
                    <tbody></tbody>
                </table>
            </div>
            <button type="button" class="btn-primary btn-sm mt-md" id="addCashFlowRowBtn">Add Cash Flow</button>
            <h3 class="section-title" style="margin-top: 30px;">Values</h3>
            <div class="details-table-wrapper">
                <table class="details-table" id="navTable">
                    <thead><tr><th>Date</th><th>Amount (USD)</th><th></th></tr></thead>
                    <tbody></tbody>
                </table>
            </div>
            <button type="button" class="btn-primary btn-sm mt-md" id="addNavRowBtn">Add Value</button>
            <div class="form-actions">
                <button class="btn-secondary" id="cancelDetailsModalBtn">Cancel</button>
                <button class="btn-primary" id="saveDetailsChangesBtn">Save Changes</button>
            </div>
        </div>
    </div>

    <!-- Backup Warning Modal -->
    <div id="backupWarningModal" class="modal modal-sm">
        <div class="modal-content">
            <button type="button" class="btn-close" id="closeBackupWarningBtn" aria-label="Close">&times;</button>
            <h2 class="text-warning mb-md">Important: Backup Your Data</h2>
            <p class="backup-warning-text">Your PE Fund Manager data is stored <strong>locally in your browser</strong>. This means your data could be lost if:</p>
            <ul class="backup-warning-list">
                <li>You clear your browser cache or cookies</li>
                <li>You uninstall your browser</li>
                <li>Your computer crashes or is reset</li>
                <li>You switch to a different device</li>
            </ul>
            <p class="backup-warning-cta">Please export your data regularly to avoid data loss!</p>
            <div class="form-group">
                <label class="checkbox-label"><input type="checkbox" id="dontShowBackupWarning">Don't show this warning again</label>
            </div>
            <div class="form-actions">
                <button class="btn-secondary" id="remindLaterBtn">Remind Me Later</button>
                <button class="btn-success" id="exportNowBtn">Export Now</button>
            </div>
        </div>
    </div>

    <!-- Health Check Modal -->
    <div id="healthCheckModal" class="modal health-check-modal">
        <div class="modal-content health-check-content">
            <button type="button" class="btn-close" id="closeHealthCheckModalBtn" aria-label="Close">&times;</button>
            <h2>Data Health Check</h2>
            <div id="healthCheckSummary" class="health-check-summary"></div>
            <div id="healthCheckResults" class="health-check-results"></div>
            <div class="form-actions">
                <button class="btn-secondary" id="closeHealthCheckModal2Btn">Close</button>
            </div>
        </div>
    </div>

    <!-- Keyboard Shortcuts Modal -->
    <div id="shortcutsModal" class="modal shortcuts-modal">
        <div class="modal-content">
            <button type="button" class="btn-close" id="closeShortcutsModalBtn" aria-label="Close">&times;</button>
            <h2>Keyboard Shortcuts</h2>
            <div class="shortcuts-list">
                <div class="shortcut-key"><kbd>?</kbd></div><div class="shortcut-desc">Show this help</div>
                <div class="shortcut-key"><kbd>Ctrl</kbd> + <kbd>N</kbd></div><div class="shortcut-desc">Add new investment</div>
                <div class="shortcut-key"><kbd>Ctrl</kbd> + <kbd>E</kbd></div><div class="shortcut-desc">Export to JSON</div>
                <div class="shortcut-key"><kbd>Ctrl</kbd> + <kbd>S</kbd></div><div class="shortcut-desc">Save (in details modal)</div>
                <div class="shortcut-key"><kbd>Esc</kbd></div><div class="shortcut-desc">Close modal/sidebar</div>
            </div>
            <div class="form-actions"><button class="btn-secondary" id="closeShortcutsModal2Btn">Close</button></div>
        </div>
    </div>

    <!-- Confirm Modal -->
    <div id="confirmModal" class="modal confirm-modal">
        <div class="modal-content confirm-modal-content">
            <button type="button" class="btn-close" id="closeConfirmModalBtn" aria-label="Close">&times;</button>
            <h2 id="confirmModalTitle">Confirm</h2>
            <p id="confirmModalMessage" class="confirm-modal-message"></p>
            <div class="form-actions">
                <button class="btn-secondary" id="confirmModalCancelBtn">Cancel</button>
                <button class="btn-danger" id="confirmModalConfirmBtn">Confirm</button>
            </div>
        </div>
    </div>

    <!-- Bulk Cash Flow Modal -->
    <div id="bulkCashFlowModal" class="modal modal-md">
        <div class="modal-content">
            <button type="button" class="btn-close" id="closeBulkCashFlowModalBtn" aria-label="Close">&times;</button>
            <h2>Bulk Cash Flow</h2>
            <p class="modal-description">Add a cash flow to all investors in a fund based on a percentage of their commitment.</p>
            <div class="form-group"><label for="bulkCashFlowFundName">Fund Name *</label><select id="bulkCashFlowFundName" required><option value="">Select a fund</option></select></div>
            <div class="form-group"><label for="bulkCashFlowDate">Date *</label><input type="date" id="bulkCashFlowDate" required></div>
            <div class="form-group"><label for="bulkCashFlowType">Type *</label><select id="bulkCashFlowType" required><option value="Contribution">Contribution (Capital Call)</option><option value="Distribution">Distribution</option><option value="Adjustment">Adjustment</option></select></div>
            <div class="form-group"><label for="bulkCashFlowPercentage">Percentage of Commitment *</label><input type="number" id="bulkCashFlowPercentage" step="0.01" min="0.01" max="100" placeholder="e.g., 4.5" required><div class="hint">Enter percentage (e.g., 4.5 for 4.5%)</div></div>
            <div class="form-group"><label><input type="checkbox" id="bulkCashFlowAffectsCommitment" checked>Affects unfunded commitment</label></div>
            <div id="bulkCashFlowPreview" class="preview-container"><h4 class="preview-title">Preview</h4><div id="bulkCashFlowPreviewContent"></div></div>
            <div class="form-actions">
                <button type="button" class="btn-secondary" id="cancelBulkCashFlowBtn">Cancel</button>
                <button type="button" class="btn-secondary" id="previewBulkCashFlowBtn">Preview</button>
                <button type="button" class="btn-primary" id="applyBulkCashFlowBtn" disabled>Apply</button>
            </div>
        </div>
    </div>

    <!-- Bulk Remove Fund Modal -->
    <div id="bulkRemoveFundModal" class="modal modal-md">
        <div class="modal-content">
            <button type="button" class="btn-close" id="closeBulkRemoveFundModalBtn" aria-label="Close">&times;</button>
            <h2>Bulk Remove Fund</h2>
            <p class="modal-description">Remove all investor positions for a selected fund. This action cannot be undone.</p>
            <div class="form-group"><label for="bulkRemoveFundName">Fund Name *</label><select id="bulkRemoveFundName" required><option value="">Select a fund</option></select></div>
            <div id="bulkRemoveFundPreview" class="preview-container"><h4 class="preview-title-danger">The following investors will be removed:</h4><div id="bulkRemoveFundPreviewContent"></div></div>
            <div class="form-actions">
                <button type="button" class="btn-secondary" id="cancelBulkRemoveFundBtn">Cancel</button>
                <button type="button" class="btn-secondary" id="previewBulkRemoveFundBtn">Preview</button>
                <button type="button" class="btn-danger" id="applyBulkRemoveFundBtn" disabled>Remove All</button>
            </div>
        </div>
    </div>

    <!-- Bulk Assign Group Modal -->
    <div id="bulkAssignGroupModal" class="modal modal-md">
        <div class="modal-content">
            <button type="button" class="btn-close" id="closeBulkAssignGroupModalBtn" aria-label="Close">&times;</button>
            <h2>Bulk Assign Group</h2>
            <p class="modal-description">Assign all investments with a specific account number to a group.</p>
            <div class="form-group"><label for="bulkAssignGroupAccount">Account Number *</label><select id="bulkAssignGroupAccount" required><option value="">Select an account</option></select></div>
            <div class="form-group"><label for="bulkAssignGroupTarget">Target Group *</label><select id="bulkAssignGroupTarget" required><option value="">No Group</option></select></div>
            <div id="bulkAssignGroupPreview" class="preview-container"><h4 class="preview-title">The following investments will be updated:</h4><div id="bulkAssignGroupPreviewContent"></div></div>
            <div class="form-actions">
                <button type="button" class="btn-secondary" id="cancelBulkAssignGroupBtn">Cancel</button>
                <button type="button" class="btn-secondary" id="previewBulkAssignGroupBtn">Preview</button>
                <button type="button" class="btn-primary" id="applyBulkAssignGroupBtn" disabled>Apply</button>
            </div>
        </div>
    </div>

    <!-- Import Preview Modal -->
    <div id="importPreviewModal" class="modal modal-lg">
        <div class="modal-content">
            <button type="button" class="btn-close" id="closeImportPreviewModalBtn" aria-label="Close">&times;</button>
            <h2>Import Preview</h2>
            <p class="modal-description">Review the data to be imported before confirming.</p>
            <div id="importPreviewContent" class="import-preview-container"><p class="text-muted">Select a JSON file to preview...</p></div>
            <div class="form-actions">
                <button type="button" class="btn-secondary btn-min-width" id="cancelImportPreviewBtn">Cancel</button>
                <label for="importPreviewFileInput" class="btn-secondary btn-file-input">Choose File</label>
                <input type="file" id="importPreviewFileInput" accept=".json" class="hidden">
                <button type="button" class="btn-primary btn-min-width" id="applyImportBtn" disabled>Import</button>
            </div>
        </div>
    </div>

    <!-- Sync Account Groups Modal -->
    <div id="syncAccountGroupsModal" class="modal modal-lg">
        <div class="modal-content">
            <button type="button" class="btn-close" id="closeSyncAccountGroupsModalBtn" aria-label="Close">&times;</button>
            <h2>Sync Account Groups</h2>
            <p class="modal-description">Review account numbers with inconsistent group assignments. Apply sync to ensure all investments with the same account number share the same group.</p>
            <div id="syncAccountGroupsContent" class="sync-content"></div>
            <div class="form-actions">
                <button type="button" class="btn-secondary btn-min-width" id="cancelSyncAccountGroupsBtn">Cancel</button>
                <button type="button" class="btn-primary btn-min-width" id="applySyncAccountGroupsBtn" disabled>Apply Sync</button>
            </div>
        </div>
    </div>

    <!-- Sidebar Panel -->
    <div id="sidebarOverlay" class="sidebar-overlay"></div>
    <div id="sidebar" class="sidebar">
        <div class="sidebar-header">
            <h3>Settings & Actions</h3>
            <button class="sidebar-close" id="closeSidebarBtn" title="Close">&times;</button>
        </div>
        <div class="sidebar-content">
            <div class="sidebar-section">
                <h4 class="sidebar-section-title">View Options</h4>
                <div class="sidebar-item"><label class="sidebar-checkbox-label"><input type="checkbox" id="sidebarShowTagsCheckbox" checked><span>Show Tags</span></label></div>
                <div class="sidebar-item"><label class="sidebar-checkbox-label"><input type="checkbox" id="sidebarMaskAccountsCheckbox"><span>Mask Accounts</span></label></div>
                <div class="sidebar-item"><label class="sidebar-checkbox-label"><input type="checkbox" id="sidebarGroupByGroupCheckbox"><span>Group by Group</span></label></div>
                <div class="sidebar-item"><label class="sidebar-checkbox-label"><input type="checkbox" id="sidebarDarkModeCheckbox"><span>Dark Mode</span></label></div>
            </div>
            <div class="sidebar-section">
                <h4 class="sidebar-section-title">Manage</h4>
                <div class="sidebar-item"><a href="#" id="sidebarNewInvestment">New Investment</a></div>
                <div class="sidebar-item"><a href="#" id="sidebarManageFunds">Manage Funds</a></div>
                <div class="sidebar-item"><a href="#" id="sidebarManageGroups">Manage Groups</a></div>
                <div class="sidebar-item"><a href="#" id="sidebarBulkCashFlow">Bulk Cash Flow</a></div>
                <div class="sidebar-item"><a href="#" id="sidebarBulkAssignGroup">Bulk Assign Group</a></div>
            </div>
            <div class="sidebar-section">
                <h4 class="sidebar-section-title">Data</h4>
                <div class="sidebar-item"><a href="#" id="sidebarExportCSV">Export to CSV</a></div>
                <div class="sidebar-item"><a href="#" id="sidebarExportJSON">Export to JSON</a></div>
                <div class="sidebar-item"><a href="#" id="sidebarExportPDF">Export to PDF</a></div>
                <div class="sidebar-item"><a href="#" id="sidebarImportJSON">Import JSON</a></div>
            </div>
            <div class="sidebar-section">
                <h4 class="sidebar-section-title">Admin</h4>
                <div class="sidebar-item"><a href="#" id="sidebarHealthCheck">Data Health Check</a></div>
                <div class="sidebar-item"><a href="#" id="sidebarSyncAccountGroups">Sync Account Groups</a></div>
                <div class="sidebar-item"><a href="#" id="sidebarLoadSampleData">Load Sample Data</a></div>
                <div class="sidebar-item"><a href="#" id="sidebarBulkRemoveFund" style="color: var(--color-danger);">Bulk Remove Fund</a></div>
                <div class="sidebar-item"><a href="#" id="sidebarClearDatabase" style="color: var(--color-danger);">Clear Database</a></div>
            </div>
        </div>
    </div>

</body>
</html>
