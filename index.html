<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PE Fund Manager</title>
    <meta name="description" content="Private Equity Fund Analytics & Management Tool">
  <script type="module" crossorigin>var Gn=Object.defineProperty;var On=(e,t,n)=>t in e?Gn(e,t,{enumerable:!0,configurable:!0,writable:!0,value:n}):e[t]=n;var O=(e,t,n)=>On(e,typeof t!="symbol"?t+"":t,n);(function(){const t=document.createElement("link").relList;if(t&&t.supports&&t.supports("modulepreload"))return;for(const o of document.querySelectorAll('link[rel="modulepreload"]'))a(o);new MutationObserver(o=>{for(const s of o)if(s.type==="childList")for(const r of s.addedNodes)r.tagName==="LINK"&&r.rel==="modulepreload"&&a(r)}).observe(document,{childList:!0,subtree:!0});function n(o){const s={};return o.integrity&&(s.integrity=o.integrity),o.referrerPolicy&&(s.referrerPolicy=o.referrerPolicy),o.crossOrigin==="use-credentials"?s.credentials="include":o.crossOrigin==="anonymous"?s.credentials="omit":s.credentials="same-origin",s}function a(o){if(o.ep)return;o.ep=!0;const s=n(o);fetch(o.href,s)}})();const b={DB_NAME:"FundsDB",FUNDS_STORE:"funds",FUNDNAMES_STORE:"fundNames",GROUPS_STORE:"groups",AUDIT_STORE:"auditLog",DISMISSED_ISSUES_STORE:"dismissedHealthIssues",DB_VERSION:12,CURRENCY_FORMAT:"en-US",CURRENCY_CODE:"USD",IRR_MAX_ITERATIONS:1e3,IRR_PRECISION:1e-6,IRR_GUESS:.1,IRR_MIN_RATE:-.99,IRR_MAX_RATE:10,IRR_MIN_DAYS:30,DATE_FORMAT:/^\d{4}-\d{2}-\d{2}$/,DEBOUNCE_FILTER:300,DEBOUNCE_SEARCH:300,DEBOUNCE_INPUT:300,MIN_COLUMN_WIDTH:50,MAX_FILE_SIZE:50*1024*1024,FUND_NAME_MIN_LENGTH:2,FUND_NAME_MAX_LENGTH:100,METRICS_CACHE_TTL:5e3,MAX_METRICS_CACHE_SIZE:1e3,LAZY_RENDER_TIMELINE:!0,TABLE_LOADING_DELAY:150,ALLOWED_FUND_NAME_PATTERN:/^[a-zA-Z0-9\s\-_.,&']+$/,MAX_IMPORT_FUNDS:1e4,MAX_IMPORT_GROUPS:1e3,MAX_IMPORT_FUNDNAMES:5e3,MAX_JSON_DEPTH:10,DANGEROUS_KEYS:["__proto__","constructor","prototype"],STORAGE_COLUMN_WIDTHS:"columnWidths",STORAGE_SHOW_TAGS:"showTags",STORAGE_GROUP_BY_FUND:"groupByFund",STORAGE_MASK_ACCOUNTS:"maskAccounts",STORAGE_BACKUP_WARNING:"backupWarningShown",STORAGE_LAST_BACKUP:"lastBackupDate",BACKUP_REMINDER_DAYS:30};class _n{constructor(){O(this,"currentFunds",[]);O(this,"fundNames",new Set);O(this,"fundNameData",new Map);O(this,"groups",[]);O(this,"groupsMap",new Map);O(this,"sortColumns",[]);O(this,"currentActionFundId",null);O(this,"currentDetailsFundId",null);O(this,"hasUnsavedChanges",!1);O(this,"fundModalHasUnsavedChanges",!1);O(this,"dataVersion",0);O(this,"lastHealthCheckVersion",-1);O(this,"dataChangedSinceLastExport",!1);O(this,"lastExportReminderTime",0);O(this,"displayLimit",50);O(this,"displayLimitIncrement",50);O(this,"metricsCache",new Map);O(this,"groupDescendantsCache",new Map);O(this,"ancestorCache",new Map);O(this,"abortController",null)}getFunds(){return this.currentFunds}getGroups(){return this.groups}clearMetricsCache(){this.metricsCache.clear()}getMetricsFromCache(t,n){const a=`${t}-${n}`,o=this.metricsCache.get(a);return o&&Date.now()-o.timestamp<b.METRICS_CACHE_TTL?o.metrics:null}setMetricsCache(t,n,a){const o=`${t}-${n}`;if(this.metricsCache.size>=b.MAX_METRICS_CACHE_SIZE){let s=null,r=1/0;for(const[i,c]of this.metricsCache)c.timestamp<r&&(r=c.timestamp,s=i);s&&this.metricsCache.delete(s)}this.metricsCache.set(o,{metrics:a,timestamp:Date.now()})}setFunds(t){this.currentFunds=t}setGroups(t){this.groups=t,this.groupsMap.clear(),t.forEach(n=>this.groupsMap.set(n.id,n)),this.ancestorCache.clear(),this.groupDescendantsCache.clear()}getGroupByIdSync(t){return this.groupsMap.get(t)}getDirectChildIds(t){const n=[];for(const[a,o]of this.groupsMap)o.parentGroupId===t&&n.push(a);return n}getAncestorIds(t){const n=this.ancestorCache.get(t);if(n)return n;const a=[];let o=t;for(;o!=null;){const s=this.groupsMap.get(o);if(!s)break;a.push(s.id),o=s.parentGroupId}return this.ancestorCache.set(t,a),a}getDescendantIds(t){const n=this.groupDescendantsCache.get(t);if(n)return n;const a=[t];for(const[o,s]of this.groupsMap)if(s.parentGroupId===t){const r=this.getDescendantIds(o);a.push(...r)}return this.groupDescendantsCache.set(t,a),a}clearDescendantCache(){this.groupDescendantsCache.clear()}setUnsavedChanges(t){this.hasUnsavedChanges=t}setFundModalUnsavedChanges(t){this.fundModalHasUnsavedChanges=t}setFundNames(t){this.fundNames=t}setFundNameData(t){this.fundNameData=t}setSortColumns(t){this.sortColumns=t}setCurrentActionFundId(t){this.currentActionFundId=t}setCurrentDetailsFundId(t){this.currentDetailsFundId=t}setAbortController(t){this.abortController=t}markDataChanged(){this.dataVersion++,this.dataChangedSinceLastExport=!0}markDataExported(){this.dataChangedSinceLastExport=!1,this.lastExportReminderTime=Date.now()}needsHealthCheckRefresh(){return this.lastHealthCheckVersion!==this.dataVersion}markHealthCheckRun(){this.lastHealthCheckVersion=this.dataVersion}shouldShowExportReminder(t){return this.dataChangedSinceLastExport?Date.now()-this.lastExportReminderTime>=t:!1}dismissExportReminder(){this.lastExportReminderTime=Date.now()}resetDisplayLimit(){this.displayLimit=50}loadMore(){this.displayLimit+=this.displayLimitIncrement}}const g=new _n;function Pn(e,t){const n=[];if(!e&&t)return[{field:"record",oldValue:null,newValue:"created"}];if(e&&!t)return[{field:"record",oldValue:"existed",newValue:null}];if(!e||!t)return n;const a=new Set([...Object.keys(e),...Object.keys(t)]);for(const o of a){if(o==="id"||o==="timestamp")continue;const s=e[o],r=t[o],i=JSON.stringify(s),c=JSON.stringify(r);i!==c&&n.push({field:o,oldValue:s,newValue:r})}return n}function Un(e){return e.length===0?"No changes":e.map(t=>{if(t.field==="record")return t.newValue==="created"?"Created new record":"Deleted record";const n=a=>{if(a==null)return"empty";const o=typeof a=="object"?JSON.stringify(a):String(a);return o.length>50?o.substring(0,47)+"...":o};return`${t.field}: ${n(t.oldValue)} → ${n(t.newValue)}`}).join("; ")}function P(e){if(typeof e!="string"||!/^\d{4}-\d{2}-\d{2}$/.test(e))return!1;const t=new Date(e+"T00:00:00");if(isNaN(t.getTime()))return!1;const[n,a,o]=e.split("-").map(Number);return t.getFullYear()===n&&t.getMonth()+1===a&&t.getDate()===o}function cn(e){const t=[];if(!e||typeof e!="object")return{valid:!1,errors:["Fund data is required"]};const n=e;return(!n.fundName||typeof n.fundName!="string"||!n.fundName.trim())&&t.push("Fund name is required"),(!n.accountNumber||typeof n.accountNumber!="string"||!n.accountNumber.trim())&&t.push("Account number is required"),typeof n.commitment!="number"?t.push("Commitment must be a number"):isNaN(n.commitment)?t.push("Commitment is NaN (invalid number)"):isFinite(n.commitment)?n.commitment<0&&t.push("Commitment cannot be negative"):t.push("Commitment must be a finite number"),n.cashFlows!==void 0&&(Array.isArray(n.cashFlows)?n.cashFlows.forEach((a,o)=>{if(!a||typeof a!="object"){t.push(`Cash flow at index ${o} is invalid`);return}const s=a;typeof s.amount!="number"?t.push(`Cash flow ${o}: amount must be a number`):isNaN(s.amount)?t.push(`Cash flow ${o}: amount is NaN (invalid number)`):isFinite(s.amount)||t.push(`Cash flow ${o}: amount must be finite`),!s.date||typeof s.date!="string"?t.push(`Cash flow ${o}: date is required`):P(s.date)||t.push(`Cash flow ${o}: invalid date format (expected YYYY-MM-DD)`),s.type?["Contribution","Distribution","Adjustment"].includes(s.type)||t.push(`Cash flow ${o}: invalid type "${s.type}"`):t.push(`Cash flow ${o}: type is required`)}):t.push("Cash flows must be an array")),n.monthlyNav!==void 0&&(Array.isArray(n.monthlyNav)?n.monthlyNav.forEach((a,o)=>{if(!a||typeof a!="object"){t.push(`NAV entry at index ${o} is invalid`);return}const s=a;typeof s.amount!="number"?t.push(`NAV ${o}: amount must be a number`):isNaN(s.amount)?t.push(`NAV ${o}: amount is NaN (invalid number)`):isFinite(s.amount)||t.push(`NAV ${o}: amount must be finite`),!s.date||typeof s.date!="string"?t.push(`NAV ${o}: date is required`):P(s.date)||t.push(`NAV ${o}: invalid date format (expected YYYY-MM-DD)`)}):t.push("Monthly NAV must be an array")),{valid:t.length===0,errors:t}}let x=null;function qn(){return new Promise((e,t)=>{const n=indexedDB.open(b.DB_NAME,b.DB_VERSION);n.onerror=()=>t(n.error),n.onsuccess=()=>{x=n.result,e(x)},n.onupgradeneeded=a=>{const o=a.target.result,s=a.oldVersion,r=a.target.transaction;if(!o.objectStoreNames.contains(b.FUNDS_STORE)){const i=o.createObjectStore(b.FUNDS_STORE,{keyPath:"id",autoIncrement:!0});i.createIndex("fundName","fundName",{unique:!1}),i.createIndex("accountNumber","accountNumber",{unique:!1})}if(o.objectStoreNames.contains(b.FUNDNAMES_STORE)||o.createObjectStore(b.FUNDNAMES_STORE,{keyPath:"name"}),!o.objectStoreNames.contains(b.GROUPS_STORE)){const i=o.createObjectStore(b.GROUPS_STORE,{keyPath:"id",autoIncrement:!0});i.createIndex("parentGroupId","parentGroupId",{unique:!1}),i.createIndex("name","name",{unique:!1})}if(!o.objectStoreNames.contains(b.AUDIT_STORE)){const i=o.createObjectStore(b.AUDIT_STORE,{keyPath:"id",autoIncrement:!0});i.createIndex("timestamp","timestamp",{unique:!1}),i.createIndex("operation","operation",{unique:!1}),i.createIndex("entityType","entityType",{unique:!1}),i.createIndex("entityId","entityId",{unique:!1})}if(!o.objectStoreNames.contains(b.DISMISSED_ISSUES_STORE)){const i=o.createObjectStore(b.DISMISSED_ISSUES_STORE,{keyPath:"id",autoIncrement:!0});i.createIndex("fund1Id","fund1Id",{unique:!1}),i.createIndex("fund2Id","fund2Id",{unique:!1})}if(s<6&&s>=5){o.objectStoreNames.contains("tags")&&o.deleteObjectStore("tags");const i=r.objectStore(b.FUNDS_STORE),c=r.objectStore(b.FUNDNAMES_STORE),l=new Map;i.openCursor().onsuccess=function(u){const f=u.target.result;if(f){const p=f.value;p.tags&&Array.isArray(p.tags)&&p.tags.length>0&&(l.has(p.fundName)||l.set(p.fundName,new Set),p.tags.forEach(d=>l.get(p.fundName).add(d))),delete p.tags,f.update(p),f.continue()}else c.getAll().onsuccess=function(p){p.target.result.forEach(m=>{const h=m.name,v=l.has(h)?Array.from(l.get(h)):[];c.put({name:h,tags:v})})}}}if(s===9){if(o.objectStoreNames.contains("investments")&&!o.objectStoreNames.contains("funds")){const i=o.createObjectStore("funds",{keyPath:"id",autoIncrement:!0});i.createIndex("fundName","fundName",{unique:!1}),i.createIndex("accountNumber","accountNumber",{unique:!1});const c=r.objectStore("investments");c.openCursor().onsuccess=function(l){const u=l.target.result;u&&(i.put(u.value),u.continue())}}if(o.objectStoreNames.contains("investmentNames")&&!o.objectStoreNames.contains("fundNames")){o.createObjectStore("fundNames",{keyPath:"name"});const i=r.objectStore("investmentNames"),c=r.objectStore("fundNames");i.openCursor().onsuccess=function(l){const u=l.target.result;u&&(c.put(u.value),u.continue())}}o.objectStoreNames.contains("investments")&&o.deleteObjectStore("investments"),o.objectStoreNames.contains("investmentNames")&&o.deleteObjectStore("investmentNames")}}})}async function vt(e,t,n){if(!x)throw new Error("Database not initialized");return new Promise((a,o)=>{const r=x.transaction([e],t).objectStore(e),i=n(r);i.onsuccess=()=>a(i.result),i.onerror=()=>o(i.error)})}function oe(e){return new Promise((t,n)=>{const a=cn(e);if(!a.valid){const i=`Fund validation failed: ${a.errors.join("; ")}`;console.error(i,e),n(new Error(i));return}if(!x){n(new Error("Database not initialized"));return}const o=!!e.id;let s;if(o){const i=x.transaction([b.FUNDS_STORE],"readonly").objectStore(b.FUNDS_STORE).get(e.id);i.onsuccess=()=>{s=i.result?Je(i.result):void 0,r()},i.onerror=()=>{r()}}else r();function r(){const c=x.transaction([b.FUNDS_STORE],"readwrite").objectStore(b.FUNDS_STORE);let l;if(e.id)l=c.put(e);else{const{id:u,...f}=e;l=c.add(f)}l.onsuccess=()=>{const u=l.result;g.markDataChanged();const f={...e,id:u};mn(o?"UPDATE":"CREATE",f,s).catch(console.error),t(u)},l.onerror=()=>n(l.error)}})}function Kt(e){if(!e)return"";if(typeof e=="string"&&/^\d{4}-\d{2}-\d{2}$/.test(e))return e;let t=String(e).trim();const n=t.match(/^(\d{1,2})\/(\d{1,2})\/(\d{4})$/);if(n){const[,r,i,c]=n;return`${c}-${r.padStart(2,"0")}-${i.padStart(2,"0")}`}const a=t.match(/^(\d{4})\/(\d{1,2})\/(\d{1,2})$/);if(a){const[,r,i,c]=a;return`${r}-${i.padStart(2,"0")}-${c.padStart(2,"0")}`}const o=t.match(/^(\d{1,2})-(\d{1,2})-(\d{4})$/);if(o){const[,r,i,c]=o;return`${c}-${i.padStart(2,"0")}-${r.padStart(2,"0")}`}const s=t.match(/^(\d{4})-(\d{2})-(\d{2})T/);if(s){const[,r,i,c]=s;return`${r}-${i}-${c}`}return console.warn("Could not normalize date format:",e),t}function jn(e,t){if(typeof e=="string"){const n=e.toLowerCase().trim();if(n==="contribution"||n==="capital call")return"Contribution";if(n==="distribution")return"Distribution";if(n==="adjustment")return"Adjustment"}return t<0?"Contribution":"Distribution"}function Je(e){const t=Array.isArray(e.cashFlows)?e.cashFlows.map(a=>{const o=typeof a.amount=="number"?a.amount:parseFloat(a.amount)||0;return{date:Kt(a.date),amount:o,type:jn(a.type,o),affectsCommitment:a.affectsCommitment!==void 0?a.affectsCommitment:!0}}):[],n=Array.isArray(e.monthlyNav)?e.monthlyNav.map(a=>({date:Kt(a.date),amount:typeof a.amount=="number"?a.amount:parseFloat(a.amount)||0})):[];return{id:e.id,fundName:e.fundName||"",accountNumber:e.accountNumber||"",commitment:typeof e.commitment=="number"?e.commitment:parseFloat(e.commitment)||0,groupId:e.groupId??null,cashFlows:t,monthlyNav:n,timestamp:e.timestamp||new Date().toISOString()}}async function q(){return(await vt(b.FUNDS_STORE,"readonly",t=>t.getAll())).map(Je)}async function ce(e){const t=await vt(b.FUNDS_STORE,"readonly",n=>n.get(e));return t?Je(t):void 0}function ln(e){return new Promise((t,n)=>{if(!x){n(new Error("Database not initialized"));return}const a=x.transaction([b.FUNDS_STORE],"readonly").objectStore(b.FUNDS_STORE).get(e);a.onsuccess=()=>{const o=a.result?Je(a.result):null,i=x.transaction([b.FUNDS_STORE],"readwrite").objectStore(b.FUNDS_STORE).delete(e);i.onsuccess=()=>{g.markDataChanged(),o&&mn("DELETE",o).catch(console.error),t()},i.onerror=()=>n(i.error)},a.onerror=()=>{const r=x.transaction([b.FUNDS_STORE],"readwrite").objectStore(b.FUNDS_STORE).delete(e);r.onsuccess=()=>t(),r.onerror=()=>n(r.error)}})}function Le(){return new Promise((e,t)=>{if(!x){t(new Error("Database not initialized"));return}const o=x.transaction([b.FUNDNAMES_STORE],"readonly").objectStore(b.FUNDNAMES_STORE).getAll();o.onsuccess=()=>{const s=o.result.map(r=>({name:r.name,tags:r.tags||[],investmentTermStartDate:r.investmentTermStartDate||r.finalCloseDate||null,investmentTermYears:r.investmentTermYears||null}));e(s)},o.onerror=()=>t(o.error)})}function pe(e){return new Promise((t,n)=>{if(!x){n(new Error("Database not initialized"));return}const a=typeof e=="string"?{name:e,tags:[],investmentTermStartDate:null,investmentTermYears:null}:{name:e.name,tags:e.tags||[],investmentTermStartDate:e.investmentTermStartDate||null,investmentTermYears:e.investmentTermYears||null},r=x.transaction([b.FUNDNAMES_STORE],"readwrite").objectStore(b.FUNDNAMES_STORE).put(a);r.onsuccess=()=>{g.markDataChanged(),t()},r.onerror=()=>n(r.error)})}function un(e){return new Promise((t,n)=>{if(!x){n(new Error("Database not initialized"));return}const s=x.transaction([b.FUNDNAMES_STORE],"readwrite").objectStore(b.FUNDNAMES_STORE).delete(e);s.onsuccess=()=>{g.markDataChanged(),t()},s.onerror=()=>n(s.error)})}function ie(){return vt(b.GROUPS_STORE,"readonly",e=>e.getAll())}function bt(e){return new Promise((t,n)=>{if(!x){n(new Error("Database not initialized"));return}const s=x.transaction([b.GROUPS_STORE],"readwrite").objectStore(b.GROUPS_STORE).put(e);s.onsuccess=()=>{g.markDataChanged(),t(s.result)},s.onerror=()=>n(s.error)})}function Yn(e){return new Promise((t,n)=>{if(!x){n(new Error("Database not initialized"));return}const s=x.transaction([b.GROUPS_STORE],"readwrite").objectStore(b.GROUPS_STORE).delete(e);s.onsuccess=()=>{g.markDataChanged(),t()},s.onerror=()=>n(s.error)})}function Hn(){return new Promise((e,t)=>{if(!x){t(new Error("Database not initialized"));return}const n=x.transaction([b.FUNDS_STORE,b.FUNDNAMES_STORE,b.GROUPS_STORE],"readwrite");let a=0,o=!1;const s=[b.FUNDS_STORE,b.FUNDNAMES_STORE,b.GROUPS_STORE];s.forEach(r=>{const c=n.objectStore(r).clear();c.onsuccess=()=>{o||(a++,a===s.length&&(o=!0,g.markDataChanged(),dn({operation:"CLEAR_ALL",entityType:"System",entityId:null,entityName:null,summary:"Cleared all data (funds, groups, fund names)"}).catch(console.error),e()))},c.onerror=()=>{o||(o=!0,t(c.error))}})})}function dn(e){return new Promise((t,n)=>{if(!x){console.warn("[AUDIT] DB not ready, logging to console:",e),t(-1);return}if(!x.objectStoreNames.contains(b.AUDIT_STORE)){console.warn("[AUDIT] Audit store not available, logging to console:",e),t(-1);return}const a={...e,timestamp:new Date().toISOString()},r=x.transaction([b.AUDIT_STORE],"readwrite").objectStore(b.AUDIT_STORE).add(a);r.onsuccess=()=>t(r.result),r.onerror=()=>{console.error("[AUDIT] Failed to log entry:",r.error),n(r.error)}})}async function mn(e,t,n){const a=Pn(n,e==="DELETE"?null:t);await dn({operation:e,entityType:"Fund",entityId:t.id??null,entityName:t.fundName,summary:Un(a),previousValue:n,newValue:e==="DELETE"?void 0:t})}function Vn(){return new Promise((e,t)=>{if(!x){t(new Error("Database not initialized"));return}if(!x.objectStoreNames.contains(b.DISMISSED_ISSUES_STORE)){e([]);return}const o=x.transaction([b.DISMISSED_ISSUES_STORE],"readonly").objectStore(b.DISMISSED_ISSUES_STORE).getAll();o.onsuccess=()=>e(o.result),o.onerror=()=>t(o.error)})}function zn(e,t,n){return new Promise((a,o)=>{if(!x){o(new Error("Database not initialized"));return}if(!x.objectStoreNames.contains(b.DISMISSED_ISSUES_STORE)){o(new Error("Dismissed issues store not available"));return}const s=Math.min(e,t),r=Math.max(e,t),i={fund1Id:s,fund2Id:r,reason:n,dismissedAt:new Date().toISOString()},u=x.transaction([b.DISMISSED_ISSUES_STORE],"readwrite").objectStore(b.DISMISSED_ISSUES_STORE).add(i);u.onsuccess=()=>a(),u.onerror=()=>o(u.error)})}function Wn(e,t,n){return new Promise((a,o)=>{if(!x){o(new Error("Database not initialized"));return}if(!x.objectStoreNames.contains(b.DISMISSED_ISSUES_STORE)){o(new Error("Dismissed issues store not available"));return}const s={fund1Id:e,fund2Id:0,category:t,message:n,reason:`${t}: ${n}`,dismissedAt:new Date().toISOString()},c=x.transaction([b.DISMISSED_ISSUES_STORE],"readwrite").objectStore(b.DISMISSED_ISSUES_STORE).add(s);c.onsuccess=()=>a(),c.onerror=()=>o(c.error)})}function we(e){return new Date(e+"T00:00:00").getTime()}function fn(e,t=b.IRR_GUESS){if(!Array.isArray(e)||e.length<2)return null;const n=[...e].sort((f,p)=>we(f.date)-we(p.date)),a=n[0],o=n[n.length-1];if(!a||!o)return null;const s=we(a.date);if((we(o.date)-s)/(24*60*60*1e3)<b.IRR_MIN_DAYS)return null;const c=f=>n.reduce((p,d)=>{const m=(we(d.date)-s)/315576e5;return p+d.amount/Math.pow(1+f,m)},0),l=f=>n.reduce((p,d)=>{const m=(we(d.date)-s)/315576e5;return m===0?p:p-m*d.amount/Math.pow(1+f,m+1)},0);let u=t;for(let f=0;f<b.IRR_MAX_ITERATIONS;f++){const p=c(u),d=l(u);if(Math.abs(p)<b.IRR_PRECISION)return u>b.IRR_MAX_RATE||u<b.IRR_MIN_RATE?null:u;if(Math.abs(d)<b.IRR_PRECISION)return null;const m=u-p/d;if(Math.abs(m-u)<b.IRR_PRECISION)return m>b.IRR_MAX_RATE||m<b.IRR_MIN_RATE?null:m;u=m}return null}function pn(e){if(!Array.isArray(e)||e.length===0)return null;const t=e.filter(a=>a.amount<0).reduce((a,o)=>a+Math.abs(o.amount),0),n=e.filter(a=>a.amount>0).reduce((a,o)=>a+o.amount,0);return t===0?null:n/t}function Q(e){if(e===null||typeof e>"u")return NaN;if(typeof e=="number")return isFinite(e)?e:NaN;if(typeof e=="string"){const t=e.replace(/[$,]/g,"").replace(/^\((.*)\)$/,"-$1").trim();if(t==="")return NaN;const n=parseFloat(t);return isFinite(n)?n:NaN}return NaN}function We(e){if(e==null||isNaN(e))return"";const t=e.toString().split(".");return t[0]=t[0].replace(/\B(?=(\d{3})+(?!\d))/g,","),t.join(".")}function B(e,t=!1){const n=typeof e=="string"?parseFloat(e):e;return!isFinite(n)||isNaN(n)?"$0":n.toLocaleString("en-US",{style:"currency",currency:"USD",minimumFractionDigits:t?2:0,maximumFractionDigits:t?2:0})}function ge(e,t){const n=Q(e);return n===null&&e!=null&&e!==""&&e!==0&&console.warn(`Currency parse failed (${t}):`,e),n||0}function V(e){return new Date(e+"T00:00:00")}function Ke(e){const t=(e.cashFlows||[]).filter(n=>n.type==="Contribution"&&P(n.date)).sort((n,a)=>V(n.date).getTime()-V(a.date).getTime());return t.length>0?V(t[0].date).getFullYear():null}function ct(e,t,n){return(e.cashFlows||[]).filter(o=>o.type===t&&P(o.date)&&(!n||V(o.date)<=n)).reduce((o,s)=>o+Math.abs(ge(s.amount,"cash flow amount")),0)}function gn(e,t){const n=(e.monthlyNav||[]).filter(i=>P(i.date)&&(!t||V(i.date)<=t)).sort((i,c)=>V(c.date).getTime()-V(i.date).getTime());if(n.length===0)return 0;const a=n[0];let o=ge(a.amount,"NAV amount");const s=V(a.date);return(e.cashFlows||[]).filter(i=>{if(!P(i.date))return!1;const c=V(i.date);return c>s&&(!t||c<=t)}).forEach(i=>{const c=ge(i.amount,"cash flow amount");i.type==="Contribution"?o+=Math.abs(c):i.type==="Distribution"&&(o-=Math.abs(c))}),o}function Kn(e,t){const n=(e.monthlyNav||[]).filter(a=>P(a.date)&&(!t||V(a.date)<=t)).sort((a,o)=>V(o.date).getTime()-V(a.date).getTime());return n.length>0?n[0].date:null}function Xn(e,t){let n=ge(e.commitment,"commitment");return(e.cashFlows||[]).filter(a=>P(a.date)&&(!t||V(a.date)<=t)).forEach(a=>{const o=ge(a.amount,"cash flow amount");if(a.type==="Adjustment"){n-=o;return}a.affectsCommitment!==!1&&(a.type==="Contribution"?n-=Math.abs(o):a.type==="Distribution"&&(n+=Math.abs(o)))}),Math.max(0,n)}function hn(e,t){const n=(e.cashFlows||[]).filter(s=>P(s.date)&&(!t||V(s.date)<=t)&&s.type!=="Adjustment").map(s=>{const r=ge(s.amount,"cash flow amount");return{date:s.date,amount:s.type==="Contribution"?-Math.abs(r):Math.abs(r)}}),a=gn(e,t),o=(e.monthlyNav||[]).filter(s=>P(s.date)&&(!t||V(s.date)<=t)).sort((s,r)=>V(r.date).getTime()-V(s.date).getTime());return o.length>0&&n.push({date:o[0].date,amount:a}),n.sort((s,r)=>V(s.date).getTime()-V(r.date).getTime())}function re(e,t){const n=ge(e.commitment,"commitment"),a=ct(e,"Contribution",t),o=ct(e,"Distribution",t),s=gn(e,t),r=Kn(e,t),i=Xn(e,t),c=Ke(e),l=o+s-a,u=hn(e,t),f=fn(u),p=pn(u),d=a>0?o/a:null,m=a>0?s/a:null,h=a>0?(o+s)/a:null;return{calledCapital:a,distributions:o,nav:s,navDate:r,irr:f,moic:p,dpi:d,rvpi:m,tvpi:h,outstandingCommitment:i,vintageYear:c,commitment:n,totalContributions:a,totalDistributions:o,investmentReturn:l,vintage:c}}function at(e,t){if(e.id==null)return re(e,t);const n=t?.toISOString()??"current",a=g.getMetricsFromCache(e.id,n);if(a)return a;const o=re(e,t);return g.setMetricsCache(e.id,n,o),o}function C(e){if(typeof e!="string")return"";const t=document.createElement("div");return t.textContent=e,t.innerHTML}function Fe(e){if(e==null)return"";const t=String(e);return t.includes(",")||t.includes('"')||t.includes(`
`)?'"'+t.replace(/"/g,'""')+'"':t}function Ne(e){return typeof e!="string"?"":e.replace(/&/g,"&amp;").replace(/"/g,"&quot;").replace(/'/g,"&#39;").replace(/</g,"&lt;").replace(/>/g,"&gt;")}function Ze(e){return e==null||!isFinite(e)?"N/A":e.toFixed(2)+"x"}function Qe(e){return e==null||!isFinite(e)?"N/A":(e*100).toFixed(2)+"%"}function yn(e){if(!e.groupId)return"";const t=g.getGroupByIdSync(e.groupId);return t?t.name:""}function lt(e){const t=yn(e);return t?`${t} (${e.accountNumber})`:e.accountNumber}function Jn(e){const t=yn(e);return t?`<div>${C(t)}</div><div style="font-size: 0.85em; color: var(--color-text-light);">${C(e.accountNumber)}</div>`:C(e.accountNumber)}function vn(e,t,n){if(t.length===0)return e;const a=new Map;for(const o of e)o.id!=null&&a.set(o.id,at(o,n));return[...e].sort((o,s)=>{for(const{column:r,direction:i}of t){const c=i==="asc"?1:-1;let l=0;const u=o.id!=null?a.get(o.id):at(o,n),f=s.id!=null?a.get(s.id):at(s,n);switch(r){case"fundName":l=o.fundName.localeCompare(s.fundName);break;case"accountNumber":l=lt(o).localeCompare(lt(s));break;case"vintage":const p=u?.vintageYear||0,d=f?.vintageYear||0;l=p-d;break;case"commitment":l=(u?.commitment||0)-(f?.commitment||0);break;case"totalContributions":l=(u?.calledCapital||0)-(f?.calledCapital||0);break;case"totalDistributions":l=(u?.distributions||0)-(f?.distributions||0);break;case"nav":l=(u?.nav||0)-(f?.nav||0);break;case"investmentReturn":l=(u?.investmentReturn||0)-(f?.investmentReturn||0);break;case"moic":l=(u?.moic||0)-(f?.moic||0);break;case"irr":l=(u?.irr||0)-(f?.irr||0);break;case"outstandingCommitment":l=(u?.outstandingCommitment||0)-(f?.outstandingCommitment||0);break;default:l=0}if(l!==0)return l*c}return 0})}function Zn(e,t,n=!1){const a=e.metrics,o=g.fundNameData.get(e.fundName),s=o&&o.tags?o.tags:[],r=n&&s.length>0?`<div class="table-tags">${s.map(c=>`<span class="table-tag">${C(c)}</span>`).join("")}</div>`:"",i=a.investmentReturn??a.distributions+a.nav-a.calledCapital;return`
    <td>
      <div>${C(e.fundName)}</div>
      ${r}
    </td>
    <td title="${C(lt(e))}">${Jn(e)}</td>
    <td class="center">${a.vintageYear||"N/A"}</td>
    <td class="number">${B(a.commitment||0)}</td>
    <td class="number">${B(a.calledCapital)}</td>
    <td class="number">${B(a.distributions)}</td>
    <td class="number">${B(a.nav)}</td>
    <td class="number ${i>=0?"positive":"negative"}">${B(i)}</td>
    <td class="number">${Ze(a.moic)}</td>
    <td class="number ${a.irr!==null&&a.irr>=0?"positive":"negative"}">${Qe(a.irr)}</td>
    <td class="number">${B(a.outstandingCommitment)}</td>
    <td class="center">
      <button class="btn-icon fund-actions-btn" data-fund-id="${e.id}" title="Actions" aria-label="Actions for ${C(e.fundName)}">⚙</button>
    </td>
  `}function bn(e,t){const n={commitment:0,calledCapital:0,distributions:0,nav:0,investmentReturn:0,outstandingCommitment:0,aggregateFlows:[]};e.forEach(c=>{const l=c.metrics;n.commitment+=l.commitment||0,n.calledCapital+=l.calledCapital,n.distributions+=l.distributions,n.nav+=l.nav,n.investmentReturn+=l.investmentReturn??l.distributions+l.nav-l.calledCapital,n.outstandingCommitment+=l.outstandingCommitment;const u=hn(c,t);n.aggregateFlows.push(...u)});const a=fn(n.aggregateFlows),o=pn(n.aggregateFlows),s=n.calledCapital>0?n.distributions/n.calledCapital:null,r=n.calledCapital>0?n.nav/n.calledCapital:null,i=n.calledCapital>0?(n.distributions+n.nav)/n.calledCapital:null;return{commitment:n.commitment,calledCapital:n.calledCapital,distributions:n.distributions,nav:n.nav,investmentReturn:n.investmentReturn,outstandingCommitment:n.outstandingCommitment,aggregateIRR:a,aggregateMOIC:o,aggregateDPI:s,aggregateRVPI:r,aggregateTVPI:i}}function Xt(e){return`
    <td><strong>Total</strong></td>
    <td></td>
    <td></td>
    <td class="number"><strong>${B(e.commitment)}</strong></td>
    <td class="number"><strong>${B(e.calledCapital)}</strong></td>
    <td class="number"><strong>${B(e.distributions)}</strong></td>
    <td class="number"><strong>${B(e.nav)}</strong></td>
    <td class="number ${e.investmentReturn>=0?"positive":"negative"}"><strong>${B(e.investmentReturn)}</strong></td>
    <td class="number"><strong>${Ze(e.aggregateMOIC)}</strong></td>
    <td class="number ${e.aggregateIRR!==null&&e.aggregateIRR>=0?"positive":"negative"}"><strong>${Qe(e.aggregateIRR)}</strong></td>
    <td class="number"><strong>${B(e.outstandingCommitment)}</strong></td>
    <td></td>
  `}function Qn(e,t){const n=bn(e,t),a=new Set(e.map(s=>s.fundName)),o=(s,r)=>{const i=document.getElementById(s);i&&(i.textContent=r)};o("summaryInvestmentCount",e.length.toString()),o("summaryFundCount",a.size.toString()),o("summaryCommitment",B(n.commitment)),o("summaryNav",B(n.nav)),o("summaryIRR",Qe(n.aggregateIRR)),o("summaryMOIC",Ze(n.aggregateMOIC)),o("summaryDPI",n.aggregateDPI!==null?n.aggregateDPI.toFixed(2)+"x":"N/A"),o("summaryRVPI",n.aggregateRVPI!==null?n.aggregateRVPI.toFixed(2)+"x":"N/A"),o("summaryTVPI",n.aggregateTVPI!==null?n.aggregateTVPI.toFixed(2)+"x":"N/A")}function eo(e){document.querySelectorAll("#fundsTable th").forEach(t=>{t.classList.remove("sorted-asc","sorted-desc"),t.removeAttribute("data-sort-priority")}),e.forEach(({column:t,direction:n},a)=>{const o=document.querySelector(`#fundsTable th[data-sort="${t}"]`);o&&(o.classList.add(n==="asc"?"sorted-asc":"sorted-desc"),e.length>1&&o.setAttribute("data-sort-priority",(a+1).toString()))})}function In(e,t,n=[]){const a=new Map;for(const s of e){const r=a.get(s.fundName)||[];r.push(s),a.set(s.fundName,r)}const o=[];for(const[s,r]of a){const i=[];let c=0,l=0,u=null;for(const E of r)i.push(...E.cashFlows),c+=E.commitment,l+=E.metrics.nav,E.metrics.navDate&&(!u||E.metrics.navDate>u)&&(u=E.metrics.navDate);const p=[{date:u||new Date().toISOString().split("T")[0],amount:l}],d={fundName:s,accountNumber:`${r.length} investor${r.length!==1?"s":""}`,commitment:c,cashFlows:i,monthlyNav:p,groupId:null,timestamp:new Date().toISOString()},m=re(d,t),h=r[0]?.id,v={...d,id:h,investorCount:r.length,consolidatedMetrics:m};o.push(v)}return n.length>0?o.sort((s,r)=>{for(const{column:i,direction:c}of n){const l=c==="asc"?1:-1;let u=0;const f=s.consolidatedMetrics,p=r.consolidatedMetrics;switch(i){case"fundName":u=s.fundName.localeCompare(r.fundName);break;case"accountNumber":u=s.investorCount-r.investorCount;break;case"vintage":u=(f.vintageYear||0)-(p.vintageYear||0);break;case"commitment":u=(f.commitment||0)-(p.commitment||0);break;case"totalContributions":u=f.calledCapital-p.calledCapital;break;case"totalDistributions":u=f.distributions-p.distributions;break;case"nav":u=f.nav-p.nav;break;case"investmentReturn":u=(f.investmentReturn||0)-(p.investmentReturn||0);break;case"moic":u=(f.moic||0)-(p.moic||0);break;case"irr":u=(f.irr||0)-(p.irr||0);break;case"outstandingCommitment":u=f.outstandingCommitment-p.outstandingCommitment;break;default:u=0}if(u!==0)return u*l}return 0}):o.sort((s,r)=>s.fundName.localeCompare(r.fundName)),o}function to(e,t,n=!1){const a=e.consolidatedMetrics,o=g.fundNameData.get(e.fundName),s=o&&o.tags?o.tags:[],r=n&&s.length>0?`<div class="table-tags">${s.map(c=>`<span class="table-tag">${C(c)}</span>`).join("")}</div>`:"",i=a.investmentReturn??a.distributions+a.nav-a.calledCapital;return`
    <td>
      <div>${C(e.fundName)}</div>
      ${r}
    </td>
    <td class="center"><span class="investor-count">${e.investorCount} investor${e.investorCount!==1?"s":""}</span></td>
    <td class="center">${a.vintageYear||"N/A"}</td>
    <td class="number">${B(a.commitment||0)}</td>
    <td class="number">${B(a.calledCapital)}</td>
    <td class="number">${B(a.distributions)}</td>
    <td class="number">${B(a.nav)}</td>
    <td class="number ${i>=0?"positive":"negative"}">${B(i)}</td>
    <td class="number">${Ze(a.moic)}</td>
    <td class="number ${a.irr!==null&&a.irr>=0?"positive":"negative"}">${Qe(a.irr)}</td>
    <td class="number">${B(a.outstandingCommitment)}</td>
    <td></td>
  `}function no(){const e=new Date,t=e.getFullYear(),n=[new Date(t,2,31),new Date(t,5,30),new Date(t,8,30),new Date(t,11,31)];let a=new Date(t-1,11,31);for(let i=n.length-1;i>=0;i--)if(n[i]<=e){a=n[i];break}const o=a.getFullYear(),s=String(a.getMonth()+1).padStart(2,"0"),r=String(a.getDate()).padStart(2,"0");return`${o}-${s}-${r}`}function L(e){const t=document.getElementById(e);if(!t)return[];const n=t.querySelectorAll(".multi-select-option.selected");return Array.from(n).map(a=>a.dataset.value||"")}function Ee(e,t){const n=document.getElementById(e);if(!n)return;n.querySelectorAll(".multi-select-option").forEach(o=>{const s=o;if(t.includes(s.dataset.value||"")){o.classList.add("selected");const r=o.querySelector('input[type="checkbox"]');r&&(r.checked=!0)}else{o.classList.remove("selected");const r=o.querySelector('input[type="checkbox"]');r&&(r.checked=!1)}}),et(e)}function De(e){Ee(e,[])}function et(e){const t=document.getElementById(e);if(!t)return;const n=t.querySelector(".multi-select-display");if(!n)return;const a=t.dataset.placeholder||"Select...",o=L(e);if(o.length===0)n.innerHTML=`<span class="placeholder">${C(a)}</span>`;else if(o.length===1){const r=t.querySelector(`.multi-select-option[data-value="${CSS.escape(o[0]||"")}"]`)?.querySelector("label")?.textContent||o[0];n.innerHTML=C(r)}else n.innerHTML=`<span class="multi-select-count">${o.length} selected</span>`}function Be(e,t,n=[]){const a=document.getElementById(e);if(!a)return;const o=a.querySelector(".multi-select-dropdown");if(!o)return;const r=o.querySelector(".multi-select-search input")?.value||"";let i=!1;const c=t.map(l=>{const u=n.includes(l.value),f=l.indent!==void 0?`style="--indent-level: ${l.indent}"`:"",p=["multi-select-option"];return l.indent!==void 0&&(l.indent===0?(p.push("group-top-level"),i&&p.push("group-separator"),i=!0):p.push("group-option","group-child")),u&&p.push("selected"),`
      <div class="${p.join(" ")}"
           data-value="${C(l.value)}"
           role="option"
           aria-selected="${u}"
           ${f}>
        <input type="checkbox" ${u?"checked":""} tabindex="-1">
        <label>${C(l.label)}</label>
      </div>
    `}).join("");o.innerHTML=`
    <div class="multi-select-search">
      <input type="text" placeholder="Search..." aria-label="Search options" value="${C(r)}">
    </div>
    <div class="multi-select-options">
      <div class="multi-select-option multi-select-all-option" data-value="__select_all__" role="option" aria-selected="false">
        <input type="checkbox" tabindex="-1">
        <label>Select All</label>
      </div>
      ${c}
    </div>
    <div class="multi-select-no-results">No matches found</div>
  `,r&&It(a,r),et(e)}function It(e,t){const n=e.querySelector(".multi-select-options"),a=e.querySelector(".multi-select-no-results");if(!n)return;const o=n.querySelectorAll(".multi-select-option"),s=t.toLowerCase().trim();let r=0;o.forEach(i=>{const c=i.querySelector("label"),l=c&&c.textContent?.toLowerCase()||"";s===""||l.includes(s)?(i.classList.remove("search-hidden"),r++):i.classList.add("search-hidden")}),a&&a.classList.toggle("visible",r===0&&s!=="")}function je(e){const t=e.querySelector(".multi-select-search input");t&&(t.value=""),It(e,"")}function oo(e){const t=e.querySelector(".multi-select-options");if(!t)return;const n=t.querySelectorAll(".multi-select-option:not(.search-hidden):not(.multi-select-all-option)"),o=!Array.from(n).every(s=>s.classList.contains("selected"));n.forEach(s=>{o?s.classList.add("selected"):s.classList.remove("selected");const r=s.querySelector('input[type="checkbox"]');r&&(r.checked=o),s.setAttribute("aria-selected",o.toString())}),wt(e),et(e.id)}function wt(e){const t=e.querySelector(".multi-select-all-option");if(!t)return;const n=e.querySelector(".multi-select-options");if(!n)return;const a=n.querySelectorAll(".multi-select-option:not(.search-hidden):not(.multi-select-all-option)");if(a.length===0){t.classList.remove("selected");const r=t.querySelector('input[type="checkbox"]');r&&(r.checked=!1);return}const o=Array.from(a).every(r=>r.classList.contains("selected"));o?t.classList.add("selected"):t.classList.remove("selected");const s=t.querySelector('input[type="checkbox"]');s&&(s.checked=o)}function $e(e,t){return e.filter(n=>n.parentGroupId===t).sort((n,a)=>n.name.localeCompare(a.name)).map(n=>({...n,children:$e(e,n.id)}))}const ao=[{id:"fundFilter",isMultiSelect:!0,apply:(e,t)=>t.length===0||t.includes(e.fundName)},{id:"accountFilter",isMultiSelect:!0,apply:(e,t)=>t.length===0||t.includes(e.accountNumber)},{id:"vintageFilter",isMultiSelect:!0,apply:(e,t)=>{if(t.length===0)return!0;const n=Ke(e);return n!==null&&t.includes(n.toString())}}];function Et(e){const t={fundFilter:L("fundFilter"),accountFilter:L("accountFilter"),groupFilter:L("groupFilter"),tagFilter:L("tagFilter"),vintageFilter:L("vintageFilter")},n=t.groupFilter;let a=null;if(n.length>0){a=new Set;for(const s of n){const r=parseInt(s),i=g.getDescendantIds(r);for(const c of i)a.add(c)}}const o=t.tagFilter.length>0?new Set(t.tagFilter):null;return e.filter(s=>{for(const r of ao){const i=t[r.id]||[];if(!r.apply(s,i))return!1}return!(a!==null&&(!s.groupId||!a.has(s.groupId))||o!==null&&!(g.fundNameData.get(s.fundName)?.tags||[]).some(l=>o.has(l)))})}function St(){De("fundFilter"),De("accountFilter"),De("groupFilter"),De("tagFilter"),De("vintageFilter");const e=document.getElementById("cutoffDate");e&&(e.value=no())}function so(){const e=document.getElementById("activeFiltersIndicator");if(!e)return;const t=[L("fundFilter"),L("accountFilter"),L("groupFilter"),L("tagFilter"),L("vintageFilter")].filter(n=>n.length>0).length;t>0?(e.innerHTML=`${t} filter${t>1?"s":""} active <button class="clear-filters" title="Clear all filters" aria-label="Clear all filters">&times;</button>`,e.style.display="inline-flex"):(e.innerHTML="",e.style.display="none")}function wn(e,t,n){const a=e.querySelector(".multi-select-options");if(!a)return;const o=(r,i)=>{const c=a.querySelector(`[data-value="${r}"]`);if(c){i?c.classList.add("selected"):c.classList.remove("selected");const l=c.querySelector('input[type="checkbox"]');l&&(l.checked=i),c.setAttribute("aria-selected",i.toString())}},s=r=>{const i=a.querySelector(`[data-value="${r}"]`);return i?i.classList.contains("selected"):!1};if(n){g.getDescendantIds(t).forEach(c=>{c!==t&&o(c,!0)});let i=t;for(;i!=null;){const c=g.getGroupByIdSync(i);if(!c||c.parentGroupId==null)break;const l=c.parentGroupId;if(g.getDirectChildIds(l).every(p=>s(p)))o(l,!0),i=l;else break}}else{g.getDescendantIds(t).forEach(c=>{c!==t&&o(c,!1)});const i=g.getGroupByIdSync(t);if(i&&i.parentGroupId!=null){let c=i.parentGroupId;for(;c!=null;){o(c,!1);const l=g.getGroupByIdSync(c);c=l?l.parentGroupId:null}}}}function ro(e){const t=L("groupFilter"),n=L("fundFilter"),a=L("accountFilter"),o=L("vintageFilter"),s=L("tagFilter");let r=null;if(t.length>0){r=new Set;for(const S of t){const M=parseInt(S),$=g.getDescendantIds(M);for(const J of $)r.add(J)}}const i=n.length>0?new Set(n):null,c=a.length>0?new Set(a):null,l=o.length>0?new Set(o):null,u=(S,M)=>M?S.filter($=>$.groupId!=null&&M.has($.groupId)):S,f=(S,M)=>M?S.filter($=>{const J=Ke($);return J!==null&&M.has(J.toString())}):S,p=(S,M)=>M?S.filter($=>M.has($.fundName)):S,d=(S,M)=>M?S.filter($=>M.has($.accountNumber)):S;let m=e;m=u(m,r),m=d(m,c),m=f(m,l);const h=new Set(m.map(S=>S.fundName)),E=[...h].sort().map(S=>({value:S,label:S})),T=n.filter(S=>h.has(S));Be("fundFilter",E,T);let F=e;F=u(F,r),F=p(F,i),F=f(F,l);const D=new Set(F.map(S=>S.accountNumber)),k=[...D].sort().map(S=>({value:S,label:S})),j=a.filter(S=>D.has(S));Be("accountFilter",k,j);const G=g.getGroups(),Y=[];if(G.length>0){const S=$e(G,null),M=($,J,ae=null)=>{const de=[];return $.forEach(se=>{(ae===null||ae.has(se.id))&&de.push({value:se.id.toString(),label:se.name,indent:J}),se.children&&se.children.length>0&&de.push(...M(se.children,J+1,ae))}),de};if(n.length>0||a.length>0||o.length>0){let $=e;$=p($,i),$=d($,c),$=f($,l);const J=new Set;$.forEach(ae=>{ae.groupId!=null&&g.getAncestorIds(ae.groupId).forEach(se=>J.add(se))}),Y.push(...M(S,0,J))}else Y.push(...M(S,0))}const te=new Set(Y.map(S=>S.value)),le=t.filter(S=>te.has(S));Be("groupFilter",Y,le);let X=e;X=u(X,r),X=p(X,i),X=d(X,c);const be=new Set;X.forEach(S=>{const M=Ke(S);M!==null&&be.add(M)});const nt=Array.from(be).sort((S,M)=>M-S).map(S=>({value:S.toString(),label:S.toString()})),Oe=o.filter(S=>be.has(parseInt(S)));Be("vintageFilter",nt,Oe);const Ie=new Set;g.fundNameData.forEach(S=>{S.tags&&S.tags.forEach(M=>Ie.add(M))});const Pe=Array.from(Ie).sort((S,M)=>S.localeCompare(M)).map(S=>({value:S,label:S})),Ue=s.filter(S=>Ie.has(S));Be("tagFilter",Pe,Ue)}function I(e,t="success"){const n=document.createElement("div");n.className=`status-message ${t}`;const a=document.createElement("button");a.className="close-status",a.innerHTML="&times;",a.onclick=()=>n.remove();const o=document.createElement("span");o.textContent=e,n.appendChild(o),n.appendChild(a),document.body.appendChild(n),setTimeout(()=>{n.parentNode&&n.remove()},t==="success"?3e3:8e3)}function K(e="Loading..."){const t=document.getElementById("loadingOverlay"),n=document.getElementById("loadingText");n&&(n.textContent=e),t&&t.classList.add("show")}function U(){const e=document.getElementById("loadingOverlay");e&&e.classList.remove("show")}function fe(e,t={}){return new Promise(n=>{const a=document.getElementById("confirmModal"),o=document.getElementById("confirmModalTitle"),s=document.getElementById("confirmModalMessage"),r=document.getElementById("confirmModalConfirmBtn"),i=document.getElementById("confirmModalCancelBtn");if(!a||!o||!s||!r||!i){n(!1);return}o.textContent=t.title||"Confirm",s.textContent=e,r.textContent=t.confirmText||"Confirm",i.textContent=t.cancelText||"Cancel",a.classList.add("show");const c=()=>{a.classList.remove("show"),r.onclick=null,i.onclick=null};r.onclick=()=>{c(),n(!0)},i.onclick=()=>{c(),n(!1)}})}function Z(e){const t=document.getElementById(e);t&&t.classList.add("show")}function R(e){const t=document.getElementById(e);t&&t.classList.remove("show")}function io(){["fundName","accountNumber","fundGroup","commitment","newFundNameInline"].forEach(t=>{const n=document.getElementById(t);n&&(n.addEventListener("input",()=>{g.setFundModalUnsavedChanges(!0)}),n.addEventListener("change",()=>{g.setFundModalUnsavedChanges(!0)}))})}async function co(){g.fundModalHasUnsavedChanges&&!await fe("You have unsaved changes. Discard them?",{title:"Unsaved Changes",confirmText:"Discard",cancelText:"Keep Editing"})||(g.setFundModalUnsavedChanges(!1),En(),R("fundModal"))}let Se=null,xe=!1,ut=0;function En(){Se=null,xe=!1,ut=0}async function Sn(e,t=null){if(!e||e.trim()==="")return{groupId:null,groupName:null,isAmbiguous:!1,conflictingGroups:[]};const n=e.trim().toLowerCase(),o=(await q()).filter(i=>t&&i.id===t?!1:i.accountNumber&&i.accountNumber.trim().toLowerCase()===n);if(o.length===0)return{groupId:null,groupName:null,isAmbiguous:!1,conflictingGroups:[]};const s=new Map;o.forEach(i=>{const c=i.groupId||null;if(s.has(c))s.get(c).count++;else{const l=c?g.getGroupByIdSync(c)?.name||"Unknown Group":"No Group";s.set(c,{groupId:c,groupName:l,count:1})}});const r=Array.from(s.values());return r.length===1?{groupId:r[0].groupId,groupName:r[0].groupName,isAmbiguous:!1,conflictingGroups:[]}:{groupId:null,groupName:null,isAmbiguous:!0,conflictingGroups:r}}function dt(e,t=[],n=""){ve();const a=document.getElementById("fundGroup")?.closest(".form-group");if(!a)return;const o=document.createElement("div");if(o.id="groupAutoFillIndicator",o.style.cssText="margin-top: 6px; font-size: 12px; display: flex; align-items: flex-start; gap: 6px;",e==="auto-filled")o.innerHTML=`
      <span style="color: var(--color-success); display: flex; align-items: center; gap: 4px;">
        <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <polyline points="20 6 9 17 4 12"></polyline>
        </svg>
        Auto-filled from existing investor data
      </span>
      <span style="color: var(--color-text-light);">(${C(n)})</span>
    `;else if(e==="ambiguous"){const s=t.map(r=>`${C(r.groupName)} (${r.count})`).join(", ");o.innerHTML=`
      <span style="color: var(--color-warning); display: flex; align-items: center; gap: 4px;">
        <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <circle cx="12" cy="12" r="10"></circle>
          <line x1="12" y1="8" x2="12" y2="12"></line>
          <line x1="12" y1="16" x2="12.01" y2="16"></line>
        </svg>
        Multiple groups found for this account
      </span>
      <span style="color: var(--color-text-light); font-size: 11px;">(${s})</span>
    `}a.appendChild(o)}function ve(){const e=document.getElementById("groupAutoFillIndicator");e&&e.remove()}async function Jt(){const e=document.getElementById("accountNumber"),t=document.getElementById("fundGroup"),n=document.getElementById("fundId");if(!e||!t)return;const a=e.value.trim(),o=n?.value?parseInt(n.value):null;if(ve(),Se=null,xe=!1,!a)return;const s=++ut,r=await Sn(a,o);s===ut&&(r.isAmbiguous?(dt("ambiguous",r.conflictingGroups),xe=!0):(r.groupId!==null||r.groupName==="No Group")&&(Se=r.groupId,xe=!0,tt("fundGroup",r.groupId?.toString()||""),dt("auto-filled",[],r.groupName||"No Group")))}function lo(e){ve();const t=document.getElementById("fundGroup")?.closest(".form-group");if(!t)return;const n=document.createElement("div");n.id="groupAutoFillIndicator",n.style.cssText="margin-top: 6px; font-size: 12px; display: flex; align-items: flex-start; gap: 6px;";const a=e.map(o=>`${C(o.groupName)} (${o.count})`).join(", ");n.innerHTML=`
    <span style="color: var(--color-warning); display: flex; align-items: center; gap: 4px;">
      <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
        <circle cx="12" cy="12" r="10"></circle>
        <line x1="12" y1="8" x2="12" y2="12"></line>
        <line x1="12" y1="16" x2="12.01" y2="16"></line>
      </svg>
      Multiple groups will exist for this account
    </span>
    <span style="color: var(--color-text-light); font-size: 11px;">(${a})</span>
  `,t.appendChild(n)}async function uo(){const e=document.getElementById("fundGroup"),t=document.getElementById("accountNumber");if(!e||!t||!xe)return;const n=t.value.trim();if(!n)return;const a=e.value?parseInt(e.value):null;if(a!==Se){const o=document.getElementById("fundId"),s=o?.value?parseInt(o.value):null,r=await Sn(n,s);if(r.conflictingGroups.length>0||r.groupId!==null){const i=a?g.getGroupByIdSync(a)?.name||"Unknown Group":"No Group",c=[...r.conflictingGroups];!r.isAmbiguous&&r.groupId!==null&&c.push({groupId:r.groupId,groupName:r.groupName||"No Group",count:1}),c.some(l=>l.groupId===a)||c.push({groupId:a,groupName:i,count:0}),lo(c)}}else if(Se!==null){const o=g.getGroupByIdSync(Se)?.name||"No Group";dt("auto-filled",[],o)}else ve()}function mo(){const e=document.getElementById("accountNumber"),t=document.getElementById("fundGroup");if(!e)return;let n=null;e.addEventListener("input",()=>{n&&clearTimeout(n),n=setTimeout(Jt,300)}),e.addEventListener("blur",Jt),t&&t.addEventListener("change",uo)}async function Re(){const e=document.getElementById("fundName");if(!e)return;const t=await Le(),n=t.map(r=>r.name).sort();g.setFundNames(new Set(n));const a=new Map;t.forEach(r=>a.set(r.name,r)),g.setFundNameData(a);const o=e.value;e.innerHTML='<option value="">Select a fund</option>',n.forEach(r=>{const i=document.createElement("option");i.value=r,i.textContent=r,e.appendChild(i)});const s=document.createElement("option");s.value="__new__",s.textContent="+ Add new fund name...",e.appendChild(s),o&&n.includes(o)&&(e.value=o)}function he(e,t){if(document.getElementById(e+"Container")?.classList.contains("searchable-select")){fo(e,t);return}const a=document.getElementById(e);if(!a)return;const o=g.getGroups(),s=$e(o,null);a.innerHTML='<option value="">No Group</option>';const r=(i,c)=>{i.forEach(l=>{if(t!==void 0&&l.id===t)return;const u=document.createElement("option");u.value=l.id.toString();const f=c>0?"–".repeat(c)+" ":"";u.textContent=f+l.name,a.appendChild(u),l.children&&l.children.length>0&&r(l.children,c+1)})};r(s,0)}function fo(e,t){const n=document.getElementById(e+"Container"),a=document.getElementById(e),o=n?.querySelector(".searchable-select-options");if(!n||!a||!o)return;const s=g.getGroups(),r=$e(s,null),i=n.dataset.placeholder||"Select...";let c=`<div class="searchable-select-option" data-value="" data-indent="0">
    ${C(i)}
  </div>`;const l=(f,p)=>{f.forEach(d=>{if(t!==void 0&&d.id===t)return;const m=p>0?"–".repeat(p)+" ":"";c+=`<div class="searchable-select-option" data-value="${d.id}" data-indent="${p}">
        ${C(m+d.name)}
      </div>`,d.children&&d.children.length>0&&l(d.children,p+1)})};l(r,0),o.innerHTML=c,a.value="";const u=n.querySelector(".searchable-select-display");u&&(u.textContent=i)}function tt(e,t){const n=document.getElementById(e+"Container"),a=document.getElementById(e);if(!n||!a)return;a.value=t;const o=n.querySelector(".searchable-select-display"),s=n.querySelectorAll(".searchable-select-option");let r=n.dataset.placeholder||"Select...";s.forEach(i=>{const c=i;c.classList.remove("selected"),c.dataset.value===t&&(c.classList.add("selected"),r=c.textContent?.trim()||r)}),o&&(o.textContent=r)}async function Xe(){const e=document.getElementById("fundModalTitle"),t=document.getElementById("fundId"),n=document.getElementById("isDuplicate"),a=document.getElementById("saveFundBtn"),o=document.getElementById("duplicateMultiplierContainer");e&&(e.textContent="Add New Investment"),t&&(t.value=""),n&&(n.value=""),a&&(a.textContent="Save"),o&&(o.style.display="none");const s=document.getElementById("fundForm");s&&s.reset(),ve(),await Re(),he("fundGroup"),g.setFundModalUnsavedChanges(!1),Z("fundModal")}async function po(e){const t=await ce(e);if(!t){I("Fund not found","error");return}const n=document.getElementById("fundModalTitle"),a=document.getElementById("fundId"),o=document.getElementById("isDuplicate"),s=document.getElementById("fundName"),r=document.getElementById("accountNumber"),i=document.getElementById("commitment"),c=document.getElementById("saveFundBtn"),l=document.getElementById("duplicateMultiplierContainer");n&&(n.textContent="Edit Investment"),a&&(a.value=e.toString()),o&&(o.value=""),c&&(c.textContent="Save"),l&&(l.style.display="none"),ve(),await Re(),he("fundGroup"),s&&(s.value=t.fundName),r&&(r.value=t.accountNumber),tt("fundGroup",t.groupId?.toString()||""),i&&(i.value=We(t.commitment)),g.setFundModalUnsavedChanges(!1),Z("fundModal")}async function go(e){const t=await ce(e);if(!t){I("Fund not found","error");return}const n=document.getElementById("fundModalTitle"),a=document.getElementById("fundId"),o=document.getElementById("isDuplicate"),s=document.getElementById("fundName"),r=document.getElementById("accountNumber"),i=document.getElementById("commitment"),c=document.getElementById("duplicateMultiplier"),l=document.getElementById("saveFundBtn"),u=document.getElementById("duplicateMultiplierContainer");n&&(n.textContent="Duplicate Investment"),a&&(a.value=e.toString()),o&&(o.value="true"),l&&(l.textContent="Duplicate"),u&&(u.style.display="block"),c&&(c.value="1"),ve(),await Re(),he("fundGroup"),s&&(s.value=t.fundName),r&&(r.value=""),tt("fundGroup",t.groupId?.toString()||""),i&&(i.value=We(t.commitment)),g.setFundModalUnsavedChanges(!1),Z("fundModal")}async function ho(e){const t=document.getElementById("fundId"),n=document.getElementById("isDuplicate"),a=document.getElementById("fundName"),o=document.getElementById("accountNumber"),s=document.getElementById("fundGroup"),r=document.getElementById("commitment"),i=document.getElementById("duplicateMultiplier");let c=a?.value||"";const l=(o?.value||"").replace(/\s/g,""),u=s?.value?parseInt(s.value):null,f=Q(r?.value||"0"),p=n?.value==="true",d=parseFloat(i?.value||"1")||1;if(c==="__new__"){const m=document.getElementById("newFundNameInline"),h=m?.value?.trim();if(!h){I("Please enter a fund name","error");return}if(g.fundNames.has(h)){I("A fund with this name already exists. Please select it from the dropdown.","error");return}try{const v={name:h,tags:[],investmentTermStartDate:null,investmentTermYears:null};await pe(v),g.fundNames.add(h),g.fundNameData.set(h,v),c=h,await Re(),a&&(a.value=h);const E=document.getElementById("newFundNameContainer");E&&(E.style.display="none"),m&&(m.value="")}catch(v){I("Error creating fund name: "+v.message,"error");return}}if(!c){I("Please select a fund name","error");return}if(!l){I("Please enter an account number","error");return}if(isNaN(f)||f<=0){I("Please enter a valid commitment amount","error");return}try{if(K("Saving..."),p&&t?.value){const m=await ce(parseInt(t.value));if(!m){I("Original fund not found","error"),U();return}const h={fundName:c,accountNumber:l,groupId:u,commitment:f*d,cashFlows:m.cashFlows.map(v=>({...v,amount:v.amount*d})),monthlyNav:m.monthlyNav.map(v=>({...v,amount:v.amount*d})),timestamp:new Date().toISOString()};await oe(h),I("Investment duplicated successfully")}else if(t?.value){const m=await ce(parseInt(t.value));if(!m){I("Fund not found","error"),U();return}const h={...m,fundName:c,accountNumber:l,groupId:u,commitment:f,timestamp:new Date().toISOString()};await oe(h),I("Investment updated successfully")}else{const m={fundName:c,accountNumber:l,groupId:u,commitment:f,cashFlows:[],monthlyNav:[],timestamp:new Date().toISOString()};await oe(m),I("Investment added successfully")}if(l){const h=(await q()).filter(v=>v.accountNumber===l&&v.groupId!==u);for(const v of h)await oe({...v,groupId:u})}g.setFundModalUnsavedChanges(!1),En(),R("fundModal"),g.clearMetricsCache(),await e()}catch(m){console.error("Error saving fund:",m),I("Error saving investment: "+m.message,"error")}finally{U()}}async function yo(e,t){const n=await ce(e);if(!n){I("Fund not found","error");return}if(await fe(`Are you sure you want to delete "${n.fundName}" (${n.accountNumber})? This action cannot be undone.`,{title:"Delete Investment",confirmText:"Delete",cancelText:"Cancel"}))try{K("Deleting..."),await ln(e),g.clearMetricsCache(),I("Investment deleted successfully"),await t()}catch(o){console.error("Error deleting fund:",o),I("Error deleting investment: "+o.message,"error")}finally{U()}}async function mt(e,t){const n=await ce(e);if(!n){I("Fund not found","error");return}g.setCurrentDetailsFundId(e);const a=document.getElementById("detailsModalTitle"),o=document.getElementById("detailsModalSubtitle"),s=document.querySelector("#cashFlowsTable tbody"),r=document.querySelector("#navTable tbody");a&&(a.textContent=n.fundName),o&&(o.textContent=n.accountNumber);const i=re(n),c=(l,u)=>{const f=document.getElementById(l);f&&(f.textContent=u)};c("detailsSummaryCommitment",B(n.commitment)),c("detailsSummaryContributions",B(i.calledCapital)),c("detailsSummaryDistributions",B(i.distributions)),c("detailsSummaryValue",B(i.nav)),c("detailsSummaryReturn",B(i.investmentReturn||0)),c("detailsSummaryOutstanding",B(i.outstandingCommitment)),s&&(s.innerHTML="",[...n.cashFlows].sort((u,f)=>new Date(u.date).getTime()-new Date(f.date).getTime()).forEach((u,f)=>{const p=document.createElement("tr");p.innerHTML=`
        <td><input type="date" value="${u.date}" data-field="date" data-index="${f}"></td>
        <td class="number"><input type="text" value="${We(Q(u.amount)||0)}" data-field="amount" data-index="${f}"></td>
        <td class="center">
          <select data-field="type" data-index="${f}">
            <option value="Contribution" ${u.type==="Contribution"?"selected":""}>Contribution</option>
            <option value="Distribution" ${u.type==="Distribution"?"selected":""}>Distribution</option>
            <option value="Adjustment" ${u.type==="Adjustment"?"selected":""}>Adjustment</option>
          </select>
        </td>
        <td class="center">
          <input type="checkbox" ${u.affectsCommitment!==!1?"checked":""} data-field="affectsCommitment" data-index="${f}">
        </td>
        <td>
          <button class="delete-row-btn" data-action="deleteCashFlow" data-index="${f}" title="Delete">×</button>
        </td>
      `,s.appendChild(p)})),r&&(r.innerHTML="",[...n.monthlyNav].sort((u,f)=>new Date(u.date).getTime()-new Date(f.date).getTime()).forEach((u,f)=>{const p=document.createElement("tr");p.innerHTML=`
        <td><input type="date" value="${u.date}" data-field="date" data-index="${f}"></td>
        <td><input type="text" value="${We(Q(u.amount)||0)}" data-field="amount" data-index="${f}"></td>
        <td>
          <button class="delete-row-btn" data-action="deleteNav" data-index="${f}" title="Delete">×</button>
        </td>
      `,r.appendChild(p)})),g.setUnsavedChanges(!1),Z("detailsModal")}function vo(){const e=document.querySelector("#cashFlowsTable tbody");if(!e)return;const t=e.querySelectorAll("tr").length,n=new Date().toISOString().split("T")[0],a=document.createElement("tr");a.innerHTML=`
    <td><input type="date" value="${n}" data-field="date" data-index="${t}"></td>
    <td class="number"><input type="text" value="" placeholder="0" data-field="amount" data-index="${t}"></td>
    <td class="center">
      <select data-field="type" data-index="${t}">
        <option value="Contribution" selected>Contribution</option>
        <option value="Distribution">Distribution</option>
        <option value="Adjustment">Adjustment</option>
      </select>
    </td>
    <td class="center">
      <input type="checkbox" checked data-field="affectsCommitment" data-index="${t}">
    </td>
    <td>
      <button class="delete-row-btn" data-action="deleteCashFlow" data-index="${t}" title="Delete">×</button>
    </td>
  `,e.insertBefore(a,e.firstChild),g.setUnsavedChanges(!0)}function bo(){const e=document.querySelector("#navTable tbody");if(!e)return;const t=e.querySelectorAll("tr").length,n=new Date().toISOString().split("T")[0],a=document.createElement("tr");a.innerHTML=`
    <td><input type="date" value="${n}" data-field="date" data-index="${t}"></td>
    <td><input type="text" value="" placeholder="0" data-field="amount" data-index="${t}"></td>
    <td>
      <button class="delete-row-btn" data-action="deleteNav" data-index="${t}" title="Delete">×</button>
    </td>
  `,e.insertBefore(a,e.firstChild),g.setUnsavedChanges(!0)}async function st(){const e=g.currentDetailsFundId;if(!e)return;const t=await ce(e);if(!t)return;const n=document.querySelectorAll("#cashFlowsTable tbody tr"),a=[];n.forEach(l=>{const u=l.querySelector('input[data-field="date"]'),f=l.querySelector('input[data-field="amount"]'),p=l.querySelector('select[data-field="type"]'),d=l.querySelector('input[data-field="affectsCommitment"]'),m=u?.value||"",h=Q(f?.value||"0"),v=p?.value||"Contribution",E=d?.checked??!0;m&&!isNaN(h)&&a.push({date:m,amount:h,type:v,affectsCommitment:E})});const o=document.querySelectorAll("#navTable tbody tr"),s=[];o.forEach(l=>{const u=l.querySelector('input[data-field="date"]'),f=l.querySelector('input[data-field="amount"]'),p=u?.value||"",d=Q(f?.value||"0");p&&!isNaN(d)&&s.push({date:p,amount:d})});const r={...t,cashFlows:a,monthlyNav:s},i=re(r),c=(l,u)=>{const f=document.getElementById(l);f&&(f.textContent=u)};c("detailsSummaryCommitment",B(t.commitment)),c("detailsSummaryContributions",B(i.calledCapital)),c("detailsSummaryDistributions",B(i.distributions)),c("detailsSummaryValue",B(i.nav)),c("detailsSummaryReturn",B(i.investmentReturn||0)),c("detailsSummaryOutstanding",B(i.outstandingCommitment))}async function Io(e){const t=g.currentDetailsFundId;if(!t)return;const n=await ce(t);if(!n){I("Fund not found","error");return}try{K("Saving...");const a=document.querySelectorAll("#cashFlowsTable tbody tr"),o=[];a.forEach(c=>{const l=c.querySelector('input[data-field="date"]'),u=c.querySelector('input[data-field="amount"]'),f=c.querySelector('select[data-field="type"]'),p=c.querySelector('input[data-field="affectsCommitment"]'),d=l?.value||"",m=Q(u?.value||"0"),h=f?.value||"Contribution",v=p?.checked??!0;d&&!isNaN(m)&&o.push({date:d,amount:m,type:h,affectsCommitment:v})});const s=document.querySelectorAll("#navTable tbody tr"),r=[];s.forEach(c=>{const l=c.querySelector('input[data-field="date"]'),u=c.querySelector('input[data-field="amount"]'),f=l?.value||"",p=Q(u?.value||"0");f&&!isNaN(p)&&r.push({date:f,amount:p})});const i={...n,cashFlows:o,monthlyNav:r,timestamp:new Date().toISOString()};await oe(i),g.clearMetricsCache(),g.setUnsavedChanges(!1),I("Changes saved successfully"),R("detailsModal"),await e()}catch(a){console.error("Error saving details:",a),I("Error saving changes: "+a.message,"error")}finally{U()}}function wo(e){g.setCurrentActionFundId(e)}function Ye(){return g.currentActionFundId}async function Ct(){const e=document.getElementById("groupsList");if(!e)return;const t=await ie();g.setGroups(t),he("newGroupParent");const n=$e(t,null),a=(o,s)=>{let i=`
      <div class="group-item" style="margin-left: ${s*20}px; padding: 10px; border-bottom: 1px solid var(--color-border);">
        <div style="display: flex; justify-content: space-between; align-items: center;">
          <div>
            <strong>${C(o.name)}</strong>
            ${o.type?`<span style="font-size: 0.85em; color: var(--color-text-light);"> (${C(o.type)})</span>`:""}
          </div>
          <div>
            <button class="btn-icon" data-action="editGroup" data-id="${o.id}" title="Edit">✎</button>
            <button class="btn-icon danger" data-action="deleteGroup" data-id="${o.id}" title="Delete">×</button>
          </div>
        </div>
      </div>
    `;return o.children&&o.children.length>0&&o.children.forEach(c=>{i+=a(c,s+1)}),i};e.innerHTML=n.map(o=>a(o,0)).join(""),Z("manageGroupsModal")}async function Eo(e){const t=document.getElementById("editGroupId"),n=document.getElementById("newGroupName"),a=document.getElementById("newGroupParent"),o=document.getElementById("newGroupType"),s=n?.value?.trim()||"",r=a?.value?parseInt(a.value):null,i=o?.value||"",c=t?.value?parseInt(t.value):null;if(!s){I("Please enter a group name","error");return}if(g.getGroups().find(f=>f.name.toLowerCase()===s.toLowerCase()&&f.id!==c)){I("A group with this name already exists","error");return}try{K("Saving...");const f={name:s,parentGroupId:r,type:i||void 0};c&&(f.id=c),await bt(f),g.clearMetricsCache(),I(c?"Group updated successfully":"Group added successfully"),n&&(n.value=""),o&&(o.value=""),a&&(a.value=""),t&&(t.value="");const p=await ie();g.setGroups(p),await Ct(),await e()}catch(f){console.error("Error saving group:",f),I("Error saving group: "+f.message,"error")}finally{U()}}async function So(e,t){const n=g.getGroupByIdSync(e);if(!n){I("Group not found","error");return}if(await fe(`Are you sure you want to delete "${n.name}"? Funds in this group will become ungrouped.`,{title:"Delete Group",confirmText:"Delete",cancelText:"Cancel"}))try{K("Deleting..."),await Yn(e);const o=await q();for(const r of o)r.groupId===e&&await oe({...r,groupId:null});const s=await ie();g.setGroups(s),I("Group deleted successfully"),await Ct(),await t()}catch(o){console.error("Error deleting group:",o),I("Error deleting group: "+o.message,"error")}finally{U()}}let ue=[];function ft(){ue=[]}async function Co(){const e=await q(),t=await ie(),n=new Map;t.forEach(s=>n.set(s.id,s.name));const a=new Map;for(const s of e)s.accountNumber&&(a.has(s.accountNumber)||a.set(s.accountNumber,[]),a.get(s.accountNumber).push(s));const o=[];for(const[s,r]of a){if(new Set(r.map(f=>f.groupId)).size<=1)continue;const c=new Map;for(const f of r)c.set(f.groupId,(c.get(f.groupId)||0)+1);let l=null,u=0;for(const[f,p]of c)f!==null&&(l===null||p>u)&&(l=f,u=p);o.push({accountNumber:s,funds:r.map(f=>({id:f.id,fundName:f.fundName,groupId:f.groupId,groupName:f.groupId?n.get(f.groupId)||"Unknown":"None"})),suggestedGroupId:l,suggestedGroupName:l?n.get(l)||"Unknown":"None"})}return o}async function No(){const e=document.getElementById("syncAccountGroupsContent"),t=document.getElementById("applySyncAccountGroupsBtn");if(!e||!t)return;if(e.innerHTML='<p style="color: var(--color-text-light);">Analyzing account groups...</p>',t.disabled=!0,Z("syncAccountGroupsModal"),ue=await Co(),ue.length===0){e.innerHTML=`
      <div style="padding: 20px; text-align: center; color: var(--color-success);">
        <p style="font-size: 16px; margin-bottom: 8px;">&#10003; All account numbers have consistent group assignments.</p>
        <p style="color: var(--color-text-light); font-size: 14px;">No sync needed.</p>
      </div>
    `,t.disabled=!0;return}let n=`
    <p style="margin-bottom: 16px; color: var(--color-warning);">
      Found <strong>${ue.length}</strong> account number${ue.length>1?"s":""} with inconsistent group assignments.
    </p>
    <table style="width: 100%; border-collapse: collapse; font-size: 13px;">
      <thead>
        <tr style="background: var(--color-alt-bg);">
          <th style="padding: 8px 12px; text-align: left; border-bottom: 1px solid var(--color-border);">Account #</th>
          <th style="padding: 8px 12px; text-align: left; border-bottom: 1px solid var(--color-border);">Current Groups</th>
          <th style="padding: 8px 12px; text-align: left; border-bottom: 1px solid var(--color-border);">Sync To</th>
        </tr>
      </thead>
      <tbody>
  `;for(const a of ue){const o=[...new Set(a.funds.map(s=>s.groupName))].join(", ");n+=`
      <tr>
        <td style="padding: 8px 12px; border-bottom: 1px solid var(--color-border);">${C(a.accountNumber)}</td>
        <td style="padding: 8px 12px; border-bottom: 1px solid var(--color-border);">${C(o)}</td>
        <td style="padding: 8px 12px; border-bottom: 1px solid var(--color-border); color: var(--color-action); font-weight: 500;">${C(a.suggestedGroupName)}</td>
      </tr>
    `}n+="</tbody></table>",e.innerHTML=n,t.disabled=!1}async function Fo(e){if(ue.length===0){I("No sync needed"),ft(),R("syncAccountGroupsModal");return}try{K("Syncing account groups...");let t=0;for(const n of ue)for(const a of n.funds)if(a.groupId!==n.suggestedGroupId){const o=await ce(a.id);o&&(await oe({...o,groupId:n.suggestedGroupId}),t++)}ft(),g.clearMetricsCache(),R("syncAccountGroupsModal"),I(`Synced groups for ${t} investment${t!==1?"s":""}`),await e()}catch(t){console.error("Error syncing account groups:",t),I("Error syncing account groups: "+t.message,"error")}finally{U()}}let ye=[];function Cn(){ye=[]}function Do(){const e=new Set;return g.fundNameData.forEach(t=>{t.tags&&t.tags.forEach(n=>e.add(n))}),[...e].sort()}async function Ge(){const e=document.getElementById("fundNamesList");if(!e)return;const t=await Le();e.innerHTML="",t.sort((n,a)=>n.name.localeCompare(a.name)).forEach(n=>{const a=document.createElement("div");a.className="fund-name-item",a.innerHTML=`
        <div>
          <strong>${C(n.name)}</strong>
          ${n.tags&&n.tags.length>0?`<div class="fund-name-tags">${n.tags.map(o=>`<span class="table-tag">${C(o)}</span>`).join("")}</div>`:""}
        </div>
        <div>
          <button class="btn-icon" data-action="editFundName" data-name="${Ne(n.name)}" title="Edit">✎</button>
          <button class="btn-icon danger" data-action="deleteFundName" data-name="${Ne(n.name)}" title="Delete">×</button>
        </div>
      `,e.appendChild(a)}),Z("manageFundNamesModal")}function Nt(){const e=document.getElementById("editFundTagsContainer");e&&(e.innerHTML="",ye.forEach((t,n)=>{const a=document.createElement("span");a.className="tag",a.innerHTML=`${C(t)} <button type="button" class="tag-remove" data-index="${n}">&times;</button>`,e.appendChild(a)}))}function Bo(e){const t=g.fundNameData.get(e);if(!t){I("Fund not found","error");return}ye=[...t.tags||[]];const n=document.getElementById("editFundNameOriginal"),a=document.getElementById("editFundNameInput"),o=document.getElementById("editFundTagsDatalist"),s=document.getElementById("editFundTermStartDate"),r=document.getElementById("editFundInvestmentTerm");n&&(n.value=e),a&&(a.value=e),s&&(s.value=t.investmentTermStartDate||""),r&&(r.value=t.investmentTermYears?.toString()||""),Nt(),o&&(o.innerHTML="",Do().forEach(i=>{const c=document.createElement("option");c.value=i,o.appendChild(c)})),Z("editFundNameModal")}function To(e){const t=e.trim();t&&!ye.includes(t)&&(ye.push(t),Nt())}function xo(e){ye.splice(e,1),Nt()}async function Ao(e){const t=document.getElementById("editFundNameOriginal"),n=document.getElementById("editFundNameInput"),a=document.getElementById("editFundTermStartDate"),o=document.getElementById("editFundInvestmentTerm"),s=t?.value,r=n?.value?.trim(),i=a?.value||null,c=o?.value?parseInt(o.value):null;if(!r){I("Please enter a fund name","error");return}if(r!==s&&g.fundNames.has(r)){I("A fund with this name already exists","error");return}try{if(K("Saving..."),r!==s&&s){const u=await q();for(const f of u)f.fundName===s&&await oe({...f,fundName:r,timestamp:new Date().toISOString()});await un(s),g.fundNames.delete(s),g.fundNameData.delete(s)}const l={name:r,tags:ye,investmentTermStartDate:i,investmentTermYears:c};await pe(l),g.fundNames.add(r),g.fundNameData.set(r,l),Cn(),R("editFundNameModal"),I("Fund updated successfully"),await Ge(),await e()}catch(l){console.error("Error saving fund name:",l),I("Error saving fund: "+l.message,"error")}finally{U()}}async function Mo(e,t){const a=(await q()).filter(s=>s.fundName===e);if(a.length>0){I(`Cannot delete: ${a.length} investment(s) use this fund name`,"error");return}if(await fe(`Are you sure you want to delete "${e}"? This action cannot be undone.`,{title:"Delete Fund Name",confirmText:"Delete",cancelText:"Cancel"}))try{K("Deleting..."),await un(e),g.fundNames.delete(e),g.fundNameData.delete(e),I("Fund name deleted successfully"),await Ge(),await t()}catch(s){console.error("Error deleting fund name:",s),I("Error deleting fund name: "+s.message,"error")}finally{U()}}async function ko(e){const t=document.getElementById("newFundNameInput"),n=document.getElementById("newFundTermStartDate"),a=document.getElementById("newFundInvestmentTerm"),o=t?.value?.trim(),s=n?.value||null,r=a?.value?parseInt(a.value):null;if(!o){I("Please enter a fund name","error");return}if(g.fundNames.has(o)){I("A fund with this name already exists","error");return}try{K("Adding...");const i={name:o,tags:[],investmentTermStartDate:s,investmentTermYears:r};await pe(i),g.fundNames.add(o),g.fundNameData.set(o,i),t&&(t.value=""),n&&(n.value=""),a&&(a.value="");const c=document.getElementById("newFundTermsDetails");c&&(c.open=!1),I("Fund name added successfully"),await Ge(),await e()}catch(i){console.error("Error adding fund name:",i),I("Error adding fund name: "+i.message,"error")}finally{U()}}async function Lo(){const e=document.getElementById("newFundNameInline"),t=e?.value?.trim();if(!t){I("Please enter a fund name","error");return}if(g.fundNames.has(t)){I("A fund with this name already exists","error");return}try{const n={name:t,tags:[],investmentTermStartDate:null,investmentTermYears:null};await pe(n),g.fundNames.add(t),g.fundNameData.set(t,n),await Re();const a=document.getElementById("fundName");a&&(a.value=t);const o=document.getElementById("newFundNameContainer");o&&(o.style.display="none"),e&&(e.value=""),I("Fund name added successfully")}catch(n){console.error("Error adding fund name:",n),I("Error adding fund name: "+n.message,"error")}}function $o(){const e=document.getElementById("newFundNameContainer"),t=document.getElementById("newFundNameInline"),n=document.getElementById("fundName");e&&(e.style.display="none"),t&&(t.value=""),n&&(n.value="")}function ne(e){if(e==null)return"";const t=typeof e=="number"?e:parseFloat(String(e));return!isFinite(t)||isNaN(t)?"":t.toFixed(2)}function z(e){if(e==null)return"";const t=String(e);if(!isNaN(Number(t))&&t.trim()!=="")return t;const n=t.charAt(0);return t.length>0&&["=","+","-","@","	","\r"].includes(n)?"'"+t:t}async function Nn(){try{const e=await q(),t=await Le(),n=await ie(),a={funds:e,fundNames:t,groups:n,exportDate:new Date().toISOString()},o=JSON.stringify(a,null,2),s=new Blob([o],{type:"application/json"}),i=`pe-funds-export-${new Date().toISOString().replace(/[:.]/g,"-")}.json`;if("showSaveFilePicker"in window)try{const f=await(await window.showSaveFilePicker({suggestedName:i,types:[{description:"JSON Files",accept:{"application/json":[".json"]}}]})).createWritable();await f.write(s),await f.close(),g.markDataExported(),I("Data exported successfully");return}catch(u){if(u.name==="AbortError")return;throw u}const c=URL.createObjectURL(s),l=document.createElement("a");l.href=c,l.download=i,document.body.appendChild(l),l.click(),document.body.removeChild(l),URL.revokeObjectURL(c),g.markDataExported(),I("Data exported successfully")}catch(e){I("Error exporting data: "+e.message,"error"),console.error("Error exporting data:",e)}}async function Ro(){K("Exporting to CSV...");try{const e=await q();let t=Et(e);g.sortColumns.length>0&&(t=vn(t,g.sortColumns));const a=document.getElementById("cutoffDate")?.value,o=a?new Date(a+"T00:00:00"):void 0,s=t.map(m=>({...m,metrics:re(m,o)})),r=localStorage.getItem(b.STORAGE_GROUP_BY_FUND)==="true";let i,c;if(r){const m=In(s,o,g.sortColumns);i=["Fund Name","Vintage","Investor Count","Total Commitment","Total Contributions","Total Distributions","Total NAV","Investment Return","MOIC","IRR","Outstanding Commitment"],c=m.map(h=>{const v=h.consolidatedMetrics,E=v.investmentReturn??v.distributions+v.nav-v.calledCapital;return[Fe(h.fundName),Fe(v.vintageYear?.toString()||""),z(h.investorCount.toString()),z(ne(v.commitment)),z(ne(v.calledCapital)),z(ne(v.distributions)),z(ne(v.nav)),z(ne(E)),z(v.moic!==null&&isFinite(v.moic)?v.moic.toFixed(2):""),z(v.irr!==null?(v.irr*100).toFixed(2):""),z(ne(v.outstandingCommitment))].join(",")})}else i=["Fund Name","Account Number","Vintage","Commitment","Total Contributions","Total Distributions","NAV","Investment Return","MOIC","IRR","Outstanding Commitment"],c=s.map(m=>{const h=m.metrics,v=h.investmentReturn??h.distributions+h.nav-h.calledCapital;return[Fe(m.fundName),Fe(m.accountNumber),Fe(h.vintageYear?.toString()||""),z(ne(h.commitment)),z(ne(h.calledCapital)),z(ne(h.distributions)),z(ne(h.nav)),z(ne(v)),z(h.moic!==null&&isFinite(h.moic)?h.moic.toFixed(2):""),z(h.irr!==null?(h.irr*100).toFixed(2):""),z(ne(h.outstandingCommitment))].join(",")});const l=[i.join(","),...c].join(`
`),u=new Blob([l],{type:"text/csv;charset=utf-8;"}),p=`pe-funds-export-${new Date().toISOString().replace(/[:.]/g,"-").split("T")[0]}.csv`,d=document.createElement("a");if(d.download!==void 0){const m=URL.createObjectURL(u);d.setAttribute("href",m),d.setAttribute("download",p),d.style.visibility="hidden",document.body.appendChild(d),d.click(),document.body.removeChild(d),URL.revokeObjectURL(m)}I("CSV exported successfully")}catch(e){I("Error exporting CSV: "+e.message,"error"),console.error("Error exporting CSV:",e)}finally{U()}}function Go(){window.print()}function pt(e,t=0){if(t>b.MAX_JSON_DEPTH)throw new Error("Object too deeply nested");if(e===null||typeof e!="object")return e;if(Array.isArray(e))return e.map(a=>pt(a,t+1));const n=Object.create(null);for(const a of Object.keys(e)){if(b.DANGEROUS_KEYS.includes(a)){console.warn(`Blocked potentially dangerous key: ${a}`);continue}n[a]=pt(e[a],t+1)}return n}function Oo(e){const t=JSON.parse(e);return pt(t)}function _o(e){const t=document.getElementById("srAnnounce");t&&(t.textContent=e,setTimeout(()=>{t.textContent=""},1e3))}let Ce=null;async function Po(e){const t=await q(),n=new Map;t.forEach(r=>{if(r.groupId){const i=r.accountNumber.replace(/\s/g,"").toLowerCase();n.has(i)||n.set(i,[]);const c=n.get(i);c.includes(r.groupId)||c.push(r.groupId)}});let a=0,o=0;const s=[];for(const r of e)if(r.groupId==null&&r.accountNumber){const i=r.accountNumber.replace(/\s/g,"").toLowerCase(),c=n.get(i);c&&c.length===1?(r.groupId=c[0],r._groupAutoFilled=!0,a++):c&&c.length>1&&(o++,s.includes(r.accountNumber)||s.push(r.accountNumber))}return{enrichedCount:a,ambiguousCount:o,ambiguousAccounts:s}}function Uo(){Ce=null;const e=document.getElementById("importPreviewContent"),t=document.getElementById("applyImportBtn"),n=document.getElementById("importPreviewFileInput");e&&(e.innerHTML='<p style="color: var(--color-text-light);">Select a JSON file to preview...</p>'),t&&(t.disabled=!0),n&&(n.value=""),Z("importPreviewModal")}async function qo(e){const t=e.target,n=t.files?.[0];if(!n)return;const a=document.getElementById("importPreviewContent"),o=document.getElementById("applyImportBtn");if(n.size>b.MAX_FILE_SIZE){a&&(a.innerHTML=`<p style="color: var(--color-danger);">File too large (${(n.size/1024/1024).toFixed(2)}MB). Maximum size is ${b.MAX_FILE_SIZE/1024/1024}MB.</p>`),t.value="";return}try{const s=await n.text(),r=Oo(s);Ce=r;const i=r.funds||r,c=Array.isArray(i)?i.length:0,l=r.groups?.length||0,u=r.fundNames?.length||0,f=await q(),p=new Set;f.forEach(w=>{const k=`${w.fundName}|${w.accountNumber}`.toLowerCase();p.add(k)});const d=[],m=[],h=new Set;if(Array.isArray(i))for(const w of i){const k=(w.accountNumber||"").replace(/\s/g,""),j=`${w.fundName}|${k}`.toLowerCase();p.has(j)||h.has(j)?d.push({fundName:w.fundName,accountNumber:w.accountNumber}):(m.push({fundName:w.fundName,accountNumber:w.accountNumber}),h.add(j))}const v=await ie(),E=new Set(v.map(w=>w.name.toLowerCase()));let T=0,F=0;if(r.groups&&Array.isArray(r.groups))for(const w of r.groups)E.has(w.name.toLowerCase())?T++:F++;let D=`
      <div style="margin-bottom: 15px;">
        <strong>File:</strong> ${C(n.name)}<br>
        <strong>Size:</strong> ${(n.size/1024).toFixed(2)} KB
      </div>
      <div style="margin-bottom: 15px;">
        <strong>Contents:</strong>
        <ul style="margin: 10px 0 0 20px;">
          <li>${c} fund(s)</li>
          ${l>0?`<li>${l} group(s)</li>`:""}
          ${u>0?`<li>${u} fund name(s)</li>`:""}
        </ul>
      </div>
    `;c>0&&(D+=`
        <div style="margin-bottom: 15px; padding: 12px; background: var(--color-alt-bg); border-radius: var(--radius-sm);">
          <strong>Import Analysis:</strong>
          <ul style="margin: 10px 0 0 20px;">
            <li style="color: var(--color-success);">${m.length} new fund(s) will be imported</li>
            ${d.length>0?`<li style="color: var(--color-warning);">${d.length} duplicate(s) will be skipped</li>`:""}
            ${F>0?`<li style="color: var(--color-success);">${F} new group(s) will be created</li>`:""}
            ${T>0?`<li style="color: var(--color-warning);">${T} existing group(s) will be skipped</li>`:""}
          </ul>
        </div>
      `),d.length>0&&(D+=`
        <div style="margin-bottom: 15px;">
          <strong style="color: var(--color-warning);">Duplicates to skip:</strong>
          <ul style="margin: 10px 0 0 20px; font-size: 0.9em; color: var(--color-warning);">
            ${d.slice(0,5).map(w=>`<li>${C(w.fundName)} (${C(w.accountNumber)})</li>`).join("")}
            ${d.length>5?`<li>... and ${d.length-5} more</li>`:""}
          </ul>
        </div>
      `),m.length>0&&(D+=`
        <div>
          <strong>New funds to import:</strong>
          <ul style="margin: 10px 0 0 20px; font-size: 0.9em;">
            ${m.slice(0,5).map(w=>`<li>${C(w.fundName)} (${C(w.accountNumber)})</li>`).join("")}
            ${m.length>5?`<li>... and ${m.length-5} more</li>`:""}
          </ul>
        </div>
      `),a&&(a.innerHTML=D),o&&(o.disabled=m.length===0&&F===0&&u===0)}catch(s){a&&(a.innerHTML=`<p style="color: var(--color-danger);">Error reading file: ${C(s.message)}</p>`),Ce=null,t.value=""}}async function jo(e){if(!Ce){I("No import data available","error");return}R("importPreviewModal"),K("Importing data...");try{const t=Ce;let n=0;const a={};if(t.groups&&Array.isArray(t.groups)){if(t.groups.length>b.MAX_IMPORT_GROUPS)throw new Error(`Too many groups (${t.groups.length}). Maximum allowed is ${b.MAX_IMPORT_GROUPS}.`);const d=new Set(t.groups.map(F=>F.id));for(const F of t.groups)F.parentGroupId!=null&&(d.has(F.parentGroupId)||(F.parentGroupId=null),F.id===F.parentGroupId&&(F.parentGroupId=null));const m=[],h=new Set;let v=[...t.groups];for(;v.length>0;){const F=v.length;for(let D=v.length-1;D>=0;D--){const w=v[D];(w.parentGroupId==null||h.has(w.parentGroupId))&&(m.push(w),h.add(w.id),v.splice(D,1))}if(v.length===F){console.warn(`Import: ${v.length} group(s) had circular parent references and were moved to root level:`,v.map(D=>D.name)),v.forEach(D=>{D.parentGroupId=null,m.push(D)});break}}const E=await ie(),T={};E.forEach(F=>{T[F.name.toLowerCase()]=F});for(const F of m){const D=F.id,{id:w,...k}=F;k.parentGroupId!=null&&a[k.parentGroupId]&&(k.parentGroupId=a[k.parentGroupId]);const j=T[k.name.toLowerCase()];if(j)D!=null&&(a[D]=j.id);else{const G=await bt(k);D!=null&&G&&(a[D]=G),T[k.name.toLowerCase()]={...k,id:G}}}g.setGroups(await ie())}if(t.fundNames&&Array.isArray(t.fundNames)){if(t.fundNames.length>b.MAX_IMPORT_FUNDNAMES)throw new Error(`Too many fund names (${t.fundNames.length}). Maximum allowed is ${b.MAX_IMPORT_FUNDNAMES}.`);const d=[];for(const m of t.fundNames){const h=typeof m=="string"?{name:m,tags:[],investmentTermStartDate:null,investmentTermYears:null}:{name:m.name,tags:m.tags||[],investmentTermStartDate:m.investmentTermStartDate||m.finalCloseDate||null,investmentTermYears:m.investmentTermYears||null};await pe(h),d.push(h)}for(const m of d)g.fundNames.add(m.name),g.fundNameData.set(m.name,m)}const o=t.funds||t;if(!Array.isArray(o))throw new Error("Invalid format: expected array of funds");if(o.length>b.MAX_IMPORT_FUNDS)throw new Error(`Too many funds (${o.length}). Maximum allowed is ${b.MAX_IMPORT_FUNDS}.`);const s=new Set;o.forEach(d=>{d.fundName&&!g.fundNames.has(d.fundName)&&s.add(d.fundName)});for(const d of s){const m={name:d,tags:[],investmentTermStartDate:null,investmentTermYears:null};await pe(m),g.fundNames.add(d),g.fundNameData.set(d,m)}const r=await Po(o),i=await q(),c=new Set;i.forEach(d=>{const m=`${d.fundName}|${d.accountNumber}`.toLowerCase();c.add(m)});const l=[],u=[],f=[];for(let d=0;d<o.length;d++){const m=o[d],h=(m.accountNumber||"").replace(/\s/g,""),v=`${m.fundName}|${h}`.toLowerCase();if(c.has(v))continue;const E=(m.cashFlows||[]).map(w=>({date:w.date,amount:Q(w.amount),type:w.type||(w.amount<0?"Contribution":"Distribution"),affectsCommitment:w.affectsCommitment!==void 0?w.affectsCommitment:!0})),T=(m.monthlyNav||[]).map(w=>({date:w.date,amount:Q(w.amount)})),F={fundName:m.fundName,accountNumber:(m.accountNumber||"").replace(/\s/g,""),commitment:Q(m.commitment),cashFlows:E,monthlyNav:T},D=cn(F);D.valid||f.push({index:d,name:m.fundName||m.accountNumber||`Fund ${d+1}`,errors:D.errors})}if(f.length>0){const d=f.slice(0,5).map(h=>`• ${h.name}: ${h.errors.slice(0,2).join("; ")}`).join(`
`),m=f.length>5?`
...and ${f.length-5} more`:"";throw new Error(`Import aborted: ${f.length} fund(s) failed validation.

${d}${m}`)}for(let d=0;d<o.length;d++){const m=o[d],h=(m.accountNumber||"").replace(/\s/g,""),v=`${m.fundName}|${h}`.toLowerCase();if(c.has(v)){l.push({index:d,name:m.fundName,account:m.accountNumber});continue}try{c.add(v);const E=(m.cashFlows||[]).map(w=>({date:w.date,amount:Q(w.amount),type:w.type||(w.amount<0?"Contribution":"Distribution"),affectsCommitment:w.affectsCommitment!==void 0?w.affectsCommitment:!0})),T=(m.monthlyNav||[]).map(w=>({date:w.date,amount:Q(w.amount)}));let F=null;m.groupId!=null&&(m._groupAutoFilled?F=m.groupId:a[m.groupId]&&(F=a[m.groupId]));const D={fundName:m.fundName,accountNumber:(m.accountNumber||"").replace(/\s/g,""),groupId:F,commitment:Q(m.commitment),cashFlows:E,monthlyNav:T,timestamp:m.timestamp||new Date().toISOString()};await oe(D),n++}catch(E){console.error(`Error importing fund at index ${d}:`,E),u.push({index:d,name:m.fundName||m.accountNumber||"Unknown",error:E.message})}}if(u.length>0||l.length>0){const d=[];n>0&&d.push(`${n} imported`),l.length>0&&d.push(`${l.length} duplicates skipped`),u.length>0&&d.push(`${u.length} failed`),r.enrichedCount>0&&d.push(`${r.enrichedCount} groups auto-filled`);const m=u.length>0?"error":"success";I(`Import complete: ${d.join(", ")}`,m)}else{let d=`Successfully imported ${n} fund(s)`;r.enrichedCount>0&&(d+=` (${r.enrichedCount} groups auto-filled)`),I(d)}Ce=null;const p={fundFilter:L("fundFilter"),accountFilter:L("accountFilter"),groupFilter:L("groupFilter"),tagFilter:L("tagFilter"),vintageFilter:L("vintageFilter")};await e(),Ee("fundFilter",p.fundFilter),Ee("accountFilter",p.accountFilter),Ee("groupFilter",p.groupFilter),Ee("tagFilter",p.tagFilter),Ee("vintageFilter",p.vintageFilter),await e()}catch(t){I("Error importing data: "+t.message,"error"),console.error("Error importing data:",t)}finally{U()}}async function Yo(e){K("Loading sample data...");try{const t=[{name:"Buyout Funds",parentGroupId:null,type:"Strategy"},{name:"Venture Capital",parentGroupId:null,type:"Strategy"},{name:"Real Estate",parentGroupId:null,type:"Strategy"}],n={};for(const s of t){const r=await bt(s);n[s.name]=r}g.setGroups(await ie());const a=[{name:"Apex Capital Partners",tags:["Buyout","North America"],investmentTermStartDate:"2020-06-15",investmentTermYears:10},{name:"Summit Growth Fund",tags:["Growth","Technology"],investmentTermStartDate:"2021-03-01",investmentTermYears:10},{name:"Horizon Ventures",tags:["Venture","Early Stage"],investmentTermStartDate:"2022-01-10",investmentTermYears:12},{name:"Metro Real Estate Partners",tags:["Real Estate","Commercial"],investmentTermStartDate:"2019-09-01",investmentTermYears:8},{name:"Blue Ocean Capital",tags:["Buyout","Europe"],investmentTermStartDate:"2021-07-20",investmentTermYears:10}];for(const s of a)await pe(s),g.fundNames.add(s.name),g.fundNameData.set(s.name,s);const o=[{fundName:"Apex Capital Partners",accountNumber:"APEX-001",groupId:n["Buyout Funds"]??null,commitment:5e6,cashFlows:[{date:"2020-07-01",amount:-125e4,type:"Contribution",affectsCommitment:!0},{date:"2020-12-15",amount:-1e6,type:"Contribution",affectsCommitment:!0},{date:"2021-06-30",amount:-75e4,type:"Contribution",affectsCommitment:!0},{date:"2022-03-15",amount:-5e5,type:"Contribution",affectsCommitment:!0},{date:"2023-01-20",amount:8e5,type:"Distribution",affectsCommitment:!0},{date:"2023-09-10",amount:12e5,type:"Distribution",affectsCommitment:!0}],monthlyNav:[{date:"2021-12-31",amount:32e5},{date:"2022-12-31",amount:38e5},{date:"2023-12-31",amount:45e5}],timestamp:new Date().toISOString()},{fundName:"Summit Growth Fund",accountNumber:"SUMMIT-001",groupId:n["Venture Capital"]??null,commitment:25e5,cashFlows:[{date:"2021-04-01",amount:-625e3,type:"Contribution",affectsCommitment:!0},{date:"2021-10-15",amount:-5e5,type:"Contribution",affectsCommitment:!0},{date:"2022-06-30",amount:-375e3,type:"Contribution",affectsCommitment:!0},{date:"2023-06-15",amount:4e5,type:"Distribution",affectsCommitment:!0}],monthlyNav:[{date:"2022-12-31",amount:18e5},{date:"2023-12-31",amount:22e5}],timestamp:new Date().toISOString()},{fundName:"Horizon Ventures",accountNumber:"HV-001",groupId:n["Venture Capital"]??null,commitment:1e6,cashFlows:[{date:"2022-02-01",amount:-25e4,type:"Contribution",affectsCommitment:!0},{date:"2022-08-15",amount:-2e5,type:"Contribution",affectsCommitment:!0},{date:"2023-04-01",amount:-15e4,type:"Contribution",affectsCommitment:!0}],monthlyNav:[{date:"2022-12-31",amount:52e4},{date:"2023-12-31",amount:75e4}],timestamp:new Date().toISOString()},{fundName:"Metro Real Estate Partners",accountNumber:"METRO-001",groupId:n["Real Estate"]??null,commitment:3e6,cashFlows:[{date:"2019-10-01",amount:-75e4,type:"Contribution",affectsCommitment:!0},{date:"2020-04-15",amount:-6e5,type:"Contribution",affectsCommitment:!0},{date:"2020-12-01",amount:-45e4,type:"Contribution",affectsCommitment:!0},{date:"2021-06-30",amount:-3e5,type:"Contribution",affectsCommitment:!0},{date:"2022-03-15",amount:5e5,type:"Distribution",affectsCommitment:!0},{date:"2023-03-15",amount:6e5,type:"Distribution",affectsCommitment:!0}],monthlyNav:[{date:"2021-12-31",amount:24e5},{date:"2022-12-31",amount:28e5},{date:"2023-12-31",amount:31e5}],timestamp:new Date().toISOString()},{fundName:"Blue Ocean Capital",accountNumber:"BOC-001",groupId:n["Buyout Funds"]??null,commitment:4e6,cashFlows:[{date:"2021-08-01",amount:-1e6,type:"Contribution",affectsCommitment:!0},{date:"2022-02-15",amount:-8e5,type:"Contribution",affectsCommitment:!0},{date:"2022-09-01",amount:-6e5,type:"Contribution",affectsCommitment:!0},{date:"2023-05-15",amount:7e5,type:"Distribution",affectsCommitment:!0}],monthlyNav:[{date:"2022-12-31",amount:26e5},{date:"2023-12-31",amount:32e5}],timestamp:new Date().toISOString()}];for(const s of o)await oe(s);g.clearMetricsCache(),I(`Successfully loaded ${o.length} sample investments`),await e()}catch(t){I("Error loading sample data: "+t.message,"error"),console.error("Error loading sample data:",t)}finally{U()}}async function Fn(e){const t=document.getElementById(e);if(!t)return;const a=(await Le()).map(o=>o.name).sort();t.innerHTML='<option value="">Select a fund</option>',a.forEach(o=>{const s=document.createElement("option");s.value=o,s.textContent=o,t.appendChild(s)})}async function Ho(e){const t=document.getElementById(e);if(!t)return;const n=await q(),a=[...new Set(n.map(o=>o.accountNumber))].sort();t.innerHTML='<option value="">Select an account</option>',a.forEach(o=>{const s=document.createElement("option");s.value=o,s.textContent=o,t.appendChild(s)})}async function Vo(){await Fn("bulkCashFlowFundName");const e=document.getElementById("bulkCashFlowDate"),t=document.getElementById("bulkCashFlowType"),n=document.getElementById("bulkCashFlowPercentage"),a=document.getElementById("bulkCashFlowAffectsCommitment"),o=document.getElementById("bulkCashFlowPreview"),s=document.getElementById("applyBulkCashFlowBtn");e&&(e.value=new Date().toISOString().split("T")[0]||""),t&&(t.value="Contribution"),n&&(n.value=""),a&&(a.checked=!0),o&&(o.style.display="none"),s&&(s.disabled=!0),Z("bulkCashFlowModal")}async function zo(){const e=document.getElementById("bulkCashFlowFundName"),t=document.getElementById("bulkCashFlowPercentage"),n=document.getElementById("bulkCashFlowType"),a=document.getElementById("bulkCashFlowPreview"),o=document.getElementById("bulkCashFlowPreviewContent"),s=document.getElementById("applyBulkCashFlowBtn"),r=e?.value,i=parseFloat(t?.value||"0"),c=n?.value||"Contribution";if(!r){I("Please select a fund","error");return}if(isNaN(i)||i<=0||i>100){I("Please enter a valid percentage (0.01 - 100)","error");return}const u=(await q()).filter(m=>m.fundName===r);if(u.length===0){I("No investments found for this fund","error");return}let f='<table style="width: 100%; font-size: 0.9em;"><thead><tr><th>Account</th><th style="text-align: right;">Commitment</th><th style="text-align: right;">Amount</th></tr></thead><tbody>',p=0;u.forEach(m=>{const h=m.commitment*(i/100);p+=h;const v=c==="Contribution"?-h:h;f+=`<tr><td>${C(m.accountNumber)}</td><td style="text-align: right;">${B(m.commitment)}</td><td style="text-align: right;">${B(v)}</td></tr>`});const d=c==="Contribution"?-p:p;f+=`</tbody><tfoot><tr style="font-weight: bold;"><td>Total (${u.length} investors)</td><td></td><td style="text-align: right;">${B(d)}</td></tr></tfoot></table>`,o&&(o.innerHTML=f),a&&(a.style.display="block"),s&&(s.disabled=!1)}async function Wo(e){const t=document.getElementById("bulkCashFlowFundName"),n=document.getElementById("bulkCashFlowDate"),a=document.getElementById("bulkCashFlowType"),o=document.getElementById("bulkCashFlowPercentage"),s=document.getElementById("bulkCashFlowAffectsCommitment"),r=t?.value,i=n?.value,c=a?.value||"Contribution",l=parseFloat(o?.value||"0"),u=s?.checked??!0;if(!r||!i||isNaN(l)){I("Missing required fields","error");return}R("bulkCashFlowModal"),K("Applying bulk cash flow...");try{const p=(await q()).filter(m=>m.fundName===r);let d=0;for(const m of p){const h=m.commitment*(l/100),v=c==="Contribution"?-h:h,E={...m,cashFlows:[...m.cashFlows,{date:i,amount:v,type:c,affectsCommitment:u}],timestamp:new Date().toISOString()};await oe(E),d++}g.clearMetricsCache(),I(`Successfully added cash flow to ${d} investment(s)`),await e()}catch(f){I("Error applying bulk cash flow: "+f.message,"error")}finally{U()}}async function Ko(){await Fn("bulkRemoveFundName");const e=document.getElementById("bulkRemoveFundPreview"),t=document.getElementById("applyBulkRemoveFundBtn");e&&(e.style.display="none"),t&&(t.disabled=!0),Z("bulkRemoveFundModal")}async function Xo(){const e=document.getElementById("bulkRemoveFundName"),t=document.getElementById("bulkRemoveFundPreview"),n=document.getElementById("bulkRemoveFundPreviewContent"),a=document.getElementById("applyBulkRemoveFundBtn"),o=e?.value;if(!o){I("Please select a fund","error");return}const r=(await q()).filter(c=>c.fundName===o);if(r.length===0){I("No investments found for this fund","error");return}let i='<ul style="margin: 0; padding-left: 20px;">';r.forEach(c=>{i+=`<li>${C(c.accountNumber)} - ${B(c.commitment)}</li>`}),i+="</ul>",i+=`<p style="margin-top: 10px; font-weight: bold; color: var(--color-danger);">Total: ${r.length} investment(s) will be permanently deleted.</p>`,n&&(n.innerHTML=i),t&&(t.style.display="block"),a&&(a.disabled=!1)}async function Jo(e){const n=document.getElementById("bulkRemoveFundName")?.value;if(!n){I("Please select a fund","error");return}R("bulkRemoveFundModal"),K("Removing investments...");try{const o=(await q()).filter(r=>r.fundName===n);let s=0;for(const r of o)r.id&&(await ln(r.id),s++);g.clearMetricsCache(),I(`Successfully removed ${s} investment(s)`),await e()}catch(a){I("Error removing investments: "+a.message,"error")}finally{U()}}async function Zo(){await Ho("bulkAssignGroupAccount"),he("bulkAssignGroupTarget");const e=document.getElementById("bulkAssignGroupPreview"),t=document.getElementById("applyBulkAssignGroupBtn");e&&(e.style.display="none"),t&&(t.disabled=!0),Z("bulkAssignGroupModal")}async function Qo(){const e=document.getElementById("bulkAssignGroupAccount"),t=document.getElementById("bulkAssignGroupTarget"),n=document.getElementById("bulkAssignGroupPreview"),a=document.getElementById("bulkAssignGroupPreviewContent"),o=document.getElementById("applyBulkAssignGroupBtn"),s=e?.value,r=t?.value?parseInt(t.value):null;if(!s){I("Please select an account","error");return}const c=(await q()).filter(f=>f.accountNumber===s);if(c.length===0){I("No investments found for this account","error");return}const l=r?g.getGroupByIdSync(r)?.name||"Unknown":"No Group";let u='<ul style="margin: 0; padding-left: 20px;">';c.forEach(f=>{u+=`<li>${C(f.fundName)}</li>`}),u+="</ul>",u+=`<p style="margin-top: 10px;">These ${c.length} investment(s) will be assigned to: <strong>${C(l)}</strong></p>`,a&&(a.innerHTML=u),n&&(n.style.display="block"),o&&(o.disabled=!1)}async function ea(e){const t=document.getElementById("bulkAssignGroupAccount"),n=document.getElementById("bulkAssignGroupTarget"),a=t?.value,o=n?.value?parseInt(n.value):null;if(!a){I("Please select an account","error");return}R("bulkAssignGroupModal"),K("Assigning group...");try{const r=(await q()).filter(c=>c.accountNumber===a);let i=0;for(const c of r){const l={...c,groupId:o,timestamp:new Date().toISOString()};await oe(l),i++}g.clearMetricsCache(),I(`Successfully updated ${i} investment(s)`),await e()}catch(s){I("Error assigning group: "+s.message,"error")}finally{U()}}function ta(e){const t=document.getElementById("closeBulkCashFlowModalBtn"),n=document.getElementById("cancelBulkCashFlowBtn"),a=document.getElementById("previewBulkCashFlowBtn"),o=document.getElementById("applyBulkCashFlowBtn");[t,n].forEach(d=>{d&&d.addEventListener("click",()=>R("bulkCashFlowModal"))}),a&&a.addEventListener("click",zo),o&&o.addEventListener("click",()=>Wo(e));const s=document.getElementById("closeBulkRemoveFundModalBtn"),r=document.getElementById("cancelBulkRemoveFundBtn"),i=document.getElementById("previewBulkRemoveFundBtn"),c=document.getElementById("applyBulkRemoveFundBtn");[s,r].forEach(d=>{d&&d.addEventListener("click",()=>R("bulkRemoveFundModal"))}),i&&i.addEventListener("click",Xo),c&&c.addEventListener("click",()=>Jo(e));const l=document.getElementById("closeBulkAssignGroupModalBtn"),u=document.getElementById("cancelBulkAssignGroupBtn"),f=document.getElementById("previewBulkAssignGroupBtn"),p=document.getElementById("applyBulkAssignGroupBtn");[l,u].forEach(d=>{d&&d.addEventListener("click",()=>R("bulkAssignGroupModal"))}),f&&f.addEventListener("click",Qo),p&&p.addEventListener("click",()=>ea(e))}function na(e,t){const n={calls:{},distributions:{},byFund:{}},a=t?t.getFullYear():new Date().getFullYear();return e.forEach(o=>{if(!o.cashFlows||o.cashFlows.length===0)return;const s=o.fundName;n.byFund[s]||(n.byFund[s]={calls:{},distributions:{}}),o.cashFlows.forEach(r=>{if(!r.date)return;const i=new Date(r.date+"T00:00:00"),c=i.getFullYear();if(r.type==="Adjustment"||t&&i>t||c>a)return;const l=Math.abs(r.amount);r.type==="Contribution"?(n.calls[c]=(n.calls[c]||0)+l,n.byFund[s].calls[c]=(n.byFund[s].calls[c]||0)+l):r.type==="Distribution"&&(n.distributions[c]=(n.distributions[c]||0)+l,n.byFund[s].distributions[c]=(n.byFund[s].distributions[c]||0)+l)})}),n}function oa(e,t,n){const a={projectedCalls:{},byFund:{},estimatedCalls:{},estimatedByFund:{},estimatedYears:new Set},o=n||new Date,s=o.getFullYear(),r=4;return e.forEach(i=>{const c=t.get(i.fundName);if(!c)return;const{investmentTermStartDate:l,investmentTermYears:u}=c;if(!l||!u){const w=i.commitment||0,k=(i.cashFlows||[]).filter(G=>G.type==="Adjustment"||n&&new Date(G.date+"T00:00:00")>n?!1:G.type==="Contribution").reduce((G,Y)=>G+Math.abs(Y.amount),0),j=Math.max(0,w-k);if(j>0){const G=s+1,Y=j/r,te=i.fundName;a.estimatedByFund[te]||(a.estimatedByFund[te]={});for(let le=0;le<r;le++){const X=G+le;a.estimatedCalls[X]=(a.estimatedCalls[X]||0)+Y,a.estimatedByFund[te][X]=(a.estimatedByFund[te][X]||0)+Y,a.estimatedYears.add(X)}}return}const f=new Date(l+"T00:00:00"),p=new Date(f);if(p.setFullYear(p.getFullYear()+u),p<o)return;const d=i.commitment||0,m=(i.cashFlows||[]).filter(w=>w.type==="Adjustment"||n&&new Date(w.date+"T00:00:00")>n?!1:w.type==="Contribution").reduce((w,k)=>w+Math.abs(k.amount),0),h=Math.max(0,d-m);if(h<=0)return;const v=Math.max(s+1,f.getFullYear()),E=p.getFullYear(),T=[];for(let w=v;w<=E;w++)T.push(w);if(T.length===0)return;const F=h/T.length,D=i.fundName;a.byFund[D]||(a.byFund[D]={}),T.forEach(w=>{a.projectedCalls[w]=(a.projectedCalls[w]||0)+F,a.byFund[D][w]=(a.byFund[D][w]||0)+F})}),a}function aa(e,t,n){const a=n||new Date().getFullYear(),o=new Set;Object.keys(e.calls).forEach(h=>o.add(parseInt(h))),Object.keys(e.distributions).forEach(h=>o.add(parseInt(h))),Object.keys(t.projectedCalls).forEach(h=>o.add(parseInt(h))),Object.keys(t.estimatedCalls||{}).forEach(h=>o.add(parseInt(h)));const s=Array.from(o);if(s.length===0){const h=[];for(let v=a;v<=a+4;v++)h.push(v);return{years:h,cutoffYear:a,firstProjectedYear:a+1,estimatedYears:new Set}}const r=Math.min(...s),i=Math.max(...s),c=Math.min(r,a-9),l=Math.max(i,a+6),u=[];for(let h=c;h<=l;h++)u.push(h);const f=u.filter(h=>h<=a),p=u.filter(h=>h>a),d=f.slice(-10),m=p.slice(0,6);return{years:[...d,...m],cutoffYear:a,firstProjectedYear:m.length>0?m[0]:null,estimatedYears:t.estimatedYears||new Set}}function Zt(e,t,n,a,o,s,r,i,c,l,u={},f={}){let p="";const d=C(e),m=Ne(t);return p+=`<tr class="${t==="calls"?"row-calls":"row-distributions"} timeline-expand-row" ${`data-type="${m}"`}>`,p+=`<td class="row-label"><span class="timeline-expand-icon">▶</span>${d}</td>`,n.years.forEach(v=>{const E=n.firstProjectedYear!==null&&v>=n.firstProjectedYear,T=v===n.firstProjectedYear,F=n.estimatedYears&&n.estimatedYears.has(v);let D=0,w=!1;if(E){const G=o[v]||0,Y=u[v]||0;D=G+Y,w=Y>0}else a[v]&&(D=a[v]);let k=T?"timeline-divider":"";F&&w?k+=" year-estimated":E&&(k+=" year-projected");const j=D>0?B(t==="calls"?-D:D):"-";p+=`<td class="${k}">${j}</td>`}),p+="</tr>",r&&r.forEach(v=>{p+=`<tr class="timeline-fund-row" data-type="${m}">`,p+=`<td>${C(v)}</td>`,n.years.forEach(E=>{const T=n.firstProjectedYear!==null&&E>=n.firstProjectedYear,F=E===n.firstProjectedYear,D=n.estimatedYears&&n.estimatedYears.has(E);let w=0,k=!1;if(T){const Y=c[v]&&c[v][E]||0,te=f[v]&&f[v][E]||0;w=Y+te,k=te>0}else i[v]&&i[v][l]&&i[v][l][E]&&(w=i[v][l][E]);let j=F?"timeline-divider":"";D&&k?j+=" year-estimated":T&&(j+=" year-projected");const G=w>0?B(t==="calls"?-w:w):"-";p+=`<td class="${j}">${G}</td>`}),p+="</tr>"}),p}function sa(e,t,n){let a='<tr class="row-net">';return a+='<td class="row-label">Net Cash Flow</td>',e.years.forEach(o=>{const s=e.firstProjectedYear!==null&&o>=e.firstProjectedYear,r=o===e.firstProjectedYear,i=e.estimatedYears&&e.estimatedYears.has(o);let c=0,l=0,u=!1;if(s){const m=n.projectedCalls[o]||0,h=n.estimatedCalls&&n.estimatedCalls[o]||0;c=m+h,u=h>0}else c=t.calls[o]||0,l=t.distributions[o]||0;const f=l-c;let p=r?"timeline-divider":"";i&&u?p+=" year-estimated":s&&(p+=" year-projected"),p+=` ${f>=0?"positive":"negative"}`;let d="-";(c>0||l>0)&&(d=(f>=0?"+":"")+B(f)),a+=`<td class="${p}">${d}</td>`}),a+="</tr>",a}function ra(e){const t=document.getElementById("timelineTableContainer"),n=document.getElementById("timelinePanel");if(!t)return;if(n&&!n.classList.contains("expanded")){t.innerHTML="";return}if(!e||e.length===0){t.innerHTML='<p class="timeline-no-data">No investments to display. <a href="#" onclick="showAddFundModal(); return false;" style="color: var(--color-action);">Add your first investment</a> with cash flows to see the timeline.</p>';return}const o=document.getElementById("cutoffDate")?.value,s=o?new Date(o+"T00:00:00"):null,r=s?s.getFullYear():null,i=na(e,s),c=oa(e,g.fundNameData,s),l=aa(i,c,r);if(l.years.length===0){t.innerHTML='<p class="timeline-no-data">No cash flow data available for the selected funds.</p>';return}let u='<table class="timeline-table">';const f=l.estimatedYears&&l.estimatedYears.size>0;u+="<thead><tr><th></th>",l.years.forEach(d=>{const m=l.firstProjectedYear!==null&&d>=l.firstProjectedYear,h=d===l.firstProjectedYear,v=l.estimatedYears&&l.estimatedYears.has(d),E=`${m&&!v?"year-projected":""} ${v?"year-estimated":""} ${h?"timeline-divider":""}`;let T="";v?T='<span class="timeline-estimated-indicator" title="Estimated: fund(s) missing term start date">&#8224;</span>':m&&(T="*"),u+=`<th class="${E}">${d}${T}</th>`}),u+="</tr></thead>",u+="<tbody>";const p=[...new Set(e.map(d=>d.fundName))].sort();if(u+=Zt("Capital Calls","calls",l,i.calls,c.projectedCalls,!0,p,i.byFund,c.byFund,"calls",c.estimatedCalls,c.estimatedByFund),u+=Zt("Distributions","distributions",l,i.distributions,{},!0,p,i.byFund,{},"distributions",{},{}),u+=sa(l,i,c),u+="</tbody></table>",l.firstProjectedYear||f){let d='<div style="margin-top: 10px; font-size: 11px; color: var(--color-text-light); font-style: italic;">';if(l.firstProjectedYear&&!f){const m=s?`* Projected values (after ${C(o||"")}) based on remaining uncalled capital distributed linearly across investment period`:"* Projected values based on remaining uncalled capital distributed linearly across investment period";d+=`<p style="margin: 0;">${m}</p>`}else if(f&&!l.firstProjectedYear)d+='<p style="margin: 0; color: var(--color-warning);">&#8224; Estimated projections for funds missing term start date (spread over 4 years). <a href="#" onclick="showManageFundsModal(); return false;" style="color: var(--color-action);">Add fund terms</a> for more accurate projections.</p>';else if(l.firstProjectedYear&&f){const m=s?`* Projected values (after ${C(o||"")}) based on remaining uncalled capital distributed linearly across investment period`:"* Projected values based on remaining uncalled capital distributed linearly across investment period";d+=`<p style="margin: 0 0 4px 0;">${m}</p>`,d+='<p style="margin: 0; color: var(--color-warning);">&#8224; Estimated projections for funds missing term start date (spread over 4 years). <a href="#" onclick="showManageFundsModal(); return false;" style="color: var(--color-action);">Add fund terms</a> for more accurate projections.</p>'}d+="</div>",u+=d}t.innerHTML=u}function ia(){const e=g.getFunds(),t=Et(e);ra(t)}function ca(e,t=[],n=[]){let a=[];const o=new Set;for(const l of e){if(l.id==null)continue;const u=ua(l);for(const f of u)a.push(f),o.add(l.id)}const s=ma(e);for(const l of s)a.push(l),o.add(l.fundId);let r=fa(e);n.length>0&&(r=r.filter(l=>{const u=Math.min(l.fund1Id,l.fund2Id),f=Math.max(l.fund1Id,l.fund2Id);return!n.some(p=>p.fund2Id>0&&p.fund1Id===u&&p.fund2Id===f)}),a=a.filter(l=>!n.some(u=>u.fund2Id===0&&u.fund1Id===l.fundId&&u.category===l.category&&u.message===l.message)));const i=la(t,e),c={error:0,warning:1,info:2};a.sort((l,u)=>c[l.severity]-c[u.severity]),o.clear();for(const l of a)o.add(l.fundId);return{totalFunds:e.length,fundsWithIssues:o.size,issues:a,duplicates:r,groupIssues:i,errorCount:a.filter(l=>l.severity==="error").length+i.filter(l=>l.severity==="error").length,warningCount:a.filter(l=>l.severity==="warning").length+i.filter(l=>l.severity==="warning").length,infoCount:a.filter(l=>l.severity==="info").length+i.filter(l=>l.severity==="info").length,timestamp:new Date().toISOString()}}function la(e,t){const n=[],a=new Set;for(const s of t)s.groupId!=null&&a.add(s.groupId);const o=new Set;for(const s of e)s.parentGroupId!=null&&o.add(s.parentGroupId);for(const s of e)if(s.id===0&&n.push({groupId:s.id,groupName:s.name,severity:"error",message:"Group has ID 0 (data corruption). Delete and recreate this group."}),s.id!=null&&s.id!==0){const r=a.has(s.id),i=o.has(s.id);!r&&!i&&n.push({groupId:s.id,groupName:s.name,severity:"warning",message:"Orphaned group: no investments or sub-groups assigned."})}return n}function ua(e){const t=[],n=e.id,a=e.fundName;if(e.commitment<=0&&t.push({fundId:n,fundName:a,severity:"error",category:"Invalid Data",message:`Commitment is ${e.commitment<=0?e.commitment===0?"zero":"negative":"invalid"}`}),!e.cashFlows||e.cashFlows.length===0)t.push({fundId:n,fundName:a,severity:"info",category:"Incomplete Data",message:"No cash flows recorded"});else{const r=e.cashFlows.filter(d=>d.type==="Contribution"&&P(d.date)).sort((d,m)=>d.date.localeCompare(m.date)),i=e.cashFlows.filter(d=>d.type==="Distribution"&&P(d.date)).sort((d,m)=>d.date.localeCompare(m.date));if(r.length>0&&i.length>0){const d=r[0],m=i.filter(h=>h.date<d.date);m.length>0&&t.push({fundId:n,fundName:a,severity:"warning",category:"Timeline Issue",message:`${m.length} distribution(s) before first contribution (${d.date})`})}const c=new Map;for(const d of e.cashFlows){const m=d.affectsCommitment!==!1,h=`${d.date}|${d.type}|${d.amount}|${m}`;c.set(h,(c.get(h)||0)+1)}const l=Array.from(c.entries()).filter(([,d])=>d>1);if(l.length>0){const d=l.reduce((m,[,h])=>m+h-1,0);t.push({fundId:n,fundName:a,severity:"warning",category:"Duplicate Data",message:`${d} duplicate cash flow(s) detected`})}const u=new Date;u.setDate(u.getDate()+30);const f=u.toISOString().split("T")[0],p=e.cashFlows.filter(d=>P(d.date)&&d.date>f);if(p.length>0&&t.push({fundId:n,fundName:a,severity:"warning",category:"Timeline Issue",message:`${p.length} cash flow(s) dated more than 30 days in the future`}),e.commitment>0){const d=ct(e,"Contribution"),m=d/e.commitment;m>1.2&&t.push({fundId:n,fundName:a,severity:"warning",category:"Data Anomaly",message:`Contributions (${He(d)}) exceed commitment (${He(e.commitment)}) by ${Math.round((m-1)*100)}%`})}}if(e.monthlyNav&&e.monthlyNav.length>0){const r=(e.cashFlows||[]).filter(p=>P(p.date)).sort((p,d)=>p.date.localeCompare(d.date));if(r.length>0){const p=r[0].date,d=e.monthlyNav.filter(m=>P(m.date)&&m.date<p);d.length>0&&t.push({fundId:n,fundName:a,severity:"info",category:"Timeline Issue",message:`${d.length} NAV entry(ies) before first cash flow`})}const i=e.monthlyNav.filter(p=>P(p.date)).map(p=>p.date),c=new Set(i);i.length!==c.size&&t.push({fundId:n,fundName:a,severity:"warning",category:"Duplicate Data",message:`${i.length-c.size} duplicate NAV date(s)`});const l=new Date;l.setDate(l.getDate()+30);const u=l.toISOString().split("T")[0],f=e.monthlyNav.filter(p=>P(p.date)&&p.date>u);f.length>0&&t.push({fundId:n,fundName:a,severity:"warning",category:"Timeline Issue",message:`${f.length} NAV entry(ies) dated more than 30 days in the future`})}const o=re(e),s=(e.cashFlows||[]).filter(r=>P(r.date)).map(r=>r.date).concat((e.monthlyNav||[]).filter(r=>P(r.date)).map(r=>r.date)).sort();if(s.length>=2){const r=new Date(s[0]+"T00:00:00").getTime(),c=(new Date(s[s.length-1]+"T00:00:00").getTime()-r)/(24*60*60*1e3);c>0&&c<30&&t.push({fundId:n,fundName:a,severity:"info",category:"Calculation Note",message:`Short holding period (${Math.round(c)} days) - IRR not calculated for periods under 30 days`})}if(e.monthlyNav&&e.monthlyNav.length>0&&(!e.cashFlows||e.cashFlows.length===0)&&t.push({fundId:n,fundName:a,severity:"info",category:"Incomplete Data",message:"Has NAV but no cash flows - IRR and MOIC cannot be calculated"}),e.cashFlows&&e.cashFlows.length>0){const r=e.cashFlows.some(c=>c.type==="Contribution");e.cashFlows.some(c=>c.type==="Distribution")&&!r&&t.push({fundId:n,fundName:a,severity:"warning",category:"Data Anomaly",message:"Has distributions but no contributions - MOIC cannot be calculated"})}if(e.cashFlows&&e.cashFlows.length>0&&(!e.monthlyNav||e.monthlyNav.length===0)&&o.outstandingCommitment>0&&t.push({fundId:n,fundName:a,severity:"info",category:"Incomplete Data",message:"No NAV recorded - investment return may be understated if fund holds unrealized value"}),o.irr!==null&&o.irr>5&&t.push({fundId:n,fundName:a,severity:"warning",category:"Data Anomaly",message:`Extremely high IRR (${(o.irr*100).toFixed(1)}%) - verify data accuracy`}),o.calledCapital>0&&o.nav>=0){const r=o.calledCapital+o.nav;o.distributions>r*1.5&&t.push({fundId:n,fundName:a,severity:"warning",category:"Data Anomaly",message:`Distributions (${He(o.distributions)}) significantly exceed contributions + NAV`})}if(o.nav<0&&Math.abs(o.nav)>1e3&&t.push({fundId:n,fundName:a,severity:"info",category:"Review Needed",message:`Negative NAV (${He(o.nav)}) - verify if this is expected`}),o.vintageYear!==null){const r=(e.cashFlows||[]).filter(i=>i.type==="Contribution"&&P(i.date)).sort((i,c)=>i.date.localeCompare(c.date))[0];if(r){const i=new Date(r.date+"T00:00:00").getFullYear();i!==o.vintageYear&&t.push({fundId:n,fundName:a,severity:"info",category:"Data Anomaly",message:`Calculated vintage (${i}) differs from stored value`})}}return t}function He(e){return new Intl.NumberFormat("en-US",{style:"currency",currency:"USD",minimumFractionDigits:0,maximumFractionDigits:0}).format(e)}function Dn(e){switch(e){case"error":return"severity-error";case"warning":return"severity-warning";case"info":return"severity-info";default:return""}}function Bn(e){switch(e){case"error":return"Error";case"warning":return"Warning";case"info":return"Info";default:return e}}function da(e){switch(e){case"high":return"confidence-high";case"medium":return"confidence-medium";case"low":return"confidence-low";default:return""}}function ma(e){const t=[],n=new Map;for(const a of e){if(a.id==null||a.commitment<=0)continue;const o=ke(a.fundName);n.has(o)||n.set(o,[]),n.get(o).push(a)}for(const[,a]of n){if(a.length<2)continue;const o=a.map(c=>({fund:c,metrics:re(c)})),s=o.reduce((c,l)=>c+l.fund.commitment,0),r=o.reduce((c,l)=>c+l.metrics.calledCapital,0),i=o.reduce((c,l)=>c+l.metrics.distributions,0);if(!(r===0&&i===0))for(const{fund:c,metrics:l}of o){const u=c.commitment/s*r,f=c.commitment/s*i;if(l.calledCapital>0&&r>0){const p=Math.abs(l.calledCapital-u)/u;if(p>.1){const d=a.length-1;t.push({fundId:c.id,fundName:c.fundName,severity:"info",category:"Data Anomaly",message:`Contributions not proportional to commitment (${Math.round(p*100)}% deviation vs ${d} other investment${d>1?"s":""} in same fund)`});continue}}if(l.distributions>0&&i>0){const p=Math.abs(l.distributions-f)/f;if(p>.1){const d=a.length-1;t.push({fundId:c.id,fundName:c.fundName,severity:"info",category:"Data Anomaly",message:`Distributions not proportional to commitment (${Math.round(p*100)}% deviation vs ${d} other investment${d>1?"s":""} in same fund)`})}}}}return t}function fa(e){const t=[],n=new Set;for(let o=0;o<e.length;o++)for(let s=o+1;s<e.length;s++){const r=e[o],i=e[s];if(r.id==null||i.id==null)continue;const c=`${Math.min(r.id,i.id)}-${Math.max(r.id,i.id)}`;if(n.has(c))continue;const l=pa(r,i);l&&(n.add(c),t.push({fund1Id:r.id,fund1Name:r.fundName,fund2Id:i.id,fund2Name:i.fundName,reason:l.reason,confidence:l.confidence}))}const a={high:0,medium:1,low:2};return t.sort((o,s)=>a[o.confidence]-a[s.confidence]),t}function pa(e,t){const n=e.accountNumber&&t.accountNumber&&Qt(e.accountNumber)===Qt(t.accountNumber);if(ke(e.fundName)===ke(t.fundName)&&n)return{reason:"Identical fund name and account number",confidence:"high"};const o=ha(e.fundName,t.fundName);if(o>=.85&&n){const s=re(e),r=re(t),i=s.vintageYear,c=r.vintageYear;if(!(i!=null&&c!=null&&i!==c))return{reason:`Same account with similar fund names (${Math.round(o*100)}% match)`,confidence:"medium"}}return null}function ga(e){const t=[[/\bxxv\b/gi,"25"],[/\bxxiv\b/gi,"24"],[/\bxxiii\b/gi,"23"],[/\bxxii\b/gi,"22"],[/\bxxi\b/gi,"21"],[/\bxx\b/gi,"20"],[/\bxix\b/gi,"19"],[/\bxviii\b/gi,"18"],[/\bxvii\b/gi,"17"],[/\bxvi\b/gi,"16"],[/\bxv\b/gi,"15"],[/\bxiv\b/gi,"14"],[/\bxiii\b/gi,"13"],[/\bxii\b/gi,"12"],[/\bxi\b/gi,"11"],[/\bx\b/gi,"10"],[/\bix\b/gi,"9"],[/\bviii\b/gi,"8"],[/\bvii\b/gi,"7"],[/\bvi\b/gi,"6"],[/\bv\b/gi,"5"],[/\biv\b/gi,"4"],[/\biii\b/gi,"3"],[/\bii\b/gi,"2"],[/\bi\b/gi,"1"]];let n=e;for(const[a,o]of t)n=n.replace(a,o);return n}function ke(e){let t=e.toLowerCase();return t=ga(t),t.replace(/[^a-z0-9]/g,"").replace(/fund/g,"").replace(/lp/g,"").replace(/llc/g,"").replace(/inc/g,"").trim()}function Qt(e){return e.toLowerCase().replace(/[^a-z0-9]/g,"").trim()}function ha(e,t){const n=ke(e),a=ke(t);if(n===a)return 1;if(n.length===0||a.length===0)return 0;const o=ya(n,a),s=Math.max(n.length,a.length);return 1-o/s}function ya(e,t){const n=e.length,a=t.length,o=Array(n+1).fill(null).map(()=>Array(a+1).fill(0));for(let s=0;s<=n;s++)o[s][0]=s;for(let s=0;s<=a;s++)o[0][s]=s;for(let s=1;s<=n;s++)for(let r=1;r<=a;r++){const i=e[s-1]===t[r-1]?0:1;o[s][r]=Math.min(o[s-1][r]+1,o[s][r-1]+1,o[s-1][r-1]+i)}return o[n][a]}function en(){const e=document.getElementById("backupWarningModal");e&&e.classList.add("show")}function rt(){const e=document.getElementById("backupWarningModal");e&&e.classList.remove("show")}function Tn(){localStorage.setItem(b.STORAGE_LAST_BACKUP,new Date().toISOString())}function va(){const e=localStorage.getItem(b.STORAGE_LAST_BACKUP);if(localStorage.getItem(b.STORAGE_BACKUP_WARNING)==="true")return;if(!e){en();return}(Date.now()-new Date(e).getTime())/(1e3*60*60*24)>b.BACKUP_REMINDER_DAYS&&en()}function ba(){const e=document.getElementById("closeBackupWarningBtn"),t=document.getElementById("exportNowBtn"),n=document.getElementById("remindLaterBtn"),a=document.getElementById("dontShowBackupWarning");e&&e.addEventListener("click",rt),t&&t.addEventListener("click",async()=>{rt(),await Nn(),Tn()}),n&&n.addEventListener("click",()=>{a?.checked&&localStorage.setItem(b.STORAGE_BACKUP_WARNING,"true"),rt()})}const xn=5*60*1e3;let it=null;function Ia(){g.shouldShowExportReminder(xn)&&wa()}function wa(){g.dismissExportReminder(),I("You have unsaved changes. Consider exporting to JSON.","warning")}function Ea(){it!==null&&clearInterval(it),it=setInterval(Ia,xn)}let Ae=null;function gt(){const e=document.getElementById("healthCheckSummary"),t=document.getElementById("healthCheckResults");if(!g.needsHealthCheckRefresh()&&Ae){Z("healthCheckModal"),tn(Ae);return}e&&(e.innerHTML=""),t&&(t.innerHTML=`
      <div class="health-check-loading">
        <div class="loading-spinner"></div>
        <p>Running health checks...</p>
      </div>
    `),Z("healthCheckModal"),setTimeout(async()=>{const n=g.getFunds(),a=g.getGroups(),o=await Vn(),s=ca(n,a,o);Ae=s,g.markHealthCheckRun(),tn(s)},50)}function tn(e){const t=document.getElementById("healthCheckSummary"),n=document.getElementById("healthCheckResults");if(!t||!n)return;const a=e.duplicates.length;t.innerHTML=`
    <div class="health-check-stat">
      <div class="health-check-stat-value">${e.totalFunds}</div>
      <div class="health-check-stat-label">Total Funds</div>
    </div>
    <div class="health-check-stat">
      <div class="health-check-stat-value ${e.fundsWithIssues>0?"warning-count":"success-count"}">${e.fundsWithIssues}</div>
      <div class="health-check-stat-label">With Issues</div>
    </div>
    <div class="health-check-stat">
      <div class="health-check-stat-value ${a>0?"warning-count":"success-count"}">${a}</div>
      <div class="health-check-stat-label">Duplicates</div>
    </div>
    <div class="health-check-stat">
      <div class="health-check-stat-value error-count">${e.errorCount}</div>
      <div class="health-check-stat-label">Errors</div>
    </div>
    <div class="health-check-stat">
      <div class="health-check-stat-value warning-count">${e.warningCount}</div>
      <div class="health-check-stat-label">Warnings</div>
    </div>
    <div class="health-check-stat">
      <div class="health-check-stat-value info-count">${e.infoCount}</div>
      <div class="health-check-stat-label">Info</div>
    </div>
  `;let o="",s=!1;e.groupIssues.length>0&&(o+='<div class="health-check-section-header">Group Issues</div>',o+=e.groupIssues.map(r=>Na(r)).join(""),s=!0),e.duplicates.length>0&&(o+='<div class="health-check-section-header">Potential Duplicates</div>',o+=e.duplicates.map(r=>Ca(r)).join(""),s=!0),e.issues.length>0&&(s&&(o+='<div class="health-check-section-header">Data Issues</div>'),o+=e.issues.map(r=>Sa(r)).join(""),s=!0),s||(o=`
      <div class="health-check-empty">
        All funds and groups passed health checks!
      </div>
    `),n.innerHTML=o}function Sa(e){const n=e.severity==="warning"||e.severity==="info"?`<button class="btn-dismiss-issue btn-dismiss-fund-issue" data-fund-id="${e.fundId}" data-category="${Ne(e.category)}" data-message="${Ne(e.message)}" title="Dismiss this issue">Dismiss</button>`:"";return`
    <div class="health-issue" data-fund-id="${e.fundId}">
      <span class="health-issue-severity ${Dn(e.severity)}">${Bn(e.severity)}</span>
      <div class="health-issue-content">
        <div class="health-issue-fund">${C(e.fundName)}</div>
        <div class="health-issue-message">${C(e.message)}</div>
        <div class="health-issue-category">${C(e.category)}</div>
      </div>
      ${n}
    </div>
  `}function Ca(e){return`
    <div class="duplicate-pair">
      <span class="duplicate-confidence ${da(e.confidence)}">${e.confidence}</span>
      <div class="duplicate-content">
        <div class="duplicate-funds">
          <span class="duplicate-fund-link" data-fund-id="${e.fund1Id}">${C(e.fund1Name)}</span>
          <span class="duplicate-separator">&harr;</span>
          <span class="duplicate-fund-link" data-fund-id="${e.fund2Id}">${C(e.fund2Name)}</span>
        </div>
        <div class="duplicate-reason">${C(e.reason)}</div>
      </div>
      <button class="btn-dismiss-issue" data-fund1-id="${e.fund1Id}" data-fund2-id="${e.fund2Id}" data-reason="${Ne(e.reason)}" title="Dismiss this issue">Dismiss</button>
    </div>
  `}function Na(e){return`
    <div class="health-issue group-issue">
      <span class="health-issue-severity ${Dn(e.severity)}">${Bn(e.severity)}</span>
      <div class="health-issue-content">
        <div class="health-issue-fund">Group: ${C(e.groupName)}</div>
        <div class="health-issue-message">${C(e.message)}</div>
      </div>
    </div>
  `}function Fa(){const e=document.getElementById("closeHealthCheckModalBtn"),t=document.getElementById("closeHealthCheckModal2Btn");e&&e.addEventListener("click",()=>R("healthCheckModal")),t&&t.addEventListener("click",()=>R("healthCheckModal"));const n=document.getElementById("healthCheckResults");n&&n.addEventListener("click",async a=>{const o=a.target,s=o.closest(".btn-dismiss-issue:not(.btn-dismiss-fund-issue)");if(s){a.stopPropagation();const l=parseInt(s.getAttribute("data-fund1-id")||"0",10),u=parseInt(s.getAttribute("data-fund2-id")||"0",10),f=s.getAttribute("data-reason")||"";if(l>0&&u>0)try{await zn(l,u,f),Ae=null,g.markHealthCheckRun(),g.lastHealthCheckVersion=-1,gt()}catch(p){console.error("Error dismissing health issue:",p)}return}const r=o.closest(".btn-dismiss-fund-issue");if(r){a.stopPropagation();const l=parseInt(r.getAttribute("data-fund-id")||"0",10),u=r.getAttribute("data-category")||"",f=r.getAttribute("data-message")||"";if(l>0&&u&&f)try{await Wn(l,u,f),Ae=null,g.lastHealthCheckVersion=-1,gt()}catch(p){console.error("Error dismissing fund issue:",p)}return}const i=o.closest(".health-issue");if(i){const l=parseInt(i.getAttribute("data-fund-id")||"0",10);l>0&&(R("healthCheckModal"),mt(l));return}const c=o.closest(".duplicate-fund-link");if(c){const l=parseInt(c.getAttribute("data-fund-id")||"0",10);l>0&&(R("healthCheckModal"),mt(l))}})}let ht=!1,yt=!1;function Da(e,t){const n=JSON.parse(localStorage.getItem(b.STORAGE_COLUMN_WIDTHS)||"{}");n[e]=t,localStorage.setItem(b.STORAGE_COLUMN_WIDTHS,JSON.stringify(n))}function Ba(){const e=document.getElementById("fundsTable");if(!e)return;const t=JSON.parse(localStorage.getItem(b.STORAGE_COLUMN_WIDTHS)||"{}");e.querySelectorAll("thead th").forEach((a,o)=>{const s=t[o];s&&(a.style.width=s+"px",a.style.minWidth=s+"px",a.style.maxWidth=s+"px")})}function Ta(){const e=document.getElementById("fundsTable");if(!e)return;const t=e.querySelectorAll("thead th");t.forEach(n=>{if(n.querySelector(".resizer")||!n.getAttribute("data-sort"))return;const a=document.createElement("span");a.className="resizer",n.appendChild(a),n.style.position="relative",a.addEventListener("mousedown",o=>{o.preventDefault(),o.stopPropagation();const s=o.pageX,r=n.offsetWidth,i=Array.from(t).indexOf(n),c=e.querySelectorAll(`tbody tr td:nth-child(${i+1})`);ht=!0,yt=!0,n.classList.add("resizing"),document.body.style.cursor="col-resize",document.body.style.userSelect="none";const l=f=>{const p=f.pageX-s,d=Math.max(b.MIN_COLUMN_WIDTH,r+p);n.style.width=d+"px",n.style.minWidth=d+"px",n.style.maxWidth=d+"px",c.forEach(m=>{m.style.width=d+"px",m.style.minWidth=d+"px",m.style.maxWidth=d+"px"}),Da(i,d)},u=()=>{n.classList.remove("resizing"),document.body.style.cursor="",document.body.style.userSelect="",document.removeEventListener("mousemove",l),document.removeEventListener("mouseup",u),window.removeEventListener("blur",u),setTimeout(()=>{ht=!1,yt=!1},50)};document.addEventListener("mousemove",l),document.addEventListener("mouseup",u),window.addEventListener("blur",u)})}),Ba()}function xa(e,t){let n;return function(...o){const s=()=>{clearTimeout(n),e(...o)};clearTimeout(n),n=setTimeout(s,t)}}function nn(e){const t=document.getElementById("filterLoading");t&&t.classList.toggle("show",e)}function on(e,t){let n=document.getElementById("tablePaginationContainer");if(!n){const o=document.querySelector(".table-container");o&&(n=document.createElement("div"),n.id="tablePaginationContainer",n.className="table-pagination",o.after(n))}if(!n)return;if(e>=t){n.innerHTML="",n.style.display="none";return}n.style.display="flex",n.innerHTML=`
    <div class="pagination-info">
      Showing <strong>${e}</strong> of <strong>${t}</strong> investments
    </div>
    <button type="button" class="btn-secondary load-more-btn" id="loadMoreBtn">
      Load More
    </button>
  `;const a=document.getElementById("loadMoreBtn");a&&a.addEventListener("click",async()=>{g.loadMore(),await H()})}async function H(){const e=document.getElementById("fundsTableBody"),t=setTimeout(()=>{e&&(e.innerHTML=`
        <tr class="table-loading-row">
          <td colspan="12">
            <div class="table-loading-content">
              <div class="table-loading-spinner"></div>
              <div class="table-loading-text">Loading investments...</div>
            </div>
          </td>
        </tr>
      `)},b.TABLE_LOADING_DELAY);try{const n=await q();g.setFunds(n);let a=Et(n);const s=document.getElementById("cutoffDate")?.value,r=s?new Date(s+"T00:00:00"):void 0;g.sortColumns.length>0&&(a=vn(a,g.sortColumns,r)),ro(n),so();const i=a.map(d=>({...d,metrics:re(d,r)}));if(Qn(i,r),clearTimeout(t),!e)return;if(e.innerHTML="",i.length===0){const d=L("fundFilter").length>0||L("accountFilter").length>0||L("groupFilter").length>0||L("tagFilter").length>0||L("vintageFilter").length>0,m=n.length>0;let h;d&&m?h=`
          <tr>
            <td colspan="12" class="empty-state">
              <div style="padding: 40px;">
                <h3 style="margin-bottom: 10px;">No matching investments</h3>
                <p style="margin-bottom: 15px;">No investments match your current filters.</p>
                <button type="button" class="btn-secondary" id="clearFiltersBtn">Clear All Filters</button>
              </div>
            </td>
          </tr>
        `:h=`
          <tr>
            <td colspan="12" class="empty-state">
              <div style="padding: 40px;">
                <h3 style="margin-bottom: 10px;">No investments yet</h3>
                <p style="margin-bottom: 15px;">Add your first investment to start tracking your portfolio.</p>
                <button type="button" class="btn-primary" id="addFirstInvestmentBtn">Add Investment</button>
              </div>
            </td>
          </tr>
        `,e.innerHTML=h;const v=document.getElementById("clearFiltersBtn");v&&v.addEventListener("click",()=>{St(),Ft()});const E=document.getElementById("addFirstInvestmentBtn");E&&E.addEventListener("click",Xe);return}const c=document.getElementById("sidebarShowTagsCheckbox")?.checked??!0,l=localStorage.getItem(b.STORAGE_GROUP_BY_FUND)==="true",u=bn(i,r),f=i.length,p=g.displayLimit;if(l){const d=In(i,r,g.sortColumns),m=d.slice(0,p);m.forEach((v,E)=>{const T=document.createElement("tr");T.classList.add("grouped-fund-row"),T.setAttribute("tabindex","0"),T.setAttribute("role","row"),T.setAttribute("aria-rowindex",(E+2).toString()),T.innerHTML=to(v,E,c),e.appendChild(T)});const h=document.createElement("tr");h.innerHTML=Xt(u),e.appendChild(h),on(m.length,d.length)}else{const d=i.slice(0,p);d.forEach((h,v)=>{const E=document.createElement("tr");E.setAttribute("tabindex","0"),E.setAttribute("data-fund-id",h.id?.toString()||""),E.setAttribute("role","row"),E.setAttribute("aria-rowindex",(v+2).toString()),E.innerHTML=Zn(h,v,c),e.appendChild(E)});const m=document.createElement("tr");m.innerHTML=Xt(u),e.appendChild(m),on(d.length,f)}}catch(n){clearTimeout(t),console.error("Error rendering table:",n),I("Error loading data: "+n.message,"error")}}async function Ft(){g.abortController&&g.abortController.abort(),g.resetDisplayLimit(),g.setAbortController(new AbortController);const e=g.abortController.signal;nn(!0);try{if(e.aborted||(Aa(),e.aborted))return;await H();const t=document.getElementById("summaryInvestmentCount")?.textContent||"0";_o(`Filter applied. Showing ${t} investments.`)}catch(t){if(t.name==="AbortError")return;console.error("Error applying filters:",t),I("Error applying filters: "+t.message,"error")}finally{nn(!1),g.abortController&&!g.abortController.signal.aborted&&g.setAbortController(null)}}const Ve=xa(Ft,b.DEBOUNCE_FILTER);function Aa(){const e=L("groupFilter"),t=document.getElementById("headerTitle"),n=document.getElementById("headerSubtitle");if(!(!t||!n))if(e.length===1&&e[0]){const a=parseInt(e[0]),o=g.getGroupByIdSync(a);if(o)if(t.textContent=o.name,o.parentGroupId){const s=g.getGroupByIdSync(o.parentGroupId);n.textContent=s?.name||o.type||"Account Group"}else n.textContent=""}else if(e.length>1){const a=e.map(s=>g.getGroupByIdSync(parseInt(s))),o=new Set(a.map(s=>s?.parentGroupId).filter(s=>s!=null));if(o.size===1){const s=Array.from(o)[0],r=g.getGroupByIdSync(s);r?(t.textContent=r.name,n.textContent="Multiple Groups Selected"):(t.textContent="PE Fund Manager",n.textContent="Multiple Groups Selected")}else t.textContent="PE Fund Manager",n.textContent="Multiple Groups Selected"}else t.textContent="PE Fund Manager",n.textContent="Private Equity Fund Analytics & Management Tool"}async function Ma(e){const t=e.target;if(yt||ht||t.closest(".resizer"))return;const n=t.closest("th[data-sort]");if(!n)return;const a=n.dataset.sort;if(!a)return;if(e.shiftKey){const s=g.sortColumns.findIndex(r=>r.column===a);if(s!==-1)if(g.sortColumns[s].direction==="asc"){const i=[...g.sortColumns];i[s]={column:a,direction:"desc"},g.setSortColumns(i)}else{const i=g.sortColumns.filter((c,l)=>l!==s);g.setSortColumns(i)}else g.setSortColumns([...g.sortColumns,{column:a,direction:"asc"}])}else{const s=g.sortColumns.find(r=>r.column===a);s?s.direction==="asc"?g.setSortColumns([{column:a,direction:"desc"}]):g.setSortColumns([]):g.setSortColumns([{column:a,direction:"asc"}])}eo(g.sortColumns),await H()}function ka(e){const n=e.target.closest(".fund-actions-btn");if(!n)return;e.stopPropagation();const a=parseInt(n.dataset.fundId||"0");if(!a)return;wo(a);const o=document.getElementById("actionDropdown");if(!o)return;const s=n.getBoundingClientRect();o.style.visibility="hidden",o.classList.add("show");const r=o.offsetWidth||160,i=o.offsetHeight||200;o.classList.remove("show"),o.style.visibility="";let c=s.bottom+2,l=s.left-(r-s.width);c+i>window.innerHeight&&(c=s.top-i-2),l<8&&(l=8),l+r>window.innerWidth-8&&(l=window.innerWidth-r-8),o.style.position="fixed",o.style.top=`${c}px`,o.style.left=`${l}px`,o.classList.add("show")}function La(){const e=document.getElementById("sidebar"),t=document.getElementById("sidebarOverlay");e&&e.classList.add("show"),t&&t.classList.add("show")}function W(){const e=document.getElementById("sidebar"),t=document.getElementById("sidebarOverlay");e&&e.classList.remove("show"),t&&t.classList.remove("show")}function $a(){const e=document.getElementById("sidebarDarkModeCheckbox");if(!e)return;const t=localStorage.getItem("theme"),n=window.matchMedia("(prefers-color-scheme: dark)").matches,a=t?t==="dark":n;document.documentElement.setAttribute("data-theme",a?"dark":"light"),e.checked=a,e.addEventListener("change",()=>{const o=e.checked?"dark":"light";document.documentElement.setAttribute("data-theme",o),localStorage.setItem("theme",o)})}function Ra(){const e=new Date,t=e.getFullYear(),n=[new Date(t,2,31),new Date(t,5,30),new Date(t,8,30),new Date(t,11,31)];for(let a=n.length-1;a>=0;a--)if(n[a]<=e)return n[a];return new Date(t-1,11,31)}function Ga(){const e=document.getElementById("cutoffDate");if(!e)return;const t=Ra(),n=t.getFullYear(),a=String(t.getMonth()+1).padStart(2,"0"),o=String(t.getDate()).padStart(2,"0");e.value=`${n}-${a}-${o}`}function Oa(){document.querySelectorAll(".multi-select").forEach(t=>{const n=t.querySelector(".multi-select-trigger"),a=t.querySelector(".multi-select-dropdown");!n||!a||(n.addEventListener("click",o=>{o.stopPropagation();const s=t.classList.contains("open");document.querySelectorAll(".multi-select.open").forEach(r=>{r.classList.remove("open"),r.querySelector(".multi-select-trigger")?.setAttribute("aria-expanded","false"),je(r)}),s||(t.classList.add("open"),n.setAttribute("aria-expanded","true"),setTimeout(()=>{const r=a.querySelector(".multi-select-search input");r&&r.focus()},0))}),n.addEventListener("keydown",o=>{const s=o;s.key==="Enter"||s.key===" "?(s.preventDefault(),n.click()):s.key==="Escape"&&(t.classList.remove("open"),n.setAttribute("aria-expanded","false"),je(t))}),a.addEventListener("input",o=>{const s=o.target;s.matches(".multi-select-search input")&&(It(t,s.value),Te(t),wt(t))}),a.addEventListener("keydown",o=>{const s=o;if(s.key==="Escape"){t.classList.remove("open"),n.setAttribute("aria-expanded","false"),je(t),Te(t),n.focus();return}if(s.key==="ArrowDown"||s.key==="ArrowUp"){s.preventDefault(),Ua(t,s.key==="ArrowDown"?1:-1);return}if(s.key==="Enter"){s.preventDefault();const r=t.querySelector(".multi-select-option.highlighted");r&&!r.classList.contains("search-hidden")&&sn(t,r,Ve);return}}),a.addEventListener("click",o=>{const s=o.target;if(s.closest(".multi-select-search")){o.stopPropagation();return}const r=s.closest(".multi-select-option");if(r){if(o.stopPropagation(),r.classList.contains("multi-select-all-option")){oo(t),t.id==="groupFilter"&&t.querySelectorAll(".multi-select-option.selected:not(.multi-select-all-option)").forEach(c=>{const l=parseInt(c.getAttribute("data-value")||"0");wn(t,l,!0)}),Ve();return}sn(t,r,Ve)}}),a.addEventListener("mouseover",o=>{const s=o.target.closest(".multi-select-option");s&&!s.classList.contains("search-hidden")&&(Te(t),s.classList.add("highlighted"))}))}),document.addEventListener("click",t=>{t.target.closest(".multi-select")||document.querySelectorAll(".multi-select.open").forEach(n=>{n.classList.remove("open"),n.querySelector(".multi-select-trigger")?.setAttribute("aria-expanded","false"),je(n),Te(n)})})}function _a(){document.querySelectorAll(".searchable-select").forEach(t=>{const n=t.querySelector(".searchable-select-trigger"),a=t.querySelector(".searchable-select-dropdown"),o=t.querySelector('input[type="hidden"]');!n||!a||!o||(n.addEventListener("click",s=>{s.stopPropagation();const r=t.classList.contains("open");document.querySelectorAll(".searchable-select.open").forEach(i=>{i.classList.remove("open"),i.querySelector(".searchable-select-trigger")?.setAttribute("aria-expanded","false");const c=i.querySelector(".searchable-select-search input");c&&(c.value=""),ze(i,"")}),r||(t.classList.add("open"),n.setAttribute("aria-expanded","true"),setTimeout(()=>{const i=a.querySelector(".searchable-select-search input");i&&i.focus()},0))}),n.addEventListener("keydown",s=>{const r=s;r.key==="Enter"||r.key===" "?(r.preventDefault(),n.click()):r.key==="Escape"&&(t.classList.remove("open"),n.setAttribute("aria-expanded","false"))}),a.addEventListener("input",s=>{const r=s.target;r.matches(".searchable-select-search input")&&(ze(t,r.value),Me(t))}),a.addEventListener("keydown",s=>{const r=s;if(r.key==="Escape"){t.classList.remove("open"),n.setAttribute("aria-expanded","false"),Me(t),n.focus();return}if(r.key==="ArrowDown"||r.key==="ArrowUp"){r.preventDefault(),Pa(t,r.key==="ArrowDown"?1:-1);return}if(r.key==="Enter"){r.preventDefault();const i=t.querySelector(".searchable-select-option.highlighted");i&&!i.classList.contains("search-hidden")&&an(t,i,o,n);return}}),a.addEventListener("click",s=>{const r=s.target;if(r.closest(".searchable-select-search")){s.stopPropagation();return}const i=r.closest(".searchable-select-option");i&&(s.stopPropagation(),an(t,i,o,n))}),a.addEventListener("mouseover",s=>{const r=s.target.closest(".searchable-select-option");r&&!r.classList.contains("search-hidden")&&(Me(t),r.classList.add("highlighted"))}))}),document.addEventListener("click",t=>{t.target.closest(".searchable-select")||document.querySelectorAll(".searchable-select.open").forEach(n=>{n.classList.remove("open"),n.querySelector(".searchable-select-trigger")?.setAttribute("aria-expanded","false");const a=n.querySelector(".searchable-select-search input");a&&(a.value=""),ze(n,"")})})}function ze(e,t){const n=e.querySelector(".searchable-select-options"),a=e.querySelector(".searchable-select-no-results");if(!n)return;const o=n.querySelectorAll(".searchable-select-option"),s=t.toLowerCase().trim();let r=0;o.forEach(i=>{const c=i.textContent?.toLowerCase()||"";s===""||c.includes(s)?(i.classList.remove("search-hidden"),r++):i.classList.add("search-hidden")}),a&&a.classList.toggle("visible",r===0&&s!=="")}function Me(e){e.querySelectorAll(".searchable-select-option.highlighted").forEach(t=>{t.classList.remove("highlighted")})}function Pa(e,t){const n=Array.from(e.querySelectorAll(".searchable-select-option:not(.search-hidden)"));if(n.length===0)return;const a=e.querySelector(".searchable-select-option.highlighted");let o=a?n.indexOf(a):-1;Me(e);let s=o+t;s<0&&(s=n.length-1),s>=n.length&&(s=0);const r=n[s];r&&(r.classList.add("highlighted"),r.scrollIntoView({block:"nearest"}))}function an(e,t,n,a){const o=t.dataset.value||"";n.value=o,n.dispatchEvent(new Event("change",{bubbles:!0}));const s=e.querySelector(".searchable-select-display");s&&(s.textContent=t.textContent?.trim()||e.getAttribute("data-placeholder")||"Select..."),e.querySelectorAll(".searchable-select-option").forEach(i=>{i.classList.remove("selected")}),t.classList.add("selected"),e.classList.remove("open"),a.setAttribute("aria-expanded","false");const r=e.querySelector(".searchable-select-search input");r&&(r.value=""),ze(e,""),Me(e)}function Te(e){e.querySelectorAll(".multi-select-option.highlighted").forEach(t=>{t.classList.remove("highlighted")})}function Ua(e,t){const n=Array.from(e.querySelectorAll(".multi-select-option:not(.search-hidden)"));if(n.length===0)return;const a=e.querySelector(".multi-select-option.highlighted");let o=a?n.indexOf(a):-1;Te(e);let s=o+t;s<0&&(s=n.length-1),s>=n.length&&(s=0);const r=n[s];r&&(r.classList.add("highlighted"),r.scrollIntoView({block:"nearest"}))}function sn(e,t,n){t.classList.toggle("selected");const a=t.querySelector('input[type="checkbox"]');if(a&&(a.checked=t.classList.contains("selected")),t.setAttribute("aria-selected",t.classList.contains("selected").toString()),e.id==="groupFilter"){const o=parseInt(t.getAttribute("data-value")||"0"),s=t.classList.contains("selected");wn(e,o,s)}wt(e),et(e.id),n()}function qa(){const e=document.querySelector("#fundsTable thead");e&&e.addEventListener("click",Ma);const t=document.getElementById("fundsTableBody");t&&t.addEventListener("click",y=>{ka(y)}),document.addEventListener("click",y=>{const N=document.getElementById("actionDropdown"),A=y.target;N&&!A.closest("#actionDropdown")&&!A.closest(".fund-actions-btn")&&N.classList.remove("show")});const n=document.getElementById("actionEdit"),a=document.getElementById("actionDuplicate"),o=document.getElementById("actionViewDetails"),s=document.getElementById("actionDelete");n&&n.addEventListener("click",y=>{y.preventDefault();const N=Ye();N&&po(N),document.getElementById("actionDropdown")?.classList.remove("show")}),a&&a.addEventListener("click",y=>{y.preventDefault();const N=Ye();N&&go(N),document.getElementById("actionDropdown")?.classList.remove("show")}),o&&o.addEventListener("click",y=>{y.preventDefault();const N=Ye();N&&mt(N),document.getElementById("actionDropdown")?.classList.remove("show")}),s&&s.addEventListener("click",async y=>{y.preventDefault();const N=Ye();N&&await yo(N,H),document.getElementById("actionDropdown")?.classList.remove("show")});const r=document.getElementById("fundForm");r&&r.addEventListener("submit",async y=>{y.preventDefault(),await ho(H)});const i=document.getElementById("closeFundModalBtn"),c=document.getElementById("cancelFundModalBtn");[i,c].forEach(y=>{y&&y.addEventListener("click",()=>co())});const l=document.getElementById("fundName");l&&l.addEventListener("change",y=>{const N=y.target.value,A=document.getElementById("newFundNameContainer");N==="__new__"&&A?(A.style.display="block",document.getElementById("newFundNameInline")?.focus()):A&&(A.style.display="none")});const u=document.getElementById("addCashFlowRowBtn"),f=document.getElementById("addNavRowBtn"),p=document.getElementById("saveDetailsChangesBtn"),d=document.getElementById("cancelDetailsModalBtn"),m=document.getElementById("closeDetailsModalBtn");u&&u.addEventListener("click",vo),f&&f.addEventListener("click",bo),p&&p.addEventListener("click",()=>Io(H)),[d,m].forEach(y=>{y&&y.addEventListener("click",async()=>{g.hasUnsavedChanges&&!await fe("You have unsaved changes. Discard them?",{title:"Unsaved Changes",confirmText:"Discard",cancelText:"Keep Editing"})||(g.setUnsavedChanges(!1),R("detailsModal"))})});const h=document.getElementById("cashFlowsTable"),v=document.getElementById("navTable");[h,v].forEach(y=>{y&&(y.addEventListener("click",N=>{const ee=N.target.closest(".delete-row-btn");if(ee){const _=ee.closest("tr");_&&(_.remove(),g.setUnsavedChanges(!0),st())}}),y.addEventListener("input",()=>{g.setUnsavedChanges(!0),st()}),y.addEventListener("change",()=>{g.setUnsavedChanges(!0),st()}))});const E=document.getElementById("sidebarManageFunds");E&&E.addEventListener("click",y=>{y.preventDefault(),W(),Ge()});const T=document.getElementById("closeManageFundsModalBtn"),F=document.getElementById("closeManageFundsModal2Btn");[T,F].forEach(y=>{y&&y.addEventListener("click",()=>R("manageFundNamesModal"))});const D=document.getElementById("addNewFundNameModalBtn");D&&D.addEventListener("click",()=>ko(H));const w=document.getElementById("fundNamesList");w&&w.addEventListener("click",async y=>{const A=y.target.closest("button");if(!A)return;const ee=A.dataset.action,_=A.dataset.name;ee==="editFundName"&&_?Bo(_):ee==="deleteFundName"&&_&&await Mo(_,H)});const k=document.getElementById("closeEditFundNameModalBtn"),j=document.getElementById("cancelEditFundNameBtn");[k,j].forEach(y=>{y&&y.addEventListener("click",()=>{Cn(),R("editFundNameModal")})});const G=document.getElementById("saveEditedFundNameBtn");G&&G.addEventListener("click",()=>Ao(H));const Y=document.getElementById("editFundTagsInput");Y&&Y.addEventListener("keydown",y=>{if(y.key==="Enter"){y.preventDefault();const N=Y.value.trim();N&&(To(N),Y.value="")}});const te=document.getElementById("editFundTagsContainer");te&&te.addEventListener("click",y=>{const N=y.target;if(N.classList.contains("tag-remove")){const A=parseInt(N.dataset.index||"0");xo(A)}});const le=document.getElementById("addNewFundNameBtn");le&&le.addEventListener("click",Lo);const X=document.getElementById("cancelNewFundNameBtn");X&&X.addEventListener("click",$o);const be=document.getElementById("sidebarManageGroups");be&&be.addEventListener("click",y=>{y.preventDefault(),W(),Ct()});const Dt=document.getElementById("closeManageGroupsModalBtn"),nt=document.getElementById("closeManageGroupsModal2Btn");[Dt,nt].forEach(y=>{y&&y.addEventListener("click",()=>R("manageGroupsModal"))});const Oe=document.getElementById("saveGroupBtn");Oe&&Oe.addEventListener("click",()=>Eo(H));const Ie=document.getElementById("groupsList");Ie&&Ie.addEventListener("click",async y=>{const A=y.target.closest("button");if(!A)return;const ee=A.dataset.action,_=parseInt(A.dataset.id||"0");if(ee==="editGroup"&&!isNaN(_)){const me=g.getGroupByIdSync(_);if(me){const qe=document.getElementById("editGroupId"),Yt=document.getElementById("newGroupName"),Ht=document.getElementById("newGroupType"),Vt=document.getElementById("saveGroupBtn"),zt=document.getElementById("cancelEditBtn"),Wt=document.getElementById("groupFormTitle");qe&&(qe.value=_.toString()),Yt&&(Yt.value=me.name),Ht&&(Ht.value=me.type||""),Vt&&(Vt.textContent="Update Group"),zt&&(zt.style.display="inline-block"),Wt&&(Wt.textContent="Edit Group"),he("newGroupParent",_),tt("newGroupParent",me.parentGroupId?.toString()||"")}}else ee==="deleteGroup"&&!isNaN(_)&&await So(_,H)});const _e=document.getElementById("cancelEditBtn");_e&&_e.addEventListener("click",()=>{const y=document.getElementById("editGroupId"),N=document.getElementById("newGroupName"),A=document.getElementById("newGroupType"),ee=document.getElementById("saveGroupBtn"),_=document.getElementById("groupFormTitle");y&&(y.value=""),N&&(N.value=""),A&&(A.value=""),ee&&(ee.textContent="Add Group"),_&&(_.textContent="Add New Group"),_e.style.display="none",he("newGroupParent")});const Pe=document.getElementById("toggleSidebarBtn"),Ue=document.getElementById("closeSidebarBtn"),S=document.getElementById("sidebarOverlay");Pe&&Pe.addEventListener("click",La),Ue&&Ue.addEventListener("click",W),S&&S.addEventListener("click",W);const M=document.getElementById("sidebarNewInvestment");M&&M.addEventListener("click",y=>{y.preventDefault(),W(),Xe()});const $=document.getElementById("sidebarShowTagsCheckbox");if($){$.addEventListener("change",async()=>{const N=$.checked;localStorage.setItem("showTags",N.toString()),await H()});const y=localStorage.getItem("showTags");y!==null&&($.checked=y==="true")}const J=document.getElementById("groupByFundToggle");J&&(localStorage.getItem(b.STORAGE_GROUP_BY_FUND)==="true"&&J.classList.add("active"),J.addEventListener("click",async()=>{const A=!(localStorage.getItem(b.STORAGE_GROUP_BY_FUND)==="true");J.classList.toggle("active",A),localStorage.setItem(b.STORAGE_GROUP_BY_FUND,A.toString()),await H()}));const ae=document.getElementById("sidebarMaskAccountsCheckbox");if(ae){ae.addEventListener("change",()=>{const N=ae.checked;localStorage.setItem(b.STORAGE_MASK_ACCOUNTS,N.toString()),document.documentElement.setAttribute("data-mask-accounts",N.toString())});const y=localStorage.getItem(b.STORAGE_MASK_ACCOUNTS);if(y!==null){const N=y==="true";ae.checked=N,document.documentElement.setAttribute("data-mask-accounts",N.toString())}}const de=document.getElementById("sidebarClearDatabase");de&&de.addEventListener("click",async y=>{if(y.preventDefault(),W(),await fe("Are you sure you want to clear ALL data? This action cannot be undone!",{title:"Clear Database",confirmText:"Clear All Data",cancelText:"Cancel"}))try{K("Clearing database..."),await Hn(),g.clearMetricsCache(),g.setFunds([]),g.setGroups([]),I("Database cleared successfully"),await H()}catch(A){console.error("Error clearing database:",A),I("Error clearing database: "+A.message,"error")}finally{U()}});const se=document.getElementById("sidebarExportCSV");se&&se.addEventListener("click",async y=>{y.preventDefault(),W(),await Ro()});const Bt=document.getElementById("sidebarExportJSON");Bt&&Bt.addEventListener("click",async y=>{y.preventDefault(),W(),await Nn(),Tn()});const Tt=document.getElementById("sidebarExportPDF");Tt&&Tt.addEventListener("click",y=>{y.preventDefault(),W(),Go()});const xt=document.getElementById("sidebarImportJSON");xt&&xt.addEventListener("click",y=>{y.preventDefault(),W(),Uo()});const At=document.getElementById("sidebarLoadSampleData");At&&At.addEventListener("click",async y=>{y.preventDefault(),W(),await fe("This will add sample data to your database. Existing data will not be deleted. Continue?",{title:"Load Sample Data",confirmText:"Load Data",cancelText:"Cancel"})&&await Yo(H)});const Mt=document.getElementById("sidebarHealthCheck");Mt&&Mt.addEventListener("click",y=>{y.preventDefault(),W(),gt()});const kt=document.getElementById("sidebarSyncAccountGroups");kt&&kt.addEventListener("click",y=>{y.preventDefault(),W(),No()});const Lt=document.getElementById("sidebarBulkCashFlow");Lt&&Lt.addEventListener("click",y=>{y.preventDefault(),W(),Vo()});const $t=document.getElementById("sidebarBulkAssignGroup");$t&&$t.addEventListener("click",y=>{y.preventDefault(),W(),Zo()});const Rt=document.getElementById("sidebarBulkRemoveFund");Rt&&Rt.addEventListener("click",y=>{y.preventDefault(),W(),Ko()}),ta(H);const Gt=document.getElementById("importPreviewFileInput");Gt&&Gt.addEventListener("change",qo);const Ot=document.getElementById("applyImportBtn");Ot&&Ot.addEventListener("click",()=>jo(H));const An=document.getElementById("closeImportPreviewModalBtn"),Mn=document.getElementById("cancelImportPreviewBtn");[An,Mn].forEach(y=>{y&&y.addEventListener("click",()=>R("importPreviewModal"))});const kn=document.getElementById("closeSyncAccountGroupsModalBtn"),Ln=document.getElementById("cancelSyncAccountGroupsBtn");[kn,Ln].forEach(y=>{y&&y.addEventListener("click",()=>{ft(),R("syncAccountGroupsModal")})});const _t=document.getElementById("applySyncAccountGroupsBtn");_t&&_t.addEventListener("click",()=>Fo(H));const Pt=document.getElementById("cutoffDate");Pt&&Pt.addEventListener("change",Ve);const Ut=document.getElementById("activeFiltersIndicator");Ut&&Ut.addEventListener("click",y=>{y.target.classList.contains("clear-filters")&&(St(),Ft())});const qt=document.getElementById("timelineHeader"),jt=document.getElementById("timelinePanel");qt&&jt&&qt.addEventListener("click",()=>{jt.classList.toggle("expanded")&&ia()});const ot=document.getElementById("timelineTableContainer");ot&&ot.addEventListener("click",y=>{const A=y.target.closest(".timeline-expand-row");if(!A)return;const ee=A.dataset.type,_=A.classList.toggle("expanded"),me=A.querySelector(".timeline-expand-icon");me&&(me.textContent=_?"▼":"▶"),ot.querySelectorAll(`.timeline-fund-row[data-type="${ee}"]`).forEach(qe=>{qe.classList.toggle("visible",_)})}),document.addEventListener("keydown",y=>{const N=y.target;N.tagName==="INPUT"||N.tagName==="TEXTAREA"||N.tagName==="SELECT"||(y.ctrlKey&&y.key==="n"?(y.preventDefault(),Xe()):y.key==="?"&&!y.ctrlKey&&!y.metaKey?Z("shortcutsModal"):y.key==="Escape"&&(W(),document.querySelectorAll(".modal.show").forEach(A=>{R(A.id)})))});const $n=document.getElementById("closeShortcutsModalBtn"),Rn=document.getElementById("closeShortcutsModal2Btn");[$n,Rn].forEach(y=>{y&&y.addEventListener("click",()=>R("shortcutsModal"))})}async function rn(){try{K("Initializing..."),await qn();const e=await q();g.setFunds(e);const t=await ie();g.setGroups(t);const n=await Le(),a=new Map;n.forEach(o=>a.set(o.name,o)),g.setFundNameData(a),g.setFundNames(new Set(n.map(o=>o.name))),$a(),Ga(),Oa(),_a(),qa(),ba(),Fa(),Ta(),mo(),io(),await H(),U(),setTimeout(()=>{va()},1e3),Ea()}catch(e){console.error("Error initializing application:",e),U(),I("Error initializing application: "+e.message,"error")}}window.showAddFundModal=Xe;window.showManageFundsModal=Ge;window.resetFilters=St;document.readyState==="loading"?document.addEventListener("DOMContentLoaded",rn):rn();</script>
  <style rel="stylesheet" crossorigin>:root{--color-primary: #2C3E50;--color-primary-light: #34495E;--color-background: #ECF0F1;--color-white: #ffffff;--color-action: #3498DB;--color-action-hover: #2980B9;--color-success: #27AE60;--color-success-hover: #229954;--color-danger: #E74C3C;--color-danger-hover: #C0392B;--color-warning: #F39C12;--color-warning-bg: #FEF9E7;--color-secondary: #95A5A6;--color-secondary-hover: #7F8C8D;--color-text: #2C3E50;--color-text-light: #95A5A6;--color-muted: #95A5A6;--color-border: #E0E0E0;--color-border-input: #BDC3C7;--color-hover-bg: #F8F9FA;--color-alt-bg: #FAFAFA;--spacing-xs: 4px;--spacing-sm: 8px;--spacing-md: 12px;--spacing-lg: 20px;--spacing-xl: 30px;--radius-sm: 3px;--radius-md: 4px;--shadow-sm: 0 1px 3px rgba(0, 0, 0, .1);--shadow-md: 0 2px 8px rgba(0, 0, 0, .15);--shadow-lg: 0 4px 12px rgba(0, 0, 0, .15);--transition-fast: all .15s ease;--transition-medium: all .2s ease}[data-theme=dark]{--color-primary: #F0F0F0;--color-primary-light: #2D3748;--color-background: #1A202C;--color-white: #2D3748;--color-action: #63B3ED;--color-action-hover: #4299E1;--color-success: #68D391;--color-success-hover: #48BB78;--color-danger: #FC8181;--color-danger-hover: #F56565;--color-warning: #F6E05E;--color-warning-bg: #744210;--color-secondary: #A0AEC0;--color-secondary-hover: #CBD5E0;--color-text: #F7FAFC;--color-text-light: #CBD5E0;--color-muted: #A0AEC0;--color-border: #4A5568;--color-border-input: #4A5568;--color-hover-bg: #374151;--color-alt-bg: #1F2937;--shadow-sm: 0 1px 3px rgba(0, 0, 0, .3);--shadow-md: 0 2px 8px rgba(0, 0, 0, .4);--shadow-lg: 0 4px 12px rgba(0, 0, 0, .5)}[data-theme=dark] header{background:#1f2937;border-bottom-color:#374151;color:#e2e8f0}[data-theme=dark] header h1{color:#f7fafc}[data-theme=dark] thead{background:#374151}[data-theme=dark] thead th{color:#f7fafc}[data-theme=dark] th:hover{background:#4a5568}[data-theme=dark] td{border-bottom-color:#374151}[data-theme=dark] tbody tr:last-child{border-color:#4a5568;background:#1f2937}[data-theme=dark] .modal-content{background:#2d3748;color:var(--color-text)}[data-theme=dark] .sidebar{background:#2d3748}[data-theme=dark] .sidebar-header{background:#1f2937;border-bottom-color:#4a5568}[data-theme=dark] .status-message{background:#2d3748}[data-theme=dark] .table-tag{background:#374151;color:#e2e8f0}[data-theme=dark] .tag{background:#4299e1}[data-theme=dark] input:disabled,[data-theme=dark] textarea:disabled,[data-theme=dark] select:disabled{background:#1f2937}[data-theme=dark] input,[data-theme=dark] textarea,[data-theme=dark] select,[data-theme=dark] select option,[data-theme=dark] .form-group input,[data-theme=dark] .form-group textarea,[data-theme=dark] .form-group select{background:#2d3748!important;color:#f7fafc!important}[data-theme=dark] input::placeholder,[data-theme=dark] textarea::placeholder{color:#a0aec0}[data-theme=dark] .details-table th{background-color:#374151;border-bottom-color:#4a5568}[data-theme=dark] .details-table tbody tr:nth-child(2n){background-color:#1f2937}[data-theme=dark] .details-table input:hover,[data-theme=dark] .details-table select:hover{border-bottom-color:#4a5568}[data-theme=dark] .details-table input:focus,[data-theme=dark] .details-table select:focus{border-bottom-color:var(--color-action)}[data-theme=dark] .group-item,[data-theme=dark] .fund-name-item{background:#1f2937;border-color:#4a5568;color:#f7fafc}[data-theme=dark] .action-dropdown{background:#2d3748;border-color:#4a5568}[data-theme=dark] .action-dropdown a:hover{background:#374151}[data-theme=dark] .action-dropdown a.danger-action:hover{background:#742a2a}[data-theme=dark] .loading-content{background:#2d3748}[data-theme=dark] .multi-select-trigger{background:#2d3748;border-color:#4a5568;color:#f7fafc}[data-theme=dark] .multi-select-dropdown{background:#2d3748;border-color:#4a5568}[data-theme=dark] .multi-select-option:hover,[data-theme=dark] .multi-select-option.highlighted{background:#3b5068}[data-theme=dark] .multi-select-option.selected{background:#63b3ed33}[data-theme=dark] .multi-select-actions{background:#1f2937;border-top-color:#4a5568}[data-theme=dark] .multi-select-option.group-top-level{background:#374151}[data-theme=dark] .multi-select-option.group-separator{border-top-color:#4a5568}[data-theme=dark] .multi-select-option.group-child{border-left-color:#63b3ed}[data-theme=dark] .multi-select-search{background:var(--color-bg);border-bottom-color:#4a5568}[data-theme=dark] .multi-select-search input{background:#374151;border-color:#4a5568;color:var(--color-text)}[data-theme=dark] .multi-select-search input:focus{border-color:var(--color-action)}[data-theme=dark] .multi-select-all-option{border-bottom-color:#4a5568}.portfolio-summary{display:flex;flex-wrap:wrap;gap:16px;padding:16px 20px;background:var(--color-alt-bg);border:1px solid var(--color-border);border-radius:var(--radius-md);margin-bottom:20px}.summary-stat{display:flex;flex-direction:column;min-width:100px;padding:8px 16px;background:var(--color-white);border-radius:var(--radius-sm);border:1px solid var(--color-border)}.summary-label{font-size:11px;font-weight:600;text-transform:uppercase;color:var(--color-text-light);letter-spacing:.5px;margin-bottom:4px}.summary-value{font-size:18px;font-weight:600;color:var(--color-text);font-variant-numeric:tabular-nums}.summary-value.positive{color:var(--color-success)}.summary-value.negative{color:var(--color-danger)}#detailsSummary{gap:10px}#detailsSummary .summary-value{font-size:13px}#detailsSummary .summary-label{font-size:9px}#detailsSummary .summary-stat{min-width:70px;padding:8px 10px}.summary-label-container{display:flex;align-items:center;gap:4px}.info-icon{display:inline-flex;align-items:center;justify-content:center;width:14px;height:14px;border-radius:50%;background:var(--color-text-light);color:var(--color-white);font-size:9px;font-weight:700;cursor:help;position:relative;flex-shrink:0}.info-icon:hover{background:var(--color-action)}.info-icon .tooltip{display:none;position:absolute;bottom:calc(100% + 8px);left:50%;transform:translate(-50%);background:var(--color-primary);color:#fff;padding:8px 12px;border-radius:var(--radius-md);font-size:12px;font-weight:400;white-space:normal;width:220px;text-align:left;z-index:1000;box-shadow:var(--shadow-md);line-height:1.4}.info-icon .tooltip:after{content:"";position:absolute;top:100%;left:50%;transform:translate(-50%);border:6px solid transparent;border-top-color:var(--color-primary)}.info-icon:hover .tooltip{display:block}[data-theme=dark] .info-icon{background:var(--color-text-light);color:var(--color-background)}[data-theme=dark] .info-icon .tooltip{background:#4a5568}[data-theme=dark] .info-icon .tooltip:after{border-top-color:#4a5568}.timeline-panel{background:var(--color-white);border:1px solid var(--color-border);border-radius:var(--radius-md);margin-bottom:20px;overflow:hidden}.timeline-header{display:flex;justify-content:space-between;align-items:center;padding:12px 16px;background:var(--color-alt-bg);border-bottom:1px solid var(--color-border);cursor:pointer;user-select:none}.timeline-header:hover{background:var(--color-hover-bg)}.timeline-header h3{margin:0;font-size:14px;font-weight:600;color:var(--color-text);display:flex;align-items:center;gap:8px}.timeline-toggle{font-size:12px;color:var(--color-text-light);transition:transform .2s ease}.timeline-panel.expanded .timeline-toggle{transform:rotate(180deg)}.timeline-content{display:none;padding:16px;overflow-x:auto}.timeline-panel.expanded .timeline-content{display:block}.timeline-table{width:100%;border-collapse:collapse;font-size:13px;min-width:600px}.timeline-table th,.timeline-table td{padding:8px 12px;text-align:right;border:1px solid var(--color-border);white-space:nowrap}.timeline-table th:not(:first-child),.timeline-table td:not(:first-child){min-width:90px;width:90px}.timeline-table th{background:var(--color-alt-bg);font-weight:600;color:var(--color-text)}.timeline-table th:first-child,.timeline-table td:first-child{text-align:left;position:sticky;left:0;background:var(--color-white);z-index:1}.timeline-table th:first-child{background:var(--color-alt-bg)}.timeline-table .year-projected{background:var(--color-alt-bg);font-style:italic}.timeline-table .year-projected th{background:#e8f4fd}[data-theme=dark] .timeline-table .year-projected th{background:#2c4a5e}.timeline-table .year-estimated{background:var(--color-warning-bg);font-style:italic}.timeline-table .year-estimated th{background:var(--color-warning-bg)}.timeline-estimated-indicator{display:inline-block;font-size:10px;color:var(--color-warning);margin-left:4px;vertical-align:super;cursor:help}.timeline-table .row-calls td{color:var(--color-danger)}.timeline-table .row-distributions td,.timeline-table .row-net td.positive{color:var(--color-success)}.timeline-table .row-net td.negative{color:var(--color-danger)}.timeline-table .row-net{font-weight:600;border-top:2px solid var(--color-border)}.timeline-table .row-label{font-weight:500;color:var(--color-text)}.timeline-table td:first-child{font-weight:500}.timeline-divider{border-left:3px solid var(--color-action)!important}.timeline-expand-row{cursor:pointer}.timeline-expand-row:hover{background:var(--color-hover-bg)}.timeline-expand-icon{display:inline-block;width:16px;font-size:10px;color:var(--color-text-light)}.timeline-fund-row{display:none}.timeline-fund-row.visible{display:table-row}.timeline-fund-row td{background:var(--color-alt-bg);font-size:12px}.timeline-fund-row td:first-child{padding-left:28px;background:var(--color-alt-bg)}.timeline-no-data{text-align:center;padding:30px;color:var(--color-text-light);font-style:italic}@media (max-width: 768px){.timeline-table{font-size:11px}.timeline-table th,.timeline-table td{padding:6px 8px}}.shortcuts-modal .modal-content{max-width:500px}.shortcuts-list{display:grid;grid-template-columns:auto 1fr;gap:12px 20px;margin-top:16px}.shortcut-key{display:inline-flex;align-items:center;gap:4px}.shortcut-key kbd{display:inline-block;padding:4px 8px;font-family:monospace;font-size:12px;background:var(--color-alt-bg);border:1px solid var(--color-border);border-radius:var(--radius-sm);box-shadow:0 1px 2px #0000001a}.shortcut-desc{color:var(--color-text);font-size:14px}.health-check-modal .modal-content{max-width:700px;max-height:80vh;display:flex;flex-direction:column}.health-check-summary{display:flex;gap:16px;flex-wrap:wrap;padding:16px;background:var(--color-alt-bg);border-radius:var(--radius-sm);margin-bottom:16px}.health-check-stat{text-align:center;padding:8px 16px;min-width:80px}.health-check-stat-value{font-size:24px;font-weight:600}.health-check-stat-label{font-size:12px;color:var(--color-secondary-hover);text-transform:uppercase}.health-check-stat-value.error-count{color:var(--color-danger)}.health-check-stat-value.warning-count{color:var(--color-warning)}.health-check-stat-value.info-count{color:var(--color-action)}.health-check-stat-value.success-count{color:var(--color-success)}.health-check-results{flex:1;overflow-y:auto;max-height:400px}.health-check-empty{text-align:center;padding:40px;color:var(--color-success);font-size:16px}.health-check-loading{display:flex;flex-direction:column;align-items:center;justify-content:center;padding:40px;gap:16px;color:var(--color-text-light)}.health-check-loading .loading-spinner{width:32px;height:32px}.health-issue{display:flex;align-items:flex-start;gap:12px;padding:12px;border-bottom:1px solid var(--color-border)}.health-issue:last-child{border-bottom:none}.health-issue:hover{background:var(--color-hover-bg)}.health-issue-severity{padding:4px 8px;border-radius:var(--radius-sm);font-size:11px;font-weight:600;text-transform:uppercase;flex-shrink:0}.severity-error{background:#e74c3c26;color:var(--color-danger)}.severity-warning{background:#f1c40f26;color:var(--color-warning)}.severity-info{background:#3498db26;color:var(--color-action)}.health-issue-content{flex:1}.health-issue-fund{font-weight:600;color:var(--color-primary);margin-bottom:4px}.health-issue-message{font-size:14px;color:var(--color-text)}.health-issue-category{font-size:12px;color:var(--color-secondary-hover);margin-top:4px}.health-check-section-header{font-size:13px;font-weight:600;text-transform:uppercase;color:var(--color-secondary-hover);padding:12px 12px 8px;border-bottom:1px solid var(--color-border);background:var(--color-alt-bg)}.duplicate-pair{display:flex;align-items:flex-start;gap:12px;padding:12px;border-bottom:1px solid var(--color-border)}.duplicate-pair:last-child{border-bottom:none}.duplicate-pair:hover{background:var(--color-hover-bg)}.duplicate-confidence{padding:4px 8px;border-radius:var(--radius-sm);font-size:11px;font-weight:600;text-transform:uppercase;flex-shrink:0}.confidence-high{background:#e74c3c26;color:var(--color-danger)}.confidence-medium{background:#f1c40f26;color:var(--color-warning)}.confidence-low{background:#3498db26;color:var(--color-action)}.duplicate-content{flex:1}.duplicate-funds{display:flex;align-items:center;gap:8px;flex-wrap:wrap;margin-bottom:4px}.duplicate-fund-link{font-weight:600;color:var(--color-action);cursor:pointer}.duplicate-fund-link:hover{text-decoration:underline}.duplicate-separator{color:var(--color-secondary-hover)}.duplicate-reason{font-size:14px;color:var(--color-text)}.btn-dismiss-issue{padding:4px 10px;font-size:12px;background:transparent;border:1px solid var(--color-border);border-radius:var(--radius-sm);color:var(--color-text-light);cursor:pointer;flex-shrink:0;align-self:center;transition:all .15s ease}.btn-dismiss-issue:hover{background:var(--color-hover-bg);border-color:var(--color-secondary-hover);color:var(--color-text)}@media (max-width: 768px){.portfolio-summary{gap:8px;padding:12px}.summary-stat{min-width:80px;padding:6px 10px}.summary-label{font-size:10px}.summary-value{font-size:14px}}*{box-sizing:border-box;margin:0;padding:0}body{font-family:-apple-system,BlinkMacSystemFont,Segoe UI,Roboto,Oxygen,Ubuntu,Cantarell,sans-serif;background:var(--color-background);min-height:100vh;padding:var(--spacing-lg)}.container{max-width:1800px;margin:0 auto;background:var(--color-white);border-radius:var(--radius-md);box-shadow:var(--shadow-sm);overflow:hidden}header{background:var(--color-primary);color:var(--color-white);padding:24px var(--spacing-xl);border-bottom:1px solid var(--color-primary-light)}header h1{font-size:1.75em;font-weight:600;margin-bottom:4px;letter-spacing:-.5px}header p{font-size:.95em;opacity:.85;font-weight:400}.controls-bar{background:var(--color-alt-bg);padding:var(--spacing-lg) var(--spacing-xl);display:flex;gap:16px;flex-wrap:wrap;align-items:flex-end;border-bottom:1px solid var(--color-border)}.control-group{display:flex;flex-direction:column;gap:6px}.control-group label{font-weight:500;font-size:.85em;color:var(--color-text)}.control-group select,.control-group input[type=date],.control-group input[type=text]{padding:var(--spacing-sm) var(--spacing-md);border:1px solid var(--color-border-input);border-radius:var(--radius-sm);font-size:14px;min-width:150px;background:var(--color-white);color:var(--color-text)}.control-group select:focus,.control-group input[type=date]:focus,.control-group input[type=text]:focus{outline:none;border-color:var(--color-action);box-shadow:0 0 0 2px #3498db1a}.filter-badge{display:inline-flex;align-items:center;gap:6px;background:var(--color-action);color:#fff;font-size:11px;font-weight:600;padding:3px 8px;border-radius:12px;margin-left:8px;white-space:nowrap}.filter-badge .clear-filters{display:inline-flex;align-items:center;justify-content:center;width:14px;height:14px;border-radius:50%;background:#ffffff4d;color:#fff;font-size:10px;cursor:pointer;border:none;padding:0;line-height:1}.filter-badge .clear-filters:hover{background:#ffffff80}.multi-select{position:relative;min-width:150px}.multi-select-trigger{display:flex;align-items:center;justify-content:space-between;padding:var(--spacing-sm) var(--spacing-md);border:1px solid var(--color-border-input);border-radius:var(--radius-sm);font-size:14px;background:var(--color-white);color:var(--color-text);cursor:pointer;min-height:36px;gap:8px}.multi-select-trigger:hover{border-color:var(--color-action)}.multi-select.open .multi-select-trigger{border-color:var(--color-action);box-shadow:0 0 0 2px #3498db1a}.multi-select-display{flex:1;overflow:hidden;text-overflow:ellipsis;white-space:nowrap}.multi-select-display .placeholder{color:var(--color-muted)}.multi-select-count{background:var(--color-action);color:#fff;font-size:11px;font-weight:600;padding:2px 6px;border-radius:10px;flex-shrink:0}.multi-select-arrow{flex-shrink:0;transition:transform .2s ease}.multi-select.open .multi-select-arrow{transform:rotate(180deg)}.multi-select-dropdown{position:absolute;top:100%;left:0;min-width:220px;margin-top:4px;background:var(--color-white);border:1px solid var(--color-border);border-radius:var(--radius-sm);box-shadow:var(--shadow-lg);z-index:1000;display:none}.multi-select.open .multi-select-dropdown{display:block}.multi-select-option{display:flex;align-items:center;gap:8px;padding:8px 12px;cursor:pointer;transition:background .15s ease}.multi-select-option:hover,.multi-select-option.highlighted{background:#e8f4fc;outline:none}.multi-select-option.selected{background:#3498db1a}.multi-select-option input[type=checkbox]{margin:0;cursor:pointer}.multi-select-option label{flex:1;cursor:pointer;font-size:14px;white-space:nowrap}.multi-select-option.group-option{padding-left:calc(12px + var(--indent-level, 0) * 16px)}.multi-select-option.group-top-level{background:var(--color-alt-bg);font-weight:600}.multi-select-option.group-top-level label{font-weight:600}.multi-select-option.group-separator{margin-top:6px;border-top:1px solid var(--color-border);padding-top:10px}.multi-select-option.group-child{border-left:3px solid var(--color-primary-light, #85c1e9);margin-left:8px;padding-left:calc(12px + var(--indent-level, 0) * 16px - 11px)}.multi-select-actions{display:flex;gap:8px;padding:8px 12px;border-top:1px solid var(--color-border);background:var(--color-alt-bg)}.multi-select-actions button{flex:1;padding:4px 8px;font-size:12px}.multi-select-search{padding:8px;border-bottom:1px solid var(--color-border);position:sticky;top:0;background:var(--color-white);z-index:1}.multi-select-search input{width:100%;padding:6px 10px;border:1px solid var(--color-border-input);border-radius:var(--radius-sm);font-size:13px;background:var(--color-white);color:var(--color-text)}.multi-select-all-option{border-bottom:1px solid var(--color-border);font-weight:500}.multi-select-all-option label{font-weight:500}.multi-select-search input:focus{outline:none;border-color:var(--color-action);box-shadow:0 0 0 2px #3498db1a}.multi-select-search input::placeholder{color:var(--color-muted)}.multi-select-options{max-height:350px;overflow-y:auto}.multi-select-option.search-hidden{display:none}.multi-select-no-results{padding:12px;text-align:center;color:var(--color-muted);font-size:13px;display:none}.multi-select-no-results.visible{display:block}.searchable-select{position:relative}.searchable-select-trigger{display:flex;align-items:center;justify-content:space-between;padding:var(--spacing-sm) var(--spacing-md);border:1px solid var(--color-border-input);border-radius:var(--radius-sm);font-size:14px;background:var(--color-white);color:var(--color-text);cursor:pointer;min-height:36px;gap:8px}.searchable-select-trigger:hover{border-color:var(--color-action)}.searchable-select.open .searchable-select-trigger{border-color:var(--color-action);box-shadow:0 0 0 2px #3498db1a}.searchable-select-display{flex:1;overflow:hidden;text-overflow:ellipsis;white-space:nowrap}.searchable-select-arrow{flex-shrink:0;width:0;height:0;border-left:5px solid transparent;border-right:5px solid transparent;border-top:5px solid var(--color-text-light);transition:transform .2s ease}.searchable-select.open .searchable-select-arrow{transform:rotate(180deg)}.searchable-select-dropdown{position:absolute;top:100%;left:0;right:0;min-width:200px;margin-top:4px;background:var(--color-white);border:1px solid var(--color-border);border-radius:var(--radius-sm);box-shadow:var(--shadow-lg);z-index:1000;display:none}.searchable-select.open .searchable-select-dropdown{display:block}.searchable-select-search{padding:8px;background:var(--color-bg);border-bottom:1px solid var(--color-border)}.searchable-select-search input{width:100%;padding:6px 10px;border:1px solid var(--color-border-input);border-radius:var(--radius-sm);font-size:13px;background:var(--color-white);color:var(--color-text)}.searchable-select-search input:focus{outline:none;border-color:var(--color-action);box-shadow:0 0 0 2px #3498db1a}.searchable-select-options{max-height:250px;overflow-y:auto}.searchable-select-option{display:flex;align-items:center;padding:8px 12px;cursor:pointer;font-size:14px;color:var(--color-text)}.searchable-select-option:hover{background:var(--color-hover-bg)}.searchable-select-option.selected{background:#3498db1a;font-weight:500}.searchable-select-option.highlighted{background:#e8f4fc;outline:none}.searchable-select-option.search-hidden{display:none}.searchable-select-option[data-indent="1"]{padding-left:28px}.searchable-select-option[data-indent="2"]{padding-left:44px}.searchable-select-option[data-indent="3"]{padding-left:60px}.searchable-select-no-results{padding:12px;text-align:center;color:var(--color-muted);font-size:13px;display:none}.searchable-select-no-results.visible{display:block}[data-theme=dark] .searchable-select-trigger{background:#2d3748;border-color:#4a5568;color:#f7fafc}[data-theme=dark] .searchable-select-dropdown{background:#2d3748;border-color:#4a5568}[data-theme=dark] .searchable-select-option:hover{background:#374151}[data-theme=dark] .searchable-select-option.selected{background:#63b3ed33}[data-theme=dark] .searchable-select-option.highlighted{background:#3b5068}[data-theme=dark] .searchable-select-search{background:var(--color-bg);border-bottom-color:#4a5568}[data-theme=dark] .searchable-select-search input{background:#374151;border-color:#4a5568;color:var(--color-text)}button{padding:9px 18px;border:none;border-radius:var(--radius-sm);font-size:14px;font-weight:500;cursor:pointer;transition:var(--transition-fast)}.controls-bar button{margin-top:auto}.btn-primary{background:var(--color-action);color:var(--color-white)}.btn-primary:hover{background:var(--color-action-hover)}.btn-secondary{background:var(--color-secondary);color:var(--color-white)}.btn-secondary:hover{background:var(--color-secondary-hover)}.btn-success{background:var(--color-success);color:var(--color-white)}.btn-success:hover{background:var(--color-success-hover)}.btn-danger{background:var(--color-danger);color:var(--color-white)}.btn-danger:hover{background:var(--color-danger-hover)}.btn-link{background:none;border:none;color:var(--color-action);cursor:pointer;padding:2px 4px;font-size:inherit;text-decoration:underline}.btn-link:hover{color:var(--color-action-hover)}.btn-info{background:var(--color-primary-light);color:var(--color-white)}.btn-info:hover{background:var(--color-primary)}button:disabled{opacity:.5;cursor:not-allowed}button:focus-visible,a:focus-visible,input:focus-visible,select:focus-visible,textarea:focus-visible{outline:2px solid var(--color-action);outline-offset:2px}button:focus:not(:focus-visible),a:focus:not(:focus-visible),input:focus:not(:focus-visible),select:focus:not(:focus-visible){outline:none}.skip-link{position:absolute;top:-40px;left:0;background:var(--color-action);color:#fff;padding:8px;z-index:100000;transition:top .3s}.skip-link:focus{top:0}.sr-announce{position:absolute;left:-10000px;width:1px;height:1px;overflow:hidden}.filter-loading{display:none;align-items:center;gap:8px;padding:8px 12px;color:var(--color-text-light);font-size:13px}.filter-loading.show{display:flex}.filter-loading-spinner{width:16px;height:16px;border:2px solid var(--color-border);border-top-color:var(--color-action);border-radius:50%;animation:spin .8s linear infinite}@keyframes spin{to{transform:rotate(360deg)}}tbody tr:focus{outline:2px solid var(--color-action);outline-offset:-2px}tbody tr[tabindex]:hover{background:var(--color-hover-bg)}.btn-icon{background:none;border:none;color:var(--color-text-light);font-size:16px;padding:var(--spacing-xs) var(--spacing-sm);cursor:pointer;transition:var(--transition-fast)}.btn-icon:hover{color:var(--color-primary-light)}.action-dropdown{display:none;position:fixed;background:var(--color-white);border:1px solid var(--color-border);border-radius:var(--radius-md);box-shadow:var(--shadow-lg);min-width:160px;z-index:10000;padding:var(--spacing-xs) 0}.action-dropdown.show{display:block}.action-dropdown a{display:block;padding:10px 16px;color:var(--color-text);text-decoration:none;font-size:14px;transition:var(--transition-fast)}.action-dropdown a:hover{background:var(--color-hover-bg)}.action-dropdown a.danger-action{color:var(--color-danger)}.action-dropdown a.danger-action:hover{background:#ffebee}.dropdown{position:relative;display:inline-block}.dropdown-menu{display:none;position:absolute;top:100%;right:0;background:var(--color-white);border:1px solid var(--color-border);border-radius:var(--radius-sm);box-shadow:var(--shadow-md);min-width:160px;z-index:1000;margin-top:var(--spacing-xs)}.dropdown-menu.show{display:block}.dropdown-menu a{display:block;padding:10px 16px;color:var(--color-text);text-decoration:none;font-size:14px;transition:var(--transition-fast)}.dropdown-menu a:hover{background:var(--color-hover-bg)}.dropdown-menu a:first-child{border-radius:var(--radius-sm) var(--radius-sm) 0 0}.dropdown-menu a:last-child{border-radius:0 0 var(--radius-sm) var(--radius-sm)}.content{padding:var(--spacing-xl)}.table-container{overflow-x:auto;margin-bottom:var(--spacing-sm)}.table-pagination{display:flex;align-items:center;justify-content:center;gap:16px;padding:16px;background:var(--color-alt-bg);border:1px solid var(--color-border);border-top:none;border-radius:0 0 var(--radius-sm) var(--radius-sm);margin-bottom:var(--spacing-xl)}.pagination-info{color:var(--color-text-light);font-size:14px}.pagination-info strong{color:var(--color-text)}.load-more-btn{padding:8px 24px;font-size:14px}.table-container table,table{width:100%;border-collapse:collapse;background:var(--color-white);border:1px solid var(--color-border);border-radius:var(--radius-sm);overflow:hidden}.table-container table{width:100%;table-layout:auto}thead{background:var(--color-primary-light);color:var(--color-white);position:sticky;top:0;z-index:10}th{padding:14px var(--spacing-md);text-align:left;font-weight:500;cursor:pointer;user-select:none;white-space:nowrap;font-size:.9em}th:hover{background:var(--color-primary)}th.sorted-asc:after{content:" ↑";opacity:1}th.sorted-desc:after{content:" ↓";opacity:1}th.sorted-asc[data-sort-priority="1"]:after{content:" ↑¹"}th.sorted-asc[data-sort-priority="2"]:after{content:" ↑²"}th.sorted-asc[data-sort-priority="3"]:after{content:" ↑³"}th.sorted-asc[data-sort-priority="4"]:after{content:" ↑⁴"}th.sorted-asc[data-sort-priority="5"]:after{content:" ↑⁵"}th.sorted-desc[data-sort-priority="1"]:after{content:" ↓¹"}th.sorted-desc[data-sort-priority="2"]:after{content:" ↓²"}th.sorted-desc[data-sort-priority="3"]:after{content:" ↓³"}th.sorted-desc[data-sort-priority="4"]:after{content:" ↓⁴"}th.sorted-desc[data-sort-priority="5"]:after{content:" ↓⁵"}th.wrap-header{white-space:normal;line-height:1.3;padding:10px 8px}th{position:relative}th.resizable{overflow:hidden;text-overflow:ellipsis}th .resizer{position:absolute;top:0;right:-8px;width:16px;height:100%;cursor:col-resize;user-select:none;z-index:10}th .resizer:hover{background-color:var(--color-action);width:4px;right:0}th.resizing{user-select:none}#fundsTable th:nth-child(2),#fundsTable td:nth-child(2){max-width:200px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap}td{padding:12px;border-bottom:1px solid #F0F0F0;font-size:.9em;color:var(--color-primary)}tbody tr:hover{background:var(--color-hover-bg)}tbody tr:last-child{border-top:2px solid var(--color-primary-light);border-bottom:2px solid var(--color-primary-light);font-weight:600;background:var(--color-alt-bg)}tbody tr:last-child td{border-bottom:none}table.no-summary-row tbody tr:last-child{border-top:none;border-bottom:1px solid var(--color-border);font-weight:400;background:transparent}[data-theme=dark] table.no-summary-row tbody tr:last-child{border-color:var(--color-border);background:transparent}td.number{text-align:right;font-variant-numeric:tabular-nums}th.center,td.center{text-align:center}.positive{color:var(--color-success)}.negative{color:var(--color-danger)}.empty-state{text-align:center;padding:60px 20px;color:var(--color-text-light)}.action-buttons{display:flex;gap:5px;flex-wrap:nowrap}.btn-sm{padding:6px 12px;font-size:12px;min-width:auto;white-space:nowrap}.modal{display:none;position:fixed;z-index:1000;left:0;top:0;width:100%;height:100%;overflow-y:auto;background-color:#00000080}.modal.show{display:flex;align-items:flex-start;justify-content:center;padding:40px 20px}.modal-content{background-color:var(--color-white);padding:30px;border-radius:var(--radius-md);width:100%;max-width:700px;box-shadow:0 4px 12px #00000026;position:relative;margin:auto}.modal-content h2{margin-bottom:24px;color:var(--color-primary);font-size:1.5em;font-weight:600}.modal .close{position:absolute;top:15px;right:20px;font-size:28px;font-weight:300;color:var(--color-text-light);cursor:pointer;line-height:1;width:30px;height:30px;display:flex;align-items:center;justify-content:center;border-radius:var(--radius-sm);transition:var(--transition-medium)}.modal .close:hover{background:var(--color-border);color:var(--color-primary)}.confirm-modal{z-index:2000}.confirm-modal-content{max-width:450px;text-align:center}.confirm-modal-content h2{margin-bottom:16px}.confirm-modal-message{color:var(--color-text);line-height:1.6;margin-bottom:8px;white-space:pre-wrap}.confirm-modal-content .form-actions{justify-content:center}.confirm-modal-content .form-actions button{flex:0 1 auto;min-width:100px}.form-group{margin-bottom:20px}.form-group label{display:block;margin-bottom:8px;font-weight:500;color:var(--color-primary);font-size:.9em}.form-group label.checkbox-label{display:inline-flex;align-items:center;gap:8px;cursor:pointer}.form-group label.checkbox-label input[type=checkbox]{width:auto;margin:0}.form-group input,.form-group select,.form-group textarea{width:100%;padding:10px 12px;border:1px solid var(--color-border-input);border-radius:var(--radius-sm);font-size:14px;transition:var(--transition-fast);background:var(--color-white)}.form-group input:focus,.form-group select:focus,.form-group textarea:focus{outline:none;border-color:var(--color-action);box-shadow:0 0 0 2px #3498db1a}.form-group.has-error input,.form-group.has-error select,.form-group.has-error textarea{border-color:var(--color-danger);background-color:#e74c3c0d}.form-group.has-error input:focus,.form-group.has-error select:focus,.form-group.has-error textarea:focus{border-color:var(--color-danger);box-shadow:0 0 0 2px #e74c3c1a}.form-group textarea{font-family:Courier New,monospace;resize:vertical;min-height:100px}.form-group .hint{font-size:12px;color:var(--color-secondary-hover);margin-top:5px}.tags-container{display:flex;flex-wrap:wrap;gap:6px;margin-bottom:8px;min-height:24px}.tag{display:inline-flex;align-items:center;background:var(--color-action);color:var(--color-white);padding:4px 10px;border-radius:12px;font-size:13px;font-weight:500;gap:6px}.tag-remove{cursor:pointer;font-weight:700;font-size:16px;line-height:1;opacity:.8}.tag-remove:hover{opacity:1}.table-tags{display:flex;flex-wrap:wrap;gap:4px}.table-tag{display:inline-block;background:#e8f4f8;color:var(--color-primary);padding:2px 8px;border-radius:10px;font-size:11px;font-weight:500;white-space:nowrap}.form-actions{display:flex;gap:10px;margin-top:25px}.form-actions button{flex:1}.status-message{position:fixed;top:20px;right:20px;padding:14px 45px 14px 20px;border-radius:var(--radius-sm);background:var(--color-white);box-shadow:0 2px 8px #00000026;z-index:2000;animation:slideIn .2s ease;max-width:400px;border-left:3px solid}.status-message.success{border-left-color:var(--color-success)}.status-message.error{border-left-color:var(--color-danger)}.status-message.warning{border-left-color:#f39c12}.status-message .close-status{position:absolute;top:10px;right:12px;font-size:20px;font-weight:300;color:var(--color-text-light);cursor:pointer;line-height:1;background:none;border:none;padding:0}.status-message .close-status:hover{color:var(--color-primary)}@keyframes slideIn{0%{transform:translate(400px);opacity:0}to{transform:translate(0);opacity:1}}.loading-overlay{position:fixed;top:0;left:0;width:100%;height:100%;background:#00000080;display:none;justify-content:center;align-items:center;z-index:3000}.loading-overlay.show{display:flex}.loading-content{background:var(--color-white);padding:30px 40px;border-radius:5px;text-align:center;box-shadow:0 4px 12px #0000004d}.loading-spinner{border:4px solid #f3f3f3;border-top:4px solid var(--color-action);border-radius:50%;width:40px;height:40px;animation:spin 1s linear infinite;margin:0 auto 15px}@keyframes spin{0%{transform:rotate(0)}to{transform:rotate(360deg)}}.loading-text{color:var(--color-primary);font-size:16px;font-weight:500}input[type=file]{display:none}.file-input-label{display:inline-block;padding:9px 18px;background:var(--color-primary-light);color:var(--color-white);border-radius:var(--radius-sm);cursor:pointer;font-weight:500;transition:var(--transition-fast);font-size:14px}.file-input-label:hover{background:var(--color-primary)}input:disabled,textarea:disabled,select:disabled{opacity:.6;background:#f5f5f5;cursor:not-allowed}.details-table-wrapper{overflow-x:auto;margin-top:15px;border:1px solid var(--color-border);border-radius:var(--radius-sm);max-width:100%}.details-table{border-collapse:collapse;font-size:.85em}.details-table th{background-color:var(--color-primary-light);color:var(--color-white);padding:6px 8px;text-align:left;border:none;border-bottom:2px solid var(--color-primary);font-weight:500;font-size:.85em}.details-table td{padding:6px 8px;border:none}.details-table tbody tr:nth-child(2n){background-color:var(--color-alt-bg)}.details-table input,.details-table select{padding:6px 8px;background:transparent;border:none;border-bottom:1px solid transparent;border-radius:0;font-size:1em;box-sizing:border-box;transition:border-color .15s ease}.details-table input:hover,.details-table select:hover{border-bottom-color:var(--color-border-input)}.details-table input:focus,.details-table select:focus{border-bottom-color:var(--color-action);outline:none}.details-table input[type=number],.details-table input[type=text]{text-align:right;width:90px}.details-table input[type=date]{text-align:left;width:130px}.details-table select{text-align:left;width:115px}.details-table input[type=checkbox]{width:auto}#cashFlowsTable{width:100%}#cashFlowsTable th:nth-child(1),#cashFlowsTable td:nth-child(1){width:150px}#cashFlowsTable th:nth-child(2),#cashFlowsTable td:nth-child(2){width:140px}#cashFlowsTable th:nth-child(3),#cashFlowsTable td:nth-child(3){width:130px}#cashFlowsTable th:nth-child(4),#cashFlowsTable td:nth-child(4){width:160px;text-align:center}#cashFlowsTable th:nth-child(5),#cashFlowsTable td:nth-child(5){width:auto;text-align:right}#navTable{width:100%}#navTable th:nth-child(1),#navTable td:nth-child(1){width:150px}#navTable th:nth-child(2),#navTable td:nth-child(2){width:140px;text-align:right}#navTable th:nth-child(3),#navTable td:nth-child(3){width:auto;text-align:right}.delete-row-btn{background:none;border:none;color:var(--color-danger);font-size:18px;padding:4px 8px;cursor:pointer;transition:var(--transition-fast)}.delete-row-btn:hover{color:var(--color-danger-hover)}.validation-error-row{background-color:#ffebee!important;border-left:3px solid var(--color-danger)}.validation-error-row input{border-color:var(--color-danger)!important}#manageFundNamesModal .fund-name-item{display:flex;justify-content:space-between;align-items:center;padding:10px;margin-bottom:8px;background:var(--color-alt-bg);border:1px solid var(--color-border);border-radius:var(--radius-sm);gap:10px}#manageFundNamesModal .fund-name-item .btn-sm{margin-left:5px}.group-item{display:flex;justify-content:space-between;align-items:center;padding:8px 10px;margin-bottom:4px;background:var(--color-alt-bg);border:1px solid var(--color-border);border-radius:var(--radius-sm)}.group-item.level-0{margin-left:0;font-weight:600}.group-item.level-1{margin-left:20px;font-weight:500}.group-item.level-2{margin-left:40px}.group-item.level-3{margin-left:60px}.group-item-info{flex:1;display:flex;align-items:center;gap:10px}.group-item-type{font-size:.85em;color:var(--color-secondary-hover);font-style:italic}.group-item-actions{display:flex;gap:5px}@media (max-width: 1400px){.controls-bar{flex-direction:column;align-items:stretch}.control-group{width:100%}}@media (max-width: 768px){body{padding:var(--spacing-sm)}header{padding:16px var(--spacing-md)}header h1{font-size:1.4em}.controls-bar{padding:var(--spacing-md);gap:12px}.content{padding:var(--spacing-md)}.table-container{overflow-x:auto;-webkit-overflow-scrolling:touch}.modal-content{padding:20px;margin:20px;max-width:calc(100% - 40px)}.form-actions{flex-direction:column}.form-actions button{width:100%}.sidebar{width:280px;right:-280px}.btn-icon{font-size:18px!important;padding:6px}th,td{font-size:.85em;padding:8px 6px}}@media (max-width: 480px){header h1{font-size:1.2em}header p{font-size:.85em}.controls-bar{gap:8px}.modal-content{padding:15px}.modal-content h2{font-size:1.2em}th,td{font-size:.8em;padding:6px 4px}.table-container table{min-width:800px}}@media print{:root,[data-theme=dark]{--color-primary: #2C3E50;--color-primary-light: #34495E;--color-background: #ECF0F1;--color-white: #ffffff;--color-action: #3498DB;--color-success: #27AE60;--color-danger: #E74C3C;--color-text: #2C3E50;--color-text-light: #95A5A6;--color-muted: #95A5A6;--color-border: #E0E0E0;--color-hover-bg: #F8F9FA;--color-alt-bg: #FAFAFA}body{background:#fff!important;color:#2c3e50!important;padding:0}.container{box-shadow:none;border-radius:0}.controls-bar,.btn-sm,button{display:none!important}header{background:#fff!important;color:#2c3e50!important;border-bottom:2px solid #2C3E50!important;padding:15px}header h1{color:#2c3e50!important}header p{color:#95a5a6!important}.content{padding:10px}table{width:100%;max-width:100%;page-break-inside:auto;border:1px solid var(--color-primary);table-layout:fixed}.table-container table{min-width:100%!important;max-width:100%!important}thead{background:#2c3e50!important;-webkit-print-color-adjust:exact;print-color-adjust:exact}thead th{color:#fff!important;background:#2c3e50!important}tr{page-break-inside:avoid;page-break-after:auto}th,td{padding:8px 6px;font-size:10px;color:#2c3e50!important;background:#fff!important}tbody tr:nth-child(2n) td{background:#f8f9fa!important}.container,.content,.table-container{background:#fff!important}.positive{color:#27ae60!important}.negative{color:#e74c3c!important}#fundsTable th,#fundsTable td{min-width:auto!important;max-width:none!important}#fundsTable th:nth-child(1),#fundsTable td:nth-child(1){width:130px!important}#fundsTable th:nth-child(2),#fundsTable td:nth-child(2){width:90px!important;max-width:90px!important;overflow:hidden;text-overflow:ellipsis}#fundsTable th:nth-child(3),#fundsTable td:nth-child(3){width:45px!important}#fundsTable th:nth-child(4),#fundsTable td:nth-child(4),#fundsTable th:nth-child(5),#fundsTable td:nth-child(5),#fundsTable th:nth-child(6),#fundsTable td:nth-child(6),#fundsTable th:nth-child(7),#fundsTable td:nth-child(7),#fundsTable th:nth-child(8),#fundsTable td:nth-child(8),#fundsTable th:nth-child(11),#fundsTable td:nth-child(11){width:70px!important}#fundsTable th:nth-child(9),#fundsTable td:nth-child(9),#fundsTable th:nth-child(10),#fundsTable td:nth-child(10){width:50px!important}thead tr th:last-child,tbody tr td:last-child{display:none}tbody tr:last-child{border-top:2px solid var(--color-primary);border-bottom:2px solid var(--color-primary);background:#f0f0f0!important;-webkit-print-color-adjust:exact;print-color-adjust:exact}.positive{color:var(--color-success)!important;-webkit-print-color-adjust:exact;print-color-adjust:exact}.negative{color:var(--color-danger)!important;-webkit-print-color-adjust:exact;print-color-adjust:exact}@page{size:landscape;margin:.5in}#timelinePanel:not(.expanded){display:none!important}}.sidebar-overlay{position:fixed;top:0;left:0;width:100%;height:100%;background:#00000080;z-index:9998;opacity:0;visibility:hidden;transition:opacity .3s ease,visibility .3s ease}.sidebar-overlay.show{opacity:1;visibility:visible}.sidebar{position:fixed;top:0;right:-320px;width:320px;height:100%;background:var(--color-white);box-shadow:-2px 0 8px #00000026;z-index:9999;transition:right .3s ease;display:flex;flex-direction:column}.sidebar.show{right:0}.sidebar-header{display:flex;justify-content:space-between;align-items:center;padding:20px;border-bottom:1px solid var(--color-border);background:var(--color-hover-bg)}.sidebar-header h3{margin:0;color:var(--color-primary);font-size:18px;font-weight:600}.sidebar-close{background:none;border:none;font-size:28px;color:var(--color-secondary-hover);cursor:pointer;padding:0;width:30px;height:30px;display:flex;align-items:center;justify-content:center;border-radius:var(--radius-sm);transition:var(--transition-medium)}.sidebar-close:hover{background:var(--color-border);color:var(--color-primary)}.sidebar-content{flex:1;overflow-y:auto;padding:10px 0}.sidebar-section{margin-bottom:10px}.sidebar-section-title{padding:12px 20px 8px;margin:0;font-size:12px;font-weight:600;color:var(--color-secondary-hover);text-transform:uppercase;letter-spacing:.5px}.sidebar-item{padding:0}.sidebar-item a{display:flex;align-items:center;gap:12px;padding:12px 20px;color:var(--color-primary);text-decoration:none;transition:var(--transition-medium);cursor:pointer;font-size:14px}.sidebar-item a:hover{background:var(--color-hover-bg)}.sidebar-checkbox-label{display:flex;align-items:center;gap:12px;padding:12px 20px;cursor:pointer;transition:var(--transition-medium);font-size:14px}.sidebar-checkbox-label:hover{background:var(--color-hover-bg)}.sidebar-checkbox-label input[type=checkbox]{width:18px;height:18px;cursor:pointer;margin:0}.sidebar-checkbox-label span{color:var(--color-primary);flex:1}body.sidebar-open{overflow:hidden}[data-mask-accounts=true] #fundsTable th:nth-child(2),[data-mask-accounts=true] #fundsTable td:nth-child(2){display:none}.grouped-fund-row{background:var(--color-alt-bg)}.grouped-fund-row td:first-child{font-weight:600}.grouped-fund-row .investor-count{font-size:.85em;color:var(--color-text-light);font-weight:400}[data-theme=dark] .grouped-fund-row{background:var(--color-hover-bg)}.table-loading-row td{text-align:center;padding:40px;color:var(--color-text-light)}.table-loading-content{display:flex;flex-direction:column;align-items:center;gap:12px}.table-loading-spinner{width:24px;height:24px;border:3px solid var(--color-border);border-top-color:var(--color-action);border-radius:50%;animation:spin .8s linear infinite}.table-loading-text{font-size:14px}.header-toggle{font-size:14px;padding:2px 6px;border-radius:var(--radius-sm);transition:var(--transition-fast);background:transparent;color:var(--color-white);opacity:.7}.header-toggle:hover{opacity:1;background:#ffffff1a}.header-toggle.active{background-color:var(--color-action);color:#fff;opacity:1}[data-theme=dark] .header-toggle{color:var(--color-text)}[data-theme=dark] .header-toggle.active{background-color:var(--color-action);color:#fff}</style>
</head>
<body>
    <!-- Skip to main content for keyboard/screen reader users -->
    <a href="#mainContent" class="skip-link">Skip to main content</a>

    <!-- Screen reader announcements for dynamic content updates -->
    <div id="srAnnounce" class="sr-announce" aria-live="polite" aria-atomic="true"></div>

    <!-- Loading Overlay -->
    <div id="loadingOverlay" class="loading-overlay" role="dialog" aria-labelledby="loadingText" aria-modal="true">
        <div class="loading-content">
            <div class="loading-spinner" aria-hidden="true"></div>
            <div class="loading-text" id="loadingText">Loading...</div>
        </div>
    </div>

    <div class="container" role="main">
        <header role="banner">
            <h1 id="headerTitle">PE Fund Manager</h1>
            <p id="headerSubtitle">Private Equity Fund Analytics & Management Tool</p>
        </header>

        <div class="controls-bar" role="search" aria-label="Filter and search controls">
            <div class="control-group">
                <label>Filter by Group</label>
                <div class="multi-select" id="groupFilter" data-placeholder="All Groups">
                    <div class="multi-select-trigger" tabindex="0" role="combobox" aria-expanded="false" aria-haspopup="listbox">
                        <span class="multi-select-display"><span class="placeholder">All Groups</span></span>
                        <span class="multi-select-arrow">&#9662;</span>
                    </div>
                    <div class="multi-select-dropdown" role="listbox"></div>
                </div>
            </div>
            <div class="control-group">
                <label>Filter by Fund</label>
                <div class="multi-select" id="fundFilter" data-placeholder="All Funds">
                    <div class="multi-select-trigger" tabindex="0" role="combobox" aria-expanded="false" aria-haspopup="listbox">
                        <span class="multi-select-display"><span class="placeholder">All Funds</span></span>
                        <span class="multi-select-arrow">&#9662;</span>
                    </div>
                    <div class="multi-select-dropdown" role="listbox"></div>
                </div>
            </div>
            <div class="control-group">
                <label>Filter by Account</label>
                <div class="multi-select" id="accountFilter" data-placeholder="All Accounts">
                    <div class="multi-select-trigger" tabindex="0" role="combobox" aria-expanded="false" aria-haspopup="listbox">
                        <span class="multi-select-display"><span class="placeholder">All Accounts</span></span>
                        <span class="multi-select-arrow">&#9662;</span>
                    </div>
                    <div class="multi-select-dropdown" role="listbox"></div>
                </div>
            </div>
            <div class="control-group">
                <label>Filter by Vintage</label>
                <div class="multi-select" id="vintageFilter" data-placeholder="All Vintages">
                    <div class="multi-select-trigger" tabindex="0" role="combobox" aria-expanded="false" aria-haspopup="listbox">
                        <span class="multi-select-display"><span class="placeholder">All Vintages</span></span>
                        <span class="multi-select-arrow">&#9662;</span>
                    </div>
                    <div class="multi-select-dropdown" role="listbox"></div>
                </div>
            </div>
            <div class="control-group">
                <label>Filter by Tag</label>
                <div class="multi-select" id="tagFilter" data-placeholder="All Tags">
                    <div class="multi-select-trigger" tabindex="0" role="combobox" aria-expanded="false" aria-haspopup="listbox">
                        <span class="multi-select-display"><span class="placeholder">All Tags</span></span>
                        <span class="multi-select-arrow">&#9662;</span>
                    </div>
                    <div class="multi-select-dropdown" role="listbox"></div>
                </div>
            </div>
            <div class="control-group">
                <label for="cutoffDate" title="Calculate all metrics (IRR, MOIC, NAV, etc.) as of this date">Cutoff Date</label>
                <input type="date" id="cutoffDate" title="Calculate all metrics (IRR, MOIC, NAV, etc.) as of this date" aria-label="Cutoff date for calculating metrics">
            </div>
            <span id="activeFiltersIndicator" class="filter-badge" style="display: none;" aria-live="polite"></span>
            <div id="filterLoading" class="filter-loading" aria-live="polite">
                <div class="filter-loading-spinner" aria-hidden="true"></div>
                <span>Filtering...</span>
            </div>
            <div style="margin-left: auto;">
                <button class="btn-icon" id="toggleSidebarBtn" title="Settings and Actions" aria-label="Open settings sidebar" style="font-size: 20px;">&#9776;</button>
            </div>
        </div>

        <div class="content" id="mainContent">
            <div id="portfolioSummary" class="portfolio-summary">
                <div class="summary-stat">
                    <span class="summary-label">Investments</span>
                    <span class="summary-value" id="summaryInvestmentCount">0</span>
                </div>
                <div class="summary-stat">
                    <span class="summary-label">Funds</span>
                    <span class="summary-value" id="summaryFundCount">0</span>
                </div>
                <div class="summary-stat">
                    <span class="summary-label">Total Commitment</span>
                    <span class="summary-value" id="summaryCommitment">$0</span>
                </div>
                <div class="summary-stat">
                    <span class="summary-label">Total NAV</span>
                    <span class="summary-value" id="summaryNav">$0</span>
                </div>
                <div class="summary-stat">
                    <div class="summary-label-container">
                        <span class="summary-label">Avg IRR</span>
                        <span class="info-icon" aria-label="IRR explanation">?<span class="tooltip">Internal Rate of Return: The annualized return rate that makes the net present value of all cash flows equal to zero. Higher is better.</span></span>
                    </div>
                    <span class="summary-value" id="summaryIRR">N/A</span>
                </div>
                <div class="summary-stat">
                    <div class="summary-label-container">
                        <span class="summary-label">Avg MOIC</span>
                        <span class="info-icon" aria-label="MOIC explanation">?<span class="tooltip">Multiple on Invested Capital: Total value (distributions + NAV) divided by total contributions. A MOIC of 2.0x means you doubled your money.</span></span>
                    </div>
                    <span class="summary-value" id="summaryMOIC">N/A</span>
                </div>
                <div class="summary-stat">
                    <div class="summary-label-container">
                        <span class="summary-label">DPI</span>
                        <span class="info-icon" aria-label="DPI explanation">?<span class="tooltip">Distributions to Paid-In: Total distributions divided by total contributions. Measures actual cash returned to investors.</span></span>
                    </div>
                    <span class="summary-value" id="summaryDPI">N/A</span>
                </div>
                <div class="summary-stat">
                    <div class="summary-label-container">
                        <span class="summary-label">RVPI</span>
                        <span class="info-icon" aria-label="RVPI explanation">?<span class="tooltip">Residual Value to Paid-In: Current NAV divided by total contributions. Represents unrealized value still held in the fund.</span></span>
                    </div>
                    <span class="summary-value" id="summaryRVPI">N/A</span>
                </div>
                <div class="summary-stat">
                    <div class="summary-label-container">
                        <span class="summary-label">TVPI</span>
                        <span class="info-icon" aria-label="TVPI explanation">?<span class="tooltip">Total Value to Paid-In: DPI + RVPI. The most comprehensive measure of fund performance.</span></span>
                    </div>
                    <span class="summary-value" id="summaryTVPI">N/A</span>
                </div>
            </div>

            <div id="timelinePanel" class="timeline-panel">
                <div class="timeline-header" id="timelineHeader">
                    <h3>
                        <span>Cash Flow Timeline</span>
                        <span style="font-weight: normal; font-size: 12px; color: var(--color-text-light);">(Historical + Projected)</span>
                    </h3>
                    <span class="timeline-toggle">&#9660;</span>
                </div>
                <div class="timeline-content">
                    <div id="timelineTableContainer">
                        <p class="timeline-no-data">No investments to display yet.</p>
                    </div>
                </div>
            </div>

            <div class="table-container">
                <table id="fundsTable">
                    <thead>
                        <tr>
                            <th data-sort="fundName">Fund Name</th>
                            <th data-sort="accountNumber" class="center">Investor</th>
                            <th data-sort="vintage" class="center">Vintage</th>
                            <th data-sort="commitment" class="center number">Commitment</th>
                            <th data-sort="totalContributions" class="center number">Contributions</th>
                            <th data-sort="totalDistributions" class="center number">Distributions</th>
                            <th data-sort="nav" class="center number">Value (NAV)</th>
                            <th data-sort="investmentReturn" class="center number wrap-header">Investment<br>Return</th>
                            <th data-sort="moic" class="center number">MOIC</th>
                            <th data-sort="irr" class="center number">IRR</th>
                            <th data-sort="outstandingCommitment" class="center number wrap-header">Outstanding<br>Commitment</th>
                            <th class="center">
                                <button id="groupByFundToggle" class="btn-icon header-toggle" title="Group by Fund (Σ)" aria-label="Toggle group by fund">Σ</button>
                            </th>
                        </tr>
                    </thead>
                    <tbody id="fundsTableBody"></tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- Fund Add/Edit Modal -->
    <div id="fundModal" class="modal">
        <div class="modal-content">
            <span class="close" id="closeFundModalBtn">&times;</span>
            <h2 id="fundModalTitle">Add New Investment</h2>
            <form id="fundForm">
                <input type="hidden" id="fundId">
                <input type="hidden" id="isDuplicate">
                <div class="form-group">
                    <label for="fundName">Fund Name *</label>
                    <select id="fundName" required></select>
                    <div id="newFundNameContainer" style="display: none; margin-top: 8px;">
                        <div style="display: flex; gap: 8px;">
                            <input type="text" id="newFundNameInline" placeholder="Enter new fund name" style="flex: 1;">
                            <button type="button" class="btn-primary" id="addNewFundNameBtn" style="padding: 8px 12px; white-space: nowrap;">Add</button>
                            <button type="button" class="btn-secondary" id="cancelNewFundNameBtn" style="padding: 8px 12px;">Cancel</button>
                        </div>
                    </div>
                </div>
                <div class="form-group">
                    <label for="accountNumber">Account Number *</label>
                    <input type="text" id="accountNumber" required>
                </div>
                <div class="form-group">
                    <label for="fundGroup">Group (optional)</label>
                    <div class="searchable-select" id="fundGroupContainer" data-placeholder="No Group">
                        <input type="hidden" id="fundGroup" value="">
                        <div class="searchable-select-trigger" tabindex="0" aria-haspopup="listbox" aria-expanded="false">
                            <span class="searchable-select-display">No Group</span>
                            <span class="searchable-select-arrow"></span>
                        </div>
                        <div class="searchable-select-dropdown">
                            <div class="searchable-select-search">
                                <input type="text" placeholder="Search groups..." aria-label="Search groups">
                            </div>
                            <div class="searchable-select-options"></div>
                            <div class="searchable-select-no-results">No matches found</div>
                        </div>
                    </div>
                </div>
                <div class="form-group">
                    <label for="commitment">Commitment (USD) *</label>
                    <input type="text" id="commitment" required placeholder="e.g., 1,000,000">
                </div>
                <div id="duplicateMultiplierContainer" class="form-group" style="display: none;">
                    <label for="duplicateMultiplier">Duplicate Multiplier</label>
                    <input type="number" id="duplicateMultiplier" step="any" value="1">
                </div>
                <div class="form-actions">
                    <button type="submit" class="btn-primary" id="saveFundBtn">Save</button>
                    <button type="button" class="btn-secondary" id="cancelFundModalBtn">Cancel</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Action Dropdown -->
    <div id="actionDropdown" class="action-dropdown">
        <a href="#" id="actionEdit">Edit</a>
        <a href="#" id="actionDuplicate">Duplicate</a>
        <a href="#" id="actionViewDetails">View Details</a>
        <a href="#" id="actionDelete" class="danger-action">Delete</a>
    </div>

    <!-- Manage Fund Names Modal -->
    <div id="manageFundNamesModal" class="modal">
        <div class="modal-content">
            <span class="close" id="closeManageFundsModalBtn">&times;</span>
            <h2>Manage Fund Names</h2>
            <div class="form-group">
                <label for="newFundNameInput">Add New Fund Name</label>
                <input type="text" id="newFundNameInput" placeholder="Enter fund name">
            </div>
            <details id="newFundTermsDetails" style="margin-bottom: 15px;">
                <summary style="cursor: pointer; color: var(--color-action); font-size: 13px;">+ Add Fund Terms (optional)</summary>
                <div style="padding: 10px; background: var(--color-alt-bg); border-radius: var(--radius-sm); margin-top: 10px;">
                    <div class="form-group" style="margin-bottom: 10px;">
                        <label for="newFundTermStartDate" style="font-size: 12px;">Investment Term Start Date</label>
                        <input type="date" id="newFundTermStartDate">
                    </div>
                    <div class="form-group" style="margin-bottom: 0;">
                        <label for="newFundInvestmentTerm" style="font-size: 12px;">Investment Term (years)</label>
                        <input type="number" id="newFundInvestmentTerm" min="1" max="15" step="1" placeholder="e.g., 5">
                    </div>
                </div>
            </details>
            <button class="btn-primary" id="addNewFundNameModalBtn" style="width: 100%;">Add Fund Name</button>
            <hr style="margin: 20px 0; border: none; border-top: 1px solid var(--color-border);">
            <h3 style="margin-bottom: 15px; color: var(--color-text); font-weight: 600; font-size: 1.1em;">Existing Fund Names</h3>
            <div id="fundNamesList"></div>
            <div class="form-actions">
                <button class="btn-secondary" id="closeManageFundsModal2Btn">Close</button>
            </div>
        </div>
    </div>

    <!-- Edit Fund Name Modal -->
    <div id="editFundNameModal" class="modal">
        <div class="modal-content">
            <span class="close" id="closeEditFundNameModalBtn">&times;</span>
            <h2>Edit Fund</h2>
            <input type="hidden" id="editFundNameOriginal" value="">
            <div class="form-group">
                <label for="editFundNameInput">Fund Name</label>
                <input type="text" id="editFundNameInput" placeholder="Enter fund name">
            </div>
            <div class="form-group">
                <label for="editFundTags">Tags (optional)</label>
                <div id="editFundTagsContainer" class="tags-container"></div>
                <input type="text" id="editFundTagsInput" placeholder="Add tag (e.g., Venture Capital, Growth Equity)" list="editFundTagsDatalist">
                <datalist id="editFundTagsDatalist"></datalist>
                <div class="hint">Press Enter to add tags. Click x on a tag to remove it.</div>
            </div>
            <h3 style="margin: 20px 0 15px 0; color: var(--color-text); font-weight: 600; font-size: 1em; border-top: 1px solid var(--color-border); padding-top: 20px;">Fund Terms</h3>
            <div class="form-group">
                <label for="editFundTermStartDate">Investment Term Start Date</label>
                <input type="date" id="editFundTermStartDate">
            </div>
            <div class="form-group">
                <label for="editFundInvestmentTerm">Investment Term (years)</label>
                <input type="number" id="editFundInvestmentTerm" min="1" max="15" step="1" placeholder="e.g., 5">
                <div class="hint">Number of years from term start during which capital can be called</div>
            </div>
            <div class="form-actions">
                <button class="btn-primary" id="saveEditedFundNameBtn">Save Changes</button>
                <button class="btn-secondary" id="cancelEditFundNameBtn">Cancel</button>
            </div>
        </div>
    </div>

    <!-- Manage Groups Modal -->
    <div id="manageGroupsModal" class="modal">
        <div class="modal-content" style="max-width: 600px;">
            <span class="close" id="closeManageGroupsModal2Btn">&times;</span>
            <h2>Manage Account Groups</h2>
            <input type="hidden" id="editGroupId" value="">
            <h3 id="groupFormTitle" style="margin-bottom: 15px; color: var(--color-text); font-weight: 600; font-size: 1.1em;">Add New Group</h3>
            <div class="form-group">
                <label for="newGroupName">Group Name</label>
                <input type="text" id="newGroupName" placeholder="e.g., John Smith, Smith Family Trust">
                <small style="color: var(--color-text-light); font-size: 0.85em; margin-top: 4px; display: block;">Use groups to organize by account holder or entity</small>
            </div>
            <div class="form-group">
                <label>Parent Group (optional)</label>
                <div class="searchable-select" id="newGroupParentContainer" data-placeholder="None (Top Level)">
                    <input type="hidden" id="newGroupParent" value="">
                    <div class="searchable-select-trigger" tabindex="0" aria-haspopup="listbox" aria-expanded="false">
                        <span class="searchable-select-display">None (Top Level)</span>
                        <span class="searchable-select-arrow"></span>
                    </div>
                    <div class="searchable-select-dropdown">
                        <div class="searchable-select-search">
                            <input type="text" placeholder="Search groups..." aria-label="Search groups">
                        </div>
                        <div class="searchable-select-options"></div>
                        <div class="searchable-select-no-results">No matches found</div>
                    </div>
                </div>
            </div>
            <div class="form-group">
                <label for="newGroupType">Type (optional)</label>
                <select id="newGroupType">
                    <option value="">Select type...</option>
                    <option value="Household">Household</option>
                    <option value="Client">Client</option>
                    <option value="Revocable Trust">Revocable Trust</option>
                    <option value="Irrevocable Trust">Irrevocable Trust</option>
                    <option value="Retirement Account">Retirement Account</option>
                    <option value="Other">Other</option>
                </select>
            </div>
            <div style="display: flex; gap: 10px;">
                <button id="saveGroupBtn" class="btn-primary">Add Group</button>
                <button id="cancelEditBtn" class="btn-secondary" style="display: none;">Cancel</button>
            </div>
            <hr style="margin: 20px 0; border: none; border-top: 1px solid var(--color-border);">
            <h3 style="margin-bottom: 15px; color: var(--color-text); font-weight: 600; font-size: 1.1em;">Existing Groups</h3>
            <div id="groupsList" style="max-height: 400px; overflow-y: auto;"></div>
            <div class="form-actions">
                <button class="btn-secondary" id="closeManageGroupsModalBtn">Close</button>
            </div>
        </div>
    </div>

    <!-- Details Modal -->
    <div id="detailsModal" class="modal">
        <div class="modal-content" style="max-width: 900px;">
            <span class="close" id="closeDetailsModalBtn">&times;</span>
            <h2 id="detailsModalTitle">Fund Details</h2>
            <p id="detailsModalSubtitle" style="margin: 5px 0 0 0; color: var(--color-text-light); font-size: 0.9em;"></p>
            <div id="detailsSummary" class="portfolio-summary" style="margin-top: 20px;">
                <div class="summary-stat"><span class="summary-label">Total Commitment</span><span class="summary-value" id="detailsSummaryCommitment">$0</span></div>
                <div class="summary-stat"><span class="summary-label">Contributions</span><span class="summary-value" id="detailsSummaryContributions">$0</span></div>
                <div class="summary-stat"><span class="summary-label">Distributions</span><span class="summary-value" id="detailsSummaryDistributions">$0</span></div>
                <div class="summary-stat"><span class="summary-label">Current Value</span><span class="summary-value" id="detailsSummaryValue">$0</span></div>
                <div class="summary-stat"><span class="summary-label">Investment Return</span><span class="summary-value" id="detailsSummaryReturn">$0</span></div>
                <div class="summary-stat"><span class="summary-label">Outstanding Commitment</span><span class="summary-value" id="detailsSummaryOutstanding">$0</span></div>
            </div>
            <h3 style="margin-top: 20px; color: var(--color-text); font-weight: 600; font-size: 1.1em;">Cash Flows</h3>
            <div class="details-table-wrapper">
                <table class="details-table" id="cashFlowsTable">
                    <thead><tr><th>Date</th><th class="number">Amount (USD)</th><th class="center">Type</th><th class="center">Affects Commitment?</th><th></th></tr></thead>
                    <tbody></tbody>
                </table>
            </div>
            <button type="button" class="btn-primary btn-sm" style="margin-top: 10px;" id="addCashFlowRowBtn">Add Cash Flow</button>
            <h3 style="margin-top: 30px; color: var(--color-text); font-weight: 600; font-size: 1.1em;">Values</h3>
            <div class="details-table-wrapper">
                <table class="details-table" id="navTable">
                    <thead><tr><th>Date</th><th>Amount (USD)</th><th></th></tr></thead>
                    <tbody></tbody>
                </table>
            </div>
            <button type="button" class="btn-primary btn-sm" style="margin-top: 10px;" id="addNavRowBtn">Add Value</button>
            <div class="form-actions">
                <button class="btn-primary" id="saveDetailsChangesBtn">Save Changes</button>
                <button class="btn-secondary" id="cancelDetailsModalBtn">Cancel</button>
            </div>
        </div>
    </div>

    <!-- Backup Warning Modal -->
    <div id="backupWarningModal" class="modal">
        <div class="modal-content" style="max-width: 500px;">
            <span class="close" id="closeBackupWarningBtn">&times;</span>
            <h2 style="color: var(--color-warning); margin-bottom: 15px;">Important: Backup Your Data</h2>
            <p style="line-height: 1.6; margin-bottom: 15px;">Your PE Fund Manager data is stored <strong>locally in your browser</strong>. This means your data could be lost if:</p>
            <ul style="margin: 15px 0 15px 25px; line-height: 1.8;">
                <li>You clear your browser cache or cookies</li>
                <li>You uninstall your browser</li>
                <li>Your computer crashes or is reset</li>
                <li>You switch to a different device</li>
            </ul>
            <p style="line-height: 1.6; margin-bottom: 20px; font-weight: 600; color: var(--color-danger);">Please export your data regularly to avoid data loss!</p>
            <div class="form-group">
                <label class="checkbox-label"><input type="checkbox" id="dontShowBackupWarning">Don't show this warning again</label>
            </div>
            <div class="form-actions">
                <button class="btn-success" id="exportNowBtn">Export Now</button>
                <button class="btn-secondary" id="remindLaterBtn">Remind Me Later</button>
            </div>
        </div>
    </div>

    <!-- Health Check Modal -->
    <div id="healthCheckModal" class="modal health-check-modal">
        <div class="modal-content health-check-content">
            <span class="close" id="closeHealthCheckModalBtn">&times;</span>
            <h2>Data Health Check</h2>
            <div id="healthCheckSummary" class="health-check-summary"></div>
            <div id="healthCheckResults" class="health-check-results"></div>
            <div class="form-actions">
                <button class="btn-secondary" id="closeHealthCheckModal2Btn">Close</button>
            </div>
        </div>
    </div>

    <!-- Keyboard Shortcuts Modal -->
    <div id="shortcutsModal" class="modal shortcuts-modal">
        <div class="modal-content">
            <span class="close" id="closeShortcutsModalBtn">&times;</span>
            <h2>Keyboard Shortcuts</h2>
            <div class="shortcuts-list">
                <div class="shortcut-key"><kbd>?</kbd></div><div class="shortcut-desc">Show this help</div>
                <div class="shortcut-key"><kbd>Ctrl</kbd> + <kbd>N</kbd></div><div class="shortcut-desc">Add new investment</div>
                <div class="shortcut-key"><kbd>Ctrl</kbd> + <kbd>E</kbd></div><div class="shortcut-desc">Export to JSON</div>
                <div class="shortcut-key"><kbd>Ctrl</kbd> + <kbd>S</kbd></div><div class="shortcut-desc">Save (in details modal)</div>
                <div class="shortcut-key"><kbd>Esc</kbd></div><div class="shortcut-desc">Close modal/sidebar</div>
            </div>
            <div class="form-actions"><button class="btn-secondary" id="closeShortcutsModal2Btn">Close</button></div>
        </div>
    </div>

    <!-- Confirm Modal -->
    <div id="confirmModal" class="modal confirm-modal">
        <div class="modal-content confirm-modal-content">
            <h2 id="confirmModalTitle">Confirm</h2>
            <p id="confirmModalMessage" class="confirm-modal-message"></p>
            <div class="form-actions">
                <button class="btn-secondary" id="confirmModalCancelBtn">Cancel</button>
                <button class="btn-danger" id="confirmModalConfirmBtn">Confirm</button>
            </div>
        </div>
    </div>

    <!-- Bulk Cash Flow Modal -->
    <div id="bulkCashFlowModal" class="modal">
        <div class="modal-content" style="max-width: 600px;">
            <span class="close" id="closeBulkCashFlowModalBtn">&times;</span>
            <h2>Bulk Cash Flow</h2>
            <p style="color: var(--color-text-light); margin-bottom: 20px; font-size: 14px;">Add a cash flow to all investors in a fund based on a percentage of their commitment.</p>
            <div class="form-group"><label for="bulkCashFlowFundName">Fund Name *</label><select id="bulkCashFlowFundName" required><option value="">Select a fund</option></select></div>
            <div class="form-group"><label for="bulkCashFlowDate">Date *</label><input type="date" id="bulkCashFlowDate" required></div>
            <div class="form-group"><label for="bulkCashFlowType">Type *</label><select id="bulkCashFlowType" required><option value="Contribution">Contribution (Capital Call)</option><option value="Distribution">Distribution</option><option value="Adjustment">Adjustment</option></select></div>
            <div class="form-group"><label for="bulkCashFlowPercentage">Percentage of Commitment *</label><input type="number" id="bulkCashFlowPercentage" step="0.01" min="0.01" max="100" placeholder="e.g., 4.5" required><div class="hint">Enter percentage (e.g., 4.5 for 4.5%)</div></div>
            <div class="form-group"><label><input type="checkbox" id="bulkCashFlowAffectsCommitment" checked>Affects unfunded commitment</label></div>
            <div id="bulkCashFlowPreview" style="display: none; margin: 20px 0; padding: 15px; background: var(--color-alt-bg); border-radius: var(--radius-sm); max-height: 300px; overflow-y: auto;"><h4 style="margin: 0 0 10px 0; font-size: 14px;">Preview</h4><div id="bulkCashFlowPreviewContent"></div></div>
            <div class="form-actions">
                <button type="button" class="btn-secondary" id="previewBulkCashFlowBtn">Preview</button>
                <button type="button" class="btn-primary" id="applyBulkCashFlowBtn" disabled>Apply</button>
                <button type="button" class="btn-secondary" id="cancelBulkCashFlowBtn">Cancel</button>
            </div>
        </div>
    </div>

    <!-- Bulk Remove Fund Modal -->
    <div id="bulkRemoveFundModal" class="modal">
        <div class="modal-content" style="max-width: 600px;">
            <span class="close" id="closeBulkRemoveFundModalBtn">&times;</span>
            <h2>Bulk Remove Fund</h2>
            <p style="color: var(--color-text-light); margin-bottom: 20px; font-size: 14px;">Remove all investor positions for a selected fund. This action cannot be undone.</p>
            <div class="form-group"><label for="bulkRemoveFundName">Fund Name *</label><select id="bulkRemoveFundName" required><option value="">Select a fund</option></select></div>
            <div id="bulkRemoveFundPreview" style="display: none; margin: 20px 0; padding: 15px; background: var(--color-alt-bg); border-radius: var(--radius-sm); max-height: 300px; overflow-y: auto;"><h4 style="margin: 0 0 10px 0; font-size: 14px; color: var(--color-danger);">The following investors will be removed:</h4><div id="bulkRemoveFundPreviewContent"></div></div>
            <div class="form-actions">
                <button type="button" class="btn-secondary" id="previewBulkRemoveFundBtn">Preview</button>
                <button type="button" class="btn-danger" id="applyBulkRemoveFundBtn" disabled>Remove All</button>
                <button type="button" class="btn-secondary" id="cancelBulkRemoveFundBtn">Cancel</button>
            </div>
        </div>
    </div>

    <!-- Bulk Assign Group Modal -->
    <div id="bulkAssignGroupModal" class="modal">
        <div class="modal-content" style="max-width: 600px;">
            <span class="close" id="closeBulkAssignGroupModalBtn">&times;</span>
            <h2>Bulk Assign Group</h2>
            <p style="color: var(--color-text-light); margin-bottom: 20px; font-size: 14px;">Assign all investments with a specific account number to a group.</p>
            <div class="form-group"><label for="bulkAssignGroupAccount">Account Number *</label><select id="bulkAssignGroupAccount" required><option value="">Select an account</option></select></div>
            <div class="form-group"><label for="bulkAssignGroupTarget">Target Group *</label><select id="bulkAssignGroupTarget" required><option value="">No Group</option></select></div>
            <div id="bulkAssignGroupPreview" style="display: none; margin: 20px 0; padding: 15px; background: var(--color-alt-bg); border-radius: var(--radius-sm); max-height: 300px; overflow-y: auto;"><h4 style="margin: 0 0 10px 0; font-size: 14px;">The following investments will be updated:</h4><div id="bulkAssignGroupPreviewContent"></div></div>
            <div class="form-actions">
                <button type="button" class="btn-secondary" id="previewBulkAssignGroupBtn">Preview</button>
                <button type="button" class="btn-primary" id="applyBulkAssignGroupBtn" disabled>Apply</button>
                <button type="button" class="btn-secondary" id="cancelBulkAssignGroupBtn">Cancel</button>
            </div>
        </div>
    </div>

    <!-- Import Preview Modal -->
    <div id="importPreviewModal" class="modal">
        <div class="modal-content" style="max-width: 700px;">
            <span class="close" id="closeImportPreviewModalBtn">&times;</span>
            <h2>Import Preview</h2>
            <p style="color: var(--color-text-light); margin-bottom: 20px; font-size: 14px;">Review the data to be imported before confirming.</p>
            <div id="importPreviewContent" style="margin: 20px 0; padding: 15px; background: var(--color-alt-bg); border-radius: var(--radius-sm); max-height: 400px; overflow-y: auto;"><p style="color: var(--color-text-light);">Select a JSON file to preview...</p></div>
            <div class="form-actions">
                <label for="importPreviewFileInput" class="btn-secondary" style="cursor: pointer; display: inline-block; padding: 9px 18px; min-width: 100px; text-align: center;">Choose File</label>
                <input type="file" id="importPreviewFileInput" accept=".json" style="display: none;">
                <button type="button" class="btn-primary" id="applyImportBtn" disabled style="min-width: 100px;">Import</button>
                <button type="button" class="btn-secondary" id="cancelImportPreviewBtn" style="min-width: 100px;">Cancel</button>
            </div>
        </div>
    </div>

    <!-- Sync Account Groups Modal -->
    <div id="syncAccountGroupsModal" class="modal">
        <div class="modal-content" style="max-width: 700px;">
            <span class="close" id="closeSyncAccountGroupsModalBtn">&times;</span>
            <h2>Sync Account Groups</h2>
            <p style="color: var(--color-text-light); margin-bottom: 20px; font-size: 14px;">Review account numbers with inconsistent group assignments. Apply sync to ensure all investments with the same account number share the same group.</p>
            <div id="syncAccountGroupsContent" style="margin: 20px 0; max-height: 400px; overflow-y: auto;"></div>
            <div class="form-actions">
                <button type="button" class="btn-primary" id="applySyncAccountGroupsBtn" disabled style="min-width: 100px;">Apply Sync</button>
                <button type="button" class="btn-secondary" id="cancelSyncAccountGroupsBtn" style="min-width: 100px;">Cancel</button>
            </div>
        </div>
    </div>

    <!-- Sidebar Panel -->
    <div id="sidebarOverlay" class="sidebar-overlay"></div>
    <div id="sidebar" class="sidebar">
        <div class="sidebar-header">
            <h3>Settings & Actions</h3>
            <button class="sidebar-close" id="closeSidebarBtn" title="Close">&times;</button>
        </div>
        <div class="sidebar-content">
            <div class="sidebar-section">
                <h4 class="sidebar-section-title">View Options</h4>
                <div class="sidebar-item"><label class="sidebar-checkbox-label"><input type="checkbox" id="sidebarShowTagsCheckbox" checked><span>Show Tags</span></label></div>
                <div class="sidebar-item"><label class="sidebar-checkbox-label"><input type="checkbox" id="sidebarMaskAccountsCheckbox"><span>Mask Accounts</span></label></div>
                <div class="sidebar-item"><label class="sidebar-checkbox-label"><input type="checkbox" id="sidebarDarkModeCheckbox"><span>Dark Mode</span></label></div>
            </div>
            <div class="sidebar-section">
                <h4 class="sidebar-section-title">Manage</h4>
                <div class="sidebar-item"><a href="#" id="sidebarNewInvestment">New Investment</a></div>
                <div class="sidebar-item"><a href="#" id="sidebarManageFunds">Manage Funds</a></div>
                <div class="sidebar-item"><a href="#" id="sidebarManageGroups">Manage Groups</a></div>
                <div class="sidebar-item"><a href="#" id="sidebarBulkCashFlow">Bulk Cash Flow</a></div>
                <div class="sidebar-item"><a href="#" id="sidebarBulkAssignGroup">Bulk Assign Group</a></div>
            </div>
            <div class="sidebar-section">
                <h4 class="sidebar-section-title">Data</h4>
                <div class="sidebar-item"><a href="#" id="sidebarExportCSV">Export to CSV</a></div>
                <div class="sidebar-item"><a href="#" id="sidebarExportJSON">Export to JSON</a></div>
                <div class="sidebar-item"><a href="#" id="sidebarExportPDF">Export to PDF</a></div>
                <div class="sidebar-item"><a href="#" id="sidebarImportJSON">Import JSON</a></div>
            </div>
            <div class="sidebar-section">
                <h4 class="sidebar-section-title">Admin</h4>
                <div class="sidebar-item"><a href="#" id="sidebarHealthCheck">Data Health Check</a></div>
                <div class="sidebar-item"><a href="#" id="sidebarSyncAccountGroups">Sync Account Groups</a></div>
                <div class="sidebar-item"><a href="#" id="sidebarLoadSampleData">Load Sample Data</a></div>
                <div class="sidebar-item"><a href="#" id="sidebarBulkRemoveFund" style="color: var(--color-danger);">Bulk Remove Fund</a></div>
                <div class="sidebar-item"><a href="#" id="sidebarClearDatabase" style="color: var(--color-danger);">Clear Database</a></div>
            </div>
        </div>
    </div>

</body>
</html>
