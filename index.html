<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PE Fund Manager</title>
    <style>
        /* ===========================
           CSS Variables
           =========================== */
        :root {
            /* Primary Colors */
            --color-primary: #2C3E50;
            --color-primary-light: #34495E;
            --color-background: #ECF0F1;
            --color-white: #ffffff;

            /* Action Colors */
            --color-action: #3498DB;
            --color-action-hover: #2980B9;
            --color-success: #27AE60;
            --color-success-hover: #229954;
            --color-danger: #E74C3C;
            --color-danger-hover: #C0392B;
            --color-secondary: #95A5A6;
            --color-secondary-hover: #7F8C8D;

            /* Neutral Colors */
            --color-text: #2C3E50;
            --color-text-light: #95A5A6;
            --color-border: #E0E0E0;
            --color-border-input: #BDC3C7;
            --color-hover-bg: #F8F9FA;
            --color-alt-bg: #FAFAFA;

            /* Spacing */
            --spacing-xs: 4px;
            --spacing-sm: 8px;
            --spacing-md: 12px;
            --spacing-lg: 20px;
            --spacing-xl: 30px;

            /* Border Radius */
            --radius-sm: 3px;
            --radius-md: 4px;

            /* Shadows */
            --shadow-sm: 0 1px 3px rgba(0, 0, 0, 0.1);
            --shadow-md: 0 2px 8px rgba(0, 0, 0, 0.15);
            --shadow-lg: 0 4px 12px rgba(0, 0, 0, 0.15);

            /* Transitions */
            --transition-fast: all 0.15s ease;
            --transition-medium: all 0.2s ease;
        }

        /* Dark Mode Theme */
        [data-theme="dark"] {
            --color-primary: #E8E8E8;
            --color-primary-light: #2D3748;
            --color-background: #1A202C;
            --color-white: #2D3748;

            --color-action: #4299E1;
            --color-action-hover: #3182CE;
            --color-success: #48BB78;
            --color-success-hover: #38A169;
            --color-danger: #FC8181;
            --color-danger-hover: #F56565;
            --color-secondary: #718096;
            --color-secondary-hover: #A0AEC0;

            --color-text: #E2E8F0;
            --color-text-light: #A0AEC0;
            --color-border: #4A5568;
            --color-border-input: #4A5568;
            --color-hover-bg: #374151;
            --color-alt-bg: #1F2937;

            --shadow-sm: 0 1px 3px rgba(0, 0, 0, 0.3);
            --shadow-md: 0 2px 8px rgba(0, 0, 0, 0.4);
            --shadow-lg: 0 4px 12px rgba(0, 0, 0, 0.5);
        }

        [data-theme="dark"] header {
            background: #1F2937;
            border-bottom-color: #374151;
        }

        [data-theme="dark"] thead {
            background: #374151;
        }

        [data-theme="dark"] th:hover {
            background: #4A5568;
        }

        [data-theme="dark"] td {
            border-bottom-color: #374151;
        }

        [data-theme="dark"] tbody tr:last-child {
            border-color: #4A5568;
            background: #1F2937;
        }

        [data-theme="dark"] .modal-content {
            background: #2D3748;
        }

        [data-theme="dark"] .sidebar {
            background: #2D3748;
        }

        [data-theme="dark"] .sidebar-header {
            background: #1F2937;
            border-bottom-color: #4A5568;
        }

        [data-theme="dark"] .status-message {
            background: #2D3748;
        }

        [data-theme="dark"] .table-tag {
            background: #374151;
            color: #E2E8F0;
        }

        [data-theme="dark"] .tag {
            background: #4299E1;
        }

        [data-theme="dark"] input:disabled,
        [data-theme="dark"] textarea:disabled,
        [data-theme="dark"] select:disabled {
            background: #1F2937;
        }

        [data-theme="dark"] .details-table th {
            background-color: #374151;
            border-color: #4A5568;
        }

        [data-theme="dark"] .details-table td {
            border-color: #4A5568;
        }

        [data-theme="dark"] .details-table tbody tr:nth-child(even) {
            background-color: #1F2937;
        }

        [data-theme="dark"] .group-item,
        [data-theme="dark"] .fund-name-item {
            background: #1F2937;
            border-color: #4A5568;
        }

        [data-theme="dark"] .action-dropdown {
            background: #2D3748;
            border-color: #4A5568;
        }

        [data-theme="dark"] .action-dropdown a:hover {
            background: #374151;
        }

        [data-theme="dark"] .action-dropdown a.danger-action:hover {
            background: #742A2A;
        }

        [data-theme="dark"] .loading-content {
            background: #2D3748;
        }

        /* Portfolio Summary Stats */
        .portfolio-summary {
            display: flex;
            flex-wrap: wrap;
            gap: 16px;
            padding: 16px 20px;
            background: var(--color-alt-bg);
            border: 1px solid var(--color-border);
            border-radius: var(--radius-md);
            margin-bottom: 20px;
        }

        .summary-stat {
            display: flex;
            flex-direction: column;
            min-width: 100px;
            padding: 8px 16px;
            background: var(--color-white);
            border-radius: var(--radius-sm);
            border: 1px solid var(--color-border);
        }

        .summary-label {
            font-size: 11px;
            font-weight: 600;
            text-transform: uppercase;
            color: var(--color-text-light);
            letter-spacing: 0.5px;
            margin-bottom: 4px;
        }

        .summary-value {
            font-size: 18px;
            font-weight: 600;
            color: var(--color-text);
            font-variant-numeric: tabular-nums;
        }

        .summary-value.positive {
            color: var(--color-success);
        }

        .summary-value.negative {
            color: var(--color-danger);
        }

        /* Keyboard Shortcuts Modal */
        .shortcuts-modal .modal-content {
            max-width: 500px;
        }

        .shortcuts-list {
            display: grid;
            grid-template-columns: auto 1fr;
            gap: 12px 20px;
            margin-top: 16px;
        }

        .shortcut-key {
            display: inline-flex;
            align-items: center;
            gap: 4px;
        }

        .shortcut-key kbd {
            display: inline-block;
            padding: 4px 8px;
            font-family: monospace;
            font-size: 12px;
            background: var(--color-alt-bg);
            border: 1px solid var(--color-border);
            border-radius: var(--radius-sm);
            box-shadow: 0 1px 2px rgba(0,0,0,0.1);
        }

        .shortcut-desc {
            color: var(--color-text);
            font-size: 14px;
        }

        @media (max-width: 768px) {
            .portfolio-summary {
                gap: 8px;
                padding: 12px;
            }

            .summary-stat {
                min-width: 80px;
                padding: 6px 10px;
            }

            .summary-label {
                font-size: 10px;
            }

            .summary-value {
                font-size: 14px;
            }
        }

        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background: var(--color-background);
            min-height: 100vh;
            padding: var(--spacing-lg);
        }

        .container {
            max-width: 1800px;
            margin: 0 auto;
            background: var(--color-white);
            border-radius: var(--radius-md);
            box-shadow: var(--shadow-sm);
            overflow: hidden;
        }

        header {
            background: var(--color-primary);
            color: var(--color-white);
            padding: 24px var(--spacing-xl);
            border-bottom: 1px solid var(--color-primary-light);
        }

        header h1 {
            font-size: 1.75em;
            font-weight: 600;
            margin-bottom: 4px;
            letter-spacing: -0.5px;
        }

        header p {
            font-size: 0.95em;
            opacity: 0.85;
            font-weight: 400;
        }

        .controls-bar {
            background: var(--color-alt-bg);
            padding: var(--spacing-lg) var(--spacing-xl);
            display: flex;
            gap: 16px;
            flex-wrap: wrap;
            align-items: flex-end;
            border-bottom: 1px solid var(--color-border);
        }

        .control-group {
            display: flex;
            flex-direction: column;
            gap: 6px;
        }

        .control-group label {
            font-weight: 500;
            font-size: 0.85em;
            color: var(--color-text);
        }

        .control-group select,
        .control-group input[type="date"],
        .control-group input[type="text"] {
            padding: var(--spacing-sm) var(--spacing-md);
            border: 1px solid var(--color-border-input);
            border-radius: var(--radius-sm);
            font-size: 14px;
            min-width: 150px;
            background: var(--color-white);
            color: var(--color-text);
        }

        .control-group select:focus,
        .control-group input[type="date"]:focus,
        .control-group input[type="text"]:focus {
            outline: none;
            border-color: var(--color-action);
            box-shadow: 0 0 0 2px rgba(52, 152, 219, 0.1);
        }

        button {
            padding: 9px 18px;
            border: none;
            border-radius: var(--radius-sm);
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            transition: var(--transition-fast);
        }

        .controls-bar button {
            margin-top: auto;
        }

        .btn-primary {
            background: var(--color-action);
            color: var(--color-white);
        }

        .btn-primary:hover {
            background: var(--color-action-hover);
        }

        .btn-secondary {
            background: var(--color-secondary);
            color: var(--color-white);
        }

        .btn-secondary:hover {
            background: var(--color-secondary-hover);
        }

        .btn-success {
            background: var(--color-success);
            color: var(--color-white);
        }

        .btn-success:hover {
            background: var(--color-success-hover);
        }

        .btn-danger {
            background: var(--color-danger);
            color: var(--color-white);
        }

        .btn-danger:hover {
            background: var(--color-danger-hover);
        }

        .btn-info {
            background: var(--color-primary-light);
            color: var(--color-white);
        }

        .btn-info:hover {
            background: var(--color-primary);
        }

        button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .btn-icon {
            background: none;
            border: none;
            color: var(--color-text-light);
            font-size: 16px;
            padding: var(--spacing-xs) var(--spacing-sm);
            cursor: pointer;
            transition: var(--transition-fast);
        }

        .btn-icon:hover {
            color: var(--color-primary-light);
        }

        /* Action Dropdown */
        .action-dropdown {
            display: none;
            position: fixed;
            background: var(--color-white);
            border: 1px solid var(--color-border);
            border-radius: var(--radius-md);
            box-shadow: var(--shadow-lg);
            min-width: 160px;
            z-index: 10000;
            padding: var(--spacing-xs) 0;
        }

        .action-dropdown.show {
            display: block;
        }

        .action-dropdown a {
            display: block;
            padding: 10px 16px;
            color: var(--color-text);
            text-decoration: none;
            font-size: 14px;
            transition: var(--transition-fast);
        }

        .action-dropdown a:hover {
            background: var(--color-hover-bg);
        }

        .action-dropdown a.danger-action {
            color: var(--color-danger);
        }

        .action-dropdown a.danger-action:hover {
            background: #FFEBEE;
        }

        /* Dropdown Menu */
        .dropdown {
            position: relative;
            display: inline-block;
        }

        .dropdown-menu {
            display: none;
            position: absolute;
            top: 100%;
            right: 0;
            background: var(--color-white);
            border: 1px solid var(--color-border);
            border-radius: var(--radius-sm);
            box-shadow: var(--shadow-md);
            min-width: 160px;
            z-index: 1000;
            margin-top: var(--spacing-xs);
        }

        .dropdown-menu.show {
            display: block;
        }

        .dropdown-menu a {
            display: block;
            padding: 10px 16px;
            color: var(--color-text);
            text-decoration: none;
            font-size: 14px;
            transition: var(--transition-fast);
        }

        .dropdown-menu a:hover {
            background: var(--color-hover-bg);
        }

        .dropdown-menu a:first-child {
            border-radius: var(--radius-sm) var(--radius-sm) 0 0;
        }

        .dropdown-menu a:last-child {
            border-radius: 0 0 var(--radius-sm) var(--radius-sm);
        }

        .content {
            padding: var(--spacing-xl);
        }

        .table-container {
            overflow-x: auto;
            margin-bottom: var(--spacing-xl);
        }

        /* Consolidated table styles - removed duplicate definition */
        .table-container table,
        table {
            width: 100%;
            border-collapse: collapse;
            background: var(--color-white);
            border: 1px solid var(--color-border);
            border-radius: var(--radius-sm);
            overflow: hidden;
        }

        .table-container table {
            width: 100%;
            table-layout: auto;
        }

        thead {
            background: var(--color-primary-light);
            color: var(--color-white);
            position: sticky;
            top: 0;
            z-index: 10;
        }

        th {
            padding: 14px var(--spacing-md);
            text-align: left;
            font-weight: 500;
            cursor: pointer;
            user-select: none;
            white-space: nowrap;
            font-size: 0.9em;
        }

        th:hover {
            background: var(--color-primary);
        }

        th.sorted-asc::after {
            content: ' ↑';
            opacity: 1;
        }

        th.sorted-desc::after {
            content: ' ↓';
            opacity: 1;
        }

        /* Multi-column sort priority indicators */
        th.sorted-asc[data-sort-priority="1"]::after { content: ' ↑¹'; }
        th.sorted-asc[data-sort-priority="2"]::after { content: ' ↑²'; }
        th.sorted-asc[data-sort-priority="3"]::after { content: ' ↑³'; }
        th.sorted-asc[data-sort-priority="4"]::after { content: ' ↑⁴'; }
        th.sorted-asc[data-sort-priority="5"]::after { content: ' ↑⁵'; }
        th.sorted-desc[data-sort-priority="1"]::after { content: ' ↓¹'; }
        th.sorted-desc[data-sort-priority="2"]::after { content: ' ↓²'; }
        th.sorted-desc[data-sort-priority="3"]::after { content: ' ↓³'; }
        th.sorted-desc[data-sort-priority="4"]::after { content: ' ↓⁴'; }
        th.sorted-desc[data-sort-priority="5"]::after { content: ' ↓⁵'; }

        th.wrap-header {
            white-space: normal;
            line-height: 1.3;
            padding: 10px 8px;
        }

        /* Resizable columns */
        th {
            position: relative;
        }

        th.resizable {
            overflow: hidden;
            text-overflow: ellipsis;
        }

        th .resizer {
            position: absolute;
            top: 0;
            right: -8px;
            width: 16px;
            height: 100%;
            cursor: col-resize;
            user-select: none;
            z-index: 10;
        }

        th .resizer:hover {
            background-color: var(--color-action);
            width: 4px;
            right: 0;
        }

        th.resizing {
            user-select: none;
        }

        /* Parent/Account column with max-width */
        #fundsTable th:nth-child(2),
        #fundsTable td:nth-child(2) {
            max-width: 200px;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }

        td {
            padding: 12px;
            border-bottom: 1px solid #F0F0F0;
            font-size: 0.9em;
            color: var(--color-primary);
        }

        tbody tr:hover {
            background: var(--color-hover-bg);
        }

        tbody tr:last-child {
            border-top: 2px solid var(--color-primary-light);
            border-bottom: 2px solid var(--color-primary-light);
            font-weight: 600;
            background: var(--color-alt-bg);
        }

        tbody tr:last-child td {
            border-bottom: none;
        }

        td.number {
            text-align: right;
            font-variant-numeric: tabular-nums;
        }

        th.center,
        td.center {
            text-align: center;
        }

        .positive {
            color: var(--color-success);
        }

        .negative {
            color: var(--color-danger);
        }

        .empty-state {
            text-align: center;
            padding: 60px 20px;
            color: var(--color-text-light);
        }

        .action-buttons {
            display: flex;
            gap: 5px;
            flex-wrap: nowrap;
        }

        .btn-sm {
            padding: 6px 12px;
            font-size: 12px;
            min-width: auto;
            white-space: nowrap;
        }

        /* Modal Styles */
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            overflow-y: auto;
            background-color: rgba(0, 0, 0, 0.5);
        }

        .modal.show {
            display: flex;
            align-items: flex-start;
            justify-content: center;
            padding: 40px 20px;
        }

        .modal-content {
            background-color: var(--color-white);
            padding: 30px;
            border-radius: var(--radius-md);
            width: 100%;
            max-width: 700px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
            position: relative;
            margin: auto;
        }

        .modal-content h2 {
            margin-bottom: 24px;
            color: var(--color-primary);
            font-size: 1.5em;
            font-weight: 600;
        }

        .modal .close {
            position: absolute;
            top: 15px;
            right: 20px;
            font-size: 28px;
            font-weight: 300;
            color: var(--color-text-light);
            cursor: pointer;
            line-height: 1;
            width: 30px;
            height: 30px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: var(--radius-sm);
            transition: var(--transition-medium);
        }

        .modal .close:hover {
            background: var(--color-border);
            color: var(--color-primary);
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 500;
            color: var(--color-primary);
            font-size: 0.9em;
        }

        .form-group input,
        .form-group select,
        .form-group textarea {
            width: 100%;
            padding: 10px 12px;
            border: 1px solid var(--color-border-input);
            border-radius: var(--radius-sm);
            font-size: 14px;
            transition: var(--transition-fast);
            background: var(--color-white);
        }

        .form-group input:focus,
        .form-group select:focus,
        .form-group textarea:focus {
            outline: none;
            border-color: var(--color-action);
            box-shadow: 0 0 0 2px rgba(52, 152, 219, 0.1);
        }

        .form-group textarea {
            font-family: 'Courier New', monospace;
            resize: vertical;
            min-height: 100px;
        }

        .form-group .hint {
            font-size: 12px;
            color: var(--color-secondary-hover);
            margin-top: 5px;
        }

        .tags-container {
            display: flex;
            flex-wrap: wrap;
            gap: 6px;
            margin-bottom: 8px;
            min-height: 24px;
        }

        .tag {
            display: inline-flex;
            align-items: center;
            background: var(--color-action);
            color: var(--color-white);
            padding: 4px 10px;
            border-radius: 12px;
            font-size: 13px;
            font-weight: 500;
            gap: 6px;
        }

        .tag-remove {
            cursor: pointer;
            font-weight: bold;
            font-size: 16px;
            line-height: 1;
            opacity: 0.8;
        }

        .tag-remove:hover {
            opacity: 1;
        }

        .table-tags {
            display: flex;
            flex-wrap: wrap;
            gap: 4px;
        }

        .table-tag {
            display: inline-block;
            background: #E8F4F8;
            color: var(--color-primary);
            padding: 2px 8px;
            border-radius: 10px;
            font-size: 11px;
            font-weight: 500;
            white-space: nowrap;
        }

        .form-actions {
            display: flex;
            gap: 10px;
            margin-top: 25px;
        }

        .form-actions button {
            flex: 1;
        }

        .status-message {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 14px 45px 14px 20px;
            border-radius: var(--radius-sm);
            background: var(--color-white);
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.15);
            z-index: 2000;
            animation: slideIn 0.2s ease;
            max-width: 400px;
            border-left: 3px solid;
        }

        .status-message.success {
            border-left-color: var(--color-success);
        }

        .status-message.error {
            border-left-color: var(--color-danger);
        }

        .status-message.warning {
            border-left-color: #F39C12;
        }

        .status-message .close-status {
            position: absolute;
            top: 10px;
            right: 12px;
            font-size: 20px;
            font-weight: 300;
            color: var(--color-text-light);
            cursor: pointer;
            line-height: 1;
            background: none;
            border: none;
            padding: 0;
        }

        .status-message .close-status:hover {
            color: var(--color-primary);
        }

        @keyframes slideIn {
            from {
                transform: translateX(400px);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }

        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 3000;
        }

        .loading-overlay.show {
            display: flex;
        }

        .loading-content {
            background: var(--color-white);
            padding: 30px 40px;
            border-radius: 5px;
            text-align: center;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
        }

        .loading-spinner {
            border: 4px solid #f3f3f3;
            border-top: 4px solid var(--color-action);
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 0 auto 15px auto;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .loading-text {
            color: var(--color-primary);
            font-size: 16px;
            font-weight: 500;
        }

        input[type="file"] {
            display: none;
        }

        .file-input-label {
            display: inline-block;
            padding: 9px 18px;
            background: var(--color-primary-light);
            color: var(--color-white);
            border-radius: var(--radius-sm);
            cursor: pointer;
            font-weight: 500;
            transition: var(--transition-fast);
            font-size: 14px;
        }

        .file-input-label:hover {
            background: var(--color-primary);
        }

        input:disabled,
        textarea:disabled,
        select:disabled {
            opacity: 0.6;
            background: #F5F5F5;
            cursor: not-allowed;
        }

        /* Details Table */
        .details-table-wrapper {
            overflow-x: auto;
            margin-top: 15px;
            border: 1px solid var(--color-border);
            border-radius: var(--radius-sm);
            max-width: 100%;
        }

        .details-table {
            border-collapse: collapse;
            font-size: 0.85em;
        }

        .details-table th {
            background-color: var(--color-primary-light);
            color: var(--color-white);
            padding: 6px 8px;
            text-align: left;
            border: 1px solid var(--color-primary);
            font-weight: 500;
            font-size: 0.85em;
        }

        .details-table td {
            padding: 4px;
            border: 1px solid var(--color-border);
        }

        .details-table tbody tr:nth-child(even) {
            background-color: var(--color-alt-bg);
        }

        .details-table input,
        .details-table select {
            padding: 6px 8px;
            border: 1px solid var(--color-border-input);
            border-radius: var(--radius-sm);
            font-size: 1em;
            box-sizing: border-box;
        }

        .details-table input[type="number"],
        .details-table input[type="text"] {
            text-align: right;
            width: 90px;
        }

        .details-table input[type="date"] {
            text-align: left;
            width: 130px;
        }

        .details-table select {
            text-align: left;
            width: 115px;
        }

        .details-table input[type="checkbox"] {
            width: auto;
        }

        /* Cash Flows Table Column Widths */
        #cashFlowsTable {
            width: 100%;
        }

        #cashFlowsTable th:nth-child(1),
        #cashFlowsTable td:nth-child(1) {
            width: 20%;
        }

        #cashFlowsTable th:nth-child(2),
        #cashFlowsTable td:nth-child(2) {
            width: 20%;
        }

        #cashFlowsTable th:nth-child(3),
        #cashFlowsTable td:nth-child(3) {
            width: 25%;
        }

        #cashFlowsTable th:nth-child(4),
        #cashFlowsTable td:nth-child(4) {
            width: 25%;
            text-align: center;
        }

        #cashFlowsTable th:nth-child(5),
        #cashFlowsTable td:nth-child(5) {
            width: 10%;
            text-align: center;
        }

        /* NAV Table Column Widths */
        #navTable {
            width: 100%;
        }

        #navTable th:nth-child(1),
        #navTable td:nth-child(1) {
            width: 40%;
        }

        #navTable th:nth-child(2),
        #navTable td:nth-child(2) {
            width: 45%;
        }

        #navTable th:nth-child(3),
        #navTable td:nth-child(3) {
            width: 15%;
            text-align: center;
        }

        .delete-row-btn {
            background: none;
            border: none;
            color: var(--color-danger);
            font-size: 18px;
            padding: 4px 8px;
            cursor: pointer;
            transition: var(--transition-fast);
        }

        .delete-row-btn:hover {
            color: var(--color-danger-hover);
        }

        .validation-error-row {
            background-color: #ffebee !important;
            border-left: 3px solid var(--color-danger);
        }

        .validation-error-row input {
            border-color: var(--color-danger) !important;
        }

        #manageFundNamesModal .fund-name-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px;
            margin-bottom: 8px;
            background: var(--color-alt-bg);
            border: 1px solid var(--color-border);
            border-radius: var(--radius-sm);
            gap: 10px;
        }

        #manageFundNamesModal .fund-name-item .btn-sm {
            margin-left: 5px;
        }

        /* Manage Groups Modal */
        .group-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 8px 10px;
            margin-bottom: 4px;
            background: var(--color-alt-bg);
            border: 1px solid var(--color-border);
            border-radius: var(--radius-sm);
        }

        .group-item.level-0 {
            margin-left: 0;
            font-weight: 600;
        }

        .group-item.level-1 {
            margin-left: 20px;
            font-weight: 500;
        }

        .group-item.level-2 {
            margin-left: 40px;
        }

        .group-item.level-3 {
            margin-left: 60px;
        }

        .group-item-info {
            flex: 1;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .group-item-type {
            font-size: 0.85em;
            color: var(--color-secondary-hover);
            font-style: italic;
        }

        .group-item-actions {
            display: flex;
            gap: 5px;
        }

        @media (max-width: 1400px) {
            .controls-bar {
                flex-direction: column;
                align-items: stretch;
            }

            .control-group {
                width: 100%;
            }
        }

        /* Mobile responsive improvements */
        @media (max-width: 768px) {
            body {
                padding: var(--spacing-sm);
            }

            header {
                padding: 16px var(--spacing-md);
            }

            header h1 {
                font-size: 1.4em;
            }

            .controls-bar {
                padding: var(--spacing-md);
                gap: 12px;
            }

            .content {
                padding: var(--spacing-md);
            }

            /* Make table scrollable horizontally on mobile */
            .table-container {
                overflow-x: auto;
                -webkit-overflow-scrolling: touch;
            }

            /* Adjust modal for mobile */
            .modal-content {
                padding: 20px;
                margin: 20px;
                max-width: calc(100% - 40px);
            }

            /* Stack form actions vertically on mobile */
            .form-actions {
                flex-direction: column;
            }

            .form-actions button {
                width: 100%;
            }

            /* Adjust sidebar for mobile */
            .sidebar {
                width: 280px;
                right: -280px;
            }

            /* Smaller buttons on mobile */
            .btn-icon {
                font-size: 18px !important;
                padding: 6px;
            }

            /* Adjust table font sizes for mobile */
            th, td {
                font-size: 0.85em;
                padding: 8px 6px;
            }
        }

        /* Very small screens */
        @media (max-width: 480px) {
            header h1 {
                font-size: 1.2em;
            }

            header p {
                font-size: 0.85em;
            }

            .controls-bar {
                gap: 8px;
            }

            .modal-content {
                padding: 15px;
            }

            .modal-content h2 {
                font-size: 1.2em;
            }

            th, td {
                font-size: 0.8em;
                padding: 6px 4px;
            }

            /* Only enforce min-width on extremely narrow screens */
            .table-container table {
                min-width: 800px;
            }
        }

        /* Print Styles for PDF Export */
        @media print {
            body {
                background: var(--color-white);
                padding: 0;
            }

            .container {
                box-shadow: none;
                border-radius: 0;
            }

            .controls-bar,
            .btn-sm,
            button {
                display: none !important;
            }

            header {
                background: var(--color-white);
                color: var(--color-primary);
                border-bottom: 2px solid var(--color-primary);
                padding: 15px;
            }

            .content {
                padding: 10px;
            }

            table {
                width: 100%;
                max-width: 100%;
                page-break-inside: auto;
                border: 1px solid var(--color-primary);
                table-layout: fixed;
            }

            /* Override min-width for main table in print view */
            .table-container table {
                min-width: 100% !important;
                max-width: 100% !important;
            }

            thead {
                background: var(--color-primary) !important;
                -webkit-print-color-adjust: exact;
                print-color-adjust: exact;
            }

            tr {
                page-break-inside: avoid;
                page-break-after: auto;
            }

            th, td {
                padding: 8px 6px;
                font-size: 10px;
            }

            /* Reset inline styles and set specific widths for print to fit landscape page */
            #fundsTable th,
            #fundsTable td {
                min-width: auto !important;
                max-width: none !important;
            }

            /* Fund Name - allow it to be wider */
            #fundsTable th:nth-child(1),
            #fundsTable td:nth-child(1) {
                width: 130px !important;
            }

            /* Investor - limit width to fit page */
            #fundsTable th:nth-child(2),
            #fundsTable td:nth-child(2) {
                width: 90px !important;
                max-width: 90px !important;
                overflow: hidden;
                text-overflow: ellipsis;
            }

            /* Vintage */
            #fundsTable th:nth-child(3),
            #fundsTable td:nth-child(3) {
                width: 45px !important;
            }

            /* Numeric columns - compact width */
            #fundsTable th:nth-child(4),
            #fundsTable td:nth-child(4),
            #fundsTable th:nth-child(5),
            #fundsTable td:nth-child(5),
            #fundsTable th:nth-child(6),
            #fundsTable td:nth-child(6),
            #fundsTable th:nth-child(7),
            #fundsTable td:nth-child(7),
            #fundsTable th:nth-child(8),
            #fundsTable td:nth-child(8),
            #fundsTable th:nth-child(11),
            #fundsTable td:nth-child(11) {
                width: 70px !important;
            }

            /* MOIC and IRR - narrower */
            #fundsTable th:nth-child(9),
            #fundsTable td:nth-child(9),
            #fundsTable th:nth-child(10),
            #fundsTable td:nth-child(10) {
                width: 50px !important;
            }

            /* Hide Actions column in print view */
            thead tr th:last-child,
            tbody tr td:last-child {
                display: none;
            }

            tbody tr:last-child {
                border-top: 2px solid var(--color-primary);
                border-bottom: 2px solid var(--color-primary);
                background: #F0F0F0 !important;
                -webkit-print-color-adjust: exact;
                print-color-adjust: exact;
            }

            .positive {
                color: var(--color-success) !important;
                -webkit-print-color-adjust: exact;
                print-color-adjust: exact;
            }

            .negative {
                color: var(--color-danger) !important;
                -webkit-print-color-adjust: exact;
                print-color-adjust: exact;
            }

            @page {
                size: landscape;
                margin: 0.5in;
            }
        }

        /* Sidebar Styles */
        .sidebar-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            z-index: 9998;
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.3s ease, visibility 0.3s ease;
        }

        .sidebar-overlay.show {
            opacity: 1;
            visibility: visible;
        }

        .sidebar {
            position: fixed;
            top: 0;
            right: -320px;
            width: 320px;
            height: 100%;
            background: var(--color-white);
            box-shadow: -2px 0 8px rgba(0, 0, 0, 0.15);
            z-index: 9999;
            transition: right 0.3s ease;
            display: flex;
            flex-direction: column;
        }

        .sidebar.show {
            right: 0;
        }

        .sidebar-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 20px;
            border-bottom: 1px solid var(--color-border);
            background: var(--color-hover-bg);
        }

        .sidebar-header h3 {
            margin: 0;
            color: var(--color-primary);
            font-size: 18px;
            font-weight: 600;
        }

        .sidebar-close {
            background: none;
            border: none;
            font-size: 28px;
            color: var(--color-secondary-hover);
            cursor: pointer;
            padding: 0;
            width: 30px;
            height: 30px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: var(--radius-sm);
            transition: var(--transition-medium);
        }

        .sidebar-close:hover {
            background: var(--color-border);
            color: var(--color-primary);
        }

        .sidebar-content {
            flex: 1;
            overflow-y: auto;
            padding: 10px 0;
        }

        .sidebar-section {
            margin-bottom: 10px;
        }

        .sidebar-section-title {
            padding: 12px 20px 8px;
            margin: 0;
            font-size: 12px;
            font-weight: 600;
            color: var(--color-secondary-hover);
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .sidebar-item {
            padding: 0;
        }

        .sidebar-item a,
        .sidebar-import-label {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 12px 20px;
            color: var(--color-primary);
            text-decoration: none;
            transition: var(--transition-medium);
            cursor: pointer;
            font-size: 14px;
        }

        .sidebar-item a:hover,
        .sidebar-import-label:hover {
            background: var(--color-hover-bg);
        }

        .sidebar-checkbox-label {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 12px 20px;
            cursor: pointer;
            transition: var(--transition-medium);
            font-size: 14px;
        }

        .sidebar-checkbox-label:hover {
            background: var(--color-hover-bg);
        }

        .sidebar-checkbox-label input[type="checkbox"] {
            width: 18px;
            height: 18px;
            cursor: pointer;
            margin: 0;
        }

        .sidebar-checkbox-label span {
            color: var(--color-primary);
            flex: 1;
        }

        /* Adjust body when sidebar is open to prevent scroll issues */
        body.sidebar-open {
            overflow: hidden;
        }
    </style>
</head>
<body>
    <!-- Loading Overlay -->
    <div id="loadingOverlay" class="loading-overlay">
        <div class="loading-content">
            <div class="loading-spinner"></div>
            <div class="loading-text" id="loadingText">Loading...</div>
        </div>
    </div>

    <div class="container">
        <header>
            <h1 id="headerTitle">PE Fund Manager</h1>
            <p id="headerSubtitle">Private Equity Fund Analytics & Management Tool</p>
        </header>

        <div class="controls-bar">
            <div class="control-group">
                <label for="groupFilter">Filter by Group</label>
                <select id="groupFilter">
                    <option value="">All Groups</option>
                </select>
            </div>
            <div class="control-group">
                <label for="fundFilter">Filter by Fund</label>
                <select id="fundFilter">
                    <option value="">All Funds</option>
                </select>
            </div>
            <div class="control-group">
                <label for="accountFilter">Filter by Account</label>
                <select id="accountFilter">
                    <option value="">All Accounts</option>
                </select>
            </div>
            <div class="control-group">
                <label for="searchInput">Search</label>
                <input type="text" id="searchInput" placeholder="Search funds..." title="Search by fund name or account number" aria-label="Search funds by name or account number">
            </div>
            <div class="control-group">
                <label for="vintageFilter">Filter by Vintage</label>
                <select id="vintageFilter">
                    <option value="">All Vintages</option>
                </select>
            </div>
            <div class="control-group">
                <label for="cutoffDate" title="Calculate all metrics (IRR, MOIC, NAV, etc.) as of this date">Cutoff Date</label>
                <input type="date" id="cutoffDate" title="Calculate all metrics (IRR, MOIC, NAV, etc.) as of this date" aria-label="Cutoff date for calculating metrics">
            </div>
            <div class="control-group">
                <button class="btn-icon" id="resetFiltersBtn" title="Reset Filters" style="font-size: 20px; margin-top: auto;">↻</button>
                <span id="activeFiltersIndicator" style="display: none; margin-left: 5px; color: var(--color-action); font-size: 12px; font-weight: 600;">●</span>
            </div>
            <div style="margin-left: auto; display: flex; gap: 10px; align-items: center;">
                <button class="btn-icon" id="undoBtn" title="Undo last action" style="font-size: 20px;" disabled>↶</button>
                <button class="btn-icon" id="redoBtn" title="Redo last undone action" style="font-size: 20px;" disabled>↷</button>
                <button class="btn-icon" id="toggleSidebarBtn" title="Settings and Actions" style="font-size: 20px;">☰</button>
            </div>
        </div>

        <div class="content">
            <!-- Portfolio Summary Stats -->
            <div id="portfolioSummary" class="portfolio-summary">
                <div class="summary-stat">
                    <span class="summary-label">Funds</span>
                    <span class="summary-value" id="summaryFundCount">0</span>
                </div>
                <div class="summary-stat">
                    <span class="summary-label">Total Commitment</span>
                    <span class="summary-value" id="summaryCommitment">$0</span>
                </div>
                <div class="summary-stat">
                    <span class="summary-label">Total NAV</span>
                    <span class="summary-value" id="summaryNav">$0</span>
                </div>
                <div class="summary-stat">
                    <span class="summary-label">Avg IRR</span>
                    <span class="summary-value" id="summaryIRR">N/A</span>
                </div>
                <div class="summary-stat">
                    <span class="summary-label">Avg MOIC</span>
                    <span class="summary-value" id="summaryMOIC">N/A</span>
                </div>
                <div class="summary-stat">
                    <span class="summary-label">DPI</span>
                    <span class="summary-value" id="summaryDPI">N/A</span>
                </div>
                <div class="summary-stat">
                    <span class="summary-label">TVPI</span>
                    <span class="summary-value" id="summaryTVPI">N/A</span>
                </div>
            </div>

            <div class="table-container">
                <table id="fundsTable">
                    <thead>
                        <tr>
                            <th data-sort="fundName">Fund Name</th>
                            <th data-sort="accountNumber" class="center">Investor</th>
                            <th data-sort="vintage" class="center">Vintage</th>
                            <th data-sort="commitment" class="center number">Commitment</th>
                            <th data-sort="totalContributions" class="center number">Contributions</th>
                            <th data-sort="totalDistributions" class="center number">Distributions</th>
                            <th data-sort="nav" class="center number">Value (NAV)</th>
                            <th data-sort="investmentReturn" class="center number wrap-header">Investment<br>Return</th>
                            <th data-sort="moic" class="center number">MOIC</th>
                            <th data-sort="irr" class="center number">IRR</th>
                            <th data-sort="outstandingCommitment" class="center number wrap-header">Outstanding<br>Commitment</th>
                            <th class="center"></th>
                        </tr>
                    </thead>
                    <tbody id="fundsTableBody">
                        <!-- Data will be populated here -->
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- Fund Add/Edit Modal -->
    <div id="fundModal" class="modal">
        <div class="modal-content">
            <span class="close" id="closeFundModalBtn">&times;</span>
            <h2 id="fundModalTitle">Add New Investment</h2>
            <form id="fundForm">
                <input type="hidden" id="fundId">
                <input type="hidden" id="isDuplicate">

                <div class="form-group">
                    <label for="fundName">Fund Name *</label>
                    <select id="fundName" required></select>
                </div>

                <div class="form-group">
                    <label for="accountNumber">Account Number *</label>
                    <input type="text" id="accountNumber" required>
                </div>

                <div class="form-group">
                    <label for="fundGroup">Group (optional)</label>
                    <select id="fundGroup">
                        <option value="">No Group</option>
                    </select>
                </div>

                <div class="form-group">
                    <label for="commitment">Commitment (USD) *</label>
                    <input type="text" id="commitment" required placeholder="e.g., 1,000,000">
                </div>

                <div id="duplicateMultiplierContainer" class="form-group" style="display: none;">
                    <label for="duplicateMultiplier">Duplicate Multiplier</label>
                    <input type="number" id="duplicateMultiplier" step="any" value="1">
                </div>

                <div class="form-group">
                    <label for="cashFlows">Cash Flows (JSON)</label>
                    <textarea id="cashFlows" placeholder='[{"date":"2024-01-15","amount":-1000000,"type":"Contribution","affectsCommitment":true}]'></textarea>
                    <div class="hint">Format: [{"date":"YYYY-MM-DD","amount":number,"type":"Contribution|Distribution","affectsCommitment":true}]</div>
                </div>

                <div class="form-group">
                    <label for="monthlyNav">Monthly NAV (JSON)</label>
                    <textarea id="monthlyNav" placeholder='[{"date":"2024-01-31","amount":950000}]'></textarea>
                    <div class="hint">Format: [{"date":"YYYY-MM-DD","amount":number}]</div>
                </div>

                <div class="form-actions">
                    <button type="submit" class="btn-primary">Save</button>
                    <button type="button" class="btn-secondary" id="cancelFundModalBtn">Cancel</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Action Dropdown -->
    <div id="actionDropdown" class="action-dropdown">
        <a href="#" id="actionEdit">Edit</a>
        <a href="#" id="actionDuplicate">Duplicate</a>
        <a href="#" id="actionViewDetails">View Details</a>
        <a href="#" id="actionDelete" class="danger-action">Delete</a>
    </div>

    <!-- Manage Fund Names Modal -->
    <div id="manageFundNamesModal" class="modal">
        <div class="modal-content">
            <span class="close" id="closeManageFundsModalBtn">&times;</span>
            <h2>Manage Fund Names</h2>

            <div class="form-group">
                <label for="newFundNameInput">Add New Fund Name</label>
                <div style="display: flex; gap: 10px;">
                    <input type="text" id="newFundNameInput" style="flex: 1;" placeholder="Enter fund name">
                    <button class="btn-primary" id="addNewFundNameBtn">Add</button>
                </div>
            </div>

            <hr style="margin: 20px 0; border: none; border-top: 1px solid #E0E0E0;">

            <h3 style="margin-bottom: 15px; color: #2C3E50; font-weight: 600; font-size: 1.1em;">Existing Fund Names</h3>
            <div id="fundNamesList"></div>

            <div class="form-actions">
                <button class="btn-secondary" id="closeManageFundsModal2Btn">Close</button>
            </div>
        </div>
    </div>

    <!-- Edit Fund Name Modal -->
    <div id="editFundNameModal" class="modal">
        <div class="modal-content">
            <span class="close" id="closeEditFundNameModalBtn">&times;</span>
            <h2>Edit Fund</h2>

            <input type="hidden" id="editFundNameOriginal" value="">

            <div class="form-group">
                <label for="editFundNameInput">Fund Name</label>
                <input type="text" id="editFundNameInput" placeholder="Enter fund name">
            </div>

            <div class="form-group">
                <label for="editFundTags">Tags (optional)</label>
                <div id="editFundTagsContainer" class="tags-container"></div>
                <input type="text" id="editFundTagsInput" placeholder="Add tag (e.g., Venture Capital, Growth Equity)" list="editFundTagsDatalist">
                <datalist id="editFundTagsDatalist"></datalist>
                <div class="hint">Press Enter to add tags. Click × on a tag to remove it.</div>
            </div>

            <div class="form-actions">
                <button class="btn-primary" id="saveEditedFundNameBtn">Save Changes</button>
                <button class="btn-secondary" id="cancelEditFundNameBtn">Cancel</button>
            </div>
        </div>
    </div>

    <!-- Manage Groups Modal -->
    <div id="manageGroupsModal" class="modal">
        <div class="modal-content" style="max-width: 600px;">
            <span class="close" id="closeManageGroupsModal2Btn">&times;</span>
            <h2>Manage Account Groups</h2>

            <input type="hidden" id="editGroupId" value="">
            <h3 id="groupFormTitle" style="margin-bottom: 15px; color: #2C3E50; font-weight: 600; font-size: 1.1em;">Add New Group</h3>

            <div class="form-group">
                <label for="newGroupName">Group Name</label>
                <input type="text" id="newGroupName" placeholder="e.g., John Smith, Smith Family Trust">
                <small style="color: #7f8c8d; font-size: 0.85em; margin-top: 4px; display: block;">Use groups to organize by account holder or entity (e.g., individuals, trusts, IRAs)</small>
            </div>

            <div class="form-group">
                <label for="newGroupParent">Parent Group (optional)</label>
                <select id="newGroupParent">
                    <option value="">None (Top Level)</option>
                </select>
            </div>

            <div class="form-group">
                <label for="newGroupType">Type (optional)</label>
                <input type="text" id="newGroupType" placeholder="e.g., Client, Trust, Account">
            </div>

            <div style="display: flex; gap: 10px;">
                <button id="saveGroupBtn" class="btn-primary">Add Group</button>
                <button id="cancelEditBtn" class="btn-secondary" style="display: none;">Cancel</button>
            </div>

            <hr style="margin: 20px 0; border: none; border-top: 1px solid #E0E0E0;">

            <h3 style="margin-bottom: 15px; color: #2C3E50; font-weight: 600; font-size: 1.1em;">Existing Groups</h3>
            <div id="groupsList" style="max-height: 400px; overflow-y: auto;"></div>

            <div class="form-actions">
                <button class="btn-secondary" id="closeManageGroupsModalBtn">Close</button>
            </div>
        </div>
    </div>

    <!-- Details Modal -->
    <div id="detailsModal" class="modal">
        <div class="modal-content" style="max-width: 900px;">
            <span class="close" id="closeDetailsModalBtn">&times;</span>
            <h2 id="detailsModalTitle">Fund Details</h2>
            <p id="detailsModalSubtitle" style="margin: 5px 0 0 0; color: #95A5A6; font-size: 0.9em;"></p>

            <h3 style="margin-top: 20px; color: #2C3E50; font-weight: 600; font-size: 1.1em;">Cash Flows</h3>
            <div class="details-table-wrapper">
                <table class="details-table" id="cashFlowsTable">
                    <thead>
                        <tr>
                            <th>Date</th>
                            <th class="number">Amount (USD)</th>
                            <th class="center">Type</th>
                            <th class="center">Affects Commitment?</th>
                            <th></th>
                        </tr>
                    </thead>
                    <tbody></tbody>
                </table>
            </div>
            <button type="button" class="btn-primary btn-sm" style="margin-top: 10px;" id="addCashFlowRowBtn">Add Cash Flow</button>

            <h3 style="margin-top: 30px; color: #2C3E50; font-weight: 600; font-size: 1.1em;">Monthly NAV</h3>
            <div class="details-table-wrapper">
                <table class="details-table" id="navTable">
                    <thead>
                        <tr>
                            <th>Date</th>
                            <th>Amount (USD)</th>
                            <th></th>
                        </tr>
                    </thead>
                    <tbody></tbody>
                </table>
            </div>
            <button type="button" class="btn-primary btn-sm" style="margin-top: 10px;" id="addNavRowBtn">Add NAV</button>

            <div class="form-actions">
                <button class="btn-primary" id="saveDetailsChangesBtn">Save Changes</button>
                <button class="btn-secondary" id="cancelDetailsModalBtn">Cancel</button>
            </div>
        </div>
    </div>

    <!-- Backup Warning Modal -->
    <div id="backupWarningModal" class="modal">
        <div class="modal-content" style="max-width: 500px;">
            <span class="close" id="closeBackupWarningBtn">&times;</span>
            <h2 style="color: #E67E22; margin-bottom: 15px;">⚠️ Important: Backup Your Data</h2>
            <p style="line-height: 1.6; margin-bottom: 15px;">
                Your PE Fund Manager data is stored <strong>locally in your browser</strong>.
                This means your data could be lost if:
            </p>
            <ul style="margin: 15px 0 15px 25px; line-height: 1.8;">
                <li>You clear your browser cache or cookies</li>
                <li>You uninstall your browser</li>
                <li>Your computer crashes or is reset</li>
                <li>You switch to a different device</li>
            </ul>
            <p style="line-height: 1.6; margin-bottom: 20px; font-weight: 600; color: #E74C3C;">
                Please export your data regularly to avoid data loss!
            </p>
            <div class="form-group">
                <label>
                    <input type="checkbox" id="dontShowBackupWarning" style="margin-right: 8px;">
                    Don't show this warning again (you'll see a reminder every 30 days)
                </label>
            </div>
            <div class="form-actions">
                <button class="btn-success" id="exportNowBtn">Export Now</button>
                <button class="btn-secondary" id="remindLaterBtn">Remind Me Later</button>
            </div>
        </div>
    </div>

    <!-- Keyboard Shortcuts Help Modal -->
    <div id="shortcutsModal" class="modal shortcuts-modal">
        <div class="modal-content">
            <span class="close" id="closeShortcutsModalBtn">&times;</span>
            <h2>Keyboard Shortcuts</h2>
            <div class="shortcuts-list">
                <div class="shortcut-key"><kbd>?</kbd></div>
                <div class="shortcut-desc">Show this help</div>

                <div class="shortcut-key"><kbd>Ctrl</kbd> + <kbd>F</kbd></div>
                <div class="shortcut-desc">Focus search input</div>

                <div class="shortcut-key"><kbd>Ctrl</kbd> + <kbd>N</kbd></div>
                <div class="shortcut-desc">Add new investment</div>

                <div class="shortcut-key"><kbd>Ctrl</kbd> + <kbd>E</kbd></div>
                <div class="shortcut-desc">Export to JSON</div>

                <div class="shortcut-key"><kbd>Ctrl</kbd> + <kbd>Z</kbd></div>
                <div class="shortcut-desc">Undo last action</div>

                <div class="shortcut-key"><kbd>Ctrl</kbd> + <kbd>Shift</kbd> + <kbd>Z</kbd></div>
                <div class="shortcut-desc">Redo last action</div>

                <div class="shortcut-key"><kbd>Ctrl</kbd> + <kbd>S</kbd></div>
                <div class="shortcut-desc">Save (in details modal)</div>

                <div class="shortcut-key"><kbd>Esc</kbd></div>
                <div class="shortcut-desc">Close modal/sidebar</div>
            </div>
            <p style="margin-top: 20px; font-size: 12px; color: var(--color-text-light);">
                On Mac, use <kbd style="display: inline-block; padding: 2px 6px; font-family: monospace; font-size: 11px; background: var(--color-alt-bg); border: 1px solid var(--color-border); border-radius: 3px;">⌘</kbd> instead of <kbd style="display: inline-block; padding: 2px 6px; font-family: monospace; font-size: 11px; background: var(--color-alt-bg); border: 1px solid var(--color-border); border-radius: 3px;">Ctrl</kbd>
            </p>
            <div class="form-actions">
                <button class="btn-secondary" id="closeShortcutsModal2Btn">Close</button>
            </div>
        </div>
    </div>

    <!-- Sidebar Panel -->
    <div id="sidebarOverlay" class="sidebar-overlay"></div>
    <div id="sidebar" class="sidebar">
        <div class="sidebar-header">
            <h3>Settings & Actions</h3>
            <button class="sidebar-close" id="closeSidebarBtn" title="Close">&times;</button>
        </div>
        <div class="sidebar-content">
            <!-- View Options Section -->
            <div class="sidebar-section">
                <h4 class="sidebar-section-title">View Options</h4>
                <div class="sidebar-item">
                    <label class="sidebar-checkbox-label">
                        <input type="checkbox" id="sidebarShowTagsCheckbox" checked>
                        <span>Show Tags</span>
                    </label>
                </div>
                <div class="sidebar-item">
                    <label class="sidebar-checkbox-label">
                        <input type="checkbox" id="sidebarDarkModeCheckbox">
                        <span>Dark Mode</span>
                    </label>
                </div>
            </div>

            <!-- Manage Section -->
            <div class="sidebar-section">
                <h4 class="sidebar-section-title">Manage</h4>
                <div class="sidebar-item">
                    <a href="#" id="sidebarNewInvestment">
                        New Investment
                    </a>
                </div>
                <div class="sidebar-item">
                    <a href="#" id="sidebarManageFunds">
                        Manage Funds
                    </a>
                </div>
                <div class="sidebar-item">
                    <a href="#" id="sidebarManageGroups">
                        Manage Groups
                    </a>
                </div>
            </div>

            <!-- Data Section -->
            <div class="sidebar-section">
                <h4 class="sidebar-section-title">Data</h4>
                <div class="sidebar-item">
                    <a href="#" id="sidebarExportCSV">
                        Export to CSV
                    </a>
                </div>
                <div class="sidebar-item">
                    <a href="#" id="sidebarExportJSON">
                        Export to JSON
                    </a>
                </div>
                <div class="sidebar-item">
                    <a href="#" id="sidebarExportPDF">
                        Export to PDF
                    </a>
                </div>
                <div class="sidebar-item">
                    <label for="sidebarImportFile" class="sidebar-import-label">
                        Import JSON
                    </label>
                    <input type="file" id="sidebarImportFile" accept=".json" style="display: none;">
                </div>
            </div>
        </div>
    </div>

    <script>
        /**
         * PE Fund Manager - Private Equity Fund Analytics & Management Tool
         *
         * A comprehensive single-file application for managing private equity fund investments.
         * All data is stored locally in IndexedDB with no external dependencies.
         *
         * Key Features:
         * - Fund portfolio management with cash flows and NAV tracking
         * - IRR and MOIC calculations using Newton-Raphson method
         * - Hierarchical account grouping with cycle detection
         * - Undo/redo functionality with persistent history
         * - CSV/JSON import/export with formula injection protection
         * - Mobile-responsive design with accessibility features
         * - Performance optimizations: metrics caching, debouncing, race condition handling
         * - Input validation and sanitization for security
         * - Automatic backup reminders with local storage tracking
         *
         * Architecture:
         * - State Management: Centralized AppState object with caching
         * - Database: IndexedDB with 4 stores (funds, fundNames, groups, undoHistory)
         * - UI: Event-driven with delegation patterns and keyboard shortcuts
         * - Performance: Debounced filters, cached metrics, abort controllers for cancellation
         *
         * @version 2.0.0
         * @author PE Fund Manager Team
         * @license MIT
         */
        (function() {
            'use strict';

            // ===========================
            // Configuration & Constants
            // ===========================

        /**
         * Application configuration constants
         * @const {Object}
         */
        const CONFIG = {
            // Database
            DB_NAME: 'FundsDB',
            FUNDS_STORE: 'funds',
            FUNDNAMES_STORE: 'fundNames',
            GROUPS_STORE: 'groups',
            UNDO_STORE: 'undoHistory',
            DB_VERSION: 7,

            // Currency formatting
            CURRENCY_FORMAT: 'en-US',
            CURRENCY_CODE: 'USD',
            CURRENCY_MIN: -1e12,
            CURRENCY_MAX: 1e12,

            // IRR calculation
            IRR_MAX_ITERATIONS: 1000,
            IRR_PRECISION: 1e-6,
            IRR_GUESS: 0.1,
            IRR_MIN_RATE: -0.99,
            IRR_MAX_RATE: 10.0,

            // Date format validation
            DATE_FORMAT: /^\d{4}-\d{2}-\d{2}$/,

            // Debounce delays (ms)
            DEBOUNCE_FILTER: 300,
            DEBOUNCE_SEARCH: 300,
            DEBOUNCE_INPUT: 300,

            // UI constraints
            MIN_COLUMN_WIDTH: 50,
            MAX_FILE_SIZE: 50 * 1024 * 1024, // 50MB
            DUPLICATE_MULTIPLIER_MAX: 1000,
            DUPLICATE_MULTIPLIER_MIN: 0.001,
            FUND_NAME_MIN_LENGTH: 2,
            FUND_NAME_MAX_LENGTH: 100,

            // Performance
            METRICS_CACHE_TTL: 5000, // 5 seconds
            PAGINATION_SIZE: 50,
            VIRTUAL_SCROLL_BUFFER: 10,

            // Validation
            ALLOWED_FUND_NAME_PATTERN: /^[a-zA-Z0-9\s\-_.,&()]+$/,
            MAX_IMPORT_FUNDS: 10000,
            MAX_JSON_DEPTH: 10,

            // LocalStorage keys
            STORAGE_COLUMN_WIDTHS: 'columnWidths',
            STORAGE_SHOW_TAGS: 'showTags',
            STORAGE_BACKUP_WARNING: 'backupWarningShown',
            STORAGE_LAST_BACKUP: 'lastBackupDate',

            // Undo
            MAX_UNDO_HISTORY: 50,
            UNDO_RETENTION_DAYS: 7
        };

        // ===========================
        // Utility Functions
        // ===========================

        /**
         * Debounce function to limit rate of function calls
         * @param {Function} func - Function to debounce
         * @param {number} wait - Wait time in milliseconds
         * @returns {Function} Debounced function
         */
        function debounce(func, wait) {
            let timeout;
            return function executedFunction(...args) {
                const later = () => {
                    clearTimeout(timeout);
                    func(...args);
                };
                clearTimeout(timeout);
                timeout = setTimeout(later, wait);
            };
        }

        /**
         * Safe localStorage operations with error handling
         * @namespace Storage
         */
        const Storage = {
            /**
             * Get item from localStorage with error handling
             * @param {string} key - Storage key
             * @param {*} defaultValue - Default value if not found
             * @returns {*} Parsed value or default
             */
            get(key, defaultValue = null) {
                try {
                    const item = localStorage.getItem(key);
                    return item ? JSON.parse(item) : defaultValue;
                } catch (error) {
                    console.error(`Error reading from localStorage: ${key}`, error);
                    return defaultValue;
                }
            },

            /**
             * Set item in localStorage with error handling
             * @param {string} key - Storage key
             * @param {*} value - Value to store
             * @returns {boolean} Success status
             */
            set(key, value) {
                try {
                    localStorage.setItem(key, JSON.stringify(value));
                    return true;
                } catch (error) {
                    console.error(`Error writing to localStorage: ${key}`, error);
                    if (error.name === 'QuotaExceededError') {
                        console.warn('localStorage quota exceeded');
                    }
                    return false;
                }
            },

            /**
             * Remove item from localStorage with error handling
             * @param {string} key - Storage key
             * @returns {boolean} Success status
             */
            remove(key) {
                try {
                    localStorage.removeItem(key);
                    return true;
                } catch (error) {
                    console.error(`Error removing from localStorage: ${key}`, error);
                    return false;
                }
            }
        };

        // ===========================
        // IndexedDB Operations
        // ===========================

        // Database state (maintained for backward compatibility)
        let db;
        let dbReady = false;
        const DB_NAME = CONFIG.DB_NAME;
        const FUNDS_STORE = CONFIG.FUNDS_STORE;
        const FUNDNAMES_STORE = CONFIG.FUNDNAMES_STORE;
        const GROUPS_STORE = CONFIG.GROUPS_STORE;
        const DB_VERSION = CONFIG.DB_VERSION;

        // Application state - centralized state management
        const AppState = {
            // Data
            currentFunds: [],
            fundNames: new Set(),
            fundNameData: new Map(),
            groups: [],
            groupDescendantsCache: new Map(), // groupId -> array of descendant IDs

            // UI state
            currentGroupDescendants: null,
            sortColumns: [], // Array of {column, direction} for multi-column sorting
            currentActionFundId: null,
            currentDetailsFundId: null,
            hasUnsavedChanges: false,

            // Cache
            metricsCache: new Map(), // fundId -> { metrics, timestamp }
            filterCache: null,

            // Undo/Redo
            undoStack: [],
            redoStack: [],

            // Performance
            abortController: null, // For canceling in-flight requests

            // Getters
            getFunds() { return this.currentFunds; },
            getGroups() { return this.groups; },

            // Cache management
            clearMetricsCache() {
                this.metricsCache.clear();
            },

            getMetricsFromCache(fundId, cutoffDate) {
                const key = `${fundId}-${cutoffDate}`;
                const cached = this.metricsCache.get(key);
                if (cached && (Date.now() - cached.timestamp < CONFIG.METRICS_CACHE_TTL)) {
                    return cached.metrics;
                }
                return null;
            },

            setMetricsCache(fundId, cutoffDate, metrics) {
                const key = `${fundId}-${cutoffDate}`;
                this.metricsCache.set(key, { metrics, timestamp: Date.now() });
            }
        };

        // Legacy compatibility - will be removed gradually
        let currentFunds = [];
        let fundNames = new Set();
        let fundNameData = new Map();
        let groups = [];
        let currentGroupDescendants = null;
        let sortColumns = []; // Array of {column, direction} for multi-column sorting
        let isResizingColumn = false;
        let lastMousedownOnResizer = false;
        let currentActionFundId = null;
        let currentDetailsFundId = null;
        let hasUnsavedChanges = false;

        /**
         * Initialize IndexedDB database
         * @returns {Promise<IDBDatabase>} Resolves with database instance
         */
        function initDB() {
            return new Promise((resolve, reject) => {
                const request = indexedDB.open(DB_NAME, DB_VERSION);

                request.onerror = () => reject(request.error);
                request.onsuccess = () => {
                    db = request.result;
                    dbReady = true;
                    resolve(db);
                };

                request.onupgradeneeded = (event) => {
                    const db = event.target.result;
                    const oldVersion = event.oldVersion;
                    const transaction = event.target.transaction;

                    // Funds store
                    if (!db.objectStoreNames.contains(FUNDS_STORE)) {
                        const fundsStore = db.createObjectStore(FUNDS_STORE, {
                            keyPath: 'id',
                            autoIncrement: true
                        });
                        fundsStore.createIndex('fundName', 'fundName', { unique: false });
                        fundsStore.createIndex('accountNumber', 'accountNumber', { unique: false });
                    }

                    // Fund names store
                    if (!db.objectStoreNames.contains(FUNDNAMES_STORE)) {
                        db.createObjectStore(FUNDNAMES_STORE, { keyPath: 'name' });
                    }

                    // Groups store
                    if (!db.objectStoreNames.contains(GROUPS_STORE)) {
                        const groupsStore = db.createObjectStore(GROUPS_STORE, {
                            keyPath: 'id',
                            autoIncrement: true
                        });
                        groupsStore.createIndex('parentGroupId', 'parentGroupId', { unique: false });
                        groupsStore.createIndex('name', 'name', { unique: false });
                    }

                    // Undo history store
                    if (!db.objectStoreNames.contains(CONFIG.UNDO_STORE)) {
                        const undoStore = db.createObjectStore(CONFIG.UNDO_STORE, {
                            keyPath: 'id',
                            autoIncrement: true
                        });
                        undoStore.createIndex('timestamp', 'timestamp', { unique: false });
                        undoStore.createIndex('type', 'type', { unique: false });
                    }

                    // Migrate from v5 to v6: Move tags from investments to fund names
                    if (oldVersion < 6 && oldVersion >= 5) {
                        // Delete old tags store
                        if (db.objectStoreNames.contains('tags')) {
                            db.deleteObjectStore('tags');
                        }

                        // Get all funds and extract unique fund names with their tags
                        const fundsStore = transaction.objectStore(FUNDS_STORE);
                        const fundNamesStore = transaction.objectStore(FUNDNAMES_STORE);

                        const fundNameTagsMap = new Map(); // fundName -> Set of tags

                        fundsStore.openCursor().onsuccess = function(event) {
                            const cursor = event.target.result;
                            if (cursor) {
                                const fund = cursor.value;
                                if (fund.tags && Array.isArray(fund.tags) && fund.tags.length > 0) {
                                    if (!fundNameTagsMap.has(fund.fundName)) {
                                        fundNameTagsMap.set(fund.fundName, new Set());
                                    }
                                    fund.tags.forEach(tag => fundNameTagsMap.get(fund.fundName).add(tag));
                                }

                                // Remove tags from fund
                                delete fund.tags;
                                cursor.update(fund);

                                cursor.continue();
                            } else {
                                // Cursor finished - now update all fund names with their tags
                                fundNamesStore.getAll().onsuccess = function(event) {
                                    const fundNames = event.target.result;
                                    fundNames.forEach(fundNameObj => {
                                        const name = fundNameObj.name;
                                        const tags = fundNameTagsMap.has(name)
                                            ? Array.from(fundNameTagsMap.get(name))
                                            : [];
                                        fundNamesStore.put({ name, tags });
                                    });
                                };
                            }
                        };
                    }
                };
            });
        }

        function saveFundToDB(fundData) {
            return new Promise((resolve, reject) => {
                if (!db) {
                    reject(new Error('Database not initialized'));
                    return;
                }

                const transaction = db.transaction([FUNDS_STORE], 'readwrite');
                const objectStore = transaction.objectStore(FUNDS_STORE);

                let request;
                if (fundData.id) {
                    request = objectStore.put(fundData);
                } else {
                    delete fundData.id;
                    request = objectStore.add(fundData);
                }

                request.onsuccess = () => resolve(request.result);
                request.onerror = () => reject(request.error);
            });
        }

        function getAllFunds() {
            return new Promise((resolve, reject) => {
                if (!db) {
                    reject(new Error('Database not initialized'));
                    return;
                }

                const transaction = db.transaction([FUNDS_STORE], 'readonly');
                const objectStore = transaction.objectStore(FUNDS_STORE);
                const request = objectStore.getAll();

                request.onsuccess = () => resolve(request.result);
                request.onerror = () => reject(request.error);
            });
        }

        function getFundById(id) {
            return new Promise((resolve, reject) => {
                if (!db) {
                    reject(new Error('Database not initialized'));
                    return;
                }

                const transaction = db.transaction([FUNDS_STORE], 'readonly');
                const objectStore = transaction.objectStore(FUNDS_STORE);
                const request = objectStore.get(id);

                request.onsuccess = () => resolve(request.result);
                request.onerror = () => reject(request.error);
            });
        }

        function deleteFundFromDB(id) {
            return new Promise((resolve, reject) => {
                if (!db) {
                    reject(new Error('Database not initialized'));
                    return;
                }

                const transaction = db.transaction([FUNDS_STORE], 'readwrite');
                const objectStore = transaction.objectStore(FUNDS_STORE);
                const request = objectStore.delete(id);

                request.onsuccess = () => resolve();
                request.onerror = () => reject(request.error);
            });
        }

        // Get all fund name objects (with name and tags)
        function getAllFundNameObjects() {
            return new Promise((resolve, reject) => {
                if (!db) {
                    reject(new Error('Database not initialized'));
                    return;
                }

                const transaction = db.transaction([FUNDNAMES_STORE], 'readonly');
                const objectStore = transaction.objectStore(FUNDNAMES_STORE);
                const request = objectStore.getAll();

                request.onsuccess = () => {
                    // Ensure all objects have tags array
                    const objects = request.result.map(item => ({
                        name: item.name,
                        tags: item.tags || []
                    }));
                    resolve(objects);
                };
                request.onerror = () => reject(request.error);
            });
        }

        // Get just the fund names (for backward compatibility)
        function getAllFundNames() {
            return new Promise((resolve, reject) => {
                getAllFundNameObjects()
                    .then(objects => resolve(objects.map(obj => obj.name)))
                    .catch(reject);
            });
        }

        // Save or update a fund name (pass string for just name, or object with {name, tags})
        function saveFundName(nameOrObject) {
            return new Promise((resolve, reject) => {
                if (!db) {
                    reject(new Error('Database not initialized'));
                    return;
                }

                const fundNameObj = typeof nameOrObject === 'string'
                    ? { name: nameOrObject, tags: [] }
                    : { name: nameOrObject.name, tags: nameOrObject.tags || [] };

                const transaction = db.transaction([FUNDNAMES_STORE], 'readwrite');
                const objectStore = transaction.objectStore(FUNDNAMES_STORE);
                const request = objectStore.put(fundNameObj);

                request.onsuccess = () => resolve();
                request.onerror = () => reject(request.error);
            });
        }

        function deleteFundName(name) {
            return new Promise((resolve, reject) => {
                if (!db) {
                    reject(new Error('Database not initialized'));
                    return;
                }

                const transaction = db.transaction([FUNDNAMES_STORE], 'readwrite');
                const objectStore = transaction.objectStore(FUNDNAMES_STORE);
                const request = objectStore.delete(name);

                request.onsuccess = () => resolve();
                request.onerror = () => reject(request.error);
            });
        }

        // ===========================
        // Groups Database Operations
        // ===========================

        function getAllGroups() {
            return new Promise((resolve, reject) => {
                if (!db) {
                    reject(new Error('Database not initialized'));
                    return;
                }

                const transaction = db.transaction([GROUPS_STORE], 'readonly');
                const objectStore = transaction.objectStore(GROUPS_STORE);
                const request = objectStore.getAll();

                request.onsuccess = () => resolve(request.result);
                request.onerror = () => reject(request.error);
            });
        }

        function saveGroup(groupData) {
            return new Promise((resolve, reject) => {
                if (!db) {
                    reject(new Error('Database not initialized'));
                    return;
                }

                const transaction = db.transaction([GROUPS_STORE], 'readwrite');
                const objectStore = transaction.objectStore(GROUPS_STORE);
                const request = objectStore.put(groupData);

                request.onsuccess = () => resolve(request.result);
                request.onerror = () => reject(request.error);
            });
        }

        function deleteGroup(id) {
            return new Promise((resolve, reject) => {
                if (!db) {
                    reject(new Error('Database not initialized'));
                    return;
                }

                const transaction = db.transaction([GROUPS_STORE], 'readwrite');
                const objectStore = transaction.objectStore(GROUPS_STORE);
                const request = objectStore.delete(id);

                request.onsuccess = () => resolve();
                request.onerror = () => reject(request.error);
            });
        }

        function getGroupsByParent(parentGroupId) {
            return new Promise((resolve, reject) => {
                if (!db) {
                    reject(new Error('Database not initialized'));
                    return;
                }

                const transaction = db.transaction([GROUPS_STORE], 'readonly');
                const objectStore = transaction.objectStore(GROUPS_STORE);
                const index = objectStore.index('parentGroupId');
                const request = index.getAll(parentGroupId);

                request.onsuccess = () => resolve(request.result);
                request.onerror = () => reject(request.error);
            });
        }

        function getGroupById(id) {
            return new Promise((resolve, reject) => {
                if (!db) {
                    reject(new Error('Database not initialized'));
                    return;
                }

                const transaction = db.transaction([GROUPS_STORE], 'readonly');
                const objectStore = transaction.objectStore(GROUPS_STORE);
                const request = objectStore.get(id);

                request.onsuccess = () => resolve(request.result);
                request.onerror = () => reject(request.error);
            });
        }

        /**
         * Get all descendant group IDs recursively with cycle detection
         * @param {number} groupId - Group ID to get descendants for
         * @param {Set} visited - Set of visited group IDs (for cycle detection)
         * @returns {Promise<Array<number>>} Array of descendant group IDs
         */
        async function getAllDescendantGroupIds(groupId, visited = new Set()) {
            // Detect circular reference
            if (visited.has(groupId)) {
                console.warn(`Circular reference detected for group ${groupId}`);
                return [];
            }

            visited.add(groupId);
            const descendants = [groupId];

            try {
                const children = await getGroupsByParent(groupId);

                for (const child of children) {
                    const childDescendants = await getAllDescendantGroupIds(child.id, visited);
                    descendants.push(...childDescendants);
                }
            } catch (err) {
                console.error('Error getting descendants for group', groupId, err);
            }

            return descendants;
        }

        /**
         * Check if setting parentId for groupId would create a circular reference
         * @param {number} groupId - The group being modified
         * @param {number} parentId - The proposed parent group ID
         * @param {Array} allGroups - All groups in the system
         * @returns {boolean} True if circular reference would be created
         */
        function wouldCreateCircularReference(groupId, parentId, allGroups) {
            if (groupId === parentId) return true;
            if (!parentId) return false;

            // Build a map of group relationships
            const childrenMap = new Map();
            allGroups.forEach(g => {
                if (!childrenMap.has(g.parentGroupId)) {
                    childrenMap.set(g.parentGroupId, []);
                }
                childrenMap.get(g.parentGroupId).push(g.id);
            });

            // Check if parentId is a descendant of groupId
            const visited = new Set();
            const stack = [groupId];

            while (stack.length > 0) {
                const current = stack.pop();

                if (visited.has(current)) continue;
                visited.add(current);

                if (current === parentId) return true; // Circular reference detected

                const children = childrenMap.get(current) || [];
                stack.push(...children);
            }

            return false;
        }

        // ===========================
        // Undo/Redo Operations
        // ===========================

        /**
         * Save an action to undo history
         * @param {string} type - Action type (create, update, delete)
         * @param {string} entity - Entity type (fund, group, fundName)
         * @param {Object} before - State before action
         * @param {Object} after - State after action
         */
        async function saveUndoAction(type, entity, before, after) {
            try {
                const undoAction = {
                    type,
                    entity,
                    before,
                    after,
                    timestamp: new Date().toISOString()
                };

                const transaction = db.transaction([CONFIG.UNDO_STORE], 'readwrite');
                const store = transaction.objectStore(CONFIG.UNDO_STORE);
                await store.add(undoAction);

                // Limit undo history
                const allActions = await getUndoHistory();
                if (allActions.length > CONFIG.MAX_UNDO_HISTORY) {
                    const toDelete = allActions.slice(0, allActions.length - CONFIG.MAX_UNDO_HISTORY);
                    for (const action of toDelete) {
                        await store.delete(action.id);
                    }
                }

                // Clear redo stack when new action is performed
                AppState.redoStack = [];

                // Update undo button state
                updateUndoRedoButtons();
            } catch (err) {
                console.error('Error saving undo action:', err);
            }
        }

        /**
         * Get undo history
         */
        function getUndoHistory() {
            return new Promise((resolve, reject) => {
                const transaction = db.transaction([CONFIG.UNDO_STORE], 'readonly');
                const store = transaction.objectStore(CONFIG.UNDO_STORE);
                const request = store.getAll();
                request.onsuccess = () => resolve(request.result);
                request.onerror = () => reject(request.error);
            });
        }

        /**
         * Undo last action
         */
        async function undoLastAction() {
            const history = await getUndoHistory();
            if (history.length === 0) {
                showStatus('Nothing to undo', 'warning');
                return;
            }

            const lastAction = history[history.length - 1];

            try {
                // Restore previous state
                switch (lastAction.entity) {
                    case 'fund':
                        if (lastAction.type === 'delete') {
                            await saveFundToDB(lastAction.before);
                        } else if (lastAction.type === 'create') {
                            await deleteFundFromDB(lastAction.after.id);
                        } else if (lastAction.type === 'update') {
                            await saveFundToDB(lastAction.before);
                        }
                        break;
                    case 'group':
                        if (lastAction.type === 'delete') {
                            await saveGroup(lastAction.before);
                        } else if (lastAction.type === 'create') {
                            await deleteGroup(lastAction.after.id);
                        } else if (lastAction.type === 'update') {
                            await saveGroup(lastAction.before);
                        }
                        break;
                    case 'fundName':
                        if (lastAction.type === 'delete') {
                            await saveFundName(lastAction.before);
                        } else if (lastAction.type === 'create') {
                            await deleteFundName(lastAction.after.name);
                        } else if (lastAction.type === 'update') {
                            await saveFundName(lastAction.before);
                        }
                        break;
                }

                // Move action to redo stack
                AppState.redoStack.push(lastAction);

                // Remove from undo history
                const transaction = db.transaction([CONFIG.UNDO_STORE], 'readwrite');
                await transaction.objectStore(CONFIG.UNDO_STORE).delete(lastAction.id);

                await renderTable();
                showStatus('Action undone', 'success');
                updateUndoRedoButtons();
            } catch (err) {
                showStatus('Error undoing action: ' + err.message, 'error');
            }
        }

        /**
         * Redo last undone action
         */
        async function redoLastAction() {
            if (AppState.redoStack.length === 0) {
                showStatus('Nothing to redo', 'warning');
                return;
            }

            const action = AppState.redoStack.pop();

            try {
                // Reapply action
                switch (action.entity) {
                    case 'fund':
                        if (action.type === 'delete') {
                            await deleteFundFromDB(action.after.id);
                        } else if (action.type === 'create') {
                            await saveFundToDB(action.after);
                        } else if (action.type === 'update') {
                            await saveFundToDB(action.after);
                        }
                        break;
                    case 'group':
                        if (action.type === 'delete') {
                            await deleteGroup(action.after.id);
                        } else if (action.type === 'create') {
                            await saveGroup(action.after);
                        } else if (action.type === 'update') {
                            await saveGroup(action.after);
                        }
                        break;
                    case 'fundName':
                        if (action.type === 'delete') {
                            await deleteFundName(action.after.name);
                        } else if (action.type === 'create') {
                            await saveFundName(action.after);
                        } else if (action.type === 'update') {
                            await saveFundName(action.after);
                        }
                        break;
                }

                // Add back to undo history
                await saveUndoAction(action.type, action.entity, action.before, action.after);

                await renderTable();
                showStatus('Action redone', 'success');
                updateUndoRedoButtons();
            } catch (err) {
                showStatus('Error redoing action: ' + err.message, 'error');
            }
        }

        /**
         * Update undo/redo button states
         */
        async function updateUndoRedoButtons() {
            const undoBtn = document.getElementById('undoBtn');
            const redoBtn = document.getElementById('redoBtn');

            if (undoBtn) {
                const history = await getUndoHistory();
                undoBtn.disabled = history.length === 0;
                undoBtn.title = history.length > 0 ? `Undo (${history.length} actions available)` : 'Nothing to undo';
            }

            if (redoBtn) {
                redoBtn.disabled = AppState.redoStack.length === 0;
                redoBtn.title = AppState.redoStack.length > 0 ? `Redo (${AppState.redoStack.length} actions available)` : 'Nothing to redo';
            }
        }

        // ===========================
        // Calculation Functions
        // ===========================

        /**
         * Parse currency string to number with robust error handling and validation
         * @param {string|number|null} val - Value to parse
         * @param {boolean} validate - Whether to validate range (default: true)
         * @returns {number} Parsed number or NaN
         */
        function parseCurrency(val, validate = true) {
            if (val === null || typeof val === 'undefined') return NaN;

            if (typeof val === 'number') {
                if (!isFinite(val)) return NaN;
                if (validate && (val < CONFIG.CURRENCY_MIN || val > CONFIG.CURRENCY_MAX)) {
                    console.warn('Currency value out of range:', val);
                    return NaN;
                }
                return val;
            }

            if (typeof val === 'string') {
                const cleaned = val.replace(/[$,]/g, '').replace(/^\((.*)\)$/, '-$1').trim();
                if (cleaned === '' || cleaned === '-') return NaN;
                const num = parseFloat(cleaned);
                if (!isFinite(num)) return NaN;
                if (validate && (num < CONFIG.CURRENCY_MIN || num > CONFIG.CURRENCY_MAX)) {
                    console.warn('Currency value out of range:', num);
                    return NaN;
                }
                return num;
            }

            return NaN;
        }

        /**
         * Format number with commas for thousands separator
         * @param {number} num - Number to format
         * @returns {string} Formatted number string
         */
        function formatNumberWithCommas(num) {
            if (num === null || num === undefined || isNaN(num)) return '';
            // Format with commas and up to 2 decimal places if needed
            const parts = num.toString().split('.');
            parts[0] = parts[0].replace(/\B(?=(\d{3})+(?!\d))/g, ',');
            return parts.join('.');
        }

        /**
         * Format number as currency using configured locale
         * @param {number|string} value - Value to format
         * @param {boolean} showCents - Whether to show cents (default: false)
         * @returns {string} Formatted currency string
         */
        function formatCurrency(value, showCents = false) {
            const val = parseFloat(value);
            if (!isFinite(val) || isNaN(val)) return '$0';
            return val.toLocaleString(CONFIG.CURRENCY_FORMAT, {
                style: 'currency',
                currency: CONFIG.CURRENCY_CODE,
                minimumFractionDigits: showCents ? 2 : 0,
                maximumFractionDigits: showCents ? 2 : 0
            });
        }

        /**
         * Validate date string format (YYYY-MM-DD) and check for valid date
         * Handles timezone issues by parsing date components directly
         * @param {string} dateStr - Date string to validate
         * @returns {boolean} True if valid date format
         */
        function isValidDate(dateStr) {
            if (typeof dateStr !== 'string' || !CONFIG.DATE_FORMAT.test(dateStr)) {
                return false;
            }

            // Parse date components to avoid timezone issues
            const [year, month, day] = dateStr.split('-').map(Number);

            // Check if date components are valid
            if (month < 1 || month > 12) return false;
            if (day < 1 || day > 31) return false;
            if (year < 1900 || year > 2100) return false;

            // Check if day is valid for the given month
            const daysInMonth = new Date(year, month, 0).getDate();
            if (day > daysInMonth) return false;

            return true;
        }

        /**
         * Parse date string to Date object in UTC to avoid timezone issues
         * @param {string} dateStr - Date string in YYYY-MM-DD format
         * @returns {Date|null} Date object or null if invalid
         */
        function parseDate(dateStr) {
            if (!isValidDate(dateStr)) return null;
            const [year, month, day] = dateStr.split('-').map(Number);
            return new Date(Date.UTC(year, month - 1, day));
        }

        /**
         * Compare two date strings
         * @param {string} date1 - First date string
         * @param {string} date2 - Second date string
         * @returns {number} -1 if date1 < date2, 0 if equal, 1 if date1 > date2
         */
        function compareDates(date1, date2) {
            const d1 = parseDate(date1);
            const d2 = parseDate(date2);
            if (!d1 || !d2) return 0;
            return d1 < d2 ? -1 : (d1 > d2 ? 1 : 0);
        }

        function getVintageYear(fund) {
            const contributions = (fund.cashFlows || [])
                .filter(cf => cf.type === 'Contribution' && isValidDate(cf.date))
                .sort((a, b) => new Date(a.date) - new Date(b.date));

            return contributions.length > 0 ? new Date(contributions[0].date).getFullYear() : null;
        }

        function getTotalByType(fund, type, cutoffDate) {
            return (fund.cashFlows || [])
                .filter(cf =>
                    cf.type === type &&
                    isValidDate(cf.date) &&
                    (!cutoffDate || new Date(cf.date) <= cutoffDate)
                )
                .reduce((sum, cf) => sum + Math.abs(parseCurrency(cf.amount) || 0), 0);
        }

        function getLatestNav(fund, cutoffDate) {
            const navs = (fund.monthlyNav || [])
                .filter(n => isValidDate(n.date) && (!cutoffDate || new Date(n.date) <= cutoffDate))
                .sort((a, b) => new Date(b.date) - new Date(a.date));

            if (navs.length === 0) return 0;

            const latestNav = navs[0];
            let navAmount = parseCurrency(latestNav.amount) || 0;
            const navDate = new Date(latestNav.date);

            // Adjust for cash flows after NAV date
            const subsequentFlows = (fund.cashFlows || []).filter(cf => {
                if (!isValidDate(cf.date)) return false;
                const cfDate = new Date(cf.date);
                return cfDate > navDate && (!cutoffDate || cfDate <= cutoffDate);
            });

            subsequentFlows.forEach(cf => {
                const amount = parseCurrency(cf.amount) || 0;
                if (cf.type === 'Contribution') {
                    navAmount -= Math.abs(amount);
                } else if (cf.type === 'Distribution') {
                    navAmount += Math.abs(amount);
                }
            });

            return navAmount;
        }

        function getOutstandingCommitment(fund, cutoffDate) {
            let outstanding = parseCurrency(fund.commitment) || 0;

            (fund.cashFlows || [])
                .filter(cf =>
                    isValidDate(cf.date) &&
                    (!cutoffDate || new Date(cf.date) <= cutoffDate) &&
                    cf.affectsCommitment !== false
                )
                .forEach(cf => {
                    if (cf.type === 'Contribution') {
                        const amount = parseCurrency(cf.amount) || 0;
                        outstanding -= Math.abs(amount);
                    }
                });

            return Math.max(0, outstanding);
        }

        function parseCashFlowsForIRR(fund, cutoffDate) {
            const flows = (fund.cashFlows || [])
                .filter(cf => isValidDate(cf.date) && (!cutoffDate || new Date(cf.date) <= cutoffDate))
                .map(cf => {
                    const amount = parseCurrency(cf.amount) || 0;
                    return {
                        date: cf.date,
                        amount: cf.type === 'Contribution' ? -Math.abs(amount) : Math.abs(amount)
                    };
                });

            // Add NAV as final cash flow (include zero NAV for accurate IRR calculation)
            const nav = getLatestNav(fund, cutoffDate);
            if (nav >= 0) {
                const navs = (fund.monthlyNav || [])
                    .filter(n => isValidDate(n.date) && (!cutoffDate || new Date(n.date) <= cutoffDate))
                    .sort((a, b) => new Date(b.date) - new Date(a.date));

                if (navs.length > 0) {
                    flows.push({ date: navs[0].date, amount: nav });
                }
            }

            return flows.sort((a, b) => new Date(a.date) - new Date(b.date));
        }

        /**
         * Calculate Internal Rate of Return using Newton-Raphson method
         * Handles edge cases: all positive/negative flows, zero contributions, extreme values
         * @param {Array<{date: string, amount: number}>} cashFlows - Array of cash flows
         * @param {number} guess - Initial guess for IRR (default from CONFIG)
         * @returns {number|null} IRR as decimal or null if calculation fails
         */
        function calculateIRR(cashFlows, guess = CONFIG.IRR_GUESS) {
            if (!Array.isArray(cashFlows) || cashFlows.length < 2) return null;

            // Validate cash flows
            const hasNegative = cashFlows.some(f => f.amount < 0);
            const hasPositive = cashFlows.some(f => f.amount > 0);

            // IRR cannot be calculated if all flows are same sign
            if (!hasNegative || !hasPositive) return null;

            // Check for zero contributions (denominator in MOIC)
            const contributions = cashFlows.filter(f => f.amount < 0).reduce((sum, f) => sum + Math.abs(f.amount), 0);
            if (contributions === 0) return null;

            const flows = [...cashFlows].sort((a, b) => {
                const d1 = parseDate(a.date);
                const d2 = parseDate(b.date);
                return d1 - d2;
            });

            const firstDate = parseDate(flows[0].date);
            if (!firstDate) return null;

            const npv = rate => flows.reduce((acc, cf) => {
                const cfDate = parseDate(cf.date);
                if (!cfDate) return acc;
                const yearsDiff = (cfDate - firstDate) / (365.25 * 24 * 60 * 60 * 1000);
                return acc + cf.amount / Math.pow(1 + rate, yearsDiff);
            }, 0);

            const dNpv = rate => flows.reduce((acc, cf) => {
                const cfDate = parseDate(cf.date);
                if (!cfDate) return acc;
                const yearsDiff = (cfDate - firstDate) / (365.25 * 24 * 60 * 60 * 1000);
                if (yearsDiff === 0) return acc;
                return acc - (yearsDiff * cf.amount) / Math.pow(1 + rate, yearsDiff + 1);
            }, 0);

            let rate = guess;

            for (let i = 0; i < CONFIG.IRR_MAX_ITERATIONS; i++) {
                const npvValue = npv(rate);
                const derivativeValue = dNpv(rate);

                if (Math.abs(npvValue) < CONFIG.IRR_PRECISION) {
                    // Validate result is within reasonable bounds
                    if (rate > CONFIG.IRR_MAX_RATE || rate < CONFIG.IRR_MIN_RATE) return null;
                    return rate;
                }

                // Avoid division by near-zero derivative
                if (Math.abs(derivativeValue) < CONFIG.IRR_PRECISION) return null;

                const newRate = rate - npvValue / derivativeValue;

                // Check convergence
                if (Math.abs(newRate - rate) < CONFIG.IRR_PRECISION) {
                    if (newRate > CONFIG.IRR_MAX_RATE || newRate < CONFIG.IRR_MIN_RATE) return null;
                    return newRate;
                }

                // Prevent rate from going too extreme
                rate = Math.max(CONFIG.IRR_MIN_RATE, Math.min(CONFIG.IRR_MAX_RATE, newRate));
            }

            return null;
        }

        /**
         * Calculate Multiple on Invested Capital (MOIC)
         * @param {Array<{date: string, amount: number}>} cashFlows - Array of cash flows
         * @returns {number|null} MOIC or null if cannot be calculated
         */
        function calculateMOIC(cashFlows) {
            if (!Array.isArray(cashFlows) || cashFlows.length === 0) return null;

            const contributions = cashFlows
                .filter(f => f.amount < 0)
                .reduce((sum, f) => sum + Math.abs(f.amount), 0);

            const distributions = cashFlows
                .filter(f => f.amount > 0)
                .reduce((sum, f) => sum + f.amount, 0);

            // Cannot calculate meaningful MOIC without contributions
            if (contributions === 0) return null;

            const moic = distributions / contributions;

            // Validate MOIC is reasonable (between 0 and 100x)
            if (!isFinite(moic) || moic < 0 || moic > 100) return null;

            return moic;
        }

        /**
         * Calculate Distributed to Paid-In (DPI)
         * DPI = Total Distributions / Total Contributions
         * @param {number} totalDistributions - Sum of all distributions
         * @param {number} totalContributions - Sum of all contributions
         * @returns {number|null} DPI or null if cannot be calculated
         */
        function calculateDPI(totalDistributions, totalContributions) {
            if (totalContributions === 0) return null;
            const dpi = totalDistributions / totalContributions;
            if (!isFinite(dpi) || dpi < 0) return null;
            return dpi;
        }

        /**
         * Calculate Total Value to Paid-In (TVPI)
         * TVPI = (NAV + Total Distributions) / Total Contributions
         * @param {number} nav - Current Net Asset Value
         * @param {number} totalDistributions - Sum of all distributions
         * @param {number} totalContributions - Sum of all contributions
         * @returns {number|null} TVPI or null if cannot be calculated
         */
        function calculateTVPI(nav, totalDistributions, totalContributions) {
            if (totalContributions === 0) return null;
            const tvpi = (nav + totalDistributions) / totalContributions;
            if (!isFinite(tvpi) || tvpi < 0) return null;
            return tvpi;
        }

        /**
         * Format DPI/TVPI for display
         * @param {number|null} value - DPI or TVPI value
         * @returns {string} Formatted string
         */
        function formatMultiple(value) {
            if (value === null || value === undefined || !isFinite(value)) return 'N/A';
            return value.toFixed(2) + 'x';
        }

        /**
         * Format MOIC for display with consistent null handling
         * @param {number|null} moic - MOIC value
         * @returns {string} Formatted MOIC string
         */
        function formatMOIC(moic) {
            if (moic === null || moic === undefined || !isFinite(moic)) return 'N/A';
            return moic.toFixed(2) + 'x';
        }

        /**
         * Format IRR for display with consistent null handling
         * @param {number|null} irr - IRR value as decimal
         * @returns {string} Formatted IRR string
         */
        function formatIRR(irr) {
            if (irr === null || irr === undefined || !isFinite(irr)) return 'N/A';
            return (irr * 100).toFixed(2) + '%';
        }

        /**
         * Calculate metrics for a fund with caching support
         * @param {Object} fund - Fund object
         * @param {Date|null} cutoffDate - Cutoff date for calculations
         * @param {boolean} useCache - Whether to use cached metrics (default: true)
         * @returns {Object} Calculated metrics
         */
        function calculateMetrics(fund, cutoffDate, useCache = true) {
            // Check cache first
            if (useCache && fund.id) {
                const cached = AppState.getMetricsFromCache(fund.id, cutoffDate);
                if (cached) return cached;
            }

            const commitment = parseCurrency(fund.commitment) || 0;
            const totalContributions = getTotalByType(fund, 'Contribution', cutoffDate);
            const totalDistributions = getTotalByType(fund, 'Distribution', cutoffDate);
            const nav = getLatestNav(fund, cutoffDate);
            const outstandingCommitment = getOutstandingCommitment(fund, cutoffDate);
            const investmentReturn = totalDistributions + nav - totalContributions;
            const vintage = getVintageYear(fund);

            const cashFlowsForIRR = parseCashFlowsForIRR(fund, cutoffDate);
            const irr = calculateIRR(cashFlowsForIRR);
            const moic = calculateMOIC(cashFlowsForIRR);
            const dpi = calculateDPI(totalDistributions, totalContributions);
            const tvpi = calculateTVPI(nav, totalDistributions, totalContributions);

            const metrics = {
                commitment,
                totalContributions,
                totalDistributions,
                nav,
                outstandingCommitment,
                investmentReturn,
                vintage,
                irr,
                moic,
                dpi,
                tvpi
            };

            // Cache the result
            if (fund.id) {
                AppState.setMetricsCache(fund.id, cutoffDate, metrics);
            }

            return metrics;
        }

        function getLatestQuarterEnd() {
            const now = new Date();
            const currentMonth = now.getMonth();
            const currentQuarter = Math.floor(currentMonth / 3);
            const quarterStartMonth = currentQuarter * 3;
            return new Date(now.getFullYear(), quarterStartMonth, 0);
        }

        // ===========================
        // Input Validation & Sanitization
        // ===========================

        /**
         * Validate fund name
         * @param {string} name - Fund name to validate
         * @returns {{valid: boolean, error: string|null}} Validation result
         */
        function validateFundName(name) {
            if (!name || typeof name !== 'string') {
                return { valid: false, error: 'Fund name is required' };
            }

            const trimmed = name.trim();

            if (trimmed.length < CONFIG.FUND_NAME_MIN_LENGTH) {
                return { valid: false, error: `Fund name must be at least ${CONFIG.FUND_NAME_MIN_LENGTH} characters` };
            }

            if (trimmed.length > CONFIG.FUND_NAME_MAX_LENGTH) {
                return { valid: false, error: `Fund name must be at most ${CONFIG.FUND_NAME_MAX_LENGTH} characters` };
            }

            if (!CONFIG.ALLOWED_FUND_NAME_PATTERN.test(trimmed)) {
                return { valid: false, error: 'Fund name contains invalid characters. Only letters, numbers, spaces, and basic punctuation allowed.' };
            }

            // Check for potentially dangerous patterns
            const dangerous = ['<script', 'javascript:', 'onerror=', 'onclick='];
            const lowerName = trimmed.toLowerCase();
            for (const pattern of dangerous) {
                if (lowerName.includes(pattern)) {
                    return { valid: false, error: 'Fund name contains invalid pattern' };
                }
            }

            return { valid: true, error: null };
        }

        /**
         * Sanitize text for CSV export to prevent formula injection
         * @param {string} value - Value to sanitize
         * @returns {string} Sanitized value
         */
        function sanitizeForCSV(value) {
            if (value === null || value === undefined) return '';

            const str = String(value);

            // Check if starts with formula injection characters
            if (str.length > 0 && ['=', '+', '-', '@', '\t', '\r'].includes(str[0])) {
                // Prefix with single quote to prevent formula execution
                return "'" + str;
            }

            return str;
        }

        /**
         * Escape CSV value (quote if contains special chars)
         * @param {*} value - Value to escape
         * @returns {string} Escaped CSV value
         */
        function escapeCSV(value) {
            const sanitized = sanitizeForCSV(value);
            if (sanitized === '') return '';

            const str = String(sanitized);
            // If contains comma, quote, or newline, wrap in quotes and escape quotes
            if (str.includes(',') || str.includes('"') || str.includes('\n')) {
                return '"' + str.replace(/"/g, '""') + '"';
            }

            return str;
        }

        /**
         * Validate account number
         * @param {string} accountNumber - Account number to validate
         * @returns {{valid: boolean, error: string|null}} Validation result
         */
        function validateAccountNumber(accountNumber) {
            if (!accountNumber || typeof accountNumber !== 'string') {
                return { valid: false, error: 'Account number is required' };
            }

            const trimmed = accountNumber.trim();

            if (trimmed.length === 0) {
                return { valid: false, error: 'Account number cannot be empty' };
            }

            if (trimmed.length > 100) {
                return { valid: false, error: 'Account number is too long' };
            }

            return { valid: true, error: null };
        }

        /**
         * Validate cash flow data
         * @param {Array} cashFlows - Array of cash flows
         * @returns {{valid: boolean, error: string|null, index: number|null}} Validation result
         */
        function validateCashFlows(cashFlows) {
            if (!Array.isArray(cashFlows)) {
                return { valid: false, error: 'Cash flows must be an array', index: null };
            }

            for (let i = 0; i < cashFlows.length; i++) {
                const cf = cashFlows[i];

                if (!cf.date) {
                    return { valid: false, error: 'Cash flow missing date', index: i };
                }

                if (!isValidDate(cf.date)) {
                    return { valid: false, error: 'Invalid date format (use YYYY-MM-DD)', index: i };
                }

                if (typeof cf.amount === 'undefined') {
                    return { valid: false, error: 'Cash flow missing amount', index: i };
                }

                const amount = parseCurrency(cf.amount);
                if (isNaN(amount)) {
                    return { valid: false, error: 'Invalid amount', index: i };
                }

                if (!['Contribution', 'Distribution'].includes(cf.type)) {
                    return { valid: false, error: 'Invalid cash flow type (must be Contribution or Distribution)', index: i };
                }
            }

            return { valid: true, error: null, index: null };
        }

        /**
         * Validate NAV data
         * @param {Array} monthlyNav - Array of NAV entries
         * @returns {{valid: boolean, error: string|null, index: number|null}} Validation result
         */
        function validateMonthlyNav(monthlyNav) {
            if (!Array.isArray(monthlyNav)) {
                return { valid: false, error: 'Monthly NAV must be an array', index: null };
            }

            for (let i = 0; i < monthlyNav.length; i++) {
                const nav = monthlyNav[i];

                if (!nav.date) {
                    return { valid: false, error: 'NAV entry missing date', index: i };
                }

                if (!isValidDate(nav.date)) {
                    return { valid: false, error: 'Invalid date format (use YYYY-MM-DD)', index: i };
                }

                if (typeof nav.amount === 'undefined') {
                    return { valid: false, error: 'NAV entry missing amount', index: i };
                }

                const amount = parseCurrency(nav.amount);
                if (isNaN(amount)) {
                    return { valid: false, error: 'Invalid NAV amount', index: i };
                }

                if (amount < 0) {
                    return { valid: false, error: 'NAV amount cannot be negative', index: i };
                }
            }

            return { valid: true, error: null, index: null };
        }

        // ===========================
        // UI Functions
        // ===========================

        function showStatus(message, type = 'success') {
            const statusDiv = document.createElement('div');
            statusDiv.className = `status-message ${type}`;

            // Create close button
            const closeBtn = document.createElement('button');
            closeBtn.className = 'close-status';
            closeBtn.innerHTML = '&times;';
            closeBtn.onclick = () => statusDiv.remove();

            // Create message text
            const messageText = document.createElement('span');
            messageText.textContent = message;

            statusDiv.appendChild(messageText);
            statusDiv.appendChild(closeBtn);
            document.body.appendChild(statusDiv);

            // Auto-dismiss messages: success after 3s, errors/warnings after 8s
            const dismissTime = type === 'success' ? 3000 : 8000;
            setTimeout(() => {
                if (statusDiv.parentNode) {
                    statusDiv.remove();
                }
            }, dismissTime);
        }

        function showLoading(message = 'Loading...') {
            const overlay = document.getElementById('loadingOverlay');
            const text = document.getElementById('loadingText');
            text.textContent = message;
            overlay.classList.add('show');
        }

        function hideLoading() {
            const overlay = document.getElementById('loadingOverlay');
            overlay.classList.remove('show');
        }

        async function renderTable() {
            try {
                const funds = await getAllFunds();
                currentFunds = funds;

                // Apply filters
                let filtered = applyCurrentFilters(funds);

                // Apply sorting
                if (sortColumns.length > 0) {
                    filtered = sortData(filtered, sortColumns);
                }

                // Update filter dropdowns bidirectionally
                // Each dropdown shows only options compatible with other selected filters
                updateFilterDropdowns(funds);

                // Update vintage filter
                updateVintageFilter(funds);

                // Update active filters indicator
                updateActiveFiltersIndicator();

                // Get cutoff date
                const cutoffDateValue = document.getElementById('cutoffDate').value;
                const cutoffDate = cutoffDateValue ? new Date(cutoffDateValue) : null;

                // Calculate metrics for each fund
                const fundsWithMetrics = filtered.map(fund => ({
                    ...fund,
                    metrics: calculateMetrics(fund, cutoffDate)
                }));

                // Update portfolio summary statistics
                updatePortfolioSummary(fundsWithMetrics, cutoffDate);

                // Render table body
                const tbody = document.getElementById('fundsTableBody');
                tbody.innerHTML = '';

                if (fundsWithMetrics.length === 0) {
                    tbody.innerHTML = `
                        <tr>
                            <td colspan="12" class="empty-state">
                                <div style="padding: 40px;">
                                    <h3 style="margin-bottom: 10px;">No investments found</h3>
                                    <p>Click "New Investment" to add your first fund</p>
                                </div>
                            </td>
                        </tr>
                    `;
                    return;
                }

                fundsWithMetrics.forEach(fund => {
                    const m = fund.metrics;
                    const row = document.createElement('tr');

                    // Build tags HTML - look up tags from fund name
                    const showTags = document.getElementById('sidebarShowTagsCheckbox').checked;
                    const fundNameObj = fundNameData.get(fund.fundName);
                    const tags = fundNameObj && fundNameObj.tags ? fundNameObj.tags : [];
                    const tagsHtml = (showTags && tags.length > 0)
                        ? `<div class="table-tags">${tags.map(tag => `<span class="table-tag">${escapeHtml(tag)}</span>`).join('')}</div>`
                        : '';

                    row.innerHTML = `
                        <td>
                            <div>${escapeHtml(fund.fundName)}</div>
                            ${tagsHtml}
                        </td>
                        <td title="${escapeHtml(getParentAccountDisplay(fund))}">${getInvestorCellHtml(fund)}</td>
                        <td class="center">${m.vintage || 'N/A'}</td>
                        <td class="number">${formatCurrency(m.commitment)}</td>
                        <td class="number">${formatCurrency(m.totalContributions)}</td>
                        <td class="number">${formatCurrency(m.totalDistributions)}</td>
                        <td class="number">${formatCurrency(m.nav)}</td>
                        <td class="number ${m.investmentReturn >= 0 ? 'positive' : 'negative'}">${formatCurrency(m.investmentReturn)}</td>
                        <td class="number">${formatMOIC(m.moic)}</td>
                        <td class="number ${m.irr !== null && m.irr >= 0 ? 'positive' : 'negative'}">${formatIRR(m.irr)}</td>
                        <td class="number">${formatCurrency(m.outstandingCommitment)}</td>
                        <td class="center">
                            <button class="btn-icon fund-actions-btn" data-fund-id="${fund.id}" title="Actions">⚙</button>
                        </td>
                    `;

                    tbody.appendChild(row);
                });

                // Add totals row
                addTotalsRow(fundsWithMetrics, cutoffDate);

            } catch (err) {
                console.error('Error rendering table:', err);
                showStatus('Error loading data: ' + err.message, 'error');
            }
        }

        function addTotalsRow(fundsWithMetrics, cutoffDate) {
            const tbody = document.getElementById('fundsTableBody');

            // Calculate totals
            const totals = {
                commitment: 0,
                totalContributions: 0,
                totalDistributions: 0,
                nav: 0,
                investmentReturn: 0,
                outstandingCommitment: 0,
                aggregateFlows: []
            };

            fundsWithMetrics.forEach(fund => {
                const m = fund.metrics;
                totals.commitment += m.commitment;
                totals.totalContributions += m.totalContributions;
                totals.totalDistributions += m.totalDistributions;
                totals.nav += m.nav;
                totals.investmentReturn += m.investmentReturn;
                totals.outstandingCommitment += m.outstandingCommitment;

                const flows = parseCashFlowsForIRR(fund, cutoffDate);
                totals.aggregateFlows.push(...flows);
            });

            // Calculate aggregate IRR and MOIC
            const aggregateIRR = calculateIRR(totals.aggregateFlows);
            const aggregateMOIC = calculateMOIC(totals.aggregateFlows);

            const totalRow = document.createElement('tr');
            totalRow.innerHTML = `
                <td><strong>Total</strong></td>
                <td></td>
                <td></td>
                <td class="number"><strong>${formatCurrency(totals.commitment)}</strong></td>
                <td class="number"><strong>${formatCurrency(totals.totalContributions)}</strong></td>
                <td class="number"><strong>${formatCurrency(totals.totalDistributions)}</strong></td>
                <td class="number"><strong>${formatCurrency(totals.nav)}</strong></td>
                <td class="number ${totals.investmentReturn >= 0 ? 'positive' : 'negative'}"><strong>${formatCurrency(totals.investmentReturn)}</strong></td>
                <td class="number"><strong>${formatMOIC(aggregateMOIC)}</strong></td>
                <td class="number ${aggregateIRR !== null && aggregateIRR >= 0 ? 'positive' : 'negative'}"><strong>${formatIRR(aggregateIRR)}</strong></td>
                <td class="number"><strong>${formatCurrency(totals.outstandingCommitment)}</strong></td>
                <td></td>
            `;

            tbody.appendChild(totalRow);
        }

        function applyCurrentFilters(funds) {
            const fundFilter = document.getElementById('fundFilter').value;
            const accountFilter = document.getElementById('accountFilter').value;
            const groupFilter = document.getElementById('groupFilter').value;
            const searchInput = document.getElementById('searchInput').value.toLowerCase().trim();
            const vintageFilter = document.getElementById('vintageFilter').value;

            return funds.filter(fund => {
                if (fundFilter && fund.fundName !== fundFilter) return false;
                if (accountFilter && fund.accountNumber !== accountFilter) return false;
                if (groupFilter) {
                    // Check if fund's groupId matches or is descendant of selected group
                    const groupId = parseInt(groupFilter);
                    if (!fund.groupId) return false;
                    if (!currentGroupDescendants || currentGroupDescendants.groupId !== groupId) {
                        return false; // Will be set by async filter
                    }
                    if (!currentGroupDescendants.ids.includes(fund.groupId)) return false;
                }
                // Vintage filter
                if (vintageFilter) {
                    const fundVintage = getVintageYear(fund);
                    if (!fundVintage || fundVintage !== parseInt(vintageFilter)) {
                        return false;
                    }
                }
                // Search filter: check fund name, account number, and tags
                if (searchInput) {
                    const fundName = (fund.fundName || '').toLowerCase();
                    const accountNumber = (fund.accountNumber || '').toLowerCase();
                    // Look up tags from fund name data
                    const fundNameObj = fundNameData.get(fund.fundName);
                    const tags = fundNameObj && fundNameObj.tags ? fundNameObj.tags : [];
                    const fundTags = tags.map(tag => tag.toLowerCase()).join(' ');
                    if (!fundName.includes(searchInput) &&
                        !accountNumber.includes(searchInput) &&
                        !fundTags.includes(searchInput)) {
                        return false;
                    }
                }
                return true;
            });
        }

        function updateFilterDropdowns(allFunds) {
            // Get current filter values
            const groupFilter = document.getElementById('groupFilter');
            const fundFilter = document.getElementById('fundFilter');
            const accountFilter = document.getElementById('accountFilter');

            const currentGroupValue = groupFilter.value;
            const currentFundValue = fundFilter.value;
            const currentAccountValue = accountFilter.value;

            // Helper function to filter funds by group
            const filterByGroup = (funds, groupId) => {
                if (!groupId) return funds;
                const gId = parseInt(groupId);
                return funds.filter(fund => {
                    if (!fund.groupId) return false;
                    if (fund.groupId === gId) return true;
                    // Check if fund's group is descendant of selected group
                    if (currentGroupDescendants && currentGroupDescendants.groupId === gId) {
                        return currentGroupDescendants.ids.includes(fund.groupId);
                    }
                    return false;
                });
            };

            // 1. Update FUND dropdown (filter by group and account)
            // Group filter always takes priority - fund dropdown only shows funds from selected group
            let fundsForFundDropdown = allFunds;
            if (currentGroupValue) {
                fundsForFundDropdown = filterByGroup(fundsForFundDropdown, currentGroupValue);
            }
            if (currentAccountValue) {
                fundsForFundDropdown = fundsForFundDropdown.filter(f => f.accountNumber === currentAccountValue);
            }
            const uniqueFunds = [...new Set(fundsForFundDropdown.map(f => f.fundName))].sort();
            fundFilter.innerHTML = '<option value="">All Funds</option>';
            uniqueFunds.forEach(name => {
                const option = document.createElement('option');
                option.value = name;
                option.textContent = name;
                fundFilter.appendChild(option);
            });
            if (currentFundValue && uniqueFunds.includes(currentFundValue)) {
                fundFilter.value = currentFundValue;
            } else {
                fundFilter.value = '';
            }

            // 2. Update ACCOUNT dropdown (filter by group and fund)
            let fundsForAccountDropdown = allFunds;
            if (currentGroupValue) {
                fundsForAccountDropdown = filterByGroup(fundsForAccountDropdown, currentGroupValue);
            }
            if (currentFundValue) {
                fundsForAccountDropdown = fundsForAccountDropdown.filter(f => f.fundName === currentFundValue);
            }
            const uniqueAccounts = [...new Set(fundsForAccountDropdown.map(f => f.accountNumber))].sort();
            accountFilter.innerHTML = '<option value="">All Accounts</option>';
            uniqueAccounts.forEach(account => {
                const option = document.createElement('option');
                option.value = account;
                option.textContent = account;
                accountFilter.appendChild(option);
            });
            if (currentAccountValue && uniqueAccounts.includes(currentAccountValue)) {
                accountFilter.value = currentAccountValue;
            } else {
                accountFilter.value = '';
            }

            // 3. Update GROUP dropdown
            groupFilter.innerHTML = '<option value="">All Groups</option>';
            if (groups.length > 0) {
                const tree = buildGroupsTree(groups, null);

                // If a group is already selected, keep it selected and show all groups
                // Group filter takes priority and should not be auto-cleared
                if (currentGroupValue) {
                    addGroupOptionsToSelect(groupFilter, tree, 0);
                    groupFilter.value = currentGroupValue;
                } else if (currentFundValue || currentAccountValue) {
                    // Only filter groups when NO group is selected but fund/account IS selected
                    // This helps users see which groups contain the selected fund/account
                    let fundsForGroupDropdown = allFunds;
                    if (currentFundValue) {
                        fundsForGroupDropdown = fundsForGroupDropdown.filter(f => f.fundName === currentFundValue);
                    }
                    if (currentAccountValue) {
                        fundsForGroupDropdown = fundsForGroupDropdown.filter(f => f.accountNumber === currentAccountValue);
                    }

                    // Collect all group IDs including ancestors
                    const validGroupIds = new Set();
                    fundsForGroupDropdown.forEach(fund => {
                        if (fund.groupId != null) {
                            // Add the fund's group and all its ancestors
                            const ancestors = getAncestorGroupIds(fund.groupId);
                            ancestors.forEach(id => validGroupIds.add(id));
                        }
                    });

                    addGroupOptionsToSelectFiltered(groupFilter, tree, 0, validGroupIds);
                } else {
                    // No filters active - show all groups
                    addGroupOptionsToSelect(groupFilter, tree, 0);
                }
            }
        }

        // Helper function to get all ancestor group IDs for a given group ID
        function getAncestorGroupIds(groupId) {
            const ancestors = [];
            let currentId = groupId;

            while (currentId != null) {
                const group = groups.find(g => g.id === currentId);
                if (!group) break;
                ancestors.push(group.id);
                currentId = group.parentId;
            }

            return ancestors;
        }

        // Helper function to get immediate parent group name for a fund
        function getImmediateParentName(fund) {
            if (!fund.groupId) return '';
            const group = groups.find(g => g.id === fund.groupId);
            return group ? group.name : '';
        }

        // Helper function to get parent name + account display text (for sorting/tooltips)
        function getParentAccountDisplay(fund) {
            const parentName = getImmediateParentName(fund);
            return parentName ? `${parentName} (${fund.accountNumber})` : fund.accountNumber;
        }

        // Helper function to get HTML for investor cell display
        function getInvestorCellHtml(fund) {
            const groupName = getImmediateParentName(fund);
            if (groupName) {
                return `<div>${escapeHtml(groupName)}</div><div style="font-size: 0.85em; color: #7f8c8d;">${escapeHtml(fund.accountNumber)}</div>`;
            }
            return escapeHtml(fund.accountNumber);
        }

        // Helper function to add group options but only include groups with valid funds
        function addGroupOptionsToSelectFiltered(selectElement, groupNodes, level, validGroupIds) {
            groupNodes.forEach(node => {
                // Only add this group if it or any of its descendants are in validGroupIds
                const hasValidFunds = validGroupIds.has(node.id) ||
                    hasDescendantWithValidFunds(node, validGroupIds);

                if (hasValidFunds) {
                    const option = document.createElement('option');
                    option.value = node.id;
                    // Use increasing dashes to show hierarchy depth
                    const prefix = level > 0 ? '–'.repeat(level) + ' ' : '';
                    option.textContent = prefix + node.name;
                    selectElement.appendChild(option);

                    if (node.children.length > 0) {
                        addGroupOptionsToSelectFiltered(selectElement, node.children, level + 1, validGroupIds);
                    }
                }
            });
        }

        // Check if a group node or any of its descendants have valid funds
        function hasDescendantWithValidFunds(node, validGroupIds) {
            if (validGroupIds.has(node.id)) return true;
            for (const child of node.children) {
                if (hasDescendantWithValidFunds(child, validGroupIds)) return true;
            }
            return false;
        }

        /**
         * Apply filters to the funds table with race condition protection
         * @returns {Promise<void>}
         */
        async function applyFilters() {
            // Cancel any in-flight filter operation
            if (AppState.abortController) {
                AppState.abortController.abort();
            }

            // Create new abort controller for this operation
            AppState.abortController = new AbortController();
            const signal = AppState.abortController.signal;

            try {
                const groupFilterValue = document.getElementById('groupFilter').value;

                // Check if cancelled
                if (signal.aborted) return;

                // Precompute descendants if group filter is active
                if (groupFilterValue) {
                    const groupId = parseInt(groupFilterValue);

                    // Use cached descendants if available
                    if (!AppState.groupDescendantsCache.has(groupId)) {
                        const descendants = await getAllDescendantGroupIds(groupId);
                        if (signal.aborted) return; // Check again after async operation
                        AppState.groupDescendantsCache.set(groupId, descendants);
                    }

                    currentGroupDescendants = {
                        groupId,
                        ids: AppState.groupDescendantsCache.get(groupId)
                    };
                } else {
                    currentGroupDescendants = null;
                }

                if (signal.aborted) return;

                // Update header based on selected group
                updateHeader();

                if (signal.aborted) return;

                renderTable();
            } catch (err) {
                if (err.name === 'AbortError') {
                    // Operation was cancelled, ignore
                    return;
                }
                console.error('Error applying filters:', err);
                showStatus('Error applying filters: ' + err.message, 'error');
            } finally {
                // Clear abort controller if this is still the current one
                if (AppState.abortController && !AppState.abortController.signal.aborted) {
                    AppState.abortController = null;
                }
            }
        }

        /**
         * Debounced version of applyFilters to reduce excessive calls
         * @const {Function}
         */
        const applyFiltersDebounced = debounce(applyFilters, CONFIG.DEBOUNCE_FILTER);

        function updateHeader() {
            const groupFilterValue = document.getElementById('groupFilter').value;
            const headerTitle = document.getElementById('headerTitle');
            const headerSubtitle = document.getElementById('headerSubtitle');

            if (groupFilterValue) {
                const groupId = parseInt(groupFilterValue);
                const group = groups.find(g => g.id === groupId);

                if (group) {
                    // Set main title to group name
                    headerTitle.textContent = group.name;

                    // Set subtitle to parent group name if exists, otherwise hide subtitle for top-level groups
                    if (group.parentGroupId) {
                        const parentGroup = groups.find(g => g.id === group.parentGroupId);
                        if (parentGroup) {
                            headerSubtitle.textContent = parentGroup.name;
                        } else {
                            headerSubtitle.textContent = group.type || 'Account Group';
                        }
                    } else {
                        // Top level group - no subtitle
                        headerSubtitle.textContent = '';
                    }
                }
            } else {
                // Reset to default
                headerTitle.textContent = 'PE Fund Manager';
                headerSubtitle.textContent = 'Private Equity Fund Analytics & Management Tool';
            }
        }

        function resetFilters() {
            document.getElementById('fundFilter').value = '';
            document.getElementById('accountFilter').value = '';
            document.getElementById('groupFilter').value = '';
            document.getElementById('searchInput').value = '';
            document.getElementById('vintageFilter').value = '';

            // Reset cutoff date to latest quarter end (same as page load)
            const quarterEnd = getLatestQuarterEnd();
            document.getElementById('cutoffDate').value = quarterEnd.toISOString().split('T')[0];

            // Clear all sort columns
            sortColumns = [];
            updateSortHeaders();

            currentGroupDescendants = null;
            updateHeader();
            updateActiveFiltersIndicator();
            renderTable();
        }

        /**
         * Update the active filters indicator
         */
        function updateActiveFiltersIndicator() {
            const fundFilter = document.getElementById('fundFilter').value;
            const accountFilter = document.getElementById('accountFilter').value;
            const groupFilter = document.getElementById('groupFilter').value;
            const searchInput = document.getElementById('searchInput').value.trim();
            const vintageFilter = document.getElementById('vintageFilter').value;

            const hasActiveFilters = fundFilter || accountFilter || groupFilter || searchInput || vintageFilter;
            const indicator = document.getElementById('activeFiltersIndicator');

            if (indicator) {
                indicator.style.display = hasActiveFilters ? 'inline' : 'none';
                indicator.title = hasActiveFilters ? 'Filters are active' : '';
            }
        }

        /**
         * Update portfolio summary statistics
         * @param {Array} fundsWithMetrics - Array of funds with calculated metrics
         * @param {Date|null} cutoffDate - Cutoff date for calculations
         */
        function updatePortfolioSummary(fundsWithMetrics, cutoffDate) {
            const count = fundsWithMetrics.length;

            // Calculate totals
            let totalCommitment = 0;
            let totalNav = 0;
            let totalContributions = 0;
            let totalDistributions = 0;
            let validIRRs = [];
            let validMOICs = [];
            let aggregateFlows = [];

            fundsWithMetrics.forEach(fund => {
                const m = fund.metrics;
                totalCommitment += m.commitment || 0;
                totalNav += m.nav || 0;
                totalContributions += m.totalContributions || 0;
                totalDistributions += m.totalDistributions || 0;

                if (m.irr !== null && isFinite(m.irr)) {
                    validIRRs.push(m.irr);
                }
                if (m.moic !== null && isFinite(m.moic)) {
                    validMOICs.push(m.moic);
                }

                // Collect cash flows for aggregate calculations
                const flows = parseCashFlowsForIRR(fund, cutoffDate);
                aggregateFlows.push(...flows);
            });

            // Calculate averages
            const avgIRR = validIRRs.length > 0
                ? validIRRs.reduce((a, b) => a + b, 0) / validIRRs.length
                : null;
            const avgMOIC = validMOICs.length > 0
                ? validMOICs.reduce((a, b) => a + b, 0) / validMOICs.length
                : null;

            // Calculate aggregate DPI and TVPI
            const portfolioDPI = calculateDPI(totalDistributions, totalContributions);
            const portfolioTVPI = calculateTVPI(totalNav, totalDistributions, totalContributions);

            // Update DOM
            document.getElementById('summaryFundCount').textContent = count;
            document.getElementById('summaryCommitment').textContent = formatCurrency(totalCommitment);
            document.getElementById('summaryNav').textContent = formatCurrency(totalNav);

            const irrElement = document.getElementById('summaryIRR');
            irrElement.textContent = formatIRR(avgIRR);
            irrElement.className = 'summary-value' + (avgIRR !== null ? (avgIRR >= 0 ? ' positive' : ' negative') : '');

            const moicElement = document.getElementById('summaryMOIC');
            moicElement.textContent = formatMOIC(avgMOIC);
            moicElement.className = 'summary-value' + (avgMOIC !== null ? (avgMOIC >= 1 ? ' positive' : ' negative') : '');

            const dpiElement = document.getElementById('summaryDPI');
            dpiElement.textContent = formatMultiple(portfolioDPI);
            dpiElement.className = 'summary-value' + (portfolioDPI !== null ? (portfolioDPI >= 1 ? ' positive' : '') : '');

            const tvpiElement = document.getElementById('summaryTVPI');
            tvpiElement.textContent = formatMultiple(portfolioTVPI);
            tvpiElement.className = 'summary-value' + (portfolioTVPI !== null ? (portfolioTVPI >= 1 ? ' positive' : ' negative') : '');
        }

        /**
         * Toggle dark mode
         */
        function toggleDarkMode() {
            const isDark = document.documentElement.getAttribute('data-theme') === 'dark';
            const newTheme = isDark ? 'light' : 'dark';
            document.documentElement.setAttribute('data-theme', newTheme);
            Storage.set('darkMode', newTheme === 'dark');
            document.getElementById('sidebarDarkModeCheckbox').checked = newTheme === 'dark';
        }

        /**
         * Initialize dark mode from saved preference
         */
        function initializeDarkMode() {
            const savedDarkMode = Storage.get('darkMode', false);
            if (savedDarkMode) {
                document.documentElement.setAttribute('data-theme', 'dark');
                document.getElementById('sidebarDarkModeCheckbox').checked = true;
            }
        }

        /**
         * Update vintage year filter dropdown
         * @param {Array} funds - All funds
         */
        function updateVintageFilter(funds) {
            const vintageFilter = document.getElementById('vintageFilter');
            const currentValue = vintageFilter.value;

            // Get unique vintage years
            const vintages = new Set();
            funds.forEach(fund => {
                const vintage = getVintageYear(fund);
                if (vintage) {
                    vintages.add(vintage);
                }
            });

            // Sort vintages in descending order
            const sortedVintages = Array.from(vintages).sort((a, b) => b - a);

            vintageFilter.innerHTML = '<option value="">All Vintages</option>';
            sortedVintages.forEach(year => {
                const option = document.createElement('option');
                option.value = year;
                option.textContent = year;
                vintageFilter.appendChild(option);
            });

            // Restore selection if still valid
            if (currentValue && sortedVintages.includes(parseInt(currentValue))) {
                vintageFilter.value = currentValue;
            }
        }

        /**
         * Show keyboard shortcuts modal
         */
        function showShortcutsModal() {
            document.getElementById('shortcutsModal').classList.add('show');
        }

        /**
         * Close keyboard shortcuts modal
         */
        function closeShortcutsModal() {
            document.getElementById('shortcutsModal').classList.remove('show');
        }

        function toggleSidebar() {
            const sidebar = document.getElementById('sidebar');
            const overlay = document.getElementById('sidebarOverlay');
            sidebar.classList.add('show');
            overlay.classList.add('show');
            document.body.classList.add('sidebar-open');
        }

        function closeSidebar() {
            const sidebar = document.getElementById('sidebar');
            const overlay = document.getElementById('sidebarOverlay');
            sidebar.classList.remove('show');
            overlay.classList.remove('show');
            document.body.classList.remove('sidebar-open');
        }

        function toggleTagsDisplay() {
            const checkbox = document.getElementById('sidebarShowTagsCheckbox');
            // Save preference to localStorage
            Storage.set('showTags', checkbox.checked);
            // Re-render table to show/hide tags
            renderTable();
            // Also refresh Manage Funds list if it's open
            const manageFundsModal = document.getElementById('manageFundNamesModal');
            if (manageFundsModal && manageFundsModal.classList.contains('show')) {
                loadFundNamesList();
            }
        }

        function sortData(data, sortSpecs) {
            if (!sortSpecs || sortSpecs.length === 0) return data;

            return [...data].sort((a, b) => {
                const cutoffDateValue = document.getElementById('cutoffDate').value;
                const cutoffDate = cutoffDateValue ? new Date(cutoffDateValue) : null;

                const metricsA = calculateMetrics(a, cutoffDate);
                const metricsB = calculateMetrics(b, cutoffDate);

                for (const { column, direction } of sortSpecs) {
                    let valA, valB;

                    switch(column) {
                        case 'fundName':
                            valA = a[column];
                            valB = b[column];
                            break;
                        case 'accountNumber':
                            // Sort by displayed text (parent name + account number)
                            valA = getParentAccountDisplay(a);
                            valB = getParentAccountDisplay(b);
                            break;
                        case 'vintage':
                        case 'commitment':
                        case 'totalContributions':
                        case 'totalDistributions':
                        case 'nav':
                        case 'investmentReturn':
                        case 'outstandingCommitment':
                        case 'irr':
                        case 'moic':
                            valA = metricsA[column] ?? -Infinity;
                            valB = metricsB[column] ?? -Infinity;
                            break;
                        default:
                            continue;
                    }

                    if (valA < valB) return direction === 'asc' ? -1 : 1;
                    if (valA > valB) return direction === 'asc' ? 1 : -1;
                    // If equal, continue to next sort column
                }
                return 0;
            });
        }

        function sortTable(column) {
            const existingIndex = sortColumns.findIndex(s => s.column === column);

            if (existingIndex === -1) {
                // Column not in sort list - add as ascending
                sortColumns.push({ column, direction: 'asc' });
            } else if (sortColumns[existingIndex].direction === 'asc') {
                // Currently ascending - change to descending
                sortColumns[existingIndex].direction = 'desc';
            } else {
                // Currently descending - remove from sort list
                sortColumns.splice(existingIndex, 1);
            }

            // Update header classes
            updateSortHeaders();
            renderTable();
        }

        function updateSortHeaders() {
            const headers = document.querySelectorAll('#fundsTable th');
            const columnNames = ['fundName', 'accountNumber', 'vintage', 'commitment', 'totalContributions', 'totalDistributions', 'nav', 'investmentReturn', 'moic', 'irr', 'outstandingCommitment'];

            headers.forEach((th, index) => {
                th.classList.remove('sorted-asc', 'sorted-desc');
                th.removeAttribute('data-sort-priority');

                const columnName = columnNames[index];
                const sortIndex = sortColumns.findIndex(s => s.column === columnName);

                if (sortIndex !== -1) {
                    th.classList.add(`sorted-${sortColumns[sortIndex].direction}`);
                    if (sortColumns.length > 1) {
                        th.setAttribute('data-sort-priority', sortIndex + 1);
                    }
                }
            });
        }

        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        // ===========================
        // Modal Functions
        // ===========================

        async function showAddFundModal() {
            document.getElementById('fundModalTitle').textContent = 'Add New Investment';
            document.getElementById('fundId').value = '';
            document.getElementById('isDuplicate').value = '';
            document.getElementById('duplicateMultiplierContainer').style.display = 'none';

            await populateFundNamesDropdown();
            await populateFundGroupDropdown();

            // Reset other form fields (not the fund name dropdown which we just populated)
            document.getElementById('accountNumber').value = '';
            document.getElementById('commitment').value = '';
            document.getElementById('cashFlows').value = '';
            document.getElementById('monthlyNav').value = '';

            document.getElementById('fundModal').classList.add('show');
        }

        async function editFund(id) {
            try {
                const fund = await getFundById(id);
                if (!fund) {
                    showStatus('Fund not found', 'error');
                    return;
                }

                console.log('Editing fund:', fund);
                console.log('Fund monthlyNav:', fund.monthlyNav);

                document.getElementById('fundModalTitle').textContent = 'Edit Investment';
                document.getElementById('fundId').value = fund.id;
                document.getElementById('isDuplicate').value = '';
                document.getElementById('duplicateMultiplierContainer').style.display = 'none';

                await populateFundNamesDropdown(fund.fundName);
                await populateFundGroupDropdown(fund.groupId);
                document.getElementById('accountNumber').value = fund.accountNumber;
                document.getElementById('commitment').value = formatCurrency(parseCurrency(fund.commitment) || 0);
                document.getElementById('cashFlows').value = JSON.stringify(fund.cashFlows || [], null, 2);
                document.getElementById('monthlyNav').value = JSON.stringify(fund.monthlyNav || [], null, 2);

                document.getElementById('fundModal').classList.add('show');
            } catch (err) {
                showStatus('Error loading fund: ' + err.message, 'error');
                console.error('Error in editFund:', err);
            }
        }

        async function duplicateFund(id) {
            try {
                const fund = await getFundById(id);
                if (!fund) {
                    showStatus('Fund not found', 'error');
                    return;
                }

                document.getElementById('fundModalTitle').textContent = 'Duplicate Investment';
                document.getElementById('fundId').value = '';
                document.getElementById('isDuplicate').value = id;
                document.getElementById('duplicateMultiplierContainer').style.display = 'block';
                document.getElementById('duplicateMultiplier').value = '1';

                await populateFundNamesDropdown(fund.fundName);
                await populateFundGroupDropdown(fund.groupId);
                document.getElementById('accountNumber').value = fund.accountNumber + ' (Copy)';
                document.getElementById('commitment').value = formatCurrency(parseCurrency(fund.commitment) || 0);
                document.getElementById('cashFlows').value = JSON.stringify(fund.cashFlows || [], null, 2);
                document.getElementById('monthlyNav').value = JSON.stringify(fund.monthlyNav || [], null, 2);

                document.getElementById('fundModal').classList.add('show');
            } catch (err) {
                showStatus('Error loading fund: ' + err.message, 'error');
            }
        }

        function closeFundModal() {
            document.getElementById('fundModal').classList.remove('show');
        }

        // Tag management functions
        // Handle tag input for Edit Fund Name modal
        document.addEventListener('keydown', function(event) {
            if (event.target.id === 'editFundTagsInput' && event.key === 'Enter') {
                event.preventDefault();
                const input = event.target;
                const tagName = input.value.trim();
                if (tagName) {
                    const currentTags = getEditFundTags();
                    if (!currentTags.includes(tagName)) {
                        addEditFundTag(tagName);
                        input.value = '';
                    } else {
                        showStatus('Tag already added', 'warning');
                    }
                }
            }
        });

        async function saveFund(event) {
            event.preventDefault();

            try {
                const fundId = document.getElementById('fundId').value;
                const isDuplicate = document.getElementById('isDuplicate').value;
                const fundName = document.getElementById('fundName').value.trim();
                const accountNumber = document.getElementById('accountNumber').value.trim();
                const groupId = document.getElementById('fundGroup').value;
                const commitmentText = document.getElementById('commitment').value.trim();
                const cashFlowsText = document.getElementById('cashFlows').value.trim();
                const monthlyNavText = document.getElementById('monthlyNav').value.trim();

                // Validate fund name
                const fundNameValidation = validateFundName(fundName);
                if (!fundNameValidation.valid) {
                    showStatus(fundNameValidation.error, 'error');
                    return;
                }

                // Validate account number
                const accountValidation = validateAccountNumber(accountNumber);
                if (!accountValidation.valid) {
                    showStatus(accountValidation.error, 'error');
                    return;
                }

                // Validate commitment is present
                if (!commitmentText) {
                    showStatus('Please enter a commitment amount', 'error');
                    return;
                }

                // Parse commitment
                let commitment = parseCurrency(commitmentText);
                if (isNaN(commitment)) {
                    showStatus('Invalid commitment amount', 'error');
                    return;
                }
                if (commitment < 0) {
                    showStatus('Commitment amount cannot be negative', 'error');
                    return;
                }

                // Parse and validate JSON
                let cashFlows, monthlyNav;

                // Parse cash flows (optional)
                if (cashFlowsText) {
                    try {
                        cashFlows = JSON.parse(cashFlowsText);
                        if (!Array.isArray(cashFlows)) throw new Error('Cash flows must be an array');
                    } catch (err) {
                        showStatus('Invalid cash flows JSON: ' + err.message, 'error');
                        return;
                    }

                    // Validate cash flows using validation function
                    const cashFlowValidation = validateCashFlows(cashFlows);
                    if (!cashFlowValidation.valid) {
                        const errorMsg = cashFlowValidation.index !== null
                            ? `Cash flow #${cashFlowValidation.index + 1}: ${cashFlowValidation.error}`
                            : cashFlowValidation.error;
                        showStatus(errorMsg, 'error');
                        return;
                    }
                } else {
                    cashFlows = [];
                }

                // Parse monthly NAV
                try {
                    monthlyNav = monthlyNavText ? JSON.parse(monthlyNavText) : [];
                    if (!Array.isArray(monthlyNav)) throw new Error('Monthly NAV must be an array');
                } catch (err) {
                    showStatus('Invalid monthly NAV JSON: ' + err.message, 'error');
                    return;
                }

                // Validate monthly NAV using validation function
                const navValidation = validateMonthlyNav(monthlyNav);
                if (!navValidation.valid) {
                    const errorMsg = navValidation.index !== null
                        ? `NAV entry #${navValidation.index + 1}: ${navValidation.error}`
                        : navValidation.error;
                    showStatus(errorMsg, 'error');
                    return;
                }

                // Handle duplicate multiplier
                if (isDuplicate) {
                    const multiplier = parseFloat(document.getElementById('duplicateMultiplier').value) || 1;

                    if (multiplier <= 0) {
                        showStatus('Duplicate multiplier must be positive', 'error');
                        return;
                    }

                    if (multiplier > 1000) {
                        if (!confirm(`Warning: Multiplier of ${multiplier} is very large. This will create extremely large amounts. Continue?`)) {
                            return;
                        }
                    }

                    if (multiplier < 0.001) {
                        if (!confirm(`Warning: Multiplier of ${multiplier} is very small. This may result in rounding to zero. Continue?`)) {
                            return;
                        }
                    }

                    commitment = commitment * multiplier;

                    cashFlows = cashFlows.map(cf => ({
                        ...cf,
                        amount: parseCurrency(cf.amount) * multiplier
                    }));

                    monthlyNav = monthlyNav.map(nav => ({
                        ...nav,
                        amount: parseCurrency(nav.amount) * multiplier
                    }));
                }

                const fundData = {
                    fundName,
                    accountNumber,
                    groupId: groupId ? parseInt(groupId) : null,
                    commitment: commitment,
                    cashFlows,
                    monthlyNav,
                    timestamp: new Date().toISOString()
                };

                // Save undo history for updates
                let beforeState = null;
                if (fundId) {
                    fundData.id = parseInt(fundId);
                    beforeState = await getFundById(parseInt(fundId));
                }

                const savedId = await saveFundToDB(fundData);

                // Save undo action
                if (fundId) {
                    await saveUndoAction('update', 'fund', beforeState, fundData);
                } else {
                    await saveUndoAction('create', 'fund', null, { ...fundData, id: savedId });
                }

                // Save fund name if new
                if (!fundNames.has(fundName)) {
                    await saveFundName(fundName);
                    fundNames.add(fundName);
                    fundNameData.set(fundName, { name: fundName, tags: [] });
                }

                // Clear metrics cache since data changed
                AppState.clearMetricsCache();

                closeFundModal();
                await renderTable();
                showStatus(fundId ? 'Fund updated successfully' : 'Fund added successfully');

                // Update last backup reminder
                checkBackupReminder();

            } catch (err) {
                showStatus('Error saving fund: ' + err.message, 'error');
                console.error(err);
            }
        }

        async function showActionModal(id, buttonElement) {
            console.log('showActionModal called with ID:', id, 'Type:', typeof id);

            if (!id && id !== 0) {
                console.error('Invalid fund ID provided to showActionModal:', id);
                showStatus('Error: Invalid fund ID provided', 'error');
                return;
            }

            currentActionFundId = id;

            try {
                const fund = await getFundById(id);
                if (!fund) {
                    showStatus('Fund not found', 'error');
                    return;
                }

                console.log('Action dropdown showing for fund:', fund.fundName, 'ID:', fund.id);

                // Position and show the dropdown
                const dropdown = document.getElementById('actionDropdown');
                const rect = buttonElement.getBoundingClientRect();

                // Position dropdown below and to the left of the button
                // Since dropdown uses position: fixed, we don't add window.scrollY/X
                dropdown.style.top = `${rect.bottom + 2}px`;
                dropdown.style.left = `${rect.left - 100}px`;

                dropdown.classList.add('show');
            } catch (err) {
                console.error('Error in showActionModal:', err);
                showStatus('Error loading fund: ' + err.message, 'error');
            }
        }

        function closeActionModal() {
            const dropdown = document.getElementById('actionDropdown');
            dropdown.classList.remove('show');
            currentActionFundId = null;
        }

        function editFundFromAction() {
            const fundId = currentActionFundId;
            if (fundId == null) {
                showStatus('Error: No fund selected', 'error');
                return;
            }
            closeActionModal();
            editFund(fundId);
        }

        function duplicateFundFromAction() {
            const fundId = currentActionFundId;
            if (fundId == null) {
                showStatus('Error: No fund selected', 'error');
                return;
            }
            closeActionModal();
            duplicateFund(fundId);
        }

        async function deleteFundFromAction() {
            if (currentActionFundId == null) return;

            try {
                const fund = await getFundById(currentActionFundId);
                if (!fund) {
                    showStatus('Fund not found', 'error');
                    return;
                }

                if (confirm(`Are you sure you want to delete "${fund.fundName} - ${fund.accountNumber}"?`)) {
                    // Save undo action before deleting
                    await saveUndoAction('delete', 'fund', fund, null);

                    await deleteFundFromDB(currentActionFundId);

                    // Clear metrics cache
                    AppState.clearMetricsCache();

                    closeActionModal();
                    await renderTable();
                    showStatus('Fund deleted successfully (Undo available)', 'success');
                }
            } catch (err) {
                showStatus('Error deleting fund: ' + err.message, 'error');
            }
        }

        function showDetailsFromAction() {
            // Capture the ID before closing the modal
            const fundId = currentActionFundId;
            console.log('Opening details for fund ID:', fundId);
            if (fundId == null) {
                console.error('No fund ID available');
                showStatus('Error: No fund selected', 'error');
                return;
            }
            closeActionModal();
            showDetailsModal(fundId);
        }

        async function showDetailsModal(id) {
            console.log('showDetailsModal called with ID:', id, 'Type:', typeof id);

            if (!id && id !== 0) {
                console.error('Invalid fund ID provided to showDetailsModal:', id);
                showStatus('Error: Invalid fund ID provided', 'error');
                return;
            }

            currentDetailsFundId = id;

            try {
                console.log('Loading fund details for ID:', id);
                const fund = await getFundById(id);

                if (!fund) {
                    console.error('Fund not found:', id);
                    showStatus('Fund not found', 'error');
                    return;
                }

                console.log('Fund loaded:', fund);

                document.getElementById('detailsModalTitle').textContent =
                    `Fund Details - ${fund.fundName}`;

                // Display last modified timestamp
                const subtitle = document.getElementById('detailsModalSubtitle');
                if (fund.timestamp) {
                    try {
                        const date = new Date(fund.timestamp);
                        const formatted = date.toLocaleString('en-US', {
                            year: 'numeric',
                            month: 'short',
                            day: 'numeric',
                            hour: '2-digit',
                            minute: '2-digit'
                        });
                        subtitle.textContent = `Last modified: ${formatted}`;
                    } catch (err) {
                        subtitle.textContent = '';
                    }
                } else {
                    subtitle.textContent = '';
                }

                // Populate cash flows table
                const cashFlowsTable = document.getElementById('cashFlowsTable');
                if (!cashFlowsTable) {
                    console.error('Cash flows table not found');
                    showStatus('Error: Cash flows table element not found in page', 'error');
                    return;
                }
                const cashFlowsTableBody = cashFlowsTable.querySelector('tbody');
                if (!cashFlowsTableBody) {
                    console.error('Cash flows table body not found');
                    showStatus('Error: Cash flows table body element not found in page', 'error');
                    return;
                }
                cashFlowsTableBody.innerHTML = '';

                console.log('Cash flows:', fund.cashFlows);
                (fund.cashFlows || []).forEach((cf, index) => {
                    try {
                        const row = document.createElement('tr');
                        const amountValue = parseCurrency(cf.amount);
                        const displayAmount = isNaN(amountValue) ? '' : formatNumberWithCommas(amountValue);

                        row.innerHTML = `
                            <td><input type="date" value="${escapeHtml(cf.date || '')}" data-field="date" data-index="${index}"></td>
                            <td class="number"><input type="text" value="${displayAmount}" data-field="amount" data-index="${index}"></td>
                            <td class="center">
                                <select data-field="type" data-index="${index}">
                                    <option value="Contribution" ${cf.type === 'Contribution' ? 'selected' : ''}>Contribution</option>
                                    <option value="Distribution" ${cf.type === 'Distribution' ? 'selected' : ''}>Distribution</option>
                                </select>
                            </td>
                            <td class="center">
                                <input type="checkbox" ${cf.affectsCommitment !== false ? 'checked' : ''} data-field="affectsCommitment" data-index="${index}">
                            </td>
                            <td>
                                <button class="delete-row-btn" data-action="deleteCashFlow" title="Delete">×</button>
                            </td>
                        `;
                        cashFlowsTableBody.appendChild(row);
                    } catch (cfErr) {
                        console.error('Error adding cash flow row:', cfErr, cf);
                        showStatus('Error loading cash flow at index ' + index + ': ' + cfErr.message, 'error');
                    }
                });

                // Populate NAV table
                const navTable = document.getElementById('navTable');
                if (!navTable) {
                    console.error('NAV table not found');
                    showStatus('Error: NAV table element not found in page', 'error');
                    return;
                }
                const navTableBody = navTable.querySelector('tbody');
                if (!navTableBody) {
                    console.error('NAV table body not found');
                    showStatus('Error: NAV table body element not found in page', 'error');
                    return;
                }
                navTableBody.innerHTML = '';

                console.log('Monthly NAV:', fund.monthlyNav);
                (fund.monthlyNav || []).forEach((nav, index) => {
                    try {
                        const row = document.createElement('tr');
                        const amountValue = parseCurrency(nav.amount);
                        const displayAmount = isNaN(amountValue) ? '' : formatNumberWithCommas(amountValue);

                        row.innerHTML = `
                            <td><input type="date" value="${escapeHtml(nav.date || '')}" data-field="date" data-index="${index}"></td>
                            <td><input type="text" value="${displayAmount}" data-field="amount" data-index="${index}"></td>
                            <td>
                                <button class="delete-row-btn" data-action="deleteNav" title="Delete">×</button>
                            </td>
                        `;
                        navTableBody.appendChild(row);
                    } catch (navErr) {
                        console.error('Error adding NAV row:', navErr, nav);
                        showStatus('Error loading NAV at index ' + index + ': ' + navErr.message, 'error');
                    }
                });

                document.getElementById('detailsModal').classList.add('show');
                hasUnsavedChanges = false; // Reset unsaved changes flag when opening modal
                console.log('Details modal opened successfully');
            } catch (err) {
                console.error('Error in showDetailsModal:', err);
                showStatus('Error loading fund details: ' + err.message + ' (Check console for details)', 'error');
            }
        }

        function closeDetailsModal() {
            if (hasUnsavedChanges) {
                if (!confirm('You have unsaved changes. Are you sure you want to close without saving?')) {
                    return;
                }
            }
            document.getElementById('detailsModal').classList.remove('show');
            currentDetailsFundId = null;
            hasUnsavedChanges = false;
        }

        function addCashFlowRow() {
            const table = document.getElementById('cashFlowsTable').querySelector('tbody');
            const index = table.children.length;
            const row = document.createElement('tr');
            row.innerHTML = `
                <td><input type="date" data-field="date" data-index="${index}"></td>
                <td class="number"><input type="text" placeholder="0" data-field="amount" data-index="${index}"></td>
                <td class="center">
                    <select data-field="type" data-index="${index}">
                        <option value="Contribution">Contribution</option>
                        <option value="Distribution">Distribution</option>
                    </select>
                </td>
                <td class="center">
                    <input type="checkbox" checked data-field="affectsCommitment" data-index="${index}">
                </td>
                <td>
                    <button class="delete-row-btn" data-action="deleteCashFlow">Delete</button>
                </td>
            `;
            table.appendChild(row);
            hasUnsavedChanges = true;
        }

        function deleteCashFlowRow(button) {
            const row = button.closest('tr');
            if (row) {
                const date = row.querySelector('[data-field="date"]').value;
                const amount = row.querySelector('[data-field="amount"]').value;
                const type = row.querySelector('[data-field="type"]').value;

                const dateText = date || 'no date';
                const amountText = amount || '$0';
                const typeText = type || 'contribution';

                if (confirm(`Delete this cash flow?\n${typeText} on ${dateText}: ${amountText}`)) {
                    row.remove();
                    hasUnsavedChanges = true;
                }
            }
        }

        function addNavRow() {
            const table = document.getElementById('navTable').querySelector('tbody');
            const index = table.children.length;
            const row = document.createElement('tr');
            row.innerHTML = `
                <td><input type="date" data-field="date" data-index="${index}"></td>
                <td><input type="text" placeholder="0" data-field="amount" data-index="${index}"></td>
                <td>
                    <button class="delete-row-btn" data-action="deleteNav" title="Delete">×</button>
                </td>
            `;
            table.appendChild(row);
            hasUnsavedChanges = true;
        }

        function deleteNavRow(button) {
            const row = button.closest('tr');
            if (row) {
                const date = row.querySelector('[data-field="date"]').value;
                const amount = row.querySelector('[data-field="amount"]').value;

                const dateText = date || 'no date';
                const amountText = amount || '$0';

                if (confirm(`Delete this NAV entry?\n${dateText}: ${amountText}`)) {
                    row.remove();
                    hasUnsavedChanges = true;
                }
            }
        }

        async function saveDetailsChanges() {
            if (!currentDetailsFundId) return;

            try {
                const fund = await getFundById(currentDetailsFundId);
                if (!fund) {
                    showStatus('Fund not found', 'error');
                    return;
                }

                // Store original counts for comparison
                const originalCashFlowCount = (fund.cashFlows || []).length;
                const originalNavCount = (fund.monthlyNav || []).length;

                // Read cash flows from table
                const cashFlowsTable = document.getElementById('cashFlowsTable').querySelector('tbody');
                const cashFlows = [];
                const invalidCashFlows = [];

                // Clear previous error highlights
                Array.from(cashFlowsTable.children).forEach(row => {
                    row.classList.remove('validation-error-row');
                });

                Array.from(cashFlowsTable.children).forEach((row, index) => {
                    const date = row.querySelector('[data-field="date"]').value;
                    const amount = row.querySelector('[data-field="amount"]').value;
                    const type = row.querySelector('[data-field="type"]').value;
                    const affectsCommitment = row.querySelector('[data-field="affectsCommitment"]').checked;

                    if (date && amount) {
                        // Validate date format (YYYY-MM-DD)
                        if (!isValidDate(date)) {
                            invalidCashFlows.push(index + 1);
                            row.classList.add('validation-error-row');
                        } else {
                            cashFlows.push({
                                date,
                                amount: parseCurrency(amount),
                                type,
                                affectsCommitment
                            });
                        }
                    }
                });

                if (invalidCashFlows.length > 0) {
                    showStatus(`Invalid date format in cash flow row(s): ${invalidCashFlows.join(', ')}. Use YYYY-MM-DD format.`, 'error');
                    return;
                }

                // Read NAV from table
                const navTable = document.getElementById('navTable').querySelector('tbody');
                const monthlyNav = [];
                const invalidNav = [];

                // Clear previous error highlights
                Array.from(navTable.children).forEach(row => {
                    row.classList.remove('validation-error-row');
                });

                Array.from(navTable.children).forEach((row, index) => {
                    const date = row.querySelector('[data-field="date"]').value;
                    const amount = row.querySelector('[data-field="amount"]').value;

                    if (date && amount) {
                        // Validate date format (YYYY-MM-DD)
                        if (!isValidDate(date)) {
                            invalidNav.push(index + 1);
                            row.classList.add('validation-error-row');
                        } else {
                            monthlyNav.push({
                                date,
                                amount: parseCurrency(amount)
                            });
                        }
                    }
                });

                if (invalidNav.length > 0) {
                    showStatus(`Invalid date format in NAV row(s): ${invalidNav.join(', ')}. Use YYYY-MM-DD format.`, 'error');
                    return;
                }

                // Warn if significant data is being deleted
                if (originalCashFlowCount > 0 && cashFlows.length < originalCashFlowCount / 2) {
                    if (!confirm(`Warning: You are deleting ${originalCashFlowCount - cashFlows.length} cash flow(s). Continue?`)) {
                        return;
                    }
                }

                if (originalNavCount > 0 && monthlyNav.length < originalNavCount / 2) {
                    if (!confirm(`Warning: You are deleting ${originalNavCount - monthlyNav.length} NAV entr(ies). Continue?`)) {
                        return;
                    }
                }

                // Update fund
                fund.cashFlows = cashFlows;
                fund.monthlyNav = monthlyNav;
                fund.timestamp = new Date().toISOString();

                await saveFundToDB(fund);
                hasUnsavedChanges = false; // Mark as saved before closing
                closeDetailsModal();
                await renderTable();
                showStatus('Details updated successfully');

            } catch (err) {
                showStatus('Error saving details: ' + err.message, 'error');
                console.error(err);
            }
        }

        async function showManageFundsModal() {
            await loadFundNamesList();
            await populateFundNamesDropdown();
            document.getElementById('manageFundNamesModal').classList.add('show');
        }

        function closeManageFundsModal() {
            document.getElementById('manageFundNamesModal').classList.remove('show');
        }

        async function loadFundNamesList() {
            try {
                const fundNameObjects = await getAllFundNameObjects();
                fundNames = new Set(fundNameObjects.map(obj => obj.name));
                fundNameData = new Map(fundNameObjects.map(obj => [obj.name, obj]));

                const container = document.getElementById('fundNamesList');
                container.innerHTML = '';

                if (fundNameObjects.length === 0) {
                    container.innerHTML = '<p style="color: #95A5A6;">No fund names yet</p>';
                    return;
                }

                fundNameObjects.forEach(fundNameObj => {
                    const div = document.createElement('div');
                    div.className = 'fund-name-item';

                    const nameDiv = document.createElement('div');
                    nameDiv.style.flex = '1';
                    nameDiv.style.minWidth = '0';

                    const nameSpan = document.createElement('div');
                    nameSpan.textContent = fundNameObj.name;
                    nameSpan.style.fontWeight = '500';
                    nameSpan.style.marginBottom = '4px';
                    nameDiv.appendChild(nameSpan);

                    // Show tags if any and if tags are enabled
                    const showTags = document.getElementById('sidebarShowTagsCheckbox').checked;
                    if (showTags && fundNameObj.tags && fundNameObj.tags.length > 0) {
                        const tagsDiv = document.createElement('div');
                        tagsDiv.className = 'table-tags';
                        tagsDiv.style.marginTop = '4px';
                        fundNameObj.tags.forEach(tag => {
                            const tagSpan = document.createElement('span');
                            tagSpan.className = 'table-tag';
                            tagSpan.textContent = tag;
                            tagsDiv.appendChild(tagSpan);
                        });
                        nameDiv.appendChild(tagsDiv);
                    }

                    const editBtn = document.createElement('button');
                    editBtn.className = 'btn-icon';
                    editBtn.textContent = '✎';
                    editBtn.title = 'Edit';
                    editBtn.setAttribute('data-fund-name', fundNameObj.name);
                    editBtn.onclick = function() { openEditFundNameModal(this.getAttribute('data-fund-name')); };

                    const deleteBtn = document.createElement('button');
                    deleteBtn.className = 'btn-icon';
                    deleteBtn.textContent = '×';
                    deleteBtn.title = 'Delete';
                    deleteBtn.style.color = '#E74C3C';
                    deleteBtn.setAttribute('data-fund-name', fundNameObj.name);
                    deleteBtn.onclick = function() { removeFundName(this.getAttribute('data-fund-name')); };

                    div.appendChild(nameDiv);
                    div.appendChild(editBtn);
                    div.appendChild(deleteBtn);
                    container.appendChild(div);
                });
            } catch (err) {
                showStatus('Error loading fund names: ' + err.message, 'error');
            }
        }

        async function addNewFundName() {
            const input = document.getElementById('newFundNameInput');
            const name = input.value.trim();

            if (!name) {
                showStatus('Please enter a fund name', 'error');
                return;
            }

            if (fundNames.has(name)) {
                showStatus('Fund name already exists', 'error');
                return;
            }

            try {
                const fundNameObj = { name, tags: [] };
                await saveFundName(fundNameObj);

                // Save undo action
                await saveUndoAction('create', 'fundName', null, fundNameObj);

                fundNames.add(name);
                fundNameData.set(name, fundNameObj);
                input.value = '';
                await loadFundNamesList();
                showStatus('Fund name added successfully');
            } catch (err) {
                showStatus('Error adding fund name: ' + err.message, 'error');
            }
        }

        // Open Edit Fund Name Modal
        function openEditFundNameModal(fundName) {
            const fundNameObj = fundNameData.get(fundName);
            if (!fundNameObj) {
                showStatus('Fund name not found', 'error');
                return;
            }

            document.getElementById('editFundNameOriginal').value = fundName;
            document.getElementById('editFundNameInput').value = fundName;

            // Populate tags
            populateEditFundTagsDatalist();
            setEditFundTags(fundNameObj.tags || []);

            document.getElementById('editFundNameModal').classList.add('show');
        }

        function closeEditFundNameModal() {
            document.getElementById('editFundNameModal').classList.remove('show');
        }

        // Tag management for Edit Fund Name modal
        function addEditFundTag(tagName) {
            const container = document.getElementById('editFundTagsContainer');
            const tag = document.createElement('span');
            tag.className = 'tag';
            tag.innerHTML = `${escapeHtml(tagName)}<span class="tag-remove" data-action="removeTag">×</span>`;
            tag.setAttribute('data-tag', tagName);
            container.appendChild(tag);

            populateEditFundTagsDatalist();
        }

        function removeEditFundTag(button) {
            const tag = button.closest('.tag');
            if (tag) {
                tag.remove();
            }
        }

        function getEditFundTags() {
            const container = document.getElementById('editFundTagsContainer');
            const tagElements = container.querySelectorAll('.tag');
            return Array.from(tagElements).map(tag => tag.getAttribute('data-tag'));
        }

        function setEditFundTags(tagArray) {
            const container = document.getElementById('editFundTagsContainer');
            container.innerHTML = '';
            if (Array.isArray(tagArray)) {
                tagArray.forEach(tagName => addEditFundTag(tagName));
            }
        }

        function populateEditFundTagsDatalist() {
            const datalist = document.getElementById('editFundTagsDatalist');
            datalist.innerHTML = '';

            // Collect all unique tags from all fund names
            const allTags = new Set();
            fundNameData.forEach(fundNameObj => {
                if (fundNameObj.tags) {
                    fundNameObj.tags.forEach(tag => allTags.add(tag));
                }
            });

            allTags.forEach(tag => {
                const option = document.createElement('option');
                option.value = tag;
                datalist.appendChild(option);
            });
        }

        // Save edited fund name
        async function saveEditedFundName() {
            const oldName = document.getElementById('editFundNameOriginal').value;
            const newName = document.getElementById('editFundNameInput').value.trim();
            const tags = getEditFundTags();

            if (!newName) {
                showStatus('Fund name cannot be empty', 'error');
                return;
            }

            if (fundNames.has(newName) && newName !== oldName) {
                showStatus('Fund name already exists', 'error');
                return;
            }

            try {
                showLoading('Updating fund name...');

                const oldFundNameObj = fundNameData.get(oldName);
                const newFundNameObj = { name: newName, tags };

                // If name changed, update all funds that use this name
                if (newName !== oldName) {
                    const funds = await getAllFunds();
                    const fundsToUpdate = funds.filter(f => f.fundName === oldName);

                    const updateErrors = [];
                    for (const fund of fundsToUpdate) {
                        try {
                            fund.fundName = newName;
                            await saveFundToDB(fund);
                        } catch (err) {
                            updateErrors.push(fund.accountNumber);
                            console.error(`Failed to update fund ${fund.accountNumber}:`, err);
                        }
                    }

                    if (updateErrors.length > 0) {
                        throw new Error(`Failed to update ${updateErrors.length} fund(s): ${updateErrors.join(', ')}`);
                    }

                    // Delete old name and save new name with tags
                    await deleteFundName(oldName);
                    await saveFundName(newFundNameObj);

                    // Save undo action (store the rename operation)
                    await saveUndoAction('update', 'fundName', oldFundNameObj, newFundNameObj);

                    fundNames.delete(oldName);
                    fundNames.add(newName);
                    fundNameData.delete(oldName);
                    fundNameData.set(newName, newFundNameObj);

                    // Clear metrics cache
                    AppState.clearMetricsCache();

                    await renderTable();
                    showStatus(`Fund name updated successfully (${fundsToUpdate.length} fund(s) updated)`);
                } else {
                    // Just update tags
                    await saveFundName(newFundNameObj);

                    // Save undo action
                    await saveUndoAction('update', 'fundName', oldFundNameObj, newFundNameObj);

                    fundNameData.set(newName, newFundNameObj);
                    await renderTable();
                    showStatus('Tags updated successfully');
                }

                closeEditFundNameModal();
                await loadFundNamesList();
            } catch (err) {
                showStatus('Error updating fund name: ' + err.message, 'error');
                console.error(err);
            } finally {
                hideLoading();
            }
        }

        async function removeFundName(name) {
            if (!confirm(`Are you sure you want to delete "${name}"? This will not delete funds using this name.`)) {
                return;
            }

            try {
                const fundNameObj = fundNameData.get(name);

                // Save undo action before deleting
                await saveUndoAction('delete', 'fundName', fundNameObj, null);

                await deleteFundName(name);
                fundNames.delete(name);
                fundNameData.delete(name);
                await loadFundNamesList();
                showStatus('Fund name deleted successfully (Undo available)', 'success');
            } catch (err) {
                showStatus('Error deleting fund name: ' + err.message, 'error');
            }
        }

        // ===========================
        // Manage Groups Modal Functions
        // ===========================

        async function showManageGroupsModal() {
            await loadGroupsList();
            await populateGroupParentDropdown();
            document.getElementById('manageGroupsModal').classList.add('show');
        }

        function closeManageGroupsModal() {
            document.getElementById('manageGroupsModal').classList.remove('show');
        }

        async function loadGroupsList() {
            try {
                groups = await getAllGroups();
                const container = document.getElementById('groupsList');
                container.innerHTML = '';

                if (groups.length === 0) {
                    container.innerHTML = '<p style="color: #95A5A6;">No groups yet</p>';
                    return;
                }

                // Build hierarchical tree
                const tree = buildGroupsTree(groups, null);
                renderGroupsTree(container, tree, 0);
            } catch (err) {
                showStatus('Error loading groups: ' + err.message, 'error');
            }
        }

        function buildGroupsTree(allGroups, parentId) {
            return allGroups
                .filter(g => g.parentGroupId === parentId)
                .sort((a, b) => a.name.localeCompare(b.name))
                .map(group => ({
                    ...group,
                    children: buildGroupsTree(allGroups, group.id)
                }));
        }

        function renderGroupsTree(container, tree, level) {
            tree.forEach(group => {
                const div = document.createElement('div');
                div.className = `group-item level-${Math.min(level, 3)}`;

                const typeText = group.type ? `<span class="group-item-type">(${escapeHtml(group.type)})</span>` : '';

                div.innerHTML = `
                    <div class="group-item-info">
                        <span>${escapeHtml(group.name)}</span>
                        ${typeText}
                    </div>
                    <div class="group-item-actions">
                        <button class="btn-icon group-edit-btn" data-group-id="${group.id}" title="Edit">✎</button>
                        <button class="btn-icon group-delete-btn" data-group-id="${group.id}" title="Delete" style="color: #E74C3C;">×</button>
                    </div>
                `;
                container.appendChild(div);

                // Recursively render children
                if (group.children && group.children.length > 0) {
                    renderGroupsTree(container, group.children, level + 1);
                }
            });
        }

        async function populateGroupParentDropdown() {
            const select = document.getElementById('newGroupParent');
            const editId = document.getElementById('editGroupId').value;

            try {
                groups = await getAllGroups();

                select.innerHTML = '<option value="">None (Top Level)</option>';

                // If editing, exclude the group being edited and its descendants
                let excludeIds = [];
                if (editId) {
                    excludeIds = await getAllDescendantGroupIds(parseInt(editId));
                }

                // Build hierarchical options
                const tree = buildGroupsTree(groups, null);
                addGroupOptionsToSelect(select, tree, 0, excludeIds);
            } catch (err) {
                console.error('Error populating group parent dropdown:', err);
            }
        }

        function addGroupOptionsToSelect(select, tree, level, excludeIds = []) {
            tree.forEach(group => {
                // Skip excluded groups (the group being edited and its descendants)
                if (excludeIds.includes(group.id)) {
                    return;
                }
                const option = document.createElement('option');
                option.value = group.id;
                // Use increasing dashes to show hierarchy depth
                const prefix = level > 0 ? '–'.repeat(level) + ' ' : '';
                option.textContent = prefix + group.name;
                select.appendChild(option);

                // Recursively add children
                if (group.children && group.children.length > 0) {
                    addGroupOptionsToSelect(select, group.children, level + 1, excludeIds);
                }
            });
        }

        async function saveGroupChanges() {
            const name = document.getElementById('newGroupName').value.trim();
            const parentId = document.getElementById('newGroupParent').value;
            const type = document.getElementById('newGroupType').value.trim();
            const editId = document.getElementById('editGroupId').value;

            if (!name) {
                showStatus('Please enter a group name', 'error');
                return;
            }

            // Validate circular reference prevention
            if (editId && parentId) {
                const groupId = parseInt(editId);
                const parentGroupId = parseInt(parentId);

                // Use improved circular reference detection
                const allGroups = await getAllGroups();
                if (wouldCreateCircularReference(groupId, parentGroupId, allGroups)) {
                    showStatus('Error: This would create a circular reference in the group hierarchy', 'error');
                    return;
                }
            }

            try {
                const groupData = {
                    name,
                    parentGroupId: parentId ? parseInt(parentId) : null,
                    type: type || null
                };

                // Save undo history for updates
                let beforeState = null;
                if (editId) {
                    groupData.id = parseInt(editId);
                    beforeState = await getGroupById(parseInt(editId));
                }

                const savedId = await saveGroup(groupData);

                // Save undo action
                if (editId) {
                    await saveUndoAction('update', 'group', beforeState, groupData);
                } else {
                    await saveUndoAction('create', 'group', null, { ...groupData, id: savedId });
                }

                // Clear group descendants cache since hierarchy changed
                AppState.groupDescendantsCache.clear();

                // Reset form
                cancelGroupEdit();

                await loadGroupsList();
                await populateGroupParentDropdown();

                // Update the main filter dropdowns
                await renderTable();

                showStatus(editId ? 'Group updated successfully' : 'Group added successfully');
            } catch (err) {
                showStatus('Error saving group: ' + err.message, 'error');
            }
        }

        async function editGroup(id) {
            const group = groups.find(g => g.id === id);
            if (!group) return;

            // Set edit ID first
            document.getElementById('editGroupId').value = id;

            // Refresh parent dropdown (will now exclude this group and descendants)
            await populateGroupParentDropdown();

            // Populate form fields
            document.getElementById('newGroupName').value = group.name;
            document.getElementById('newGroupParent').value = group.parentGroupId || '';
            document.getElementById('newGroupType').value = group.type || '';

            // Update UI
            document.getElementById('groupFormTitle').textContent = 'Edit Group';
            document.getElementById('saveGroupBtn').textContent = 'Update Group';
            document.getElementById('cancelEditBtn').style.display = 'inline-block';

            // Scroll to top of modal
            document.querySelector('#manageGroupsModal .modal-content').scrollTop = 0;
        }

        function cancelGroupEdit() {
            // Clear form
            document.getElementById('newGroupName').value = '';
            document.getElementById('newGroupParent').value = '';
            document.getElementById('newGroupType').value = '';
            document.getElementById('editGroupId').value = '';

            // Reset UI
            document.getElementById('groupFormTitle').textContent = 'Add New Group';
            document.getElementById('saveGroupBtn').textContent = 'Add Group';
            document.getElementById('cancelEditBtn').style.display = 'none';
        }

        async function removeGroup(id) {
            const group = groups.find(g => g.id === id);
            if (!group) return;

            // Check if group has children
            const children = await getGroupsByParent(id);
            if (children.length > 0) {
                showStatus('Cannot delete group with subgroups. Delete subgroups first.', 'error');
                return;
            }

            // Check if any funds use this group
            const funds = await getAllFunds();
            const fundsInGroup = funds.filter(f => f.groupId === id);
            if (fundsInGroup.length > 0) {
                if (!confirm(`This group contains ${fundsInGroup.length} fund(s). Deleting the group will remove the group assignment from these funds. Continue?`)) {
                    return;
                }

                // Remove groupId from affected funds
                for (const fund of fundsInGroup) {
                    fund.groupId = null;
                    await saveFundToDB(fund);
                }
            }

            try {
                // Save undo action before deleting
                await saveUndoAction('delete', 'group', group, null);

                await deleteGroup(id);

                // Clear cache
                AppState.groupDescendantsCache.clear();

                await loadGroupsList();
                await populateGroupParentDropdown();
                await renderTable();
                showStatus('Group deleted successfully (Undo available)', 'success');
            } catch (err) {
                showStatus('Error deleting group: ' + err.message, 'error');
            }
        }

        async function populateFundGroupDropdown(valueToSet = null) {
            const select = document.getElementById('fundGroup');

            try {
                groups = await getAllGroups();

                select.innerHTML = '<option value="">No Group</option>';

                // Build hierarchical options
                const tree = buildGroupsTree(groups, null);
                addGroupOptionsToSelect(select, tree, 0);

                // Set the value if provided
                if (valueToSet) {
                    select.value = valueToSet;
                }
            } catch (err) {
                console.error('Error populating fund group dropdown:', err);
            }
        }

        async function populateFundNamesDropdown(valueToSet = null) {
            const select = document.getElementById('fundName');
            const currentValue = valueToSet !== null ? valueToSet : select.value;

            try {
                const names = await getAllFundNames();
                console.log('Fund names from database:', names);
                fundNames = new Set(names);

                select.innerHTML = '<option value="">Select a fund</option>';
                names.forEach(name => {
                    const option = document.createElement('option');
                    option.value = name;
                    option.textContent = name;
                    select.appendChild(option);
                });

                // Add option to create new fund
                const newOption = document.createElement('option');
                newOption.value = '__new__';
                newOption.textContent = '+ Add New Fund Name';
                select.appendChild(newOption);

                if (currentValue && currentValue !== '__new__') {
                    select.value = currentValue;
                }

                console.log('Dropdown populated with', names.length, 'fund names');

                // Handle new fund name creation
                select.onchange = async function() {
                    if (this.value === '__new__') {
                        const newName = prompt('Enter new fund name:');
                        if (newName && newName.trim()) {
                            const name = newName.trim();

                            // Validate fund name
                            if (name.length > 100) {
                                showStatus('Fund name too long (max 100 characters)', 'error');
                                this.value = '';
                                return;
                            }

                            if (name.length < 2) {
                                showStatus('Fund name too short (min 2 characters)', 'error');
                                this.value = '';
                                return;
                            }

                            if (!fundNames.has(name)) {
                                try {
                                    await saveFundName(name);
                                    fundNames.add(name);
                                    await populateFundNamesDropdown(name);
                                    showStatus('Fund name added successfully');
                                } catch (err) {
                                    showStatus('Error adding fund name: ' + err.message, 'error');
                                    this.value = '';
                                }
                            } else {
                                select.value = name;
                            }
                        } else {
                            this.value = '';
                        }
                    }
                };
            } catch (err) {
                console.error('Error populating fund names:', err);
            }
        }

        // ===========================
        // Import / Export
        // ===========================

        async function exportDatabase() {
            try {
                const funds = await getAllFunds();
                const fundNamesData = await getAllFundNameObjects(); // Get full objects with tags
                const groupsData = await getAllGroups();

                const exportData = {
                    funds,
                    fundNames: fundNamesData, // Export full objects instead of just names
                    groups: groupsData,
                    exportDate: new Date().toISOString()
                };

                const dataStr = JSON.stringify(exportData, null, 2);
                const blob = new Blob([dataStr], { type: 'application/json' });
                const timestamp = new Date().toISOString().replace(/[:.]/g, '-');
                const filename = `pe-funds-export-${timestamp}.json`;

                if ('showSaveFilePicker' in window) {
                    try {
                        const handle = await window.showSaveFilePicker({
                            suggestedName: filename,
                            types: [{
                                description: 'JSON Files',
                                accept: { 'application/json': ['.json'] }
                            }]
                        });

                        const writable = await handle.createWritable();
                        await writable.write(blob);
                        await writable.close();

                        showStatus('Data exported successfully');
                        return;
                    } catch (err) {
                        if (err.name === 'AbortError') return;
                        throw err;
                    }
                }

                // Fallback
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = filename;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);

                showStatus('Data exported successfully');
                updateLastBackupTime();
            } catch (err) {
                showStatus('Error exporting data: ' + err.message, 'error');
                console.error(err);
            }
        }

        async function exportToCSV() {
            showLoading('Exporting to CSV...');
            try {
                // Get filtered and sorted data (same as what's displayed in the table)
                const funds = await getAllFunds();
                let filtered = applyCurrentFilters(funds);

                if (sortColumns.length > 0) {
                    filtered = sortData(filtered, sortColumns);
                }

                // Get cutoff date
                const cutoffDateValue = document.getElementById('cutoffDate').value;
                const cutoffDate = cutoffDateValue ? new Date(cutoffDateValue) : null;

                // Calculate metrics for each fund
                const fundsWithMetrics = filtered.map(fund => ({
                    ...fund,
                    metrics: calculateMetrics(fund, cutoffDate)
                }));

                // Create CSV header
                const headers = [
                    'Fund Name',
                    'Account Number',
                    'Vintage',
                    'Commitment',
                    'Total Contributions',
                    'Total Distributions',
                    'NAV',
                    'Investment Return',
                    'MOIC',
                    'IRR',
                    'Outstanding Commitment'
                ];

                // Use the sanitization function defined earlier (no need to redefine)

                // Helper to format number without $ symbol for CSV
                const formatNumber = (value) => {
                    const val = parseFloat(value);
                    if (!isFinite(val) || isNaN(val)) return '';
                    return val.toFixed(2);
                };

                // Create CSV rows with sanitization
                const rows = fundsWithMetrics.map(fund => {
                    const m = fund.metrics;
                    return [
                        escapeCSV(fund.fundName),
                        escapeCSV(fund.accountNumber),
                        escapeCSV(m.vintage || ''),
                        sanitizeForCSV(formatNumber(m.commitment)),
                        sanitizeForCSV(formatNumber(m.totalContributions)),
                        sanitizeForCSV(formatNumber(m.totalDistributions)),
                        sanitizeForCSV(formatNumber(m.nav)),
                        sanitizeForCSV(formatNumber(m.investmentReturn)),
                        sanitizeForCSV(m.moic !== null && isFinite(m.moic) ? m.moic.toFixed(2) : ''),
                        sanitizeForCSV(m.irr !== null ? (m.irr * 100).toFixed(2) : ''),
                        sanitizeForCSV(formatNumber(m.outstandingCommitment))
                    ].join(',');
                });

                // Combine header and rows
                const csv = [headers.join(','), ...rows].join('\n');

                // Create blob and download
                const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
                const timestamp = new Date().toISOString().replace(/[:.]/g, '-').split('T')[0];
                const filename = `pe-funds-export-${timestamp}.csv`;

                // Create download link
                const link = document.createElement('a');
                if (link.download !== undefined) {
                    const url = URL.createObjectURL(blob);
                    link.setAttribute('href', url);
                    link.setAttribute('download', filename);
                    link.style.visibility = 'hidden';
                    document.body.appendChild(link);
                    link.click();
                    document.body.removeChild(link);
                    URL.revokeObjectURL(url);
                }

                showStatus('CSV exported successfully');
            } catch (err) {
                showStatus('Error exporting CSV: ' + err.message, 'error');
                console.error(err);
            } finally {
                hideLoading();
            }
        }

        function exportToPDF() {
            // Use the browser's print dialog to save as PDF
            window.print();
        }

        // Event delegation for dynamically created buttons and dropdown handling
        document.addEventListener('click', function(event) {
            // Handle fund actions button
            if (event.target.classList.contains('fund-actions-btn')) {
                event.stopPropagation(); // Prevent immediate close
                const fundId = parseInt(event.target.getAttribute('data-fund-id'));
                showActionModal(fundId, event.target);
                return;
            }

            // Close action dropdown when clicking outside
            const actionDropdown = document.getElementById('actionDropdown');
            if (actionDropdown && actionDropdown.classList.contains('show')) {
                if (!actionDropdown.contains(event.target)) {
                    closeActionModal();
                }
            }

            // Handle group edit button
            if (event.target.classList.contains('group-edit-btn')) {
                const groupId = parseInt(event.target.getAttribute('data-group-id'));
                editGroup(groupId);
                return;
            }

            // Handle group delete button
            if (event.target.classList.contains('group-delete-btn')) {
                const groupId = parseInt(event.target.getAttribute('data-group-id'));
                removeGroup(groupId);
                return;
            }

            // Close dropdown when clicking outside
            const dropdowns = document.querySelectorAll('.dropdown');
            dropdowns.forEach(dropdown => {
                if (!dropdown.contains(event.target)) {
                    const menu = dropdown.querySelector('.dropdown-menu');
                    if (menu) {
                        menu.classList.remove('show');
                    }
                }
            });
        });

        // Track changes in details modal
        document.addEventListener('input', function(event) {
            const detailsModal = document.getElementById('detailsModal');
            if (detailsModal && detailsModal.classList.contains('show')) {
                if (detailsModal.contains(event.target)) {
                    hasUnsavedChanges = true;
                }
            }
        });

        // Keyboard shortcuts
        document.addEventListener('keydown', function(event) {
            // Check if user is typing in an input field
            const isTyping = ['INPUT', 'TEXTAREA', 'SELECT'].includes(event.target.tagName);

            // ? key: Show keyboard shortcuts help (only if not typing)
            if (event.key === '?' && !isTyping) {
                event.preventDefault();
                showShortcutsModal();
                return;
            }

            // Escape key: Close sidebar or open modals
            if (event.key === 'Escape') {
                const sidebar = document.getElementById('sidebar');
                const shortcutsModal = document.getElementById('shortcutsModal');
                const detailsModal = document.getElementById('detailsModal');
                const actionDropdown = document.getElementById('actionDropdown');
                const fundModal = document.getElementById('fundModal');
                const manageFundsModal = document.getElementById('manageFundNamesModal');
                const editFundNameModal = document.getElementById('editFundNameModal');
                const manageGroupsModal = document.getElementById('manageGroupsModal');

                if (shortcutsModal && shortcutsModal.classList.contains('show')) {
                    closeShortcutsModal();
                } else if (sidebar && sidebar.classList.contains('show')) {
                    closeSidebar();
                } else if (detailsModal && detailsModal.classList.contains('show')) {
                    closeDetailsModal();
                } else if (actionDropdown && actionDropdown.classList.contains('show')) {
                    closeActionModal();
                } else if (fundModal && fundModal.classList.contains('show')) {
                    closeFundModal();
                } else if (editFundNameModal && editFundNameModal.classList.contains('show')) {
                    closeEditFundNameModal();
                } else if (manageFundsModal && manageFundsModal.classList.contains('show')) {
                    closeManageFundsModal();
                } else if (manageGroupsModal && manageGroupsModal.classList.contains('show')) {
                    closeManageGroupsModal();
                }
                return;
            }

            // Ctrl/Cmd+F: Focus search input
            if ((event.ctrlKey || event.metaKey) && event.key === 'f') {
                event.preventDefault();
                const searchInput = document.getElementById('searchInput');
                if (searchInput) {
                    searchInput.focus();
                    searchInput.select();
                }
                return;
            }

            // Ctrl/Cmd+S: Save details if details modal is open
            if ((event.ctrlKey || event.metaKey) && event.key === 's') {
                event.preventDefault();
                const detailsModal = document.getElementById('detailsModal');
                if (detailsModal && detailsModal.classList.contains('show')) {
                    saveDetailsChanges();
                }
                return;
            }

            // Ctrl/Cmd+Z: Undo
            if ((event.ctrlKey || event.metaKey) && event.key === 'z' && !event.shiftKey) {
                event.preventDefault();
                undoLastAction();
                return;
            }

            // Ctrl/Cmd+Shift+Z or Ctrl/Cmd+Y: Redo
            if ((event.ctrlKey || event.metaKey) && ((event.key === 'z' && event.shiftKey) || event.key === 'y')) {
                event.preventDefault();
                redoLastAction();
                return;
            }

            // Ctrl/Cmd+E: Export
            if ((event.ctrlKey || event.metaKey) && event.key === 'e') {
                event.preventDefault();
                exportDatabase();
                return;
            }

            // Ctrl/Cmd+N: New investment
            if ((event.ctrlKey || event.metaKey) && event.key === 'n') {
                event.preventDefault();
                showAddFundModal();
                return;
            }
        });

        async function importDatabase(event) {
            const file = event.target.files[0];
            if (!file) return;

            // Validate file size (max 50MB)
            const maxSize = 50 * 1024 * 1024; // 50MB in bytes
            if (file.size > maxSize) {
                showStatus(`File too large (${(file.size / 1024 / 1024).toFixed(2)}MB). Maximum size is 50MB.`, 'error');
                event.target.value = '';
                return;
            }

            showLoading('Importing data...');
            try {
                const text = await file.text();
                const data = JSON.parse(text);

                let imported = 0;
                const oldGroupIdToNew = {}; // Map old group IDs to new ones

                // Import groups first (since funds may reference them)
                if (data.groups && Array.isArray(data.groups)) {
                    // Validate group hierarchy before importing
                    const groupIds = new Set(data.groups.map(g => g.id));

                    // Check for invalid parent references and circular dependencies
                    for (const group of data.groups) {
                        if (group.parentGroupId != null) {
                            // Check if parent exists in import data
                            if (!groupIds.has(group.parentGroupId)) {
                                console.warn(`Warning: Group "${group.name}" (ID ${group.id}) references non-existent parent ${group.parentGroupId}. Setting to top-level.`);
                                group.parentGroupId = null;
                            }

                            // Check for circular reference (direct self-reference)
                            if (group.id === group.parentGroupId) {
                                console.warn(`Warning: Group "${group.name}" (ID ${group.id}) has circular reference. Setting to top-level.`);
                                group.parentGroupId = null;
                            }
                        }
                    }

                    // Import groups sorted by hierarchy (parents before children)
                    const sortedGroups = [];
                    const addedIds = new Set();
                    let remainingGroups = [...data.groups];

                    // Keep adding groups whose parents have been added (or are null)
                    while (remainingGroups.length > 0) {
                        const initialLength = remainingGroups.length;

                        for (let i = remainingGroups.length - 1; i >= 0; i--) {
                            const group = remainingGroups[i];
                            if (group.parentGroupId == null || addedIds.has(group.parentGroupId)) {
                                sortedGroups.push(group);
                                addedIds.add(group.id);
                                remainingGroups.splice(i, 1);
                            }
                        }

                        // If no groups were added this iteration, we have circular dependencies
                        if (remainingGroups.length === initialLength) {
                            console.warn('Warning: Circular dependencies detected in remaining groups. Setting to top-level.');
                            remainingGroups.forEach(g => {
                                g.parentGroupId = null;
                                sortedGroups.push(g);
                            });
                            break;
                        }
                    }

                    // Import sorted groups
                    for (const group of sortedGroups) {
                        const oldId = group.id;
                        const { id, ...groupData } = group;

                        // Map parent ID to new ID if it was already imported
                        if (groupData.parentGroupId != null && oldGroupIdToNew[groupData.parentGroupId]) {
                            groupData.parentGroupId = oldGroupIdToNew[groupData.parentGroupId];
                        }

                        // Save group and get new ID
                        const newId = await saveGroup(groupData);
                        if (oldId != null && newId) {
                            oldGroupIdToNew[oldId] = newId;
                        }
                    }
                    // Reload groups cache
                    groups = await getAllGroups();
                }

                // Import fund names (now with tags)
                if (data.fundNames && Array.isArray(data.fundNames)) {
                    for (const fundNameItem of data.fundNames) {
                        // Support both old format (string) and new format (object with tags)
                        const fundNameObj = typeof fundNameItem === 'string'
                            ? { name: fundNameItem, tags: [] }
                            : { name: fundNameItem.name, tags: fundNameItem.tags || [] };

                        await saveFundName(fundNameObj);
                        fundNames.add(fundNameObj.name);
                        fundNameData.set(fundNameObj.name, fundNameObj);
                    }
                }

                // Import funds
                const fundsToImport = data.funds || data;
                if (!Array.isArray(fundsToImport)) {
                    throw new Error('Invalid format: expected array of funds');
                }

                // Collect unique fund names from imported funds (in case fundNames array is missing)
                const uniqueFundNames = new Set();
                fundsToImport.forEach(fund => {
                    if (fund.fundName && !fundNames.has(fund.fundName)) {
                        uniqueFundNames.add(fund.fundName);
                    }
                });

                // Save any missing fund names to database
                for (const name of uniqueFundNames) {
                    const fundNameObj = { name, tags: [] };
                    await saveFundName(fundNameObj);
                    fundNames.add(name);
                    fundNameData.set(name, fundNameObj);
                }

                const totalFunds = fundsToImport.length;
                const failedImports = [];

                for (let i = 0; i < fundsToImport.length; i++) {
                    const fund = fundsToImport[i];
                    try {
                        // Normalize cash flows to ensure proper structure
                        const cashFlows = (fund.cashFlows || []).map(cf => ({
                            date: cf.date,
                            amount: parseCurrency(cf.amount),
                            type: cf.type || (cf.amount < 0 ? 'Contribution' : 'Distribution'),
                            affectsCommitment: cf.affectsCommitment !== undefined ? cf.affectsCommitment : true
                        }));

                        // Normalize monthly NAV
                        const monthlyNav = (fund.monthlyNav || []).map(nav => ({
                            date: nav.date,
                            amount: parseCurrency(nav.amount)
                        }));

                        // Map old groupId to new groupId if applicable
                        let groupId = null;
                        if (fund.groupId && oldGroupIdToNew[fund.groupId]) {
                            groupId = oldGroupIdToNew[fund.groupId];
                        }

                        const fundData = {
                            fundName: fund.fundName,
                            accountNumber: fund.accountNumber,
                            groupId: groupId,
                            commitment: parseCurrency(fund.commitment),
                            cashFlows: cashFlows,
                            monthlyNav: monthlyNav,
                            timestamp: fund.timestamp || new Date().toISOString()
                        };

                        await saveFundToDB(fundData);
                        imported++;
                    } catch (fundErr) {
                        console.error(`Error importing fund at index ${i}:`, fundErr, fund);
                        failedImports.push({ index: i, name: fund.fundName || fund.accountNumber || 'Unknown', error: fundErr.message });
                    }
                }

                await renderTable();

                if (failedImports.length > 0) {
                    const failedCount = failedImports.length;
                    showStatus(`Partial import: ${imported}/${totalFunds} funds imported. ${failedCount} failed (see console for details)`, 'error');
                    console.error('Failed imports:', failedImports);
                    // Don't clear input on partial failure
                } else {
                    showStatus(`Successfully imported ${imported} fund(s)`);
                    event.target.value = '';
                }
            } catch (err) {
                showStatus('Error importing data: ' + err.message, 'error');
                console.error(err);
                // Don't clear input on error so user can retry
            } finally {
                hideLoading();
            }
        }

        // ===========================
        // Column Resizing
        // ===========================

        function initializeColumnResizing() {
            const table = document.getElementById('fundsTable');
            const thead = table.querySelector('thead');
            const ths = thead.querySelectorAll('th');

            // Add resizer to each column header except the last one (Actions column)
            ths.forEach((th, index) => {
                if (index < ths.length - 1) { // Skip the last column
                    th.classList.add('resizable');

                    // Create resizer element
                    const resizer = document.createElement('div');
                    resizer.className = 'resizer';
                    th.appendChild(resizer);

                    // Prevent click events on resizer from triggering sort
                    resizer.addEventListener('click', (e) => {
                        e.stopPropagation();
                        e.preventDefault();
                    });

                    // Variables for resizing
                    let startX, startWidth;

                    resizer.addEventListener('mousedown', (e) => {
                        e.stopPropagation(); // Prevent sort trigger
                        e.preventDefault(); // Prevent text selection
                        startX = e.pageX;
                        startWidth = th.offsetWidth;

                        isResizingColumn = true;
                        th.classList.add('resizing');
                        document.body.style.cursor = 'col-resize';
                        document.body.style.userSelect = 'none';

                        const onMouseMove = (e) => {
                            const diff = e.pageX - startX;
                            const newWidth = Math.max(CONFIG.MIN_COLUMN_WIDTH, startWidth + diff);
                            th.style.width = newWidth + 'px';
                            th.style.minWidth = newWidth + 'px';
                            th.style.maxWidth = newWidth + 'px';

                            // Also set width on corresponding td elements
                            const columnIndex = Array.from(ths).indexOf(th);
                            const tds = table.querySelectorAll(`tbody tr td:nth-child(${columnIndex + 1})`);
                            tds.forEach(td => {
                                td.style.width = newWidth + 'px';
                                td.style.minWidth = newWidth + 'px';
                                td.style.maxWidth = newWidth + 'px';
                            });

                            // Save to localStorage
                            saveColumnWidth(columnIndex, newWidth);
                        };

                        const onMouseUp = () => {
                            th.classList.remove('resizing');
                            document.body.style.cursor = '';
                            document.body.style.userSelect = '';
                            document.removeEventListener('mousemove', onMouseMove);
                            document.removeEventListener('mouseup', onMouseUp);
                            document.removeEventListener('blur', onMouseUp); // Clean up blur listener
                            // Reset flag after a short delay so click handler can check it
                            setTimeout(() => { isResizingColumn = false; }, 50);
                        };

                        const cleanup = () => {
                            // Ensure cleanup happens even if mouse leaves window
                            if (th.classList.contains('resizing')) {
                                onMouseUp();
                            }
                        };

                        document.addEventListener('mousemove', onMouseMove);
                        document.addEventListener('mouseup', onMouseUp);
                        window.addEventListener('blur', cleanup); // Handle tab switch/window blur
                    });
                }
            });

            // Restore saved column widths
            restoreColumnWidths();
        }

        /**
         * Save column width to localStorage
         * @param {number} columnIndex - Column index
         * @param {number} width - Column width in pixels
         */
        function saveColumnWidth(columnIndex, width) {
            const savedWidths = Storage.get(CONFIG.STORAGE_COLUMN_WIDTHS, {});
            savedWidths[columnIndex] = width;
            Storage.set(CONFIG.STORAGE_COLUMN_WIDTHS, savedWidths);
        }

        /**
         * Restore saved column widths from localStorage
         */
        function restoreColumnWidths() {
            const savedWidths = Storage.get(CONFIG.STORAGE_COLUMN_WIDTHS, {});
            const table = document.getElementById('fundsTable');
            const ths = table.querySelectorAll('thead th');

            Object.keys(savedWidths).forEach(columnIndex => {
                const width = savedWidths[columnIndex];
                const th = ths[columnIndex];
                if (th) {
                    th.style.width = width + 'px';
                    th.style.minWidth = width + 'px';
                    th.style.maxWidth = width + 'px';

                    // Also set width on corresponding td elements
                    const tds = table.querySelectorAll(`tbody tr td:nth-child(${parseInt(columnIndex) + 1})`);
                    tds.forEach(td => {
                        td.style.width = width + 'px';
                        td.style.minWidth = width + 'px';
                        td.style.maxWidth = width + 'px';
                    });
                }
            });
        }

        // ===========================
        // Backup Warning & Reminders
        // ===========================

        /**
         * Check if backup warning should be shown
         */
        function shouldShowBackupWarning() {
            const warningShown = Storage.get(CONFIG.STORAGE_BACKUP_WARNING, false);
            const lastBackup = Storage.get(CONFIG.STORAGE_LAST_BACKUP, null);

            // Always show if never shown
            if (!warningShown) return true;

            // Show if more than 30 days since last backup
            if (lastBackup) {
                const daysSinceBackup = (Date.now() - new Date(lastBackup).getTime()) / (1000 * 60 * 60 * 24);
                if (daysSinceBackup > 30) return true;
            }

            return false;
        }

        /**
         * Show backup warning modal
         */
        function showBackupWarning() {
            const modal = document.getElementById('backupWarningModal');
            if (modal) {
                modal.classList.add('show');
            }
        }

        /**
         * Close backup warning modal
         */
        function closeBackupWarning() {
            const modal = document.getElementById('backupWarningModal');
            if (modal) {
                modal.classList.remove('show');
            }
        }

        /**
         * Check backup reminder after data changes
         */
        function checkBackupReminder() {
            const lastBackup = Storage.get(CONFIG.STORAGE_LAST_BACKUP, null);
            if (lastBackup) {
                const daysSinceBackup = (Date.now() - new Date(lastBackup).getTime()) / (1000 * 60 * 60 * 24);
                if (daysSinceBackup > 7) {
                    // Show subtle reminder in sidebar
                    const sidebar = document.getElementById('sidebar');
                    if (sidebar && !document.getElementById('backupReminder')) {
                        const reminder = document.createElement('div');
                        reminder.id = 'backupReminder';
                        reminder.style.cssText = 'padding: 10px 20px; background: #FFF3CD; color: #856404; font-size: 12px; border-top: 1px solid #FFEAA7;';
                        reminder.textContent = `⚠️ ${Math.floor(daysSinceBackup)} days since last backup`;
                        sidebar.appendChild(reminder);
                    }
                }
            }
        }

        /**
         * Update last backup timestamp
         */
        function updateLastBackupTime() {
            Storage.set(CONFIG.STORAGE_LAST_BACKUP, new Date().toISOString());
        }

        // ===========================
        // Initialization
        // ===========================

        /**
         * Initialize all event listeners
         * Centralized event listener setup using event delegation where appropriate
         */
        function initializeEventListeners() {
            // Filter controls
            document.getElementById('groupFilter').addEventListener('change', applyFilters);
            document.getElementById('fundFilter').addEventListener('change', applyFilters);
            document.getElementById('accountFilter').addEventListener('change', applyFilters);
            document.getElementById('vintageFilter').addEventListener('change', applyFilters);
            document.getElementById('searchInput').addEventListener('input', applyFilters);
            document.getElementById('cutoffDate').addEventListener('change', applyFilters);
            document.getElementById('resetFiltersBtn').addEventListener('click', resetFilters);

            // Undo/Redo buttons
            document.getElementById('undoBtn').addEventListener('click', undoLastAction);
            document.getElementById('redoBtn').addEventListener('click', redoLastAction);

            // Keyboard shortcuts modal
            document.getElementById('closeShortcutsModalBtn').addEventListener('click', closeShortcutsModal);
            document.getElementById('closeShortcutsModal2Btn').addEventListener('click', closeShortcutsModal);

            document.getElementById('toggleSidebarBtn').addEventListener('click', toggleSidebar);

            // Table header sorting - use event delegation
            const thead = document.querySelector('#fundsTable thead');

            // Track mousedown on resizer to prevent sort on click
            thead.addEventListener('mousedown', (e) => {
                lastMousedownOnResizer = e.target.closest('.resizer') !== null;
            });

            thead.addEventListener('click', (e) => {
                // Skip sorting if mousedown was on resizer, currently resizing, or click target is resizer
                if (lastMousedownOnResizer || isResizingColumn || e.target.closest('.resizer')) {
                    lastMousedownOnResizer = false;
                    return;
                }
                lastMousedownOnResizer = false;
                const th = e.target.closest('th[data-sort]');
                if (th) {
                    const sortColumn = th.getAttribute('data-sort');
                    sortTable(sortColumn);
                }
            });

            // Fund modal
            document.getElementById('closeFundModalBtn').addEventListener('click', closeFundModal);
            document.getElementById('cancelFundModalBtn').addEventListener('click', closeFundModal);
            document.getElementById('fundForm').addEventListener('submit', saveFund);

            // Action dropdown
            document.getElementById('actionEdit').addEventListener('click', (e) => {
                e.preventDefault();
                editFundFromAction();
            });
            document.getElementById('actionDuplicate').addEventListener('click', (e) => {
                e.preventDefault();
                duplicateFundFromAction();
            });
            document.getElementById('actionViewDetails').addEventListener('click', (e) => {
                e.preventDefault();
                showDetailsFromAction();
            });
            document.getElementById('actionDelete').addEventListener('click', (e) => {
                e.preventDefault();
                deleteFundFromAction();
            });

            // Manage funds modal
            document.getElementById('closeManageFundsModalBtn').addEventListener('click', closeManageFundsModal);
            document.getElementById('closeManageFundsModal2Btn').addEventListener('click', closeManageFundsModal);
            document.getElementById('addNewFundNameBtn').addEventListener('click', addNewFundName);

            // Edit fund name modal
            document.getElementById('closeEditFundNameModalBtn').addEventListener('click', closeEditFundNameModal);
            document.getElementById('saveEditedFundNameBtn').addEventListener('click', saveEditedFundName);
            document.getElementById('cancelEditFundNameBtn').addEventListener('click', closeEditFundNameModal);

            // Manage groups modal
            document.getElementById('closeManageGroupsModal2Btn').addEventListener('click', closeManageGroupsModal);
            document.getElementById('closeManageGroupsModalBtn').addEventListener('click', closeManageGroupsModal);
            document.getElementById('saveGroupBtn').addEventListener('click', saveGroupChanges);
            document.getElementById('cancelEditBtn').addEventListener('click', cancelGroupEdit);

            // Details modal
            document.getElementById('closeDetailsModalBtn').addEventListener('click', closeDetailsModal);
            document.getElementById('cancelDetailsModalBtn').addEventListener('click', closeDetailsModal);
            document.getElementById('addCashFlowRowBtn').addEventListener('click', addCashFlowRow);
            document.getElementById('addNavRowBtn').addEventListener('click', addNavRow);
            document.getElementById('saveDetailsChangesBtn').addEventListener('click', saveDetailsChanges);

            // Event delegation for dynamically created delete buttons
            document.getElementById('cashFlowsTable').addEventListener('click', (e) => {
                const btn = e.target.closest('[data-action="deleteCashFlow"]');
                if (btn) {
                    deleteCashFlowRow(btn);
                }
            });

            document.getElementById('navTable').addEventListener('click', (e) => {
                const btn = e.target.closest('[data-action="deleteNav"]');
                if (btn) {
                    deleteNavRow(btn);
                }
            });

            // Event delegation for tag removal
            document.getElementById('editFundTagsContainer').addEventListener('click', (e) => {
                const btn = e.target.closest('[data-action="removeTag"]');
                if (btn) {
                    removeEditFundTag(btn);
                }
            });

            // Backup warning modal
            document.getElementById('closeBackupWarningBtn').addEventListener('click', closeBackupWarning);
            document.getElementById('exportNowBtn').addEventListener('click', () => {
                closeBackupWarning();
                exportDatabase();
                updateLastBackupTime();
            });
            document.getElementById('remindLaterBtn').addEventListener('click', () => {
                const dontShow = document.getElementById('dontShowBackupWarning').checked;
                if (dontShow) {
                    Storage.set(CONFIG.STORAGE_BACKUP_WARNING, true);
                }
                closeBackupWarning();
            });

            // Sidebar
            document.getElementById('sidebarOverlay').addEventListener('click', closeSidebar);
            document.getElementById('closeSidebarBtn').addEventListener('click', closeSidebar);
            document.getElementById('sidebarShowTagsCheckbox').addEventListener('change', toggleTagsDisplay);
            document.getElementById('sidebarDarkModeCheckbox').addEventListener('change', toggleDarkMode);

            // Sidebar menu items
            document.getElementById('sidebarNewInvestment').addEventListener('click', (e) => {
                e.preventDefault();
                closeSidebar();
                showAddFundModal();
            });
            document.getElementById('sidebarManageFunds').addEventListener('click', (e) => {
                e.preventDefault();
                closeSidebar();
                showManageFundsModal();
            });
            document.getElementById('sidebarManageGroups').addEventListener('click', (e) => {
                e.preventDefault();
                closeSidebar();
                showManageGroupsModal();
            });
            document.getElementById('sidebarExportCSV').addEventListener('click', (e) => {
                e.preventDefault();
                closeSidebar();
                exportToCSV();
            });
            document.getElementById('sidebarExportJSON').addEventListener('click', (e) => {
                e.preventDefault();
                closeSidebar();
                exportDatabase();
            });
            document.getElementById('sidebarExportPDF').addEventListener('click', (e) => {
                e.preventDefault();
                closeSidebar();
                exportToPDF();
            });
            document.getElementById('sidebarImportFile').addEventListener('change', (e) => {
                importDatabase(e);
                closeSidebar();
            });
        }

        function setControlsEnabled(enabled) {
            const buttons = document.querySelectorAll('button');
            const inputs = document.querySelectorAll('input, select, textarea');

            inputs.forEach(input => input.disabled = !enabled);
            buttons.forEach(button => button.disabled = !enabled);
        }

        async function init() {
            showLoading('Initializing application...');
            try {
                setControlsEnabled(false);

                await initDB();

                // Load fund name objects (with tags)
                const fundNameObjects = await getAllFundNameObjects();
                fundNames = new Set(fundNameObjects.map(obj => obj.name));
                fundNameData = new Map(fundNameObjects.map(obj => [obj.name, obj]));

                // Load groups
                groups = await getAllGroups();

                // Set default cutoff date to latest quarter end
                const quarterEnd = getLatestQuarterEnd();
                document.getElementById('cutoffDate').value = quarterEnd.toISOString().split('T')[0];

                // Restore tag display preference from localStorage (default: true)
                const showTags = Storage.get('showTags', true);
                document.getElementById('sidebarShowTagsCheckbox').checked = showTags;

                // Initialize dark mode from saved preference
                initializeDarkMode();

                await renderTable();

                // Initialize column resizing
                initializeColumnResizing();

                // Initialize event listeners
                initializeEventListeners();

                // Update undo/redo button states
                await updateUndoRedoButtons();

                setControlsEnabled(true);

                // Show backup warning if needed
                setTimeout(() => {
                    if (shouldShowBackupWarning()) {
                        showBackupWarning();
                    }
                }, 1000); // Delay to not interfere with initial load

                console.log('PE Fund Manager initialized successfully');
            } catch (err) {
                showStatus('Error initializing application: ' + err.message, 'error');
                console.error(err);
            } finally {
                hideLoading();
            }
        }

            if (document.readyState === 'loading') {
                document.addEventListener('DOMContentLoaded', init);
            } else {
                init();
            }
        })();
    </script>
</body>
</html>
