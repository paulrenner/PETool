# Phase 1 Report — System Mapping

**Date:** 2026-01-22
**System:** PE Fund Manager (TypeScript SPA)

---

## Module Map

```
┌─────────────────────────────────────────────────────────────────┐
│                         src/main.ts                             │
│                    (Entry Point + Events)                       │
└───────────────┬─────────────────┬───────────────┬───────────────┘
                │                 │               │
        ┌───────▼───────┐ ┌───────▼───────┐ ┌─────▼─────┐
        │   src/core/   │ │src/calculations│ │ src/app/  │
        │               │ │               │ │           │
        │ • config.ts   │ │ • irr.ts      │ │ • table   │
        │ • state.ts    │ │ • metrics.ts  │ │ • filters │
        │ • db.ts       │ │               │ │ • modals  │
        └───────┬───────┘ └───────┬───────┘ │ • export  │
                │                 │         │ • import  │
                │                 │         │ • bulk    │
                │                 │         │ • timeline│
                │                 │         └─────┬─────┘
                │                 │               │
        ┌───────▼─────────────────▼───────────────▼───────┐
        │                  src/types/                      │
        │  • fund.ts (Fund, CashFlow, Nav)                │
        │  • group.ts (Group)                             │
        │  • state.ts (AppState types)                    │
        │  • audit.ts (Audit types)                       │
        └─────────────────────────────────────────────────┘
```

---

## Data Flow Diagram

```
┌──────────────┐      ┌──────────────┐      ┌──────────────┐
│   IndexedDB  │◄────►│   src/core/  │◄────►│  AppState    │
│  (Persistent)│      │    db.ts     │      │  (Singleton) │
└──────────────┘      └──────────────┘      └──────┬───────┘
                                                   │
                                                   ▼
┌──────────────┐      ┌──────────────┐      ┌──────────────┐
│ User Input   │─────►│  src/app/    │─────►│src/calculations│
│ (Forms/UI)   │      │  modals.ts   │      │  metrics.ts  │
└──────────────┘      └──────────────┘      └──────┬───────┘
                                                   │
                                                   ▼
┌──────────────┐      ┌──────────────┐      ┌──────────────┐
│    DOM       │◄─────│  src/app/    │◄─────│ FundWithMetrics│
│   (Table)    │      │   table.ts   │      │   (Computed) │
└──────────────┘      └──────────────┘      └──────────────┘
```

**Flow Summary:**
1. `init()` loads funds/groups from IndexedDB → AppState
2. User actions trigger modal dialogs → save to IndexedDB
3. `renderTable()` reads AppState → applies filters → calculates metrics → renders DOM
4. Export functions read from AppState/IndexedDB → generate CSV/JSON/PDF

---

## Calculation Pipeline Summary

```
Fund Data (cashFlows[], navs[], commitment)
            │
            ▼
┌───────────────────────────────────┐
│      parseCashFlowsForIRR()       │  ← Converts to IRR-compatible format
│      (src/calculations/metrics.ts)│
└───────────────┬───────────────────┘
                │
                ▼
┌───────────────────────────────────┐
│         calculateIRR()            │  ← Newton-Raphson method
│      (src/calculations/irr.ts)    │
└───────────────┬───────────────────┘
                │
                ▼
┌───────────────────────────────────┐
│       calculateMetrics()          │  ← Orchestrates all metrics
│      (src/calculations/metrics.ts)│
│                                   │
│  Calls:                           │
│  • getTotalByType() → contributions/distributions
│  • getLatestNav() → adjusted NAV  │
│  • calculateMOIC() → MOIC         │
│  • Computes: DPI, RVPI, TVPI      │
└───────────────────────────────────┘
```

**Key Metrics Produced:**
- IRR (Internal Rate of Return)
- MOIC (Multiple on Invested Capital)
- DPI (Distributions to Paid-In)
- RVPI (Residual Value to Paid-In)
- TVPI (Total Value to Paid-In)

---

## Risk Surface Overview

| Area | Risk Level | Notes |
|------|------------|-------|
| **Financial Calculations** | HIGH | IRR/MOIC correctness critical; date handling risks |
| **State Management** | MEDIUM | Singleton pattern; cache invalidation concerns |
| **IndexedDB Persistence** | MEDIUM | Async operations; partial write risk |
| **Import/Export** | MEDIUM | File parsing; data validation required |
| **DOM Rendering** | LOW-MEDIUM | XSS via user data (escaping used) |
| **User Input** | MEDIUM | Form validation; type coercion |

**Key Entry Points for Deeper Review:**
1. `src/calculations/irr.ts` — IRR algorithm correctness
2. `src/calculations/metrics.ts` — Metric aggregation logic
3. `src/core/db.ts` — Data normalization, IndexedDB transactions
4. `src/app/import.ts` — External data parsing
5. `src/utils/escaping.ts` — XSS prevention

---

## Module Responsibilities

| Module | Primary Responsibility |
|--------|------------------------|
| `main.ts` | App initialization, event binding, render orchestration |
| `core/config.ts` | Application constants |
| `core/state.ts` | AppState singleton (funds, groups, cache, UI state) |
| `core/db.ts` | IndexedDB CRUD, data normalization |
| `calculations/irr.ts` | IRR and MOIC calculation |
| `calculations/metrics.ts` | All fund metrics computation |
| `app/table.ts` | Table rendering, sorting, totals |
| `app/filters.ts` | Multi-select filters, cascading logic |
| `app/modals.ts` | All modal dialogs (add/edit fund, details, groups) |
| `app/export.ts` | CSV, JSON, PDF export |
| `app/import.ts` | JSON import with preview |
| `app/bulk.ts` | Bulk operations (cash flow, group assignment) |
| `app/timeline.ts` | Timeline visualization |

---

## Phase 1 Complete

**Next:** Phase 2 — Financial Engine Audit (src/calculations/irr.ts, src/calculations/metrics.ts, src/types/fund.ts)
