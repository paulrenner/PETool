# Phase 2 Report — Financial Engine Audit

**Date:** 2026-01-22
**Files Reviewed:**
- `src/calculations/irr.ts` (86 lines)
- `src/calculations/metrics.ts` (226 lines)
- `src/types/fund.ts` (142 lines)

---

## Financial Risk Register

| ID | File:Line | Severity | Issue | Impact |
|----|-----------|----------|-------|--------|
| FIN-001 | irr.ts:21,25,30,37 | **HIGH** | Date parsing without timezone handling | IRR calculation may use wrong dates |
| FIN-002 | metrics.ts:109-113 | **MEDIUM** | Distributions add to outstanding commitment | May overstate unfunded commitment |
| FIN-003 | irr.ts:30,37 | **LOW** | Year calculation uses 365.25 | Minor precision vs actual/actual |
| FIN-004 | metrics.ts:35,67,107,131 | **MEDIUM** | parseCurrency on amounts suggests string storage | Silent parse failures possible |
| FIN-005 | metrics.ts:171-173 | **LOW** | TVPI/MOIC calculated differently | Theoretical discrepancy risk |

---

## Issue Details

### FIN-001: Date Parsing Timezone Risk (HIGH)

**Location:** `src/calculations/irr.ts:21, 25, 30, 37`

**Problem:** The IRR calculation uses `new Date(cf.date)` directly on date strings. Per CLAUDE.md, JavaScript has timezone issues with date-only strings like "2021-08-01" — they're parsed as UTC but `getTime()` returns local time.

**Code Pattern:**
```typescript
new Date(cf.date).getTime()  // Timezone-unsafe
```

**Impact:** IRR calculations may use incorrect date offsets, affecting the years-diff calculation and thus the final IRR value. A 1-day error at year boundaries can shift cash flows to wrong periods.

**Remediation:** Append `T00:00:00` to force local timezone interpretation, or use a consistent date parsing utility:
```typescript
new Date(cf.date + 'T00:00:00').getTime()
```

---

### FIN-002: Distribution Commitment Logic (MEDIUM)

**Location:** `src/calculations/metrics.ts:109-113`

**Problem:** In `getOutstandingCommitment()`, distributions ADD to the remaining commitment:
```typescript
} else if (cf.type === 'Distribution') {
  // Recallable distribution - adds back to remaining commitment
  outstanding += Math.abs(amount);
}
```

**Concern:** Most PE fund distributions do NOT restore unfunded commitment. This logic assumes all distributions are recallable, which is unusual. While `affectsCommitment` flag can override this, the default behavior may confuse users or produce unexpected results.

**Impact:** Outstanding commitment may be overstated for funds with distributions.

**Remediation:** Consider inverting the default — distributions should NOT affect commitment unless explicitly flagged as recallable. Or document this behavior prominently in the UI.

---

### FIN-003: Year Calculation Approximation (LOW)

**Location:** `src/calculations/irr.ts:30, 37`

**Problem:** Uses 365.25 days per year for time delta calculation.

**Industry Context:** This is a common simplification. More precise implementations use actual/actual day counts or 365 days flat. The difference is negligible for most PE fund timelines (< 0.01% IRR variance).

**Remediation:** No immediate action needed. Document the convention if auditability is required.

---

### FIN-004: Currency Parsing Fragility (MEDIUM)

**Location:** `src/calculations/metrics.ts:35, 67, 107, 131`

**Problem:** All amount values are passed through `parseCurrency()`, suggesting amounts may be stored as strings (e.g., "$100,000" or "100000").

**Risk:** If `parseCurrency()` returns `null` or `NaN` for malformed input, the `|| 0` fallback silently converts it to zero. This could cause:
- Contributions of $0 → division by zero guard returns null metrics
- Missing cash flows → understated IRR/MOIC

**Remediation:**
1. Ensure amounts are stored as numbers in IndexedDB (verify `db.ts` normalization)
2. Add validation/logging when `parseCurrency()` returns null on non-empty input

---

### FIN-005: TVPI vs MOIC Calculation Paths (LOW)

**Location:** `src/calculations/metrics.ts:168, 173`

**Problem:** TVPI and MOIC are mathematically equivalent but calculated via different code paths:
- MOIC: `calculateMOIC(cashFlowsForIRR)` — uses IRR cash flow array
- TVPI: `(distributions + nav) / calledCapital` — uses direct metric values

**Risk:** If filtering in `parseCashFlowsForIRR()` differs from `getTotalByType()`, the values could diverge. Currently they appear consistent, but future changes could introduce drift.

**Remediation:** Add a test that asserts `MOIC ≈ TVPI` for representative funds, or refactor to calculate TVPI from MOIC directly.

---

## Formula Validation Notes

### IRR (Newton-Raphson) ✓
- Algorithm is correct standard implementation
- Convergence guards in place (max iterations, precision threshold)
- Rate bounds prevent extreme outliers (-100% to +1000%)
- Derivative calculation is mathematically correct

### MOIC ✓
- Formula: `distributions / |contributions|` — correct
- Guard for zero contributions — returns null

### DPI/RVPI/TVPI ✓
- DPI = Distributions / CalledCapital — correct
- RVPI = NAV / CalledCapital — correct
- TVPI = (Distributions + NAV) / CalledCapital — correct
- All guard for zero calledCapital — return null

### NAV Adjustment Logic ✓
- Contributions after NAV date → ADD to NAV (correct)
- Distributions after NAV date → SUBTRACT from NAV (correct)
- Adjustments → No effect (correct)

### Sign Conventions ✓
- Contributions stored as positive, converted to negative for IRR
- Distributions stored as positive, kept positive for IRR
- Documented clearly in types/fund.ts

---

## Test Gaps Identified

| Gap | Description | Priority |
|-----|-------------|----------|
| TG-001 | No test for timezone edge cases in IRR | HIGH |
| TG-002 | No test for distribution commitment restoration | MEDIUM |
| TG-003 | No test asserting TVPI ≈ MOIC | LOW |
| TG-004 | No test for parseCurrency failure handling | MEDIUM |
| TG-005 | No golden dataset validation against Excel/Bloomberg | HIGH |

---

## Summary

**Overall Assessment:** The financial engine is fundamentally sound. The IRR implementation follows industry standards, sign conventions are well-documented, and metric calculations are correct.

**Critical Issue:** FIN-001 (timezone date parsing) should be fixed immediately as it can cause calculation errors.

**Recommended Priority:**
1. Fix FIN-001 (timezone handling in IRR)
2. Add TG-001 test (timezone edge cases)
3. Add TG-005 golden dataset tests
4. Review FIN-002 logic with product requirements

---

**Next:** Phase 3 — State, Persistence & Data Integrity
