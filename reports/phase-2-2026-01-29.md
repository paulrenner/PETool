# Phase 2 Report — Financial Engine Audit (Recurring Review)

**Date:** 2026-01-29
**Previous Review:** 2026-01-22
**Files Reviewed:**
- `src/calculations/irr.ts` (93 lines)
- `src/calculations/metrics.ts` (234 lines)

---

## Delta Summary

| Previous Issue | Status | Notes |
|----------------|--------|-------|
| FIN-001 (HIGH) Date parsing timezone | ✅ **RESOLVED** | `parseDateLocal()` helper added |
| FIN-002 (MEDIUM) Distribution commitment | ✅ **ADDRESSED** | Extensive documentation added |
| FIN-003 (LOW) Year calculation 365.25 | ⏸ Accepted | No change needed |
| FIN-004 (MEDIUM) Currency parsing | ⚠️ **PERSISTS** | Silent `|| 0` fallbacks remain |
| FIN-005 (LOW) TVPI vs MOIC paths | ⏸ Accepted | No change needed |

---

## Resolved Issues

### FIN-001: Date Parsing Timezone Risk ✅ RESOLVED

**Evidence:** `src/calculations/irr.ts:14-17`
```typescript
function parseDateLocal(dateStr: string): number {
  return new Date(dateStr + 'T00:00:00').getTime();
}
```

This helper is now used consistently throughout IRR calculations (lines 29, 33, 38, 45).

Additionally, `getVintageYear()` in metrics.ts:15 now uses the `T00:00:00` suffix.

---

### FIN-002: Distribution Commitment Logic ✅ ADDRESSED

**Evidence:** `src/calculations/metrics.ts:109-121`

Extensive documentation now explains the recallable distribution behavior:
- Default assumes distributions ARE recallable (adds back to commitment)
- Users can set `affectsCommitment: false` for standard non-recallable distributions
- This is a product decision, not a bug

---

## Persisting Issues

### FIN-004: Currency Parsing Fragility ⚠️ PERSISTS

**Locations:** `src/calculations/metrics.ts:35, 56, 67, 96, 107, 119, 139, 165`

**Pattern:**
```typescript
parseCurrency(cf.amount) || 0
```

**Risk:** If `parseCurrency()` returns `null` for malformed input (e.g., "abc"), the `|| 0` silently converts it to zero. This could cause:
- Understated contributions/distributions
- Incorrect IRR/MOIC calculations
- Division-by-zero guards masking data issues

**Recommendation:** Add logging or validation when parseCurrency returns null on non-empty input. Consider:
```typescript
const amount = parseCurrency(cf.amount);
if (amount === null && cf.amount != null) {
  console.warn(`Failed to parse amount: ${cf.amount}`);
}
```

---

## New Observations

### OBS-001: Inconsistent Date Parsing in metrics.ts (LOW)

**Locations:** `src/calculations/metrics.ts:13, 33, 50-51, 62-63, 86-87, 102, 135, 150-151, 158`

While the IRR calculation now uses `parseDateLocal()`, the metrics.ts file still uses raw `new Date(date)` for sorting and comparisons:

```typescript
// Line 13 - sorting
.sort((a, b) => new Date(a.date).getTime() - new Date(b.date).getTime());

// Line 33 - cutoff comparison
(!cutoffDate || new Date(cf.date) <= cutoffDate)
```

**Impact:** LOW - These are relative comparisons where both dates would be shifted identically, so the ordering remains correct. However, cutoff date comparisons at midnight boundaries could behave unexpectedly.

**Recommendation:** For consistency and future-proofing, consider using a shared date parsing utility throughout.

---

## Formula Validation (Unchanged)

All formulas validated in previous review remain correct:
- ✓ IRR (Newton-Raphson)
- ✓ MOIC
- ✓ DPI/RVPI/TVPI
- ✓ NAV adjustment logic
- ✓ Sign conventions

---

## Test Gaps (Updated)

| Gap | Status | Priority |
|-----|--------|----------|
| TG-001 Timezone edge cases in IRR | ✅ **LIKELY RESOLVED** | Verify tests exist |
| TG-002 Distribution commitment restoration | ⏸ Still needed | MEDIUM |
| TG-003 TVPI ≈ MOIC assertion | ⏸ Still needed | LOW |
| TG-004 parseCurrency failure handling | ⏸ Still needed | MEDIUM |
| TG-005 Golden dataset validation | ⏸ Still needed | HIGH |

---

## Summary

**Overall Assessment:** Significant improvement since last review. The critical timezone issue (FIN-001) has been properly fixed with a dedicated helper function. The distribution commitment logic (FIN-002) is now well-documented.

**Remaining Work:**
1. FIN-004 (currency parsing) should be addressed to prevent silent data issues
2. Consider unifying date parsing across metrics.ts for consistency

**Regressions:** None identified.

---

**Next:** Phase 3 — State, Persistence & Data Integrity
