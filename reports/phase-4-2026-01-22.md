# Phase 4 Report — Security & Performance

**Date:** 2026-01-22
**Files Reviewed:**
- `src/utils/escaping.ts` (35 lines) — Full review
- `src/utils/validation.ts` (468 lines) — Full review
- `src/app/filters.ts` (584 lines) — Full review
- `src/app/table.ts` (306 lines) — Full review
- `src/app/modals.ts` (1722 lines) — Pattern scan only (exceeds 500-line limit)
- `src/app/import.ts` — Previously reviewed in Phase 3
- `src/calculations/irr.ts`, `metrics.ts` — Previously reviewed in Phase 2

---

## Security Risk Register

| ID | File:Line | Severity | Issue | Impact |
|----|-----------|----------|-------|--------|
| SEC-001 | — | **NONE** | No XSS vectors found | N/A |
| SEC-002 | — | **NONE** | No prototype pollution | N/A |
| SEC-003 | — | **NONE** | No eval/Function/document.write | N/A |
| SEC-004 | filters.ts:94 | **LOW** | CSS.escape used for data-value selector | Safe but unusual |

---

## Security Review Summary

### XSS Protection ✓

**Finding:** All user data rendered to DOM uses `escapeHtml()`.

Evidence from scanned files:
- `table.ts:8` — imports escapeHtml
- `table.ts:139,146,149,160` — uses escapeHtml for fund data
- `filters.ts:91,97,144,149` — uses escapeHtml for filter options
- `modals.ts:20` — imports escapeHtml
- `modals.ts:171,174,269,1058,1059,1062,1063,1095,1096,1295,1673-1675` — uses escapeHtml throughout

**Conclusion:** XSS risk is LOW. The codebase consistently escapes user data.

### escapeHtml Implementation ✓

```typescript
// src/utils/escaping.ts:4-9
export function escapeHtml(text: unknown): string {
  if (typeof text !== 'string') return '';
  const div = document.createElement('div');
  div.textContent = text;
  return div.innerHTML;
}
```

**Assessment:** Correct implementation using DOM-based escaping. Handles non-string inputs safely.

### Prototype Pollution Protection ✓

`src/app/import.ts` blocks dangerous keys:
```typescript
const dangerousKeys = ['__proto__', 'constructor', 'prototype'];
```

### CSV Injection Protection ✓

`src/app/export.ts` sanitizes formula-triggering characters:
```typescript
if (['=', '+', '-', '@', '\t', '\r'].includes(firstChar)) {
  return "'" + str;
}
```

### No Dangerous Functions ✓

Grep results confirm no usage of:
- `eval()`
- `Function()`
- `document.write()`

---

## Performance Risk Register

| ID | File:Line | Severity | Issue | Impact |
|----|-----------|----------|-------|--------|
| PERF-001 | table.ts:203-204 | **MEDIUM** | Aggregate IRR merges all cash flows | O(n*m) for large portfolios |
| PERF-002 | filters.ts:265-304 | **LOW** | Filter applies sequentially | Linear per filter |
| PERF-003 | irr.ts:44 | **LOW** | Newton-Raphson max iterations | Configurable, bounded |

---

## Performance Review

### IRR Calculation Complexity

**Algorithm:** Newton-Raphson with max 100 iterations (default).

**Per-fund cost:** O(n * k) where n = cash flows, k = iterations (typically <20)

**Aggregate IRR risk:** `calculateTotals()` at `table.ts:203-204` merges all cash flows:
```typescript
const flows = parseCashFlowsForIRR(fund, cutoffDate);
totals.aggregateFlows.push(...flows);
```

For 100 funds with 50 cash flows each = 5,000 cash flows for aggregate IRR.
This is acceptable but could degrade with 1000+ funds.

### Metrics Caching ✓

`calculateMetricsCached()` uses AppState cache with TTL:
```typescript
if (cached && Date.now() - cached.timestamp < CONFIG.METRICS_CACHE_TTL) {
  return cached.metrics;
}
```

**Assessment:** Good caching strategy prevents redundant calculations during render cycles.

### Sort Pre-calculation ✓

`sortData()` pre-calculates metrics to avoid redundant calculations:
```typescript
const metricsMap = new Map<number, FundMetrics>();
for (const fund of funds) {
  if (fund.id != null) {
    metricsMap.set(fund.id, calculateMetricsCached(fund, cutoffDate));
  }
}
```

**Assessment:** Efficient pattern. Uses cached metrics.

### Filter Chain Performance

`applyCurrentFilters()` applies filters sequentially:
- Group filter: O(funds * groups) due to descendant lookup
- Other filters: O(funds)

**Assessment:** Acceptable for typical portfolio sizes (<1000 funds). The descendant lookup uses memoized cache.

---

## Validation Coverage ✓

`src/utils/validation.ts` provides comprehensive validation:

| Function | Purpose | Guards Against |
|----------|---------|---------------|
| `isValidDate` | YYYY-MM-DD format | Invalid dates, Feb 30, etc. |
| `validateFundName` | 2-100 char length | XSS via long strings |
| `validateCashFlow` | Type, date, amount | Missing/invalid data |
| `validateNavEntry` | Date, amount | Missing/invalid data |
| `validateFund` | All fields | NaN, Infinity, missing required |
| `validateFundCrossField` | Logical consistency | Distributions before contributions |

**Highlight:** `validateFund` explicitly blocks NaN and Infinity:
```typescript
} else if (isNaN(f.commitment)) {
  errors.push('Commitment is NaN (invalid number)');
} else if (!isFinite(f.commitment)) {
  errors.push('Commitment must be a finite number');
```

---

## Files Exceeding 500-Line Limit

| File | Lines | Action |
|------|-------|--------|
| `src/app/modals.ts` | 1722 | Pattern scan only |

**Recommendation:** Consider splitting modals.ts into smaller modules (fund modals, group modals, bulk modals) for maintainability.

---

## Summary

### Security Assessment: **STRONG**

No exploitable vulnerabilities found. The codebase demonstrates:
- Consistent XSS escaping
- Prototype pollution protection
- CSV injection protection
- Input validation before persistence
- No dangerous function usage

### Performance Assessment: **ADEQUATE**

Performance is acceptable for typical use cases (<500 funds). Potential concerns:
- Aggregate IRR calculation may slow with very large portfolios
- Consider lazy calculation or web worker for 1000+ funds

---

## Recommendations

1. **No immediate security fixes required**
2. **Consider splitting modals.ts** for maintainability
3. **Monitor aggregate IRR performance** if user base grows to very large portfolios
4. **Add performance metrics** (optional) to track calculation times in production

---

**Next:** Phase 5 — Architecture, Types & Maintainability
