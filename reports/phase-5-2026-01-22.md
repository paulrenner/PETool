# Phase 5 Report — Architecture, Types & Maintainability

**Date:** 2026-01-22
**Files Reviewed:**
- `src/types/fund.ts` (142 lines) — Previously reviewed
- `src/types/group.ts` (18 lines)
- `src/types/state.ts` (81 lines)
- `src/core/config.ts` (63 lines)
- `src/core/state.ts` (177 lines) — Previously reviewed
- Index files for module structure

---

## Architectural Assessment

### Module Structure ✓

```
src/
├── types/         # Pure type definitions (no runtime deps)
├── core/          # State, config, DB (foundational)
├── calculations/  # Financial logic (isolated, testable)
├── utils/         # Pure utility functions
├── ui/            # Reusable UI components
└── app/           # Feature modules (high-level)
```

**Assessment:** Good separation of concerns. Calculations module is isolated and testable without DOM dependencies.

### Dependency Flow ✓

```
types → (no deps)
core → types
calculations → types, core
utils → types (minimal)
ui → core, utils
app → everything
main.ts → orchestrates all
```

**Assessment:** No circular dependencies detected. Dependencies flow downward.

---

## Type System Assessment

### Domain Types Quality

| Type | Precision | Notes |
|------|-----------|-------|
| `Fund` | Good | Clear fields, documented |
| `CashFlow` | Good | Sign convention documented |
| `Nav` | Good | Allows negative (documented) |
| `FundMetrics` | Good | All metrics typed, nullability correct |
| `Group` | Good | Simple hierarchical model |
| `SortColumn` | Good | Union type for direction |

### Type Gaps Identified

| ID | Location | Issue | Severity |
|----|----------|-------|----------|
| TYPE-001 | state.ts:14 | `column: string` should be union type | LOW |
| TYPE-002 | Various | `any` usage in import.ts for raw JSON | LOW |
| TYPE-003 | fund.ts:29 | `amount: number` allows negative (intended?) | INFO |

---

## Type Details

### TYPE-001: SortColumn Column Type

```typescript
export interface SortColumn {
  column: string;  // Could be stricter
  direction: SortDirection;
}
```

**Recommendation:** Define valid column names as union type:
```typescript
type SortableColumn = 'fundName' | 'accountNumber' | 'vintage' | 'commitment' | ...;
```

### TYPE-002: Import JSON Typing

Import uses `any` for raw JSON parsing, which is appropriate for external data. The `sanitizeObject` and validation functions provide runtime safety.

### TYPE-003: Amount Sign Convention

`CashFlow.amount` is documented as "absolute value (always positive)" but the type allows any number. This is by design — the `type` field determines direction.

---

## Configuration Management ✓

`src/core/config.ts` centralizes all magic numbers:

- IRR parameters (iterations, precision, bounds)
- Database names and version
- Debounce delays
- File size limits
- Import limits
- Security constraints

**Assessment:** Excellent. All configuration is centralized and typed with `as const`.

---

## Maintainability Concerns

### Large File: modals.ts (1722 lines)

**Recommendation:** Split into:
- `modals/fund.ts` — Fund add/edit modals
- `modals/group.ts` — Group management
- `modals/bulk.ts` — Bulk operations
- `modals/import-export.ts` — Import/export dialogs
- `modals/common.ts` — Shared utilities

### AppState Class Pattern

The singleton AppState pattern works but could benefit from:
1. Stronger typing for cache keys
2. Event emitters for state changes (if reactive UI needed later)

---

## Technical Debt Assessment

| Area | Debt Level | Notes |
|------|------------|-------|
| Type safety | LOW | Good coverage, minor gaps |
| Module size | MEDIUM | modals.ts too large |
| Documentation | LOW | Key types well-documented |
| Test isolation | LOW | Calculations easily testable |
| Circular deps | NONE | Clean dependency graph |

---

## Refactor Opportunities (Prioritized)

1. **Split modals.ts** — Improves maintainability (MEDIUM effort)
2. **Add SortableColumn type** — Type safety (LOW effort)
3. **Extract modal state machine** — Better state management (HIGH effort, optional)

---

**Next:** Phase 6 — Tests & Regression Safety
