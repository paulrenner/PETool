# Phase 6 Report — Tests & Regression Safety

**Date:** 2026-01-22
**Files Reviewed:**
- `__tests__/calculations.test.js` (435 lines)
- `__tests__/financial-validation.test.js` (839 lines)
- Test file listing via glob

---

## Test Structure Overview

| Test File | Lines | Focus |
|-----------|-------|-------|
| calculations.test.js | 435 | IRR, MOIC, metrics functions |
| financial-validation.test.js | 839 | Data validation, sign conventions, edge cases |
| validation.test.js | — | Input validation functions |
| escaping.test.js | — | XSS/CSV escaping |
| formatting.test.js | — | Currency/date formatting |
| core.test.js | — | State/DB operations |
| ui.test.js | — | UI components |
| tags.test.js | — | Tag functionality |

**Total:** 8 test files, 265 tests reported (per CLAUDE.md)

---

## Financial Formula Coverage Analysis

### Covered ✓

| Function | Tests | Edge Cases |
|----------|-------|------------|
| `calculateIRR` | 7 | Empty, single flow, positive/negative, extreme bounds |
| `calculateMOIC` | 6 | Empty, no contributions, 2x, partial, multiple flows |
| `getVintageYear` | 4 | Empty, earliest contribution, ignores distributions |
| `getTotalByType` | 5 | Empty, contributions, distributions, cutoff date, string amounts |
| `getLatestNav` | 5 | Empty, latest value, contribution adjustment, distribution adjustment |
| `getOutstandingCommitment` | 6 | Full, reduced, non-affecting, floor at zero, recallable |
| `parseCashFlowsForIRR` | 4 | Sign conversion, NAV inclusion, sorting |
| `calculateMetrics` | 2 | Complete fund, missing data |
| `validateFund` | 20+ | NaN, Infinity, required fields, date format, types |
| Sign conventions | 5 | LP perspective, absolute values |
| Negative NAV | 4 | Included in metrics, impacts IRR |
| NAV adjustment | 8 | Contributions add, distributions subtract, timing |
| DPI/RVPI/TVPI | 7 | Formulas, null handling, negative NAV |

### Strong Coverage Areas

1. **Data Validation:** Comprehensive NaN/Infinity/required field tests
2. **Sign Conventions:** Well-tested LP perspective conversion
3. **NAV Adjustment Logic:** Multiple scenarios for post-NAV cash flows
4. **Edge Cases:** Zero values, large values, small values, date boundaries

---

## Test Gaps Identified

### GAP-001: Timezone Date Handling (HIGH)

**Issue:** No test verifies IRR calculation handles timezone edge cases correctly.

**Missing Test:**
```javascript
test('handles date at midnight UTC vs local time boundary', () => {
  // Test that '2021-01-01' in different timezones produces same IRR
  const cashFlows = [
    { date: '2020-12-31', amount: -1000 },
    { date: '2021-01-01', amount: 1100 }
  ];
  const irr = calculateIRR(cashFlows);
  // Should be ~10% regardless of local timezone
  expect(irr).toBeCloseTo(0.10, 1);
});
```

**Priority:** HIGH — This is the same issue identified in Phase 2 (FIN-001).

---

### GAP-002: Golden Dataset Validation (HIGH)

**Issue:** No tests validate calculations against known-correct reference values from industry tools (Excel XIRR, Bloomberg).

**Missing Test:**
```javascript
describe('Golden Dataset - Excel XIRR Validation', () => {
  test('matches Excel XIRR for standard PE fund', () => {
    // Real fund data with Excel-verified IRR
    const cashFlows = [
      { date: '2018-03-15', amount: -1000000 },
      { date: '2018-09-30', amount: -500000 },
      { date: '2019-06-15', amount: 200000 },
      { date: '2020-12-31', amount: 1800000 }
    ];
    const irr = calculateIRR(cashFlows);
    // Excel XIRR: 15.23%
    expect(irr).toBeCloseTo(0.1523, 3);
  });
});
```

**Priority:** HIGH — Industry credibility requires external validation.

---

### GAP-003: Concurrent Modification (MEDIUM)

**Issue:** No test verifies behavior when data is modified during calculation.

**Priority:** MEDIUM — Edge case for multi-tab usage.

---

### GAP-004: Import Rollback (MEDIUM)

**Issue:** No test verifies partial import behavior when validation fails mid-batch.

**Priority:** MEDIUM — Related to Phase 3 finding DI-002.

---

### GAP-005: Cache Invalidation (LOW)

**Issue:** Limited testing of metrics cache TTL and invalidation scenarios.

**Priority:** LOW — Performance optimization, not correctness.

---

## Test Quality Assessment

### Strengths

1. **Clear test organization** — Descriptive describe/test blocks
2. **Edge case coverage** — Zero, null, negative, extreme values
3. **Sign convention documentation** — Comments explain LP perspective
4. **Regression protection** — Good coverage of core calculations

### Weaknesses

1. **No external validation** — Calculations not verified against Excel/Bloomberg
2. **Limited integration tests** — Most tests are unit-level
3. **No performance benchmarks** — No tests for calculation speed with large datasets

---

## Recommended Test Additions

### Immediate (HIGH)

```javascript
// 1. Timezone edge case
describe('IRR Timezone Safety', () => {
  test('same dates produce same IRR across timezones', () => {
    // Use dates at year boundary
  });
});

// 2. Golden dataset
describe('Golden Dataset', () => {
  test('PE Fund Alpha matches Excel XIRR', () => {
    // Include 5-10 known funds with verified IRRs
  });
});
```

### Short-term (MEDIUM)

```javascript
// 3. Import failure handling
describe('Import Partial Failure', () => {
  test('reports which funds failed validation', () => { });
  test('does not corrupt valid funds on partial failure', () => { });
});
```

---

## Summary

| Category | Coverage | Notes |
|----------|----------|-------|
| Core calculations | HIGH | All functions tested |
| Validation | HIGH | Comprehensive |
| Sign conventions | HIGH | Well documented |
| Edge cases | MEDIUM-HIGH | Good but gaps exist |
| Timezone handling | LOW | Missing tests |
| External validation | NONE | No golden datasets |

**Overall Test Quality:** Good foundation, but missing timezone tests and golden dataset validation that would be critical for financial software certification.

---

**Next:** Phase 7 — Synthesis & Roadmap
