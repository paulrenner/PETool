# Phase 7 Report — Synthesis & Roadmap

**Date:** 2026-01-22
**Input:** Phase 1-6 reports from 2026-01-22

---

## Top 5 Financial Correctness Risks

| Rank | ID | Description | Phase | Severity |
|------|-----|-------------|-------|----------|
| 1 | FIN-001 | **Timezone date parsing in IRR** — `new Date(date)` without timezone handling can shift cash flow dates by 1 day | Phase 2 | CRITICAL |
| 2 | GAP-001 | **No timezone test coverage** — No tests verify IRR is timezone-safe | Phase 6 | HIGH |
| 3 | GAP-002 | **No golden dataset validation** — Calculations not verified against Excel/Bloomberg | Phase 6 | HIGH |
| 4 | FIN-002 | **Distribution adds to commitment** — Default behavior may overstate unfunded commitment | Phase 2 | MEDIUM |
| 5 | DI-003 | **Date normalization fallback** — Uses unsafe `new Date()` in db.ts normalization | Phase 3 | MEDIUM |

---

## Top 5 Systemic Risks

| Rank | ID | Description | Phase | Severity |
|------|-----|-------------|-------|----------|
| 1 | DI-002 | **Partial import commits** — Failed imports leave inconsistent state, no rollback | Phase 3 | HIGH |
| 2 | TYPE-001 | **modals.ts 1722 lines** — Maintenance risk, hard to navigate | Phase 5 | MEDIUM |
| 3 | DI-001 | **Non-atomic save** — Audit log may capture stale state | Phase 3 | MEDIUM |
| 4 | PERF-001 | **Aggregate IRR scaling** — May slow with 1000+ funds | Phase 4 | LOW |
| 5 | DI-006 | **setFunds replaces array** — Could lose unsaved edits | Phase 3 | LOW |

---

## Prioritized Remediation Plan

### Immediate (Critical/High) — Do First

| Priority | ID | Action | Effort |
|----------|-----|--------|--------|
| 1 | FIN-001 | Fix timezone handling in `irr.ts` | LOW |
| 2 | GAP-001 | Add timezone edge case tests | LOW |
| 3 | GAP-002 | Add golden dataset tests (3-5 funds) | MEDIUM |
| 4 | DI-002 | Add pre-validation pass to import | MEDIUM |

### Short-term (Medium) — Next Sprint

| Priority | ID | Action | Effort |
|----------|-----|--------|--------|
| 5 | FIN-002 | Review distribution commitment logic with product | LOW |
| 6 | DI-003 | Remove unsafe Date() fallback in normalizeDate | LOW |
| 7 | TYPE-001 | Split modals.ts into 4-5 smaller files | MEDIUM |

### Long-term (Low/Refactoring) — Backlog

| Priority | ID | Action | Effort |
|----------|-----|--------|--------|
| 8 | DI-001 | Consider single transaction for audit logging | MEDIUM |
| 9 | PERF-001 | Add web worker for aggregate IRR (if needed) | HIGH |
| 10 | DI-006 | Document setFunds usage constraints | LOW |

---

## Architectural Improvement Plan

### Near-term
1. Split `modals.ts` into logical modules
2. Add stricter typing for sort columns

### Future Considerations
1. Consider state management library if app grows
2. Add BroadcastChannel for multi-tab coordination
3. Add performance monitoring for large portfolios

---

## Ongoing Validation Checklist

When making changes to financial calculations:

- [ ] Run `npm test` — all 265 tests pass
- [ ] Verify IRR matches Excel XIRR for test funds
- [ ] Check sign conventions (contributions negative, distributions positive)
- [ ] Verify NAV adjustment logic (contributions add, distributions subtract)
- [ ] Confirm DPI + RVPI = TVPI ≈ MOIC

---

## Security Posture

**Status:** STRONG

No immediate security fixes required. The codebase demonstrates:
- Consistent XSS escaping
- Prototype pollution protection
- CSV injection protection
- Input validation before persistence

---

## Next Steps

1. Generate fix list → `reports/fix-list-2026-01-22.md`
2. Execute Phase 8 to implement fixes
3. Re-run Phase 2 and Phase 6 after fixes
4. Schedule recurring reviews (quarterly recommended)
